<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Log√≠stica</title>
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --btn-bg: #0066cc;
  --btn-bg-hover: #004c99;
  --grid-size: 26px;
  --vignette: rgba(0,0,0,0.9);
  --titulo-size: clamp(42px,7vw,96px);
  --led-size: 50px;
  --led-gap: 16px;
  --led-off-core: #111;
  --led-off-edge: #000;
  --led-on-core: #0f0;
  --led-on-edge: #063;
  --glow: #00ff88;
  --blink-duration: 0.9s;
}

*{ box-sizing: border-box; }
html, body{ height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:#111; }

.pantalla{ display:none; width:100%; min-height:100vh; }
.pantalla.activa{ display:flex; flex-direction:column; }

#pantalla1{
  align-items:center;
  justify-content:center;
  flex-direction: column;
  background:linear-gradient(135deg,#222,#444);
  gap:18px;
}
.btn-contenedor{
  display:flex;
  flex-direction:column;
  align-items:center;
}

#pantalla1 h1{ margin:0 0 8px; }
.usuario-btn{
  background: var(--btn-bg);
  color:#fff;
  border:0;
  padding:14px 28px;
  margin:8px;
  border-radius:10px;
  font-size:18px;
  cursor:pointer;
  transition: background .25s ease;
  outline-color: #000;
}
.usuario-btn:hover{ background: var(--btn-bg-hover); }

#pantalla2{
  background-color:#000;
  background-image:
    radial-gradient(circle, rgba(60,60,60,.28) 20%, transparent 21%),
    radial-gradient(circle, #101010 20%, transparent 21%);
  background-size: var(--grid-size) var(--grid-size);
  box-shadow: inset 0 0 90px var(--vignette);
  overflow-y: auto;
}
.header{ display:flex; align-items:center; justify-content:center; padding:16px 20px 6px; position: relative; }
#tituloFijo{
  font-weight:800;
  text-align:center;
  letter-spacing:.5px;
  text-shadow:0 2px 8px rgba(0,0,0,.65);
  font-size:var(--titulo-size);
}
#turnoActual {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 1.2rem;
  font-weight: bold;
  background-color: rgba(0,0,0,0.5);
  padding: 5px 10px;
  border-radius: 5px;
}
.zona-centro{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px 24px 28px;
  flex-direction: column;
}
.grupo-contenedor{
  display: flex;
  flex-wrap: wrap;
  gap: clamp(24px, 4vw, 64px);
  width: min(1200px, 96vw);
  justify-content: center;
}
.grupo.oculto {
  display: none;
}
.grupo{ display:flex; flex-direction:column; align-items:center; text-align:center; }
.grupo .nombre{ font-size: clamp(20px,2.2vw,28px); font-weight:800; margin-bottom:8px; letter-spacing:.5px; text-shadow:0 1px 6px rgba(0,0,0,.5); }
.grupo .tarimas{ font-size: clamp(16px,1.7vw,22px); opacity:.9; margin-top:14px; }
.leds{ display:flex; gap: var(--led-gap); justify-content:center; align-items:center; flex-wrap:nowrap; padding:4px; }
.led{
  width: var(--led-size);
  height: var(--led-size);
  border-radius:50%;
  cursor:pointer;
  background: radial-gradient(circle at 45% 40%, var(--led-off-core) 40%, var(--led-off-edge) 100%);
  box-shadow: inset -4px -5px 8px rgba(0,0,0,.8), inset 4px 5px 6px rgba(255,255,255,.06), 0 1px 0 rgba(255,255,255,.05);
  transition: transform .1s ease, filter .2s ease, box-shadow .2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: bold;
  color: #fff;
  text-shadow: 0 0 3px #000;
}
.led:active{ transform: scale(.96); }
.led.on{
  background: radial-gradient(circle at 48% 45%, var(--led-on-core) 40%, var(--led-on-edge) 100%);
  box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  animation: blink var(--blink-duration) ease-in-out infinite;
}
.led.disabled {
    cursor: not-allowed;
    pointer-events: none;
}

.resumen-turno {
  display: flex;
  justify-content: center;
  gap: 40px;
  margin-bottom: 20px;
  background-color: #222;
  border-radius: 12px;
  padding: 15px 30px;
  box-shadow: 0 4px 10px rgba(0,0,0,.3);
  width: min(800px, 90vw);
}
.resumen-turno.oculto {
  display: none;
}
.dato-resumen {
  text-align: center;
}
.dato-resumen .etiqueta {
  font-size: 14px;
  opacity: 0.7;
  text-transform: uppercase;
  margin-bottom: 4px;
}
.dato-resumen .valor {
  font-size: 32px;
  font-weight: bold;
  letter-spacing: 1px;
}
.tiempos{
  margin-top: 10px;
  font-size: 14px;
  opacity: 0.8;
  text-align: left;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
}
.btn-rojo{
  background: #cc0000;
  outline-color: #000;
}
.btn-rojo:hover{
  background: #990000;
}
.footer{
  width: 100%;
  display: flex;
  justify-content: center;
  padding: 20px;
}
.footer .usuario-btn{
  padding: 10px 20px;
  font-size: 16px;
}
.contadores-calidad {
  display: flex;
  gap: 20px;
  justify-content: center;
  margin-top: 10px;
}
.contador-calidad {
  text-align: center;
  font-size: 14px;
  font-weight: bold;
}
.contador-calidad .valor {
  font-size: 20px;
  font-weight: bold;
}
.contador-calidad .etiqueta {
  font-size: 12px;
  opacity: 0.8;
}

@media(max-width:720px){ 
  .grupo-contenedor{ 
    display: flex;
    flex-direction: column;
    gap: 24px;
    width: 100%;
  }
}
@keyframes blink {
  0%, 100% {
    box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  }
  50% {
    box-shadow: 0 0 40px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  }
}

.modal-calidad,
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.modal-calidad.visible,
.modal.visible {
  visibility: visible;
  opacity: 1;
}

#modalCalidad .modal-content,
#modalRechazo .modal-content,
#modalOpcionesCalidad .modal-content,
#modalAsignarTarimaProduccion .modal-content {
  background-color: #1c1c1c !important;
  color: #eee !important;
  padding: 25px 35px;
  border-radius: 12px;
  text-align: center;
  max-width: 450px;
  width: 90%;
  box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}
  
#modalCalidad h3,
#modalRechazo h3 {
  color: #f0f0f0 !important;
}
#modalCalidad .opcion-btn,
#modalRechazo .opcion-btn {
  padding: 12px 20px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: transform 0.15s ease;
}
#modalCalidad .opcion-btn[data-color="rojo"] { background: #d32f2f; color: #fff; }
#modalCalidad .opcion-btn[data-color="verde"] { background: #2e7d32; color: #fff; }
#modalCalidad .opcion-btn:hover { transform: scale(1.05); }

#modalRechazo .modal-content {
  text-align: left;
}
#modalRechazo .modal-content h3 {
  text-align: center;
  margin-bottom: 30px;
}
#modalRechazo form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}
#modalRechazo label {
  font-size: 16px;
  margin-bottom: 5px;
  display: block;
}
#modalRechazo input, #modalRechazo textarea {
  width: 100%;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid #555;
  background-color: #333;
  color: #fff;
  font-size: 16px;
}
#modalRechazo textarea {
  resize: vertical;
  min-height: 80px;
}
#modalRechazo button[type="submit"] {
  margin-top: 20px;
  background-color: var(--btn-bg);
  color: #fff;
  border: none;
  padding: 15px;
  border-radius: 8px;
  font-size: 18px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
#modalRechazo button[type="submit"]:hover {
  background-color: var(--btn-bg-hover);
}

#modalRechazo .modal-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}
#modalRechazo .modal-actions button {
  flex: 1;
  margin: 0 5px;
}
  
.led.naranja {
  background: radial-gradient(circle at 48% 45%, #ff9800 40%, #c17500 100%);
  box-shadow: 0 0 22px #ff9800, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.rojo {
  background: radial-gradient(circle at 48% 45%, #f44336 40%, #d32f2f 100%);
  box-shadow: 0 0 22px #f44336, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.verde {
  background: radial-gradient(circle at 48% 45%, #4caf50 40%, #388e3c 100%);
  box-shadow: 0 0 22px #4caf50, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}

#pantalla3 {
  background-color: #f5f5f5;
  color: #333;
  align-items: center;
  justify-content: flex-start;
  padding: 20px;
  overflow-y: auto;
}
#pantalla3 h1 { font-size: 2.5rem; color: #0066cc; margin-bottom: 20px; }
#pantalla3 .btn-contenedor { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 15px; width: 100%; max-width: 800px; }
#pantalla3 .usuario-btn { background-color: #0066cc; color: #fff; font-size: 1.2rem; padding: 15px 30px; border-radius: 10px; cursor: pointer; border: none; transition: background-color 0.3s ease; }
#pantalla3 .usuario-btn:hover { background-color: #004c99; }
#pantalla3 .contenedor-reporte { background-color: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 100%; max-width: 1200px; margin-top: 20px; }
#pantalla3 .header-reporte { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; justify-content: space-between; margin-bottom: 20px; }
#pantalla3 .header-reporte h2 { color: #0066cc; margin: 0; }
#pantalla3 .header-reporte .filtros { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
#pantalla3 .header-reporte .filtros label { font-size: 14px; }
#pantalla3 .header-reporte .filtros input[type="date"],
#pantalla3 .header-reporte .filtros select,
#pantalla3 .header-reporte .filtros input[type="text"] { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
#pantalla3 table { width: 100%; border-collapse: collapse; margin-top: 20px; display: table; }
#pantalla3 th, #pantalla3 td { border: 1px solid #ccc; padding: 12px; text-align: left; font-size: 14px; }
#pantalla3 thead { background-color: #0066cc; color: #fff; }
#pantalla3 tbody tr:nth-child(even) { background-color: #f2f2f2; }
#pantalla3 tbody tr:hover { background-color: #ddd; }
#pantalla3 .resumen-datos { display: flex; gap: 30px; flex-wrap: wrap; justify-content: space-around; margin-bottom: 20px; }
#pantalla3 .dato { background-color: #f2f2f2; padding: 15px; border-radius: 8px; font-weight: bold; text-align: center; }
#pantalla3 .dato .valor { font-size: 24px; color: #0066cc; }
#pantalla3 .dato .etiqueta { font-size: 12px; text-transform: uppercase; color: #666; }
.botones-reporte { margin-top: 20px; display: flex; gap: 15px; justify-content: flex-end; flex-wrap: wrap; }
.grafico-contenedor { width: 100%; max-width: 600px; margin: 20px auto; }
.opciones-grafico { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; justify-content: center; }
.opciones-grafico .usuario-btn { padding: 8px 15px; font-size: 14px; }
.reporte-calidad-mobile .tabla-calidad-movil .fila-dato { background-color: #f2f2f2; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
.reporte-calidad-mobile .tabla-calidad-movil .etiqueta { font-weight: bold; color: #666; display: block; font-size: 12px; }
.reporte-calidad-mobile .tabla-calidad-movil .valor { color: #333; font-size: 16px; }
@media (max-width: 768px) {
    #pantalla3 .header-reporte { flex-direction: column; align-items: flex-start; }
    #pantalla3 .header-reporte .filtros { width: 100%; flex-direction: column; }
    #pantalla3 .header-reporte .filtros input, #pantalla3 .header-reporte .filtros select { width: 100%; }
    #pantalla3 .resumen-datos { flex-direction: column; gap: 15px; }
    #pantalla3 .dato { width: 100%; }
    #pantalla3 table { display: none; }
    .reporte-calidad-mobile { display: block; }
}
@media (min-width: 769px) { .reporte-calidad-mobile { display: none; } }

#pantalla4 {
  background-color: #000; color: #fff; padding: 20px; display: grid; grid-template-areas: "header" "filtros" "kpis" "graficos" "pendientes" "footer"; gap: 20px; align-content: start; overflow-y: auto;
}
#pantalla4 .header { grid-area: header; text-align: center; }
#pantalla4 .filtros-dashboard { grid-area: filtros; display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; align-items: center; }
#pantalla4 .filtros-dashboard label { font-size: 14px; }
#pantalla4 .filtros-dashboard input[type="date"], #pantalla4 .filtros-dashboard select { padding: 8px; border-radius: 5px; border: 1px solid #555; background-color: #222; color: #fff; }
#pantalla4 .kpis-grid { grid-area: kpis; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
#pantalla4 .kpi-card { background-color: #1a1a1a; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 1px solid #333; }
#pantalla4 .kpi-card h3 { margin-top: 0; font-size: 1rem; color: #aaa; text-transform: uppercase; }
#pantalla4 .kpi-card .valor { font-size: 3rem; font-weight: bold; color: #00ff88; transition: color 0.3s ease; }
#pantalla4 .kpi-card.alerta .valor { color: #ff3333; }
#pantalla4 .graficos-container { grid-area: graficos; display: grid; grid-template-columns: 1fr; gap: 20px; }
#pantalla4 .graficos-container .panel { background-color: #1a1a1a; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 1px solid #333; }
#pantalla4 .graficos-container h3 { text-align: center; margin-top: 0; margin-bottom: 15px; color: #eee; }
#pantalla4 #tablaPendientes { width: 100%; border-collapse: collapse; color: #fff; }
#pantalla4 #tablaPendientes th, #pantalla4 #tablaPendientes td { padding: 12px; border-bottom: 1px solid #444; text-align: left; }
#pantalla4 #tablaPendientes th { background-color: #222; }
#pantalla4 #tablaPendientes tbody tr:hover { background-color: #333; }
#pantalla4 .footer { grid-area: footer; }
@media (min-width: 768px) {
  #pantalla4 { grid-template-columns: 1fr 1fr; grid-template-areas: "header header" "filtros filtros" "kpis kpis" "graficos graficos" "pendientes pendientes" "footer footer"; }
  #pantalla4 .graficos-container { grid-template-columns: 1fr 1fr; }
  .graficos-container > *:nth-child(3) { grid-column: span 2; }
}
@media (min-width: 1200px) {
  #pantalla4 { grid-template-columns: repeat(3, 1fr); grid-template-areas: "header header header" "filtros filtros filtros" "kpis kpis kpis" "produccion calidad logistica" "pendientes pendientes pendientes" "footer footer footer"; }
  #pantalla4 .graficos-container { grid-template-columns: 1fr 1fr 1fr; }
  .graficos-container > *:nth-child(3) { grid-column: span 1; }
}

.mt-fab { position: fixed; bottom: 20px; right: 20px; background: #0a84ff; color: #fff; border: none; border-radius: 50%; width: 78px; height: 78px; font-size: 12px; font-weight: 700; cursor: pointer; z-index: 1000; box-shadow: 0 10px 25px rgba(10,132,255,.35); }
.mt-fab:active { transform: translateY(1px); }

.mt-panel { position: fixed; top: 0; right: -420px; width: 420px; max-width: 95vw; height: 100%; background: #111316; color: #eaeaea; box-shadow: -4px 0 20px rgba(0,0,0,.45); transition: right .28s ease; z-index: 999; }
.mt-panel.open { right: 0; }
.mt-panel-content { padding: 20px; }
.mt-close { background: transparent; border: none; color: #aaa; font-size: 28px; cursor: pointer; float: right; }
.mt-close:hover { color: #fff; }

.mt-row { display: flex; gap: 10px; align-items: stretch; }
.mt-btn { padding: 10px 14px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; }
.mt-primary { background:#0a84ff; color:#fff; }
.mt-success { background:#34c759; color:#000; }
.mt-select, #bxInput { flex: 1; padding: 10px 12px; border-radius: 10px; border: 1px solid #2b2f36; background:#171a1f; color:#eaeaea; }
.mt-select:focus, #bxInput:focus { outline: 2px solid #0a84ff; }
.mt-card { margin-top: 16px; padding: 16px; border-radius: 14px; background: linear-gradient(180deg, #16191e 0%, #121418 100%); border: 1px solid #20242b; }
.mt-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 8px 14px; margin-bottom: 10px; }
.mt-list { list-style: none; padding-left: 0; margin: 8px 0 0; max-height: 200px; overflow: auto; }
.mt-list li { padding: 10px 12px; margin-bottom: 8px; border-radius: 10px; background:#0f1216; border: 1px solid #22262c; font-size: 14px; word-break: break-word; }
.mt-assign { margin-top: 14px; border-top: 1px dashed #2a2f36; padding-top: 12px; }

body.theme-dark { background: #0b0d0f !important; color: #eaeaea !important; }
body.theme-dark .card, body.theme-dark .panel, body.theme-dark .widget { background: #121418 !important; color: #eaeaea !important; border-color: #21252b !important; }
body.theme-dark button, body.theme-dark .btn { border-radius: 10px; }

/* ======== NUEVO CSS PARA MODALES PERSONALIZADOS ======== */
.custom-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}
.custom-modal-overlay.visible {
    opacity: 1;
    visibility: visible;
}
.custom-modal {
    background: #1e1e1e;
    padding: 25px 35px;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    border: 1px solid #444;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    transform: scale(0.9);
    transition: transform 0.3s ease;
}
.custom-modal-overlay.visible .custom-modal {
    transform: scale(1);
}
.custom-modal h3 {
    margin-top: 0;
    color: #00aaff;
}
.custom-modal p {
    color: #ccc;
    line-height: 1.5;
}
.custom-modal-actions {
    margin-top: 25px;
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
}
.custom-modal-actions button {
    padding: 10px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
}
.custom-modal-actions input {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #555;
    background-color: #333;
    color: #fff;
    font-size: 16px;
    margin-bottom: 10px;
}
.modal-btn-confirm {
    background-color: var(--btn-bg);
    color: white;
}
.modal-btn-cancel {
    background-color: #555;
    color: white;
}
</style>
</head>
<body>

<section id="pantalla1" class="pantalla activa">
<h1 id="mainTitle">Selecciona tu usuario</h1>
<div class="btn-contenedor">
    <button class="usuario-btn" onclick="seleccionarUsuario('LOG√çSTICA')">LOG√çSTICA</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('MULTIPORT')">MULTIPORT</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('DROPS')">DROPS</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('BEDROCK')">BEDROCK</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('SUPERVISOR')">SUPERVISOR</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('CALIDAD')">CALIDAD</button> 
    <button class="usuario-btn" onclick="seleccionarReporte()">REPORTES</button>
    <button class="usuario-btn" onclick="seleccionarDashboard()">DASHBOARD</button>
</div>
</section>

<section id="pantalla2" class="pantalla">
<header class="header">
    <div id="tituloFijo">LOG√çSTICA</div>
    <div id="turnoActual"></div>
</header>
<div class="zona-centro">
    <div id="resumenTurno" class="resumen-turno oculto">
<div class="dato-resumen">
    <div class="etiqueta">Tarimas Totales</div>
    <div id="tarimasTotales" class="valor">0</div>
</div>
<div class="dato-resumen">
    <div class="etiqueta">Tiempo Promedio</div>
    <div id="tiempoPromedio" class="valor">0 min</div>
</div>
</div>
<div class="grupo-contenedor">
    <div class="grupo" data-grupo="MULTIPORT">
        <div class="nombre">MULTIPORT</div>
        <div class="leds" data-grupo="MULTIPORT" data-linea="linea1"></div>
        <div class="leds" data-grupo="MULTIPORT" data-linea="linea2"></div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="tiempos" data-grupo="MULTIPORT"></div>
    </div>

    <div class="grupo" data-grupo="DROPS">
        <div class="nombre">DROPS</div>
        <div class="leds" data-grupo="DROPS" data-linea="linea1"></div>
        <div class="leds" data-grupo="DROPS" data-linea="linea2"></div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="tiempos" data-grupo="DROPS"></div>
    </div>

    <div class="grupo" data-grupo="BEDROCK">
        <div class="nombre">BEDROCK</div>
        <div class="leds" data-grupo="BEDROCK" data-linea="linea1"></div>
        <div class="leds" data-grupo="BEDROCK" data-linea="linea2"></div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="tiempos" data-grupo="BEDROCK"></div>
    </div>

    <div class="grupo" data-grupo="CALIDAD_MULTIPORT">
        <div class="nombre">CALIDAD MULTIPORT</div>
        <div class="leds" data-grupo="CALIDAD_MULTIPORT" data-linea="linea1"></div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="tiempos" data-grupo="CALIDAD_MULTIPORT"></div>
    </div>
  
    <div class="grupo" data-grupo="CALIDAD_DROPS">
        <div class="nombre">CALIDAD DROPS</div>
        <div class="leds" data-grupo="CALIDAD_DROPS" data-linea="linea1"></div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="tiempos" data-grupo="CALIDAD_DROPS"></div>
    </div>

    <div class="grupo" data-grupo="CALIDAD_BEDROCK">
        <div class="nombre">CALIDAD BEDROCK</div>
        <div class="leds" data-grupo="CALIDAD_BEDROCK" data-linea="linea1"></div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="tiempos" data-grupo="CALIDAD_BEDROCK"></div>
    </div>
</div>
</div>
<div class="footer">
    <button class="usuario-btn btn-rojo" onclick="volverAPantalla1()">Cerrar sesi√≥n</button>
</div>
</section>

<section id="pantalla3" class="pantalla">
<header class="header">
    <h1 id="tituloReportes">REPORTES</h1>
</header>
<div class="zona-centro">
    <div id="selectoresReportes" class="btn-contenedor">
        <button class="usuario-btn" data-reporte="produccion">PRODUCCI√ìN</button>
        <button class="usuario-btn" data-reporte="logistica">LOG√çSTICA</button>
        <button class="usuario-btn" data-reporte="calidad">CALIDAD</button>
        <button class="usuario-btn" data-reporte="resumen">RESUMEN EJECUTIVO</button>
    </div>
    <div id="contenedorReporte" class="contenedor-reporte">
        <h2>Selecciona un reporte</h2>
    </div>
</div>
<div class="footer">
    <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver</button>
</div>
</section>

<section id="pantalla4" class="pantalla" style="display: none;">
<header class="header">
    <h1>DASHBOARD DE SUPERVISOR</h1>
</header>
<div class="filtros-dashboard">
    <label for="fechaDashboard">Fecha:</label>
    <input type="date" id="fechaDashboard">
    <label for="turnoDashboardSelect">Turno:</label>
    <select id="turnoDashboardSelect">
        <option value="todos">Todos</option>
        <option value="Turno 1">Turno 1</option>
        <option value="Turno 2">Turno 2</option>
    </select>
</div>
  <div class="kpis-grid">
    <div class="kpi-card">
        <h3>Tarimas Confirmadas</h3>
        <div class="valor" id="dashTarimasConfirmadas">0</div>
    </div>
    <div class="kpi-card">
        <h3>Tarimas Recolectadas</h3>
        <div class="valor" id="dashTarimasRecolectadas">0</div>
    </div>
    <div class="kpi-card" id="kpiTiempoPromedio">
        <h3>Tiempo Promedio</h3>
        <div class="valor" id="dashTiempoPromedio">0 min</div>
    </div>
    <div class="kpi-card" id="kpiTasaRechazo">
        <h3>Tasa de Rechazo</h3>
        <div class="valor" id="dashTasaRechazo">0%</div>
    </div>
</div>
<div class="graficos-container">
    <div class="panel">
        <h3>Producci√≥n por √Årea</h3>
        <div style="position: relative; height: 300px;"><canvas id="graficoProduccionDash"></canvas></div>
    </div>
    <div class="panel">
        <h3>Estado de Calidad</h3>
        <div style="position: relative; height: 300px;"><canvas id="graficoCalidadDash"></canvas></div>
    </div>
    <div class="panel">
        <h3>Recolecciones por Hora</h3>
        <div style="position: relative; height: 300px;"><canvas id="graficoLogisticaDash"></canvas></div>
    </div>
</div>
<div class="panel" style="grid-area: pendientes;">
    <h3>Tarimas Pendientes por Recolectar</h3>
    <table id="tablaPendientes">
        <thead>
            <tr>
                <th>√Årea</th>
                <th>Tarimas Pendientes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
<div class="footer">
    <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver al inicio</button>
</div>
</section>

<div id="modalCalidad" class="modal-calidad">
  <div class="modal-content">
    <h3 id="modalCalidadTitulo">Selecciona el estado:</h3>
    <div class="opciones">
      <button class="opcion-btn" data-color="rojo">Rechazada üî¥</button>
      <button class="opcion-btn" data-color="verde">Liberada üü¢</button>
    </div>
    <button class="cerrar-btn">Cerrar</button>
  </div>
</div>
<div id="modalOpcionesCalidad" class="modal">
  <div class="modal-content">
    <h3>Asignar tarima a LED de Calidad</h3>
    <label for="selectLedCalidad">Selecciona LED:</label>
    <select id="selectLedCalidad"></select>
    <div class="modal-actions">
      <button id="btnAsignarTarimaCalidad">Asignar</button>
      <button onclick="cerrarModalCalidad()">Cancelar</button>
    </div>
  </div>
</div>

<style>
.modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
.modal-content { background: #fff; padding: 20px; margin: 10% auto; width: 90%; max-width: 400px; border-radius: 10px; }
.modal-actions { margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; }
</style>
  
<div id="modalRechazo" class="modal-calidad">
  <div class="modal-content">
    <h3>Detalles del Rechazo</h3>
    <form id="formularioRechazo">
        <label for="empleado">Empleado Originador:</label>
        <input type="text" id="empleado" name="empleado" required>
        <label for="linea">L√≠nea afectada:</label>
        <input type="text" id="linea" name="linea" required>
        <label for="parte">No. de parte:</label>
        <input type="text" id="parte" name="parte" required>
        <label for="descripcionParte">Descripci√≥n del No. de parte:</label>
        <input type="text" id="descripcionParte" name="descripcionParte" required>
        <label for="problema">Descripci√≥n del problema:</label>
        <textarea id="problema" name="problema" required></textarea>
        <label for="causa">Causa ra√≠z del problema:</label>
        <textarea id="causa" name="causa" required></textarea>
        <label for="accion">Acci√≥n correctiva:</label>
        <textarea id="accion" name="accion" required></textarea>
        <div class="modal-actions">
            <button type="submit">Guardar Rechazo</button>
            <button type="button" onclick="cerrarModalRechazo()">Cancelar</button>
        </div>
    </form>
  </div>
</div>
  <div id="modalAsignarTarimaProduccion" class="modal-produccion">
  <div class="modal-content">
    <h3>Confirmar Tarima en Producci√≥n</h3>
    <label for="selectTarimaProduccion">Selecciona Tarima Recibida:</label>
    <select id="selectTarimaProduccion"></select>
    <label for="selectLedProduccion">Asignar al LED:</label>
    <select id="selectLedProduccion"></select>
    <div class="modal-actions">
      <button id="btnAsignarProduccion">Confirmar</button>
      <button onclick="cerrarModalProduccion()">Cancelar</button>
    </div>
  </div>
</div>
  
<style>
.modal-produccion {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}
.modal-produccion .modal-content {
  background: #222; padding: 20px; border-radius: 12px; color: #fff; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
.modal-produccion h3 { margin-bottom: 15px; }
.modal-produccion select { width: 100%; padding: 8px; margin: 10px 0; border-radius: 6px; border: none; }
.modal-actions { display: flex; justify-content: space-around; margin-top: 15px; }
.modal-actions button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; }
#btnAsignarProduccion { background: #4caf50; color: #fff; }
#btnAsignarProduccion:hover { filter: brightness(1.2); }
.modal-actions button:last-child { background: #555; color: #fff; }
.modal-actions button:last-child:hover { background: #777; }
#modalAsignarTarimaProduccion .modal-content {
  background: #fff; padding: 20px; margin: 10% auto; width: 90%; max-width: 400px; border-radius: 10px;
}
</style>
  <button class="mt-fab" id="mtOpenBtn" style="display:none;" title="Identificaci√≥n de Tarima">TARIMAS</button>

<div id="mtPanel" class="mt-panel" aria-hidden="true">
  <div class="mt-panel-content">
    <button id="mtCloseBtn" class="mt-close" aria-label="Cerrar panel">&times;</button>
    <h2>Identificaci√≥n de Tarima</h2>
    
    <div id="tarimasPendientesPanel" style="display:none;">
      <h3>Tarimas pendientes por inspecci√≥n</h3>
      <ul id="listaTarimasPendientes" class="mt-list"></ul>
    </div>

    <p>Escanea o ingresa un c√≥digo <b>BX</b> para ver detalles:</p>
    <div class="mt-row">
      <input type="text" id="bxInput" placeholder="Escanear/pegar c√≥digo BX..." autocomplete="off" />
      <button id="buscarTarimaBtn" class="mt-btn mt-primary">Buscar</button>
    </div>

    <div id="tarimaInfo" class="mt-card" style="display:none;">
      <h3>Tarima encontrada</h3>
      <div class="mt-grid">
        <div><b>ID:</b> <span id="tarimaId">‚Äî</span></div>
        <div><b>Empleado:</b> <span id="empleado">‚Äî</span></div>
        <div><b>Turno:</b> <span id="turno">‚Äî</span></div>
        <div><b>Total cajas:</b> <span id="totalCajas">0</span></div>
        <div><b>Total piezas:</b> <span id="totalPiezas">0</span></div>
      </div>
      <h4>Detalle de cajas (BX | piezas)</h4>
      <ul id="listaCajas" class="mt-list"></ul>
      <div id="ledAssignment" class="mt-assign" style="display:none;">
        <label for="ledSelect">Asignar LED a esta tarima:</label>
        <div class="mt-row">
          <select id="ledSelect" class="mt-select"></select>
          <button id="asignarLedBtn" class="mt-btn mt-success">Asignar LED</button>
        </div>
        <small>Nota: los LEDs solo podr√°n encenderse/apagarse si tienen tarima asignada.</small>
      </div>
    </div>
  </div>
</div>

<div id="modalAlerta" class="custom-modal-overlay">
    <div class="custom-modal">
        <h3 id="alertaTitulo">Notificaci√≥n</h3>
        <p id="alertaMensaje"></p>
        <div class="custom-modal-actions">
            <button id="alertaBotonCerrar" class="modal-btn-confirm">Aceptar</button>
        </div>
    </div>
</div>

<div id="modalConfirmacion" class="custom-modal-overlay">
    <div class="custom-modal">
        <h3 id="confirmacionTitulo">Confirmaci√≥n</h3>
        <p id="confirmacionMensaje"></p>
        <div class="custom-modal-actions">
            <button id="confirmacionBotonCancelar" class="modal-btn-cancel">Cancelar</button>
            <button id="confirmacionBotonOk" class="modal-btn-confirm">Confirmar</button>
        </div>
    </div>
</div>

<div id="modalContrase√±a" class="custom-modal-overlay">
    <div class="custom-modal">
        <h3 id="contrase√±aTitulo">Acceso Requerido</h3>
        <p id="contrase√±aMensaje"></p>
        <input type="password" id="contrase√±aInput" placeholder="Introduce la contrase√±a...">
        <div class="custom-modal-actions">
            <button id="contrase√±aBotonCancelar" class="modal-btn-cancel">Cancelar</button>
            <button id="contrase√±aBotonOk" class="modal-btn-confirm">Aceptar</button>
        </div>
    </div>
</div>

<script>
// ================= CONFIG Y ESTADO =================
const CONFIG = {
    USUARIOS: ['MULTIPORT', 'BEDROCK', 'DROPS', 'LOG√çSTICA', 'SUPERVISOR', 'CALIDAD'],
    PRODUCCION_GRUPOS: ['MULTIPORT', 'BEDROCK', 'DROPS'],
    PASSWORDS: {
        'LOG√çSTICA': 'LOGRAM', 'MULTIPORT': 'MP25', 'BEDROCK': 'BR25', 'DROPS': 'DROP25', 'SUPERVISOR': 'SUP25',
        'CALIDAD_MULTIPORT': 'AQLMP', 'CALIDAD_DROPS': 'AQLDP', 'CALIDAD_BEDROCK': 'AQLBR', 'REPORTES': 'REPO25', 'DASHBOARD': 'DASH25'
    },
    LEDS_POR_GRUPO: {
        'MULTIPORT': 5, 'BEDROCK': 5, 'DROPS': 5, 'CALIDAD_MULTIPORT': 5, 'CALIDAD_BEDROCK': 5, 'CALIDAD_DROPS': 5
    }
};

let usuarioSeleccionado = null;
let ledActivoParaFormulario = { grupo: null, idx: null, linea: null };
let reporteActual = null;
let datosFiltradosReporte = null;
let miGrafico;
let graficosDashboard = {};
let dashboardUpdateInterval;

// ================= FIREBASE =================
const firebaseConfig = {
    apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
    authDomain: "panel-logistica.firebaseapp.com",
    databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
    projectId: "panel-logistica",
    storageBucket: "panel-logistica.appspot.com",
    messagingSenderId: "38365879945",
    appId: "1:38365879945:web:e2f3590fe77f013dba3058"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const db = database; 
const ledRef = database.ref('estadoLEDs');
let historialRef;
let contadoresCalidadRef;
let rechazosDetalladosRef;
let dashboardListeners = [];

window.database = window.database || firebase.database();
window.__usuarioActual = null;

(function compatSeleccionarUsuario(){
  const legacy = window.seleccionarUsuario;
  window._seleccionarUsuarioOriginal = (typeof legacy === 'function') ? legacy : null;
  window.seleccionarUsuario = function(usuarioClave) {
    try {
      window.__usuarioActual = String(usuarioClave || '').toUpperCase();
      const isDark = window.__usuarioActual.startsWith('CALIDAD') || CONFIG.PRODUCCION_GRUPOS.includes(window.__usuarioActual);
      document.body.classList.toggle('theme-dark', isDark);
      
      const fab = document.getElementById('mtOpenBtn');
      if (fab) {
          const userBase = window.__usuarioActual.replace('CALIDAD_','');
          fab.style.display = (userBase === 'MULTIPORT') ? 'block' : 'none';
      }

      if (window._seleccionarUsuarioOriginal) return window._seleccionarUsuarioOriginal(usuarioClave);
      console.info('[Compat] seleccionarUsuario activo. Usuario:', window.__usuarioActual);
    } catch (e) { console.error('Error en seleccionarUsuario compat:', e); }
  };
})();

// ================= MODALES PERSONALIZADOS =================
const modalAlerta = document.getElementById('modalAlerta');
const modalConfirmacion = document.getElementById('modalConfirmacion');
const modalContrase√±a = document.getElementById('modalContrase√±a');

function mostrarAlerta(mensaje, titulo = "Notificaci√≥n") {
    document.getElementById('alertaTitulo').textContent = titulo;
    document.getElementById('alertaMensaje').textContent = mensaje;
    modalAlerta.classList.add('visible');
    return new Promise(resolve => {
        document.getElementById('alertaBotonCerrar').onclick = () => {
            modalAlerta.classList.remove('visible');
            resolve();
        };
    });
}

function mostrarConfirmacion(mensaje, titulo = "Confirmaci√≥n") {
    document.getElementById('confirmacionTitulo').textContent = titulo;
    document.getElementById('confirmacionMensaje').textContent = mensaje;
    modalConfirmacion.classList.add('visible');
    return new Promise(resolve => {
        document.getElementById('confirmacionBotonOk').onclick = () => {
            modalConfirmacion.classList.remove('visible');
            resolve(true);
        };
        document.getElementById('confirmacionBotonCancelar').onclick = () => {
            modalConfirmacion.classList.remove('visible');
            resolve(false);
        };
    });
}

function mostrarPromptContrase√±a(mensaje, titulo = "Acceso Requerido") {
    document.getElementById('contrase√±aTitulo').textContent = titulo;
    document.getElementById('contrase√±aMensaje').textContent = mensaje;
    const input = document.getElementById('contrase√±aInput');
    input.value = '';
    modalContrase√±a.classList.add('visible');
    input.focus();

    return new Promise(resolve => {
        const resolver = (value) => {
            modalContrase√±a.classList.remove('visible');
            document.getElementById('contrase√±aBotonOk').onclick = null;
            document.getElementById('contrase√±aBotonCancelar').onclick = null;
            input.onkeypress = null;
            resolve(value);
        };
        
        document.getElementById('contrase√±aBotonOk').onclick = () => resolver(input.value);
        document.getElementById('contrase√±aBotonCancelar').onclick = () => resolver(null);
        input.onkeypress = (e) => {
            if (e.key === 'Enter') resolver(input.value);
        };
    });
}


// ================= Panel de Identificaci√≥n de Tarimas =================
const MT = {
  ui: {
    panel:    document.getElementById('mtPanel'),
    openBtn: document.getElementById('mtOpenBtn'),
    closeBtn:document.getElementById('mtCloseBtn'),
    bxInput: document.getElementById('bxInput'),
    buscarBtn: document.getElementById('buscarTarimaBtn'),
    infoBox: document.getElementById('tarimaInfo'),
    pendientesPanel: document.getElementById('tarimasPendientesPanel'),
    fields: { id: document.getElementById('tarimaId'), empleado: document.getElementById('empleado'), turno: document.getElementById('turno'), totalCajas: document.getElementById('totalCajas'), totalPiezas: document.getElementById('totalPiezas'), listaCajas: document.getElementById('listaCajas') },
    asignacion: { wrap: document.getElementById('ledAssignment'), select: document.getElementById('ledSelect'), btn: document.getElementById('asignarLedBtn') }
  },
  state: { tarimaActual: null }
};

if (MT.ui.openBtn) MT.ui.openBtn.addEventListener('click', () => {
    MT.ui.panel.classList.add('open');
    if(usuarioSeleccionado && usuarioSeleccionado.startsWith('CALIDAD_')) {
        MT.ui.pendientesPanel.style.display = 'block';
        MT.ui.infoBox.style.display = 'none';
        MT.ui.bxInput.value = '';
        renderTarimasPendientes();
    }
});
if (MT.ui.closeBtn) MT.ui.closeBtn.addEventListener('click', () => MT.ui.panel.classList.remove('open'));
if (MT.ui.buscarBtn) MT.ui.buscarBtn.addEventListener('click', () => { const bx = (MT.ui.bxInput.value || '').trim(); if (bx) buscarTarimaPorBX(bx); });
if (MT.ui.bxInput) MT.ui.bxInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') MT.ui.buscarBtn.click(); });

function buscarTarimaPorBX(bxCode) {
  database.ref('tarimas').once('value').then(snapshot => {
    let encontrada = null;
    snapshot.forEach(tSnap => {
      const t = tSnap.val() || {};
      const cajas = t.cajas || {};
      for (const k in cajas) {
        if (cajas[k] && cajas[k].codigoCaja === bxCode) {
          encontrada = { id: t.id || tSnap.key, ...t };
          break;
        }
      }
      if (encontrada) return true;
    });

    if (!encontrada) {
      MT.ui.infoBox.style.display = 'none';
      mostrarAlerta('No se encontr√≥ tarima con ese BX.');
      return;
    }
    MT.state.tarimaActual = normalizarTarima(encontrada);
    renderTarimaEncontrada(MT.state.tarimaActual);
    MT.ui.pendientesPanel.style.display = 'none';
  }).catch(err => {
    console.error('Error buscando tarima:', err);
    mostrarAlerta('Error al buscar la tarima. Reintenta.');
  });
}

function normalizarTarima(t) {
  const out = {
    id: t.id,
    empleadoId: t.empleadoId || t.empleado || t.id_empleado || 'N/D',
    turno: t.turno || 'N/D',
    totalCajas: 0,
    totalPiezas: 0,
    cajas: []
  };
  const cajas = t.cajas || {};
  for (const cid in cajas) {
    const c = cajas[cid] || {};
    out.cajas.push({
      id: cid,
      codigoCaja: c.codigoCaja || '‚Äî',
      cantidadPiezas: Number(c.cantidadPiezas || c.piezas || 0)
    });
  }
  out.totalCajas = out.cajas.length;
  out.totalPiezas = out.cajas.reduce((a,c)=>a + (Number.isFinite(c.cantidadPiezas)?c.cantidadPiezas:0), 0);
  return out;
}

function cargarLedsDisponibles() {
    const sel = MT.ui.asignacion.select;
    const grupoCalidad = usuarioSeleccionado;
    if (!grupoCalidad || !grupoCalidad.startsWith('CALIDAD_')) return;
    db.ref(`estadoLEDs/${grupoCalidad}/linea1`).on('value', snap => {
        sel.innerHTML = '<option value="">Seleccione un LED...</option>';
        const ledsEstado = snap.val() || {};
        const totalLeds = CONFIG.LEDS_POR_GRUPO[grupoCalidad] || 5;
        for (let i = 0; i < totalLeds; i++) {
            if (!ledsEstado[i]?.tarimaId) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `LED ${i+1}`;
                sel.appendChild(opt);
            }
        }
    });
}

function renderTarimasPendientes() {
    const lista = document.getElementById('listaTarimasPendientes');
    lista.innerHTML = '<li>Cargando...</li>';
    db.ref('tarimas').once('value').then(snap => {
        const tarimas = snap.val() || {};
        db.ref('tarimasAsignadas').once('value').then(snap2 => {
            const asignadas = snap2.val() || {};
            const usadas = Object.values(asignadas).map(a => a.tarimaId);
            lista.innerHTML = '';
            const pendientes = Object.values(tarimas).filter(t => t.id && !usadas.includes(t.id));
            if(pendientes.length === 0) {
                lista.innerHTML = '<li>No hay tarimas pendientes.</li>';
            } else {
                pendientes.forEach(t => {
                    const li = document.createElement('li');
                    li.textContent = `#${t.id}`;
                    li.style.cursor = "pointer";
                    li.onclick = () => {
                        MT.ui.bxInput.value = t.cajas ? Object.values(t.cajas)[0].codigoCaja : '';
                        buscarTarimaPorBX(MT.ui.bxInput.value);
                    };
                    lista.appendChild(li);
                });
            }
        });
    });
}

db.ref('tarimas').on('value', renderTarimasPendientes);
db.ref('tarimasAsignadas').on('value', renderTarimasPendientes);

async function asignarLedATarima(ledIndex, tarimaId) {
    const grupo = usuarioSeleccionado;
    if (!grupo || !tarimaId || ledIndex === null) return mostrarAlerta('Datos incompletos para asignar.');
    const ledId = `${grupo}-linea1-${ledIndex}`;

    const snap = await db.ref('tarimasAsignadas').orderByChild('tarimaId').equalTo(tarimaId).once('value');
    if (snap.exists()) {
        return mostrarAlerta(`Error: La tarima ${tarimaId} ya ha sido asignada a un LED.`);
    }

    const ledEstadoRef = db.ref(`estadoLEDs/${grupo}/linea1/${ledIndex}`);
    try {
        await ledEstadoRef.set({
            color: 'naranja',
            tarimaId: tarimaId,
            usuario: usuarioSeleccionado,
            timestamp: new Date().toISOString()
        });
        await db.ref('tarimasAsignadas').push({ ledId, tarimaId, timestamp: Date.now() });
        await mostrarAlerta(`‚úÖ Tarima ${tarimaId} asignada al LED ${parseInt(ledIndex) + 1}`);
        MT.ui.panel.classList.remove('open');
        MT.ui.infoBox.style.display = 'none';
        MT.ui.bxInput.value = '';
    } catch (err) {
        console.error('Error asignando LED:', err);
        await mostrarAlerta('No se pudo asignar el LED.');
    }
}


function renderTarimaEncontrada(tarima) {
  MT.ui.fields.id.textContent = tarima.id;
  MT.ui.fields.empleado.textContent = tarima.empleadoId;
  MT.ui.fields.turno.textContent = tarima.turno;
  MT.ui.fields.totalCajas.textContent = tarima.totalCajas;
  MT.ui.fields.totalPiezas.textContent = tarima.totalPiezas;

  MT.ui.fields.listaCajas.innerHTML = '';
  tarima.cajas.forEach(c => {
    const li = document.createElement('li');
    li.textContent = `${c.codigoCaja}  |  ${c.cantidadPiezas} pz`;
    MT.ui.fields.listaCajas.appendChild(li);
  });

  const isCalidad = (window.__usuarioActual || '').startsWith('CALIDAD');
  MT.ui.asignacion.wrap.style.display = isCalidad ? 'block' : 'none';

  if (isCalidad) {
    cargarLedsDisponibles();
    MT.ui.asignacion.btn.onclick = () => {
      const ledIndex = MT.ui.asignacion.select.value;
      if (ledIndex === '' || !tarima.id) return;
      asignarLedATarima(ledIndex, tarima.id);
    };
  }
  MT.ui.infoBox.style.display = 'block';
}

// ================= FUNCIONES DE RENDER Y VISIBILIDAD =================
function inyectaLEDs(){
    document.querySelectorAll('.grupo').forEach(grupoDiv => {
        grupoDiv.classList.add('oculto');
    });
    const usuario = usuarioSeleccionado;

    if (usuario === 'SUPERVISOR') {
        document.querySelectorAll('.grupo').forEach(g => g.classList.remove('oculto'));
    } else if (usuario === 'LOG√çSTICA') {
        document.querySelectorAll('.grupo:not([data-grupo*="CALIDAD_"])').forEach(g => g.classList.remove('oculto'));
    } else if (usuario.startsWith('CALIDAD_')) {
        document.querySelector(`.grupo[data-grupo="${usuario}"]`)?.classList.remove('oculto');
    } else if (CONFIG.PRODUCCION_GRUPOS.includes(usuario)) {
        document.querySelector(`.grupo[data-grupo="${usuario}"]`)?.classList.remove('oculto');
        document.querySelector(`.grupo[data-grupo="CALIDAD_${usuario}"]`)?.classList.remove('oculto');
    }

    document.querySelectorAll('.grupo:not(.oculto) .leds').forEach(contenedor => {
        const grupoLeds = contenedor.dataset.grupo;
        const linea = contenedor.dataset.linea;
        const ledsPorLinea = CONFIG.LEDS_POR_GRUPO[grupoLeds] || 5;
        contenedor.innerHTML = '';
        for(let i = 0; i < ledsPorLinea; i++){
            const led = document.createElement('div');
            led.className = 'led';
            led.title = `${grupoLeds} ‚Ä¢ ${linea} ‚Ä¢ LED ${i+1}`;
            led.addEventListener('click', () => togglearLED(grupoLeds, i, linea));
            contenedor.appendChild(led);
        }
    });
}

function pintarEstado() {
    db.ref('estadoLEDs').on('value', snapshot => {
        const estados = snapshot.val() || {};
        document.querySelectorAll('.leds').forEach(contenedor => {
            const grupoLeds = contenedor.dataset.grupo;
            const linea = contenedor.dataset.linea;
            const ledsEstado = estados[grupoLeds]?.[linea] || {};
            contenedor.querySelectorAll('.led').forEach((led, index) => {
                led.className = 'led';
                led.innerHTML = '';
                const estado = ledsEstado[index];
                if (estado) {
                    let tarimaIdShort = estado.tarimaId ? "..." + estado.tarimaId.slice(-4) : "";
                    if (grupoLeds.startsWith('CALIDAD_') && estado.color) {
                        led.classList.add(estado.color);
                        if (tarimaIdShort) led.innerHTML = `<span>${tarimaIdShort}</span>`;
                    } else if (estado.encendido) {
                        led.classList.add('on');
                        if (tarimaIdShort) led.innerHTML = `<span>${tarimaIdShort}</span>`;
                    }
                }
            });
        });
    });
}

// ================= L√ìGICA DE INTERACCI√ìN PRINCIPAL (togglearLED) =================
function esGrupoDeTarimas(grupo) {
    const grupoBase = grupo.replace('CALIDAD_', '');
    return grupoBase === 'MULTIPORT';
}

async function togglearLED(grupo, idx, linea = 'linea1') {
    const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
    const usuarioActual = usuarioSeleccionado || '';
    
    const snapshot = await ledRef.once('value');
    const estadoActual = snapshot.val() || {};
    const { fecha, turno } = obtenerTurnoActual();

    // ===============================================
    // FLUJO PARA MULTIPORT (SISTEMA DE TARIMA ID)
    // ===============================================
    if (esGrupoDeTarimas(grupo)) {
        if (usuarioActual === 'CALIDAD_MULTIPORT' && grupo === usuarioActual) {
            if (!estadoActual.tarimaId) return mostrarAlerta('Este LED est√° vac√≠o. Usa el panel "TARIMAS" para asignar una.');
            if (estadoActual.color === 'verde') return mostrarAlerta('Esta tarima ya ha sido liberada.');
            
            if (estadoActual.color === 'rojo') {
                if (await mostrarConfirmacion('Esta tarima fue rechazada. ¬øConfirmas que ha sido corregida y deseas liberarla ahora?')) {
                    liberarTarima(estadoActual.tarimaId, grupo);
                    ledRef.update({ color: 'verde' });
                }
                return;
            }
            abrirModalCalidad(grupo, idx, linea, estadoActual.tarimaId);
        }
        else if (usuarioActual === 'MULTIPORT' && grupo === 'CALIDAD_MULTIPORT') {
            if (estadoActual.color === 'verde' && estadoActual.tarimaId) {
                const tarimaId = estadoActual.tarimaId;
                const recibidasRef = db.ref(`tarimasRecibidas/${usuarioActual}`);
                const yaRecibidaSnap = await recibidasRef.orderByChild('tarimaId').equalTo(tarimaId).once('value');
                if (yaRecibidaSnap.exists()) {
                    return mostrarAlerta(`La tarima #${tarimaId} ya fue recibida anteriormente.`);
                }
                if (await mostrarConfirmacion(`¬øRecibir la tarima #${tarimaId} liberada por Calidad?`)) {
                    recibidasRef.push({ tarimaId, recibidaDe: grupo, timestampRecibida: new Date().toISOString() });
                    db.ref(`historialLogs/${fecha}/${turno}`).push({ usuario: usuarioActual, grupo, accion: 'recibida_de_calidad', tarimaId, timestamp: new Date().toISOString() });
                    ledRef.set(null);
                    await mostrarAlerta(`Tarima #${tarimaId} recibida. Ahora puedes confirmarla en uno de tus LEDs.`);
                }
            }
        }
        else if (usuarioActual === 'MULTIPORT' && grupo === usuarioActual) {
            if (!estadoActual.encendido) {
                mostrarModalProduccion(grupo, idx, linea);
            } else {
                await mostrarAlerta('Este LED ya tiene una tarima en proceso.');
            }
        }
        else if (usuarioActual === 'LOG√çSTICA' && grupo === 'MULTIPORT') {
            if (estadoActual.encendido && estadoActual.tarimaId) {
                if (!(await mostrarConfirmacion(`¬øConfirmas la recolecci√≥n de la tarima ${estadoActual.tarimaId}?`))) return;
                const horaEncendido = estadoActual.horaEncendido;
                const horaApagado = new Date().toISOString();
                const tiempoRecoleccion = Math.round((new Date(horaApagado).getTime() - new Date(horaEncendido).getTime()) / 60000);
                db.ref(`historialLogs/${fecha}/${turno}`).push({ usuario: usuarioActual, grupo, accion: 'recolectada', tarimaId: estadoActual.tarimaId, timestamp: horaApagado, horaEncendido, horaApagado, tiempoRecoleccion });
                actualizarContadoresTarimas(grupo, 'recolectadas');
                ledRef.set(null);
                await mostrarAlerta(`‚úÖ Tarima ${estadoActual.tarimaId} recolectada en ${tiempoRecoleccion} minutos.`);
            }
        }
        return;
    }

    // ===============================================
    // FLUJO PARA DROPS Y BEDROCK (SISTEMA SIMPLE DE LEDS)
    // ===============================================
    else {
        const ledIdentifier = `${grupo}-${linea}-${idx + 1}`;
        
        if (usuarioActual.startsWith('CALIDAD_') && grupo === usuarioActual) {
            if (!estadoActual.color) {
                if (await mostrarConfirmacion(`¬øIniciar revisi√≥n en el LED ${idx + 1}?`)) {
                    ledRef.set({ color: 'naranja', timestamp: new Date().toISOString() });
                    db.ref(`historialLogs/${fecha}/${turno}`).push({ accion: 'revision_iniciada', led: ledIdentifier, grupo, usuario: usuarioActual, timestamp: new Date().toISOString() });
                }
            } else if (estadoActual.color === 'naranja') {
                abrirModalCalidad(grupo, idx, linea, null); // null para tarimaId
            } else if (estadoActual.color === 'rojo') {
                if (await mostrarConfirmacion('Este LED fue rechazado. ¬øConfirmas que ha sido corregido y deseas liberarlo ahora?')) {
                    liberarLedSimple(grupo, idx, linea);
                }
            } else {
                await mostrarAlerta(`Este LED ya ha sido liberado.`);
            }
        }
        else if (CONFIG.PRODUCCION_GRUPOS.includes(usuarioActual) && grupo.startsWith('CALIDAD_')) {
            if (estadoActual.color === 'verde') {
                if (await mostrarConfirmacion(`¬øRecibir material del LED de Calidad?`)) {
                    ledRef.set(null);
                    db.ref(`historialLogs/${fecha}/${turno}`).push({ accion: 'led_recibido', led: ledIdentifier, grupo, usuario: usuarioActual, timestamp: new Date().toISOString() });
                    await mostrarAlerta('Material recibido. Ahora puedes encender un LED en tu √°rea.');
                }
            }
        }
        else if (CONFIG.PRODUCCION_GRUPOS.includes(usuarioActual) && grupo === usuarioActual) {
            if (!estadoActual.encendido) {
                if (await mostrarConfirmacion(`¬øEncender LED ${idx+1} para solicitar recolecci√≥n?`)) {
                    const horaEncendido = new Date().toISOString();
                    ledRef.set({ encendido: true, horaEncendido });
                    db.ref(`historialLogs/${fecha}/${turno}`).push({ accion: 'led_encendido', led: ledIdentifier, grupo, usuario: usuarioActual, timestamp: horaEncendido, horaEncendido });
                    actualizarContadoresTarimas(grupo, 'encendidos');
                }
            } else {
                await mostrarAlerta('Este LED ya est√° encendido.');
            }
        }
        else if (usuarioActual === 'LOG√çSTICA') {
             if (estadoActual.encendido) {
                if (!(await mostrarConfirmacion(`¬øConfirmas la recolecci√≥n del LED ${grupo}-${idx + 1}?`))) return;
                const horaEncendido = estadoActual.horaEncendido;
                const horaApagado = new Date().toISOString();
                const tiempoRecoleccion = Math.round((new Date(horaApagado).getTime() - new Date(horaEncendido).getTime()) / 60000);
                db.ref(`historialLogs/${fecha}/${turno}`).push({ usuario: usuarioActual, grupo, accion: 'recolectada', led: ledIdentifier, timestamp: horaApagado, horaEncendido, horaApagado, tiempoRecoleccion });
                actualizarContadoresTarimas(grupo, 'recolectadas');
                ledRef.set(null);
                await mostrarAlerta(`‚úÖ LED ${grupo}-${idx + 1} recolectado en ${tiempoRecoleccion} minutos.`);
            }
        }
    }
}

// ================= L√ìGICA DE PROCESOS Y MODALES =================
async function liberarTarima(tarimaId, grupo) {
    const { fecha, turno } = obtenerTurnoActual();
    
    // Esta funci√≥n ahora solo se usa para Multiport
    await db.ref(`tarimas/${tarimaId}`).update({ estado: 'liberada', liberadaPor: usuarioSeleccionado, timestampLiberada: new Date().toISOString() });
    
    await db.ref(`historialLogs/${fecha}/${turno}`).push({
        usuario: usuarioSeleccionado, grupo, accion: 'liberada', tarimaId, timestamp: new Date().toISOString()
    });
    actualizarContadoresTarimas(grupo, 'liberadas');
    await mostrarAlerta(`‚úÖ Tarima ${tarimaId} liberada. Producci√≥n ahora puede recibirla.`);
    cerrarModalCalidad();
}

async function liberarLedSimple(grupo, idx, linea) {
    const { fecha, turno } = obtenerTurnoActual();
    const ledIdentifier = `${grupo}-${linea}-${idx + 1}`;
    await db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`).update({ color: 'verde' });
    await db.ref(`historialLogs/${fecha}/${turno}`).push({ usuario: usuarioSeleccionado, grupo, accion: 'led_liberado', led: ledIdentifier, timestamp: new Date().toISOString() });
    actualizarContadoresTarimas(grupo, 'liberadas');
    await mostrarAlerta(`‚úÖ LED liberado. Producci√≥n ahora puede recibirlo.`);
    cerrarModalCalidad();
}


async function guardarRechazo() {
    if (!ledSeleccionado.grupo) return;
    const { grupo, tarimaId, idx, linea } = ledSeleccionado;
    const form = document.getElementById('formularioRechazo');
    const data = {
        empleado: form.empleado.value, linea: form.linea.value, parte: form.parte.value,
        descripcionParte: form.descripcionParte.value, problema: form.problema.value,
        causa: form.causa.value, accion: form.accion.value, timestamp: new Date().toISOString()
    };
    
    if (esGrupoDeTarimas(grupo) && tarimaId) {
        await db.ref(`tarimas/${tarimaId}`).update({ estado: 'rechazada', rechazo: data, rechazadoPor: usuarioSeleccionado, timestampRechazo: new Date().toISOString() });
    }
    
    const { fecha, turno } = obtenerTurnoActual();
    const ledIdentifier = `${grupo}-${linea}-${idx + 1}`;
    await db.ref(`historialLogs/${fecha}/${turno}`).push({ usuario: usuarioSeleccionado, grupo, accion: 'rechazada', tarimaId, led: ledIdentifier, detalles: data, timestamp: new Date().toISOString() });
    actualizarContadoresTarimas(grupo, 'rechazadas');
    await db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`).update({ color: 'rojo' });
    
    await mostrarAlerta(`‚ùå ${esGrupoDeTarimas(grupo) ? `Tarima ${tarimaId}` : 'LED'} rechazado.`);
    cerrarModalRechazo();
    form.reset();
}

async function confirmarTarimaProduccion(grupo, idx, linea) {
    const select = document.getElementById('selectTarimaProduccion');
    const tarimaKey = select.value;
    if (!tarimaKey) return mostrarAlerta("Debes seleccionar una tarima.");

    const recibidaRef = db.ref(`tarimasRecibidas/${grupo}/${tarimaKey}`);
    const snapshot = await recibidaRef.once('value');
    const tarima = snapshot.val();
    if (!tarima) return mostrarAlerta("Tarima no encontrada.");

    const { fecha, turno } = obtenerTurnoActual();
    await db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`).set({
        encendido: true,
        tarimaId: tarima.tarimaId,
        usuario: usuarioSeleccionado,
        timestamp: new Date().toISOString(),
        horaEncendido: new Date().toISOString()
    });
    await db.ref(`historialLogs/${fecha}/${turno}`).push({
        usuario: usuarioSeleccionado,
        grupo,
        accion: 'confirmada_en_produccion',
        tarimaId: tarima.tarimaId,
        timestamp: new Date().toISOString()
    });
    actualizarContadoresTarimas(grupo, 'confirmadas');
    await recibidaRef.remove();
    await mostrarAlerta(`‚úÖ Tarima ${tarima.tarimaId} confirmada en LED ${linea}-${idx+1}`);
    cerrarModalProduccion();
}

let ledSeleccionado = { grupo: null, idx: null, linea: null, tarimaId: null };

function abrirModalCalidad(grupo, idx, linea, tarimaId) {
    ledSeleccionado = { grupo, idx, linea, tarimaId };
    const modal = document.getElementById('modalCalidad');
    const titulo = document.getElementById('modalCalidadTitulo');
    
    titulo.textContent = esGrupoDeTarimas(grupo) ? 'Selecciona el estado de la tarima:' : 'Selecciona el estado del LED:';

    modal.classList.add('visible');
    const setupButton = (selector, callback) => {
        const oldBtn = modal.querySelector(selector);
        const newBtn = oldBtn.cloneNode(true);
        oldBtn.parentNode.replaceChild(newBtn, oldBtn);
        newBtn.onclick = callback;
    };
    setupButton('.opcion-btn[data-color="rojo"]', () => {
        modal.classList.remove('visible');
        document.getElementById('modalRechazo').classList.add('visible');
    });
    setupButton('.opcion-btn[data-color="verde"]', () => {
        if (esGrupoDeTarimas(grupo)) {
            liberarTarima(tarimaId, grupo);
        } else {
            liberarLedSimple(grupo, idx, linea);
        }
        db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`).update({ color: 'verde' });
        modal.classList.remove('visible');
    });
    modal.querySelector('.cerrar-btn').onclick = () => modal.classList.remove('visible');
}

function cerrarModalCalidad() { document.getElementById('modalCalidad').classList.remove('visible'); }
function cerrarModalRechazo() { document.getElementById('modalRechazo').classList.remove('visible'); }
function cerrarModalProduccion() { document.getElementById('modalAsignarTarimaProduccion').style.display = 'none'; }

async function mostrarModalProduccion(grupo, idx, linea) {
    const modal = document.getElementById('modalAsignarTarimaProduccion');
    const selectTarima = modal.querySelector('#selectTarimaProduccion');
    const selectLed = modal.querySelector('#selectLedProduccion');
    ledSeleccionado = { grupo, idx, linea };

    const snapshot = await db.ref(`tarimasRecibidas/${grupo}`).once('value');
    const recibidas = snapshot.val() || {};
    selectTarima.innerHTML = '';
    const keys = Object.keys(recibidas);
    if (keys.length === 0) return mostrarAlerta("‚ö†Ô∏è No hay tarimas recibidas de Calidad para confirmar.");
    keys.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = `Tarima #${recibidas[k].tarimaId}`;
        selectTarima.appendChild(opt);
    });
    selectLed.innerHTML = `<option value="${idx}">${linea}-${idx+1}</option>`;
    modal.style.display = 'flex';
}

document.getElementById('btnAsignarProduccion').addEventListener('click', () => {
    const { grupo, idx, linea } = ledSeleccionado;
    confirmarTarimaProduccion(grupo, idx, linea);
});

// ================= NAVEGACI√ìN Y ARRANQUE =================
function formatoHora(isoString) { if (!isoString) return 'N/A'; const date = new Date(isoString); return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`; }
function obtenerTurnoActual() { const ahora = new Date(); let fecha = new Date(ahora); let turno = (ahora.getHours() > 6 || (ahora.getHours() === 6 && ahora.getMinutes() >= 30)) && (ahora.getHours() < 18 || (ahora.getHours() === 18 && ahora.getMinutes() < 30)) ? 'Turno 1' : 'Turno 2'; if (turno === 'Turno 2' && ahora.getHours() < 6) fecha.setDate(ahora.getDate() - 1); const fechaFormateada = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`; return { fecha: fechaFormateada, turno }; }
function iniciarListenersFirebase() { const { fecha, turno: turnoActualString } = obtenerTurnoActual(); document.getElementById('turnoActual').textContent = `Turno actual: ${turnoActualString}`; const rutaHistorialTurno = `historialLogs/${fecha}/${turnoActualString}`; if (historialRef) historialRef.off(); historialRef = db.ref(rutaHistorialTurno); historialRef.on('value', (snapshot) => { const logs = snapshot.val() || {}; let tarimasRecolectadasTotales = 0, tiempoTotalRecoleccion = 0; const contadores = {}; const grupos = ['MULTIPORT', 'BEDROCK', 'DROPS', 'CALIDAD_MULTIPORT', 'CALIDAD_BEDROCK', 'CALIDAD_DROPS']; grupos.forEach(g => { contadores[g] = { confirmadas: 0, recolectadas: 0, liberadas: 0, rechazadas: 0, encendidos: 0 }; }); const tiempos = { MULTIPORT: [], BEDROCK: [], DROPS: [] }; Object.values(logs).forEach(log => { if (!log.grupo || !contadores[log.grupo]) return; switch (log.accion) { case 'confirmada_en_produccion': contadores[log.grupo].confirmadas++; break; case 'led_encendido': contadores[log.grupo].encendidos++; break; case 'recolectada': contadores[log.grupo].recolectadas++; tarimasRecolectadasTotales++; if (log.tiempoRecoleccion != null) { tiempos[log.grupo]?.push(log); tiempoTotalRecoleccion += log.tiempoRecoleccion; } break; case 'rechazada': case 'led_rechazado': contadores[log.grupo].rechazadas++; break; case 'liberada': case 'led_liberado': contadores[log.grupo].liberadas++; break; } }); const tiempoPromedio = tarimasRecolectadasTotales > 0 ? Math.round(tiempoTotalRecoleccion / tarimasRecolectadasTotales) : 0; document.getElementById('tarimasTotales').textContent = tarimasRecolectadasTotales; document.getElementById('tiempoPromedio').textContent = `${tiempoPromedio} min`; document.getElementById('resumenTurno').classList.toggle('oculto', !(usuarioSeleccionado === 'LOG√çSTICA' || usuarioSeleccionado === 'SUPERVISOR')); Object.keys(contadores).forEach(grupo => { const el = document.querySelector(`.grupo[data-grupo="${grupo}"] .tarimas`); if (el) { const c = contadores[grupo]; if(grupo.startsWith('CALIDAD_')){ el.textContent = `Liberadas: ${c.liberadas} | Rechazadas: ${c.rechazadas}`; } else if(esGrupoDeTarimas(grupo)) { el.textContent = `Confirmadas: ${c.confirmadas}`; } else { el.textContent = `Tarimas: ${c.encendidos}`; } } }); Object.keys(tiempos).forEach(grupo => { const contenedorTiempos = document.querySelector(`.tiempos[data-grupo="${grupo}"]`); if (!contenedorTiempos) return; contenedorTiempos.innerHTML = ''; tiempos[grupo].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5).forEach(log => { const p = document.createElement('p'); const id = log.tarimaId ? `...${log.tarimaId.slice(-4)}` : log.led.replace(grupo + '-', ''); p.textContent = `ID ${id}: ${log.tiempoRecoleccion} min (a las ${formatoHora(log.horaApagado)})`; contenedorTiempos.appendChild(p); }); }); }); }
function actualizarContadoresTarimas(grupo, accion) { const { fecha, turno } = obtenerTurnoActual(); db.ref(`contadoresTarimas/${fecha}/${turno}/${grupo}/${accion}`).transaction(val => (val || 0) + 1); }
function activarPantalla(id){ document.querySelectorAll('.pantalla').forEach(p => { p.style.display = 'none'; p.classList.remove('activa'); }); const pantalla = document.getElementById(id); if(pantalla) { pantalla.style.display = 'flex'; pantalla.classList.add('activa'); } }
function volverAPantalla1(){ usuarioSeleccionado = null; if (historialRef) historialRef.off(); limpiarDashboardListeners(); activarPantalla('pantalla1'); }
async function seleccionarUsuario(usuario) {
    const password = await mostrarPromptContrase√±a(`Introduce la contrase√±a para ${usuario}`);
    if (password === null) return;
    let targetUser = usuario;
    let isValid = false;
    if (usuario === 'CALIDAD') {
        if (password === CONFIG.PASSWORDS.CALIDAD_MULTIPORT) { targetUser = 'CALIDAD_MULTIPORT'; isValid = true; }
        else if (password === CONFIG.PASSWORDS.CALIDAD_DROPS) { targetUser = 'CALIDAD_DROPS'; isValid = true; }
        else if (password === CONFIG.PASSWORDS.CALIDAD_BEDROCK) { targetUser = 'CALIDAD_BEDROCK'; isValid = true; }
    } else { isValid = password === CONFIG.PASSWORDS[usuario]; }
    if (isValid) {
        usuarioSeleccionado = targetUser;
        document.getElementById('tituloFijo').textContent = targetUser.replace('_', ' ');
        const fab = document.getElementById('mtOpenBtn');
        if (fab) { fab.style.display = esGrupoDeTarimas(targetUser) ? 'block' : 'none'; }
        activarPantalla('pantalla2');
        inyectaLEDs();
        pintarEstado();
        iniciarListenersFirebase();
    } else { await mostrarAlerta('Contrase√±a incorrecta.'); }
}
async function seleccionarReporte() { const password = await mostrarPromptContrase√±a('Introduce la contrase√±a para REPORTES'); if (password === CONFIG.PASSWORDS.REPORTES) { activarPantalla('pantalla3'); regresarASelectores(); } else if (password !== null) { await mostrarAlerta('Contrase√±a incorrecta.'); } }
async function seleccionarDashboard() { const password = await mostrarPromptContrase√±a('Introduce la contrase√±a para DASHBOARD'); if (password === CONFIG.PASSWORDS.DASHBOARD) { activarPantalla('pantalla4'); iniciarDashboard(); } else if (password !== null) { await mostrarAlerta('Contrase√±a incorrecta.'); } }
function limpiarDashboardListeners(){ dashboardListeners.forEach(l => l.ref.off(l.eventType, l.callback)); dashboardListeners = []; }
function iniciarDashboard(){ limpiarDashboardListeners(); const { fecha } = obtenerTurnoActual(); document.getElementById('fechaDashboard').value = fecha; document.getElementById('turnoDashboardSelect').value = 'todos'; const setup = () => setupDashboardListeners(document.getElementById('fechaDashboard').value, document.getElementById('turnoDashboardSelect').value); setup(); document.getElementById('fechaDashboard').addEventListener('change', setup); document.getElementById('turnoDashboardSelect').addEventListener('change', setup); }
function setupDashboardListeners(fecha, turno){ limpiarDashboardListeners(); const historialRefDash = db.ref(`historialLogs/${fecha}`); const ledsRefDash = db.ref('estadoLEDs'); const historialCallback = historialRefDash.on('value', snap => { const logsPorTurno = snap.val() || {}; let logsFiltrados = {}; if (turno === 'todos') Object.values(logsPorTurno).forEach(logs => Object.assign(logsFiltrados, logs)); else logsFiltrados = logsPorTurno[turno] || {}; actualizarDashboard(logsFiltrados, 'historial', null); }); dashboardListeners.push({ ref: historialRefDash, eventType: 'value', callback: historialCallback }); const ledsCallback = ledsRefDash.on('value', snap => actualizarDashboard(null, 'leds', snap.val() || {})); dashboardListeners.push({ ref: ledsRefDash, eventType: 'value', callback: ledsCallback }); }
function actualizarDashboard(historialLogs, tipo, estadoLEDs){ if (!document.getElementById('pantalla4').classList.contains('activa')) return; if (tipo === 'historial' && historialLogs) { let confirmadas = 0, recolectadas = 0, liberadas = 0, rechazadas = 0, tiempoTotal = 0; const prodPorArea = { MULTIPORT: 0, DROPS: 0, BEDROCK: 0 }; const recoleccionesPorHora = {}; Object.values(historialLogs).forEach(log => { switch(log.accion) { case 'confirmada_en_produccion': case 'led_encendido': confirmadas++; if (prodPorArea[log.grupo] !== undefined) prodPorArea[log.grupo]++; break; case 'recolectada': recolectadas++; tiempoTotal += log.tiempoRecoleccion || 0; const hora = new Date(log.timestamp).getHours(); recoleccionesPorHora[hora] = (recoleccionesPorHora[hora] || 0) + 1; break; case 'liberada': case 'led_liberado': liberadas++; break; case 'rechazada': case 'led_rechazado': rechazadas++; break; } }); const tiempoPromedio = recolectadas > 0 ? (tiempoTotal / recolectadas).toFixed(1) : 0; const tasaRechazo = (liberadas + rechazadas) > 0 ? ((rechazadas / (liberadas + rechazadas)) * 100).toFixed(1) : 0; document.getElementById('dashTarimasConfirmadas').textContent = confirmadas; document.getElementById('dashTarimasRecolectadas').textContent = recolectadas; document.getElementById('dashTiempoPromedio').textContent = `${tiempoPromedio} min`; document.getElementById('dashTasaRechazo').textContent = `${tasaRechazo}%`; document.getElementById('kpiTiempoPromedio').classList.toggle('alerta', tiempoPromedio > 10); document.getElementById('kpiTasaRechazo').classList.toggle('alerta', tasaRechazo > 5); generarGraficoProduccionDash(prodPorArea); generarGraficoCalidadDash({ liberadas, rechazadas }); generarGraficoLogisticaDash(recoleccionesPorHora); } if (tipo === 'leds' && estadoLEDs) { const pendientes = { MULTIPORT: 0, DROPS: 0, BEDROCK: 0 }; CONFIG.PRODUCCION_GRUPOS.forEach(grupo => { if(estadoLEDs[grupo]) Object.values(estadoLEDs[grupo]).forEach(linea => Object.values(linea).forEach(led => { if(led?.encendido) pendientes[grupo]++; })); }); const tablaBody = document.querySelector('#tablaPendientes tbody'); tablaBody.innerHTML = Object.entries(pendientes).map(([area, count]) => `<tr><td>${area}</td><td>${count}</td></tr>`).join(''); } }
function generarGraficoProduccionDash(datos){ if (graficosDashboard.produccion) graficosDashboard.produccion.destroy(); const ctx = document.getElementById('graficoProduccionDash').getContext('2d'); graficosDashboard.produccion = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(datos), datasets: [{ label: 'Tarimas', data: Object.values(datos), backgroundColor: ['#4BC0C0', '#36A2EB', '#FFCE56'] }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#fff', stepSize: 1 } }, x: { ticks: { color: '#fff' } } }, plugins: { legend: { display: false } } } }); }
function generarGraficoCalidadDash(datos){ if (graficosDashboard.calidad) graficosDashboard.calidad.destroy(); const ctx = document.getElementById('graficoCalidadDash').getContext('2d'); graficosDashboard.calidad = new Chart(ctx, { type: 'pie', data: { labels: ['Liberadas', 'Rechazadas'], datasets: [{ data: [datos.liberadas, datos.rechazadas], backgroundColor: ['#4caf50', '#f44336'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#fff' } } } } }); }
function generarGraficoLogisticaDash(tarimasPorHora){ if (graficosDashboard.logistica) graficosDashboard.logistica.destroy(); const ctx = document.getElementById('graficoLogisticaDash').getContext('2d'); const labels = Array.from({length: 24}, (_, i) => `${i}:00`); const data = labels.map((_, i) => tarimasPorHora[i] || 0); graficosDashboard.logistica = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Tarimas Recolectadas', data, backgroundColor: '#36A2EB' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Tarimas', color: '#fff' }, ticks: { stepSize: 1, color: '#fff' } }, x: { title: { display: true, text: 'Hora', color: '#fff' }, ticks: { color: '#fff' } } }, plugins: { legend: { display: false } } } }); }
function mostrarReporte(tipo){reporteActual=tipo;document.getElementById("selectoresReportes").style.display="none";const e=document.getElementById("contenedorReporte"),{fecha:t}=obtenerTurnoActual();let o="";"resumen"!==tipo&&(o=`<label for="areaFiltro">√Årea:</label><select id="areaFiltro">${["TODAS","MULTIPORT","DROPS","BEDROCK","CALIDAD_MULTIPORT","CALIDAD_DROPS","CALIDAD_BEDROCK"].map(e=>`<option value="${e}">${e.replace("CALIDAD_","Calidad ")}</option>`).join("")}</select>`),e.innerHTML=`<div class="header-reporte"><button onclick="regresarASelectores()" class="usuario-btn">Regresar</button><div class="filtros"><label for="fechaReporte">Fecha:</label><input type="date" id="fechaReporte" value="${t}"><label for="turnoFiltro">Turno:</label><select id="turnoFiltro"><option value="todos">Todos</option><option value="Turno 1">Turno 1</option><option value="Turno 2">Turno 2</option></select>${o}<button onclick="buscarReporte()" class="usuario-btn">Buscar</button></div></div><h2 id="tituloReporteDinamico">Cargando...</h2><div id="opcionesGrafico" class="opciones-grafico" style="display:none;"><label>Tipo de Gr√°fico:</label><select id="tipoGrafico"><option value="bar">Barras</option><option value="pie">Pastel</option><option value="line">L√≠nea</option></select></div><div id="contenidoReporte"></div><div class="botones-reporte"><button class="usuario-btn" onclick="exportarReporte('excel')">Exportar a Excel</button><button class="usuario-btn" onclick="exportarReporte('pdf')">Exportar a PDF</button><button class="usuario-btn" onclick="exportarReporte('csv')">Exportar a CSV</button></div>`,document.getElementById("turnoFiltro").value="todos",document.getElementById("tipoGrafico")?.addEventListener("change",actualizarGraficoReporte),buscarReporte()}
function actualizarGraficoReporte(){if(!datosFiltradosReporte)return;const e=document.getElementById("tipoGrafico").value,t=document.querySelector("#grafico-contenedor");if(!t)return;t.innerHTML='<canvas id="graficoDinamico"></canvas>';let o,n,l,a="";"produccion"===reporteActual?(o=Object.keys(n=datosFiltradosReporte.reduce((e,t)=>(e[t.grupo]=(e[t.grupo]||0)+1,e),{})),l=Object.values(n),a="Tarimas Confirmadas"):"logistica"===reporteActual?(o=Object.keys(n=datosFiltradosReporte.reduce((e,t)=>(e[t.grupo]=(e[t.grupo]||0)+1,e),{})),l=Object.values(n),a="Tarimas Recolectadas"):"calidad"===reporteActual&&(o=Object.keys(n=datosFiltradosReporte.reduce((e,t)=>{const o=t.detalles?.problema||"No especificado";return e[o]=(e[o]||0)+1,e},{})),l=Object.values(n),a="N√∫mero de Rechazos"),miGrafico&&miGrafico.destroy();const r=document.getElementById("graficoDinamico").getContext("2d");miGrafico=new Chart(r,{type:e,data:{labels:o,datasets:[{label:a,data:l,backgroundColor:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40"]}]},options:{responsive:!0,plugins:{title:{display:!0,text:a,font:{size:20}}}}})}
function regresarASelectores(){document.getElementById("tituloReportes").textContent="REPORTES",document.getElementById("selectoresReportes").style.display="flex",document.getElementById("contenedorReporte").innerHTML="<h2>Selecciona un reporte</h2>",miGrafico&&miGrafico.destroy(),datosFiltradosReporte=null}
function buscarReporte(){const e=reporteActual,t=document.getElementById("fechaReporte").value,o=document.getElementById("turnoFiltro").value,n=document.getElementById("areaFiltro")?.value||"TODAS";cargarDatosReporte(e,t,o,n)}
function cargarDatosReporte(e,t,o,n){const l=document.getElementById("contenidoReporte"),a=document.getElementById("tituloReporteDinamico");l.innerHTML="<p>Cargando datos...</p>",miGrafico&&miGrafico.destroy(),db.ref(`historialLogs/${t}`).once("value").then(r=>{const i=r.val()||{};let s=[];"todos"===o?Object.values(i).forEach(e=>{s.push(...Object.values(e))}):i[o]&&(s=Object.values(i[o]));const d="TODAS"===n?s:s.filter(e=>e.grupo===n);switch(a.textContent=`Reporte de ${e} - ${t} - ${o}`,e){case"produccion":procesarReporteProduccion(d,l);break;case"logistica":procesarReporteLogistica(d,l);break;case"calidad":procesarReporteCalidad(d,l);break;case"resumen":procesarReporteResumen(s,l)}}).catch(e=>{console.error("Error al cargar datos:",e),l.innerHTML="<p>Error al cargar los datos.</p>"})}
function procesarReporteCalidad(e,t){datosFiltradosReporte=e.filter(e=>"rechazada"===e.accion);const o=datosFiltradosReporte.length;let n=`<div class="resumen-datos"><div class="dato"><div class="valor">${o}</div><div class="etiqueta">Total Rechazos</div></div></div>`,l='<table><thead><tr><th>Hora</th><th>√Årea</th><th>Tarima ID</th><th>Empleado</th><th>No. Parte</th><th>Problema</th><th>Causa</th><th>Acci√≥n</th></tr></thead><tbody>',a='<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">';datosFiltradosReporte.forEach(e=>{const t=e.detalles||{};l+=`<tr><td>${formatoHora(e.timestamp)}</td><td>${e.grupo}</td><td>${e.tarimaId||e.led||'N/A'}</td><td>${t.empleado}</td><td>${t.parte}</td><td>${t.problema}</td><td>${t.causa}</td><td>${t.accion}</td></tr>`,a+=`<div class="fila-dato"><span class="etiqueta">ID:</span><span class="valor">${e.tarimaId||e.led||'N/A'}</span><br/><span class="etiqueta">Problema:</span><span class="valor">${t.problema}</span></div>`}),l+="</tbody></table>",a+='</div></div>',document.getElementById("opcionesGrafico").style.display="block",t.innerHTML=n+'<div id="grafico-contenedor" class="grafico-contenedor"></div>'+l+a,actualizarGraficoReporte()}
function procesarReporteProduccion(e,t){datosFiltradosReporte=e.filter(e=>"confirmada_en_produccion"===e.accion||"led_encendido"===e.accion);const o=datosFiltradosReporte.length;let n=`<div class="resumen-datos"><div class="dato"><div class="valor">${o}</div><div class="etiqueta">Total Confirmadas/Encendidas</div></div></div>`,l="<table><thead><tr><th>Hora</th><th>√Årea</th><th>Identificador</th><th>Usuario</th></tr></thead><tbody>",a='<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">';datosFiltradosReporte.forEach(e=>{l+=`<tr><td>${formatoHora(e.timestamp)}</td><td>${e.grupo}</td><td>${e.tarimaId||e.led}</td><td>${e.usuario}</td></tr>`,a+=`<div class="fila-dato"><span class="etiqueta">ID:</span><span class="valor">${e.tarimaId||e.led}</span><br/><span class="etiqueta">√Årea:</span><span class="valor">${e.grupo}</span></div>`}),l+="</tbody></table>",a+='</div></div>',document.getElementById("opcionesGrafico").style.display="block",t.innerHTML=n+'<div id="grafico-contenedor" class="grafico-contenedor"></div>'+l+a,actualizarGraficoReporte()}
function procesarReporteLogistica(e,t){datosFiltradosReporte=e.filter(e=>"recolectada"===e.accion);const o=datosFiltradosReporte.length,n=datosFiltradosReporte.reduce((e,t)=>e+(t.tiempoRecoleccion||0),0),l=o>0?(n/o).toFixed(1):0;let a=`<div class="resumen-datos"><div class="dato"><div class="valor">${o}</div><div class="etiqueta">Total Recolectadas</div></div><div class="dato"><div class="valor">${l} min</div><div class="etiqueta">Tiempo Promedio</div></div></div>`,r="<table><thead><tr><th>Hora Recolecci√≥n</th><th>√Årea</th><th>Identificador</th><th>Tiempo (min)</th><th>Hora Inicio</th></tr></thead><tbody>",i='<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">';datosFiltradosReporte.forEach(e=>{r+=`<tr><td>${formatoHora(e.horaApagado)}</td><td>${e.grupo}</td><td>${e.tarimaId||e.led}</td><td>${e.tiempoRecoleccion}</td><td>${formatoHora(e.horaEncendido)}</td></tr>`,i+=`<div class="fila-dato"><span class="etiqueta">ID:</span><span class="valor">${e.tarimaId||e.led}</span><br/><span class="etiqueta">Tiempo:</span><span class="valor">${e.tiempoRecoleccion} min</span></div>`}),r+="</tbody></table>",i+='</div></div>',document.getElementById("opcionesGrafico").style.display="block",t.innerHTML=a+'<div id="grafico-contenedor" class="grafico-contenedor"></div>'+r+i,actualizarGraficoReporte()}
function procesarReporteResumen(e,t){const o={};["MULTIPORT","DROPS","BEDROCK"].forEach(e=>{o[e]={confirmadas:0,recolectadas:0,liberadas:0,rechazadas:0,tiempoTotal:0}}),e.forEach(e=>{const t=e.grupo?.replace("CALIDAD_","");if(o[t])switch(e.accion){case"confirmada_en_produccion":case"led_encendido":o[t].confirmadas++;break;case"recolectada":o[t].recolectadas++,o[t].tiempoTotal+=e.tiempoRecoleccion||0;break;case"liberada":case"led_liberado":o[t].liberadas++;break;case"rechazada":case"led_rechazado":o[t].rechazadas++}});let n="";["MULTIPORT","DROPS","BEDROCK"].forEach(e=>{const t=o[e],l=(t.liberadas+t.rechazadas>0?(t.rechazadas/(t.liberadas+t.rechazadas))*100:0).toFixed(1),a=(t.recolectadas>0?t.tiempoTotal/t.recolectadas:0).toFixed(1);n+=`<h3>${e}</h3><div class="resumen-datos"><div class="dato"><div class="valor">${t.confirmadas}</div><div class="etiqueta">Confirmadas/Encendidas</div></div><div class="dato"><div class="valor">${t.liberadas}</div><div class="etiqueta">Liberadas</div></div><div class="dato"><div class="valor">${t.rechazadas}</div><div class="etiqueta">Rechazadas</div></div><div class="dato"><div class="valor">${l}%</div><div class="etiqueta">Tasa Rechazo</div></div><div class="dato"><div class="valor">${a} min</div><div class="etiqueta">Tiempo Recolecci√≥n</div></div></div>`}),t.innerHTML=n}
async function exportarReporte(e){const t=document.querySelector("#contenidoReporte table");if(!t||!datosFiltradosReporte)return mostrarAlerta("No hay datos para exportar.");const o=`${reporteActual}_${document.getElementById("fechaReporte").value}`;"excel"===e?(()=>{const e=XLSX.utils.table_to_sheet(t),o=XLSX.utils.book_new();XLSX.utils.book_append_sheet(o,e,"Reporte"),XLSX.writeFile(o,`${o}.xlsx`)})():"pdf"===e?exportarAPdf(t,miGrafico,o):"csv"===e&&exportarACsv(t,o)}
function exportarACsv(e,t){let o=[];e.querySelectorAll("tr").forEach(e=>{let t=[];e.querySelectorAll("th, td").forEach(e=>{t.push(`"${e.textContent.trim().replace(/"/g,'""')}"`)}),o.push(t.join(","))});const n=new Blob([o.join("\n")],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a");l.href=URL.createObjectURL(n),l.download=`${t}.csv`,l.click()}
function exportarAPdf(e,t,o){const n=new window.jspdf.jsPDF({orientation:"landscape"});n.text(`Reporte de ${reporteActual}`,20,20),t&&n.addImage(t.toBase64Image(),"PNG",20,30,120,70),n.autoTable({html:e,startY:t?110:30}),n.save(`${o}.pdf`)}

window.addEventListener('load', ()=>{
    firebase.auth().signInAnonymously().catch(e => console.error('Auth error:', e));
    firebase.auth().onAuthStateChanged(user => { if (user) activarPantalla('pantalla1'); });
    document.getElementById('modalRechazo').querySelector('form').addEventListener('submit', e => { e.preventDefault(); guardarRechazo(); });
    document.getElementById('selectoresReportes').querySelectorAll('.usuario-btn').forEach(btn => btn.addEventListener('click', () => mostrarReporte(btn.dataset.reporte)));
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').then(reg => console.log("‚úÖ SW Registrado")).catch(err => console.error("‚ùå Error SW:", err));
});
</script>
</body>
</html>
