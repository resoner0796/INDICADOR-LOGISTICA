<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel LogÃ­stica</title>
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>

:root{
Â  --btn-bg: #0066cc;
Â  --btn-bg-hover: #004c99;
Â  --grid-size: 26px;
Â  --vignette: rgba(0,0,0,0.9);
Â  --titulo-size: clamp(42px,7vw,96px);
Â  --led-size: 50px;
Â  --led-gap: 16px;
Â  --led-off-core: #111;
Â  --led-off-edge: #000;
Â  --led-on-core: #0f0;
Â  --led-on-edge: #063;
Â  --glow: #00ff88;
Â  --blink-duration: 0.9s;

}



*{ box-sizing: border-box; }

html, body{ height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:#111; }
.pantalla{ display:none; width:100%; min-height:100vh; }
.pantalla.activa{ display:flex; flex-direction:column; }
#pantalla1{

Â  align-items:center;
Â  justify-content:center;
Â  flex-direction: column;
Â  background:linear-gradient(135deg,#222,#444);
Â  gap:18px;

}

.btn-contenedor{
Â  display:flex;
Â  flex-direction:column;
Â  align-items:center;
}

#pantalla1 h1{ margin:0 0 8px; }

  .usuario-btn{
Â  background: var(--btn-bg);
Â  color:#fff;
Â  border:0;
Â  padding:14px 28px;
Â  margin:8px;
Â  border-radius:10px;
Â  font-size:18px;
Â  cursor:pointer;
Â  transition: background .25s ease;
Â  outline-color: #000;
}

.usuario-btn:hover{ background: var(--btn-bg-hover); }

#pantalla2{
Â  background-color:#000;
Â  background-image:
Â  Â  radial-gradient(circle, rgba(60,60,60,.28) 20%, transparent 21%),
Â  Â  radial-gradient(circle, #101010 20%, transparent 21%);
Â  background-size: var(--grid-size) var(--grid-size);
Â  box-shadow: inset 0 0 90px var(--vignette);
Â  overflow-y: auto; /* Permite el scroll solo en esta pantalla */
}

.header{ display:flex; align-items:center; justify-content:center; padding:16px 20px 6px; position: relative; }
  
#tituloFijo{
Â  font-weight:800;
Â  text-align:center;
Â  letter-spacing:.5px;
Â  text-shadow:0 2px 8px rgba(0,0,0,.65);
Â  font-size:var(--titulo-size);
}

#turnoActual {
Â  position: absolute;
Â  top: 10px;
Â  right: 10px;
Â  font-size: 1.2rem;
Â  font-weight: bold;
Â  background-color: rgba(0,0,0,0.5);
Â  padding: 5px 10px;
Â  border-radius: 5px;
}

.zona-centro{
Â  flex:1;
Â  display:flex;
Â  align-items:center;
Â  justify-content:center;
Â  padding:10px 24px 28px;
Â  flex-direction: column;
}

.grupo-contenedor{
Â  display: flex;
Â  flex-wrap: wrap;
Â  gap: clamp(24px, 4vw, 64px);
Â  width: min(1200px, 96vw);
Â  justify-content: center;
}

.grupo.oculto {
Â  display: none;
}

.grupo{ display:flex; flex-direction:column; align-items:center; text-align:center; }
.grupo .nombre{ font-size: clamp(20px,2.2vw,28px); font-weight:800; margin-bottom:8px; letter-spacing:.5px; text-shadow:0 1px 6px rgba(0,0,0,.5); }
.grupo .tarimas{ font-size: clamp(16px,1.7vw,22px); opacity:.9; margin-bottom:14px; }
.leds{ display:flex; gap: var(--led-gap); justify-content:center; align-items:center; flex-wrap:nowrap; padding:4px; }
.led{

Â  width: var(--led-size);
Â  height: var(--led-size);
Â  border-radius:50%;
Â  cursor:pointer;
Â  background: radial-gradient(circle at 45% 40%, var(--led-off-core) 40%, var(--led-off-edge) 100%);
Â  box-shadow: inset -4px -5px 8px rgba(0,0,0,.8), inset 4px 5px 6px rgba(255,255,255,.06), 0 1px 0 rgba(255,255,255,.05);
Â  transition: transform .1s ease, filter .2s ease, box-shadow .2s ease;
}

.led:active{ transform: scale(.96); }
.led.on{
Â  background: radial-gradient(circle at 48% 45%, var(--led-on-core) 40%, var(--led-on-edge) 100%);
Â  box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
Â  animation: blink var(--blink-duration) ease-in-out infinite;
}

.led.disabled {
Â  Â  cursor: not-allowed;
Â  Â  pointer-events: none;
}

.resumen-turno {
Â  display: flex;
Â  justify-content: center;
Â  gap: 40px;
Â  margin-bottom: 20px;
Â  background-color: #222;
Â  border-radius: 12px;
Â  padding: 15px 30px;
Â  box-shadow: 0 4px 10px rgba(0,0,0,.3);
Â  width: min(800px, 90vw);
}

.resumen-turno.oculto {
Â  display: none;
}

.dato-resumen {
Â  text-align: center;
}

.dato-resumen .etiqueta {
Â  font-size: 14px;
Â  opacity: 0.7;
Â  text-transform: uppercase;
Â  margin-bottom: 4px;
}

.dato-resumen .valor {
Â  font-size: 32px;
Â  font-weight: bold;
Â  letter-spacing: 1px;
}

.tiempos{
Â  margin-top: 10px;
Â  font-size: 14px;
Â  opacity: 0.8;
Â  text-align: left;
Â  width: 100%;
Â  max-height: 200px;
Â  overflow-y: auto;
}

.btn-rojo{
Â  background: #cc0000;
Â  outline-color: #000;
}

.btn-rojo:hover{
Â  background: #990000;
}

.footer{
Â  width: 100%;
Â  display: flex;
Â  justify-content: center;
Â  padding: 20px;
}

.footer .usuario-btn{
Â  padding: 10px 20px;
Â  font-size: 16px;
}

.contadores-calidad {
Â  display: flex;
Â  gap: 20px;
Â  justify-content: center;
Â  margin-top: 10px;
}

.contador-calidad {
Â  text-align: center;
Â  font-size: 14px;
Â  font-weight: bold;
}

.contador-calidad .valor {
Â  font-size: 20px;
Â  font-weight: bold;
}

.contador-calidad .etiqueta {
Â  font-size: 12px;
Â  opacity: 0.8;
}

@media(max-width:720px){Â 
Â  .grupo-contenedor{Â 
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 24px;
Â  Â  width: 100%;
Â  }
}

@keyframes blink {
Â  0%, 100% {
Â  Â  box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
Â  }
Â  50% {
Â  Â  box-shadow: 0 0 40px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
Â  }
}

/* Estilos base para ocultar los modales */

.modal-calidad,
.modal {
Â  position: fixed;
Â  top: 0;
Â  left: 0;
Â  width: 100%;
Â  height: 100%;
Â  background-color: rgba(0, 0, 0, 0.8);
Â  display: flex;
Â  justify-content: center;
Â  align-items: center;
Â  z-index: 1000;
Â  /* ğŸ’¡ Estas dos lÃ­neas son la clave para ocultarlos */
Â  visibility: hidden;
Â  opacity: 0;
Â  transition: opacity 0.3s ease, visibility 0.3s ease;
}

  /* Esta clase es la que tu JavaScript debe agregar para mostrar el modal */
.modal-calidad.visible,
.modal.visible {
Â  visibility: visible;
Â  opacity: 1;
}

/* Estilos de los contenedores de los modales (los que ya tenÃ­as) */

#modalCalidad .modal-content,
#modalRechazo .modal-content,
#modalOpcionesCalidad .modal-content,
#modalAsignarTarimaProduccion .modal-content {

Â  background-color: #1c1c1c !important;
Â  color: #eee !important;
Â  padding: 25px 35px;
Â  border-radius: 12px;
Â  text-align: center;
Â  max-width: 450px;
Â  width: 90%;
Â  box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}

/* ================= CSS DEL MODAL DE CALIDAD ================= */

#modalCalidad .modal-content,
#modalRechazo .modal-content {

Â  background-color: #1c1c1c !important;
Â  color: #eee !important;
Â  padding: 25px 35px;
Â  border-radius: 12px;
Â  text-align: center;
Â  max-width: 450px;
Â  width: 90%;
Â  box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}

#modalCalidad h3,
#modalRechazo h3 {
Â  color: #f0f0f0 !important;
}

#modalCalidad .opcion-btn,
#modalRechazo .opcion-btn {
Â  padding: 12px 20px;
Â  font-size: 16px;
Â  font-weight: bold;
Â  border: none;
Â  border-radius: 6px;
Â  cursor: pointer;
Â  transition: transform 0.15s ease;
}

#modalCalidad .opcion-btn[data-color="rojo"] { background: #d32f2f; color: #fff; }
#modalCalidad .opcion-btn[data-color="verde"] { background: #2e7d32; color: #fff; }
#modalCalidad .opcion-btn:hover { transform: scale(1.05); }

/* Nuevo CSS para el formulario de rechazo */

#modalRechazo .modal-content {
Â  text-align: left;
}

#modalRechazo .modal-content h3 {
Â  text-align: center;
Â  margin-bottom: 30px;
}

#modalRechazo form {
Â  display: flex;
Â  flex-direction: column;
Â  gap: 15px;
}

#modalRechazo label {
Â  font-size: 16px;
Â  margin-bottom: 5px;
Â  display: block;
}

#modalRechazo input, #modalRechazo textarea {

Â  width: 100%;
Â  padding: 10px;
Â  border-radius: 5px;
Â  border: 1px solid #555;
Â  background-color: #333;
Â  color: #fff;
Â  font-size: 16px;
}

#modalRechazo textarea {
Â  resize: vertical;
Â  min-height: 80px;
}

#modalRechazo button[type="submit"] {
Â  margin-top: 20px;
Â  background-color: var(--btn-bg);
Â  color: #fff;
Â  border: none;
Â  padding: 15px;
Â  border-radius: 8px;
Â  font-size: 18px;
Â  cursor: pointer;
Â  transition: background-color 0.3s ease;
}

#modalRechazo button[type="submit"]:hover {
Â  background-color: var(--btn-bg-hover);
}

#modalRechazo .modal-actions {
Â  display: flex;
Â  justify-content: space-between;
Â  margin-top: 20px;
}

#modalRechazo .modal-actions button {
Â  flex: 1;
Â  margin: 0 5px;
}

.led.naranja {
Â  background: radial-gradient(circle at 48% 45%, #ff9800 40%, #c17500 100%);
Â  box-shadow: 0 0 22px #ff9800, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}

.led.rojo {
Â  background: radial-gradient(circle at 48% 45%, #f44336 40%, #d32f2f 100%);
Â  box-shadow: 0 0 22px #f44336, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}

.led.verde {
Â  background: radial-gradient(circle at 48% 45%, #4caf50 40%, #388e3c 100%);
Â  box-shadow: 0 0 22px #4caf50, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
  
/* ================= CSS PARA PANTALLA 3 (REPORTES) ================= */

#pantalla3 {
Â  background-color: #f5f5f5;
Â  color: #333;
Â  align-items: center;
Â  justify-content: flex-start;
Â  padding: 20px;
Â  overflow-y: auto;
}

#pantalla3 h1 {
Â  font-size: 2.5rem;
Â  color: #0066cc;
Â  margin-bottom: 20px;
}

#pantalla3 .btn-contenedor {
Â  display: flex;
Â  flex-direction: row;
Â  flex-wrap: wrap;
Â  justify-content: center;
Â  gap: 15px;
Â  width: 100%;
Â  max-width: 800px;
}

#pantalla3 .usuario-btn {
Â  background-color: #0066cc;
Â  color: #fff;
Â  font-size: 1.2rem;
Â  padding: 15px 30px;
Â  border-radius: 10px;
Â  cursor: pointer;
Â  border: none;
Â  transition: background-color 0.3s ease;
}

#pantalla3 .usuario-btn:hover {
Â  background-color: #004c99;
}

#pantalla3 .contenedor-reporte {
Â  background-color: #fff;
Â  border-radius: 10px;
Â  padding: 20px;
Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
Â  width: 100%;
Â  max-width: 1200px;
Â  margin-top: 20px;
}

#pantalla3 .header-reporte {
Â  display: flex;
Â  align-items: center;
Â  flex-wrap: wrap;
Â  gap: 10px;
Â  justify-content: space-between;
Â  margin-bottom: 20px;
}

#pantalla3 .header-reporte h2 {
Â  color: #0066cc;
Â  margin: 0;
}

#pantalla3 .header-reporte .filtros {
Â  display: flex;
Â  flex-wrap: wrap;
Â  gap: 10px;
Â  align-items: center;
}

#pantalla3 .header-reporte .filtros label {
Â  font-size: 14px;
}

#pantalla3 .header-reporte .filtros input[type="date"],
#pantalla3 .header-reporte .filtros select,
#pantalla3 .header-reporte .filtros input[type="text"] {
padding: 8px;
Â  border-radius: 5px;
Â  border: 1px solid #ccc;
Â  font-size: 14px;
}

#pantalla3 table {
Â  width: 100%;
Â  border-collapse: collapse;
Â  margin-top: 20px;
Â  display: table;
}

#pantalla3 th, #pantalla3 td {
Â  border: 1px solid #ccc;
Â  padding: 12px;
Â  text-align: left;
Â  font-size: 14px;
}

#pantalla3 thead {
Â  background-color: #0066cc;
Â  color: #fff;
}

#pantalla3 tbody tr:nth-child(even) {
Â  background-color: #f2f2f2;
}

#pantalla3 tbody tr:hover {
Â  background-color: #ddd;
}

#pantalla3 .resumen-datos {
Â  display: flex;
Â  gap: 30px;
Â  flex-wrap: wrap;
Â  justify-content: space-around;
Â  margin-bottom: 20px;
}

#pantalla3 .dato {
Â  background-color: #f2f2f2;
Â  padding: 15px;
Â  border-radius: 8px;
Â  font-weight: bold;
Â  text-align: center;
}

#pantalla3 .dato .valor {
Â  font-size: 24px;
Â  color: #0066cc;
}

#pantalla3 .dato .etiqueta {
Â  font-size: 12px;
Â  text-transform: uppercase;
Â  color: #666;
}

.botones-reporte {
Â  margin-top: 20px;
Â  display: flex;
Â  gap: 15px;
Â  justify-content: flex-end;
Â  flex-wrap: wrap;
}

.grafico-contenedor {
Â  width: 100%;
Â  max-width: 600px;
Â  margin: 20px auto;
}

.opciones-grafico {
Â  Â  display: flex;
Â  Â  gap: 10px;
Â  Â  align-items: center;
Â  Â  margin-bottom: 15px;
Â  Â  justify-content: center;
}

.opciones-grafico .usuario-btn {
Â  Â  padding: 8px 15px;
Â  Â  font-size: 14px;
}

.reporte-calidad-mobile .tabla-calidad-movil .fila-dato {
Â  Â  background-color: #f2f2f2;
Â  Â  padding: 10px;
Â  Â  border-radius: 5px;
Â  Â  margin-bottom: 10px;
}

.reporte-calidad-mobile .tabla-calidad-movil .etiqueta {
Â  Â  font-weight: bold;
Â  Â  color: #666;
Â  Â  display: block;
Â  Â  font-size: 12px;
}

.reporte-calidad-mobile .tabla-calidad-movil .valor {
Â  Â  color: #333;
Â  Â  font-size: 16px;
}

@media (max-width: 768px) {
Â  Â  #pantalla3 .header-reporte {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  }

Â  Â  #pantalla3 .header-reporte .filtros {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  flex-direction: column;
Â  Â  }

Â  Â  #pantalla3 .header-reporte .filtros input,
Â  Â  #pantalla3 .header-reporte .filtros select {
Â  Â  Â  Â  width: 100%;
Â  Â  }

Â  Â  #pantalla3 .resumen-datos {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 15px;
Â  Â  }

Â  Â  #pantalla3 .dato {
Â  Â  Â  Â  width: 100%;
Â  Â  }

Â  Â  #pantalla3 table {
Â  Â  Â  Â  display: none; /* Oculta la tabla normal en mÃ³viles */
Â  Â  }

Â  Â  .reporte-calidad-mobile {
Â  Â  Â  Â  display: block; /* Muestra la tabla mÃ³vil */
Â  Â  }
}

@media (min-width: 769px) {
Â  Â  .reporte-calidad-mobile {
Â  Â  Â  Â  display: none; /* Oculta la tabla mÃ³vil en desktop */
Â  Â  }
}

/* ================= CSS PARA PANTALLA 4 (DASHBOARD) ================= */

#pantalla4 {
Â  background-color: #000;
Â  color: #fff;
Â  padding: 20px;
Â  display: grid;
Â  grid-template-areas:
Â  Â  "header"
Â  Â  "filtros"
Â  Â  "kpis"
Â  Â  "graficos"
Â  Â  "pendientes"
Â  Â  "footer";
Â  gap: 20px;
Â  align-content: start;
Â  overflow-y: auto;
}

#pantalla4 .header {
Â  grid-area: header;
Â  text-align: center;
}

#pantalla4 .filtros-dashboard {
Â  grid-area: filtros;
Â  display: flex;
Â  justify-content: center;
Â  gap: 15px;
Â  margin-bottom: 20px;
Â  align-items: center;
}

#pantalla4 .filtros-dashboard label {
Â  font-size: 14px;
}

#pantalla4 .filtros-dashboard input[type="date"],
#pantalla4 .filtros-dashboard select {
Â  padding: 8px;
Â  border-radius: 5px;
Â  border: 1px solid #555;
Â  background-color: #222;
Â  color: #fff;
}

#pantalla4 .kpis-grid {
Â  grid-area: kpis;
Â  display: grid;
Â  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
Â  gap: 20px;
}

#pantalla4 .kpi-card {
Â  background-color: #1a1a1a;
Â  border-radius: 10px;
Â  padding: 20px;
Â  text-align: center;
Â  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
Â  border: 1px solid #333;
}

#pantalla4 .kpi-card h3 {
Â  margin-top: 0;
Â  font-size: 1rem;
Â  color: #aaa;
Â  text-transform: uppercase;
}

#pantalla4 .kpi-card .valor {
Â  font-size: 3rem;
Â  font-weight: bold;
Â  color: #00ff88;
Â  transition: color 0.3s ease;
}

#pantalla4 .kpi-card.alerta .valor {
Â  color: #ff3333;
}

#pantalla4 .graficos-container {
Â  grid-area: graficos;
Â  display: grid;
Â  grid-template-columns: 1fr;
Â  gap: 20px;
}

#pantalla4 .graficos-container .panel {
Â  background-color: #1a1a1a;
Â  padding: 20px;
Â  border-radius: 10px;
Â  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
Â  border: 1px solid #333;
}

#pantalla4 .graficos-container h3 {
Â  text-align: center;
Â  margin-top: 0;
Â  margin-bottom: 15px;
Â  color: #eee;
}

#pantalla4 #tablaPendientes {
Â  width: 100%;
Â  border-collapse: collapse;
Â  color: #fff;
}

#pantalla4 #tablaPendientes th, #pantalla4 #tablaPendientes td {
Â  padding: 12px;
Â  border-bottom: 1px solid #444;
Â  text-align: left;
}

#pantalla4 #tablaPendientes th {
Â  background-color: #222;
}

#pantalla4 #tablaPendientes tbody tr:hover {
Â  background-color: #333;
}

#pantalla4 .footer {
Â  grid-area: footer;
}

@media (min-width: 768px) {
Â  #pantalla4 {
Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  grid-template-areas:
Â  Â  Â  "header header"
Â  Â  Â  "filtros filtros"
Â  Â  Â  "kpis kpis"
Â  Â  Â  "graficos graficos"
Â  Â  Â  "pendientes pendientes"
Â  Â  Â  "footer footer";
Â  }

Â  #pantalla4 .graficos-container {
Â  Â  Â  grid-template-columns: 1fr 1fr;
Â  }

Â  .graficos-container > *:nth-child(3) {
Â  Â  Â  grid-column: span 2;
Â  }
}

@media (min-width: 1200px) {
Â  #pantalla4 {
Â  Â  grid-template-columns: repeat(3, 1fr);
Â  Â  grid-template-areas:
Â  Â  Â  "header header header"
Â  Â  Â  "filtros filtros filtros"
Â  Â  Â  "kpis kpis kpis"
Â  Â  Â  "produccion calidad logistica"
Â  Â  Â  "pendientes pendientes pendientes"
Â  Â  Â  "footer footer footer";
Â  }

Â  #pantalla4 .graficos-container {
Â  Â  grid-template-columns: 1fr 1fr 1fr;
Â  }

Â  .graficos-container > *:nth-child(3) {
Â  Â  Â  grid-column: span 1;
Â  }
}

Â  /* FAB */
Â  .mt-fab {
Â  Â  position: fixed;
Â  Â  bottom: 20px;
Â  Â  right: 20px;
Â  Â  background: #0a84ff;
Â  Â  color: #fff;
Â  Â  border: none;
Â  Â  border-radius: 50%;
Â  Â  width: 78px;
Â  Â  height: 78px;
Â  Â  font-size: 12px;
Â  Â  font-weight: 700;
Â  Â  cursor: pointer;
Â  Â  z-index: 1000;
Â  Â  box-shadow: 0 10px 25px rgba(10,132,255,.35);
Â  }

Â  .mt-fab:active { transform: translateY(1px); }
  
Â  /* Panel lateral */
Â  .mt-panel {
Â  Â  position: fixed;
Â  Â  top: 0; right: -420px; width: 420px; max-width: 95vw; height: 100%;
Â  Â  background: #111316; color: #eaeaea;
Â  Â  box-shadow: -4px 0 20px rgba(0,0,0,.45);
Â  Â  transition: right .28s ease;
Â  Â  z-index: 999;
Â  }

Â  .mt-panel.open { right: 0; }
Â  .mt-panel-content { padding: 20px; }
Â  .mt-close {
Â  Â  background: transparent; border: none; color: #aaa; font-size: 28px; cursor: pointer; float: right;
Â  }

Â  .mt-close:hover { color: #fff; }

Â  /* Controles */
Â  .mt-row { display: flex; gap: 10px; align-items: stretch; }
Â  .mt-btn {
Â  Â  padding: 10px 14px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;
Â  }

Â  .mt-primary { background:#0a84ff; color:#fff; }
Â  .mt-success { background:#34c759; color:#000; }
Â  .mt-select, #bxInput {
Â  Â  flex: 1; padding: 10px 12px; border-radius: 10px; border: 1px solid #2b2f36; background:#171a1f; color:#eaeaea;
Â  }

Â  .mt-select:focus, #bxInput:focus { outline: 2px solid #0a84ff; }
Â  .mt-card {
Â  Â  margin-top: 16px; padding: 16px; border-radius: 14px;
Â  Â  background: linear-gradient(180deg, #16191e 0%, #121418 100%);
Â  Â  border: 1px solid #20242b;
Â  }
Â  .mt-grid {
Â  Â  display: grid; grid-template-columns: repeat(2,1fr); gap: 8px 14px; margin-bottom: 10px;
Â  }
Â  .mt-list { list-style: none; padding-left: 0; margin: 8px 0 0; max-height: 200px; overflow: auto; }
Â  .mt-list li {
Â  Â  padding: 10px 12px; margin-bottom: 8px; border-radius: 10px;
Â  Â  background:#0f1216; border: 1px solid #22262c; font-size: 14px;
Â  Â  word-break: break-word;
Â  }
Â  .mt-assign { margin-top: 14px; border-top: 1px dashed #2a2f36; padding-top: 12px; }



Â  /* === TEMA OSCURO SOLO PARA CALIDAD/PRODUCCIÃ“N ===

Â  Â  Â Le agregamos a <body> la clase .theme-dark cuando el usuario pertenece a esas Ã¡reas.

Â  Â  Â LogÃ­stica queda igual (sin esta clase). */

Â  body.theme-dark {

Â  Â  background: #0b0d0f !important;

Â  Â  color: #eaeaea !important;

Â  }

Â  body.theme-dark .card, body.theme-dark .panel, body.theme-dark .widget {

Â  Â  background: #121418 !important;

Â  Â  color: #eaeaea !important;

Â  Â  border-color: #21252b !important;

Â  }

Â  body.theme-dark button, body.theme-dark .btn {

Â  Â  border-radius: 10px;

Â  Â }

</style>

</head>

<body>



<section id="pantalla1" class="pantalla activa">

<h1 id="mainTitle">Selecciona tu usuario</h1>

<div class="btn-contenedor">

Â  Â  <button class="usuario-btn" onclick="seleccionarUsuario('LOGÃSTICA')">LOGÃSTICA</button>

Â  Â  <button class="usuario-btn" onclick="seleccionarUsuario('MULTIPORT')">MULTIPORT</button>

Â  Â  <button class="usuario-btn" onclick="seleccionarUsuario('DROPS')">DROPS</button>

Â  Â  <button class="usuario-btn" onclick="seleccionarUsuario('BEDROCK')">BEDROCK</button>

Â  Â  <button class="usuario-btn" onclick="seleccionarUsuario('SUPERVISOR')">SUPERVISOR</button>

Â  Â  <button class="usuario-btn" onclick="seleccionarUsuario('CALIDAD')">CALIDAD</button>Â 

Â  Â  <button class="usuario-btn" onclick="seleccionarReporte()">REPORTES</button>

Â  Â  <button class="usuario-btn" onclick="seleccionarDashboard()">DASHBOARD</button>

</div>

</section>



<section id="pantalla2" class="pantalla">

<header class="header">

Â  Â  <div id="tituloFijo">LOGÃSTICA</div>

Â  Â  <div id="turnoActual"></div>

</header>

<div class="zona-centro">

Â  Â  <div id="resumenTurno" class="resumen-turno oculto">

<div class="dato-resumen">

Â  Â  <div class="etiqueta">Tarimas Totales</div>

Â  Â  <div id="tarimasTotales" class="valor">0</div>

</div>

<div class="dato-resumen">

Â  Â  <div class="etiqueta">Tiempo Promedio</div>

Â  Â  <div id="tiempoPromedio" class="valor">0 min</div>

</div>

</div>

<div class="grupo-contenedor">

Â  Â  <div class="grupo" data-grupo="MULTIPORT">

Â  Â  Â  Â  <div class="nombre">MULTIPORT</div>

Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>

Â  Â  Â  Â  <div class="leds" data-grupo="MULTIPORT" data-linea="linea1"></div>

Â  Â  Â  Â  <div class="leds" data-grupo="MULTIPORT" data-linea="linea2"></div>

Â  Â  Â  <div class="tarimas-recibidas-panel" id="tarimasRecibidasPanel">

Â  Â  Â  Â <ul id="listaTarimasRecibidas"></ul>

Â  Â  Â  </div>

Â  Â  Â  Â <div class="tiempos" data-grupo="MULTIPORT"></div>

Â  Â  Â  Â  </div>



Â  Â  <div class="grupo" data-grupo="DROPS">

Â  Â  Â  Â  <div class="nombre">DROPS</div>

Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>

Â  Â  Â  Â  <div class="leds" data-grupo="DROPS" data-linea="linea1"></div>

Â  Â  Â  Â  <div class="leds" data-grupo="DROPS" data-linea="linea2"></div>

Â  Â  Â  Â  <div class="tiempos" data-grupo="DROPS"></div>

Â  Â  </div>



Â  Â  <div class="grupo" data-grupo="BEDROCK">

Â  Â  Â  Â  <div class="nombre">BEDROCK</div>

Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>

Â  Â  Â  Â  <div class="leds" data-grupo="BEDROCK" data-linea="linea1"></div>

Â  Â  Â  Â  <div class="leds" data-grupo="BEDROCK" data-linea="linea2"></div>

Â  Â  Â  Â  <div class="tiempos" data-grupo="BEDROCK"></div>

Â  Â  </div>



Â  Â  <div class="grupo" data-grupo="CALIDAD_MULTIPORT">

Â  Â  Â  Â  <div class="nombre">CALIDAD MULTIPORT</div>

Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>

Â  Â  Â  Â  <div class="leds" data-grupo="CALIDAD_MULTIPORT" data-linea="linea1"></div>

Â  Â  Â  Â  <div class="contadores-calidad">

Â  Â  Â  Â  Â  Â  <div class="contador-calidad">

Â  Â  Â  Â  Â  Â  Â  Â  <span class="valor" id="liberadas_CALIDAD_MULTIPORT">0</span>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Liberadas</div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="contador-calidad">

Â  Â  Â  Â  Â  Â  Â  Â  <span class="valor" id="rechazadas_CALIDAD_MULTIPORT">0</span>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Rechazadas</div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="tiempos" data-grupo="CALIDAD_MULTIPORT"></div>

Â  Â  </div>

Â Â 

Â  Â  <div class="grupo" data-grupo="CALIDAD_DROPS">

Â  Â  Â  Â  <div class="nombre">CALIDAD DROPS</div>

Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>

Â  Â  Â  Â  <div class="leds" data-grupo="CALIDAD_DROPS" data-linea="linea1"></div>

Â  Â  Â  Â  <div class="contadores-calidad">

Â  Â  Â  Â  Â  Â  <div class="contador-calidad">

Â  Â  Â  Â  Â  Â  Â  Â  <span class="valor" id="liberadas_CALIDAD_DROPS">0</span>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Liberadas</div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="contador-calidad">

Â  Â  Â  Â  Â  Â  Â  Â  <span class="valor" id="rechazadas_CALIDAD_DROPS">0</span>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Rechazadas</div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="tiempos" data-grupo="CALIDAD_DROPS"></div>

Â  Â  </div>



Â  Â  <div class="grupo" data-grupo="CALIDAD_BEDROCK">

Â  Â  Â  Â  <div class="nombre">CALIDAD BEDROCK</div>

Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>

Â  Â  Â  Â  <div class="leds" data-grupo="CALIDAD_BEDROCK" data-linea="linea1"></div>

Â  Â  Â  Â  <div class="contadores-calidad">

Â  Â  Â  Â  Â  Â  <div class="contador-calidad">

Â  Â  Â  Â  Â  Â  Â  Â  <span class="valor" id="liberadas_CALIDAD_BEDROCK">0</span>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Liberadas</div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="contador-calidad">

Â  Â  Â  Â  Â  Â  Â  Â  <span class="valor" id="rechazadas_CALIDAD_BEDROCK">0</span>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Rechazadas</div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="tiempos" data-grupo="CALIDAD_BEDROCK"></div>

Â  Â  </div>

</div>

</div>

<div class="footer">

Â  Â  <button class="usuario-btn btn-rojo" onclick="volverAPantalla1()">Cerrar sesiÃ³n</button>

</div>

</section>



<section id="pantalla3" class="pantalla">

<header class="header">

Â  Â  <h1 id="tituloReportes">REPORTES</h1>

</header>

<div class="zona-centro">

Â  Â  <div id="selectoresReportes" class="btn-contenedor">

Â  Â  Â  Â  <button class="usuario-btn" data-reporte="produccion">PRODUCCIÃ“N</button>

Â  Â  Â  Â  <button class="usuario-btn" data-reporte="logistica">LOGÃSTICA</button>

Â  Â  Â  Â  <button class="usuario-btn" data-reporte="calidad">CALIDAD</button>

Â  Â  Â  Â  <button class="usuario-btn" data-reporte="resumen">RESUMEN EJECUTIVO</button>

Â  Â  </div>

Â  Â  <div id="contenedorReporte" class="contenedor-reporte">

Â  Â  Â  Â  <h2>Selecciona un reporte</h2>

Â  Â  </div>

</div>

<div class="footer">

Â  Â  <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver</button>

</div>

</section>



<section id="pantalla4" class="pantalla" style="display: none;">

<header class="header">

Â  Â  <h1>DASHBOARD DE SUPERVISOR</h1>

</header>

<div class="filtros-dashboard">

Â  Â  <label for="fechaDashboard">Fecha:</label>

Â  Â  <input type="date" id="fechaDashboard">

Â  Â  <label for="turnoDashboardSelect">Turno:</label>

Â  Â  <select id="turnoDashboardSelect">

Â  Â  Â  Â  <option value="todos">Todos</option>

Â  Â  Â  Â  <option value="Turno 1">Turno 1</option>

Â  Â  Â  Â  <option value="Turno 2">Turno 2</option>

Â  Â  </select>

</div>

Â  <div class="kpis-grid">

Â  Â  <div class="kpi-card">

Â  Â  Â  Â  <h3>Tarimas Confirmadas</h3>

Â  Â  Â  Â  <div class="valor" id="dashTarimasConfirmadas">0</div>

Â  Â  </div>

Â  Â  <div class="kpi-card">

Â  Â  Â  Â  <h3>Tarimas Recolectadas</h3>

Â  Â  Â  Â  <div class="valor" id="dashTarimasRecolectadas">0</div>

Â  Â  </div>

Â  Â  <div class="kpi-card" id="kpiTiempoPromedio">

Â  Â  Â  Â  <h3>Tiempo Promedio</h3>

Â  Â  Â  Â  <div class="valor" id="dashTiempoPromedio">0 min</div>

Â  Â  </div>

Â  Â  <div class="kpi-card" id="kpiTasaRechazo">

Â  Â  Â  Â  <h3>Tasa de Rechazo</h3>

Â  Â  Â  Â  <div class="valor" id="dashTasaRechazo">0%</div>

Â  Â  </div>

</div>

<div class="graficos-container">

Â  Â  <div class="panel">

Â  Â  Â  Â  <h3>ProducciÃ³n por Ãrea</h3>

Â  Â  Â  Â  <div style="position: relative; height: 300px;"><canvas id="graficoProduccionDash"></canvas></div>

Â  Â  </div>

Â  Â  <div class="panel">

Â  Â  Â  Â  <h3>Estado de Calidad</h3>

Â  Â  Â  Â  <div style="position: relative; height: 300px;"><canvas id="graficoCalidadDash"></canvas></div>

Â  Â  </div>

Â  Â  <div class="panel">

Â  Â  Â  Â  <h3>EvoluciÃ³n Tiempos de RecolecciÃ³n</h3>

Â  Â  Â  Â  <div style="position: relative; height: 300px;"><canvas id="graficoLogisticaDash"></canvas></div>

Â  Â  </div>

</div>

<div class="panel" style="grid-area: pendientes;">

Â  Â  <h3>Tarimas Pendientes por Recolectar</h3>

Â  Â  <table id="tablaPendientes">

Â  Â  Â  Â  <thead>

Â  Â  Â  Â  Â  Â  <tr>

Â  Â  Â  Â  Â  Â  Â  Â  <th>Ãrea</th>

Â  Â  Â  Â  Â  Â  Â  Â  <th>Tarimas Pendientes</th>

Â  Â  Â  Â  Â  Â  </tr>

Â  Â  Â  Â  </thead>

Â  Â  Â  Â  <tbody></tbody>

Â  Â  </table>

</div>

<div class="footer">

Â  Â  <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver al inicio</button>

</div>

</section>



<div id="modalCalidad" class="modal-calidad">

Â  <div class="modal-content">

Â  Â  <h3>Selecciona el estado de la tarima:</h3>

Â  Â  <div class="opciones">

Â  Â  Â  <button class="opcion-btn" data-color="rojo">Rechazada ğŸ”´</button>

Â  Â  Â  <button class="opcion-btn" data-color="verde">Liberada ğŸŸ¢</button>

Â  Â  </div>

Â  Â  <button class="cerrar-btn">Cerrar</button>

Â  </div>

</div>

<!-- =======================

Â  Â MODAL: Opciones de Calidad

========================= -->

<div id="modalOpcionesCalidad" class="modal">

Â  <div class="modal-content">

Â  Â  <h3>Asignar tarima a LED de Calidad</h3>



Â  Â  <label for="selectLedCalidad">Selecciona LED:</label>

Â  Â  <select id="selectLedCalidad"></select>



Â  Â  <div class="modal-actions">

Â  Â  Â  <button id="btnAsignarTarimaCalidad">Asignar</button>

Â  Â  Â  <button onclick="cerrarModalCalidad()">Cancelar</button>

Â  Â  </div>

Â  </div>

</div>



<style>

/* --- estilos bÃ¡sicos para modal --- */

.modal {

Â  display: none;

Â  position: fixed;

Â  z-index: 999;

Â  left: 0; top: 0; width: 100%; height: 100%;

Â  background: rgba(0,0,0,0.6);

}

.modal-content {

Â  background: #fff;

Â  padding: 20px;

Â  margin: 10% auto;

Â  width: 90%; max-width: 400px;

Â  border-radius: 10px;

}

.modal-actions {

Â  margin-top: 15px;

Â  display: flex;

Â  justify-content: flex-end;

Â  gap: 10px;

}

</style>

Â Â 

<div id="modalRechazo" class="modal-calidad">

Â  <div class="modal-content">

Â  Â  <h3>Detalles del Rechazo</h3>

Â  Â  <form id="formularioRechazo">

Â  Â  Â  Â  <label for="empleado">Empleado Originador:</label>

Â  Â  Â  Â  <input type="text" id="empleado" name="empleado" required>

Â  Â  Â  Â Â 

Â  Â  Â  Â  <label for="linea">LÃ­nea afectada:</label>

Â  Â  Â  Â  <input type="text" id="linea" name="linea" required>



Â  Â  Â  Â  <label for="parte">No. de parte:</label>

Â  Â  Â  Â  <input type="text" id="parte" name="parte" required>



Â  Â  Â  Â  <label for="descripcionParte">DescripciÃ³n del No. de parte:</label>

Â  Â  Â  Â  <input type="text" id="descripcionParte" name="descripcionParte" required>



Â  Â  Â  Â  <label for="problema">DescripciÃ³n del problema:</label>

Â  Â  Â  Â  <textarea id="problema" name="problema" required></textarea>



Â  Â  Â  Â  <label for="causa">Causa raÃ­z del problema:</label>

Â  Â  Â  Â  <textarea id="causa" name="causa" required></textarea>



Â  Â  Â  Â  <label for="accion">AcciÃ³n correctiva:</label>

Â  Â  Â  Â  <textarea id="accion" name="accion" required></textarea>



Â  Â  Â  Â  <div class="modal-actions">

Â  Â  Â  Â  Â  Â  <button type="submit">Guardar Rechazo</button>

Â  Â  Â  Â  Â  Â  <button type="button" onclick="cerrarModalRechazo()">Cancelar</button>

Â  Â  Â  Â  </div>

Â  Â  </form>

Â  </div>

</div>

Â  <!-- =======================

Â  Â MODAL: Asignar Tarima en ProducciÃ³n

========================= -->

<div id="modalAsignarTarimaProduccion" class="modal-produccion">

Â  <div class="modal-content">

Â  Â  <h3>Asignar tarima recibida</h3>



Â  Â  <label for="selectTarimaProduccion">Selecciona Tarima:</label>

Â  Â  <select id="selectTarimaProduccion"></select>



Â  Â  <label for="selectLedProduccion">Selecciona LED:</label>

Â  Â  <select id="selectLedProduccion"></select>



Â  Â  <div class="modal-actions">

Â  Â  Â  <button id="btnAsignarProduccion">Asignar</button>

Â  Â  Â  <button onclick="cerrarModalProduccion()">Cancelar</button>

Â  Â  </div>

Â  </div>

</div>

Â Â 

<style>

Â  /* Modal ProducciÃ³n con estilo dark */

.modal-produccion {

Â  position: fixed;

Â  top: 0; left: 0;

Â  width: 100%; height: 100%;

Â  background-color: rgba(0,0,0,0.8);

Â  display: none;

Â  justify-content: center;

Â  align-items: center;

Â  z-index: 2000;

}



.modal-produccion .modal-content {

Â  background: #222;

Â  padding: 20px;

Â  border-radius: 12px;

Â  color: #fff;

Â  width: 90%;

Â  max-width: 400px;

Â  text-align: center;

Â  box-shadow: 0 5px 15px rgba(0,0,0,0.5);

}



.modal-produccion h3 {

Â  margin-bottom: 15px;

}



.modal-produccion select {

Â  width: 100%;

Â  padding: 8px;

Â  margin: 10px 0;

Â  border-radius: 6px;

Â  border: none;

}



.modal-actions {

Â  display: flex;

Â  justify-content: space-around;

Â  margin-top: 15px;

}



.modal-actions button {

Â  padding: 10px 20px;

Â  border: none;

Â  border-radius: 6px;

Â  cursor: pointer;

}



#btnAsignarProduccion { background: #4caf50; color: #fff; }

#btnAsignarProduccion:hover { filter: brightness(1.2); }

.modal-actions button:last-child { background: #555; color: #fff; }

.modal-actions button:last-child:hover { background: #777; }

Â Â 

<style>

/* Reutiliza el estilo del modal de calidad */

#modalAsignarTarimaProduccion .modal-content {

Â  background: #fff;

Â  padding: 20px;

Â  margin: 10% auto;

Â  width: 90%; max-width: 400px;

Â  border-radius: 10px;

}

</style>

Â  <button class="mt-fab" id="mtOpenBtn" style="display:none;" title="IdentificaciÃ³n de Tarima">TARIMAS</button>



<!-- === NUEVO: Panel lateral de IdentificaciÃ³n de Tarima === -->

<div id="mtPanel" class="mt-panel" aria-hidden="true">

Â  <div class="mt-panel-content">

Â  Â  <button id="mtCloseBtn" class="mt-close" aria-label="Cerrar panel">&times;</button>

Â  Â  <h2>IdentificaciÃ³n de Tarima</h2>

Â  Â  <p>Escanea o ingresa un cÃ³digo <b>BX</b> para identificar la tarima:</p>



Â  Â  <div class="mt-row">

Â  Â  Â  <input type="text" id="bxInput" placeholder="Escanear/pegar cÃ³digo BX..." autocomplete="off" />

Â  Â  Â  <button id="buscarTarimaBtn" class="mt-btn mt-primary">Buscar</button>

Â  Â  </div>



Â  Â  <!-- Resultado de bÃºsqueda -->

Â  Â  <div id="tarimaInfo" class="mt-card" style="display:none;">

Â  Â  Â  <h3>Tarima encontrada</h3>

Â  Â  Â  <div class="mt-grid">

Â  Â  Â  Â  <div><b>ID:</b> <span id="tarimaId">â€”</span></div>

Â  Â  Â  Â  <div><b>Empleado:</b> <span id="empleado">â€”</span></div>

Â  Â  Â  Â  <div><b>Turno:</b> <span id="turno">â€”</span></div>

Â  Â  Â  Â  <div><b>Total cajas:</b> <span id="totalCajas">0</span></div>

Â  Â  Â  Â  <div><b>Total piezas:</b> <span id="totalPiezas">0</span></div>

Â  Â  Â  </div>



Â  Â  Â  <h4>Detalle de cajas (BX | piezas)</h4>

Â  Â  Â  <ul id="listaCajas" class="mt-list"></ul>

Â <div id="tarimasPendientesPanel">

Â  <h3>Tarimas pendientes por inspecciÃ³n</h3>

Â  <ul id="listaTarimasPendientes"></ul>

</div>



Â  Â  Â  <!-- Solo para CALIDAD: asignaciÃ³n de LED -->

Â  Â  Â  <div id="ledAssignment" class="mt-assign" style="display:none;">

Â  Â  Â  Â  <label for="ledSelect">Asignar LED a esta tarima:</label>

Â  Â  Â  Â  <div class="mt-row">

Â  Â  Â  Â  Â  <select id="ledSelect" class="mt-select"></select>

Â  Â  Â  Â  Â  <button id="asignarLedBtn" class="mt-btn mt-success">Asignar LED</button>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <small>Nota: los LEDs solo podrÃ¡n encenderse/apagarse si tienen tarima asignada.</small>

Â  Â  Â  </div>

Â  Â  </div>

Â  </div>

</div>

Â Â 

<script>

// ================= CONFIG Y ESTADO =================

const CONFIG = {

Â  Â  USUARIOS: ['MULTIPORT', 'BEDROCK', 'DROPS', 'LOGÃSTICA', 'SUPERVISOR', 'CALIDAD'],

Â  Â  PRODUCCION_GRUPOS: ['MULTIPORT', 'BEDROCK', 'DROPS'],

Â  Â  PASSWORDS: {

Â  Â  Â  Â  'LOGÃSTICA': 'LOGRAM',

Â  Â  Â  Â  'MULTIPORT': 'MP25',

Â  Â  Â  Â  'BEDROCK': 'BR25',

Â  Â  Â  Â  'DROPS': 'DROP25',

Â  Â  Â  Â  'SUPERVISOR': 'SUP25',

Â  Â  Â  Â  'CALIDAD_MULTIPORT': 'AQLMP',

Â  Â  Â  Â  'CALIDAD_DROPS': 'AQLDP',

Â  Â  Â  Â  'CALIDAD_BEDROCK': 'AQLBR',

Â  Â  Â  Â  'REPORTES': 'REPO25',

Â  Â  Â  Â  'DASHBOARD': 'DASH25'

Â  Â  },

Â  Â  LEDS_POR_GRUPO: {

Â  Â  Â  Â  'MULTIPORT': 5,

Â  Â  Â  Â  'BEDROCK': 5,

Â  Â  Â  Â  'DROPS': 5,

Â  Â  Â  Â  'CALIDAD_MULTIPORT': 5,

Â  Â  Â  Â  'CALIDAD_BEDROCK': 5,

Â  Â  Â  Â  'CALIDAD_DROPS': 5

Â  Â  }

};



let usuarioSeleccionado = null;

let ledActivoParaFormulario = { grupo: null, idx: null, linea: null };

let reporteActual = null;

let datosFiltradosReporte = null;

let miGrafico;

let graficosDashboard = {};

let dashboardUpdateInterval;





// -------------------------------------------------------

//Â  âœ… RestauraciÃ³n/Compat: seleccionarUsuario()

//Â  - Evita el error "seleccionarUsuario is not defined"

//Â  - Si existÃ­a una versiÃ³n anterior, la detecta y delega.

//Â  - AÃ‘ADE: seteo de tema oscuro para Calidad/ProducciÃ³n,

//Â  Â  Â  Â  Â  Â y muestra el FAB de Tarimas.

// -------------------------------------------------------

// ================= FIREBASE =================

const firebaseConfig = {

Â  Â  apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",

Â  Â  authDomain: "panel-logistica.firebaseapp.com",

Â  Â  databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",

Â  Â  projectId: "panel-logistica",

Â  Â  storageBucket: "panel-logistica.appspot.com",

Â  Â  messagingSenderId: "38365879945",

Â  Â  appId: "1:38365879945:web:e2f3590fe77f013dba3058"

};

firebase.initializeApp(firebaseConfig);

const database = firebase.database();

const db = database;Â 

const ledRef = database.ref('estadoLEDs');

let historialRef;

let contadoresCalidadRef;

let rechazosDetalladosRef;

let dashboardListeners = [];



window.database = window.database || firebase.database();



// Guardaremos el usuario actual (texto del botÃ³n que usan)

window.__usuarioActual = null;



(function compatSeleccionarUsuario(){

Â  const legacy = window.seleccionarUsuario; // por si ya existÃ­a

Â  window._seleccionarUsuarioOriginal = (typeof legacy === 'function') ? legacy : null;



Â  window.seleccionarUsuario = function(usuarioClave) {

Â  Â  try {

Â  Â  Â  window.__usuarioActual = String(usuarioClave || '').toUpperCase();



Â  Â  Â  // Tema oscuro solo para CALIDAD_* y PRODUCCION_*

Â  Â  Â  const isDark = window.__usuarioActual.startsWith('CALIDAD') || window.__usuarioActual.startsWith('PRODUCCION');

Â  Â  Â  document.body.classList.toggle('theme-dark', isDark);



Â  Â  Â  // Mostrar FAB "TARIMAS" solo cuando ya hay usuario elegido

Â  Â  Â  const fab = document.getElementById('mtOpenBtn');

Â  Â  Â  if (fab) fab.style.display = 'block';



Â  Â  Â  // Delegar a tu funciÃ³n original si existÃ­a:

Â  Â  Â  if (window._seleccionarUsuarioOriginal) {

Â  Â  Â  Â  return window._seleccionarUsuarioOriginal(usuarioClave);

Â  Â  Â  }



Â  Â  Â  // Si no habÃ­a original, al menos no tronamos:

Â  Â  Â  console.info('[Compat] seleccionarUsuario activo (sin versiÃ³n original). Usuario:', window.__usuarioActual);

Â  Â  } catch (e) {

Â  Â  Â  console.error('Error en seleccionarUsuario compat:', e);

Â  Â  }

Â  };

})();



// ==============ARRIBA ELIMINE ALGO=========================================

//Â  ğŸ¯ NUEVO: IdentificaciÃ³n de Tarimas y Amarre con LEDs

//Â  - Buscar tarima por BX

//Â  - Mostrar detalle: empleado/turno/cajas/piezas/lista BX

//Â  - En CALIDAD: asignar LED a tarima (ledsAsignados/{ledId})

//Â  - En PRODUCCIÃ“N/LOGÃSTICA: no se puede accionar LED sin tarima

//Â  - En LOGÃSTICA: al apagar, se libera el LED (remove ledsAsignados)

// =======================================================



Â  function contadoresVisiblesPara(usuario) {

Â  if ((usuario || '').startsWith('CALIDAD_')) return ['liberadas', 'rechazadas'];

Â  if (usuario === 'LOGÃSTICA')Â  Â  Â  Â  Â  Â  Â  Â return ['recolectadas'];

Â  // ProducciÃ³n (MULTIPORT/DROPS/BEDROCK):

Â  return ['asignadas']; // o ['confirmadas'] si ya tienes esa acciÃ³n implementada

}

Â  // Helpers UI panel

const MT = {

Â  ui: {

Â  Â  panel:Â  Â document.getElementById('mtPanel'),

Â  Â  openBtn: document.getElementById('mtOpenBtn'),

Â  Â  closeBtn:document.getElementById('mtCloseBtn'),

Â  Â  bxInput: document.getElementById('bxInput'),

Â  Â  buscarBtn: document.getElementById('buscarTarimaBtn'),

Â  Â  infoBox: document.getElementById('tarimaInfo'),

Â  Â  fields: {

Â  Â  Â  id: document.getElementById('tarimaId'),

Â  Â  Â  empleado: document.getElementById('empleado'),

Â  Â  Â  turno: document.getElementById('turno'),

Â  Â  Â  totalCajas: document.getElementById('totalCajas'),

Â  Â  Â  totalPiezas: document.getElementById('totalPiezas'),

Â  Â  Â  listaCajas: document.getElementById('listaCajas')

Â  Â  },

Â  Â  asignacion: {

Â  Â  Â  wrap: document.getElementById('ledAssignment'),

Â  Â  Â  select: document.getElementById('ledSelect'),

Â  Â  Â  btn: document.getElementById('asignarLedBtn')

Â  Â  }

Â  },

Â  state: {

Â  Â  tarimaActual: null // { id, empleadoId, turno, cajas:{...}, totalPiezas }

Â  }

};



// Abrir / cerrar panel

if (MT.ui.openBtn) MT.ui.openBtn.addEventListener('click', () => MT.ui.panel.classList.add('open'));

if (MT.ui.closeBtn) MT.ui.closeBtn.addEventListener('click', () => MT.ui.panel.classList.remove('open'));



// Buscar tarima por BX

if (MT.ui.buscarBtn) {

Â  MT.ui.buscarBtn.addEventListener('click', () => {

Â  Â  const bx = (MT.ui.bxInput.value || '').trim();

Â  Â  if (!bx) { alert('Ingresa o escanea un cÃ³digo BX'); return; }

Â  Â  buscarTarimaPorBX(bx);

Â  });

}

// TambiÃ©n Enter en input

if (MT.ui.bxInput) {

Â  MT.ui.bxInput.addEventListener('keypress', (e) => {

Â  Â  if (e.key === 'Enter') MT.ui.buscarBtn.click();

Â  });

}





// === Helpers de grupo / rutas ===

function grupoProduccionDe(grupoCalidadOProd) {

Â  // CALIDAD_MULTIPORT -> MULTIPORT, etc.

Â  return (grupoCalidadOProd || '').replace(/^CALIDAD_/, '');

}



function nowISO() {

Â  return new Date().toISOString();

}



// === Workflow por tarima ===

function pushWorkflow(tarimaId, evento, extra = {}) {

Â  return db.ref(`tarimas/${tarimaId}/workflow`).push({

Â  Â  evento,

Â  Â  actor: usuarioSeleccionado || 'N/D',

Â  Â  timestamp: nowISO(),

Â  Â  ...extra

Â  });

}Â Â 

/**

Â * Lee /tarimas en estructura:

Â * tarimas/{idTarima}/{

Â *Â  Â empleadoId, turno, cajas:{ pushKey: {codigoCaja, cantidadPiezas, numeroOrden, ...} }

Â * }

Â */

function buscarTarimaPorBX(bxCode) {

Â  database.ref('tarimas').once('value').then(snapshot => {

Â  Â  let encontrada = null;

Â  Â  snapshot.forEach(tSnap => {

Â  Â  Â  const t = tSnap.val() || {};

Â  Â  Â  const cajas = t.cajas || {};

Â  Â  Â  for (const k in cajas) {

Â  Â  Â  Â  if (cajas[k] && cajas[k].codigoCaja === bxCode) {

Â  Â  Â  Â  Â  encontrada = { id: t.id || tSnap.key, ...t };

Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  }

Â  Â  Â  }

Â  Â  Â  if (encontrada) return true; // corta forEach

Â  Â  });



Â  Â  if (!encontrada) {

Â  Â  Â  MT.ui.infoBox.style.display = 'none';

Â  Â  Â  alert('No se encontrÃ³ tarima con ese BX.');

Â  Â  Â  return;

Â  Â  }



Â  Â  // Guardamos y pintamos

Â  Â  MT.state.tarimaActual = normalizarTarima(encontrada);

Â  Â  renderTarimaEncontrada(MT.state.tarimaActual);

Â  }).catch(err => {

Â  Â  console.error('Error buscando tarima:', err);

Â  Â  alert('Error al buscar la tarima. Reintenta.');

Â  });

}



// Normaliza estructura a un objeto amigable p/ UI

function normalizarTarima(t) {

Â  const out = {

Â  Â  id: t.id,

Â  Â  empleadoId: t.empleadoId || t.empleado || 'N/D',

Â  Â  turno: t.turno || 'N/D',

Â  Â  totalCajas: 0,

Â  Â  totalPiezas: 0,

Â  Â  cajas: [] // [{codigoCaja, cantidadPiezas}]

Â  };

Â  const cajas = t.cajas || {};

Â  for (const cid in cajas) {

Â  Â  const c = cajas[cid] || {};

Â  Â  out.cajas.push({

Â  Â  Â  id: cid,

Â  Â  Â  codigoCaja: c.codigoCaja || 'â€”',

Â  Â  Â  cantidadPiezas: Number(c.cantidadPiezas || c.piezas || 0)

Â  Â  });

Â  }

Â  out.totalCajas = out.cajas.length;

Â  out.totalPiezas = out.cajas.reduce((a,c)=>a + (Number.isFinite(c.cantidadPiezas)?c.cantidadPiezas:0), 0);

Â  return out;

}



// Carga todos los LEDs disponibles directamente en el dropdown del panel.

// Carga todos los LEDs disponibles directamente en el dropdown del panel.

Â Â 

function cargarLedsDisponibles() {

Â  Â  const sel = MT.ui.asignacion.select;

Â  Â  sel.innerHTML = '';



Â  Â  // Escuchar en tiempo real los LEDs asignados

Â  Â  db.ref('estadoLEDs/CALIDAD_MULTIPORT/linea1').on('value', snap => {

Â  Â  Â  Â  sel.innerHTML = ''; // limpiar cada vez

Â  Â  Â  Â  const ledsEstado = snap.val() || {};

Â  Â  Â  Â  const totalLeds = 5; // ajusta segÃºn corresponda



Â  Â  Â  Â  for (let i = 0; i < totalLeds; i++) {

Â  Â  Â  Â  Â  Â  const estado = ledsEstado[i] || {};

Â  Â  Â  Â  Â  Â  const ledId = `linea1-${i+1}`;



Â  Â  Â  Â  Â  Â  // Solo mostrar los disponibles (sin tarimaId asignada)

Â  Â  Â  Â  Â  Â  if (!estado.tarimaId) {

Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');

Â  Â  Â  Â  Â  Â  Â  Â  opt.value = ledId;

Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = ledId;

Â  Â  Â  Â  Â  Â  Â  Â  sel.appendChild(opt);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  });

}

Â Â 

function renderTarimasPendientes() {

Â  Â  const lista = document.getElementById('listaTarimasPendientes');

Â  Â  lista.innerHTML = '';



Â  Â  db.ref('tarimas').once('value').then(snap => {

Â  Â  Â  Â  const tarimas = snap.val() || {};



Â  Â  Â  Â  db.ref('tarimasAsignadas').once('value').then(snap2 => {

Â  Â  Â  Â  Â  Â  const asignadas = snap2.val() || {};

Â  Â  Â  Â  Â  Â  const usadas = Object.keys(asignadas);



Â  Â  Â  Â  Â  Â  Object.values(tarimas).forEach(t => {

Â  Â  Â  Â  Â  Â  Â  Â  if (!usadas.includes(t.id)) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.textContent = `#${t.id}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.style.cursor = "pointer";

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.onclick = () => renderTarimaEncontrada(t);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lista.appendChild(li);

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  });

Â  Â  });

}



// ğŸ”¥ refrescar en tiempo real

db.ref('tarimas').on('value', renderTarimasPendientes);

db.ref('tarimasAsignadas').on('value', renderTarimasPendientes);





// Escribe el vÃ­nculo LED â†” Tarima y actualiza el estado del LED

// Escribe el vÃ­nculo LED â†” Tarima y actualiza el estado del LED

Â Â 

function asignarLedATarima(ledId, tarimaId) {

Â  Â  // ğŸ’¡ Paso 1: Verificar si la tarima ya estÃ¡ asignada en algÃºn otro lugar

Â  Â  database.ref('tarimasAsignadas/' + tarimaId).once('value').then(snap => {

Â  Â  Â  Â  if (snap.exists()) {

Â  Â  Â  Â  Â  Â  return alert(`Error: La tarima ${tarimaId} ya ha sido asignada al LED ${snap.val().ledId}.`);

Â  Â  Â  Â  }



Â  Â  Â  Â  // Si no estÃ¡ asignada, continuar con el proceso

Â  Â  Â  Â  const payload = {

Â  Â  Â  Â  Â  Â  tarimaId,

Â  Â  Â  Â  Â  Â  asignadoPor: window.__usuarioActual || 'N/D',

Â  Â  Â  Â  Â  Â  timestamp: Date.now()

Â  Â  Â  Â  };



Â  Â  Â  Â  const grupo = 'CALIDAD_MULTIPORT';

Â  Â  Â  Â  const linea = 'linea1';

Â  Â  Â  Â  const ledIndex = parseInt(ledId.split('-')[1]) - 1;



Â  Â  Â  Â  const ledEstadoRef = db.ref(`estadoLEDs/${grupo}/${linea}/${ledIndex}`);

Â  Â  Â  Â  ledEstadoRef.set({

Â  Â  Â  Â  Â  Â  color: 'naranja',

Â  Â  Â  Â  Â  Â  tarimaId: tarimaId,

Â  Â  Â  Â  Â  Â  usuario: window.__usuarioActual || 'N/D',

Â  Â  Â  Â  Â  Â  timestamp: new Date().toISOString()

Â  Â  Â  Â  }).then(() => {

Â  Â  Â  Â  Â  Â  // ğŸ’¡ Paso 2: Registrar que la tarima ya fue asignada

Â  Â  Â  Â  Â  Â  database.ref('tarimasAsignadas/' + tarimaId).set({ ledId: ledId, timestamp: Date.now() });

Â  Â  Â  Â  Â  Â  alert(`âœ… Tarima ${tarimaId} asignada al LED ${ledId}`);

Â  Â  Â  Â  }).catch(err => {

Â  Â  Â  Â  Â  Â  console.error('Error asignando LED:', err);

Â  Â  Â  Â  Â  Â  alert('No se pudo asignar el LED. Intenta nuevamente.');

Â  Â  Â  Â  });

Â  Â  });

}



// ========================

// PRODUCCIÃ“N: Asignar Tarima

// ========================

// ========================

// PRODUCCIÃ“N: Asignar Tarima a LED

// ========================

function asignarTarimaProduccion(grupo, idx, linea) {

Â  const select = document.getElementById('selectTarimaProduccion');

Â  const key = select.value;

Â  if (!key) {

Â  Â  alert("âŒ Debes seleccionar una tarima.");

Â  Â  return;

Â  }



Â  const recibidaRef = db.ref(`tarimasRecibidas/${grupo}/${key}`);

Â  recibidaRef.once('value', snapshot => {

Â  Â  const tarima = snapshot.val();

Â  Â  if (!tarima) {

Â  Â  Â  alert("âŒ Tarima no encontrada en recibidas.");

Â  Â  Â  return;

Â  Â  }



Â  Â  const { fecha, turno } = obtenerTurnoActual();

Â  Â  const tarimaId = tarima.tarimaId || key;



Â  Â  // 1) Guardar en LED de ProducciÃ³n

Â  Â  const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);

Â  Â  ledRef.set({

Â  Â  Â  encendido: true,

Â  Â  Â  tarimaId: tarimaId,

Â  Â  Â  usuario: usuarioSeleccionado,

Â  Â  Â  timestamp: nowISO(),

Â  Â  Â  horaEncendido: firebase.database.ServerValue.TIMESTAMP

Â  Â  });



Â  Â  // 2) Actualizar estado global de la tarima

Â  Â  db.ref(`tarimas/${tarimaId}`).update({

Â  Â  Â  estado: 'asignada',

Â  Â  Â  grupo: grupo,

Â  Â  Â  linea: linea,

Â  Â  Â  asignadaPor: usuarioSeleccionado,

Â  Â  Â  timestampAsignada: nowISO()

Â  Â  });



Â  Â  // 3) Workflow + historial + contador

Â  Â  pushWorkflow(tarimaId, 'asignada_en_produccion', { grupo, linea, led: `${linea}-${idx+1}` });

Â  Â  db.ref(`historialLogs/${fecha}/${turno}`).push({

Â  Â  Â  usuario: usuarioSeleccionado,

Â  Â  Â  grupo,

Â  Â  Â  accion: 'asignada_en_produccion',

Â  Â  Â  tarimaId: tarimaId,

Â  Â  Â  timestamp: nowISO()

Â  Â  });

Â  Â  db.ref(`contadoresTarimas/${fecha}/${turno}/${grupo}/asignadas`)

Â  Â  Â  .transaction(v => (v || 0) + 1);



Â  Â  // 4) Eliminar de recibidas

Â  Â  recibidaRef.remove();



Â  Â  alert(`âœ… Tarima ${tarimaId} asignada a LED ${linea}-${idx+1}`);

Â  Â  cerrarModalProduccion && cerrarModalProduccion();

Â  });

}

Â  // ========================

// CALIDAD: Liberar Tarima

// ========================

// ========================

// CALIDAD: Liberar Tarima (CANÃ“NICA)

// ========================

function liberarTarima(tarimaId) {

Â  const { fecha, turno } = obtenerTurnoActual();

Â  const grupoCalidad = usuarioSeleccionado;Â  Â  Â  Â  Â  Â  Â  Â // ej: CALIDAD_MULTIPORT

Â  const grupoProdÂ  Â  Â = grupoProduccionDe(grupoCalidad);Â  // ej: MULTIPORT

Â  const tarimaRefÂ  Â  Â = db.ref(`tarimas/${tarimaId}`);



Â  tarimaRef.once('value').then(snap => {

Â  Â  if (!snap.exists()) {

Â  Â  Â  alert(`âŒ Tarima ${tarimaId} no encontrada en TARIMAS.`);

Â  Â  Â  return;

Â  Â  }



Â  Â  // 1) Estado global

Â  Â  tarimaRef.update({

Â  Â  Â  estado: 'liberada',

Â  Â  Â  liberadaPor: usuarioSeleccionado,

Â  Â  Â  timestampLiberada: nowISO()

Â  Â  });



Â  Â  // 2) Hacerla visible a ProducciÃ³n (clave = tarimaId)

Â  Â  db.ref(`tarimasRecibidas/${grupoProd}/${tarimaId}`).set({

Â  Â  Â  tarimaId,

Â  Â  Â  estado: 'recibida',

Â  Â  Â  ledOrigen: (snap.val() && snap.val().led) || 'N/D',

Â  Â  Â  recibidaDe: grupoCalidad,

Â  Â  Â  timestampRecibida: nowISO()

Â  Â  });



Â  Â  // 3) Workflow + historial + contador (Calidad)

Â  Â  pushWorkflow(tarimaId, 'liberada', { grupoCalidad, grupoProd });

Â  Â  db.ref(`historialLogs/${fecha}/${turno}`).push({

Â  Â  Â  usuario: usuarioSeleccionado,

Â  Â  Â  grupo: grupoCalidad,

Â  Â  Â  accion: 'liberada',

Â  Â  Â  tarimaId,

Â  Â  Â  timestamp: nowISO()

Â  Â  });

Â  Â  db.ref(`contadoresTarimas/${fecha}/${turno}/${grupoCalidad}/liberadas`)

Â  Â  Â  .transaction(v => (v || 0) + 1);



Â  Â  alert(`âœ… Tarima ${tarimaId} liberada y enviada a ${grupoProd}.`);

Â  Â  cerrarModalCalidad && cerrarModalCalidad();

Â  });

}

Â  // --- !!DESPLIEQUE DE TARIMA EN PANEL, AGREGA DOWNDROP A CALIDAD O !! ---

Â Â 

Â  function renderTarimaEncontrada(tarima) {

Â  // Rellena campos

Â  MT.ui.fields.id.textContent = tarima.id;

Â  MT.ui.fields.empleado.textContent = tarima.empleadoId;

Â  MT.ui.fields.turno.textContent = tarima.turno;

Â  MT.ui.fields.totalCajas.textContent = tarima.totalCajas;

Â  MT.ui.fields.totalPiezas.textContent = tarima.totalPiezas;



Â  // Lista de cajas

Â  MT.ui.fields.listaCajas.innerHTML = '';

Â  tarima.cajas.forEach(c => {

Â  Â  const li = document.createElement('li');

Â  Â  li.textContent = `${c.codigoCaja}Â  |Â  ${c.cantidadPiezas} pz`;

Â  Â  MT.ui.fields.listaCajas.appendChild(li);

Â  });



Â  // Si el usuario es CALIDAD_* â†’ mostrar asignaciÃ³n de LED

Â  const isCalidad = (window.__usuarioActual || '').startsWith('CALIDAD');

Â  MT.ui.asignacion.wrap.style.display = isCalidad ? 'block' : 'none';



Â  if (isCalidad) {

Â  Â  // ğŸ’¡ Llama a la funciÃ³n que ahora genera los LEDs en el panel.

Â  Â  cargarLedsDisponibles();

Â  Â  // ğŸ’¡ Asegura que el botÃ³n de asignar del panel tenga la lÃ³gica de asignaciÃ³n.

Â  Â  MT.ui.asignacion.btn.onclick = () => {

Â  Â  Â  const ledId = MT.ui.asignacion.select.value;

Â  Â  Â  if (!ledId) return;

Â  Â  Â  asignarLedATarima(ledId, tarima.id);

Â  Â  };

Â  }



Â  MT.ui.infoBox.style.display = 'block';

}



Â  // =======================================================

//Â  âœ… VALIDACIÃ“N DE ACCIONES SOBRE LEDs

//Â  - Solo permite encender/apagar si hay tarima asignada.

//Â  - En apagado (LogÃ­stica), libera el LED.

//Â  - Se integra SIN romper tus funciones existentes.

//Â  Â  * Si tenÃ­as encenderLed/apagarLed â†’ las envolvemos.

//Â  Â  * Si no, exponemos estas funciones para tus botones.

// =======================================================



function validarLedAntesDeAccion(ledId) {

Â  return database.ref('ledsAsignados/'+ledId).once('value').then(snap => snap.exists());

}



// Wrappers seguros (detectan y envuelven funciones existentes)

(function envolverAccionesLED(){

Â  const _encender = window.encenderLed;

Â  const _apagar = window.apagarLed;



Â  // Encender: requiere tarima asignada

Â  window.encenderLed = function(ledId) {

Â  Â  validarLedAntesDeAccion(ledId).then(ok => {

Â  Â  Â  if (!ok) { alert('Este LED no tiene tarima asignada. Asigna una desde Calidad.'); return; }

Â  Â  Â  if (typeof _encender === 'function') {

Â  Â  Â  Â  // Tu lÃ³gica original

Â  Â  Â  Â  _encender(ledId);

Â  Â  Â  } else {

Â  Â  Â  Â  // Por si no existÃ­a: write directo (mantÃ©n tu pintarLed/cargarEstado aparte)

Â  Â  Â  Â  database.ref('estadoLEDs/'+ledId).set(true);

Â  Â  Â  }

Â  Â  }).catch(err => console.error('ValidaciÃ³n LED fallÃ³:', err));

Â  };



Â  // Apagar: requiere tarima asignada y luego libera

Â  window.apagarLed = function(ledId) {

Â  Â  validarLedAntesDeAccion(ledId).then(ok => {

Â  Â  Â  if (!ok) { alert('Este LED no tiene tarima asignada.'); return; }

Â  Â  Â  const apagarAccion = () => {

Â  Â  Â  Â  if (typeof _apagar === 'function') {

Â  Â  Â  Â  Â  _apagar(ledId);

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  database.ref('estadoLEDs/'+ledId).set(false);

Â  Â  Â  Â  }

Â  Â  Â  Â  // LiberaciÃ³n automÃ¡tica

Â  Â  Â  Â  database.ref('ledsAsignados/'+ledId).remove()

Â  Â  Â  Â  Â  .then(()=>console.info('LED liberado:', ledId))

Â  Â  Â  Â  Â  .catch(err=>console.warn('No se pudo liberar LED:', err));

Â  Â  Â  };

Â  Â  Â  apagarAccion();

Â  Â  }).catch(err => console.error('ValidaciÃ³n LED fallÃ³:', err));

Â  };

})();



// =======================================================

//Â  ğŸ“Œ NOTAS PARA FUTURAS EXTENSIONES

//Â  - Reportes: puedes consumir /tarimas y /ledsAsignados para ver

//Â  Â  quÃ© LED tuvo quÃ© tarima y cuÃ¡ndo.

//Â  - Permisos: si luego agregas auth/roles, aquÃ­ puedes condicionar

//Â  Â  la visibilidad del FAB y del panel por usuario.

//Â  - Reglas de seguridad: idealmente, en Firebase Rules valida que

//Â  Â  solo se pueda escribir /estadoLEDs/{ledId} si existe

//Â  Â  /ledsAsignados/{ledId}. AsÃ­ la seguridad queda a prueba de balas.

// =======================================================



Â Â 

// ================= FUNCIONES DE RENDER ( REPARTE LA PANTALLA 2 ACORDE AL USUARIO SELECCIONADO =================

function inyectaLEDs(){

Â  Â  document.querySelectorAll('.grupo').forEach(grupoDiv => {

Â  Â  Â  Â  grupoDiv.classList.add('oculto');

Â  Â  });



Â  Â  if (usuarioSeleccionado === 'SUPERVISOR') {

Â  Â  Â  Â  document.querySelectorAll('.grupo').forEach(grupoDiv => {

Â  Â  Â  Â  Â  Â  grupoDiv.classList.remove('oculto');

Â  Â  Â  Â  });

Â  Â  } else if (usuarioSeleccionado === 'LOGÃSTICA') {

Â  Â  Â  Â  document.querySelectorAll('.grupo:not([data-grupo*="CALIDAD_"])').forEach(grupoDiv => {

Â  Â  Â  Â  Â  Â  grupoDiv.classList.remove('oculto');

Â  Â  Â  Â  });

Â  Â  } else if (usuarioSeleccionado.startsWith('CALIDAD_')) {

Â  Â  Â  Â  document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`).classList.remove('oculto');

Â  Â  } else {

Â  Â  Â  Â  document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`).classList.remove('oculto');

Â  Â  Â  Â  document.querySelector(`.grupo[data-grupo="CALIDAD_${usuarioSeleccionado}"]`).classList.remove('oculto');

Â  Â  }



Â  Â  document.querySelectorAll('.grupo:not(.oculto) .leds').forEach(contenedor => {

Â  Â  Â  Â  const grupoLeds = contenedor.dataset.grupo;

Â  Â  Â  Â  const linea = contenedor.dataset.linea;

Â  Â  Â  Â Â 

Â  Â  Â  Â  const ledsPorLinea = 5;

Â  Â  Â  Â  contenedor.innerHTML = '';

Â  Â  Â  Â Â 

Â  Â  Â  Â  for(let i = 0; i < ledsPorLinea; i++){

Â  Â  Â  Â  Â  Â  const led = document.createElement('div');

Â  Â  Â  Â  Â  Â  led.className = 'led';

Â  Â  Â  Â  Â  Â  led.title = `${grupoLeds} â€¢ ${linea} â€¢ LED ${i+1}`;

Â  Â  Â  Â  Â  Â  led.addEventListener('click', () => togglearLED(grupoLeds, i, linea));

Â  Â  Â  Â  Â  Â  contenedor.appendChild(led);

Â  Â  Â  Â  }

Â  Â  });

}



// --- !!DETALLES CON LOS LEDS, ENCENDIDOS FX ETC!! ---

Â Â 

function pintarEstado() {

Â  Â  db.ref('estadoLEDs').on('value', snapshot => {

Â  Â  Â  Â  const estados = snapshot.val() || {};

Â  Â  Â  Â  document.querySelectorAll('.leds').forEach(contenedor => {

Â  Â  Â  Â  Â  Â  const grupoLeds = contenedor.dataset.grupo;

Â  Â  Â  Â  Â  Â  const linea = contenedor.dataset.linea;



Â  Â  Â  Â  Â  Â  if (estados[grupoLeds] && estados[grupoLeds][linea]) {

Â  Â  Â  Â  Â  Â  Â  Â  const ledsEstado = estados[grupoLeds][linea];

Â  Â  Â  Â  Â  Â  Â  Â  contenedor.querySelectorAll('.led').forEach((led, index) => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.classList.remove('on', 'naranja', 'rojo', 'verde', 'disabled');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.innerHTML = '';



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ledsEstado[index]) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const estado = ledsEstado[index];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let tarimaId = estado.tarimaId || "";

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tarimaId.length > 6) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // mostramos Ãºltimos 4 caracteres si es largo

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tarimaId = tarimaId.slice(-4);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (grupoLeds.startsWith('CALIDAD_') && estado.color) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LEDs de Calidad

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.classList.add(estado.color);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tarimaId) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.innerHTML = `<span class="tarima-label">${tarimaId}</span>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (estado.encendido) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LEDs de ProducciÃ³n

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.classList.add('on');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tarimaId) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.innerHTML = `<span class="tarima-label">${tarimaId}</span>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  contenedor.querySelectorAll('.led').forEach(led => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.classList.remove('on', 'naranja', 'rojo', 'verde', 'disabled');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.innerHTML = '';

Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });

Â  Â  });

}

Â Â 

function actualizarTiemposLEDs() {

Â  Â  document.querySelectorAll('.led-linea .led.on').forEach(led => {

Â  Â  Â  Â  const horaEncendido = led.dataset.horaEncendido;

Â  Â  Â  Â  if (horaEncendido) {

Â  Â  Â  Â  Â  Â  const tiempoTranscurrido = (new Date() - new Date(horaEncendido)) / 1000; // En segundos

Â  Â  Â  Â  Â  Â  const minutos = Math.floor(tiempoTranscurrido / 60);

Â  Â  Â  Â  Â  Â  const segundos = Math.floor(tiempoTranscurrido % 60);

Â  Â  Â  Â  Â  Â  led.querySelector('.tiempo-led').textContent = `${minutos}m ${segundos}s`;

Â  Â  Â  Â  }

Â  Â  });

}

Â  // --- !!CONFIGURACION DE HORA Y TURNOS!! ---

Â Â 

Â  function formatoHora(isoString) {

Â  Â  if (!isoString) return 'N/A';

Â  Â  const date = new Date(isoString);

Â  Â  const hours = String(date.getHours()).padStart(2, '0');

Â  Â  const minutes = String(date.getMinutes()).padStart(2, '0');

Â  Â  return `${hours}:${minutes}`;

}



function obtenerTurnoActual() {

Â  Â  const ahora = new Date();

Â  Â  const hora = ahora.getHours();

Â  Â  const minutos = ahora.getMinutes();



Â  Â  let fecha = new Date(ahora);

Â  Â  let turno;



Â  Â  // Turno 1: 06:30 a 18:29

Â  Â  if ((hora > 6 || (hora === 6 && minutos >= 30)) && (hora < 18 || (hora === 18 && minutos < 30))) {

Â  Â  Â  Â  turno = 'Turno 1';

Â  Â  }Â 

Â  Â  // Turno 2: 18:30 a 06:29 del dÃ­a siguiente

Â  Â  else {

Â  Â  Â  Â  turno = 'Turno 2';

Â  Â  Â  Â  if (hora < 6 || (hora === 6 && minutos < 30)) {

Â  Â  Â  Â  Â  Â  fecha.setDate(ahora.getDate() - 1);

Â  Â  Â  Â  }

Â  Â  }

Â  Â Â 

Â  Â  const year = fecha.getFullYear();

Â  Â  const month = String(fecha.getMonth() + 1).padStart(2, '0');

Â  Â  const day = String(fecha.getDate()).padStart(2, '0');

Â  Â  const fechaFormateada = `${year}-${month}-${day}`;

Â  Â Â 

Â  Â  return { fecha: fechaFormateada, turno };

}



// --- !! SINCRONIZACION EN TIEMPO REALÂ  !! ---

Â Â 

Â  // --- !! SINCRONIZACION EN TIEMPO REAL CON TARIMAS !! ---

// --- !! SINCRONIZACION EN TIEMPO REAL CON TARIMAS !! ---

function iniciarListenersFirebase() {

Â  Â  const { fecha, turno } = obtenerTurnoActual();

Â  Â  document.getElementById('turnoActual').textContent = `Turno actual: ${turno}`;



Â  Â  // ğŸ”— Referencias a la base de datos

Â  Â  const historialRef = db.ref(`historialLogs/${fecha}/${turno}`);

Â  Â  const contadoresTarimasRef = db.ref(`contadoresTarimas/${fecha}/${turno}`);

Â  Â Â 

Â  Â  // ğŸ”„ Limpiar listeners anteriores (si estÃ¡n definidos)

Â  Â  // Nota: Aunque ya tienes variables globales, declararlas aquÃ­ dentro asegura

Â  Â  // que siempre tengas la referencia correcta para este turno.

Â  Â  if (historialRef) historialRef.off();

Â  Â  if (contadoresTarimasRef) contadoresTarimasRef.off();



Â  Â  // --- Listener: historial en tiempo real ---

Â  Â  historialRef.on('value', (snapshot) => {

Â  Â  Â  Â  const logs = snapshot.val() || {};

Â  Â  Â  Â  let tarimasTotales = 0;

Â  Â  Â  Â  let tiempoTotalRecoleccion = 0;



Â  Â  Â  Â  // ğŸ“Š Contadores por grupo

Â  Â  Â  Â  const contadores = {

Â  Â  Â  Â  Â  Â  MULTIPORT: { asignadas: 0, recolectadas: 0, rechazadas: 0, liberadas: 0 },

Â  Â  Â  Â  Â  Â  BEDROCK:Â  Â { asignadas: 0, recolectadas: 0, rechazadas: 0, liberadas: 0 },

Â  Â  Â  Â  Â  Â  DROPS:Â  Â  Â { asignadas: 0, recolectadas: 0, rechazadas: 0, liberadas: 0 },

Â  Â  Â  Â  Â  Â  CALIDAD_MULTIPORT: { rechazadas: 0, liberadas: 0 },

Â  Â  Â  Â  Â  Â  CALIDAD_BEDROCK:Â  Â { rechazadas: 0, liberadas: 0 },

Â  Â  Â  Â  Â  Â  CALIDAD_DROPS:Â  Â  Â { rechazadas: 0, liberadas: 0 },

Â  Â  Â  Â  };



Â  Â  Â  Â  const tiempos = { MULTIPORT: [], BEDROCK: [], DROPS: [] };



Â  Â  Â  Â  // Procesar historial

Â  Â  Â  Â  Object.values(logs).forEach(log => {

Â  Â  Â  Â  Â  Â  switch (log.accion) {

Â  Â  Â  Â  Â  Â  Â  Â  case 'asignada_en_produccion':

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (contadores[log.grupo]) contadores[log.grupo].asignadas++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  case 'recolectada':

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (contadores[log.grupo]) contadores[log.grupo].recolectadas++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tarimasTotales++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (log.tiempoRecoleccion) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiempos[log.grupo]?.push(log);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiempoTotalRecoleccion += log.tiempoRecoleccion;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  case 'rechazada':

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (contadores[log.grupo]) contadores[log.grupo].rechazadas++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  case 'liberada':

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (contadores[log.grupo]) contadores[log.grupo].liberadas++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });



Â  Â  Â  Â  // ğŸ•’ Calcular tiempo promedio

Â  Â  Â  Â  const tiempoPromedio = tarimasTotales > 0

Â  Â  Â  Â  Â  Â  ? Math.round(tiempoTotalRecoleccion / tarimasTotales)

Â  Â  Â  Â  Â  Â  : 0;



Â  Â  Â  Â  // Actualizar UI principal

Â  Â  Â  Â  document.getElementById('tarimasTotales').textContent = tarimasTotales;

Â  Â  Â  Â  document.getElementById('tiempoPromedio').textContent = `${tiempoPromedio} min`;



Â  Â  Â  Â  const resumenTurnoDiv = document.getElementById('resumenTurno');

Â  Â  Â  Â  if (usuarioSeleccionado === 'LOGÃSTICA' || usuarioSeleccionado === 'SUPERVISOR') {

Â  Â  Â  Â  Â  Â  resumenTurnoDiv.classList.remove('oculto');

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  resumenTurnoDiv.classList.add('oculto');

Â  Â  Â  Â  }



Â  Â  Â  Â  // Actualizar mÃ©tricos en UI

Â  Â  Â  Â  Object.keys(contadores).forEach(grupo => {

Â  Â  Â  Â  Â  Â  const c = contadores[grupo];

Â  Â  Â  Â  Â  Â  const el = document.querySelector(`.grupo[data-grupo="${grupo}"] .tarimas`);

Â  Â  Â  Â  Â  Â  if (el) {

Â  Â  Â  Â  Â  Â  Â  Â  el.textContent =

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `Asig: ${c.asignadas || 0} | Rec: ${c.recolectadas || 0} | Lib: ${c.liberadas || 0} | Rech: ${c.rechazadas || 0}`;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });



Â  Â  Â  Â  // Mostrar tiempos por grupo

Â  Â  Â  Â  Object.keys(tiempos).forEach(grupo => {

Â  Â  Â  Â  Â  Â  const contenedorTiempos = document.querySelector(`.tiempos[data-grupo="${grupo}"]`);

Â  Â  Â  Â  Â  Â  if (!contenedorTiempos) return;



Â  Â  Â  Â  Â  Â  contenedorTiempos.innerHTML = '';

Â  Â  Â  Â  Â  Â  tiempos[grupo].forEach((logEntry, index) => {

Â  Â  Â  Â  Â  Â  Â  Â  const p = document.createElement('p');

Â  Â  Â  Â  Â  Â  Â  Â  const horaInicio = formatoHora(logEntry.horaEncendido);

Â  Â  Â  Â  Â  Â  Â  Â  const horaFin = formatoHora(logEntry.horaApagado);

Â  Â  Â  Â  Â  Â  Â  Â  p.textContent = `Tarima ${index + 1}: ${logEntry.tiempoRecoleccion} min (${horaInicio} - ${horaFin})`;

Â  Â  Â  Â  Â  Â  Â  Â  contenedorTiempos.appendChild(p);

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  contenedorTiempos.scrollTop = contenedorTiempos.scrollHeight;

Â  Â  Â  Â  });

Â  Â  });



Â  Â  // --- Listener: contadores globales en tiempo real ---

Â  Â  contadoresTarimasRef.on('value', (snapshot) => {

Â  Â  Â  Â  const contadores = snapshot.val() || {};

Â  Â  Â  Â  const grupos = ['MULTIPORT', 'BEDROCK', 'DROPS', 'CALIDAD_MULTIPORT', 'CALIDAD_BEDROCK', 'CALIDAD_DROPS'];



Â  Â  Â  Â  grupos.forEach(grupo => {

Â  Â  Â  Â  Â  Â  const g = contadores[grupo] || {};

Â  Â  Â  Â  Â  Â  const asig = g.asignadas || 0;

Â  Â  Â  Â  Â  Â  const rec = g.recolectadas || 0;

Â  Â  Â  Â  Â  Â  const lib = g.liberadas || 0;

Â  Â  Â  Â  Â  Â  const rech = g.rechazadas || 0;



Â  Â  Â  Â  Â  Â  const target = document.getElementById(`metricas_${grupo}`);

Â  Â  Â  Â  Â  Â  if (target) {

Â  Â  Â  Â  Â  Â  Â  Â  target.textContent = `Asig: ${asig} | Rec: ${rec} | Lib: ${lib} | Rech: ${rech}`;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });

Â  Â  });

}



// --- Actualizar contadores de tarimas ---

function actualizarContadoresTarimas(grupo, accion) {

Â  Â  const { fecha, turno } = obtenerTurnoActual();

Â  Â  const contadorRef = db.ref(`contadoresTarimas/${fecha}/${turno}/${grupo}`);



Â  Â  switch (accion) {

Â  Â  Â  Â  case 'asignada_en_produccion':

Â  Â  Â  Â  Â  Â  contadorRef.child('asignadas').transaction(val => (val || 0) + 1);

Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'recolectada':

Â  Â  Â  Â  Â  Â  contadorRef.child('recolectadas').transaction(val => (val || 0) + 1);

Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'rechazada':

Â  Â  Â  Â  Â  Â  contadorRef.child('rechazadas').transaction(val => (val || 0) + 1);

Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'liberada':

Â  Â  Â  Â  Â  Â  contadorRef.child('liberadas').transaction(val => (val || 0) + 1);

Â  Â  Â  Â  Â  Â  break;

Â  Â  }

}





Â Â 

// ================= PERMISOS Y LÃ“GICA =================

function esUsuarioProduccion() {

Â  Â  return CONFIG.PRODUCCION_GRUPOS.includes(usuarioSeleccionado);

}



function puedeControlar(grupo){

Â  Â  if(!usuarioSeleccionado) {

Â  Â  Â  Â  return false;

Â  Â  }

Â Â 

Â  Â  if (usuarioSeleccionado === 'SUPERVISOR') {

Â  Â  Â  Â  return false;

Â  Â  }

Â Â 

Â  Â  if (usuarioSeleccionado === 'LOGÃSTICA') {

Â  Â  Â  Â  return true;

Â  Â  }

Â Â 

Â  Â  const grupoBaseUsuario = usuarioSeleccionado.startsWith('CALIDAD_') ? usuarioSeleccionado.replace('CALIDAD_', '') : usuarioSeleccionado;

Â  Â  const grupoBaseLed = grupo.startsWith('CALIDAD_') ? grupo.replace('CALIDAD_', '') : grupo;



Â  Â  return grupoBaseUsuario === grupoBaseLed;

}

Â Â 

// ===================== TOGGLE LED (CORREGIDO) =====================

// ===================== TOGGLE LED (CANÃ“NICO) =====================

function togglearLED(grupo, idx, linea = 'linea1') {

Â  const ledRefÂ  Â = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);

Â  const ledPathÂ  = `${linea}-${idx + 1}`;

Â  const usuarioActual = usuarioSeleccionado || '';



Â  ledRef.once('value').then(snapshot => {

Â  Â  const estadoActual = snapshot.val() || {};



Â  Â  // ===== CALIDAD sobre LEDs de CALIDAD =====

Â  Â  if (usuarioActual.startsWith('CALIDAD_') && grupo.startsWith('CALIDAD_')) {

Â  Â  Â  if (!estadoActual.tarimaId) {

Â  Â  Â  Â  alert('Este LED no tiene ninguna tarima asignada.');

Â  Â  Â  Â  return;

Â  Â  Â  }

Â  Â  Â  const color = estadoActual.color || 'naranja';

Â  Â  Â  if (color === 'verde') {

Â  Â  Â  Â  alert('Este LED ya estÃ¡ liberado y no puede ser modificado por Calidad.');

Â  Â  Â  Â  return;

Â  Â  Â  }

Â  Â  Â  abrirModalCalidad(grupo, idx, linea, estadoActual.tarimaId);

Â  Â  Â  return;

Â  Â  }



Â  Â  // ===== PRODUCCIÃ“N recibiendo desde CALIDAD (clic en LED de CALIDAD) =====

if (

Â  (usuarioActual === 'MULTIPORT' || usuarioActual === 'DROPS' || usuarioActual === 'BEDROCK') &&

Â  grupo.startsWith('CALIDAD_')

) {

Â  if (estadoActual.color === 'verde' && estadoActual.tarimaId) {

Â  Â  const ok = confirm(`Â¿Recibir tarima ${estadoActual.tarimaId} de Calidad?`);

Â  Â  if (!ok) return;



Â  Â  const tarimaId = estadoActual.tarimaId;



Â  Â  // Guardar en recibidas de ProducciÃ³n

Â  Â  db.ref(`tarimasRecibidas/${usuarioActual}/${tarimaId}`).set({

Â  Â  Â  tarimaId,

Â  Â  Â  recibidoEn: nowISO(),

Â  Â  Â  ledOrigen: `${linea}-${idx+1}`,

Â  Â  Â  recibidaDe: grupo

Â  Â  });



Â  Â  // Limpiar el LED de Calidad para liberarlo

Â  Â  const ledRefCalidad = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);

Â  Â  ledRefCalidad.set(null);



Â  Â  // Workflow + historial

Â  Â  pushWorkflow(tarimaId, 'recibida_por_produccion', { grupoOrigen: grupo, grupoDestino: usuarioActual });

Â  Â  alert(`âœ… Tarima ${tarimaId} recibida por ${usuarioActual}`);

Â  } else {

Â  Â  alert('Solo puedes recibir tarimas liberadas (verdes).');

Â  }

Â  return;

}

Â  Â  // ===== PRODUCCIÃ“N sobre sus propios LEDs (asignar) =====

Â  Â  if (

Â  Â  Â  (usuarioActual === 'MULTIPORT' || usuarioActual === 'DROPS' || usuarioActual === 'BEDROCK') &&

Â  Â  Â  grupo === usuarioActual

Â  Â  ) {

Â  Â  Â  // Asegura que el LED estÃ© vacÃ­o

Â  Â  Â  if (!estadoActual.encendido && !estadoActual.tarimaId) {

Â  Â  Â  Â  // ğŸ”§ Seteamos el LED seleccionado ANTES de abrir el modal

Â  Â  Â  Â  ledSeleccionado = { grupo, idx, linea };

Â  Â  Â  Â  // Abre el modal de producciÃ³n

Â  Â  Â  Â  mostrarModalProduccion(grupo, linea);

Â  Â  Â  } else {

Â  Â  Â  Â  alert('Este LED ya tiene una tarima asignada.');

Â  Â  Â  }

Â  Â  Â  return;

Â  Â  }



Â  Â  // ===== LOGÃSTICA apaga LEDs con tarima asignada =====

Â  Â  if (usuarioActual === 'LOGÃSTICA') {

Â  Â  Â  if (estadoActual.encendido && estadoActual.tarimaId) {

Â  Â  Â  Â  const ok = confirm(`Â¿Recolectar tarima ${estadoActual.tarimaId}?`);

Â  Â  Â  Â  if (!ok) return;



Â  Â  Â  Â  // Limpiar LED

Â  Â  Â  Â  ledRef.set(null);



Â  Â  Â  Â  // Workflow + historial + contador logÃ­stica

Â  Â  Â  Â  const { fecha, turno } = obtenerTurnoActual();

Â  Â  Â  Â  const tarimaId = estadoActual.tarimaId;



Â  Â  Â  Â  pushWorkflow(tarimaId, 'recolectada', { grupo });

Â  Â  Â  Â  db.ref('historial').push({

Â  Â  Â  Â  Â  usuario:Â  Â usuarioActual,

Â  Â  Â  Â  Â  grupo:Â  Â  Â grupo,

Â  Â  Â  Â  Â  led:Â  Â  Â  Â ledPath,

Â  Â  Â  Â  Â  accion:Â  Â  'recolectada',

Â  Â  Â  Â  Â  tarimaId:Â  tarimaId,

Â  Â  Â  Â  Â  timestamp: nowISO()

Â  Â  Â  Â  });

Â  Â  Â  Â  db.ref(`contadoresTarimas/${fecha}/${turno}/LOGÃSTICA/recolectadas`)

Â  Â  Â  Â  Â  .transaction(v => (v || 0) + 1);

Â  Â  Â  } else {

Â  Â  Â  Â  alert('LOGÃSTICA solo puede apagar LEDs con tarima asignada.');

Â  Â  Â  }

Â  Â  Â  return;

Â  Â  }



Â  Â  // ===== Default =====

Â  Â  alert('No tienes permiso para controlar estos LEDs.');

Â  });

}

// =================== FIN TOGGLE LED (CANÃ“NICO) ===================

// =================== FIN TOGGLE LED (CORREGIDO) ===================

Â Â 

function actualizarEstadoLED(nuevoColor) {

Â  if (!ledSeleccionado.grupo) return;



Â  const { grupo, idx, linea } = ledSeleccionado;

Â  const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);



Â  ledRef.once('value').then(snap => {

Â  Â  const estado = snap.val() || {};

Â  Â  const tarimaId = estado.tarimaId || "N/D";



Â  Â  // Cambiar color en el LED (visual)

Â  Â  ledRef.update({

Â  Â  Â  color: nuevoColor,

Â  Â  Â  timestamp: nowISO()

Â  Â  });



Â  Â  // Historial simple (visual)

Â  Â  db.ref('historial').push({

Â  Â  Â  usuario: usuarioSeleccionado,

Â  Â  Â  grupo,

Â  Â  Â  led: `${linea}-${idx+1}`,

Â  Â  Â  accion: nuevoColor,

Â  Â  Â  tarimaId,

Â  Â  Â  timestamp: nowISO()

Â  Â  });



Â  Â  // â—ï¸No movemos contadores de ProducciÃ³n aquÃ­.

Â  Â  cerrarModalCalidad && cerrarModalCalidad();

Â  });

}



Â  let ledSeleccionado = { grupo: null, idx: null, linea: null, tarimaId: null };



function abrirModalCalidad(grupo, idx, linea) {

Â  Â  ledSeleccionado = { grupo, idx, linea };



Â  Â  const modal = document.getElementById('modalCalidad');

Â  Â  modal.classList.add('visible');



Â  Â  modal.querySelectorAll('.opcion-btn').forEach(btn => {

Â  Â  Â  Â  btn.onclick = () => {

Â  Â  Â  Â  Â  Â  const color = btn.dataset.color;

Â  Â  Â  Â  Â  Â  if (color === 'rojo') {

Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.remove('visible');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalRechazo').classList.add('visible');

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  actualizarEstadoLED(color);

Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.remove('visible'); // ğŸ”¥ cerrar inmediatamente

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  };

Â  Â  });



Â  Â  modal.querySelector('.cerrar-btn').onclick = () => {

Â  Â  Â  Â  modal.classList.remove('visible');

Â  Â  };

}





function cerrarModalCalidad() {

Â  Â  document.getElementById('modalCalidad').classList.remove('visible');

Â  Â  document.getElementById('modalRechazo').classList.remove('visible');

}

Â Â 

// ================= LÃ“GICA DE CALIDAD MODAL =================

function mostrarOpcionesCalidad(grupo, idx, linea = 'linea1') {

Â  Â  const modal = document.getElementById('modalOpcionesCalidad');

Â  Â  const select = modal.querySelector('#selectLedCalidad');

Â  Â  select.innerHTML = ''; // limpia opciones anteriores



Â  Â  // ==============================

Â  Â  // Generamos lista de LEDs (ej. linea1-1, linea1-2, etc.)

Â  Â  // ==============================

Â  Â  const totalLeds = CONFIG.LEDS_POR_GRUPO[grupo] || 5;

Â  Â  for (let i = 0; i < totalLeds; i++) {

Â  Â  Â  Â  const opt = document.createElement('option');

Â  Â  Â  Â  opt.value = i; // guardamos Ã­ndice real

Â  Â  Â  Â  opt.textContent = `${linea}-${i+1}`; // nombre visible

Â  Â  Â  Â  if (i === idx) opt.selected = true;

Â  Â  Â  Â  select.appendChild(opt);

Â  Â  }



Â  Â  // Guardamos contexto en dataset

Â  Â  select.dataset.grupo = grupo;

Â  Â  select.dataset.linea = linea;



Â  Â  modal.style.display = 'block';

}

Â  document.getElementById('btnAsignarTarimaCalidad').addEventListener('click', () => {

Â  Â  const select = document.getElementById('selectLedCalidad');

Â  Â  const grupo = select.dataset.grupo;

Â  Â  const linea = select.dataset.linea;

Â  Â  const idx = parseInt(select.value);



Â  Â  // Guardamos tarima en el LED correspondiente

Â  Â  const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);

Â  Â  ledRef.set({

Â  Â  Â  Â  color: 'naranja', // inicia como en revisiÃ³n

Â  Â  Â  Â  tarimaId: tarimaEscaneadaActual || null,

Â  Â  Â  Â  usuario: usuarioSeleccionado,

Â  Â  Â  Â  timestamp: new Date().toISOString()

Â  Â  });



Â  Â  alert(`âœ… Tarima ${tarimaEscaneadaActual} asignada a ${linea}-${idx+1}`);

Â  Â  cerrarModalCalidad();

});



function cerrarModalCalidad() {

Â  Â  document.getElementById('modalOpcionesCalidad').style.display = 'none';

}

// ========================

// PRODUCCIÃ“N: Modal de AsignaciÃ³n

// --- MODAL PRODUCCION: asignar tarima a LED tocado ---

function mostrarModalProduccion(grupo, linea = 'linea1') {

Â  const modal = document.getElementById('modalAsignarTarimaProduccion');

Â  const selectTarima = modal.querySelector('#selectTarimaProduccion');

Â  const selectLed = modal.querySelector('#selectLedProduccion');



Â  const recibidasRef = db.ref(`tarimasRecibidas/${grupo}`);

Â  recibidasRef.once('value', snapshot => {

Â  Â  const recibidas = snapshot.val() || {};

Â  Â  selectTarima.innerHTML = '';



Â  Â  const keys = Object.keys(recibidas);

Â  Â  if (keys.length === 0) {

Â  Â  Â  alert("âš ï¸ No hay tarimas recibidas de Calidad para asignar.");

Â  Â  Â  return;

Â  Â  }



Â  Â  // Soporta tanto claves = tarimaId como claves aleatorias (por backward-compat)

Â  Â  keys.forEach(k => {

Â  Â  Â  const t = recibidas[k];

Â  Â  Â  const opt = document.createElement('option');

Â  Â  Â  opt.value = k; // clave que usaremos para leer

Â  Â  Â  opt.textContent = `${t.tarimaId || k} (de ${t.ledOrigen || 'N/D'})`;

Â  Â  Â  selectTarima.appendChild(opt);

Â  Â  });



Â  Â  // SÃ³lo el LED tocado

Â  Â  selectLed.innerHTML = '';

Â  Â  const opt = document.createElement('option');

Â  Â  opt.value = ledSeleccionado.idx;

Â  Â  opt.textContent = `${linea}-${ledSeleccionado.idx + 1}`;

Â  Â  selectLed.appendChild(opt);



Â  Â  modal.style.display = 'flex';

Â  });

}



Â Â 

document.getElementById('btnAsignarProduccion').addEventListener('click', () => {

Â  Â  const { grupo, idx, linea } = ledSeleccionado;

Â  Â  asignarTarimaProduccion(grupo, idx, linea);

});



function cerrarModalProduccion() {

Â  Â  document.getElementById('modalAsignarTarimaProduccion').style.display = 'none';

}

Â Â 

function aplicarEstadoCalidad(nuevoColor) {

Â  Â  const { grupo, idx, linea } = ledActivoParaFormulario;

Â  Â  const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);



Â  Â  if (nuevoColor === 'verde') {

Â  Â  Â  Â  const contadorRef = contadoresCalidadRef.child(grupo);

Â  Â  Â  Â  contadorRef.child('liberadas').transaction(currentCount => (currentCount || 0) + 1);

Â  Â  Â  Â  ledRef.update({

Â  Â  Â  Â  Â  Â  color: nuevoColor,

Â  Â  Â  Â  Â  Â  timestamp: new Date().toISOString(),

Â  Â  Â  Â  Â  Â  usuario: usuarioSeleccionado,

Â  Â  Â  Â  Â  Â  disabled: true // Nuevo estado para deshabilitar

Â  Â  Â  Â  });

Â  Â  } else {

Â  Â  Â  Â  ledRef.update({

Â  Â  Â  Â  Â  Â  color: nuevoColor,

Â  Â  Â  Â  Â  Â  timestamp: new Date().toISOString(),

Â  Â  Â  Â  Â  Â  usuario: usuarioSeleccionado,

Â  Â  Â  Â  Â  Â  disabled: false // Asegurarse de que no estÃ© deshabilitado en otros estados

Â  Â  Â  Â  });

Â  Â  Â  Â  if (nuevoColor === 'rojo') {

Â  Â  Â  Â  Â  Â  const contadorRef = contadoresCalidadRef.child(grupo);

Â  Â  Â  Â  Â  Â  contadorRef.child('rechazadas').transaction(currentCount => (currentCount || 0) + 1);

Â  Â  Â  Â  }

Â  Â  }

}





function mostrarFormularioRechazo() {

Â  Â  document.getElementById('modalCalidad').classList.remove('visible');

Â  Â  document.getElementById('modalRechazo').classList.add('visible');

}



// ========================

// CALIDAD: Rechazar Tarima

// ========================

function guardarRechazo(tarimaId, grupoCalidad) {

Â  const { fecha, turno } = obtenerTurnoActual();

Â  const tarimaRef = db.ref(`tarimas/${tarimaId}`);



Â  tarimaRef.once('value').then(snap => {

Â  Â  if (!snap.exists()) {

Â  Â  Â  alert(`âŒ Tarima ${tarimaId} no encontrada.`);

Â  Â  Â  return;

Â  Â  }



Â  Â  // 1) Estado global

Â  Â  tarimaRef.update({

Â  Â  Â  estado: 'rechazada',

Â  Â  Â  rechazadaPor: usuarioSeleccionado,

Â  Â  Â  timestampRechazada: nowISO()

Â  Â  });



Â  Â  // 2) Workflow + historial + contador (Calidad)

Â  Â  pushWorkflow(tarimaId, 'rechazada', { grupoCalidad });

Â  Â  db.ref(`historialLogs/${fecha}/${turno}`).push({

Â  Â  Â  usuario: usuarioSeleccionado,

Â  Â  Â  grupo: grupoCalidad,

Â  Â  Â  accion: 'rechazada',

Â  Â  Â  tarimaId,

Â  Â  Â  timestamp: nowISO()

Â  Â  });

Â  Â  db.ref(`contadoresTarimas/${fecha}/${turno}/${grupoCalidad}/rechazadas`)

Â  Â  Â  .transaction(v => (v || 0) + 1);



Â  Â  // 3) Visual: LED en rojo

Â  Â  if (ledSeleccionado.grupo === grupoCalidad) {

Â  Â  Â  const { idx, linea } = ledSeleccionado;

Â  Â  Â  const ledRef = db.ref(`estadoLEDs/${grupoCalidad}/${linea}/${idx}`);

Â  Â  Â  ledRef.update({

Â  Â  Â  Â  color: 'rojo',

Â  Â  Â  Â  tarimaId: tarimaId,

Â  Â  Â  Â  timestamp: nowISO()

Â  Â  Â  });

Â  Â  }



Â  Â  alert(`âŒ Tarima ${tarimaId} rechazada.`);

Â  Â  cerrarModalCalidad && cerrarModalCalidad();

Â  });

}



function cerrarModalRechazo() {

Â  Â  document.getElementById('modalRechazo').classList.remove('visible');

}



Â Â 

// ================= NAVEGACIÃ“N Y ARRANQUE =================

function activarPantalla(id){

Â  Â  document.querySelectorAll('.pantalla').forEach(p => {

Â  Â  Â  Â  p.style.display = 'none';

Â  Â  Â  Â  p.classList.remove('activa');

Â  Â  });

Â  Â  const pantalla = document.getElementById(id);

Â  Â  pantalla.style.display = 'flex';

Â  Â  pantalla.classList.add('activa');

}



function volverAPantalla1(){

Â  Â  usuarioSeleccionado = null;

Â  Â  db.ref('estadoLEDs').off();Â 

Â  Â  if (historialRef) historialRef.off();

Â  Â  if (contadoresCalidadRef) contadoresCalidadRef.off();

Â  Â  if (rechazosDetalladosRef) rechazosDetalladosRef.off();

Â  Â  clearInterval(dashboardUpdateInterval);

Â  Â  activarPantalla('pantalla1');

}



function seleccionarUsuario(usuario) {

Â  Â  if (!CONFIG.USUARIOS.includes(usuario)) {

Â  Â  Â  Â  return;

Â  Â  }



Â  Â  if (usuario === 'SUPERVISOR') {

Â  Â  Â  Â  const password = prompt('Introduce la contraseÃ±a para SUPERVISOR:');

Â  Â  Â  Â  if (password === CONFIG.PASSWORDS['SUPERVISOR']) {

Â  Â  Â  Â  Â  Â  usuarioSeleccionado = usuario;

Â  Â  Â  Â  Â  Â  document.getElementById('tituloFijo').textContent = 'SUPERVISOR';

Â  Â  Â  Â  Â  Â  activarPantalla('pantalla2');

Â  Â  Â  Â  Â  Â  inyectaLEDs();

Â  Â  Â  Â  Â  Â  pintarEstado();

Â  Â  Â  Â  Â  Â  iniciarListenersFirebase();

Â  Â  Â  Â  Â  Â  alert(`Â¡Bienvenido, ${usuario}!`);

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  alert('ContraseÃ±a incorrecta. IntÃ©ntalo de nuevo.');

Â  Â  Â  Â  }

Â  Â  } else if (usuario === 'CALIDAD') {

Â  Â  Â  Â  const password = prompt('Introduce la contraseÃ±a para CALIDAD:');

Â  Â  Â  Â  let subusuario = null;



Â  Â  Â  Â  if (password === CONFIG.PASSWORDS['CALIDAD_MULTIPORT']) {

Â  Â  Â  Â  Â  Â  subusuario = 'CALIDAD_MULTIPORT';

Â  Â  Â  Â  } else if (password === CONFIG.PASSWORDS['CALIDAD_DROPS']) {

Â  Â  Â  Â  Â  Â  subusuario = 'CALIDAD_DROPS';

Â  Â  Â  Â  } else if (password === CONFIG.PASSWORDS['CALIDAD_BEDROCK']) {

Â  Â  Â  Â  Â  Â  subusuario = 'CALIDAD_BEDROCK';

Â  Â  Â  Â  }



Â  Â  Â  Â  if (subusuario) {

Â  Â  Â  Â  Â  Â  usuarioSeleccionado = subusuario;

Â  Â  Â  Â  Â  Â  document.getElementById('tituloFijo').textContent = `CALIDAD - ${subusuario.split('_')[1]}`;

Â  Â  Â  Â  Â  Â  activarPantalla('pantalla2');

Â  Â  Â  Â  Â  Â  inyectaLEDs();

Â  Â  Â  Â  Â  Â  pintarEstado();

Â  Â  Â  Â  Â  Â  iniciarListenersFirebase();

Â  Â  Â  Â  Â  Â  alert(`Â¡Bienvenido, ${subusuario.replace('_', ' ')}!`);

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  alert('ContraseÃ±a incorrecta. IntÃ©ntalo de nuevo.');

Â  Â  Â  Â  }

Â  Â  } else {

Â  Â  Â  Â  const password = prompt(`Introduce la contraseÃ±a para ${usuario}:`);

Â  Â  Â  Â  if (password === CONFIG.PASSWORDS[usuario]) {

Â  Â  Â  Â  Â  Â  usuarioSeleccionado = usuario;

Â  Â  Â  Â  Â  Â  if (usuario === 'LOGÃSTICA') {

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tituloFijo').textContent = 'LOGÃSTICA';

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tituloFijo').textContent = usuario;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  activarPantalla('pantalla2');

Â  Â  Â  Â  Â  Â  inyectaLEDs();

Â  Â  Â  Â  Â  Â  pintarEstado();

Â  Â  Â  Â  Â  Â  iniciarListenersFirebase();



Â  Â  Â  Â  Â  Â  // âœ… ProducciÃ³n carga tarimas recibidas

Â  Â  Â  Â  Â  Â  if (esUsuarioProduccion()) {

Â  Â  Â  Â  Â  Â  Â  Â  renderTarimasRecibidas(usuarioSeleccionado);

Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  alert(`Â¡Bienvenido, ${usuario}!`);

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  alert('ContraseÃ±a incorrecta. IntÃ©ntalo de nuevo.');

Â  Â  Â  Â  }

Â  Â  }

}

Â Â 

function seleccionarReporte() {

Â  Â  const password = prompt('Introduce la contraseÃ±a para REPORTES:');

Â  Â  if (password === CONFIG.PASSWORDS['REPORTES']) {

Â  Â  Â  Â  activarPantalla('pantalla3');

Â  Â  Â  Â  document.getElementById('tituloReportes').textContent = 'REPORTES';

Â  Â  Â  Â  document.getElementById('selectoresReportes').style.display = 'flex';

Â  Â  Â  Â  document.getElementById('contenedorReporte').innerHTML = '<h2>Selecciona un reporte</h2>';

Â  Â  } else {

Â  Â  Â  Â  alert('ContraseÃ±a incorrecta. Acceso denegado.');

Â  Â  }

}



// --- !!AQUI EMPIEZA BLOQUE DE DASHBOARD!! ---Â  Â Â 

Â  Â Â 

function seleccionarDashboard() {

Â  Â  const password = prompt('Introduce la contraseÃ±a para DASHBOARD:');

Â  Â  if (password === CONFIG.PASSWORDS['DASHBOARD']) {

Â  Â  Â  Â  activarPantalla('pantalla4');

Â  Â  Â  Â  iniciarDashboard();

Â  Â  } else {

Â  Â  Â  Â  alert('ContraseÃ±a incorrecta. Acceso denegado.');

Â  Â  }

}



function limpiarDashboardListeners() {

Â  Â  dashboardListeners.forEach(listener => listener.off());

Â  Â  dashboardListeners = [];

}



function iniciarDashboard() {

Â  Â  limpiarDashboardListeners();

Â  Â  const { fecha, turno } = obtenerTurnoActual();

Â  Â  document.getElementById('fechaDashboard').value = fecha;

Â  Â  document.getElementById('turnoDashboardSelect').value = 'todos';

Â  Â Â 

Â  Â  setupDashboardListeners(fecha, turno);

Â  Â Â 

Â  Â  // Listeners para los filtros de fecha y turno

Â  Â  document.getElementById('fechaDashboard').addEventListener('change', () => {

Â  Â  Â  Â  setupDashboardListeners(document.getElementById('fechaDashboard').value, document.getElementById('turnoDashboardSelect').value);

Â  Â  });



Â  Â  document.getElementById('turnoDashboardSelect').addEventListener('change', () => {

Â  Â  Â  Â  setupDashboardListeners(document.getElementById('fechaDashboard').value, document.getElementById('turnoDashboardSelect').value);

Â  Â  });

}



function setupDashboardListeners(fecha, turno) {

Â  Â  limpiarDashboardListeners();

Â  Â Â 

Â  Â  const historialRefDash = db.ref(`historialLogs/${fecha}`);

Â  Â  const calidadRefDash = db.ref(`contadoresCalidad/${fecha}`);

Â  Â  const ledsRefDash = db.ref('estadoLEDs');



Â  Â  const historialListener = historialRefDash.on('value', snapshot => {

Â  Â  Â  Â  const logsPorTurno = snapshot.val() || {};

Â  Â  Â  Â  let logsFiltrados = {};

Â  Â  Â  Â  if (turno === 'todos') {

Â  Â  Â  Â  Â  Â  Object.values(logsPorTurno).forEach(logs => {

Â  Â  Â  Â  Â  Â  Â  Â  logsFiltrados = { ...logsFiltrados, ...logs };

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  logsFiltrados = logsPorTurno[turno] || {};

Â  Â  Â  Â  }

Â  Â  Â  Â  actualizarDashboard(logsFiltrados, 'historial', null, null);

Â  Â  });

Â  Â  dashboardListeners.push({ off: () => historialRefDash.off('value', historialListener) });



Â  Â  const calidadListener = calidadRefDash.on('value', snapshot => {

Â  Â  Â  Â  const contadoresPorTurno = snapshot.val() || {};

Â  Â  Â  Â  let contadoresFiltrados = {};

Â  Â  Â  Â  if (turno === 'todos') {

Â  Â  Â  Â  Â  Â  for (const t in contadoresPorTurno) {

Â  Â  Â  Â  Â  Â  Â  Â  for (const g in contadoresPorTurno[t]) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contadoresFiltrados[g] = contadoresFiltrados[g] || { liberadas: 0, rechazadas: 0 };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contadoresFiltrados[g].liberadas += contadoresPorTurno[t][g].liberadas || 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contadoresFiltrados[g].rechazadas += contadoresPorTurno[t][g].rechazadas || 0;

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  contadoresFiltrados = contadoresPorTurno[turno] || {};

Â  Â  Â  Â  }

Â  Â  Â  Â  actualizarDashboard(null, 'calidad', contadoresFiltrados, null);

Â  Â  });

Â  Â  dashboardListeners.push({ off: () => calidadRefDash.off('value', calidadListener) });

Â  Â Â 

Â  Â  const ledsListener = ledsRefDash.on('value', snapshot => {

Â  Â  Â  Â  const leds = snapshot.val() || {};

Â  Â  Â  Â  actualizarDashboard(null, 'leds', null, leds);

Â  Â  });

Â  Â  dashboardListeners.push({ off: () => ledsRefDash.off('value', ledsListener) });

}





function actualizarDashboard(historialLogs, tipo, contadoresCalidad, estadoLEDs, filtroArea = 'TODAS') {

Â  Â  if (tipo === 'historial') {

Â  Â  Â  Â  const produccionPorArea = { MULTIPORT: 0, DROPS: 0, BEDROCK: 0 };

Â  Â  Â  Â  const tarimasPorHora = {};

Â  Â  Â  Â  let tarimasRecolectadas = 0;

Â  Â  Â  Â  let tiempoTotalRecoleccion = 0;

Â  Â  Â  Â Â 

Â  Â  Â  Â  for (const logKey in historialLogs) {

Â  Â  Â  Â  Â  Â  const log = historialLogs[logKey];

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  // Nuevo filtro de Ã¡rea

Â  Â  Â  Â  Â  Â  if (filtroArea === 'TODAS' || log.grupo === filtroArea) {

Â  Â  Â  Â  Â  Â  Â  Â  if (log.accion === 'encendido' && produccionPorArea.hasOwnProperty(log.grupo)) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produccionPorArea[log.grupo]++;

Â  Â  Â  Â  Â  Â  Â  Â  } else if (log.accion === 'apagado' && log.tiempoRecoleccion && ['MULTIPORT', 'BEDROCK', 'DROPS'].includes(log.grupo)) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tarimasRecolectadas++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiempoTotalRecoleccion += log.tiempoRecoleccion;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const horaApagado = new Date(log.horaApagado);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const horaRedondeada = horaApagado.getHours();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tarimasPorHora[horaRedondeada] = (tarimasPorHora[horaRedondeada] || 0) + 1;

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  const tiempoPromedio = tarimasRecolectadas > 0 ? (tiempoTotalRecoleccion / tarimasRecolectadas).toFixed(1) : 0;

Â  Â  Â  Â Â 

Â  Â  Â  Â  document.getElementById('dashTarimasConfirmadas').textContent = Object.values(produccionPorArea).reduce((a, b) => a + b, 0);

Â  Â  Â  Â  document.getElementById('dashTarimasRecolectadas').textContent = tarimasRecolectadas;

Â  Â  Â  Â  document.getElementById('dashTiempoPromedio').textContent = `${tiempoPromedio} min`;

Â  Â  Â  Â Â 

Â  Â  Â  Â  const kpiTiempoPromedio = document.getElementById('kpiTiempoPromedio');

Â  Â  Â  Â  if (tiempoPromedio > 10) {

Â  Â  Â  Â  Â  Â  kpiTiempoPromedio.classList.add('alerta');

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  kpiTiempoPromedio.classList.remove('alerta');

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  generarGraficoProduccionDash(produccionPorArea);

Â  Â  Â  Â  generarGraficoLogisticaDash(tarimasPorHora);

Â  Â  }

Â  Â Â 

Â  Â  // El resto de la funciÃ³n para 'calidad' y 'leds' se mantiene igual y funciona de manera independiente

Â  Â  if (tipo === 'calidad') {

Â  Â  Â  Â  let liberadas = 0;

Â  Â  Â  Â  let rechazadas = 0;

Â  Â  Â  Â  for (const grupo in contadoresCalidad) {

Â  Â  Â  Â  Â  Â  liberadas += contadoresCalidad[grupo].liberadas || 0;

Â  Â  Â  Â  Â  Â  rechazadas += contadoresCalidad[grupo].rechazadas || 0;

Â  Â  Â  Â  }

Â  Â  Â  Â  const totalCalidad = liberadas + rechazadas;

Â  Â  Â  Â  const tasaRechazo = totalCalidad > 0 ? ((rechazadas / totalCalidad) * 100).toFixed(1) : 0;

Â  Â  Â  Â Â 

Â  Â  Â  Â  document.getElementById('dashTasaRechazo').textContent = `${tasaRechazo}%`;



Â  Â  Â  Â  const kpiTasaRechazo = document.getElementById('kpiTasaRechazo');

Â  Â  Â  Â  if (tasaRechazo > 5) {

Â  Â  Â  Â  Â  Â  kpiTasaRechazo.classList.add('alerta');

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  kpiTasaRechazo.classList.remove('alerta');

Â  Â  Â  Â  }

Â  Â  Â  Â  generarGraficoCalidadDash({ liberadas, rechazadas });

Â  Â  }



Â  Â  if (tipo === 'leds') {

Â  Â  Â  Â  const pendientesPorArea = {};

Â  Â  Â  Â Â 

Â  Â  Â  Â  CONFIG.PRODUCCION_GRUPOS.forEach(grupo => {

Â  Â  Â  Â  Â  Â  pendientesPorArea[grupo] = 0;

Â  Â  Â  Â  Â  Â  if (estadoLEDs.hasOwnProperty(grupo)) {

Â  Â  Â  Â  Â  Â  Â  Â  for (const linea in estadoLEDs[grupo]) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const led in estadoLEDs[grupo][linea]) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (estadoLEDs[grupo][linea][led].encendido) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pendientesPorArea[grupo]++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });

Â  Â  Â  Â Â 

Â  Â  Â  Â  const tablaPendientesBody = document.querySelector('#tablaPendientes tbody');

Â  Â  Â  Â  tablaPendientesBody.innerHTML = '';

Â  Â  Â  Â  for (const area in pendientesPorArea) {

Â  Â  Â  Â  Â  Â  const tr = document.createElement('tr');

Â  Â  Â  Â  Â  Â  tr.innerHTML = `<td>${area}</td><td>${pendientesPorArea[area]}</td>`;

Â  Â  Â  Â  Â  Â  tablaPendientesBody.appendChild(tr);

Â  Â  Â  Â  }

Â  Â  }

}

function generarGraficoProduccionDash(datos) {

Â  Â  if (graficosDashboard.produccion) {

Â  Â  Â  Â  graficosDashboard.produccion.destroy();

Â  Â  }

Â  Â  const ctx = document.getElementById('graficoProduccionDash').getContext('2d');

Â  Â  const labels = Object.keys(datos);

Â  Â  const data = Object.values(datos);

Â  Â  graficosDashboard.produccion = new Chart(ctx, {

Â  Â  Â  Â  type: 'bar',

Â  Â  Â  Â  data: {

Â  Â  Â  Â  Â  Â  labels: labels,

Â  Â  Â  Â  Â  Â  datasets: [{

Â  Â  Â  Â  Â  Â  Â  Â  label: 'Tarimas Confirmadas',

Â  Â  Â  Â  Â  Â  Â  Â  data: data,

Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: ['#4BC0C0', '#36A2EB', '#FFCE56'],

Â  Â  Â  Â  Â  Â  Â  Â  borderColor: ['#4BC0C0', '#36A2EB', '#FFCE56'],

Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1

Â  Â  Â  Â  Â  Â  }]

Â  Â  Â  Â  },

Â  Â  Â  Â  options: {

Â  Â  Â  Â  Â  Â  responsive: true, maintainAspectRatio: false,

Â  Â  Â  Â  Â  Â  scales: {

Â  Â  Â  Â  Â  Â  Â  Â  y: { beginAtZero: true, title: { display: true, text: 'Tarimas' } }

Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  plugins: {

Â  Â  Â  Â  Â  Â  Â  Â  legend: { display: false },

Â  Â  Â  Â  Â  Â  Â  Â  title: { display: false }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  });

}



function generarGraficoCalidadDash(datos) {

Â  Â  if (graficosDashboard.calidad) {

Â  Â  Â  Â  graficosDashboard.calidad.destroy();

Â  Â  }

Â  Â  const ctx = document.getElementById('graficoCalidadDash').getContext('2d');

Â  Â  const labels = ['Liberadas', 'Rechazadas'];

Â  Â  const data = [datos.liberadas, datos.rechazadas];

Â  Â  graficosDashboard.calidad = new Chart(ctx, {

Â  Â  Â  Â  type: 'pie',

Â  Â  Â  Â  data: {

Â  Â  Â  Â  Â  Â  labels: labels,

Â  Â  Â  Â  Â  Â  datasets: [{

Â  Â  Â  Â  Â  Â  Â  Â  data: data,

Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: ['#4caf50', '#f44336']

Â  Â  Â  Â  Â  Â  }]

Â  Â  Â  Â  },

Â  Â  Â  Â  options: {

Â  Â  Â  Â  Â  Â  responsive: true, maintainAspectRatio: false,

Â  Â  Â  Â  Â  Â  plugins: {

Â  Â  Â  Â  Â  Â  Â  Â  legend: { position: 'top' },

Â  Â  Â  Â  Â  Â  Â  Â  title: { display: false }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  });

}



function generarGraficoLogisticaDash(tarimasPorHora) {

Â  Â  if (graficosDashboard.logistica) {

Â  Â  Â  Â  graficosDashboard.logistica.destroy();

Â  Â  }

Â  Â  const ctx = document.getElementById('graficoLogisticaDash').getContext('2d');

Â  Â Â 

Â  Â  const horasOrdenadas = Object.keys(tarimasPorHora).sort((a, b) => a - b);

Â  Â  const labels = horasOrdenadas.map(hora => `${hora}:00 - ${parseInt(hora) + 1}:00`);

Â  Â  const data = horasOrdenadas.map(hora => tarimasPorHora[hora] || 0);



Â  Â  graficosDashboard.logistica = new Chart(ctx, {

Â  Â  Â  Â  type: 'bar', // Cambiado a grÃ¡fico de barras para mejor visualizaciÃ³n de conteos

Â  Â  Â  Â  data: {

Â  Â  Â  Â  Â  Â  labels: labels,Â 

Â  Â  Â  Â  Â  Â  datasets: [{

Â  Â  Â  Â  Â  Â  Â  Â  label: 'Tarimas Recolectadas por Hora',

Â  Â  Â  Â  Â  Â  Â  Â  data: data,

Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: '#36A2EB',

Â  Â  Â  Â  Â  Â  Â  Â  borderColor: '#36A2EB',

Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1

Â  Â  Â  Â  Â  Â  }]

Â  Â  Â  Â  },

Â  Â  Â  Â  options: {

Â  Â  Â  Â  Â  Â  responsive: true,

Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,

Â  Â  Â  Â  Â  Â  scales: {

Â  Â  Â  Â  Â  Â  Â  Â  y: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beginAtZero: true,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'Tarimas Recolectadas' // Nueva etiqueta del eje Y

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stepSize: 1 // Asegura que las etiquetas sean nÃºmeros enteros

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  Â  Â  x: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'Hora del DÃ­a'

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  plugins: {

Â  Â  Â  Â  Â  Â  Â  Â  legend: { display: false }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  });

}



// --- !!AQUI EMPIEZAN FUNCIONES DE REPORTE!! ---

Â  Â Â 

Â  Â Â 

Â  Â  function mostrarReporte(tipo) {

Â  Â  reporteActual = tipo;

Â  Â  document.getElementById('selectoresReportes').style.display = 'none';

Â  Â  const contenedor = document.getElementById('contenedorReporte');

Â  Â  const { fecha: fechaActual, turno: turnoActual } = obtenerTurnoActual();



Â  Â  let areaFiltroHtml = '';

Â  Â  const areas = ['TODAS', 'MULTIPORT', 'DROPS', 'BEDROCK', 'CALIDAD_MULTIPORT', 'CALIDAD_DROPS', 'CALIDAD_BEDROCK'];

Â  Â  areaFiltroHtml = `

Â  Â  Â  Â  <label for="areaFiltro">Ãrea:</label>

Â  Â  Â  Â  <select id="areaFiltro">

Â  Â  Â  Â  Â  Â  ${areas.map(area => `<option value="${area}">${area.replace('CALIDAD_', 'Calidad ')}</option>`).join('')}

Â  Â  Â  Â  </select>

Â  Â  `;



Â  Â  let empleadoFiltroHtml = '';

Â  Â  if (tipo === 'calidad') {

Â  Â  Â  Â  empleadoFiltroHtml = `

Â  Â  Â  Â  Â  Â  <label for="empleadoFiltro">Empleado:</label>

Â  Â  Â  Â  Â  Â  <input type="text" id="empleadoFiltro" placeholder="Nombre de Empleado">

Â  Â  Â  Â  `;

Â  Â  }



Â  Â  let fechaFiltroHtml = '';

Â  Â  fechaFiltroHtml = `

Â  Â  Â  Â  <label for="fechaReporte">Fecha:</label>

Â  Â  Â  Â  <input type="date" id="fechaReporte" value="${fechaActual}">

Â  Â  `;



Â  Â  let turnoFiltroHtml = '';

Â  Â  turnoFiltroHtml = `

Â  Â  Â  Â  <label for="turnoFiltro">Turno:</label>

Â  Â  Â  Â  <select id="turnoFiltro">

Â  Â  Â  Â  Â  Â  <option value="todos">Todos</option>

Â  Â  Â  Â  Â  Â  <option value="Turno 1">Turno 1</option>

Â  Â  Â  Â  Â  Â  <option value="Turno 2">Turno 2</option>

Â  Â  Â  Â  </select>

Â  Â  `;



Â  Â  let exportButtons = `

Â  Â  Â  Â  <button class="usuario-btn" onclick="exportarReporte('excel')">Exportar a Excel</button>

Â  Â  Â  Â  <button class="usuario-btn" onclick="exportarReporte('pdf')">Exportar a PDF</button>

Â  Â  Â  Â  <button class="usuario-btn" onclick="exportarReporte('csv')">Exportar a CSV</button>

Â  Â  `;



Â  Â  let graficoSelector = '';

Â  Â  if (tipo !== 'resumen') {

Â  Â  Â  Â  graficoSelector = `

Â  Â  Â  Â  Â  Â  <div class="opciones-grafico">

Â  Â  Â  Â  Â  Â  Â  Â  <label>Tipo de GrÃ¡fico:</label>

Â  Â  Â  Â  Â  Â  Â  Â  <select id="tipoGrafico">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="bar">Barras</option>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="pie">Pastel</option>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="line">LÃ­nea</option>

Â  Â  Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  `;

Â  Â  }





Â  Â  contenedor.innerHTML = `

Â  Â  Â  Â  <div class="header-reporte">

Â  Â  Â  Â  Â  Â  <button onclick="regresarASelectores()" class="usuario-btn">Regresar</button>

Â  Â  Â  Â  Â  Â  <div class="filtros">

Â  Â  Â  Â  Â  Â  Â  Â  ${fechaFiltroHtml}

Â  Â  Â  Â  Â  Â  Â  Â  ${turnoFiltroHtml}

Â  Â  Â  Â  Â  Â  Â  Â  ${tipo === 'resumen' ? '' : areaFiltroHtml}

Â  Â  Â  Â  Â  Â  Â  Â  ${empleadoFiltroHtml}

Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="buscarReporte()" class="usuario-btn">Buscar</button>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <h2 id="tituloReporteDinamico">Cargando...</h2>

Â  Â  Â  Â  ${graficoSelector}

Â  Â  Â  Â  <div id="contenidoReporte"></div>

Â  Â  Â  Â  <div class="botones-reporte">

Â  Â  Â  Â  Â  Â  ${exportButtons}

Â  Â  Â  Â  </div>

Â  Â  `;



Â  Â  if (document.getElementById('turnoFiltro')) {

Â  Â  Â  Â  document.getElementById('turnoFiltro').value = turnoActual;

Â  Â  }

Â  Â  if (document.getElementById('areaFiltro')) {

Â  Â  Â  Â  document.getElementById('areaFiltro').value = 'TODAS';

Â  Â  }

Â  Â Â 

Â  Â  // Listener para el cambio de tipo de grÃ¡fico

Â  Â  if (document.getElementById('tipoGrafico')) {

Â  Â  Â  Â  document.getElementById('tipoGrafico').addEventListener('change', actualizarGraficoReporte);

Â  Â  }



Â  Â  const fecha = document.getElementById('fechaReporte').value;

Â  Â  const turno = document.getElementById('turnoFiltro').value;

Â  Â  const area = document.getElementById('areaFiltro') ? document.getElementById('areaFiltro').value : null;

Â  Â  const empleado = document.getElementById('empleadoFiltro') ? document.getElementById('empleadoFiltro').value : null;



Â  Â  cargarDatosReporte(tipo, fecha, turno, area, empleado);

}



function actualizarGraficoReporte() {

Â  Â  const tipoGraficoSeleccionado = document.getElementById('tipoGrafico').value;

Â  Â  const contenedorGrafico = document.querySelector('#grafico-contenedor');

Â  Â Â 

Â  Â  if (contenedorGrafico) {

Â  Â  Â  Â  contenedorGrafico.innerHTML = '<canvas id="graficoDinamico"></canvas>';

Â  Â  }



Â  Â  if (datosFiltradosReporte) {

Â  Â  Â  Â  let labels, data, chartTitle;

Â  Â  Â  Â  if (reporteActual === 'produccion') {

Â  Â  Â  Â  Â  Â  const conteo = {};

Â  Â  Â  Â  Â  Â  datosFiltradosReporte.forEach(log => {

Â  Â  Â  Â  Â  Â  Â  Â  const area = log.grupo;

Â  Â  Â  Â  Â  Â  Â  Â  conteo[area] = (conteo[area] || 0) + 1;

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  labels = Object.keys(conteo);

Â  Â  Â  Â  Â  Â  data = Object.values(conteo);

Â  Â  Â  Â  Â  Â  chartTitle = 'Tarimas Producidas por Ãrea';

Â  Â  Â  Â  } else if (reporteActual === 'logistica') {

Â  Â  Â  Â  Â  Â  const conteo = {};

Â  Â  Â  Â  Â  Â  datosFiltradosReporte.forEach(log => {

Â  Â  Â  Â  Â  Â  Â  Â  const area = log.grupo;

Â  Â  Â  Â  Â  Â  Â  Â  conteo[area] = (conteo[area] || 0) + 1;

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  labels = Object.keys(conteo);

Â  Â  Â  Â  Â  Â  data = Object.values(conteo);

Â  Â  Â  Â  Â  Â  chartTitle = 'Total de Tarimas Recolectadas por Ãrea';

Â  Â  Â  Â  } else if (reporteActual === 'calidad') {

Â  Â  Â  Â  Â  Â  const conteo = {};

Â  Â  Â  Â  Â  Â  datosFiltradosReporte.forEach(rechazo => {

Â  Â  Â  Â  Â  Â  Â  Â  const problema = rechazo.problema;

Â  Â  Â  Â  Â  Â  Â  Â  conteo[problema] = (conteo[problema] || 0) + 1;

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  labels = Object.keys(conteo);

Â  Â  Â  Â  Â  Â  data = Object.values(conteo);

Â  Â  Â  Â  Â  Â  chartTitle = 'Causas de Rechazo';

Â  Â  Â  Â  }



Â  Â  Â  Â  if (miGrafico) {

Â  Â  Â  Â  Â  Â  miGrafico.destroy();

Â  Â  Â  Â  }



Â  Â  Â  Â  const ctx = document.getElementById('graficoDinamico').getContext('2d');

Â  Â  Â  Â  const backgroundColors = [

Â  Â  Â  Â  Â  Â  '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED',

Â  Â  Â  Â  Â  Â  '#FF6361', '#5DADE2', '#F7DC6F', '#7DCEA0', '#AF7AC5', '#F5B041'

Â  Â  Â  Â  ];



Â  Â  Â  Â  miGrafico = new Chart(ctx, {

Â  Â  Â  Â  Â  Â  type: tipoGraficoSeleccionado,

Â  Â  Â  Â  Â  Â  data: {

Â  Â  Â  Â  Â  Â  Â  Â  labels: labels,

Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: chartTitle,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: data,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: backgroundColors,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: backgroundColors,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fill: tipoGraficoSeleccionado === 'line',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tension: 0.4

Â  Â  Â  Â  Â  Â  Â  Â  }]

Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  options: {

Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,

Â  Â  Â  Â  Â  Â  Â  Â  plugins: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: 'top',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: { font: { size: 14 } }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: chartTitle,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: { size: 20 }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  Â  Â  scales: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beginAtZero: true

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });

Â  Â  }

}





function regresarASelectores() {

Â  Â  document.getElementById('tituloReportes').textContent = 'REPORTES';

Â  Â  document.getElementById('selectoresReportes').style.display = 'flex';

Â  Â  document.getElementById('contenedorReporte').innerHTML = '<h2>Selecciona un reporte</h2>';

Â  Â  if (miGrafico) {

Â  Â  Â  Â  miGrafico.destroy();

Â  Â  }

Â  Â  datosFiltradosReporte = null;

}



function buscarReporte() {

Â  Â  const tipo = reporteActual;

Â  Â  const fecha = document.getElementById('fechaReporte').value;

Â  Â  const turno = document.getElementById('turnoFiltro').value;

Â  Â  const area = document.getElementById('areaFiltro') ? document.getElementById('areaFiltro').value : null;

Â  Â  const empleado = document.getElementById('empleadoFiltro') ? document.getElementById('empleadoFiltro').value : null;



Â  Â  cargarDatosReporte(tipo, fecha, turno, area, empleado);

}





function cargarDatosReporte(tipo, fecha, turno, area, empleado) {

Â  Â  const contenedor = document.getElementById('contenidoReporte');

Â  Â  const tituloReporte = document.getElementById('tituloReporteDinamico');

Â  Â  contenedor.innerHTML = '<p>Cargando datos...</p>';

Â  Â Â 

Â  Â  if (miGrafico) {

Â  Â  Â  Â  miGrafico.destroy();

Â  Â  }

Â  Â Â 

Â  Â  const refHistorial = db.ref(`historialLogs`);

Â  Â  const refCalidad = db.ref(`contadoresCalidad`);

Â  Â  const refRechazos = db.ref(`rechazosDetallados`);



Â  Â  Promise.all([

Â  Â  Â  Â  refHistorial.once('value').then(s => s.val()),

Â  Â  Â  Â  refCalidad.once('value').then(s => s.val()),

Â  Â  Â  Â  refRechazos.once('value').then(s => s.val())

Â  Â  ]).then(([historial, calidad, rechazos]) => {

Â  Â  Â  Â  const datosCompletos = { historial, calidad, rechazos };

Â  Â  Â  Â Â 

Â  Â  Â  Â  if (tipo === 'calidad') {

Â  Â  Â  Â  Â  Â  tituloReporte.textContent = `Reporte de Calidad - ${fecha}`;

Â  Â  Â  Â  Â  Â  procesarReporteCalidad(datosCompletos, contenedor, fecha, turno, area, empleado);

Â  Â  Â  Â  } else if (tipo === 'produccion') {

Â  Â  Â  Â  Â  Â  tituloReporte.textContent = `Reporte de ProducciÃ³n - ${fecha}`;

Â  Â  Â  Â  Â  Â  procesarReporteProduccion(datosCompletos, contenedor, fecha, turno, area);

Â  Â  Â  Â  } else if (tipo === 'logistica') {

Â  Â  Â  Â  Â  Â  tituloReporte.textContent = `Reporte de LogÃ­stica - ${fecha}`;

Â  Â  Â  Â  Â  Â  procesarReporteLogistica(datosCompletos, contenedor, fecha, turno, area);

Â  Â  Â  Â  } else if (tipo === 'resumen') {

Â  Â  Â  Â  Â  Â  tituloReporte.textContent = `Resumen Ejecutivo`;

Â  Â  Â  Â  Â  Â  procesarReporteResumen(datosCompletos, contenedor, fecha, turno);

Â  Â  Â  Â  }

Â  Â  }).catch(error => {

Â  Â  Â  Â  console.error("Error al cargar los datos:", error);

Â  Â  Â  Â  contenedor.innerHTML = `<p>Error al cargar los datos. Intenta de nuevo.</p>`;

Â  Â  });

}





function procesarReporteCalidad(datos, contenedor, fecha, turno, area, empleado) {

Â  Â  let rechazosFiltrados = [];

Â  Â Â 

Â  Â  for (const fechaKey in datos.rechazos) {

Â  Â  Â  Â  if (fecha !== fechaKey) continue;

Â  Â  Â  Â Â 

Â  Â  Â  Â  for (const turnoKey in datos.rechazos[fechaKey]) {

Â  Â  Â  Â  Â  Â  if (turno !== 'todos' && turnoKey !== turno) continue;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  for (const rechazoKey in datos.rechazos[fechaKey][turnoKey]) {

Â  Â  Â  Â  Â  Â  Â  Â  const rechazo = datos.rechazos[fechaKey][turnoKey][rechazoKey];

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  if (

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (area === 'TODAS' || rechazo.areaRechazo === area) &&

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (!empleado || (rechazo.empleado && rechazo.empleado.toLowerCase().includes(empleado.toLowerCase())))

Â  Â  Â  Â  Â  Â  Â  Â  ) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rechazosFiltrados.push(rechazo);

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }

Â  Â Â 

Â  Â  datosFiltradosReporte = rechazosFiltrados;



Â  Â  const conteoProblemas = {};

Â  Â  rechazosFiltrados.forEach(rechazo => {

Â  Â  Â  Â  const problema = rechazo.problema || 'Desconocido';

Â  Â  Â  Â  conteoProblemas[problema] = (conteoProblemas[problema] || 0) + 1;

Â  Â  });



Â  Â  // KPIs

Â  Â  const kpisHtml = `

Â  Â  Â  Â  <div class="resumen-datos">

Â  Â  Â  Â  Â  Â  <div class="dato">

Â  Â  Â  Â  Â  Â  Â  Â  <div class="valor">${rechazosFiltrados.length}</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Tarimas Rechazadas</div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="dato">

Â  Â  Â  Â  Â  Â  Â  Â  <div class="valor">${Object.keys(conteoProblemas).length}</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Problemas Identificados</div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  `;

Â  Â Â 

Â  Â  let tablaHtml = `<table><thead><tr><th>Fecha</th><th>Hora</th><th>Ãrea</th><th>LÃ­nea</th><th>Empleado</th><th>No. de Parte</th><th>DescripciÃ³n de la Parte</th><th>DescripciÃ³n del Problema</th><th>Causa RaÃ­z</th><th>AcciÃ³n Correctiva</th></tr></thead><tbody>`;

Â  Â  rechazosFiltrados.forEach(r => {

Â  Â  Â  Â  const areaRechazoFormateada = r.areaRechazo ? r.areaRechazo.replace('CALIDAD_', '') : 'N/A';

Â  Â  Â  Â  tablaHtml += `

Â  Â  Â  Â  Â  Â  <tr>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.fecha}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.hora}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${areaRechazoFormateada}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.linea || 'N/A'}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.empleado || 'N/A'}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.parte || 'N/A'}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.descripcionParte || 'N/A'}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.problema || 'N/A'}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.causa || 'N/A'}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.accion || 'N/A'}</td>

Â  Â  Â  Â  Â  Â  </tr>

Â  Â  Â  Â  `;

Â  Â  });

Â  Â  tablaHtml += `</tbody></table>`;



Â  Â  // VersiÃ³n para mÃ³vil

Â  Â  let tablaMovilHtml = `<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">`;

Â  Â  rechazosFiltrados.forEach(r => {

Â  Â  Â  Â  const areaRechazoFormateada = r.areaRechazo ? r.areaRechazo.replace('CALIDAD_', '') : 'N/A';

Â  Â  Â  Â  tablaMovilHtml += `

Â  Â  Â  Â  Â  Â  <div class="fila-dato">

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Fecha:</span> <span class="valor">${r.fecha}</span><br>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Hora:</span> <span class="valor">${r.hora}</span><br>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Ãrea:</span> <span class="valor">${areaRechazoFormateada}</span><br>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">LÃ­nea:</span> <span class="valor">${r.linea || 'N/A'}</span><br>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Empleado:</span> <span class="valor">${r.empleado || 'N/A'}</span><br>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Problema:</span> <span class="valor">${r.problema || 'N/A'}</span>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  `;

Â  Â  });

Â  Â  tablaMovilHtml += `</div></div>`;



Â  Â  let graficoHtml = '';

Â  Â  if (Object.keys(conteoProblemas).length > 0) {

Â  Â  Â  Â  graficoHtml = `<div id="grafico-contenedor" class="grafico-contenedor"><canvas id="graficoDinamico"></canvas></div>`;

Â  Â  }

Â  Â Â 

Â  Â  contenedor.innerHTML = kpisHtml + graficoHtml + tablaHtml + tablaMovilHtml;



Â  Â  if (Object.keys(conteoProblemas).length > 0) {

Â  Â  Â  Â  actualizarGraficoReporte();

Â  Â  }

}





function procesarReporteProduccion(datos, contenedor, fecha, turno, area) {

Â  Â  let logsProduccion = [];

Â  Â  const conteo = { MULTIPORT: 0, DROPS: 0, BEDROCK: 0 };

Â  Â Â 

Â  Â  for (const fechaKey in datos.historial) {

Â  Â  Â  Â  if (fecha !== fechaKey) continue;

Â  Â  Â  Â Â 

Â  Â  Â  Â  for (const turnoKey in datos.historial[fechaKey]) {

Â  Â  Â  Â  Â  Â  if (turno !== 'todos' && turnoKey !== turno) continue;



Â  Â  Â  Â  Â  Â  for (const logKey in datos.historial[fechaKey][turnoKey]) {

Â  Â  Â  Â  Â  Â  Â  Â  const log = datos.historial[fechaKey][turnoKey][logKey];

Â  Â  Â  Â  Â  Â  Â  Â  if (log.accion === 'encendido' && ['MULTIPORT', 'DROPS', 'BEDROCK'].includes(log.grupo)) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (area === 'TODAS' || log.grupo === area) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logsProduccion.push(log);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conteo[log.grupo]++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }

Â  Â Â 

Â  Â  datosFiltradosReporte = logsProduccion;



Â  Â  const kpisHtml = `

Â  Â  Â  Â  <div class="resumen-datos">

Â  Â  Â  Â  Â  Â  <div class="dato">

Â  Â  Â  Â  Â  Â  Â  Â  <div class="valor">${logsProduccion.length}</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Tarimas Confirmadas</div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  `;



Â  Â  const graficoHtml = `<div id="grafico-contenedor" class="grafico-contenedor"><canvas id="graficoDinamico"></canvas></div>`;



Â  Â  let tablaHtml = `

Â  Â  Â  Â  <table>

Â  Â  Â  Â  Â  Â  <thead>

Â  Â  Â  Â  Â  Â  Â  Â  <tr>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>LÃ­nea</th>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Tarima</th>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Hora de ConfirmaciÃ³n</th>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Usuario</th>

Â  Â  Â  Â  Â  Â  Â  Â  </tr>

Â  Â  Â  Â  Â  Â  </thead>

Â  Â  Â  Â  Â  Â  <tbody>

Â  Â  `;

Â  Â  logsProduccion.forEach(log => {

Â  Â  Â  Â  tablaHtml += `

Â  Â  Â  Â  Â  Â  <tr>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${log.grupo}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${log.led}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatoHora(log.timestamp)}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${log.usuario}</td>

Â  Â  Â  Â  Â  Â  </tr>

Â  Â  Â  Â  `;

Â  Â  });

Â  Â  tablaHtml += `</tbody></table>`;

Â  Â Â 

Â  Â  let tablaMovilHtml = `<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">`;

Â  Â  logsProduccion.forEach(log => {

Â  Â  Â  Â  tablaMovilHtml += `

Â  Â  Â  Â  Â  Â  <div class="fila-dato">

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">LÃ­nea:</span> <span class="valor">${log.grupo}</span><br>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Tarima:</span> <span class="valor">${log.led}</span><br>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Hora:</span> <span class="valor">${formatoHora(log.timestamp)}</span><br>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Usuario:</span> <span class="valor">${log.usuario}</span>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  `;

Â  Â  });

Â  Â  tablaMovilHtml += `</div></div>`;



Â  Â  contenedor.innerHTML = kpisHtml + graficoHtml + tablaHtml + tablaMovilHtml;

Â  Â  actualizarGraficoReporte();

}





function procesarReporteLogistica(datos, contenedor, fecha, turno, area) {

Â  Â  let logsRecoleccion = [];

Â  Â  let tiempoTotal = 0;

Â  Â Â 

Â  Â  for (const fechaKey in datos.historial) {

Â  Â  Â  Â  if (fecha !== fechaKey) continue;

Â  Â  Â  Â Â 

Â  Â  Â  Â  for (const turnoKey in datos.historial[fechaKey]) {

Â  Â  Â  Â  Â  Â  if (turno !== 'todos' && turnoKey !== turno) continue;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  for (const logKey in datos.historial[fechaKey][turnoKey]) {

Â  Â  Â  Â  Â  Â  Â  Â  const log = datos.historial[fechaKey][turnoKey][logKey];

Â  Â  Â  Â  Â  Â  Â  Â  if (log.accion === 'apagado' && log.tiempoRecoleccion && ['MULTIPORT', 'DROPS', 'BEDROCK'].includes(log.grupo)) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (area === 'TODAS' || log.grupo === area) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logsRecoleccion.push(log);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiempoTotal += log.tiempoRecoleccion;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }



Â  Â  datosFiltradosReporte = logsRecoleccion;

Â  Â Â 

Â  Â  const tiempoPromedio = logsRecoleccion.length > 0 ? (tiempoTotal / logsRecoleccion.length).toFixed(1) : 0;

Â  Â Â 

Â  Â  const conteoTarimasPorArea = {};

Â  Â  logsRecoleccion.forEach(log => {

Â  Â  Â  Â  const area = log.grupo;

Â  Â  Â  Â  conteoTarimasPorArea[area] = (conteoTarimasPorArea[area] || 0) + 1;

Â  Â  });



Â  Â  const kpisHtml = `

Â  Â  Â  Â  <div class="resumen-datos">

Â  Â  Â  Â  Â  Â  <div class="dato">

Â  Â  Â  Â  Â  Â  Â  Â  <div class="valor">${logsRecoleccion.length}</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Tarimas Recolectadas</div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="dato">

Â  Â  Â  Â  Â  Â  Â  Â  <div class="valor">${tiempoPromedio} min</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Tiempo Promedio</div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  `;



Â  Â  const graficoHtml = `<div id="grafico-contenedor" class="grafico-contenedor"><canvas id="graficoDinamico"></canvas></div>`;



Â  Â  let tablaHtml = `

Â  Â  Â  Â  <table>

Â  Â  Â  Â  Â  Â  <thead>

Â  Â  Â  Â  Â  Â  Â  Â  <tr>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>LÃ­nea</th>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Tarima</th>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Tiempo de RecolecciÃ³n (min)</th>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Hora de Encendido</th>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Hora de Apagado</th>

Â  Â  Â  Â  Â  Â  Â  Â  </tr>

Â  Â  Â  Â  Â  Â  </thead>

Â  Â  Â  Â  Â  Â  <tbody>

Â  Â  `;

Â  Â  logsRecoleccion.forEach(log => {

Â  Â  Â  Â  tablaHtml += `

Â  Â  Â  Â  Â  Â  <tr>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${log.grupo}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${log.led}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${log.tiempoRecoleccion}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatoHora(log.horaEncendido)}</td>

Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatoHora(log.horaApagado)}</td>

Â  Â  Â  Â  Â  Â  </tr>

Â  Â  Â  Â  `;

Â  Â  });

Â  Â  tablaHtml += `</tbody></table>`;

Â  Â Â 

Â  Â  let tablaMovilHtml = `<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">`;

Â  Â  logsRecoleccion.forEach(log => {

Â  Â  Â  Â  tablaMovilHtml += `

Â  Â  Â  Â  Â  Â  <div class="fila-dato">

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">LÃ­nea:</span> <span class="valor">${log.grupo}</span><br>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Tarima:</span> <span class="valor">${log.led}</span><br>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Tiempo:</span> <span class="valor">${log.tiempoRecoleccion} min</span><br>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Hora de RecolecciÃ³n:</span> <span class="valor">${formatoHora(log.horaApagado)}</span>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  `;

Â  Â  });

Â  Â  tablaMovilHtml += `</div></div>`;



Â  Â  contenedor.innerHTML = kpisHtml + graficoHtml + tablaHtml + tablaMovilHtml;

Â  Â  document.getElementById('tipoGrafico').value = 'bar'; // Establecer por defecto a barras

Â  Â  actualizarGraficoReporte();

}



function procesarReporteResumen(datos, contenedor, fecha, turno) {

Â  Â  const areas = ['MULTIPORT', 'DROPS', 'BEDROCK'];

Â  Â  const resumen = {};

Â  Â Â 

Â  Â  areas.forEach(area => {

Â  Â  Â  Â  resumen[area] = {

Â  Â  Â  Â  Â  Â  produccion: 0,

Â  Â  Â  Â  Â  Â  liberadas: 0,

Â  Â  Â  Â  Â  Â  rechazadas: 0,

Â  Â  Â  Â  Â  Â  tiempoLogistica: { total: 0, count: 0, promedio: 0 }

Â  Â  Â  Â  };

Â  Â  });



Â  Â  // Procesar historial (producciÃ³n y logÃ­stica)

Â  Â  for (const fechaKey in datos.historial) {

Â  Â  Â  Â  if (fechaKey !== fecha && fecha !== null) continue; // Si se elige una fecha, procesar solo esa

Â  Â  Â  Â  for (const turnoKey in datos.historial[fechaKey]) {

Â  Â  Â  Â  Â  Â  if (turnoKey !== turno && turno !== 'todos') continue; // Si se elige un turno, procesar solo ese

Â  Â  Â  Â  Â  Â  for (const logKey in datos.historial[fechaKey][turnoKey]) {

Â  Â  Â  Â  Â  Â  Â  Â  const log = datos.historial[fechaKey][turnoKey][logKey];

Â  Â  Â  Â  Â  Â  Â  Â  if (log.accion === 'encendido' && resumen.hasOwnProperty(log.grupo)) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resumen[log.grupo].produccion++;

Â  Â  Â  Â  Â  Â  Â  Â  } else if (log.accion === 'apagado' && log.tiempoRecoleccion && resumen.hasOwnProperty(log.grupo)) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resumen[log.grupo].tiempoLogistica.total += log.tiempoRecoleccion;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resumen[log.grupo].tiempoLogistica.count++;

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }



Â  Â  // Procesar contadores de calidad

Â  Â  for (const fechaKey in datos.calidad) {

Â  Â  Â  Â  if (fechaKey !== fecha && fecha !== null) continue;

Â  Â  Â  Â  for (const turnoKey in datos.calidad[fechaKey]) {

Â  Â  Â  Â  Â  Â  if (turnoKey !== turno && turno !== 'todos') continue;

Â  Â  Â  Â  Â  Â  for (const grupoKey in datos.calidad[fechaKey][turnoKey]) {

Â  Â  Â  Â  Â  Â  Â  Â  const grupoBase = grupoKey.replace('CALIDAD_', '');

Â  Â  Â  Â  Â  Â  Â  Â  if (resumen.hasOwnProperty(grupoBase)) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const contadores = datos.calidad[fechaKey][turnoKey][grupoKey];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resumen[grupoBase].liberadas += contadores.liberadas || 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resumen[grupoBase].rechazadas += contadores.rechazadas || 0;

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }



Â  Â  let html = ``;

Â  Â  areas.forEach(area => {

Â  Â  Â  Â  const prod = resumen[area].produccion;

Â  Â  Â  Â  const liberadas = resumen[area].liberadas;

Â  Â  Â  Â  const rechazadas = resumen[area].rechazadas;

Â  Â  Â  Â  const totalCalidad = liberadas + rechazadas;

Â  Â  Â  Â  const tasaRechazo = totalCalidad > 0 ? ((rechazadas / totalCalidad) * 100).toFixed(1) : 0;

Â  Â  Â  Â  const tiempoPromedio = resumen[area].tiempoLogistica.count > 0 ? (resumen[area].tiempoLogistica.total / resumen[area].tiempoLogistica.count).toFixed(1) : 0;



Â  Â  Â  Â  html += `

Â  Â  Â  Â  Â  Â  <h3>${area}</h3>

Â  Â  Â  Â  Â  Â  <div class="resumen-datos">

Â  Â  Â  Â  Â  Â  Â  Â  <div class="dato">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="valor">${prod}</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Tarimas Producidas</div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="dato">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="valor">${liberadas}</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Tarimas Liberadas</div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="dato">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="valor">${rechazadas}</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Tarimas Rechazadas</div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="dato">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="valor">${tasaRechazo}%</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Tasa de Rechazo</div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="dato">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="valor">${tiempoPromedio} min</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="etiqueta">Tiempo RecolecciÃ³n</div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  `;

Â  Â  });

Â  Â  contenedor.innerHTML = html;

}



function generarGraficoRechazos(datos) {

Â  Â  const ctx = document.getElementById('graficoRechazos').getContext('2d');

Â  Â  const labels = Object.keys(datos);

Â  Â  const data = Object.values(datos);

Â  Â Â 

Â  Â  const backgroundColors = [

Â  Â  Â  Â  '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED',

Â  Â  Â  Â  '#FF6361', '#5DADE2', '#F7DC6F', '#7DCEA0', '#AF7AC5', '#F5B041'

Â  Â  ];

Â  Â Â 

Â  Â  if (miGrafico) {

Â  Â  Â  Â  miGrafico.destroy();

Â  Â  }

Â  Â Â 

Â  Â  miGrafico = new Chart(ctx, {

Â  Â  Â  Â  type: 'pie',

Â  Â  Â  Â  data: {

Â  Â  Â  Â  Â  Â  labels: labels,

Â  Â  Â  Â  Â  Â  datasets: [{

Â  Â  Â  Â  Â  Â  Â  Â  data: data,

Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: backgroundColors,

Â  Â  Â  Â  Â  Â  Â  Â  hoverBackgroundColor: backgroundColors

Â  Â  Â  Â  Â  Â  }]

Â  Â  Â  Â  },

Â  Â  Â  Â  options: {

Â  Â  Â  Â  Â  Â  responsive: true,

Â  Â  Â  Â  Â  Â  plugins: {

Â  Â  Â  Â  Â  Â  Â  Â  legend: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: 'top',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: { size: 14 }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  Â  Â  title: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'Causas de Rechazo',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: { size: 20 }

Â  Â  Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  Â  Â  tooltip: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  callbacks: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: (context) => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const label = context.label || '';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const value = context.raw;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const total = context.dataset.data.reduce((sum, val) => sum + val, 0);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const percentage = ((value / total) * 100).toFixed(1);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `${label}: ${value} (${percentage}%)`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  });

}



function generarGraficoProduccion(datos) {

Â  Â  const ctx = document.getElementById('graficoProduccion').getContext('2d');

Â  Â  const labels = Object.keys(datos);

Â  Â  const data = Object.values(datos);



Â  Â  if (miGrafico) {

Â  Â  Â  Â  miGrafico.destroy();

Â  Â  }



Â  Â  miGrafico = new Chart(ctx, {

Â  Â  Â  Â  type: 'bar',

Â  Â  Â  Â  data: {

Â  Â  Â  Â  Â  Â  labels: labels,

Â  Â  Â  Â  Â  Â  datasets: [{

Â  Â  Â  Â  Â  Â  Â  Â  label: 'Tarimas Confirmadas',

Â  Â  Â  Â  Â  Â  Â  Â  data: data,

Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: [

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#4BC0C0',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#36A2EB',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#FFCE56'

Â  Â  Â  Â  Â  Â  Â  Â  ],

Â  Â  Â  Â  Â  Â  Â  Â  borderColor: [

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#4BC0C0',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#36A2EB',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#FFCE56'

Â  Â  Â  Â  Â  Â  Â  Â  ],

Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1

Â  Â  Â  Â  Â  Â  }]

Â  Â  Â  Â  },

Â  Â  Â  Â  options: {

Â  Â  Â  Â  Â  Â  responsive: true,

Â  Â  Â  Â  Â  Â  scales: {

Â  Â  Â  Â  Â  Â  Â  Â  y: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beginAtZero: true,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'Cantidad de Tarimas'

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  plugins: {

Â  Â  Â  Â  Â  Â  Â  Â  legend: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: false

Â  Â  Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  Â  Â  title: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'ProducciÃ³n por Ãrea'

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  });

}





function exportarReporte(formato) {

Â  Â  const tabla = document.querySelector('#contenidoReporte table');

Â  Â  const chart = miGrafico;

Â  Â  const tipo = reporteActual;



Â  Â  if (!tabla) {

Â  Â  Â  Â  alert('No hay datos para exportar. Por favor, genera un reporte primero.');

Â  Â  Â  Â  return;

Â  Â  }



Â  Â  const nombreArchivo = `${tipo}_${document.getElementById('fechaReporte').value}`;



Â  Â  if (formato === 'excel') {

Â  Â  Â  Â  const data = XLSX.utils.table_to_sheet(tabla);

Â  Â  Â  Â  const wb = XLSX.utils.book_new();

Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, data, 'Reporte');

Â  Â  Â  Â  XLSX.writeFile(wb, `${nombreArchivo}.xlsx`);

Â  Â  } else if (formato === 'pdf') {

Â  Â  Â  Â  exportarAPdf(tabla, chart, nombreArchivo);

Â  Â  } else if (formato === 'csv') {

Â  Â  Â  Â  exportarACsv(tabla, nombreArchivo);

Â  Â  }

}



function exportarACsv(tabla, nombreReporte) {

Â  Â  let csv = [];

Â  Â  const filas = tabla.querySelectorAll('tr');



Â  Â  for (const fila of filas) {

Â  Â  Â  Â  let filaDatos = [];

Â  Â  Â  Â  const celdas = fila.querySelectorAll('th, td');

Â  Â  Â  Â  for (const celda of celdas) {

Â  Â  Â  Â  Â  Â  filaDatos.push(`"${celda.textContent.trim().replace(/"/g, '""')}"`); // Escapar comillas dobles

Â  Â  Â  Â  }

Â  Â  Â  Â  csv.push(filaDatos.join(','));

Â  Â  }



Â  Â  const csvFinal = csv.join('\n');

Â  Â  const blob = new Blob([csvFinal], { type: 'text/csv;charset=utf-8;' });

Â  Â  const url = URL.createObjectURL(blob);

Â  Â  const link = document.createElement('a');

Â  Â  link.setAttribute('href', url);

Â  Â  link.setAttribute('download', `${nombreReporte}.csv`);

Â  Â  link.style.visibility = 'hidden';

Â  Â  document.body.appendChild(link);

Â  Â  link.click();

Â  Â  document.body.removeChild(link);

}



function exportarAPdf(tabla, chart, nombreArchivo) {

Â  Â  const { jsPDF } = window.jspdf;

Â  Â  const doc = new jsPDF('p', 'pt', 'letter');

Â  Â  const margin = 20;

Â  Â  let y = margin;

Â  Â  let pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();

Â  Â  let pageWidth = doc.internal.pageSize.width || doc.internal.pageSize.getWidth();



Â  Â  // TÃ­tulo del reporte

Â  Â  doc.setFontSize(22);

Â  Â  doc.text(`Reporte de ${reporteActual.toUpperCase()}`, pageWidth / 2, y, { align: 'center' });

Â  Â  y += 30;



Â  Â  // Agregar la fecha

Â  Â  doc.setFontSize(12);

Â  Â  doc.text(`Fecha: ${document.getElementById('fechaReporte').value}`, margin, y);

Â  Â  y += 20;



Â  Â  // Agregar resumen si existe

Â  Â  const resumenDiv = document.querySelector('#contenidoReporte .resumen-datos');

Â  Â  if (resumenDiv) {

Â  Â  Â  Â  const resumenText = Array.from(resumenDiv.children).map(dato => {

Â  Â  Â  Â  Â  Â  const etiqueta = dato.querySelector('.etiqueta').textContent;

Â  Â  Â  Â  Â  Â  const valor = dato.querySelector('.valor').textContent;

Â  Â  Â  Â  Â  Â  return `${etiqueta}: ${valor}`;

Â  Â  Â  Â  }).join('Â  |Â  ');

Â  Â  Â  Â  doc.text(resumenText, margin, y);

Â  Â  Â  Â  y += 30;

Â  Â  }



Â  Â  // Agregar grÃ¡fica como imagen

Â  Â  if (chart) {

Â  Â  Â  Â  const chartDataURL = chart.toBase64Image();

Â  Â  Â  Â  const imgWidth = 500;

Â  Â  Â  Â  const imgHeight = 250;

Â  Â  Â  Â  const imgX = (pageWidth - imgWidth) / 2;



Â  Â  Â  Â  if (y + imgHeight + 30 > pageHeight) {

Â  Â  Â  Â  Â  Â  doc.addPage();

Â  Â  Â  Â  Â  Â  y = margin;

Â  Â  Â  Â  }



Â  Â  Â  Â  doc.addImage(chartDataURL, 'PNG', imgX, y, imgWidth, imgHeight);

Â  Â  Â  Â  y += imgHeight + 30;

Â  Â  }



Â  Â  // Agregar tabla

Â  Â  const tableHeaders = Array.from(tabla.querySelectorAll('thead th')).map(th => th.textContent.trim());

Â  Â  const tableData = Array.from(tabla.querySelectorAll('tbody tr')).map(tr =>

Â  Â  Â  Â  Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim())

Â  Â  );



Â  Â  const startY = y;

Â  Â  doc.autoTable({

Â  Â  Â  Â  startY: startY,

Â  Â  Â  Â  head: [tableHeaders],

Â  Â  Â  Â  body: tableData,

Â  Â  Â  Â  theme: 'striped',

Â  Â  Â  Â  styles: { fontSize: 8, cellPadding: 5 },

Â  Â  Â  Â  columnStyles: {

Â  Â  Â  Â  Â  Â  0: { cellWidth: 50 },

Â  Â  Â  Â  Â  Â  1: { cellWidth: 50 },

Â  Â  Â  Â  Â  Â  2: { cellWidth: 50 },

Â  Â  Â  Â  Â  Â  3: { cellWidth: 60 },

Â  Â  Â  Â  Â  Â  4: { cellWidth: 60 },

Â  Â  Â  Â  Â  Â  5: { cellWidth: 70 },

Â  Â  Â  Â  Â  Â  6: { cellWidth: 70 },

Â  Â  Â  Â  Â  Â  7: { cellWidth: 70 },

Â  Â  Â  Â  Â  Â  8: { cellWidth: 70 },

Â  Â  Â  Â  Â  Â  9: { cellWidth: 70 },

Â  Â  Â  Â  },

Â  Â  Â  Â  margin: { top: y, left: margin, right: margin, bottom: margin }

Â  Â  });



Â  Â  doc.save(`${nombreArchivo}.pdf`);

}



// ================= ARRANQUE Y MANEJO DE MODALES =================

window.addEventListener('load', ()=>{

Â  Â  firebase.auth().signInAnonymously().catch(err => {

Â  Â  Â  Â  console.error('Auth error:', err);

Â  Â  });

Â  Â Â 

Â  Â  firebase.auth().onAuthStateChanged(user => {

Â  Â  Â  Â  if (user) {

Â  Â  Â  Â  Â  Â  iniciarListenersFirebase();Â 

Â  Â  Â  Â  Â  Â  activarPantalla('pantalla1');

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  // Manejar el caso de no autenticaciÃ³n si es necesario

Â  Â  Â  Â  }

Â  Â  });

Â  Â Â 

Â  Â  const modalCalidad = document.getElementById('modalCalidad');

Â  Â  modalCalidad.querySelector('.cerrar-btn').addEventListener('click', () => {

Â  Â  Â  Â  modalCalidad.classList.remove('visible');

Â  Â  });



Â  Â  modalCalidad.querySelectorAll('.opcion-btn').forEach(btn => {

Â  Â  Â  Â  btn.addEventListener('click', () => {

Â  Â  Â  Â  Â  Â  const nuevoColor = btn.dataset.color;

Â  Â  Â  Â  Â  Â  if (nuevoColor === 'rojo') {

Â  Â  Â  Â  Â  Â  Â  Â  mostrarFormularioRechazo();

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  aplicarEstadoCalidad(nuevoColor);

Â  Â  Â  Â  Â  Â  Â  Â  modalCalidad.classList.remove('visible');

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });

Â  Â  });



Â  Â  const modalRechazo = document.getElementById('modalRechazo');

Â  Â  modalRechazo.querySelector('#formularioRechazo').addEventListener('submit', (e) => {

Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â Â 

Â  Â  Â  Â  const formulario = e.target;

Â  Â  Â  Â  const datos = {

Â  Â  Â  Â  Â  Â  empleado: formulario.empleado.value,

Â  Â  Â  Â  Â  Â  linea: formulario.linea.value,

Â  Â  Â  Â  Â  Â  parte: formulario.parte.value,

Â  Â  Â  Â  Â  Â  descripcionParte: formulario.descripcionParte.value,

Â  Â  Â  Â  Â  Â  problema: formulario.problema.value,

Â  Â  Â  Â  Â  Â  causa: formulario.causa.value,

Â  Â  Â  Â  Â  Â  accion: formulario.accion.value,

Â  Â  Â  Â  };

Â  Â  Â  Â Â 

Â  Â  Â  Â  guardarRechazo(datos);

Â  Â  Â  Â  formulario.reset();

Â  Â  });



Â  Â  const selectoresReportes = document.getElementById('selectoresReportes');

Â  Â  selectoresReportes.querySelectorAll('.usuario-btn').forEach(btn => {

Â  Â  Â  Â  btn.addEventListener('click', () => {

Â  Â  Â  Â  Â  Â  const tipoReporte = btn.dataset.reporte;

Â  Â  Â  Â  Â  Â  mostrarReporte(tipoReporte);

Â  Â  Â  Â  });

Â  Â  });



Â  Â  if ('serviceWorker' in navigator) {

Â  Â  Â  Â  navigator.serviceWorker.register('./sw.js')

Â  Â  Â  Â  Â  Â  .then(reg => {

Â  Â  Â  Â  Â  Â  Â  Â  console.log("âœ… Service Worker registrado:", reg);

Â  Â  Â  Â  Â  Â  })

Â  Â  Â  Â  Â  Â  .catch(err => {

Â  Â  Â  Â  Â  Â  Â  Â  console.error("âŒ Error al registrar Service Worker:", err);

Â  Â  Â  Â  Â  Â  });

Â  Â  }

});

</script>

</body>

</html>
