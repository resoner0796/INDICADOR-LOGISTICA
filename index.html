<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel LogÃ­stica</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root{
  --btn-bg: #0066cc;
  --btn-bg-hover: #004c99;
  --grid-size: 26px;
  --vignette: rgba(0,0,0,0.9);
  --titulo-size: clamp(42px,7vw,96px);
  --led-size: 50px;
  --led-gap: 16px;
  --led-off-core: #111;
  --led-off-edge: #000;
  --led-on-core: #0f0;
  --led-on-edge: #063;
  --glow: #00ff88;
  --blink-duration: 0.9s;
}

*{ box-sizing: border-box; }
html, body{ height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:#111; }
body{ overflow-y: auto; }

.pantalla{ display:none; width:100%; min-height:100vh; }
.pantalla.activa{ display:flex; flex-direction:column; }

#pantalla1{
    align-items:center;
    justify-content:center;
    flex-direction: column;
    background:linear-gradient(135deg,#222,#444);
    gap:18px;
}
.btn-contenedor{
    display:flex;
    flex-direction:column;
    align-items:center;
}

#pantalla1 h1{ margin:0 0 8px; }
.usuario-btn{
  background: var(--btn-bg);
  color:#fff;
  border:0;
  padding:14px 28px;
  margin:8px;
  border-radius:10px;
  font-size:18px;
  cursor:pointer;
  transition: background .25s ease;
  outline-color: #000; /* Puedes usar 'transparent' si no quieres que se vea */
}
.usuario-btn:hover{ background: var(--btn-bg-hover); }

#pantalla2{
  background-color:#000;
  background-image:
    radial-gradient(circle, rgba(60,60,60,.28) 20%, transparent 21%),
    radial-gradient(circle, #101010 20%, transparent 21%);
  background-size: var(--grid-size) var(--grid-size);
  box-shadow: inset 0 0 90px var(--vignette);
}
.header{ display:flex; align-items:center; justify-content:center; padding:16px 20px 6px; }
#tituloFijo{
  font-weight:800;
  text-align:center;
  letter-spacing:.5px;
  text-shadow:0 2px 8px rgba(0,0,0,.65);
  font-size:var(--titulo-size);
}
.zona-centro{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px 24px 28px;
  flex-direction: column; /* <-- Agrega esta lÃ­nea */
}
/* CÃ³digo CSS modificado */
.grupo-contenedor{
  display: flex; /* <-- CAMBIO */
  flex-wrap: wrap; /* <-- Agrega esta lÃ­nea */
  gap: clamp(24px, 4vw, 64px);
  width: min(1200px, 96vw);
  justify-content: center; /* <-- Centra los grupos si hay menos de 3 */
}

/* Nuevo estilo para ocultar grupos no autorizados */
.grupo.oculto {
  display: none;
}
.grupo{ display:flex; flex-direction:column; align-items:center; text-align:center; }
.grupo .nombre{ font-size: clamp(20px,2.2vw,28px); font-weight:800; margin-bottom:8px; letter-spacing:.5px; text-shadow:0 1px 6px rgba(0,0,0,.5); }
.grupo .tarimas{ font-size: clamp(16px,1.7vw,22px); opacity:.9; margin-bottom:14px; }
.leds{ display:flex; gap: var(--led-gap); justify-content:center; align-items:center; flex-wrap:nowrap; padding:4px; }
.led{
  width: var(--led-size);
  height: var(--led-size);
  border-radius:50%;
  cursor:pointer;
  background: radial-gradient(circle at 45% 40%, var(--led-off-core) 40%, var(--led-off-edge) 100%);
  box-shadow: inset -4px -5px 8px rgba(0,0,0,.8), inset 4px 5px 6px rgba(255,255,255,.06), 0 1px 0 rgba(255,255,255,.05);
  transition: transform .1s ease, filter .2s ease, box-shadow .2s ease;
}
.led:active{ transform: scale(.96); }
.led.on{
  background: radial-gradient(circle at 48% 45%, var(--led-on-core) 40%, var(--led-on-edge) 100%);
  box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  animation: blink var(--blink-duration) ease-in-out infinite;
}

.resumen-turno {
  display: flex;
  justify-content: center;
  gap: 40px;
  margin-bottom: 20px;
  background-color: #222;
  border-radius: 12px;
  padding: 15px 30px;
  box-shadow: 0 4px 10px rgba(0,0,0,.3);
  width: min(800px, 90vw);
}

.resumen-turno.oculto {
  display: none;
}

.dato-resumen {
  text-align: center;
}

.dato-resumen .etiqueta {
  font-size: 14px;
  opacity: 0.7;
  text-transform: uppercase;
  margin-bottom: 4px;
}

.dato-resumen .valor {
  font-size: 32px;
  font-weight: bold;
  letter-spacing: 1px;
}.tiempos{
    margin-top: 10px;
    font-size: 14px;
    opacity: 0.8;
    text-align: left;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
}
/* Agrega este nuevo bloque de CSS */
.btn-rojo{
    background: #cc0000; /* Rojo principal */
    outline-color: #000;
}
.btn-rojo:hover{
    background: #990000; /* Rojo mÃ¡s oscuro para el hover */
}
    /* Nuevo estilo para el botÃ³n de cambio de usuario en pantalla2 */
.footer{
    width: 100%;
    display: flex;
    justify-content: center;
    padding: 20px;
}
.footer .usuario-btn{
    padding: 10px 20px;
    font-size: 16px;
}

@media(max-width:720px){ 
  .grupo-contenedor{ 
    display: flex;
    flex-direction: column;
    gap: 24px;
    width: 100%;
  }
}
    @keyframes blink {
    0%, 100% {
        box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
    }
    50% {
        box-shadow: 0 0 40px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
    }
}
</style>
</head>

<body>

<section id="pantalla1" class="pantalla activa">
  <h1>Selecciona tu usuario</h1>
<div class="btn-contenedor">
    <button class="usuario-btn" onclick="seleccionarUsuario('LOGÃSTICA')">LOGÃSTICA</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('MULTIPORT')">MULTIPORT</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('DROPS')">DROPS</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('BEDROCK')">BEDROCK</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('SUPERVISOR')">SUPERVISOR</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('CALIDAD')">CALIDAD</button> 
</div>
</section>

<section id="pantalla2" class="pantalla">
  <header class="header">
    <div id="tituloFijo">LOGÃSTICA</div>
  </header>
  <div class="zona-centro">
      <div id="resumenTurno" class="resumen-turno oculto">
  <div class="dato-resumen">
    <div class="etiqueta">Tarimas Totales</div>
    <div id="tarimasTotales" class="valor">0</div>
  </div>
  <div class="dato-resumen">
    <div class="etiqueta">Tiempo Promedio</div>
    <div id="tiempoPromedio" class="valor">0 min</div>
  </div>
</div>
<div class="grupo-contenedor">
    <div class="grupo" data-grupo="MULTIPORT">
        <div class="nombre">MULTIPORT</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="MULTIPORT" data-linea="linea1"></div>
        <div class="leds" data-grupo="MULTIPORT" data-linea="linea2"></div>
        <div class="tiempos" data-grupo="MULTIPORT"></div>
    </div>

    <div class="grupo" data-grupo="DROPS">
        <div class="nombre">DROPS</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="DROPS" data-linea="linea1"></div>
        <div class="leds" data-grupo="DROPS" data-linea="linea2"></div>
        <div class="tiempos" data-grupo="DROPS"></div>
    </div>

    <div class="grupo" data-grupo="BEDROCK">
        <div class="nombre">BEDROCK</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="BEDROCK" data-linea="linea1"></div>
        <div class="leds" data-grupo="BEDROCK" data-linea="linea2"></div>
        <div class="tiempos" data-grupo="BEDROCK"></div>
    </div>

    <div class="grupo" data-grupo="CALIDAD_MULTIPORT">
        <div class="nombre">CALIDAD MULTIPORT</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="CALIDAD_MULTIPORT" data-linea="linea1"></div>
        <div class="tiempos" data-grupo="CALIDAD_MULTIPORT"></div>
    </div>

    <div class="grupo" data-grupo="CALIDAD_DROPS">
        <div class="nombre">CALIDAD DROPS</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="CALIDAD_DROPS" data-linea="linea1"></div>
        <div class="tiempos" data-grupo="CALIDAD_DROPS"></div>
    </div>

    <div class="grupo" data-grupo="CALIDAD_BEDROCK">
        <div class="nombre">CALIDAD BEDROCK</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="CALIDAD_BEDROCK" data-linea="linea1"></div>
        <div class="tiempos" data-grupo="CALIDAD_BEDROCK"></div>
    </div>
</div>
  </div>
  <div class="footer">
    <button class="usuario-btn btn-rojo" onclick="volverAPantalla1()">Cerrar sesiÃ³n</button>
  </div>
</section>

<script>
// ================= CONFIG Y ESTADO =================
// CÃ“DIGO MODIFICADO
const CONFIG = {
    // Lista completa de usuarios, incluyendo el nuevo usuario CALIDAD
    USUARIOS: ['MULTIPORT', 'BEDROCK', 'DROPS', 'LOGÃSTICA', 'SUPERVISOR', 'CALIDAD'],
    // ContraseÃ±as para cada usuario y subusuario
    PASSWORDS: {
        'LOGÃSTICA': 'logistica123',
        'MULTIPORT': 'multiport123',
        'BEDROCK': 'bedrock123',
        'DROPS': 'drops123',
        'SUPERVISOR': 'supervisor123',
        'CALIDAD_MULTIPORT': 'calidadmp123',
        'CALIDAD_DROPS': 'calidaddp123',
        'CALIDAD_BEDROCK': 'calidadbr123'
    },
    // ParÃ¡metros de los LEDs
    LEDS_POR_GRUPO: {
        'MULTIPORT': 5,
        'BEDROCK': 5,
        'DROPS': 5,
        'CALIDAD_MULTIPORT': 5,
        'CALIDAD_BEDROCK': 5,
        'CALIDAD_DROPS': 5
    }
};

let usuarioSeleccionado = null;
let estadoLEDs = {
  MULTIPORT: { linea1:Array(CONFIG.LED_COUNT).fill(false), linea2:Array(CONFIG.LED_COUNT).fill(false) },
  BEDROCK:  { linea1:Array(CONFIG.LED_COUNT).fill(false), linea2:Array(CONFIG.LED_COUNT).fill(false) },
  DROPS:    { linea1:Array(CONFIG.LED_COUNT).fill(false), linea2:Array(CONFIG.LED_COUNT).fill(false) }
};

// ================= FUNCION PARA OBTENER FECHA Y TURNO =================
// CÃ“DIGO MODIFICADO
function obtenerTurnoActual() {
    const ahora = new Date();
    const hora = ahora.getHours() + (ahora.getMinutes() / 60);

    let fecha;
    let turno;

    if (hora >= 6.5 && hora < 18.5) { // 06:30 a 18:30
        turno = 'Turno 1';
        // Para el Turno 1, la fecha es la del dÃ­a actual
        fecha = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
    } else { // 18:30 a 06:30
        turno = 'Turno 2';
        // Para el Turno 2, si la hora es antes de las 06:30, se usa la fecha del dÃ­a anterior
        if (hora < 6.5) {
            fecha = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() - 1);
        } else {
            // Si la hora es despuÃ©s de las 18:30, se usa la fecha del dÃ­a actual
            fecha = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
        }
    }
    
    // Formatea la fecha al formato YYYY-MM-DD
    const year = fecha.getFullYear();
    const month = String(fecha.getMonth() + 1).padStart(2, '0');
    const day = String(fecha.getDate()).padStart(2, '0');
    const fechaFormateada = `${year}-${month}-${day}`;
    
    return { fecha: fechaFormateada, turno };
}

// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
  authDomain: "panel-logistica.firebaseapp.com",
  databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
  projectId: "panel-logistica",
  storageBucket: "panel-logistica.appspot.com",
  messagingSenderId: "38365879945",
  appId: "1:38365879945:web:e2f3590fe77f013dba3058"
};
firebase.initializeApp(firebaseConfig);
// CÃ“DIGO MODIFICADO
const database = firebase.database();
const ledRef = database.ref('estadoLEDs');
let historialRef;
let resumenRef; // <-- Agrega esta lÃ­nea

// ================= AUTENTICACIÃ“N ANÃ“NIMA =================
firebase.auth().signInAnonymously().catch(err=>console.error('Auth error:', err));

// ================= FUNCIONES DE RENDER =================
// CÃ“DIGO MODIFICADO
function inyectaLEDs(){
    // La lÃ³gica de visibilidad de la interfaz se mantiene intacta
    document.querySelectorAll('.grupo').forEach(grupoDiv => {
        grupoDiv.classList.add('oculto');
    });

    if (usuarioSeleccionado === 'SUPERVISOR') {
        document.querySelectorAll('.grupo').forEach(grupoDiv => {
            grupoDiv.classList.remove('oculto');
        });
    } else if (usuarioSeleccionado === 'LOGÃSTICA') {
        document.querySelectorAll('.grupo:not([data-grupo*="CALIDAD_"])').forEach(grupoDiv => {
            grupoDiv.classList.remove('oculto');
        });
    } else if (usuarioSeleccionado.startsWith('CALIDAD_')) {
        document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`).classList.remove('oculto');
    } else {
        document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`).classList.remove('oculto');
        document.querySelector(`.grupo[data-grupo="CALIDAD_${usuarioSeleccionado}"]`).classList.remove('oculto');
    }

    // Esta secciÃ³n SÃ se modifica para solucionar el problema de los 10 LEDs
    document.querySelectorAll('.grupo:not(.oculto) .leds').forEach(contenedor => {
        const grupoLeds = contenedor.dataset.grupo;
        const linea = contenedor.dataset.linea;
        
        // Define el nÃºmero de LEDs por lÃ­nea
        const ledsPorLinea = 5;
        contenedor.innerHTML = '';
        
        for(let i = 0; i < ledsPorLinea; i++){
            const led = document.createElement('div');
            led.className = 'led';
            led.title = `${grupoLeds} â€¢ ${linea} â€¢ LED ${i+1}`;
            led.addEventListener('click', () => togglearLED(grupoLeds, i, linea));
            contenedor.appendChild(led);
        }
    });
}

const ESTADOS_CALIDAD = {
    'naranja': 'proceso',
    'rojo': 'rechazado',
    'verde': 'liberado'
};

function pintarEstado() {
    db.ref('estadoLEDs').on('value', snapshot => {
        const estados = snapshot.val() || {};
        
        document.querySelectorAll('.leds').forEach(contenedor => {
            const grupoLeds = contenedor.dataset.grupo;
            const linea = contenedor.dataset.linea;
            
            if (estados[grupoLeds] && estados[grupoLeds][linea]) {
                const ledsEstado = estados[grupoLeds][linea];
                
                contenedor.querySelectorAll('.led').forEach((led, index) => {
                    if (ledsEstado[index]) {
                        // LÃ³gica para LEDs de Calidad
                        if (grupoLeds.startsWith('CALIDAD_') && ledsEstado[index].color) {
                            led.style.backgroundColor = ledsEstado[index].color;
                        } 
                        // LÃ³gica para LEDs de producciÃ³n
                        else if (ledsEstado[index].encendido) {
                            led.style.backgroundColor = 'green';
                        } else {
                            led.style.backgroundColor = 'gray';
                        }
                    } else {
                        led.style.backgroundColor = 'gray';
                    }
                });
            } else {
                contenedor.querySelectorAll('.led').forEach(led => {
                    led.style.backgroundColor = 'gray';
                });
            }
        });
    });
}


// ================= FIREBASE: sincronizaciÃ³n en tiempo real =================

// FunciÃ³n auxiliar para formatear la hora
function formatoHora(isoString) {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
}

// CÃ“DIGO MODIFICADO
function cargarEstado(){
Â  ledRef.on('value',(snapshot)=>{
Â  Â  const data = snapshot.val();
Â  Â  if(!data) return;
Â  Â  ['MULTIPORT','BEDROCK','DROPS'].forEach(grupo=>{
Â  Â  Â  if(data[grupo]){
Â  Â  Â  Â  ['linea1','linea2'].forEach(linea=>{
Â  Â  Â  Â  Â  if(data[grupo][linea] && typeof data[grupo][linea] === 'object'){
Â  Â  Â  Â  Â  Â  const tempArray = Object.values(data[grupo][linea]);
Â  Â  Â  Â  Â  Â  estadoLEDs[grupo][linea] = tempArray.slice(0, CONFIG.LED_COUNT);
Â  Â  Â  Â  Â  Â  while(estadoLEDs[grupo][linea].length < CONFIG.LED_COUNT) estadoLEDs[grupo][linea].push({encendido: false, timestampEncendido: null});
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  });
Â  Â  pintarEstado();
Â  });
Â  
Â  historialRef.on('value', (snapshot) => {
Â  Â  const logs = snapshot.val();
Â  Â  const contadores = { MULTIPORT: 0, BEDROCK: 0, DROPS: 0 };
Â  Â  const tiempos = { MULTIPORT: [], BEDROCK: [], DROPS: [] };

Â  Â  // Variables para los datos totales
Â  Â  let tarimasTotales = 0;
Â  Â  let tiempoTotalRecoleccion = 0;

Â  Â  if (logs) {
Â  Â  Â  Object.values(logs).forEach(log => {
Â  Â  Â  Â  if (log.accion === 'encendido' && contadores.hasOwnProperty(log.grupo)) {
Â  Â  Â  Â  Â  contadores[log.grupo]++;
Â  Â  Â  Â  } else if (log.accion === 'apagado' && log.tiempoRecoleccion) {
Â  Â  Â  Â  Â  tiempos[log.grupo].push(log);
Â  Â  Â  Â  Â  // Acumula datos para el cÃ¡lculo total
Â  Â  Â  Â  Â  tarimasTotales++;
Â  Â  Â  Â  Â  tiempoTotalRecoleccion += log.tiempoRecoleccion;
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // Calcula el tiempo promedio
Â  Â  const tiempoPromedio = tarimasTotales > 0 ? Math.round(tiempoTotalRecoleccion / tarimasTotales) : 0;
Â  Â Â 
Â  Â  // Actualiza los datos totales en la interfaz
Â  Â  document.getElementById('tarimasTotales').textContent = tarimasTotales;
Â  Â  document.getElementById('tiempoPromedio').textContent = `${tiempoPromedio} min`;

Â  Â  // Muestra u oculta el resumen del turno segÃºn el usuario
Â  Â  const resumenTurnoDiv = document.getElementById('resumenTurno');
Â  Â  if (usuarioSeleccionado === 'LOGÃSTICA' || usuarioSeleccionado === 'SUPERVISOR') {
Â  Â  Â  resumenTurnoDiv.classList.remove('oculto');
Â  Â  } else {
Â  Â  Â  resumenTurnoDiv.classList.add('oculto');
Â  Â  }
Â  Â Â 
Â  Â  // Actualiza los contadores de tarimas por grupo
Â  Â  document.querySelector('.grupo[data-grupo="MULTIPORT"] .tarimas').textContent = `Tarimas: ${contadores.MULTIPORT}`;
Â  Â  document.querySelector('.grupo[data-grupo="BEDROCK"] .tarimas').textContent = `Tarimas: ${contadores.BEDROCK}`;
Â  Â  document.querySelector('.grupo[data-grupo="DROPS"] .tarimas').textContent = `Tarimas: ${contadores.DROPS}`;

Â  Â  // Actualiza los tiempos de recolecciÃ³n en la interfaz
Â  Â  Object.keys(tiempos).forEach(grupo => {
Â  Â  Â  Â  const contenedorTiempos = document.querySelector(`.tiempos[data-grupo="${grupo}"]`);
Â  Â  Â  Â  if (!contenedorTiempos) return;
Â  Â  Â  Â  contenedorTiempos.innerHTML = '';
Â  Â  Â  Â  tiempos[grupo].forEach((logEntry, index) => {
Â  Â  Â  Â  Â  Â  const p = document.createElement('p');
Â  Â  Â  Â  Â  Â  const horaInicio = formatoHora(logEntry.horaEncendido);
Â  Â  Â  Â  Â  Â  const horaFin = formatoHora(logEntry.horaApagado);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  p.textContent = `Tarima ${index + 1}: ${logEntry.tiempoRecoleccion} minutos (${horaInicio} - ${horaFin})`;
Â  Â  Â  Â  Â  Â  contenedorTiempos.appendChild(p);
Â  Â  Â  });
Â  Â  Â  contenedorTiempos.scrollTop = contenedorTiempos.scrollHeight;
Â  Â  });
Â  });
}
// ================= PERMISOS Y LÃ“GICA =================
function puedeControlar(grupo){
    if(!usuarioSeleccionado) {
        return false;
    }
  
    // Si el usuario es SUPERVISOR, no puede controlar nada
    if (usuarioSeleccionado === 'SUPERVISOR') {
        return false;
    }
  
    // LOGÃSTICA puede controlar todos los grupos
    if (usuarioSeleccionado === 'LOGÃSTICA') {
        return true;
    }
  
    // LÃ“GICA CLAVE: Un usuario puede controlar su propio grupo
    // O puede controlar el grupo de Calidad que le corresponde
    if (usuarioSeleccionado === grupo) {
        return true;
    }
    
    // Si el usuario es de producciÃ³n, puede controlar su grupo de Calidad anidado
    if (['MULTIPORT', 'DROPS', 'BEDROCK'].includes(usuarioSeleccionado) && grupo === `CALIDAD_${usuarioSeleccionado}`) {
        return true;
    }

    return false;
}
    
// CÃ“DIGO MODIFICADO
function togglearLED(grupo, idx, linea = 'linea1') {
    if (!puedeControlar(grupo)) {
        return alert('No tienes permiso para controlar estos LEDs');
    }

    let accion = '';
    const ledRef = db.ref('estadoLEDs/' + grupo + '/' + linea + '/' + idx);

    // LÃ³gica para Calidad
    if (grupo.startsWith('CALIDAD_')) {
        const estado = prompt("Selecciona el estado de la tarima: \nğŸŸ¡ En proceso \nğŸ”´ Rechazada \nğŸŸ¢ Liberada");

        if (estado) {
            const estadoLowerCase = estado.toLowerCase().trim();
            let nuevoColor = null;

            if (estadoLowerCase.includes('proceso')) {
                nuevoColor = 'naranja';
            } else if (estadoLowerCase.includes('rechazada')) {
                nuevoColor = 'rojo';
            } else if (estadoLowerCase.includes('liberada')) {
                nuevoColor = 'verde';
            } else {
                alert("Estado no vÃ¡lido. Intenta con las opciones sugeridas.");
                return;
            }

            // Actualiza el estado en Firebase
            ledRef.set({
                color: nuevoColor,
                timestamp: new Date().toISOString(),
                usuario: usuarioSeleccionado
            });

            // NotificaciÃ³n para el usuario de producciÃ³n si es rechazada
            if (nuevoColor === 'rojo') {
                const usuarioProduccion = grupo.split('_')[1];
                notificarRechazo(usuarioProduccion);
            }
        }
    } else { // LÃ³gica para ProducciÃ³n y LogÃ­stica
        let tiempoRecoleccion = null;
        let horaEncendido = null;
        let horaApagado = null;
        
        // Obtiene el estado actual del LED directamente desde la base de datos
        ledRef.once('value', snapshot => {
            const estadoActual = snapshot.val() || {};

            if (usuarioSeleccionado === 'LOGÃSTICA') {
                if (estadoActual.encendido) {
                    if (!confirm('Â¿EstÃ¡ realmente recolectada la tarima?')) {
                        return;
                    }

                    const tiempoEncendido = new Date(estadoActual.timestamp);
                    const tiempoApagado = new Date();
                    const diferencia = (tiempoApagado - tiempoEncendido) / 60000;
                    tiempoRecoleccion = Math.round(diferencia);
                    
                    horaEncendido = estadoActual.timestamp;
                    horaApagado = tiempoApagado.toISOString();

                    ledRef.set({
                        encendido: false,
                        timestamp: tiempoApagado.toISOString()
                    });
                    
                    accion = 'apagado';
                    actualizarResumen();
                    
                    // Crea un objeto de registro y lo guarda en Firebase
                    const log = {
                        usuario: usuarioSeleccionado,
                        grupo: grupo,
                        led: `${linea}-${idx+1}`,
                        accion: accion,
                        timestamp: new Date().toISOString(),
                        tiempoRecoleccion: tiempoRecoleccion,
                        horaEncendido: horaEncendido,
                        horaApagado: horaApagado
                    };
                    historialRef.push(log).catch(e => console.warn('Error guardando log en Firebase:', e));
                } else {
                    alert('LOGÃSTICA solo puede apagar LEDs');
                }
            } else { // LÃ³gica para los usuarios de ProducciÃ³n
                if (!estadoActual.encendido) {
                    if (!confirm('Â¿EstÃ¡ realmente confirmada la tarima?')) {
                        return;
                    }
                    ledRef.set({
                        encendido: true,
                        timestamp: new Date().toISOString(),
                        usuario: usuarioSeleccionado
                    });

                    accion = 'encendido';
                    actualizarResumen();
                    
                    const log = {
                        usuario: usuarioSeleccionado,
                        grupo: grupo,
                        led: `${linea}-${idx+1}`,
                        accion: accion,
                        timestamp: new Date().toISOString(),
                        tiempoRecoleccion: null,
                        horaEncendido: new Date().toISOString(),
                        horaApagado: null
                    };
                    historialRef.push(log).catch(e => console.warn('Error guardando log en Firebase:', e));
                } else {
                    return;
                }
            }
        });
    }
}
// CÃ“DIGO A AGREGAR
function actualizarResumen() {
    // Carga los datos actuales del resumen
    resumenRef.once('value').then(snapshot => {
        const resumenActual = snapshot.val() || {
            tarimasConfirmadas: 0,
            tarimasRecibidas: 0,
            tiemposRecoleccion: [],
            totalPorArea: { MULTIPORT: 0, BEDROCK: 0, DROPS: 0 }
        };

        // Recorre el historial para recalcular el resumen (para mayor seguridad)
        historialRef.once('value').then(historialSnapshot => {
            const logs = historialSnapshot.val();
            let tarimasConfirmadas = 0;
            let tarimasRecibidas = 0;
            const tiemposRecoleccion = [];
            const totalPorArea = { MULTIPORT: 0, BEDROCK: 0, DROPS: 0 };

            if (logs) {
                Object.values(logs).forEach(log => {
                    if (log.accion === 'encendido' && totalPorArea.hasOwnProperty(log.grupo)) {
                        tarimasConfirmadas++;
                    } else if (log.accion === 'apagado' && log.tiempoRecoleccion) {
                        tarimasRecibidas++;
                        tiemposRecoleccion.push(log.tiempoRecoleccion);
                        if (totalPorArea.hasOwnProperty(log.grupo)) {
                            totalPorArea[log.grupo]++;
                        }
                    }
                });
            }

            // Guarda el nuevo resumen en la base de datos
            resumenRef.set({
                tarimasConfirmadas: tarimasConfirmadas,
                tarimasRecibidas: tarimasRecibidas,
                tiemposRecoleccion: tiemposRecoleccion,
                totalPorArea: totalPorArea
            }).catch(e => console.warn('Error guardando resumen en Firebase:', e));
        });
    });
}
    
// ================= NAVEGACIÃ“N =================
function activarPantalla(id){
  document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa'));
  document.getElementById(id).classList.add('activa');
}

function volverAPantalla1(){
    usuarioSeleccionado = null;
    activarPantalla('pantalla1');
}

function seleccionarUsuario(usuario) {
    if (!CONFIG.USUARIOS.includes(usuario)) {
        return;
    }

function notificarRechazo(usuarioProduccion) {
    if (usuarioSeleccionado === usuarioProduccion) {
        alert("ğŸš¨ Â¡ATENCIÃ“N! Calidad ha RECHAZADO una tarima en tu Ã¡rea.");
    }
}
    // LÃ³gica para el usuario SUPERVISOR
    if (usuario === 'SUPERVISOR') {
        usuarioSeleccionado = usuario;
        document.getElementById('tituloFijo').textContent = 'SUPERVISOR';
        activarPantalla('pantalla2');
        inyectaLEDs();
        cargarEstado();
        alert(`Â¡Bienvenido, ${usuario}!`);

    // LÃ³gica para el nuevo usuario CALIDAD
    } else if (usuario === 'CALIDAD') {
        const password = prompt('Introduce la contraseÃ±a para CALIDAD:');
        let subusuario = null;
        
        // Verifica la contraseÃ±a para determinar el subusuario de Calidad
        if (password === CONFIG.PASSWORDS['CALIDAD_MULTIPORT']) {
            subusuario = 'CALIDAD_MULTIPORT';
        } else if (password === CONFIG.PASSWORDS['CALIDAD_DROPS']) {
            subusuario = 'CALIDAD_DROPS';
        } else if (password === CONFIG.PASSWORDS['CALIDAD_BEDROCK']) {
            subusuario = 'CALIDAD_BEDROCK';
        }

        // Si la contraseÃ±a fue correcta, procede con el subusuario
        if (subusuario) {
            usuarioSeleccionado = subusuario;
            // El tÃ­tulo muestra "CALIDAD" y el nombre del subgrupo (MP, DROPS, BR)
            document.getElementById('tituloFijo').textContent = `CALIDAD - ${subusuario.split('_')[1]}`;
            activarPantalla('pantalla2');
            inyectaLEDs();
            cargarEstado();
            alert(`Â¡Bienvenido, ${subusuario.replace('_', ' ')}!`);
        } else {
            alert('ContraseÃ±a incorrecta. IntÃ©ntalo de nuevo.');
        }

    // LÃ³gica para los demÃ¡s usuarios (LOGÃSTICA, MULTIPORT, DROPS, BEDROCK)
    } else {
        const password = prompt(`Introduce la contraseÃ±a para ${usuario}:`);
        if (password === CONFIG.PASSWORDS[usuario]) {
            usuarioSeleccionado = usuario;
            if (usuario === 'LOGÃSTICA') {
                document.getElementById('tituloFijo').textContent = 'LOGÃSTICA';
            } else {
                document.getElementById('tituloFijo').textContent = usuario;
            }
            activarPantalla('pantalla2');
            inyectaLEDs();
            cargarEstado();
            alert(`Â¡Bienvenido, ${usuario}!`);
        } else {
            alert('ContraseÃ±a incorrecta. IntÃ©ntalo de nuevo.');
        }
    }
}

// ================= ARRANQUE Y PWA: Service Worker =================
window.addEventListener('load', ()=>{
    const { fecha, turno } = obtenerTurnoActual();
    historialRef = database.ref(`historialLogs/${fecha}/${turno}`);
    resumenRef = database.ref(`resumenDiario/${fecha}/${turno}`); // <-- Agrega esta lÃ­nea

    usuarioSeleccionado = null;
    activarPantalla('pantalla1');
    inyectaLEDs();
    cargarEstado();

    // Registro del Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => {
                console.log("âœ… Service Worker registrado:", reg);
            })
            .catch(err => {
                console.error("âŒ Error al registrar Service Worker:", err);
            });
    }
});
</script>
</body>
</html>
