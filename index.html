<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel LogÃ­stica</title>
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
Â  /* Paleta de Colores Profesional */
Â  --bg-dark: #111827; Â  Â  Â /* Azul Marino Oscuro (Fondo Principal) */
Â  --bg-medium: #1F2937; Â  Â /* Gris Azulado Oscuro (Tarjetas y Paneles) */
Â  --bg-light: #374151; Â  Â  /* Gris Azulado Claro (Bordes, Hover) */
Â  --text-light: #F9FAFB; Â  /* Blanco Hueso (Texto Principal) */
Â  --text-medium: #9CA3AF; /* Gris Claro (Texto Secundario, Etiquetas) */
Â  --text-dark: #1F2937; Â  Â /* Texto para fondos claros */
Â  --accent-blue: #3B82F6; Â  /* Azul Principal (Botones, Ã‰nfasis) */
Â  --accent-blue-hover: #2563EB;
Â  --accent-green: #10B981; Â /* Verde Esmeralda (Ã‰xito, Liberado) */
Â  --accent-red: #EF4444; Â  Â /* Rojo (Peligro, Rechazado) */
Â  --accent-orange: #F59E0B; /* Ãmbar (Advertencia, En Proceso) */
Â Â 
Â  /* Estilos de LED */
Â  --led-size: 50px;
Â  --led-gap: 16px;
Â  --led-off-core: #2d3748;
Â  --led-off-edge: #1a202c;
Â  --glow-green: rgba(16, 185, 129, 0.7);
Â  --glow-red: rgba(239, 68, 68, 0.7);
Â  --glow-orange: rgba(245, 158, 11, 0.7);
Â  --blink-duration: 1.2s;

Â  /* TipografÃ­a */
Â  --font-family: 'Poppins', Arial, Helvetica, sans-serif;
Â  --titulo-size: clamp(28px, 5vw, 48px); /* MODIFICADO */

Â  /* Otros */
Â  --border-radius-md: 16px;
Â  --border-radius-sm: 10px;
Â  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
Â  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
}

* { box-sizing: border-box; }

html, body {
Â  height: 100%;
Â  margin: 0;
Â  font-family: var(--font-family);
Â  color: var(--text-light);
Â  background-color: var(--bg-dark);
Â  background-image:Â 
Â  Â  radial-gradient(at 47% 33%, hsl(225, 39%, 30%) 0, transparent 59%),Â 
Â  Â  radial-gradient(at 82% 65%, hsl(253, 16%, 7%) 0, transparent 55%);
}

.pantalla {
Â  display: none;
Â  width: 100%;
Â  min-height: 100vh;
Â  padding: 20px;
Â  transition: opacity 0.5s ease-out;
}
.pantalla.activa { display: flex; flex-direction: column; }

/* ================= BRANDING HEADER ================= */
.brand-title {
Â  font-family: 'Times New Roman', Times, serif;
Â  color: white;
Â  font-size: clamp(40px, 3vw, 28px);
Â  font-weight: normal;
Â  text-align: center;
Â  width: 100%;
Â  letter-spacing: 2px;
Â  margin-top: 10px;
Â  margin-bottom: 5px;
Â  padding: 0;
}

/* ================= SPLASH SCREEN ================= */
#splashScreen {
Â  align-items: center;
Â  justify-content: center;
Â  background-color: var(--bg-dark);
}
.splash-content {
Â  text-align: center;
Â  display: flex;
Â  flex-direction: column;
Â  align-items: center;
Â  gap: 15px;
}
.splash-logo-container {
Â  border-radius: 25px;
Â  margin: 20px 0;
Â  padding: 15px;
Â  background: rgba(255, 255, 255, 0.1);
Â  backdrop-filter: blur(8px);
Â  -webkit-backdrop-filter: blur(8px);
Â  border: 1px solid rgba(255, 255, 255, 0.15);
Â  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
}
.splash-logo {
Â  width: 150px;
Â  height: auto;
Â  display: block;
Â  border-radius: 15px;
}
.splash-loading {
Â  font-size: 1.2rem;
Â  color: var(--text-medium);
Â  letter-spacing: 2px;
}
.splash-loading .dot {
Â  animation: blink-dot 1.4s infinite;
Â  opacity: 0;
}
.splash-loading .dot:nth-child(2) { animation-delay: 0.2s; }
.splash-loading .dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink-dot { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }

/* ================= PANTALLA 1: SELECCIÃ“N DE USUARIO ================= */
#pantalla1 {
Â  align-items: center;
Â  justify-content: center;
Â  gap: 24px;
}
#pantalla1 .brand-header { text-align: center; }
#pantalla1 h1 {
Â  margin: 0;
Â  font-size: clamp(32px, 5vw, 48px);
Â  font-weight: 700;
Â  color: var(--text-light);
}
.login-columns-container {
Â  display: flex;
Â  justify-content: center;
Â  gap: 20px;
Â  width: 100%;
Â  max-width: 600px;
Â  flex-wrap: wrap;
}
.login-column {
Â  display: flex;
Â  flex-direction: column;
Â  gap: 16px;
Â  flex: 1;
Â  min-width: 250px;
}
.login-column .usuario-btn { width: 100%; }
.btn-contenedor {
Â  display: flex;
Â  flex-wrap: wrap;
Â  justify-content: center;
Â  gap: 16px;
Â  max-width: 800px;
}
.usuario-btn {
Â  background: rgba(59, 130, 246, 0.25);
Â  backdrop-filter: blur(10px);
Â  -webkit-backdrop-filter: blur(10px);
Â  color: var(--text-light);
Â  border: 1px solid rgba(255, 255, 255, 0.15);
Â  padding: 14px 28px;
Â  border-radius: var(--border-radius-sm);
Â  font-size: 16px;
Â  font-weight: 600;
Â  cursor: pointer;
Â  transition: background .2s ease, transform .2s ease, box-shadow .2s ease;
Â  box-shadow: var(--shadow-md);
}
.usuario-btn:hover {
Â  background: rgba(59, 130, 246, 0.4);
Â  transform: translateY(-2px);
Â  box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
}
.btn-rojo { background: rgba(239, 68, 68, 0.25); }
.btn-rojo:hover { background: rgba(239, 68, 68, 0.4); }

.usuario-btn.btn-management {
Â  background: rgba(107, 114, 128, 0.25);
Â  border-color: rgba(107, 114, 128, 0.4);
}
.usuario-btn.btn-management:hover {
Â  background: rgba(107, 114, 128, 0.4);
Â  box-shadow: 0 0 15px rgba(107, 114, 128, 0.3);
}

/* ================= PANTALLA 2: PANEL PRINCIPAL ================= */
#pantalla2 { gap: 10px; }
.header {
Â  position: relative;
Â  display: flex;
Â  flex-direction: column;
Â  align-items: center;
Â  justify-content: center;
Â  padding: 0 10px;
Â  width: 100%;
}
#tituloFijo {
Â  font-weight: 700;
Â  text-align: center;
Â  font-size: var(--titulo-size);
Â  color: var(--text-light);
}
#turnoActual {
Â  font-size: 0.8rem; /* MODIFICADO */
Â  font-weight: 600;
Â  padding: 3px 10px; /* MODIFICADO */
Â  border-radius: var(--border-radius-sm);
Â  margin-top: 4px;
Â  background: rgba(31, 41, 55, 0.5);
Â  backdrop-filter: blur(12px);
Â  -webkit-backdrop-filter: blur(12px);
Â  border: 1px solid rgba(255, 255, 255, 0.1);
}
.zona-centro {
Â  flex: 1;
Â  display: flex;
Â  flex-direction: column;
Â  align-items: center;
Â  width: 100%;
Â  gap: 15px;
Â  margin-top: 15px;
}
.resumen-turno {
Â  display: flex;
Â  justify-content: center;
Â  gap: 25px;
Â  padding: 12px 20px;
Â  width: 100%;
Â  max-width: 500px;
Â  border-radius: var(--border-radius-md);
Â  background: rgba(31, 41, 55, 0.5);
Â  backdrop-filter: blur(12px);
Â  -webkit-backdrop-filter: blur(12px);
Â  border: 1px solid rgba(255, 255, 255, 0.1);
}
.resumen-turno.oculto { display: none; }
.dato-resumen .etiqueta {
Â  font-size: 12px;
Â  color: var(--text-medium);
Â  text-transform: uppercase;
Â  margin-bottom: 4px;
Â  font-weight: 600;
}
.dato-resumen .valor {
Â  font-size: 26px;
Â  font-weight: 700;
Â  color: var(--text-light);
}
/* INICIO: Filtro Supervisor MODIFICADO */
.filtro-supervisor-container {
Â  Â  display: none;
Â  Â  justify-content: center;
Â  Â  gap: 8px;
Â  Â  align-items: center;
Â  Â  margin-bottom: 15px;
Â  Â  padding: 6px 10px;
Â  Â  border-radius: var(--border-radius-md);
Â  Â  background: rgba(31, 41, 55, 0.5);
Â  Â  backdrop-filter: blur(12px);
Â  Â  -webkit-backdrop-filter: blur(12px);
Â  Â  border: 1px solid rgba(255, 255, 255, 0.1);
Â  Â  max-width: 320px;
}
.filtro-supervisor-container.visible {
Â  Â  display: flex;
}
.filtro-supervisor-container label {
Â  Â  font-size: 13px;
Â  Â  font-weight: 600;
Â  Â  color: var(--text-medium);
}
.filtro-supervisor-container select {
Â  Â  padding: 5px 8px;
Â  Â  border-radius: var(--border-radius-sm);
Â  Â  background-color: rgba(17, 24, 39, 0.7);
Â  Â  border: 1px solid rgba(255, 255, 255, 0.1);
Â  Â  color: var(--text-light);
Â  Â  font-family: var(--font-family);
Â  Â  font-size: 13px;
}
/* FIN: Filtro Supervisor MODIFICADO */
.filtro-supervisor-container select:focus {
Â  Â  outline: none;
Â  Â  border-color: var(--accent-blue);
Â  Â  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
}
.grupo-contenedor {
Â  display: flex;
Â  flex-wrap: wrap;
Â  gap: 24px;
Â  width: 100%;
Â  max-width: 1400px;
Â  justify-content: center;
}
.grupo {
Â  display: flex;
Â  flex-direction: column;
Â  align-items: center;
Â  text-align: center;
Â  padding: 24px;
Â  flex-grow: 0;Â 
Â  width: auto;Â 
Â  min-width: 300px;
Â  transition: transform 0.2s ease, box-shadow 0.2s ease;
Â  border-radius: var(--border-radius-md);
Â  background-color: #18181a;
Â  background-image: radial-gradient(circle at center, rgba(0,0,0,0.4) 2px, transparent 3px);
Â  background-size: 12px 12px;
Â  border: 1px solid rgba(255, 255, 255, 0.1);
Â  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.6);
}
.grupo:hover {
Â  transform: translateY(-5px);
Â  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.6), 0 0 20px rgba(59, 130, 246, 0.1);
}
.grupo.oculto { display: none; }
.grupo .nombre {
Â  font-size: clamp(20px, 2.2vw, 26px);
Â  font-weight: 700;
Â  margin-bottom: 8px;
}
.grupo .tarimas {
Â  font-size: clamp(16px, 1.7vw, 18px);
Â  color: var(--text-medium);
Â  margin-bottom: 20px;
}
.leds {
Â  display: flex;
Â  gap: var(--led-gap);
Â  justify-content: center;
Â  align-items: center;
Â  margin-bottom: 10px;
}
.led {
Â  width: var(--led-size);
Â  height: var(--led-size);
Â  border-radius: 50%;
Â  cursor: pointer;
Â  background: radial-gradient(circle at 45% 40%, var(--led-off-core) 40%, var(--led-off-edge) 100%);
Â  border: 2px solid var(--led-off-edge);
Â  transition: all .2s ease;
Â  display: flex;
Â  flex-direction: column;
Â  justify-content: center;
Â  align-items: center;
Â  color: var(--text-light);
Â  line-height: 1;
Â  font-size: 11px;
Â  font-weight: bold;
Â  text-shadow: 0 0 3px #000;
}
.led:active { transform: scale(.96); }
.led.on {
Â  background: radial-gradient(circle at 48% 45%, #6EE7B7 40%, var(--accent-green) 100%);
Â  box-shadow: 0 0 22px var(--glow-green);
Â  border-color: var(--accent-green);
Â  animation: blink var(--blink-duration) ease-in-out infinite;
}
.led span {
Â  Â  line-height: 1;
Â  Â  text-align: center;
}
.led .tarima-id {
Â  Â  color: var(--text-dark);
Â  Â  text-shadow: none;
Â  Â  font-size: 16px;
Â  Â  font-weight: 700;
}
.led .tiempo-transcurrido {
Â  Â  color: var(--text-dark);
Â  Â  text-shadow: none;
}
.led .tarima-id + .tiempo-transcurrido {
Â  Â  margin-top: 3px;
}
.led .tarima-id + .tiempo-transcurrido b {
Â  Â  font-size: 14px;
}
.led .tarima-id + .tiempo-transcurrido small {
Â  Â  font-size: 8px;
Â  Â  display: block;
}
.led .tiempo-transcurrido b {
Â  Â  font-size: 18px;
Â  Â  font-weight: 700;
}
.led .tiempo-transcurrido small {
Â  Â  display: block;
Â  Â  font-size: 10px;
Â  Â  font-weight: 600;
Â  Â  text-transform: uppercase;
}
.led.naranja {
Â  background: radial-gradient(circle at 48% 45%, #FBBF24 40%, var(--accent-orange) 100%);
Â  box-shadow: 0 0 22px var(--glow-orange);
Â  border-color: var(--accent-orange);
}
.led.rojo {
Â  background: radial-gradient(circle at 48% 45%, #F87171 40%, var(--accent-red) 100%);
Â  box-shadow: 0 0 22px var(--glow-red);
Â  border-color: var(--accent-red);
}
.led.verde {
Â  background: radial-gradient(circle at 48% 45%, #6EE7B7 40%, var(--accent-green) 100%);
Â  box-shadow: 0 0 22px var(--glow-green);
Â  border-color: var(--accent-green);
}
.led.disabled { cursor: not-allowed; opacity: 0.6; }

.tiempos {
Â  margin-top: 10px;
Â  font-size: 14px;
Â  color: var(--text-medium);
Â  text-align: left;
Â  width: 100%;
Â  max-height: 150px;
Â  overflow-y: auto;
Â  background-color: rgba(0, 0, 0, 0.2);
Â  padding: 10px;
Â  border-radius: var(--border-radius-sm);
Â  border-top: 1px solid rgba(255,255,255,0.1);
}
.tiempos p {Â 
Â  Â  margin: 0 0 8px;Â 
Â  Â  line-height: 1.3;
}
.tiempos p:last-child {
Â  Â  margin-bottom: 0;
}
.tiempos small {
Â  Â  font-size: 0.8em;
Â  Â  color: var(--text-medium);
}
.contadores-calidad {
Â  display: flex;
Â  gap: 30px;
Â  margin-top: 10px;
}
.contador-calidad {
Â  text-align: center;
Â  font-weight: 600;
}
.contador-calidad .valor { font-size: 24px; font-weight: 700; }
.contador-calidad .etiqueta { font-size: 12px; color: var(--text-medium); }
.footer { width: 100%; display: flex; justify-content: center; padding: 20px 0 0; }
.footer .usuario-btn { padding: 10px 20px; font-size: 16px; }

@keyframes blink { 50% { box-shadow: 0 0 35px var(--glow-green); } }

/* ================= MODALES ESTILO GLASS ================= */
.modal, .modal-calidad, .modal-produccion, .custom-modal-overlay {
Â  position: fixed;
Â  top: 0;
Â  left: 0;
Â  width: 100%;
Â  height: 100%;
Â  background-color: rgba(0, 0, 0, 0.5);
Â  backdrop-filter: blur(5px);
Â  -webkit-backdrop-filter: blur(5px);
Â  display: flex;
Â  justify-content: center;
Â  align-items: center;
Â  z-index: 1000;
Â  visibility: hidden;
Â  opacity: 0;
Â  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.modal.visible, .modal-calidad.visible, .modal-produccion.visible, .custom-modal-overlay.visible {Â 
Â  Â  visibility: visible;Â 
Â  Â  opacity: 1;Â 
}
.modal-content, .custom-modal {
Â  padding: 30px;
Â  text-align: center;
Â  width: 90%;
Â  max-width: 500px;
Â  box-shadow: var(--shadow-lg);
Â  border-radius: var(--border-radius-md);
Â  background: rgba(31, 41, 55, 0.7);
Â  backdrop-filter: blur(15px);
Â  -webkit-backdrop-filter: blur(15px);
Â  border: 1px solid rgba(255, 255, 255, 0.15);
Â  transform: scale(0.9);
Â  transition: transform 0.3s ease;
}

.visible .modal-content, .visible .custom-modal {
Â  Â  transform: scale(1);
}

.modal-content h3, .custom-modal h3 {
Â  margin-top: 0;
Â  font-size: 22px;
Â  margin-bottom: 25px;
}

#modalCalidad .opciones {
Â  display: flex;
Â  flex-direction: column;
Â  gap: 15px;
Â  margin-bottom: 25px;
}
#modalCalidad .opcion-btn {
Â  padding: 15px 25px;
Â  font-size: 18px;
Â  font-weight: 600;
Â  border: 1px solid rgba(255, 255, 255, 0.15);
Â  border-radius: var(--border-radius-sm);
Â  cursor: pointer;
Â  transition: background 0.2s ease, transform 0.2s ease;
Â  color: #fff;
Â  backdrop-filter: blur(10px);
Â  -webkit-backdrop-filter: blur(10px);
}
#modalCalidad .opcion-btn:hover { transform: scale(1.02); }
#modalCalidad .opcion-btn[data-color="rojo"] { background: rgba(239, 68, 68, 0.3); }
#modalCalidad .opcion-btn[data-color="rojo"]:hover { background: rgba(239, 68, 68, 0.5); }
#modalCalidad .opcion-btn[data-color="verde"] { background: rgba(16, 185, 129, 0.3); }
#modalCalidad .opcion-btn[data-color="verde"]:hover { background: rgba(16, 185, 129, 0.5); }

#modalCalidad .cerrar-btn {
Â  background: rgba(55, 65, 81, 0.4);
Â  color: var(--text-light);
Â  border: 1px solid rgba(255, 255, 255, 0.1);
Â  padding: 10px 20px;
Â  border-radius: var(--border-radius-sm);
Â  cursor: pointer;
Â  font-weight: 600;
Â  backdrop-filter: blur(5px);
}
#modalCalidad .cerrar-btn:hover { background: rgba(75, 85, 99, 0.6); }

#modalRechazo .modal-content, #modalAsignarTarimaProduccion .modal-content, #pantalla5 .modal-content {
Â  text-align: left;
Â  max-height: 85vh; Â 
Â  overflow-y: auto;
}
#modalRechazo form, #modalAsignarTarimaProduccion, #formAjustes { display: flex; flex-direction: column; gap: 15px; }
#modalRechazo label, #modalAsignarTarimaProduccion label, #formAjustes label { font-size: 14px; margin-bottom: 5px; display: block; color: var(--text-medium); }
#modalRechazo input, #modalRechazo textarea, #modalAsignarTarimaProduccion select, #contraseÃ±aInput, #formAjustes input {
Â  width: 100%;
Â  padding: 12px;
Â  border-radius: var(--border-radius-sm);
Â  color: var(--text-light);
Â  font-size: 16px;
Â  font-family: var(--font-family);
Â  background: rgba(17, 24, 39, 0.5);
Â  border: 1px solid rgba(255, 255, 255, 0.1);
}
#modalRechazo input:focus, #modalRechazo textarea:focus, #modalAsignarTarimaProduccion select:focus, #contraseÃ±aInput:focus, #formAjustes input:focus {
Â  Â  outline: none;
Â  Â  border-color: var(--accent-blue);
Â  Â  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
}
#modalRechazo textarea { resize: vertical; min-height: 80px; }

.custom-modal p {
Â  font-size: 16px;
Â  color: var(--text-medium);
Â  margin-bottom: 25px;
Â  line-height: 1.6;
}
.custom-modal-actions {
Â  display: flex;
Â  justify-content: flex-end;
Â  gap: 15px;
Â  margin-top: 20px;
}
.custom-modal-actions button {
Â  Â  padding: 10px 20px;
Â  Â  font-size: 16px;
}
.modal-actions {
Â  display: flex;
Â  justify-content: flex-end;
Â  gap: 15px;
Â  margin-top: 20px;
}
.modal-actions button {
Â  Â  padding: 12px 24px;
}
/* ================= PANTALLA 3: REPORTES (TEMA CLARO) ================= */
#pantalla3 {
Â  background-color: #f4f7f9;
Â  background-image:Â 
Â  Â  radial-gradient(at 0% 0%, hsla(210, 40%, 98%, 1) 0, transparent 50%),
Â  Â  radial-gradient(at 50% 100%, hsla(200, 50%, 90%, 1) 0, transparent 50%);
Â  color: var(--text-dark);
Â  align-items: center;
Â  justify-content: flex-start;
Â  gap: 10px;
}
#pantalla3 .zona-centro { margin-top: 0; }
#pantalla3 .brand-title,
#pantalla3 .header h1,
#pantalla3 .header-reporte h2,
#pantalla3 .titulo-selector-reporte { color: var(--text-dark); }
#pantalla3 .contenedor-reporte {
Â  box-shadow: var(--shadow-lg);
Â  color: var(--text-dark);
Â  padding: 20px;
Â  width: 100%;
Â  max-width: 1400px;
Â  margin-top: 20px;
Â  border-radius: var(--border-radius-md);
Â  background-color: rgba(255, 255, 255, 0.65);
Â  backdrop-filter: blur(12px);
Â  -webkit-backdrop-filter: blur(12px);
Â  border: 1px solid rgba(255, 255, 255, 0.3);
}
#pantalla3 .header-reporte {
Â  display: flex;
Â  align-items: center;
Â  flex-wrap: wrap;
Â  gap: 15px;
Â  justify-content: space-between;
Â  margin-bottom: 20px;
}
#pantalla3 .header-reporte .filtros {
Â  display: flex;
Â  flex-wrap: wrap;
Â  gap: 10px;
Â  align-items: center;
}
#pantalla3 .header-reporte .filtros label { font-size: 14px; color: #64748b; }
#pantalla3 .header-reporte .filtros input,
#pantalla3 .header-reporte .filtros select {
Â  padding: 8px;
Â  border-radius: var(--border-radius-sm);
Â  background-color: rgba(255, 255, 255, 0.5);
Â  color: var(--text-dark);
Â  border: 1px solid #cbd5e1;
Â  font-size: 14px;
}
#pantalla3 .header-reporte .filtros input:focus,
#pantalla3 .header-reporte .filtros select:focus,
#pantalla3 .botones-reporte select:focus {
Â  border-color: var(--accent-blue);
Â  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
Â  outline: none;
}
#pantalla3 .usuario-btn {
Â  Â  color: var(--text-dark);
Â  Â  background: rgba(59, 130, 246, 0.15);
Â  Â  border-color: rgba(59, 130, 246, 0.2);
Â  Â  backdrop-filter: blur(5px);
Â  Â  -webkit-backdrop-filter: blur(5px);
}
#pantalla3 .usuario-btn:hover { background: rgba(59, 130, 246, 0.25); }
#pantalla3 .btn-rojo {
Â  Â  background: rgba(239, 68, 68, 0.15);
Â  Â  border-color: rgba(239, 68, 68, 0.2);
}
#pantalla3 .btn-rojo:hover { background: rgba(239, 68, 68, 0.25); }

#pantalla3 .botones-reporte {
Â  Â  display: flex;
Â  Â  gap: 10px;
Â  Â  align-items: center;
Â  Â  justify-content: flex-start;
Â  Â  margin-top: 20px;
}

#pantalla3 .botones-reporte select {
Â  Â  padding: 8px;
Â  Â  border-radius: var(--border-radius-sm);
Â  Â  background-color: rgba(255, 255, 255, 0.5);
Â  Â  color: var(--text-dark);
Â  Â  border: 1px solid #cbd5e1;
Â  Â  font-size: 14px;
Â  Â  font-family: var(--font-family);
}

#pantalla3 table {
Â  width: 100%;
Â  border-collapse: collapse;
Â  margin-top: 20px;
Â  color: var(--text-dark);
Â  display: table;
}
#pantalla3 th, #pantalla3 td {
Â  border-bottom: 1px solid #e2e8f0;
Â  padding: 12px;
Â  text-align: left;
Â  font-size: 0.9em;
Â  vertical-align: top;
}
#pantalla3 thead {
Â  background-color: rgba(241, 245, 249, 0.7);
Â  color: #334155;
Â  font-weight: 600;
}
#pantalla3 tbody tr:hover { background-color: rgba(248, 250, 252, 0.8); }
#pantalla3 .resumen-datos {
Â  display: flex;
Â  flex-wrap: wrap;
Â  justify-content: center;
Â  gap: 20px;
Â  margin-bottom: 20px;
}
#pantalla3 .dato {
Â  background-color: rgba(248, 250, 252, 0.7);
Â  border: 1px solid #e2e8f0;
Â  box-shadow: var(--shadow-md);
Â  padding: 15px;
Â  border-radius: var(--border-radius-sm);
Â  text-align: center;
Â  min-width: 150px;
}
#pantalla3 .dato .valor {
Â  font-size: 24px;
Â  font-weight: 700;
Â  color: var(--accent-blue);
}
#pantalla3 .dato .etiqueta {
Â  font-size: 12px;
Â  text-transform: uppercase;
Â  color: #64748b;
}
.grafico-contenedor {
Â  width: 100%;
Â  max-width: 700px;
Â  margin: 30px auto;
}
.reporte-calidad-mobile { display: none; }


/* ================= PANTALLA 4: DASHBOARD ================= */
#pantalla4 {
Â  background-color: transparent;
Â  color: var(--text-light);
Â  padding: 20px;
Â  flex-direction: column;
Â  gap: 20px;
Â  align-items: center;
Â  overflow-y: auto;
}
#pantalla4 > * {
Â  Â  width: 100%;
Â  Â  max-width: 1400px;
}
#pantalla4 .header { text-align: center; }
#pantalla4 .filtros-dashboard {
Â  display: flex;
Â  justify-content: center;
Â  gap: 15px;
Â  align-items: center;
Â  flex-wrap: wrap;
}
#pantalla4 .filtros-dashboard label { font-size: 14px; color: var(--text-medium); }
#pantalla4 .filtros-dashboard input,
#pantalla4 .filtros-dashboard select {
Â  padding: 8px;
Â  border-radius: var(--border-radius-sm);
Â  background-color: rgba(31, 41, 55, 0.5);
Â  border: 1px solid rgba(255, 255, 255, 0.1);
Â  color: var(--text-light);
}
#pantalla4 .kpis-grid {
Â  display: grid;
Â  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
Â  gap: 20px;
}
#pantalla4 .kpi-card {
Â  padding: 25px;
Â  text-align: center;
Â  transition: transform 0.2s ease, box-shadow 0.2s ease;
Â  border-radius: var(--border-radius-md);
Â  background: rgba(31, 41, 55, 0.5);
Â  backdrop-filter: blur(12px);
Â  -webkit-backdrop-filter: blur(12px);
Â  border: 1px solid rgba(255, 255, 255, 0.1);
}
#pantalla4 .kpi-card:hover {
Â  Â  transform: translateY(-5px);
Â  Â  box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
}
#pantalla4 .kpi-card h3 {
Â  margin-top: 0;
Â  font-size: 1rem;
Â  color: var(--text-medium);
Â  text-transform: uppercase;
Â  font-weight: 600;
}
#pantalla4 .kpi-card .valor {
Â  font-size: 3rem;
Â  font-weight: 700;
Â  color: var(--text-light);
Â  transition: color 0.3s ease;
Â  margin-top: 10px;
}
#pantalla4 .kpi-card.alerta .valor { color: var(--accent-red); }

.dashboard-row {
Â  Â  display: flex;
Â  Â  flex-wrap: wrap;
Â  Â  gap: 20px;
Â  Â  width: 100%;
}
.dashboard-row > .panel {
Â  Â  flex: 1;
Â  Â  min-width: 300px;
}

#pantalla4 .graficos-container {
Â  display: flex;
Â  flex-direction: column;
Â  gap: 20px;
}

#pantalla4 .panel {
Â  padding: 20px;
Â  border-radius: var(--border-radius-md);
Â  background: rgba(31, 41, 55, 0.5);
Â  backdrop-filter: blur(12px);
Â  -webkit-backdrop-filter: blur(12px);
Â  border: 1px solid rgba(255, 255, 255, 0.1);
}

#pantalla4 .panel h3 {
Â  text-align: center;
Â  margin-top: 0;
Â  margin-bottom: 20px;
Â  color: var(--text-light);
}
#pantalla4 #tablaPendientes {
Â  width: 100%;
Â  border-collapse: collapse;
Â  color: var(--text-light);
}
#pantalla4 #tablaPendientes th, #pantalla4 #tablaPendientes td {
Â  padding: 12px;
Â  border-bottom: 1px solid rgba(55, 65, 81, 0.5);
Â  text-align: left;
}
#pantalla4 #tablaPendientes thead { background-color: rgba(55, 65, 81, 0.4); }
#pantalla4 #tablaPendientes tbody tr:hover { background-color: rgba(75, 85, 99, 0.4); }

/* ======== ESTILOS PANEL LATERAL (mt-panel) ======== */
.mt-fab { position: fixed; bottom: 20px; right: 20px; background: var(--accent-blue); color: #fff; border: none; border-radius: 50%; width: 78px; height: 78px; font-size: 12px; font-weight: 700; cursor: pointer; z-index: 1000; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.35); }
.mt-fab:active { transform: translateY(1px); }
.mt-panel { position: fixed; top: 0; right: -420px; width: 420px; max-width: 95vw; height: 100%; background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); color: var(--text-light); box-shadow: -4px 0 20px rgba(0,0,0,.45); transition: right .28s ease; z-index: 999; border-left: 1px solid rgba(255,255,255,0.1); }
.mt-panel.open { right: 0; }
.mt-panel-content { padding: 20px; }
.mt-close { background: transparent; border: none; color: var(--text-medium); font-size: 28px; cursor: pointer; float: right; }
.mt-close:hover { color: #fff; }
.mt-row { display: flex; gap: 10px; align-items: stretch; }
.mt-btn { padding: 10px 14px; border: none; border-radius: var(--border-radius-sm); font-weight: 700; cursor: pointer; }
.mt-primary { background:var(--accent-blue); color:#fff; }
.mt-success { background:var(--accent-green); color:#fff; }
.mt-select, #bxInput { flex: 1; padding: 10px 12px; border-radius: var(--border-radius-sm); border: 1px solid var(--bg-light); background: rgba(17, 24, 39, 0.5); color:var(--text-light); }
.mt-select:focus, #bxInput:focus { outline: 2px solid var(--accent-blue); }
.mt-card { margin-top: 16px; padding: 16px; border-radius: var(--border-radius-md); background: rgba(31, 41, 55, 0.5); border: 1px solid var(--bg-light); }
.mt-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 8px 14px; margin-bottom: 10px; }
.mt-list { list-style: none; padding-left: 0; margin: 8px 0 0; max-height: 200px; overflow: auto; }
.mt-list li { padding: 10px 12px; margin-bottom: 8px; border-radius: var(--border-radius-sm); background:rgba(17, 24, 39, 0.5); border: 1px solid var(--bg-light); font-size: 14px; word-break: break-word; }
.mt-assign { margin-top: 14px; border-top: 1px dashed var(--bg-light); padding-top: 12px; }

/* ================= MEDIA QUERIES RESPONSIVE ================= */
@media (max-width: 768px) {
Â  .header { justify-content: center; text-align: center; }
Â Â 
Â  #pantalla3 table { display: none; }
Â  .reporte-calidad-mobile { display: block; }
Â Â 
Â  #pantalla3 .reporte-calidad-mobile .tabla-calidad-movil .fila-dato {
Â  Â  background-color: rgba(241, 245, 249, 0.8);
Â  Â  padding: 10px;
Â  Â  border-radius: var(--border-radius-sm);
Â  Â  margin-bottom: 10px;
Â  Â  color: var(--text-dark);
Â  }
Â  #pantalla3 .reporte-calidad-mobile .tabla-calidad-movil .etiqueta {
Â  Â  font-weight: bold;
Â  Â  color: #64748b;
Â  Â  display: block;
Â  Â  font-size: 12px;
Â  }
Â  #pantalla3 .reporte-calidad-mobile .tabla-calidad-movil .valor {
Â  Â  color: var(--text-dark);
Â  Â  font-size: 16px;
Â  }
}

@media (min-width: 769px) {
Â  .reporte-calidad-mobile { display: none; }
}

/* INICIO: AJUSTES PARA VISTA HORIZONTAL EN MÃ“VILES MODIFICADOS */
@media (max-height: 500px) and (orientation: landscape) {
Â  Â  .brand-title {
Â  Â  Â  Â  display: none;
Â  Â  }
Â  Â  #pantalla2 .header {
Â  Â  Â  Â  padding: 0 10px;
Â  Â  }
Â  Â  #pantalla2 #tituloFijo {
Â  Â  Â  Â  font-size: clamp(28px, 5vw, 40px);
Â  Â  }
Â  Â  #pantalla2 .zona-centro {
Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  padding-bottom: 15px;
Â  Â  Â  Â  width: 100%;
Â  Â  }
Â  Â  #pantalla2 .grupo-contenedor {
Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  grid-template-columns: repeat(3, 1fr);
Â  Â  Â  Â  grid-template-rows: auto auto;
Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 0 10px;
Â  Â  }
Â  Â  .grupo[data-grupo="MULTIPORT"] { grid-area: 1 / 1 / 2 / 2; }
Â  Â  .grupo[data-grupo="DROPS"] { grid-area: 1 / 2 / 2 / 3; }
Â  Â  .grupo[data-grupo="BEDROCK"] { grid-area: 1 / 3 / 2 / 4; }
Â  Â  .grupo[data-grupo="CALIDAD_MULTIPORT"] { grid-area: 2 / 1 / 3 / 2; }
Â  Â  .grupo[data-grupo="CALIDAD_DROPS"] { grid-area: 2 / 2 / 3 / 3; }
Â  Â  .grupo[data-grupo="CALIDAD_BEDROCK"] { grid-area: 2 / 3 / 3 / 4; }
Â  Â  #pantalla2 .grupo {
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  min-width: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  }
Â  Â  #pantalla2 .leds {
Â  Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â  #pantalla2 .led {
Â  Â  Â  Â  --led-size: 40px;
Â  Â  }
Â  Â  .footer {
Â  Â  Â  Â  padding: 10px 0 0;
Â  Â  }
}
/* FIN: AJUSTES PARA VISTA HORIZONTAL */

</style>
</head>
<body>

<section id="splashScreen" class="pantalla activa">
Â  Â  <div class="splash-content">
Â  Â  Â  Â  <p class="brand-title">CORNING</p>
Â  Â  Â  Â  <div class="splash-logo-container">
Â  Â  Â  Â  Â  Â  Â <img src="iconolog-512.PNG" alt="Logo de LogÃ­stica" class="splash-logo">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p class="splash-loading">Cargando<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></p>
Â  Â  </div>
</section>

<section id="pantalla1" class="pantalla">
Â  Â  <div class="brand-header">
Â  Â  Â  Â  <p class="brand-title">CORNING</p>
Â  Â  Â  Â  <h1 id="mainTitle">Panel de LogÃ­stica</h1>
Â  Â  </div>
Â  Â  <div class="login-columns-container">
Â  Â  Â  Â  <div class="login-column">
Â  Â  Â  Â  Â  Â  <button class="usuario-btn" onclick="seleccionarUsuario('LOGÃSTICA')">LOGÃSTICA</button>
Â  Â  Â  Â  Â  Â  <button class="usuario-btn" onclick="seleccionarUsuario('MULTIPORT')">MULTIPORT</button>
Â  Â  Â  Â  Â  Â  <button class="usuario-btn" onclick="seleccionarUsuario('BEDROCK')">BEDROCK</button>
Â  Â  Â  Â  Â  Â  <button class="usuario-btn" onclick="seleccionarUsuario('DROPS')">DROPS</button>
Â  Â  Â  Â  Â  Â  <button class="usuario-btn" onclick="seleccionarUsuario('CALIDAD')">CALIDAD</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="login-column">
Â  Â  Â  Â  Â  Â  <button class="usuario-btn btn-management" onclick="seleccionarUsuario('SUPERVISOR')">SUPERVISOR</button>
Â  Â  Â  Â  Â  Â  <button class="usuario-btn btn-management" onclick="seleccionarDashboard()">DASHBOARD</button>
Â  Â  Â  Â  Â  Â  <button class="usuario-btn btn-management" onclick="seleccionarReporte()">REPORTES</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</section>

<section id="pantalla2" class="pantalla">
<p class="brand-title">CORNING</p>
<header class="header">
Â  Â  <div id="tituloFijo">LOGÃSTICA</div>
Â  Â  <div id="turnoActual"></div>
</header>
<div class="zona-centro">
Â  Â  <div id="resumenTurno" class="resumen-turno oculto">
<div class="dato-resumen">
Â  Â  <div class="etiqueta">Tarimas Totales</div>
Â  Â  <div id="tarimasTotales" class="valor">0</div>
</div>
<div class="dato-resumen">
Â  Â  <div class="etiqueta">Tiempo Promedio</div>
Â  Â  <div id="tiempoPromedio" class="valor">0 min</div>
</div>
</div>
<div id="filtro-supervisor-container" class="filtro-supervisor-container">
Â  Â  <label for="filtroAreaSelect">Filtrar Ãrea:</label>
Â  Â  <select id="filtroAreaSelect">
Â  Â  Â  Â  <option value="TODAS">Todas las Ã¡reas</option>
Â  Â  Â  Â  <option value="MULTIPORT">Multiport</option>
Â  Â  Â  Â  <option value="DROPS">Drops</option>
Â  Â  Â  Â  <option value="BEDROCK">Bedrock</option>
Â  Â  </select>
</div>
<div class="grupo-contenedor">
Â  Â  <div class="grupo" data-grupo="MULTIPORT">
Â  Â  Â  Â  <div class="nombre">MULTIPORT</div>
Â  Â  Â  Â  <div class="leds" data-grupo="MULTIPORT" data-linea="linea1"></div>
Â  Â  Â  Â  <div class="leds" data-grupo="MULTIPORT" data-linea="linea2"></div>
Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>
Â  Â  Â  Â  <div class="tiempos" data-grupo="MULTIPORT"></div>
Â  Â  </div>

Â  Â  <div class="grupo" data-grupo="DROPS">
Â  Â  Â  Â  <div class="nombre">DROPS</div>
Â  Â  Â  Â  <div class="leds" data-grupo="DROPS" data-linea="linea1"></div>
Â  Â  Â  Â  <div class="leds" data-grupo="DROPS" data-linea="linea2"></div>
Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>
Â  Â  Â  Â  <div class="tiempos" data-grupo="DROPS"></div>
Â  Â  </div>

Â  Â  <div class="grupo" data-grupo="BEDROCK">
Â  Â  Â  Â  <div class="nombre">BEDROCK</div>
Â  Â  Â  Â  <div class="leds" data-grupo="BEDROCK" data-linea="linea1"></div>
Â  Â  Â  Â  <div class="leds" data-grupo="BEDROCK" data-linea="linea2"></div>
Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>
Â  Â  Â  Â  <div class="tiempos" data-grupo="BEDROCK"></div>
Â  Â  </div>

Â  Â  <div class="grupo" data-grupo="CALIDAD_MULTIPORT">
Â  Â  Â  Â  <div class="nombre">CALIDAD MULTIPORT</div>
Â  Â  Â  Â  <div class="leds" data-grupo="CALIDAD_MULTIPORT" data-linea="linea1"></div>
Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>
Â  Â  Â  Â  <div class="tiempos" data-grupo="CALIDAD_MULTIPORT"></div>
Â  Â  </div>
Â Â 
Â  Â  <div class="grupo" data-grupo="CALIDAD_DROPS">
Â  Â  Â  Â  <div class="nombre">CALIDAD DROPS</div>
Â  Â  Â  Â  <div class="leds" data-grupo="CALIDAD_DROPS" data-linea="linea1"></div>
Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>
Â  Â  Â  Â  <div class="tiempos" data-grupo="CALIDAD_DROPS"></div>
Â  Â  </div>

Â  Â  <div class="grupo" data-grupo="CALIDAD_BEDROCK">
Â  Â  Â  Â  <div class="nombre">CALIDAD BEDROCK</div>
Â  Â  Â  Â  <div class="leds" data-grupo="CALIDAD_BEDROCK" data-linea="linea1"></div>
Â  Â  Â  Â  <div class="tarimas">Tarimas: 0</div>
Â  Â  Â  Â  <div class="tiempos" data-grupo="CALIDAD_BEDROCK"></div>
Â  Â  </div>
</div>
</div>
<div class="footer">
Â  Â  <button class="usuario-btn btn-rojo" onclick="volverAPantalla1()">Cerrar sesiÃ³n</button>
</div>
</section>

<section id="pantalla3" class="pantalla">
<p class="brand-title">CORNING</p>
<header class="header">
Â  Â  <h1 id="tituloReportes">REPORTES</h1>
</header>
<div class="zona-centro">
Â  Â  <div id="contenedorSelectorReporte" style="text-align: center;">
Â  Â  Â  Â  <h2 class="titulo-selector-reporte" style="text-align: center; color: var(--text-dark); margin-bottom: 20px;">Selecciona un reporte</h2>
Â  Â  Â  Â  <div id="selectoresReportes" class="btn-contenedor">
Â  Â  Â  Â  Â  Â  <button class="usuario-btn" data-reporte="produccion">PRODUCCIÃ“N</button>
Â  Â  Â  Â  Â  Â  <button class="usuario-btn" data-reporte="logistica">LOGÃSTICA</button>
Â  Â  Â  Â  Â  Â  <button class="usuario-btn" data-reporte="calidad">CALIDAD</button>
Â  Â  Â  Â  Â  Â  <button class="usuario-btn" data-reporte="tarimas">TARIMAS</button>
Â  Â  Â  Â  Â  Â  <button class="usuario-btn" data-reporte="resumen">RESUMEN EJECUTIVO</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="contenedorReporte" class="contenedor-reporte" style="display: none;">
Â  Â  Â  Â  </div>
</div>
<div class="footer">
Â  Â  <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver</button>
</div>
</section>

<section id="pantalla4" class="pantalla">
Â  Â  <p class="brand-title">CORNING</p>
Â  Â  <header class="header">
Â  Â  Â  Â  <h1>DASHBOARD DE SUPERVISOR</h1>
Â  Â  </header>
Â  Â  <div class="filtros-dashboard">
Â  Â  Â  Â  <label for="fechaDashboard">Fecha:</label>
Â  Â  Â  Â  <input type="date" id="fechaDashboard">
Â  Â  Â  Â  <label for="turnoDashboardSelect">Turno:</label>
Â  Â  Â  Â  <select id="turnoDashboardSelect">
Â  Â  Â  Â  Â  Â  <option value="todos">Todos</option>
Â  Â  Â  Â  Â  Â  <option value="Turno 1">Turno 1</option>
Â  Â  Â  Â  Â  Â  <option value="Turno 2">Turno 2</option>
Â  Â  Â  Â  </select>
Â  Â  </div>
Â  Â  <div class="kpis-grid">
Â  Â  Â  Â  <div class="kpi-card">
Â  Â  Â  Â  Â  Â  <h3>Tarimas Confirmadas</h3>
Â  Â  Â  Â  Â  Â  <div class="valor" id="dashTarimasConfirmadas">0</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="kpi-card">
Â  Â  Â  Â  Â  Â  <h3>Tarimas Recolectadas</h3>
Â  Â  Â  Â  Â  Â  <div class="valor" id="dashTarimasRecolectadas">0</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="kpi-card" id="kpiTiempoPromedio">
Â  Â  Â  Â  Â  Â  <h3>Tiempo Promedio</h3>
Â  Â  Â  Â  Â  Â  <div class="valor" id="dashTiempoPromedio">0 min</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="kpi-card" id="kpiTasaRechazo">
Â  Â  Â  Â  Â  Â  <h3>Tasa de Rechazo</h3>
Â  Â  Â  Â  Â  Â  <div class="valor" id="dashTasaRechazo">0%</div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="panel">
Â  Â  Â  Â  <h3>Tarimas Pendientes por Recolectar</h3>
Â  Â  Â  Â  <table id="tablaPendientes">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Ãrea</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Tarimas Pendientes</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>
Â  Â  <div class="graficos-container">
Â  Â  Â  Â  <div class="dashboard-row">
Â  Â  Â  Â  Â  Â  <div class="panel">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>ProducciÃ³n por Ãrea</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="position: relative; height: 300px;"><canvas id="graficoProduccionDash"></canvas></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="panel">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Estado de Calidad</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="position: relative; height: 300px;"><canvas id="graficoCalidadDash"></canvas></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="panel">
Â  Â  Â  Â  Â  Â  <h3>Recolecciones por Hora</h3>
Â  Â  Â  Â  Â  Â  <div style="position: relative; height: 300px;"><canvas id="graficoLogisticaDash"></canvas></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="footer">
Â  Â  Â  Â  <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver al inicio</button>
Â  Â  </div>
</section>

<section id="pantalla5" class="pantalla">
Â  Â  <p class="brand-title">CORNING</p>
Â  Â  <header class="header">
Â  Â  Â  Â  <h1>AJUSTES</h1>
Â  Â  </header>
Â  Â  <div class="zona-centro">
Â  Â  Â  Â  <div class="modal-content" style="max-width: 600px;">
Â  Â  Â  Â  Â  Â  <h3>GestiÃ³n de ContraseÃ±as</h3>
Â  Â  Â  Â  Â  Â  <form id="formAjustes">
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="activarPantalla('pantalla1')" class="usuario-btn btn-rojo">Volver</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="guardarContraseÃ±as()" class="usuario-btn">Guardar Cambios</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</section>

<div id="modalCalidad" class="modal-calidad">
Â  <div class="modal-content">
Â  Â  <h3 id="modalCalidadTitulo">Selecciona el estado:</h3>
Â  Â  <div class="opciones">
Â  Â  Â  <button class="opcion-btn" data-color="rojo">Rechazada ğŸ”´</button>
Â  Â  Â  <button class="opcion-btn" data-color="verde">Liberada ğŸŸ¢</button>
Â  Â  </div>
Â  Â  <button class="cerrar-btn">Cerrar</button>
Â  </div>
</div>

<div id="modalOpcionesCalidad" class="modal">
Â  <div class="modal-content">
Â  Â  <h3>Asignar tarima a LED de Calidad</h3>
Â  Â  <label for="selectLedCalidad">Selecciona LED:</label>
Â  Â  <select id="selectLedCalidad"></select>
Â  Â  <div class="modal-actions">
Â  Â  Â  <button id="btnAsignarTarimaCalidad" class="usuario-btn">Asignar</button>
Â  Â  Â  <button onclick="cerrarModalCalidad()" class="usuario-btn btn-rojo">Cancelar</button>
Â  Â  </div>
Â  </div>
</div>
Â Â 
<div id="modalRechazo" class="modal-calidad">
Â  <div class="modal-content">
Â  Â  <h3>Detalles del Rechazo</h3>
Â  Â  <form id="formularioRechazo">
Â  Â  Â  Â  <label for="empleado">Empleado Originador:</label>
Â  Â  Â  Â  <input type="text" id="empleado" name="empleado" required>
Â  Â  Â  Â  <label for="linea">LÃ­nea afectada:</label>
Â  Â  Â  Â  <input type="text" id="linea" name="linea" required>
Â  Â  Â  Â  <label for="parte">No. de parte:</label>
Â  Â  Â  Â  <input type="text" id="parte" name="parte" required>
Â  Â  Â  Â  <label for="descripcionParte">DescripciÃ³n del No. de parte:</label>
Â  Â  Â  Â  <input type="text" id="descripcionParte" name="descripcionParte" required>
Â  Â  Â  Â  <label for="problema">DescripciÃ³n del problema:</label>
Â  Â  Â  Â  <textarea id="problema" name="problema" required></textarea>
Â  Â  Â  Â  <label for="causa">Causa raÃ­z del problema:</label>
Â  Â  Â  Â  <textarea id="causa" name="causa" required></textarea>
Â  Â  Â  Â  <label for="accion">AcciÃ³n correctiva:</label>
Â  Â  Â  Â  <textarea id="accion" name="accion" required></textarea>
Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  <button type="submit" class="usuario-btn">Guardar Rechazo</button>
Â  Â  Â  Â  Â  Â  <button type="button" onclick="cerrarModalRechazo()" class="usuario-btn btn-rojo">Cancelar</button>
Â  Â  Â  Â  </div>
Â  Â  </form>
Â  </div>
</div>

<div id="modalAsignarTarimaProduccion" class="modal-produccion">
Â  <div class="modal-content">
Â  Â  <h3>Confirmar Tarima en ProducciÃ³n</h3>
Â  Â  <label for="selectTarimaProduccion">Selecciona Tarima Recibida:</label>
Â  Â  <select id="selectTarimaProduccion"></select>
Â  Â  <label for="selectLedProduccion">Asignar al LED:</label>
Â  Â  <select id="selectLedProduccion"></select>
Â  Â  <div class="modal-actions">
Â  Â  Â  <button onclick="cerrarModalProduccion()" class="usuario-btn btn-rojo">Cancelar</button>
Â  Â  Â  <button id="btnAsignarProduccion" class="usuario-btn">Confirmar</button>
Â  Â  </div>
Â  </div>
</div>
Â Â 
<button class="mt-fab" id="mtOpenBtn" style="display:none;" title="IdentificaciÃ³n de Tarima">TARIMAS</button>

<div id="mtPanel" class="mt-panel" aria-hidden="true">
Â  <div class="mt-panel-content">
Â  Â  <button id="mtCloseBtn" class="mt-close" aria-label="Cerrar panel">&times;</button>
Â  Â  <h2>IdentificaciÃ³n de Tarima</h2>
Â  Â Â 
Â  Â  <div id="tarimasPendientesPanel" style="display:none;">
Â  Â  Â  <h3>Tarimas pendientes por inspecciÃ³n</h3>
Â  Â  Â  <ul id="listaTarimasPendientes" class="mt-list"></ul>
Â  Â  </div>

Â  Â  <p>Escanea o ingresa un cÃ³digo <b>BX</b> para ver detalles:</p>
Â  Â  <div class="mt-row">
Â  Â  Â  <input type="text" id="bxInput" placeholder="Escanear/pegar cÃ³digo BX..." autocomplete="off" />
Â  Â  Â  <button id="buscarTarimaBtn" class="mt-btn mt-primary">Buscar</button>
Â  Â  </div>

Â  Â  <div id="tarimaInfo" class="mt-card" style="display:none;">
Â  Â  Â  <h3>Tarima encontrada</h3>
Â  Â  Â  <div class="mt-grid">
Â  Â  Â  Â  <div><b>ID:</b> <span id="tarimaId">â€”</span></div>
Â  Â  Â  Â  <div><b>Empleado:</b> <span id="empleado">â€”</span></div>
Â  Â  Â  Â  <div><b>Turno:</b> <span id="turno">â€”</span></div>
Â  Â  Â  Â  <div><b>Total cajas:</b> <span id="totalCajas">0</span></div>
Â  Â  Â  Â  <div><b>Total piezas:</b> <span id="totalPiezas">0</span></div>
Â  Â  Â  </div>
Â  Â  Â  <h4>Detalle de cajas (BX | piezas)</h4>
Â  Â  Â  <ul id="listaCajas" class="mt-list"></ul>
Â  Â  Â  <div id="ledAssignment" class="mt-assign" style="display:none;">
Â  Â  Â  Â  <label for="ledSelect">Asignar LED a esta tarima:</label>
Â  Â  Â  Â  <div class="mt-row">
Â  Â  Â  Â  Â  <select id="ledSelect" class="mt-select"></select>
Â  Â  Â  Â  Â  <button id="asignarLedBtn" class="mt-btn mt-success">Asignar LED</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <small>Nota: los LEDs solo podrÃ¡n encenderse/apagarse si tienen tarima asignada.</small>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<div id="modalAlerta" class="custom-modal-overlay">
Â  Â  <div class="custom-modal">
Â  Â  Â  Â  <h3 id="alertaTitulo">NotificaciÃ³n</h3>
Â  Â  Â  Â  <p id="alertaMensaje" class="modal-generic-message"></p>
Â  Â  Â  Â  <div class="modal-actions" style="justify-content: center;">
Â  Â  Â  Â  Â  Â  <button id="alertaBotonCerrar" class="usuario-btn">Aceptar</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="modalConfirmacion" class="custom-modal-overlay">
Â  Â  <div class="custom-modal">
Â  Â  Â  Â  <h3 id="confirmacionTitulo">ConfirmaciÃ³n</h3>
Â  Â  Â  Â  <p id="confirmacionMensaje" class="modal-generic-message"></p>
Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  <button id="confirmacionBotonCancelar" class="usuario-btn btn-rojo">Cancelar</button>
Â  Â  Â  Â  Â  Â  <button id="confirmacionBotonOk" class="usuario-btn">Confirmar</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="modalContraseÃ±a" class="custom-modal-overlay">
Â  Â  <div class="custom-modal">
Â  Â  Â  Â  <h3 id="contraseÃ±aTitulo">Acceso Requerido</h3>
Â  Â  Â  Â  <p id="contraseÃ±aMensaje" class="modal-generic-message"></p>
Â  Â  Â  Â  <input type="password" id="contraseÃ±aInput" placeholder="Introduce la contraseÃ±a...">
Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  <button id="contraseÃ±aBotonCancelar" class="usuario-btn btn-rojo">Cancelar</button>
Â  Â  Â  Â  Â  Â  <button id="contraseÃ±aBotonOk" class="usuario-btn">Aceptar</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
// ================= CONFIG Y ESTADO =================
const CONFIG = {
Â  Â  USUARIOS: ['MULTIPORT', 'BEDROCK', 'DROPS', 'LOGÃSTICA', 'SUPERVISOR', 'CALIDAD'],
Â  Â  PRODUCCION_GRUPOS: ['MULTIPORT', 'BEDROCK', 'DROPS'],
Â  Â  PASSWORDS: {
Â  Â  Â  Â  'LOGÃSTICA': 'LOGRAM', 'MULTIPORT': 'MP25', 'BEDROCK': 'BR25', 'DROPS': 'DROP25', 'SUPERVISOR': 'SUP25',
Â  Â  Â  Â  'CALIDAD_MULTIPORT': 'AQLMP', 'CALIDAD_DROPS': 'AQLDP', 'CALIDAD_BEDROCK': 'AQLBR', 'REPORTES': 'REPO25', 'DASHBOARD': 'DASH25'
Â  Â  },
Â  Â  LEDS_POR_GRUPO: {
Â  Â  Â  Â  'MULTIPORT': 5, 'BEDROCK': 5, 'DROPS': 5, 'CALIDAD_MULTIPORT': 5, 'CALIDAD_BEDROCK': 5, 'CALIDAD_DROPS': 5
Â  Â  }
};

let usuarioSeleccionado = null;
let ledActivoParaFormulario = { grupo: null, idx: null, linea: null };
let reporteActual = null;
let datosFiltradosReporte = null;
let miGrafico;
let graficosDashboard = {};
let dashboardUpdateInterval;
let appPasswords = { ...CONFIG.PASSWORDS };
// INICIO: Variables para sincronizaciÃ³n de tiempo
let serverTimeOffset = 0;
// FIN: Variables para sincronizaciÃ³n de tiempo

// ================= FIREBASE =================
const firebaseConfig = {
Â  Â  apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
Â  Â  authDomain: "panel-logistica.firebaseapp.com",
Â  Â  databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
Â  Â  projectId: "panel-logistica",
Â  Â  storageBucket: "panel-logistica.appspot.com",
Â  Â  messagingSenderId: "38365879945",
Â  Â  appId: "1:38365879945:web:e2f3590fe77f013dba3058"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const db = database;Â 
const ledRef = database.ref('estadoLEDs');
let historialRef;
let dashboardListeners = [];

// ================= MODALES PERSONALIZADOS =================
const modalAlerta = document.getElementById('modalAlerta');
const modalConfirmacion = document.getElementById('modalConfirmacion');
const modalContraseÃ±a = document.getElementById('modalContraseÃ±a');

function mostrarAlerta(mensaje, titulo = "NotificaciÃ³n") {
Â  Â  document.getElementById('alertaTitulo').textContent = titulo;
Â  Â  document.getElementById('alertaMensaje').textContent = mensaje;
Â  Â  modalAlerta.classList.add('visible');
Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  document.getElementById('alertaBotonCerrar').onclick = () => {
Â  Â  Â  Â  Â  Â  modalAlerta.classList.remove('visible');
Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  };
Â  Â  });
}

function mostrarConfirmacion(mensaje, titulo = "ConfirmaciÃ³n") {
Â  Â  document.getElementById('confirmacionTitulo').textContent = titulo;
Â  Â  document.getElementById('confirmacionMensaje').textContent = mensaje;
Â  Â  modalConfirmacion.classList.add('visible');
Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  document.getElementById('confirmacionBotonOk').onclick = () => {
Â  Â  Â  Â  Â  Â  modalConfirmacion.classList.remove('visible');
Â  Â  Â  Â  Â  Â  resolve(true);
Â  Â  Â  Â  };
Â  Â  Â  Â  document.getElementById('confirmacionBotonCancelar').onclick = () => {
Â  Â  Â  Â  Â  Â  modalConfirmacion.classList.remove('visible');
Â  Â  Â  Â  Â  Â  resolve(false);
Â  Â  Â  Â  };
Â  Â  });
}

function mostrarPromptContraseÃ±a(mensaje, titulo = "Acceso Requerido") {
Â  Â  document.getElementById('contraseÃ±aTitulo').textContent = titulo;
Â  Â  document.getElementById('contraseÃ±aMensaje').textContent = mensaje;
Â  Â  const input = document.getElementById('contraseÃ±aInput');
Â  Â  input.value = '';
Â  Â  modalContraseÃ±a.classList.add('visible');
Â  Â  input.focus();

Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  const resolver = (value) => {
Â  Â  Â  Â  Â  Â  modalContraseÃ±a.classList.remove('visible');
Â  Â  Â  Â  Â  Â  document.getElementById('contraseÃ±aBotonOk').onclick = null;
Â  Â  Â  Â  Â  Â  document.getElementById('contraseÃ±aBotonCancelar').onclick = null;
Â  Â  Â  Â  Â  Â  input.onkeypress = null;
Â  Â  Â  Â  Â  Â  resolve(value);
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('contraseÃ±aBotonOk').onclick = () => resolver(input.value);
Â  Â  Â  Â  document.getElementById('contraseÃ±aBotonCancelar').onclick = () => resolver(null);
Â  Â  Â  Â  input.onkeypress = (e) => {
Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') resolver(input.value);
Â  Â  Â  Â  };
Â  Â  });
}


// ================= Panel de IdentificaciÃ³n de Tarimas =================
const MT = {
Â  ui: {
Â  Â  panel: Â  Â document.getElementById('mtPanel'),
Â  Â  openBtn: document.getElementById('mtOpenBtn'),
Â  Â  closeBtn:document.getElementById('mtCloseBtn'),
Â  Â  bxInput: document.getElementById('bxInput'),
Â  Â  buscarBtn: document.getElementById('buscarTarimaBtn'),
Â  Â  infoBox: document.getElementById('tarimaInfo'),
Â  Â  pendientesPanel: document.getElementById('tarimasPendientesPanel'),
Â  Â  fields: { id: document.getElementById('tarimaId'), empleado: document.getElementById('empleado'), turno: document.getElementById('turno'), totalCajas: document.getElementById('totalCajas'), totalPiezas: document.getElementById('totalPiezas'), listaCajas: document.getElementById('listaCajas') },
Â  Â  asignacion: { wrap: document.getElementById('ledAssignment'), select: document.getElementById('ledSelect'), btn: document.getElementById('asignarLedBtn') }
Â  },
Â  state: { tarimaActual: null }
};

if (MT.ui.openBtn) MT.ui.openBtn.addEventListener('click', () => {
Â  Â  MT.ui.panel.classList.add('open');
Â  Â  if(usuarioSeleccionado && usuarioSeleccionado.startsWith('CALIDAD_')) {
Â  Â  Â  Â  MT.ui.pendientesPanel.style.display = 'block';
Â  Â  Â  Â  MT.ui.infoBox.style.display = 'none';
Â  Â  Â  Â  MT.ui.bxInput.value = '';
Â  Â  Â  Â  renderTarimasPendientes();
Â  Â  }
});
if (MT.ui.closeBtn) MT.ui.closeBtn.addEventListener('click', () => MT.ui.panel.classList.remove('open'));
if (MT.ui.buscarBtn) MT.ui.buscarBtn.addEventListener('click', () => { const bx = (MT.ui.bxInput.value || '').trim(); if (bx) buscarTarimaPorBX(bx); });
if (MT.ui.bxInput) MT.ui.bxInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') MT.ui.buscarBtn.click(); });

function buscarTarimaPorBX(bxCode) {
Â  database.ref('tarimas').once('value').then(snapshot => {
Â  Â  let encontrada = null;
Â  Â  snapshot.forEach(tSnap => {
Â  Â  Â  const t = tSnap.val() || {};
Â  Â  Â  const cajas = t.cajas || {};
Â  Â  Â  for (const key in cajas) {
Â  Â  Â  Â  if (cajas[key] && cajas[key].codigoCaja === bxCode) {
Â  Â  Â  Â  Â  encontrada = { id: t.id || tSnap.key, ...t };
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  if (encontrada) return true;
Â  Â  });

Â  Â  if (!encontrada) {
Â  Â  Â  MT.ui.infoBox.style.display = 'none';
Â  Â  Â  mostrarAlerta('No se encontrÃ³ ninguna tarima con ese cÃ³digo BX.');
Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  MT.state.tarimaActual = normalizarTarima(encontrada);
Â  Â  renderTarimaEncontrada(MT.state.tarimaActual);
Â  Â  MT.ui.pendientesPanel.style.display = 'none';

Â  }).catch(err => {
Â  Â  console.error('Error buscando tarima:', err);
Â  Â  mostrarAlerta('Error al buscar la tarima. Reintenta.');
Â  });
}

function normalizarTarima(t) {
Â  const out = {
Â  Â  id: t.id || 'N/D',
Â  Â  empleadoId: t.empleadoId || 'N/D',
Â  Â  turno: t.turno || 'N/D',
Â  Â  cajas: []
Â  };
Â Â 
Â  const cajasObj = t.cajas || {};
Â  for (const key in cajasObj) {
Â  Â  const caja = cajasObj[key];
Â  Â  if (caja && caja.codigoCaja) {
Â  Â  Â  out.cajas.push({
Â  Â  Â  Â  id: key,
Â  Â  Â  Â  codigoCaja: caja.codigoCaja,
Â  Â  Â  Â  cantidadPiezas: Number(caja.cantidadPiezas || 0)
Â  Â  Â  });
Â  Â  }
Â  }
Â Â 
Â  out.totalCajas = out.cajas.length;
Â  out.totalPiezas = out.cajas.reduce((sum, caja) => sum + caja.cantidadPiezas, 0);
Â Â 
Â  return out;
}

function cargarLedsDisponibles() {
Â  Â  const sel = MT.ui.asignacion.select;
Â  Â  const grupoCalidad = usuarioSeleccionado;
Â  Â  if (!grupoCalidad || !grupoCalidad.startsWith('CALIDAD_')) return;
Â  Â  db.ref(`estadoLEDs/${grupoCalidad}/linea1`).on('value', snap => {
Â  Â  Â  Â  sel.innerHTML = '<option value="">Seleccione un LED...</option>';
Â  Â  Â  Â  const ledsEstado = snap.val() || {};
Â  Â  Â  Â  const totalLeds = CONFIG.LEDS_POR_GRUPO[grupoCalidad] || 5;
Â  Â  Â  Â  for (let i = 0; i < totalLeds; i++) {
Â  Â  Â  Â  Â  Â  if (!ledsEstado[i]?.tarimaId) {
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = i;
Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = `LED ${i+1}`;
Â  Â  Â  Â  Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
}

function renderTarimasPendientes() {
Â  Â  const lista = document.getElementById('listaTarimasPendientes');
Â  Â  lista.innerHTML = '<li>Cargando...</li>';
Â  Â  db.ref('tarimas').orderByChild('estado').equalTo('pendiente').once('value').then(snap => {
Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  lista.innerHTML = '<li>No hay tarimas pendientes.</li>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const tarimasPendientes = [];
Â  Â  Â  Â  snap.forEach(tSnap => {
Â  Â  Â  Â  Â  Â  tarimasPendientes.push(tSnap.val());
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  lista.innerHTML = '';
Â  Â  Â  Â  if (tarimasPendientes.length === 0) {
Â  Â  Â  Â  Â  Â  lista.innerHTML = '<li>No hay tarimas pendientes.</li>';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  tarimasPendientes.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  Â  li.textContent = `Tarima #${t.id}`;
Â  Â  Â  Â  Â  Â  Â  Â  li.style.cursor = "pointer";
Â  Â  Â  Â  Â  Â  Â  Â  li.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const primerBx = t.cajas ? Object.values(t.cajas)[0]?.codigoCaja : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (primerBx) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  MT.ui.bxInput.value = primerBx;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buscarTarimaPorBX(primerBx);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostrarAlerta('Esta tarima no tiene cajas registradas.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  lista.appendChild(li);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });
}


db.ref('tarimas').on('child_changed', renderTarimasPendientes);
db.ref('tarimas').on('child_added', renderTarimasPendientes);
db.ref('tarimas').on('child_removed', renderTarimasPendientes);

async function asignarLedATarima(ledIndex, tarimaId) {
Â  Â  const grupo = usuarioSeleccionado;
Â  Â  if (!grupo || !tarimaId || ledIndex === null) return mostrarAlerta('Datos incompletos para asignar.');
Â  Â  const ledId = `${grupo}-linea1-${ledIndex}`;

Â  Â  const tarimaSnap = await db.ref(`tarimas/${tarimaId}`).once('value');
Â  Â  const tarimaData = tarimaSnap.val();

Â  Â  if (tarimaData && tarimaData.estado !== 'pendiente') {
Â  Â  Â  Â  Â return mostrarAlerta(`Error: La tarima ${tarimaId} ya ha sido procesada por calidad.`);
Â  Â  }

Â  Â  const ledEstadoRef = db.ref(`estadoLEDs/${grupo}/linea1/${ledIndex}`);
Â  Â  try {
Â  Â  Â  Â  await ledEstadoRef.set({
Â  Â  Â  Â  Â  Â  color: 'naranja',
Â  Â  Â  Â  Â  Â  tarimaId: tarimaId,
Â  Â  Â  Â  Â  Â  usuario: usuarioSeleccionado,
Â  Â  Â  Â  Â  Â  // INICIO: Usar timestamp del servidor
Â  Â  Â  Â  Â  Â  timestamp: firebase.database.ServerValue.TIMESTAMP
Â  Â  Â  Â  Â  Â  // FIN: Usar timestamp del servidor
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  await db.ref(`tarimas/${tarimaId}`).update({ estado: 'en_inspeccion', asignadaA: usuarioSeleccionado });
Â  Â  Â  Â Â 
Â  Â  Â  Â  await mostrarAlerta(`âœ… Tarima ${tarimaId} asignada al LED ${parseInt(ledIndex) + 1} para inspecciÃ³n.`);
Â  Â  Â  Â  MT.ui.panel.classList.remove('open');
Â  Â  Â  Â  MT.ui.infoBox.style.display = 'none';
Â  Â  Â  Â  MT.ui.bxInput.value = '';
Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Error asignando LED:', err);
Â  Â  Â  Â  await mostrarAlerta('No se pudo asignar el LED.');
Â  Â  }
}


function renderTarimaEncontrada(tarima) {
Â  MT.ui.fields.id.textContent = tarima.id;
Â  MT.ui.fields.empleado.textContent = tarima.empleadoId;
Â  MT.ui.fields.turno.textContent = tarima.turno;
Â  MT.ui.fields.totalCajas.textContent = tarima.totalCajas;
Â  MT.ui.fields.totalPiezas.textContent = tarima.totalPiezas;

Â  MT.ui.fields.listaCajas.innerHTML = '';
Â  tarima.cajas.forEach(c => {
Â  Â  const li = document.createElement('li');
Â  Â  li.textContent = `${c.codigoCaja} Â | Â ${c.cantidadPiezas} pz`;
Â  Â  MT.ui.fields.listaCajas.appendChild(li);
Â  });

Â  const isCalidad = (usuarioSeleccionado || '').startsWith('CALIDAD');
Â  MT.ui.asignacion.wrap.style.display = isCalidad ? 'block' : 'none';

Â  if (isCalidad) {
Â  Â  cargarLedsDisponibles();
Â  Â  MT.ui.asignacion.btn.onclick = () => {
Â  Â  Â  const ledIndex = MT.ui.asignacion.select.value;
Â  Â  Â  if (ledIndex === '' || !tarima.id) return;
Â  Â  Â  asignarLedATarima(ledIndex, tarima.id);
Â  Â  };
Â  }
Â  MT.ui.infoBox.style.display = 'block';
}

// ================= FUNCIONES DE RENDER Y VISIBILIDAD =================
function inyectaLEDs(){
Â  Â  document.querySelectorAll('.grupo').forEach(grupoDiv => {
Â  Â  Â  Â  grupoDiv.classList.add('oculto');
Â  Â  });
Â  Â  const usuario = usuarioSeleccionado;

Â  Â  if (usuario === 'SUPERVISOR') {
Â  Â  Â  Â  document.querySelectorAll('.grupo').forEach(g => g.classList.remove('oculto'));
Â  Â  } else if (usuario === 'LOGÃSTICA') {
Â  Â  Â  Â  document.querySelectorAll('.grupo:not([data-grupo*="CALIDAD_"])').forEach(g => g.classList.remove('oculto'));
Â  Â  } else if (usuario.startsWith('CALIDAD_')) {
Â  Â  Â  Â  document.querySelector(`.grupo[data-grupo="${usuario}"]`)?.classList.remove('oculto');
Â  Â  } else if (CONFIG.PRODUCCION_GRUPOS.includes(usuario)) {
Â  Â  Â  Â  document.querySelector(`.grupo[data-grupo="${usuario}"]`)?.classList.remove('oculto');
Â  Â  Â  Â  document.querySelector(`.grupo[data-grupo="CALIDAD_${usuario}"]`)?.classList.remove('oculto');
Â  Â  }

Â  Â  document.querySelectorAll('.grupo:not(.oculto) .leds').forEach(contenedor => {
Â  Â  Â  Â  const grupoLeds = contenedor.dataset.grupo;
Â  Â  Â  Â  const linea = contenedor.dataset.linea;
Â  Â  Â  Â  const ledsPorLinea = CONFIG.LEDS_POR_GRUPO[grupoLeds] || 5;
Â  Â  Â  Â  contenedor.innerHTML = '';
Â  Â  Â  Â  for(let i = 0; i < ledsPorLinea; i++){
Â  Â  Â  Â  Â  Â  const led = document.createElement('div');
Â  Â  Â  Â  Â  Â  led.className = 'led';
Â  Â  Â  Â  Â  Â  led.title = `${grupoLeds} â€¢ ${linea} â€¢ LED ${i+1}`;
Â  Â  Â  Â  Â  Â  led.addEventListener('click', () => togglearLED(grupoLeds, i, linea));
Â  Â  Â  Â  Â  Â  contenedor.appendChild(led);
Â  Â  Â  Â  }
Â  Â  });
}

function pintarEstado() {
Â  Â  db.ref('estadoLEDs').on('value', snapshot => {
Â  Â  Â  Â  const estados = snapshot.val() || {};
Â  Â  Â  Â  document.querySelectorAll('.leds').forEach(contenedor => {
Â  Â  Â  Â  Â  Â  const grupoLeds = contenedor.dataset.grupo;
Â  Â  Â  Â  Â  Â  const linea = contenedor.dataset.linea;
Â  Â  Â  Â  Â  Â  const ledsEstado = estados[grupoLeds]?.[linea] || {};
Â  Â  Â  Â  Â  Â  contenedor.querySelectorAll('.led').forEach((led, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  led.className = 'led';
Â  Â  Â  Â  Â  Â  Â  Â  led.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  led.removeAttribute('data-hora-encendido');

Â  Â  Â  Â  Â  Â  Â  Â  const estado = ledsEstado[index];
Â  Â  Â  Â  Â  Â  Â  Â  if (estado) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let tarimaIdDisplay = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (estado.tarimaId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tarimaIdDisplay = String(estado.tarimaId).replace('Tarima ', '').replace('TAR-', '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (grupoLeds.startsWith('CALIDAD_') && estado.color) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.classList.add(estado.color);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tarimaIdDisplay) led.innerHTML = `<span class="tarima-id">${tarimaIdDisplay}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (estado.encendido) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.classList.add('on');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.dataset.horaEncendido = estado.horaEncendido;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (esGrupoDeTarimas(grupoLeds)) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.innerHTML = `<span class="tarima-id">${tarimaIdDisplay}</span><span class="tiempo-transcurrido"></span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led.innerHTML = `<span class="tiempo-transcurrido"></span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â  actualizarTodosLosContadores();
Â  Â  });
}


function actualizarTodosLosContadores() {
Â  Â  document.querySelectorAll('.led.on[data-hora-encendido]').forEach(led => {
Â  Â  Â  Â  const horaEncendido = led.dataset.horaEncendido;
Â  Â  Â  Â  if (horaEncendido) {
Â  Â  Â  Â  Â  Â  // INICIO: Usar tiempo sincronizado
Â  Â  Â  Â  Â  Â  const tiempoTranscurridoMs = getSyncedTime().getTime() - horaEncendido;
Â  Â  Â  Â  Â  Â  // FIN: Usar tiempo sincronizado
Â  Â  Â  Â  Â  Â  const minutosTranscurridos = Math.floor(tiempoTranscurridoMs / 60000);
Â  Â  Â  Â  Â  Â  const timerSpan = led.querySelector('.tiempo-transcurrido');
Â  Â  Â  Â  Â  Â  if (timerSpan) {
Â  Â  Â  Â  Â  Â  Â  Â  timerSpan.innerHTML = `<b>${minutosTranscurridos}</b><small>min</small>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
}

// ================= LÃ“GICA DE INTERACCIÃ“N PRINCIPAL (togglearLED) =================
function esGrupoDeTarimas(grupo) {
Â  Â  const grupoBase = grupo.replace('CALIDAD_', '');
Â  Â  return grupoBase === 'MULTIPORT';
}

async function togglearLED(grupo, idx, linea = 'linea1') {
Â  Â  const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
Â  Â  const usuarioActual = usuarioSeleccionado || '';
Â  Â Â 
Â  Â  const snapshot = await ledRef.once('value');
Â  Â  const estadoActual = snapshot.val() || {};
Â  Â  const { fecha, turno } = obtenerTurnoActual();

Â  Â  if (esGrupoDeTarimas(grupo)) {
Â  Â  Â  Â  if (usuarioActual === 'CALIDAD_MULTIPORT' && grupo === usuarioActual) {
Â  Â  Â  Â  Â  Â  if (!estadoActual.tarimaId) return mostrarAlerta('Este LED estÃ¡ vacÃ­o. Usa el panel "TARIMAS" para asignar una.');
Â  Â  Â  Â  Â  Â  if (estadoActual.color === 'verde') return mostrarAlerta('Esta tarima ya ha sido liberada.');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (estadoActual.color === 'rojo') {
Â  Â  Â  Â  Â  Â  Â  Â  if (await mostrarConfirmacion('Esta tarima fue rechazada. Â¿Confirmas que ha sido corregida y deseas liberarla ahora?')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liberarTarima(estadoActual.tarimaId, grupo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ledRef.update({ color: 'verde' });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  abrirModalCalidad(grupo, idx, linea, estadoActual.tarimaId);
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (usuarioActual === 'MULTIPORT' && grupo === 'CALIDAD_MULTIPORT') {
Â  Â  Â  Â  Â  Â  if (estadoActual.color === 'verde' && estadoActual.tarimaId) {
Â  Â  Â  Â  Â  Â  Â  Â  const tarimaId = estadoActual.tarimaId;
Â  Â  Â  Â  Â  Â  Â  Â  const recibidasRef = db.ref(`tarimasRecibidas/${usuarioActual}`);
Â  Â  Â  Â  Â  Â  Â  Â  const yaRecibidaSnap = await recibidasRef.orderByChild('tarimaId').equalTo(tarimaId).once('value');
Â  Â  Â  Â  Â  Â  Â  Â  if (yaRecibidaSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return mostrarAlerta(`La tarima #${tarimaId} ya fue recibida anteriormente.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (await mostrarConfirmacion(`Â¿Recibir la tarima #${tarimaId} liberada por Calidad?`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recibidasRef.push({ tarimaId, recibidaDe: grupo, timestampRecibida: firebase.database.ServerValue.TIMESTAMP });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  db.ref(`historialLogs/${fecha}/${turno}`).push({ usuario: usuarioActual, grupo, accion: 'recibida_de_calidad', tarimaId, timestamp: firebase.database.ServerValue.TIMESTAMP });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ledRef.set(null);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await mostrarAlerta(`Tarima #${tarimaId} recibida. Ahora puedes confirmarla en uno de tus LEDs.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (usuarioActual === 'MULTIPORT' && grupo === usuarioActual) {
Â  Â  Â  Â  Â  Â  if (!estadoActual.encendido) {
Â  Â  Â  Â  Â  Â  Â  Â  mostrarModalProduccion(grupo, idx, linea);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  await mostrarAlerta('Este LED ya tiene una tarima en proceso.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  else if ((usuarioActual === 'LOGÃSTICA' || usuarioActual === 'SUPERVISOR') && grupo === 'MULTIPORT') {
Â  Â  Â  Â  Â  Â  if (estadoActual.encendido && estadoActual.tarimaId) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!(await mostrarConfirmacion(`Â¿Confirmas la recolecciÃ³n de la tarima ${estadoActual.tarimaId}?`))) return;
Â  Â  Â  Â  Â  Â  Â  Â  const horaEncendido = estadoActual.horaEncendido;
Â  Â  Â  Â  Â  Â  Â  Â  db.ref(`historialLogs/${fecha}/${turno}`).push({ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuario: usuarioActual,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grupo,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accion: 'recolectada',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tarimaId: estadoActual.tarimaId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: firebase.database.ServerValue.TIMESTAMP,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horaEncendido: horaEncendido,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horaApagado: firebase.database.ServerValue.TIMESTAMP
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  actualizarContadoresTarimas(grupo, 'recolectadas');
Â  Â  Â  Â  Â  Â  Â  Â  ledRef.set(null);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  else {
Â  Â  Â  Â  const ledIdentifier = `${grupo}-${linea}-${idx + 1}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (usuarioActual.startsWith('CALIDAD_') && grupo === usuarioActual) {
Â  Â  Â  Â  Â  Â  if (!estadoActual.color) {
Â  Â  Â  Â  Â  Â  Â  Â  if (await mostrarConfirmacion(`Â¿Iniciar revisiÃ³n en el LED ${idx + 1}?`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ledRef.set({ color: 'naranja', timestamp: firebase.database.ServerValue.TIMESTAMP });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  db.ref(`historialLogs/${fecha}/${turno}`).push({ accion: 'revision_iniciada', led: ledIdentifier, grupo, usuario: usuarioActual, timestamp: firebase.database.ServerValue.TIMESTAMP });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (estadoActual.color === 'naranja') {
Â  Â  Â  Â  Â  Â  Â  Â  abrirModalCalidad(grupo, idx, linea, null);
Â  Â  Â  Â  Â  Â  } else if (estadoActual.color === 'rojo') {
Â  Â  Â  Â  Â  Â  Â  Â  if (await mostrarConfirmacion('Este LED fue rechazado. Â¿Confirmas que ha sido corregido y deseas liberarlo ahora?')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liberarLedSimple(grupo, idx, linea);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  await mostrarAlerta(`Este LED ya ha sido liberado.`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (CONFIG.PRODUCCION_GRUPOS.includes(usuarioActual) && grupo.startsWith('CALIDAD_')) {
Â  Â  Â  Â  Â  Â  if (estadoActual.color === 'verde') {
Â  Â  Â  Â  Â  Â  Â  Â  if (await mostrarConfirmacion(`Â¿Recibir material del LED de Calidad?`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ledRef.set(null);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  db.ref(`historialLogs/${fecha}/${turno}`).push({ accion: 'led_recibido', led: ledIdentifier, grupo, usuario: usuarioActual, timestamp: firebase.database.ServerValue.TIMESTAMP });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await mostrarAlerta('Material recibido. Ahora puedes encender un LED en tu Ã¡rea.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (CONFIG.PRODUCCION_GRUPOS.includes(usuarioActual) && grupo === usuarioActual) {
Â  Â  Â  Â  Â  Â  if (!estadoActual.encendido) {
Â  Â  Â  Â  Â  Â  Â  Â  if (await mostrarConfirmacion(`Â¿Encender LED para solicitar recolecciÃ³n?`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const logsRef = db.ref(`historialLogs/${fecha}/${turno}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const query = logsRef.orderByChild('grupo').equalTo(grupo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snapshot = await query.once('value');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let count = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snapshot.forEach(logSnap => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (logSnap.val().accion === 'led_encendido') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nuevoIdentificador = `Tarima ${count + 1}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ledRef.set({ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  encendido: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horaEncendido: firebase.database.ServerValue.TIMESTAMP,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tarimaId: nuevoIdentificador
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  db.ref(`historialLogs/${fecha}/${turno}`).push({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accion: 'led_encendido',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led: ledIdentifier,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tarimaId: nuevoIdentificador,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grupo,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuario: usuarioActual,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: firebase.database.ServerValue.TIMESTAMP,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horaEncendido: firebase.database.ServerValue.TIMESTAMP
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actualizarContadoresTarimas(grupo, 'encendidos');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  await mostrarAlerta(`Este LED ya estÃ¡ encendido y corresponde a la ${estadoActual.tarimaId}.`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (usuarioActual === 'LOGÃSTICA' || usuarioActual === 'SUPERVISOR') {
Â  Â  Â  Â  Â  Â  Â if (estadoActual.encendido) {
Â  Â  Â  Â  Â  Â  Â  Â  const nombreTarima = estadoActual.tarimaId || `LED ${grupo}-${idx + 1}`;
Â  Â  Â  Â  Â  Â  Â  Â  if (!(await mostrarConfirmacion(`Â¿Confirmas la recolecciÃ³n de ${nombreTarima}?`))) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const horaEncendido = estadoActual.horaEncendido;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  db.ref(`historialLogs/${fecha}/${turno}`).push({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuario: usuarioActual,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grupo,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accion: 'recolectada',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  led: ledIdentifier,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tarimaId: estadoActual.tarimaId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: firebase.database.ServerValue.TIMESTAMP,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horaEncendido: horaEncendido,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horaApagado: firebase.database.ServerValue.TIMESTAMP
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  actualizarContadoresTarimas(grupo, 'recolectadas');
Â  Â  Â  Â  Â  Â  Â  Â  ledRef.set(null);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
}


// ================= LÃ“GICA DE PROCESOS Y MODALES =================
async function liberarTarima(tarimaId, grupo) {
Â  Â  const { fecha, turno } = obtenerTurnoActual();
Â  Â Â 
Â  Â  await db.ref(`tarimas/${tarimaId}`).update({ estado: 'liberada', liberadaPor: usuarioSeleccionado, timestampLiberada: firebase.database.ServerValue.TIMESTAMP });
Â  Â Â 
Â  Â  await db.ref(`historialLogs/${fecha}/${turno}`).push({
Â  Â  Â  Â  usuario: usuarioSeleccionado, grupo, accion: 'liberada', tarimaId, timestamp: firebase.database.ServerValue.TIMESTAMP
Â  Â  });
Â  Â  actualizarContadoresTarimas(grupo, 'liberadas');
Â  Â  await mostrarAlerta(`âœ… Tarima ${tarimaId} liberada. ProducciÃ³n ahora puede recibirla.`);
Â  Â  cerrarModalCalidad();
}

async function liberarLedSimple(grupo, idx, linea) {
Â  Â  const { fecha, turno } = obtenerTurnoActual();
Â  Â  const ledIdentifier = `${grupo}-${linea}-${idx + 1}`;
Â  Â  await db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`).update({ color: 'verde' });
Â  Â  await db.ref(`historialLogs/${fecha}/${turno}`).push({ usuario: usuarioSeleccionado, grupo, accion: 'led_liberado', led: ledIdentifier, timestamp: firebase.database.ServerValue.TIMESTAMP });
Â  Â  actualizarContadoresTarimas(grupo, 'liberadas');
Â  Â  await mostrarAlerta(`âœ… LED liberado. ProducciÃ³n ahora puede recibirlo.`);
Â  Â  cerrarModalCalidad();
}


async function guardarRechazo() {
Â  Â  if (!ledSeleccionado.grupo) return;
Â  Â  const { grupo, tarimaId, idx, linea } = ledSeleccionado;
Â  Â  const form = document.getElementById('formularioRechazo');
Â  Â  const data = {
Â  Â  Â  Â  empleado: form.empleado.value, linea: form.linea.value, parte: form.parte.value,
Â  Â  Â  Â  descripcionParte: form.descripcionParte.value, problema: form.problema.value,
Â  Â  Â  Â  causa: form.causa.value, accion: form.accion.value, timestamp: firebase.database.ServerValue.TIMESTAMP
Â  Â  };
Â  Â Â 
Â  Â  if (esGrupoDeTarimas(grupo) && tarimaId) {
Â  Â  Â  Â  await db.ref(`tarimas/${tarimaId}`).update({ estado: 'rechazada', rechazo: data, rechazadoPor: usuarioSeleccionado, timestampRechazo: firebase.database.ServerValue.TIMESTAMP });
Â  Â  }
Â  Â Â 
Â  Â  const { fecha, turno } = obtenerTurnoActual();
Â  Â  const ledIdentifier = `${grupo}-${linea}-${idx + 1}`;
Â  Â  await db.ref(`historialLogs/${fecha}/${turno}`).push({ usuario: usuarioSeleccionado, grupo, accion: 'rechazada', tarimaId, led: ledIdentifier, detalles: data, timestamp: firebase.database.ServerValue.TIMESTAMP });
Â  Â  actualizarContadoresTarimas(grupo, 'rechazadas');
Â  Â  await db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`).update({ color: 'rojo' });
Â  Â Â 
Â  Â  await mostrarAlerta(`âŒ ${esGrupoDeTarimas(grupo) ? `Tarima ${tarimaId}` : 'LED'} rechazado.`);
Â  Â  cerrarModalRechazo();
Â  Â  form.reset();
}

async function confirmarTarimaProduccion(grupo, idx, linea) {
Â  Â  const select = document.getElementById('selectTarimaProduccion');
Â  Â  const tarimaKey = select.value;
Â  Â  if (!tarimaKey) return mostrarAlerta("Debes seleccionar una tarima.");

Â  Â  const recibidaRef = db.ref(`tarimasRecibidas/${grupo}/${tarimaKey}`);
Â  Â  const snapshot = await recibidaRef.once('value');
Â  Â  const tarima = snapshot.val();
Â  Â  if (!tarima) return mostrarAlerta("Tarima no encontrada.");

Â  Â  const { fecha, turno } = obtenerTurnoActual();
Â  Â  await db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`).set({
Â  Â  Â  Â  encendido: true,
Â  Â  Â  Â  tarimaId: tarima.tarimaId,
Â  Â  Â  Â  usuario: usuarioSeleccionado,
Â  Â  Â  Â  timestamp: firebase.database.ServerValue.TIMESTAMP,
Â  Â  Â  Â  horaEncendido: firebase.database.ServerValue.TIMESTAMP
Â  Â  });
Â  Â  await db.ref(`historialLogs/${fecha}/${turno}`).push({
Â  Â  Â  Â  usuario: usuarioSeleccionado,
Â  Â  Â  Â  grupo,
Â  Â  Â  Â  accion: 'confirmada_en_produccion',
Â  Â  Â  Â  tarimaId: tarima.tarimaId,
Â  Â  Â  Â  timestamp: firebase.database.ServerValue.TIMESTAMP
Â  Â  });
Â  Â  actualizarContadoresTarimas(grupo, 'confirmadas');
Â  Â  await recibidaRef.remove();
Â  Â  await mostrarAlerta(`âœ… Tarima ${tarima.tarimaId} confirmada en LED ${linea}-${idx+1}`);
Â  Â  cerrarModalProduccion();
}

let ledSeleccionado = { grupo: null, idx: null, linea: null, tarimaId: null };

function abrirModalCalidad(grupo, idx, linea, tarimaId) {
Â  Â  ledSeleccionado = { grupo, idx, linea, tarimaId };
Â  Â  const modal = document.getElementById('modalCalidad');
Â  Â  const titulo = document.getElementById('modalCalidadTitulo');
Â  Â Â 
Â  Â  titulo.textContent = esGrupoDeTarimas(grupo) ? 'Selecciona el estado de la tarima:' : 'Selecciona el estado del LED:';

Â  Â  modal.classList.add('visible');
Â  Â  const setupButton = (selector, callback) => {
Â  Â  Â  Â  const oldBtn = modal.querySelector(selector);
Â  Â  Â  Â  const newBtn = oldBtn.cloneNode(true);
Â  Â  Â  Â  oldBtn.parentNode.replaceChild(newBtn, oldBtn);
Â  Â  Â  Â  newBtn.onclick = callback;
Â  Â  };
Â  Â  setupButton('.opcion-btn[data-color="rojo"]', () => {
Â  Â  Â  Â  modal.classList.remove('visible');
Â  Â  Â  Â  document.getElementById('modalRechazo').classList.add('visible');
Â  Â  });
Â  Â  setupButton('.opcion-btn[data-color="verde"]', () => {
Â  Â  Â  Â  if (esGrupoDeTarimas(grupo)) {
Â  Â  Â  Â  Â  Â  liberarTarima(tarimaId, grupo);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  liberarLedSimple(grupo, idx, linea);
Â  Â  Â  Â  }
Â  Â  Â  Â  db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`).update({ color: 'verde' });
Â  Â  Â  Â  modal.classList.remove('visible');
Â  Â  });
Â  Â  modal.querySelector('.cerrar-btn').onclick = () => modal.classList.remove('visible');
}

function cerrarModalCalidad() { document.getElementById('modalCalidad').classList.remove('visible'); }
function cerrarModalRechazo() { document.getElementById('modalRechazo').classList.remove('visible'); }
function cerrarModalProduccion() { document.getElementById('modalAsignarTarimaProduccion').classList.remove('visible'); }

async function mostrarModalProduccion(grupo, idx, linea) {
Â  Â  const modal = document.getElementById('modalAsignarTarimaProduccion');
Â  Â  const selectTarima = modal.querySelector('#selectTarimaProduccion');
Â  Â  const selectLed = modal.querySelector('#selectLedProduccion');
Â  Â  ledSeleccionado = { grupo, idx, linea };

Â  Â  const snapshot = await db.ref(`tarimasRecibidas/${grupo}`).once('value');
Â  Â  const recibidas = snapshot.val() || {};
Â  Â  selectTarima.innerHTML = '';
Â  Â  const keys = Object.keys(recibidas);
Â  Â  if (keys.length === 0) return mostrarAlerta("âš ï¸ No hay tarimas recibidas de Calidad para confirmar.");
Â  Â  keys.forEach(k => {
Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  opt.value = k;
Â  Â  Â  Â  opt.textContent = `Tarima #${recibidas[k].tarimaId}`;
Â  Â  Â  Â  selectTarima.appendChild(opt);
Â  Â  });
Â  Â  selectLed.innerHTML = `<option value="${idx}">${linea}-${idx+1}</option>`;
Â  Â  modal.classList.add('visible');
}

document.getElementById('btnAsignarProduccion').addEventListener('click', () => {
Â  Â  const { grupo, idx, linea } = ledSeleccionado;
Â  Â  confirmarTarimaProduccion(grupo, idx, linea);
});

// ================= NAVEGACIÃ“N Y ARRANQUE =================
// INICIO: Funciones de sincronizaciÃ³n de tiempo
function getSyncedTime() {
    return new Date(new Date().getTime() + serverTimeOffset);
}

function formatoHora(timestamp) {
    if (!timestamp) return 'N/A';
    const date = new Date(timestamp);
    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
}

function obtenerTurnoActual() {
    const ahora = getSyncedTime();
    let fecha = new Date(ahora);
    let turno = (ahora.getHours() > 6 || (ahora.getHours() === 6 && ahora.getMinutes() >= 30)) && (ahora.getHours() < 18 || (ahora.getHours() === 18 && ahora.getMinutes() < 30)) ? 'Turno 1' : 'Turno 2';
    if (turno === 'Turno 2' && ahora.getHours() < 6) {
        fecha.setDate(ahora.getDate() - 1);
    }
    const fechaFormateada = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`;
    return { fecha: fechaFormateada, turno };
}
// FIN: Funciones de sincronizaciÃ³n de tiempo

function iniciarListenersFirebase() { const { fecha, turno: turnoActualString } = obtenerTurnoActual(); document.getElementById('turnoActual').textContent = `Turno actual: ${turnoActualString}`; const rutaHistorialTurno = `historialLogs/${fecha}/${turnoActualString}`; if (historialRef) historialRef.off(); historialRef = db.ref(rutaHistorialTurno); historialRef.on('value', (snapshot) => { const logs = snapshot.val() || {}; let tarimasRecolectadasTotales = 0, tiempoTotalRecoleccionMs = 0; const contadores = {}; const grupos = ['MULTIPORT', 'BEDROCK', 'DROPS', 'CALIDAD_MULTIPORT', 'CALIDAD_BEDROCK', 'CALIDAD_DROPS']; grupos.forEach(g => { contadores[g] = { confirmadas: 0, recolectadas: 0, liberadas: 0, rechazadas: 0, encendidos: 0 }; }); const tiempos = { MULTIPORT: [], BEDROCK: [], DROPS: [] }; Object.values(logs).forEach(log => { if (!log.grupo || !contadores[log.grupo]) return; switch (log.accion) { case 'confirmada_en_produccion': contadores[log.grupo].confirmadas++; break; case 'led_encendido': contadores[log.grupo].encendidos++; break; case 'recolectada': contadores[log.grupo].recolectadas++; tarimasRecolectadasTotales++; if (log.horaApagado && log.horaEncendido) { const duracionMs = log.horaApagado - log.horaEncendido; log.tiempoRecoleccion = Math.round(duracionMs / 60000); tiempoTotalRecoleccionMs += duracionMs; tiempos[log.grupo]?.push(log); } break; case 'rechazada': case 'led_rechazado': contadores[log.grupo].rechazadas++; break; case 'liberada': case 'led_liberado': contadores[log.grupo].liberadas++; break; } }); const tiempoPromedio = tarimasRecolectadasTotales > 0 ? Math.round(tiempoTotalRecoleccionMs / tarimasRecolectadasTotales / 60000) : 0; document.getElementById('tarimasTotales').textContent = tarimasRecolectadasTotales; document.getElementById('tiempoPromedio').textContent = `${tiempoPromedio} min`; document.getElementById('resumenTurno').classList.toggle('oculto', !(usuarioSeleccionado === 'LOGÃSTICA' || usuarioSeleccionado === 'SUPERVISOR')); Object.keys(contadores).forEach(grupo => { const el = document.querySelector(`.grupo[data-grupo="${grupo}"] .tarimas`); if (el) { const c = contadores[grupo]; if(grupo.startsWith('CALIDAD_')){ el.textContent = `Liberadas: ${c.liberadas} | Rechazadas: ${c.rechazadas}`; } else if(esGrupoDeTarimas(grupo)) { el.textContent = `Confirmadas: ${c.confirmadas}`; } else { el.textContent = `Tarimas: ${c.encendidos}`; } } }); Object.keys(tiempos).forEach(grupo => { const contenedorTiempos = document.querySelector(`.tiempos[data-grupo="${grupo}"]`); if (!contenedorTiempos) return; contenedorTiempos.innerHTML = ''; tiempos[grupo].sort((a, b) => b.timestamp - a.timestamp).forEach(log => { const p = document.createElement('p'); const id = log.tarimaId || log.led.replace(grupo + '-', ''); p.innerHTML = `<b>ID ${id}:</b> ${log.tiempoRecoleccion} min<br><small>Inicio: ${formatoHora(log.horaEncendido)} | Fin: ${formatoHora(log.horaApagado)}</small>`; contenedorTiempos.appendChild(p); }); }); }); }
function actualizarContadoresTarimas(grupo, accion) { const { fecha, turno } = obtenerTurnoActual(); db.ref(`contadoresTarimas/${fecha}/${turno}/${grupo}/${accion}`).transaction(val => (val || 0) + 1); }
function activarPantalla(id){ document.querySelectorAll('.pantalla').forEach(p => { p.style.display = 'none'; p.classList.remove('activa'); }); const pantalla = document.getElementById(id); if(pantalla) { pantalla.style.display = 'flex'; pantalla.classList.add('activa'); } }
function volverAPantalla1(){
Â  Â  usuarioSeleccionado = null;
Â  Â  if (historialRef) historialRef.off();
Â  Â  limpiarDashboardListeners();
Â  Â  document.getElementById('mtOpenBtn').style.display = 'none';
Â  Â  activarPantalla('pantalla1');
}
function aplicarFiltroSupervisor() {
Â  Â  const filtro = document.getElementById('filtroAreaSelect').value;
Â  Â  const grupos = document.querySelectorAll('#pantalla2 .grupo');
Â  Â  grupos.forEach(grupo => {
Â  Â  Â  Â  const grupoData = grupo.dataset.grupo;
Â  Â  Â  Â  if (filtro === 'TODAS') {
Â  Â  Â  Â  Â  Â  grupo.classList.remove('oculto');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const esAreaPrincipal = grupoData === filtro;
Â  Â  Â  Â  Â  Â  const esAreaCalidad = grupoData === `CALIDAD_${filtro}`;
Â  Â  Â  Â  Â  Â  if (esAreaPrincipal || esAreaCalidad) {
Â  Â  Â  Â  Â  Â  Â  Â  grupo.classList.remove('oculto');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  grupo.classList.add('oculto');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
}

async function seleccionarUsuario(usuario) {
Â  Â  const password = await mostrarPromptContraseÃ±a(`Introduce la contraseÃ±a para ${usuario}`);
Â  Â  if (password === null) return;Â 

Â  Â  let targetUser = usuario;
Â  Â  let isValid = false;

Â  Â  if (usuario === 'CALIDAD') {
Â  Â  Â  Â  if (password === appPasswords.CALIDAD_MULTIPORT) { targetUser = 'CALIDAD_MULTIPORT'; isValid = true; }
Â  Â  Â  Â  else if (password === appPasswords.CALIDAD_DROPS) { targetUser = 'CALIDAD_DROPS'; isValid = true; }
Â  Â  Â  Â  else if (password === appPasswords.CALIDAD_BEDROCK) { targetUser = 'CALIDAD_BEDROCK'; isValid = true; }
Â  Â  } else {
Â  Â  Â  Â  isValid = password === appPasswords[usuario];
Â  Â  }

Â  Â  if (isValid) {
Â  Â  Â  Â  usuarioSeleccionado = targetUser;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const fab = document.getElementById('mtOpenBtn');
Â  Â  Â  Â  if (fab) {
Â  Â  Â  Â  Â  Â  const canSeeFab = ['LOGÃSTICA', 'MULTIPORT', 'CALIDAD_MULTIPORT'].includes(targetUser);
Â  Â  Â  Â  Â  Â  fab.style.display = canSeeFab ? 'block' : 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('tituloFijo').textContent = targetUser.replace('_', ' ');

Â  Â  Â  Â  const filtroContainer = document.getElementById('filtro-supervisor-container');
Â  Â  Â  Â  if (targetUser === 'SUPERVISOR') {
Â  Â  Â  Â  Â  Â  filtroContainer.classList.add('visible');
Â  Â  Â  Â  Â  Â  document.getElementById('filtroAreaSelect').value = 'TODAS';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  filtroContainer.classList.remove('visible');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  activarPantalla('pantalla2');
Â  Â  Â  Â  inyectaLEDs();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (targetUser === 'SUPERVISOR') {
Â  Â  Â  Â  Â  Â  aplicarFiltroSupervisor();
Â  Â  Â  Â  }

Â  Â  Â  Â  pintarEstado();
Â  Â  Â  Â  iniciarListenersFirebase();
Â  Â  } else {
Â  Â  Â  Â  await mostrarAlerta('ContraseÃ±a incorrecta.');
Â  Â  }
}
async function seleccionarReporte() { const password = await mostrarPromptContraseÃ±a('Introduce la contraseÃ±a para REPORTES'); if (password === appPasswords.REPORTES) { activarPantalla('pantalla3'); regresarASelectores(); } else if (password !== null) { await mostrarAlerta('ContraseÃ±a incorrecta.'); } }
async function seleccionarDashboard() { const password = await mostrarPromptContraseÃ±a('Introduce la contraseÃ±a para DASHBOARD'); if (password === appPasswords.DASHBOARD) { activarPantalla('pantalla4'); iniciarDashboard(); } else if (password !== null) { await mostrarAlerta('ContraseÃ±a incorrecta.'); } }
async function seleccionarAjustes() { const password = await mostrarPromptContraseÃ±a('Introduce la contraseÃ±a de SUPERVISOR'); if (password === appPasswords.SUPERVISOR) { mostrarPantallaAjustes(); } else if (password !== null) { await mostrarAlerta('ContraseÃ±a incorrecta.'); } }
function limpiarDashboardListeners(){ dashboardListeners.forEach(l => l.ref.off(l.eventType, l.callback)); dashboardListeners = []; }
function iniciarDashboard(){ limpiarDashboardListeners(); const { fecha } = obtenerTurnoActual(); document.getElementById('fechaDashboard').value = fecha; document.getElementById('turnoDashboardSelect').value = 'todos'; const setup = () => setupDashboardListeners(document.getElementById('fechaDashboard').value, document.getElementById('turnoDashboardSelect').value); setup(); document.getElementById('fechaDashboard').addEventListener('change', setup); document.getElementById('turnoDashboardSelect').addEventListener('change', setup); }
function setupDashboardListeners(fecha, turno){ limpiarDashboardListeners(); const historialRefDash = db.ref(`historialLogs/${fecha}`); const ledsRefDash = db.ref('estadoLEDs'); const historialCallback = historialRefDash.on('value', snap => { const logsPorTurno = snap.val() || {}; let logsFiltrados = {}; if (turno === 'todos') Object.values(logsPorTurno).forEach(logs => Object.assign(logsFiltrados, logs)); else logsFiltrados = logsPorTurno[turno] || {}; actualizarDashboard(logsFiltrados, 'historial', null); }); dashboardListeners.push({ ref: historialRefDash, eventType: 'value', callback: historialCallback }); const ledsCallback = ledsRefDash.on('value', snap => actualizarDashboard(null, 'leds', snap.val() || {})); dashboardListeners.push({ ref: ledsRefDash, eventType: 'value', callback: ledsCallback }); }
function actualizarDashboard(historialLogs, tipo, estadoLEDs){ if (!document.getElementById('pantalla4').classList.contains('activa')) return; if (tipo === 'historial' && historialLogs) { let confirmadas = 0, recolectadas = 0, liberadas = 0, rechazadas = 0, tiempoTotalMs = 0; const prodPorArea = { MULTIPORT: 0, DROPS: 0, BEDROCK: 0 }; const recoleccionesPorHora = {}; Object.values(historialLogs).forEach(log => { switch(log.accion) { case 'confirmada_en_produccion': case 'led_encendido': confirmadas++; if (prodPorArea[log.grupo] !== undefined) prodPorArea[log.grupo]++; break; case 'recolectada': recolectadas++; if(log.horaApagado && log.horaEncendido) { tiempoTotalMs += (log.horaApagado - log.horaEncendido); } const hora = new Date(log.timestamp).getHours(); recoleccionesPorHora[hora] = (recoleccionesPorHora[hora] || 0) + 1; break; case 'liberada': case 'led_liberado': liberadas++; break; case 'rechazada': case 'led_rechazado': rechazadas++; break; } }); const tiempoPromedio = recolectadas > 0 ? (tiempoTotalMs / recolectadas / 60000).toFixed(1) : 0; const tasaRechazo = (liberadas + rechazadas) > 0 ? ((rechazadas / (liberadas + rechazadas)) * 100).toFixed(1) : 0; document.getElementById('dashTarimasConfirmadas').textContent = confirmadas; document.getElementById('dashTarimasRecolectadas').textContent = recolectadas; document.getElementById('dashTiempoPromedio').textContent = `${tiempoPromedio} min`; document.getElementById('dashTasaRechazo').textContent = `${tasaRechazo}%`; document.getElementById('kpiTiempoPromedio').classList.toggle('alerta', tiempoPromedio > 10); document.getElementById('kpiTasaRechazo').classList.toggle('alerta', tasaRechazo > 5); generarGraficoProduccionDash(prodPorArea); generarGraficoCalidadDash({ liberadas, rechazadas }); generarGraficoLogisticaDash(recoleccionesPorHora); } if (tipo === 'leds' && estadoLEDs) { const pendientes = { MULTIPORT: 0, DROPS: 0, BEDROCK: 0 }; CONFIG.PRODUCCION_GRUPOS.forEach(grupo => { if(estadoLEDs[grupo]) Object.values(estadoLEDs[grupo]).forEach(linea => Object.values(linea).forEach(led => { if(led?.encendido) pendientes[grupo]++; })); }); const tablaBody = document.querySelector('#tablaPendientes tbody'); tablaBody.innerHTML = Object.entries(pendientes).map(([area, count]) => `<tr><td>${area}</td><td>${count}</td></tr>`).join(''); } }
function generarGraficoProduccionDash(datos){ if (graficosDashboard.produccion) graficosDashboard.produccion.destroy(); const ctx = document.getElementById('graficoProduccionDash').getContext('2d'); graficosDashboard.produccion = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(datos), datasets: [{ label: 'Tarimas', data: Object.values(datos), backgroundColor: ['#4BC0C0', '#36A2EB', '#FFCE56'] }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#fff', stepSize: 1 } }, x: { ticks: { color: '#fff' } } }, plugins: { legend: { display: false } } } }); }
function generarGraficoCalidadDash(datos){ if (graficosDashboard.calidad) graficosDashboard.calidad.destroy(); const ctx = document.getElementById('graficoCalidadDash').getContext('2d'); graficosDashboard.calidad = new Chart(ctx, { type: 'pie', data: { labels: ['Liberadas', 'Rechazadas'], datasets: [{ data: [datos.liberadas, datos.rechazadas], backgroundColor: ['#4caf50', '#f44336'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#fff' } } } } }); }
function generarGraficoLogisticaDash(tarimasPorHora){ if (graficosDashboard.logistica) graficosDashboard.logistica.destroy(); const ctx = document.getElementById('graficoLogisticaDash').getContext('2d'); const labels = Array.from({length: 24}, (_, i) => `${i}:00`); const data = labels.map((_, i) => tarimasPorHora[i] || 0); graficosDashboard.logistica = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Tarimas Recolectadas', data, backgroundColor: '#36A2EB' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Tarimas', color: '#fff' }, ticks: { stepSize: 1, color: '#fff' } }, x: { title: { display: true, text: 'Hora', color: '#fff' }, ticks: { color: '#fff' } } }, plugins: { legend: { display: false } } } }); }
function mostrarReporte(tipo){reporteActual=tipo;document.getElementById("contenedorSelectorReporte").style.display="none";const e=document.getElementById("contenedorReporte");e.style.display="block";const{fecha:t}=obtenerTurnoActual();let o="";"resumen"!==tipo&&"tarimas"!==tipo&&(o=`<label for="areaFiltro">Ãrea:</label><select id="areaFiltro">${["TODAS","MULTIPORT","DROPS","BEDROCK","CALIDAD_MULTIPORT","CALIDAD_DROPS","CALIDAD_BEDROCK"].map(e=>`<option value="${e}">${e.replace("CALIDAD_","Calidad ")}</option>`).join("")}</select>`),e.innerHTML=`<div class="header-reporte"><button onclick="regresarASelectores()" class="usuario-btn">Regresar</button><div class="filtros"><label for="fechaReporte">Fecha:</label><input type="date" id="fechaReporte" value="${t}"><label for="turnoFiltro">Turno:</label><select id="turnoFiltro"><option value="todos">Todos</option><option value="Turno 1">Turno 1</option><option value="Turno 2">Turno 2</option></select>${o}<button onclick="buscarReporte()" class="usuario-btn">Buscar</button></div></div><h2 id="tituloReporteDinamico">Cargando...</h2><div id="opcionesGrafico" class="opciones-grafico" style="display:none;"><label>Tipo de GrÃ¡fico:</label><select id="tipoGrafico"><option value="bar">Barras</option><option value="pie">Pastel</option><option value="line">LÃ­nea</option></select></div><div id="contenidoReporte"></div><div class="botones-reporte"><select id="exportFormatSelect"><option value="" disabled selected>Exportar como...</option><option value="excel">Excel (.xlsx)</option><option value="pdf">PDF</option><option value="csv">CSV</option></select><button class="usuario-btn" onclick="exportarReporteUnificado()">Exportar</button></div>`,document.getElementById("turnoFiltro").value="todos",document.getElementById("tipoGrafico")?.addEventListener("change",actualizarGraficoReporte),buscarReporte()}
function actualizarGraficoReporte(){if(!datosFiltradosReporte)return;const e=document.getElementById("tipoGrafico").value,t=document.querySelector("#grafico-contenedor");if(!t)return;t.innerHTML='<canvas id="graficoDinamico"></canvas>';let o,n,l,a="";"produccion"===reporteActual?(o=Object.keys(n=datosFiltradosReporte.reduce((e,t)=>(e[t.grupo]=(e[t.grupo]||0)+1,e),{})),l=Object.values(n),a="Tarimas Confirmadas"):"logistica"===reporteActual?(o=Object.keys(n=datosFiltradosReporte.reduce((e,t)=>(e[t.grupo]=(e[t.grupo]||0)+1,e),{})),l=Object.values(n),a="Tarimas Recolectadas"):"calidad"===reporteActual&&(o=Object.keys(n=datosFiltradosReporte.reduce((e,t)=>{const o=t.detalles?.problema||"No especificado";return e[o]=(e[o]||0)+1,e},{})),l=Object.values(n),a="NÃºmero de Rechazos"),miGrafico&&miGrafico.destroy();const r=document.getElementById("graficoDinamico").getContext("2d");miGrafico=new Chart(r,{type:e,data:{labels:o,datasets:[{label:a,data:l,backgroundColor:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40"]}]},options:{responsive:!0,plugins:{title:{display:!0,text:a,font:{size:20}}}}})}
function regresarASelectores(){document.getElementById("tituloReportes").textContent="REPORTES";document.getElementById("contenedorSelectorReporte").style.display="block";const e=document.getElementById("contenedorReporte");e.innerHTML="",e.style.display="none",miGrafico&&miGrafico.destroy(),datosFiltradosReporte=null}
function buscarReporte(){const e=reporteActual,t=document.getElementById("fechaReporte").value,o=document.getElementById("turnoFiltro").value,n=document.getElementById("areaFiltro")?.value||"TODAS";cargarDatosReporte(e,t,o,n)}
function cargarDatosReporte(e,t,o,n){const l=document.getElementById("contenidoReporte"),a=document.getElementById("tituloReporteDinamico");l.innerHTML="<p>Cargando datos...</p>",miGrafico&&miGrafico.destroy(),db.ref(`historialLogs/${t}`).once("value").then(r=>{const i=r.val()||{};let s=[];"todos"===o?Object.values(i).forEach(e=>{s.push(...Object.values(e))}):i[o]&&(s=Object.values(i[o]));const d="TODAS"===n?s:s.filter(e=>e.grupo===n);switch(a.textContent=`Reporte de ${e.charAt(0).toUpperCase() + e.slice(1)} - ${t} (${"todos"===o?"Todos los turnos":o})`,e){case"produccion":procesarReporteProduccion(d,l);break;case"logistica":procesarReporteLogistica(d,l);break;case"calidad":procesarReporteCalidad(d,l);break;case"tarimas":procesarReporteTarimas(s,l);break;case"resumen":procesarReporteResumen(s,l)}}).catch(e=>{console.error("Error al cargar datos:",e),l.innerHTML="<p>Error al cargar los datos.</p>"})}
function formatoFechaYHora(e){return e?new Date(e).toLocaleString("es-MX",{dateStyle:"short",timeStyle:"short"}):"N/A"}
function procesarReporteCalidad(e,t){datosFiltradosReporte=e.filter(e=>"rechazada"===e.accion);const o=datosFiltradosReporte.length;let n=`<div class="resumen-datos"><div class="dato"><div class="valor">${o}</div><div class="etiqueta">Total Rechazos</div></div></div>`,l='<table><thead><tr><th>Fecha y Hora</th><th>Ãrea</th><th>LÃ­nea</th><th>Tarima ID</th><th>Empleado</th><th>No. de Parte</th><th>Problema</th><th>Causa</th><th>AcciÃ³n</th></tr></thead><tbody>',a='<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">';datosFiltradosReporte.forEach(e=>{const t=e.detalles||{};l+=`<tr><td>${formatoFechaYHora(e.timestamp)}</td><td>${e.grupo}</td><td>${t.linea||"N/A"}</td><td>${e.tarimaId||e.led||"N/A"}</td><td>${t.empleado||"N/A"}</td><td>${t.parte||"N/A"}</td><td>${t.problema||"N/A"}</td><td>${t.causa||"N/A"}</td><td>${t.accion||"N/A"}</td></tr>`,a+=`<div class="fila-dato"><span class="etiqueta">ID:</span><span class="valor">${e.tarimaId||e.led||"N/A"}</span><br><span class="etiqueta">Ãrea:</span><span class="valor">${e.grupo}</span><br><span class="etiqueta">LÃ­nea:</span><span class="valor">${t.linea||"N/A"}</span><br><span class="etiqueta">Problema:</span><span class="valor">${t.problema||"N/A"}</span></div>`}),l+="</tbody></table>",a+='</div></div>',document.getElementById("opcionesGrafico").style.display="block",t.innerHTML=n+'<div id="grafico-contenedor" class="grafico-contenedor"></div>'+l+a,actualizarGraficoReporte()}
function procesarReporteProduccion(e,t){datosFiltradosReporte=e.filter(e=>"confirmada_en_produccion"===e.accion||"led_encendido"===e.accion);const o=datosFiltradosReporte.length;let n=`<div class="resumen-datos"><div class="dato"><div class="valor">${o}</div><div class="etiqueta">Total Confirmadas/Encendidas</div></div></div>`,l="<table><thead><tr><th>Hora</th><th>Ãrea</th><th>Identificador</th></tr></thead><tbody>",a='<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">';datosFiltradosReporte.forEach(e=>{const t=e.horaEncendido||e.timestamp;l+=`<tr><td>${formatoHora(t)}</td><td>${e.grupo}</td><td>${e.tarimaId||e.led}</td></tr>`,a+=`<div class="fila-dato"><span class="etiqueta">ID:</span><span class="valor">${e.tarimaId||e.led}</span><br><span class="etiqueta">Ãrea:</span><span class="valor">${e.grupo}</span><br><span class="etiqueta">Hora Inicio:</span><span class="valor">${formatoHora(t)}</span></div>`}),l+="</tbody></table>",a+='</div></div>',document.getElementById("opcionesGrafico").style.display="block",t.innerHTML=n+'<div id="grafico-contenedor" class="grafico-contenedor"></div>'+l+a,actualizarGraficoReporte()}
function procesarReporteLogistica(logs, contenedor) {
    datosFiltradosReporte = logs.filter(log => log.accion === 'recolectada');
    const logsValidos = datosFiltradosReporte.filter(log => log.horaApagado && log.horaEncendido);

    const totalRecolectadas = datosFiltradosReporte.length;
    const tiempoTotalMs = logsValidos.reduce((sum, log) => sum + (log.horaApagado - log.horaEncendido), 0);
    const tiempoPromedio = logsValidos.length > 0 ? (tiempoTotalMs / logsValidos.length / 60000).toFixed(1) : 0;

    let resumenHtml = `<div class="resumen-datos">
        <div class="dato"><div class="valor">${totalRecolectadas}</div><div class="etiqueta">Total Recolectadas</div></div>
        <div class="dato"><div class="valor">${tiempoPromedio} min</div><div class="etiqueta">Tiempo Promedio</div></div>
    </div>`;

    let tablaHtml = '<table><thead><tr><th>Ãrea</th><th>Identificador</th><th>Hora de Inicio</th><th>Hora de RecolecciÃ³n</th><th>Tiempo (min)</th></tr></thead><tbody>';
    let movilHtml = '<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">';

    datosFiltradosReporte.forEach(log => {
        const tiempoRecoleccion = (log.horaApagado && log.horaEncendido) ? Math.round((log.horaApagado - log.horaEncendido) / 60000) : 'N/A';
        tablaHtml += `<tr>
            <td>${log.grupo}</td>
            <td>${log.tarimaId || log.led}</td>
            <td>${formatoHora(log.horaEncendido)}</td>
            <td>${formatoHora(log.horaApagado)}</td>
            <td>${tiempoRecoleccion}</td>
        </tr>`;
        movilHtml += `<div class="fila-dato">
            <span class="etiqueta">Ãrea:</span><span class="valor">${log.grupo}</span><br>
            <span class="etiqueta">ID:</span><span class="valor">${log.tarimaId || log.led}</span><br>
            <span class="etiqueta">Tiempo:</span><span class="valor">${tiempoRecoleccion} min</span>
        </div>`;
    });

    tablaHtml += '</tbody></table>';
    movilHtml += '</div></div>';

    document.getElementById("opcionesGrafico").style.display = "block";
    contenedor.innerHTML = resumenHtml + '<div id="grafico-contenedor" class="grafico-contenedor"></div>' + tablaHtml + movilHtml;
    actualizarGraficoReporte();
}
function procesarReporteResumen(e,t){const o={};["MULTIPORT","DROPS","BEDROCK"].forEach(e=>{o[e]={confirmadas:0,recolectadas:0,liberadas:0,rechazadas:0,tiempoTotalMs:0,recoleccionesValidas:0}}),e.forEach(e=>{const t=e.grupo?.replace("CALIDAD_","");if(o[t])switch(e.accion){case"confirmada_en_produccion":case"led_encendido":o[t].confirmadas++;break;case"recolectada":o[t].recolectadas++;if(e.horaApagado&&e.horaEncendido){o[t].tiempoTotalMs+=e.horaApagado-e.horaEncendido;o[t].recoleccionesValidas++}break;case"liberada":case"led_liberado":o[t].liberadas++;break;case"rechazada":case"led_rechazado":o[t].rechazadas++}});let n="";["MULTIPORT","DROPS","BEDROCK"].forEach(e=>{const t=o[e],l=(t.liberadas+t.rechazadas>0?(t.rechazadas/(t.liberadas+t.rechazadas))*100:0).toFixed(1),a=(t.recoleccionesValidas>0?t.tiempoTotalMs/t.recoleccionesValidas/60000:0).toFixed(1);n+=`<h3>${e}</h3><div class="resumen-datos"><div class="dato"><div class="valor">${t.confirmadas}</div><div class="etiqueta">Confirmadas/Encendidas</div></div><div class="dato"><div class="valor">${t.liberadas}</div><div class="etiqueta">Liberadas</div></div><div class="dato"><div class="valor">${t.rechazadas}</div><div class="etiqueta">Rechazadas</div></div><div class="dato"><div class="valor">${l}%</div><div class="etiqueta">Tasa Rechazo</div></div><div class="dato"><div class="valor">${a} min</div><div class="etiqueta">Tiempo RecolecciÃ³n</div></div></div>`}),t.innerHTML=n}
function procesarReporteTarimas(logs, contenedor) {
Â  Â  datosFiltradosReporte = logs;
Â  Â  const tarimasConfirmadasIds = new Set();
Â  Â  logs.forEach(log => {
Â  Â  Â  Â  if (log.accion === 'confirmada_en_produccion' && log.grupo === 'MULTIPORT' && log.tarimaId) {
Â  Â  Â  Â  Â  Â  tarimasConfirmadasIds.add(log.tarimaId);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  if (tarimasConfirmadasIds.size === 0) {
Â  Â  Â  Â  contenedor.innerHTML = '<p>No se encontraron tarimas confirmadas por Multiport para el perÃ­odo seleccionado.</p>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const tarimasConHistorial = {};
Â  Â  logs.forEach(log => {
Â  Â  Â  Â  if (log.tarimaId && tarimasConfirmadasIds.has(log.tarimaId)) {
Â  Â  Â  Â  Â  Â  if (!tarimasConHistorial[log.tarimaId]) tarimasConHistorial[log.tarimaId] = [];
Â  Â  Â  Â  Â  Â  tarimasConHistorial[log.tarimaId].push(log);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  const resumenHtml = `<div class="resumen-datos"><div class="dato"><div class="valor">${tarimasConfirmadasIds.size}</div><div class="etiqueta">Tarimas Encontradas</div></div></div>`;
Â  Â  let tablaHtml = '<table><thead><tr><th>Tarima ID</th><th>Estado Actual</th><th>Trazabilidad</th></tr></thead><tbody>';
Â  Â  let movilHtml = '<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">';

Â  Â  for (const tarimaId of Array.from(tarimasConfirmadasIds).sort()) {
Â  Â  Â  Â  const historial = tarimasConHistorial[tarimaId] || [];
Â  Â  Â  Â  historial.sort((a, b) => a.timestamp - b.timestamp);

Â  Â  Â  Â  let estadoActual = 'Estado desconocido';
Â  Â  Â  Â  const ultimoEvento = historial[historial.length - 1];
Â  Â  Â  Â  if (ultimoEvento) {
Â  Â  Â  Â  Â  Â  switch(ultimoEvento.accion) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'recolectada':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  estadoActual = `âœ… Recolectada por ${ultimoEvento.usuario} (${formatoHora(ultimoEvento.timestamp)})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'confirmada_en_produccion':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  estadoActual = `â³ En ProducciÃ³n (${formatoHora(ultimoEvento.timestamp)})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  estadoActual = 'En proceso...';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  let trazabilidadHtml = '<ul style="padding-left: 15px; margin: 0; font-size: 0.85em;">';
Â  Â  Â  Â  historial.forEach(log => {
Â  Â  Â  Â  Â  Â  let accionTexto = log.accion.replace(/_/g, ' ');
Â  Â  Â  Â  Â  Â  accionTexto = accionTexto.charAt(0).toUpperCase() + accionTexto.slice(1);
Â  Â  Â  Â  Â  Â  let usuario = log.usuario || log.grupo;
Â  Â  Â  Â  Â  Â  trazabilidadHtml += `<li><b>${formatoFechaYHora(log.timestamp)}</b>: ${accionTexto} por <i>${usuario}</i></li>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  trazabilidadHtml += '</ul>';

Â  Â  Â  Â  tablaHtml += `<tr><td><b>${tarimaId}</b></td><td>${estadoActual}</td><td>${trazabilidadHtml}</td></tr>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  movilHtml += `<div class="fila-dato">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Tarima ID:</span><span class="valor">${tarimaId}</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Estado Actual:</span><span class="valor">${estadoActual}</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="etiqueta">Ãšltima ActualizaciÃ³n:</span><span class="valor">${ultimoEvento ? formatoFechaYHora(ultimoEvento.timestamp) : 'N/A'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  }

Â  Â  tablaHtml += '</tbody></table>';
Â  Â  movilHtml += '</div></div>';
Â  Â  contenedor.innerHTML = resumenHtml + tablaHtml + movilHtml;
Â  Â  document.getElementById("opcionesGrafico").style.display = "none";
}
function exportarReporteUnificado(){const e=document.getElementById("exportFormatSelect").value;if(!e)return void mostrarAlerta("Por favor, selecciona un formato de exportaciÃ³n.");exportarReporte(e)}
async function exportarReporte(e){const t=document.querySelector("#contenidoReporte table");if(!t||!datosFiltradosReporte)return mostrarAlerta("No hay datos para exportar.");const o=`${reporteActual}_${document.getElementById("fechaReporte").value}`;"excel"===e?(()=>{const e=XLSX.utils.table_to_sheet(t),o=XLSX.utils.book_new();XLSX.utils.book_append_sheet(o,e,"Reporte"),XLSX.writeFile(o,`${o}.xlsx`)})():"pdf"===e?exportarAPdf(t,miGrafico,o):"csv"===e&&exportarACsv(t,o)}
function exportarACsv(e,t){let o=[];e.querySelectorAll("tr").forEach(e=>{let t=[];e.querySelectorAll("th, td").forEach(e=>{t.push(`"${e.textContent.trim().replace(/"/g,'""')}"`)}),o.push(t.join(","))});const n=new Blob([o.join("\n")],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a");l.href=URL.createObjectURL(n),l.download=`${t}.csv`,l.click()}
function exportarAPdf(e,t,o){const n=new window.jspdf.jsPDF({orientation:"landscape"});n.text(`Reporte de ${reporteActual}`,20,20),t&&n.addImage(t.toBase64Image(),"PNG",20,30,120,70),n.autoTable({html:e,startY:t?110:30}),n.save(`${o}.pdf`)}

function cargarConfiguracionGlobal() { db.ref('configuracion/passwords').once('value').then(snap => { if(snap.exists()) { Object.assign(appPasswords, snap.val()); } }); }
function mostrarPantallaAjustes() { activarPantalla('pantalla5'); const form = document.getElementById('formAjustes'); form.innerHTML = ''; let inputsHtml = ''; Object.keys(appPasswords).sort().forEach(key => { inputsHtml += `<label for="pass-${key}">${key.replace(/_/g, ' ')}:</label><input type="text" id="pass-${key}" value="${appPasswords[key]}">`; }); form.innerHTML = inputsHtml; }
async function guardarContraseÃ±as() { const nuevas = {}; let changed = false; for (const key in appPasswords) { const inputVal = document.getElementById(`pass-${key}`).value.trim(); if (inputVal) { nuevas[key] = inputVal; if(inputVal !== appPasswords[key]) changed = true; } else { mostrarAlerta(`El campo para ${key} no puede estar vacÃ­o.`); return; } } if(changed) { if (await mostrarConfirmacion("Â¿EstÃ¡s seguro de que quieres guardar las nuevas contraseÃ±as?")) { db.ref('configuracion/passwords').set(nuevas).then(() => { appPasswords = nuevas; mostrarAlerta("âœ… Â¡ContraseÃ±as actualizadas con Ã©xito!"); }).catch(err => mostrarAlerta("Error al guardar: " + err.message)); } } else { mostrarAlerta("No se detectaron cambios."); } }

window.addEventListener('load', ()=>{
Â  Â  firebase.auth().signInAnonymously().catch(e => console.error('Auth error:', e));

Â  Â  // INICIO: Sincronizar offset de tiempo con el servidor
Â  Â  const offsetRef = firebase.database().ref(".info/serverTimeOffset");
Â  Â  offsetRef.on("value", (snap) => {
Â  Â  Â  Â  serverTimeOffset = snap.val() || 0;
Â  Â  });
Â  Â  // FIN: Sincronizar offset

Â  Â  cargarConfiguracionGlobal();
Â  Â Â 
Â  Â  setTimeout(() => {
Â  Â  Â  Â  const splash = document.getElementById('splashScreen');
Â  Â  Â  Â  splash.style.opacity = '0';
Â  Â  Â  Â  splash.addEventListener('transitionend', () => {
Â  Â  Â  Â  Â  Â  splash.classList.remove('activa');
Â  Â  Â  Â  Â  Â  activarPantalla('pantalla1');
Â  Â  Â  Â  }, { once: true });
Â  Â  }, 2000);

Â  Â  document.getElementById('modalRechazo').querySelector('form').addEventListener('submit', e => { e.preventDefault(); guardarRechazo(); });
Â  Â  document.getElementById('selectoresReportes').querySelectorAll('.usuario-btn').forEach(btn => btn.addEventListener('click', () => mostrarReporte(btn.dataset.reporte)));
Â  Â  if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').then(reg => console.log("âœ… SW Registrado")).catch(err => console.error("âŒ Error SW:", err));

Â  Â  document.getElementById('filtroAreaSelect').addEventListener('change', aplicarFiltroSupervisor);

Â  Â  setInterval(actualizarTodosLosContadores, 10000);
});
</script>
</body>
</html>