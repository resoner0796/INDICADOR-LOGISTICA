<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Logรญstica</title>
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
ย --btn-bg: #0066cc;
ย --btn-bg-hover: #004c99;
ย --grid-size: 26px;
ย --vignette: rgba(0,0,0,0.9);
ย --titulo-size: clamp(42px,7vw,96px);
ย --led-size: 50px;
ย --led-gap: 16px;
ย --led-off-core: #111;
ย --led-off-edge: #000;
ย --led-on-core: #0f0;
ย --led-on-edge: #063;
ย --glow: #00ff88;
ย --blink-duration: 0.9s;
}

*{ box-sizing: border-box; }
html, body{ height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:#111; }

.pantalla{ display:none; width:100%; min-height:100vh; }
.pantalla.activa{ display:flex; flex-direction:column; }

#pantalla1{
ย align-items:center;
ย justify-content:center;
ย flex-direction: column;
ย background:linear-gradient(135deg,#222,#444);
ย gap:18px;
}
.btn-contenedor{
ย display:flex;
ย flex-direction:column;
ย align-items:center;
}

#pantalla1 h1{ margin:0 0 8px; }
.usuario-btn{
ย background: var(--btn-bg);
ย color:#fff;
ย border:0;
ย padding:14px 28px;
ย margin:8px;
ย border-radius:10px;
ย font-size:18px;
ย cursor:pointer;
ย transition: background .25s ease;
ย outline-color: #000;
}
.usuario-btn:hover{ background: var(--btn-bg-hover); }

#pantalla2{
ย background-color:#000;
ย background-image:
ย ย radial-gradient(circle, rgba(60,60,60,.28) 20%, transparent 21%),
ย ย radial-gradient(circle, #101010 20%, transparent 21%);
ย background-size: var(--grid-size) var(--grid-size);
ย box-shadow: inset 0 0 90px var(--vignette);
ย overflow-y: auto; /* Permite el scroll solo en esta pantalla */
}
.header{ display:flex; align-items:center; justify-content:center; padding:16px 20px 6px; position: relative; }
#tituloFijo{
ย font-weight:800;
ย text-align:center;
ย letter-spacing:.5px;
ย text-shadow:0 2px 8px rgba(0,0,0,.65);
ย font-size:var(--titulo-size);
}
#turnoActual {
ย position: absolute;
ย top: 10px;
ย right: 10px;
ย font-size: 1.2rem;
ย font-weight: bold;
ย background-color: rgba(0,0,0,0.5);
ย padding: 5px 10px;
ย border-radius: 5px;
}
.zona-centro{
ย flex:1;
ย display:flex;
ย align-items:center;
ย justify-content:center;
ย padding:10px 24px 28px;
ย flex-direction: column;
}
.grupo-contenedor{
ย display: flex;
ย flex-wrap: wrap;
ย gap: clamp(24px, 4vw, 64px);
ย width: min(1200px, 96vw);
ย justify-content: center;
}
.grupo.oculto {
ย display: none;
}
.grupo{ display:flex; flex-direction:column; align-items:center; text-align:center; }
.grupo .nombre{ font-size: clamp(20px,2.2vw,28px); font-weight:800; margin-bottom:8px; letter-spacing:.5px; text-shadow:0 1px 6px rgba(0,0,0,.5); }
.grupo .tarimas{ font-size: clamp(16px,1.7vw,22px); opacity:.9; margin-bottom:14px; }
.leds{ display:flex; gap: var(--led-gap); justify-content:center; align-items:center; flex-wrap:nowrap; padding:4px; }
.led{
ย width: var(--led-size);
ย height: var(--led-size);
ย border-radius:50%;
ย cursor:pointer;
ย background: radial-gradient(circle at 45% 40%, var(--led-off-core) 40%, var(--led-off-edge) 100%);
ย box-shadow: inset -4px -5px 8px rgba(0,0,0,.8), inset 4px 5px 6px rgba(255,255,255,.06), 0 1px 0 rgba(255,255,255,.05);
ย transition: transform .1s ease, filter .2s ease, box-shadow .2s ease;
}
.led:active{ transform: scale(.96); }
.led.on{
ย background: radial-gradient(circle at 48% 45%, var(--led-on-core) 40%, var(--led-on-edge) 100%);
ย box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
ย animation: blink var(--blink-duration) ease-in-out infinite;
}
.led.disabled {
ย ย cursor: not-allowed;
ย ย pointer-events: none;
}

.resumen-turno {
ย display: flex;
ย justify-content: center;
ย gap: 40px;
ย margin-bottom: 20px;
ย background-color: #222;
ย border-radius: 12px;
ย padding: 15px 30px;
ย box-shadow: 0 4px 10px rgba(0,0,0,.3);
ย width: min(800px, 90vw);
}
.resumen-turno.oculto {
ย display: none;
}
.dato-resumen {
ย text-align: center;
}
.dato-resumen .etiqueta {
ย font-size: 14px;
ย opacity: 0.7;
ย text-transform: uppercase;
ย margin-bottom: 4px;
}
.dato-resumen .valor {
ย font-size: 32px;
ย font-weight: bold;
ย letter-spacing: 1px;
}
.tiempos{
ย margin-top: 10px;
ย font-size: 14px;
ย opacity: 0.8;
ย text-align: left;
ย width: 100%;
ย max-height: 200px;
ย overflow-y: auto;
}
.btn-rojo{
ย background: #cc0000;
ย outline-color: #000;
}
.btn-rojo:hover{
ย background: #990000;
}
.footer{
ย width: 100%;
ย display: flex;
ย justify-content: center;
ย padding: 20px;
}
.footer .usuario-btn{
ย padding: 10px 20px;
ย font-size: 16px;
}
.contadores-calidad {
ย display: flex;
ย gap: 20px;
ย justify-content: center;
ย margin-top: 10px;
}
.contador-calidad {
ย text-align: center;
ย font-size: 14px;
ย font-weight: bold;
}
.contador-calidad .valor {
ย font-size: 20px;
ย font-weight: bold;
}
.contador-calidad .etiqueta {
ย font-size: 12px;
ย opacity: 0.8;
}

@media(max-width:720px){ย
ย .grupo-contenedor{ย
ย ย display: flex;
ย ย flex-direction: column;
ย ย gap: 24px;
ย ย width: 100%;
ย }
}
@keyframes blink {
ย 0%, 100% {
ย ย box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
ย }
ย 50% {
ย ย box-shadow: 0 0 40px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
ย }
}

/* Estilos base para ocultar los modales */
.modal-calidad,
.modal {
ย position: fixed;
ย top: 0;
ย left: 0;
ย width: 100%;
ย height: 100%;
ย background-color: rgba(0, 0, 0, 0.8);
ย display: flex;
ย justify-content: center;
ย align-items: center;
ย z-index: 1000;
ย /* ๐ก Estas dos lรญneas son la clave para ocultarlos */
ย visibility: hidden;
ย opacity: 0;
ย transition: opacity 0.3s ease, visibility 0.3s ease;
}

/* Esta clase es la que tu JavaScript debe agregar para mostrar el modal */
.modal-calidad.visible,
.modal.visible {
ย visibility: visible;
ย opacity: 1;
}

/* Estilos de los contenedores de los modales (los que ya tenรญas) */
#modalCalidad .modal-content,
#modalRechazo .modal-content,
#modalOpcionesCalidad .modal-content,
#modalAsignarTarimaProduccion .modal-content {
ย background-color: #1c1c1c !important;
ย color: #eee !important;
ย padding: 25px 35px;
ย border-radius: 12px;
ย text-align: center;
ย max-width: 450px;
ย width: 90%;
ย box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}
ยย
/* ================= CSS DEL MODAL DE CALIDAD ================= */
#modalCalidad .modal-content,
#modalRechazo .modal-content {
ย background-color: #1c1c1c !important;
ย color: #eee !important;
ย padding: 25px 35px;
ย border-radius: 12px;
ย text-align: center;
ย max-width: 450px;
ย width: 90%;
ย box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}
#modalCalidad h3,
#modalRechazo h3 {
ย color: #f0f0f0 !important;
}
#modalCalidad .opcion-btn,
#modalRechazo .opcion-btn {
ย padding: 12px 20px;
ย font-size: 16px;
ย font-weight: bold;
ย border: none;
ย border-radius: 6px;
ย cursor: pointer;
ย transition: transform 0.15s ease;
}
#modalCalidad .opcion-btn[data-color="rojo"] { background: #d32f2f; color: #fff; }
#modalCalidad .opcion-btn[data-color="verde"] { background: #2e7d32; color: #fff; }
#modalCalidad .opcion-btn:hover { transform: scale(1.05); }


/* Nuevo CSS para el formulario de rechazo */
#modalRechazo .modal-content {
ย text-align: left;
}
#modalRechazo .modal-content h3 {
ย text-align: center;
ย margin-bottom: 30px;
}
#modalRechazo form {
ย display: flex;
ย flex-direction: column;
ย gap: 15px;
}
#modalRechazo label {
ย font-size: 16px;
ย margin-bottom: 5px;
ย display: block;
}
#modalRechazo input, #modalRechazo textarea {
ย width: 100%;
ย padding: 10px;
ย border-radius: 5px;
ย border: 1px solid #555;
ย background-color: #333;
ย color: #fff;
ย font-size: 16px;
}
#modalRechazo textarea {
ย resize: vertical;
ย min-height: 80px;
}
#modalRechazo button[type="submit"] {
ย margin-top: 20px;
ย background-color: var(--btn-bg);
ย color: #fff;
ย border: none;
ย padding: 15px;
ย border-radius: 8px;
ย font-size: 18px;
ย cursor: pointer;
ย transition: background-color 0.3s ease;
}
#modalRechazo button[type="submit"]:hover {
ย background-color: var(--btn-bg-hover);
}

#modalRechazo .modal-actions {
ย display: flex;
ย justify-content: space-between;
ย margin-top: 20px;
}
#modalRechazo .modal-actions button {
ย flex: 1;
ย margin: 0 5px;
}
ยย
.led.naranja {
ย background: radial-gradient(circle at 48% 45%, #ff9800 40%, #c17500 100%);
ย box-shadow: 0 0 22px #ff9800, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.rojo {
ย background: radial-gradient(circle at 48% 45%, #f44336 40%, #d32f2f 100%);
ย box-shadow: 0 0 22px #f44336, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.verde {
ย background: radial-gradient(circle at 48% 45%, #4caf50 40%, #388e3c 100%);
ย box-shadow: 0 0 22px #4caf50, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}

/* ================= CSS PARA PANTALLA 3 (REPORTES) ================= */
#pantalla3 {
ย background-color: #f5f5f5;
ย color: #333;
ย align-items: center;
ย justify-content: flex-start;
ย padding: 20px;
ย overflow-y: auto;
}
#pantalla3 h1 {
ย font-size: 2.5rem;
ย color: #0066cc;
ย margin-bottom: 20px;
}
#pantalla3 .btn-contenedor {
ย display: flex;
ย flex-direction: row;
ย flex-wrap: wrap;
ย justify-content: center;
ย gap: 15px;
ย width: 100%;
ย max-width: 800px;
}
#pantalla3 .usuario-btn {
ย background-color: #0066cc;
ย color: #fff;
ย font-size: 1.2rem;
ย padding: 15px 30px;
ย border-radius: 10px;
ย cursor: pointer;
ย border: none;
ย transition: background-color 0.3s ease;
}
#pantalla3 .usuario-btn:hover {
ย background-color: #004c99;
}
#pantalla3 .contenedor-reporte {
ย background-color: #fff;
ย border-radius: 10px;
ย padding: 20px;
ย box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
ย width: 100%;
ย max-width: 1200px;
ย margin-top: 20px;
}
#pantalla3 .header-reporte {
ย display: flex;
ย align-items: center;
ย flex-wrap: wrap;
ย gap: 10px;
ย justify-content: space-between;
ย margin-bottom: 20px;
}
#pantalla3 .header-reporte h2 {
ย color: #0066cc;
ย margin: 0;
}
#pantalla3 .header-reporte .filtros {
ย display: flex;
ย flex-wrap: wrap;
ย gap: 10px;
ย align-items: center;
}
#pantalla3 .header-reporte .filtros label {
ย font-size: 14px;
}
#pantalla3 .header-reporte .filtros input[type="date"],
#pantalla3 .header-reporte .filtros select,
#pantalla3 .header-reporte .filtros input[type="text"] {
ย padding: 8px;
ย border-radius: 5px;
ย border: 1px solid #ccc;
ย font-size: 14px;
}
#pantalla3 table {
ย width: 100%;
ย border-collapse: collapse;
ย margin-top: 20px;
ย display: table;
}
#pantalla3 th, #pantalla3 td {
ย border: 1px solid #ccc;
ย padding: 12px;
ย text-align: left;
ย font-size: 14px;
}
#pantalla3 thead {
ย background-color: #0066cc;
ย color: #fff;
}
#pantalla3 tbody tr:nth-child(even) {
ย background-color: #f2f2f2;
}
#pantalla3 tbody tr:hover {
ย background-color: #ddd;
}
#pantalla3 .resumen-datos {
ย display: flex;
ย gap: 30px;
ย flex-wrap: wrap;
ย justify-content: space-around;
ย margin-bottom: 20px;
}
#pantalla3 .dato {
ย background-color: #f2f2f2;
ย padding: 15px;
ย border-radius: 8px;
ย font-weight: bold;
ย text-align: center;
}
#pantalla3 .dato .valor {
ย font-size: 24px;
ย color: #0066cc;
}
#pantalla3 .dato .etiqueta {
ย font-size: 12px;
ย text-transform: uppercase;
ย color: #666;
}
.botones-reporte {
ย margin-top: 20px;
ย display: flex;
ย gap: 15px;
ย justify-content: flex-end;
ย flex-wrap: wrap;
}
.grafico-contenedor {
ย width: 100%;
ย max-width: 600px;
ย margin: 20px auto;
}
.opciones-grafico {
ย ย display: flex;
ย ย gap: 10px;
ย ย align-items: center;
ย ย margin-bottom: 15px;
ย ย justify-content: center;
}
.opciones-grafico .usuario-btn {
ย ย padding: 8px 15px;
ย ย font-size: 14px;
}
.reporte-calidad-mobile .tabla-calidad-movil .fila-dato {
ย ย background-color: #f2f2f2;
ย ย padding: 10px;
ย ย border-radius: 5px;
ย ย margin-bottom: 10px;
}
.reporte-calidad-mobile .tabla-calidad-movil .etiqueta {
ย ย font-weight: bold;
ย ย color: #666;
ย ย display: block;
ย ย font-size: 12px;
}
.reporte-calidad-mobile .tabla-calidad-movil .valor {
ย ย color: #333;
ย ย font-size: 16px;
}
@media (max-width: 768px) {
ย ย #pantalla3 .header-reporte {
ย ย ย ย flex-direction: column;
ย ย ย ย align-items: flex-start;
ย ย }
ย ย #pantalla3 .header-reporte .filtros {
ย ย ย ย width: 100%;
ย ย ย ย flex-direction: column;
ย ย }
ย ย #pantalla3 .header-reporte .filtros input,
ย ย #pantalla3 .header-reporte .filtros select {
ย ย ย ย width: 100%;
ย ย }
ย ย #pantalla3 .resumen-datos {
ย ย ย ย flex-direction: column;
ย ย ย ย gap: 15px;
ย ย }
ย ย #pantalla3 .dato {
ย ย ย ย width: 100%;
ย ย }
ย ย #pantalla3 table {
ย ย ย ย display: none; /* Oculta la tabla normal en mรณviles */
ย ย }
ย ย .reporte-calidad-mobile {
ย ย ย ย display: block; /* Muestra la tabla mรณvil */
ย ย }
}
@media (min-width: 769px) {
ย ย .reporte-calidad-mobile {
ย ย ย ย display: none; /* Oculta la tabla mรณvil en desktop */
ย ย }
}

/* ================= CSS PARA PANTALLA 4 (DASHBOARD) ================= */
#pantalla4 {
ย background-color: #000;
ย color: #fff;
ย padding: 20px;
ย display: grid;
ย grid-template-areas:
ย ย "header"
ย ย "filtros"
ย ย "kpis"
ย ย "graficos"
ย ย "pendientes"
ย ย "footer";
ย gap: 20px;
ย align-content: start;
ย overflow-y: auto;
}
#pantalla4 .header {
ย grid-area: header;
ย text-align: center;
}
#pantalla4 .filtros-dashboard {
ย grid-area: filtros;
ย display: flex;
ย justify-content: center;
ย gap: 15px;
ย margin-bottom: 20px;
ย align-items: center;
}
#pantalla4 .filtros-dashboard label {
ย font-size: 14px;
}
#pantalla4 .filtros-dashboard input[type="date"],
#pantalla4 .filtros-dashboard select {
ย padding: 8px;
ย border-radius: 5px;
ย border: 1px solid #555;
ย background-color: #222;
ย color: #fff;
}
#pantalla4 .kpis-grid {
ย grid-area: kpis;
ย display: grid;
ย grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
ย gap: 20px;
}
#pantalla4 .kpi-card {
ย background-color: #1a1a1a;
ย border-radius: 10px;
ย padding: 20px;
ย text-align: center;
ย box-shadow: 0 4px 10px rgba(0,0,0,0.5);
ย border: 1px solid #333;
}
#pantalla4 .kpi-card h3 {
ย margin-top: 0;
ย font-size: 1rem;
ย color: #aaa;
ย text-transform: uppercase;
}
#pantalla4 .kpi-card .valor {
ย font-size: 3rem;
ย font-weight: bold;
ย color: #00ff88;
ย transition: color 0.3s ease;
}
#pantalla4 .kpi-card.alerta .valor {
ย color: #ff3333;
}
#pantalla4 .graficos-container {
ย grid-area: graficos;
ย display: grid;
ย grid-template-columns: 1fr;
ย gap: 20px;
}
#pantalla4 .graficos-container .panel {
ย background-color: #1a1a1a;
ย padding: 20px;
ย border-radius: 10px;
ย box-shadow: 0 4px 10px rgba(0,0,0,0.5);
ย border: 1px solid #333;
}
#pantalla4 .graficos-container h3 {
ย text-align: center;
ย margin-top: 0;
ย margin-bottom: 15px;
ย color: #eee;
}
#pantalla4 #tablaPendientes {
ย width: 100%;
ย border-collapse: collapse;
ย color: #fff;
}
#pantalla4 #tablaPendientes th, #pantalla4 #tablaPendientes td {
ย padding: 12px;
ย border-bottom: 1px solid #444;
ย text-align: left;
}
#pantalla4 #tablaPendientes th {
ย background-color: #222;
}
#pantalla4 #tablaPendientes tbody tr:hover {
ย background-color: #333;
}
#pantalla4 .footer {
ย grid-area: footer;
}
@media (min-width: 768px) {
ย #pantalla4 {
ย ย grid-template-columns: 1fr 1fr;
ย ย grid-template-areas:
ย ย ย "header header"
ย ย ย "filtros filtros"
ย ย ย "kpis kpis"
ย ย ย "graficos graficos"
ย ย ย "pendientes pendientes"
ย ย ย "footer footer";
ย }
ย #pantalla4 .graficos-container {
ย ย ย grid-template-columns: 1fr 1fr;
ย }
ย .graficos-container > *:nth-child(3) {
ย ย ย grid-column: span 2;
ย }
}
@media (min-width: 1200px) {
ย #pantalla4 {
ย ย grid-template-columns: repeat(3, 1fr);
ย ย grid-template-areas:
ย ย ย "header header header"
ย ย ย "filtros filtros filtros"
ย ย ย "kpis kpis kpis"
ย ย ย "produccion calidad logistica"
ย ย ย "pendientes pendientes pendientes"
ย ย ย "footer footer footer";
ย }
ย #pantalla4 .graficos-container {
ย ย grid-template-columns: 1fr 1fr 1fr;
ย }
ย .graficos-container > *:nth-child(3) {
ย ย ย grid-column: span 1;
ย }
}

ย /* FAB */
ย .mt-fab {
ย ย position: fixed;
ย ย bottom: 20px;
ย ย right: 20px;
ย ย background: #0a84ff;
ย ย color: #fff;
ย ย border: none;
ย ย border-radius: 50%;
ย ย width: 78px;
ย ย height: 78px;
ย ย font-size: 12px;
ย ย font-weight: 700;
ย ย cursor: pointer;
ย ย z-index: 1000;
ย ย box-shadow: 0 10px 25px rgba(10,132,255,.35);
ย }
ย .mt-fab:active { transform: translateY(1px); }

ย /* Panel lateral */
ย .mt-panel {
ย ย position: fixed;
ย ย top: 0; right: -420px; width: 420px; max-width: 95vw; height: 100%;
ย ย background: #111316; color: #eaeaea;
ย ย box-shadow: -4px 0 20px rgba(0,0,0,.45);
ย ย transition: right .28s ease;
ย ย z-index: 999;
ย }
ย .mt-panel.open { right: 0; }
ย .mt-panel-content { padding: 20px; }
ย .mt-close {
ย ย background: transparent; border: none; color: #aaa; font-size: 28px; cursor: pointer; float: right;
ย }
ย .mt-close:hover { color: #fff; }

ย /* Controles */
ย .mt-row { display: flex; gap: 10px; align-items: stretch; }
ย .mt-btn {
ย ย padding: 10px 14px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;
ย }
ย .mt-primary { background:#0a84ff; color:#fff; }
ย .mt-success { background:#34c759; color:#000; }
ย .mt-select, #bxInput {
ย ย flex: 1; padding: 10px 12px; border-radius: 10px; border: 1px solid #2b2f36; background:#171a1f; color:#eaeaea;
ย }
ย .mt-select:focus, #bxInput:focus { outline: 2px solid #0a84ff; }

ย .mt-card {
ย ย margin-top: 16px; padding: 16px; border-radius: 14px;
ย ย background: linear-gradient(180deg, #16191e 0%, #121418 100%);
ย ย border: 1px solid #20242b;
ย }
ย .mt-grid {
ย ย display: grid; grid-template-columns: repeat(2,1fr); gap: 8px 14px; margin-bottom: 10px;
ย }
ย .mt-list { list-style: none; padding-left: 0; margin: 8px 0 0; max-height: 200px; overflow: auto; }
ย .mt-list li {
ย ย padding: 10px 12px; margin-bottom: 8px; border-radius: 10px;
ย ย background:#0f1216; border: 1px solid #22262c; font-size: 14px;
ย ย word-break: break-word;
ย }
ย .mt-assign { margin-top: 14px; border-top: 1px dashed #2a2f36; padding-top: 12px; }

ย /* === TEMA OSCURO SOLO PARA CALIDAD/PRODUCCIรN ===
ย ย ยLe agregamos a <body> la clase .theme-dark cuando el usuario pertenece a esas รกreas.
ย ย ยLogรญstica queda igual (sin esta clase). */
ย body.theme-dark {
ย ย background: #0b0d0f !important;
ย ย color: #eaeaea !important;
ย }
ย body.theme-dark .card, body.theme-dark .panel, body.theme-dark .widget {
ย ย background: #121418 !important;
ย ย color: #eaeaea !important;
ย ย border-color: #21252b !important;
ย }
ย body.theme-dark button, body.theme-dark .btn {
ย ย border-radius: 10px;
ย ย}
</style>
</head>
<body>

<section id="pantalla1" class="pantalla activa">
<h1 id="mainTitle">Selecciona tu usuario</h1>
<div class="btn-contenedor">
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('LOGรSTICA')">LOGรSTICA</button>
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('MULTIPORT')">MULTIPORT</button>
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('DROPS')">DROPS</button>
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('BEDROCK')">BEDROCK</button>
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('SUPERVISOR')">SUPERVISOR</button>
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('CALIDAD')">CALIDAD</button>ย
ย ย <button class="usuario-btn" onclick="seleccionarReporte()">REPORTES</button>
ย ย <button class="usuario-btn" onclick="seleccionarDashboard()">DASHBOARD</button>
</div>
</section>

<section id="pantalla2" class="pantalla">
<header class="header">
ย ย <div id="tituloFijo">LOGรSTICA</div>
ย ย <div id="turnoActual"></div>
</header>
<div class="zona-centro">
ย ย <div id="resumenTurno" class="resumen-turno oculto">
<div class="dato-resumen">
ย ย <div class="etiqueta">Tarimas Totales</div>
ย ย <div id="tarimasTotales" class="valor">0</div>
</div>
<div class="dato-resumen">
ย ย <div class="etiqueta">Tiempo Promedio</div>
ย ย <div id="tiempoPromedio" class="valor">0 min</div>
</div>
</div>
<div class="grupo-contenedor">
ย ย <div class="grupo" data-grupo="MULTIPORT">
ย ย ย ย <div class="nombre">MULTIPORT</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="MULTIPORT" data-linea="linea1"></div>
ย ย ย ย <div class="leds" data-grupo="MULTIPORT" data-linea="linea2"></div>
ย ย ย <div class="tarimas-recibidas-panel" id="tarimasRecibidasPanel">
ย ย ย ย<ul id="listaTarimasRecibidas"></ul>
ย ย ย </div>
ย ย ย ย<div class="tiempos" data-grupo="MULTIPORT"></div>
ย ย ย ย </div>

ย ย <div class="grupo" data-grupo="DROPS">
ย ย ย ย <div class="nombre">DROPS</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="DROPS" data-linea="linea1"></div>
ย ย ย ย <div class="leds" data-grupo="DROPS" data-linea="linea2"></div>
ย ย ย ย <div class="tiempos" data-grupo="DROPS"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="BEDROCK">
ย ย ย ย <div class="nombre">BEDROCK</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="BEDROCK" data-linea="linea1"></div>
ย ย ย ย <div class="leds" data-grupo="BEDROCK" data-linea="linea2"></div>
ย ย ย ย <div class="tiempos" data-grupo="BEDROCK"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="CALIDAD_MULTIPORT">
ย ย ย ย <div class="nombre">CALIDAD MULTIPORT</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="CALIDAD_MULTIPORT" data-linea="linea1"></div>
ย ย ย ย <div class="contadores-calidad">
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="liberadas_CALIDAD_MULTIPORT">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Liberadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="rechazadas_CALIDAD_MULTIPORT">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Rechazadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div class="tiempos" data-grupo="CALIDAD_MULTIPORT"></div>
ย ย </div>
ยย
ย ย <div class="grupo" data-grupo="CALIDAD_DROPS">
ย ย ย ย <div class="nombre">CALIDAD DROPS</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="CALIDAD_DROPS" data-linea="linea1"></div>
ย ย ย ย <div class="contadores-calidad">
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="liberadas_CALIDAD_DROPS">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Liberadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="rechazadas_CALIDAD_DROPS">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Rechazadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div class="tiempos" data-grupo="CALIDAD_DROPS"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="CALIDAD_BEDROCK">
ย ย ย ย <div class="nombre">CALIDAD BEDROCK</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="CALIDAD_BEDROCK" data-linea="linea1"></div>
ย ย ย ย <div class="contadores-calidad">
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="liberadas_CALIDAD_BEDROCK">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Liberadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="rechazadas_CALIDAD_BEDROCK">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Rechazadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div class="tiempos" data-grupo="CALIDAD_BEDROCK"></div>
ย ย </div>
</div>
</div>
<div class="footer">
ย ย <button class="usuario-btn btn-rojo" onclick="volverAPantalla1()">Cerrar sesiรณn</button>
</div>
</section>

<section id="pantalla3" class="pantalla">
<header class="header">
ย ย <h1 id="tituloReportes">REPORTES</h1>
</header>
<div class="zona-centro">
ย ย <div id="selectoresReportes" class="btn-contenedor">
ย ย ย ย <button class="usuario-btn" data-reporte="produccion">PRODUCCIรN</button>
ย ย ย ย <button class="usuario-btn" data-reporte="logistica">LOGรSTICA</button>
ย ย ย ย <button class="usuario-btn" data-reporte="calidad">CALIDAD</button>
ย ย ย ย <button class="usuario-btn" data-reporte="resumen">RESUMEN EJECUTIVO</button>
ย ย </div>
ย ย <div id="contenedorReporte" class="contenedor-reporte">
ย ย ย ย <h2>Selecciona un reporte</h2>
ย ย </div>
</div>
<div class="footer">
ย ย <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver</button>
</div>
</section>

<section id="pantalla4" class="pantalla" style="display: none;">
<header class="header">
ย ย <h1>DASHBOARD DE SUPERVISOR</h1>
</header>
<div class="filtros-dashboard">
ย ย <label for="fechaDashboard">Fecha:</label>
ย ย <input type="date" id="fechaDashboard">
ย ย <label for="turnoDashboardSelect">Turno:</label>
ย ย <select id="turnoDashboardSelect">
ย ย ย ย <option value="todos">Todos</option>
ย ย ย ย <option value="Turno 1">Turno 1</option>
ย ย ย ย <option value="Turno 2">Turno 2</option>
ย ย </select>
</div>
ย <div class="kpis-grid">
ย ย <div class="kpi-card">
ย ย ย ย <h3>Tarimas Confirmadas</h3>
ย ย ย ย <div class="valor" id="dashTarimasConfirmadas">0</div>
ย ย </div>
ย ย <div class="kpi-card">
ย ย ย ย <h3>Tarimas Recolectadas</h3>
ย ย ย ย <div class="valor" id="dashTarimasRecolectadas">0</div>
ย ย </div>
ย ย <div class="kpi-card" id="kpiTiempoPromedio">
ย ย ย ย <h3>Tiempo Promedio</h3>
ย ย ย ย <div class="valor" id="dashTiempoPromedio">0 min</div>
ย ย </div>
ย ย <div class="kpi-card" id="kpiTasaRechazo">
ย ย ย ย <h3>Tasa de Rechazo</h3>
ย ย ย ย <div class="valor" id="dashTasaRechazo">0%</div>
ย ย </div>
</div>
<div class="graficos-container">
ย ย <div class="panel">
ย ย ย ย <h3>Producciรณn por รrea</h3>
ย ย ย ย <div style="position: relative; height: 300px;"><canvas id="graficoProduccionDash"></canvas></div>
ย ย </div>
ย ย <div class="panel">
ย ย ย ย <h3>Estado de Calidad</h3>
ย ย ย ย <div style="position: relative; height: 300px;"><canvas id="graficoCalidadDash"></canvas></div>
ย ย </div>
ย ย <div class="panel">
ย ย ย ย <h3>Evoluciรณn Tiempos de Recolecciรณn</h3>
ย ย ย ย <div style="position: relative; height: 300px;"><canvas id="graficoLogisticaDash"></canvas></div>
ย ย </div>
</div>
<div class="panel" style="grid-area: pendientes;">
ย ย <h3>Tarimas Pendientes por Recolectar</h3>
ย ย <table id="tablaPendientes">
ย ย ย ย <thead>
ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย <th>รrea</th>
ย ย ย ย ย ย ย ย <th>Tarimas Pendientes</th>
ย ย ย ย ย ย </tr>
ย ย ย ย </thead>
ย ย ย ย <tbody></tbody>
ย ย </table>
</div>
<div class="footer">
ย ย <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver al inicio</button>
</div>
</section>

<div id="modalCalidad" class="modal-calidad">
ย <div class="modal-content">
ย ย <h3>Selecciona el estado de la tarima:</h3>
ย ย <div class="opciones">
ย ย ย <button class="opcion-btn" data-color="rojo">Rechazada ๐ด</button>
ย ย ย <button class="opcion-btn" data-color="verde">Liberada ๐ข</button>
ย ย </div>
ย ย <button class="cerrar-btn">Cerrar</button>
ย </div>
</div>
<div id="modalOpcionesCalidad" class="modal">
ย <div class="modal-content">
ย ย <h3>Asignar tarima a LED de Calidad</h3>

ย ย <label for="selectLedCalidad">Selecciona LED:</label>
ย ย <select id="selectLedCalidad"></select>

ย ย <div class="modal-actions">
ย ย ย <button id="btnAsignarTarimaCalidad">Asignar</button>
ย ย ย <button onclick="cerrarModalCalidad()">Cancelar</button>
ย ย </div>
ย </div>
</div>

<style>
/* --- estilos bรกsicos para modal --- */
.modal {
ย display: none;
ย position: fixed;
ย z-index: 999;
ย left: 0; top: 0; width: 100%; height: 100%;
ย background: rgba(0,0,0,0.6);
}
.modal-content {
ย background: #fff;
ย padding: 20px;
ย margin: 10% auto;
ย width: 90%; max-width: 400px;
ย border-radius: 10px;
}
.modal-actions {
ย margin-top: 15px;
ย display: flex;
ย justify-content: flex-end;
ย gap: 10px;
}
</style>
ยย
<div id="modalRechazo" class="modal-calidad">
ย <div class="modal-content">
ย ย <h3>Detalles del Rechazo</h3>
ย ย <form id="formularioRechazo">
ย ย ย ย <label for="empleado">Empleado Originador:</label>
ย ย ย ย <input type="text" id="empleado" name="empleado" required>
ย ย ย ยย
ย ย ย ย <label for="linea">Lรญnea afectada:</label>
ย ย ย ย <input type="text" id="linea" name="linea" required>

ย ย ย ย <label for="parte">No. de parte:</label>
ย ย ย ย <input type="text" id="parte" name="parte" required>

ย ย ย ย <label for="descripcionParte">Descripciรณn del No. de parte:</label>
ย ย ย ย <input type="text" id="descripcionParte" name="descripcionParte" required>

ย ย ย ย <label for="problema">Descripciรณn del problema:</label>
ย ย ย ย <textarea id="problema" name="problema" required></textarea>

ย ย ย ย <label for="causa">Causa raรญz del problema:</label>
ย ย ย ย <textarea id="causa" name="causa" required></textarea>

ย ย ย ย <label for="accion">Acciรณn correctiva:</label>
ย ย ย ย <textarea id="accion" name="accion" required></textarea>

ย ย ย ย <div class="modal-actions">
ย ย ย ย ย ย <button type="submit">Guardar Rechazo</button>
ย ย ย ย ย ย <button type="button" onclick="cerrarModalRechazo()">Cancelar</button>
ย ย ย ย </div>
ย ย </form>
ย </div>
</div>
ย <div id="modalAsignarTarimaProduccion" class="modal-produccion">
ย <div class="modal-content">
ย ย <h3>Asignar tarima recibida</h3>

ย ย <label for="selectTarimaProduccion">Selecciona Tarima:</label>
ย ย <select id="selectTarimaProduccion"></select>

ย ย <label for="selectLedProduccion">Selecciona LED:</label>
ย ย <select id="selectLedProduccion"></select>

ย ย <div class="modal-actions">
ย ย ย <button id="btnAsignarProduccion">Asignar</button>
ย ย ย <button onclick="cerrarModalProduccion()">Cancelar</button>
ย ย </div>
ย </div>
</div>
ยย
<style>
ย /* Modal Producciรณn con estilo dark */
.modal-produccion {
ย position: fixed;
ย top: 0; left: 0;
ย width: 100%; height: 100%;
ย background-color: rgba(0,0,0,0.8);
ย display: none;
ย justify-content: center;
ย align-items: center;
ย z-index: 2000;
}

.modal-produccion .modal-content {
ย background: #222;
ย padding: 20px;
ย border-radius: 12px;
ย color: #fff;
ย width: 90%;
ย max-width: 400px;
ย text-align: center;
ย box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}

.modal-produccion h3 {
ย margin-bottom: 15px;
}

.modal-produccion select {
ย width: 100%;
ย padding: 8px;
ย margin: 10px 0;
ย border-radius: 6px;
ย border: none;
}

.modal-actions {
ย display: flex;
ย justify-content: space-around;
ย margin-top: 15px;
}

.modal-actions button {
ย padding: 10px 20px;
ย border: none;
ย border-radius: 6px;
ย cursor: pointer;
}

#btnAsignarProduccion { background: #4caf50; color: #fff; }
#btnAsignarProduccion:hover { filter: brightness(1.2); }
.modal-actions button:last-child { background: #555; color: #fff; }
.modal-actions button:last-child:hover { background: #777; }
ยย
<style>
/* Reutiliza el estilo del modal de calidad */
#modalAsignarTarimaProduccion .modal-content {
ย background: #fff;
ย padding: 20px;
ย margin: 10% auto;
ย width: 90%; max-width: 400px;
ย border-radius: 10px;
}
</style>
ย <button class="mt-fab" id="mtOpenBtn" style="display:none;" title="Identificaciรณn de Tarima">TARIMAS</button>

<div id="mtPanel" class="mt-panel" aria-hidden="true">
ย <div class="mt-panel-content">
ย ย <button id="mtCloseBtn" class="mt-close" aria-label="Cerrar panel">&times;</button>
ย ย <h2>Identificaciรณn de Tarima</h2>
ย ย <p>Escanea o ingresa un cรณdigo <b>BX</b> para identificar la tarima:</p>

ย ย <div class="mt-row">
ย ย ย <input type="text" id="bxInput" placeholder="Escanear/pegar cรณdigo BX..." autocomplete="off" />
ย ย ย <button id="buscarTarimaBtn" class="mt-btn mt-primary">Buscar</button>
ย ย </div>

ย ย ย ย <div id="tarimaInfo" class="mt-card" style="display:none;">
ย ย ย <h3>Tarima encontrada</h3>
ย ย ย <div class="mt-grid">
ย ย ย ย <div><b>ID:</b> <span id="tarimaId">โ</span></div>
ย ย ย ย <div><b>Empleado:</b> <span id="empleado">โ</span></div>
ย ย ย ย <div><b>Turno:</b> <span id="turno">โ</span></div>
ย ย ย ย <div><b>Total cajas:</b> <span id="totalCajas">0</span></div>
ย ย ย ย <div><b>Total piezas:</b> <span id="totalPiezas">0</span></div>
ย ย ย </div>

ย ย ย <h4>Detalle de cajas (BX | piezas)</h4>
ย ย ย <ul id="listaCajas" class="mt-list"></ul>
ย<div id="tarimasPendientesPanel">
ย <h3>Tarimas pendientes por inspecciรณn</h3>
ย <ul id="listaTarimasPendientes"></ul>
</div>

ย ย ย ย ย ย <div id="ledAssignment" class="mt-assign" style="display:none;">
ย ย ย ย <label for="ledSelect">Asignar LED a esta tarima:</label>
ย ย ย ย <div class="mt-row">
ย ย ย ย ย <select id="ledSelect" class="mt-select"></select>
ย ย ย ย ย <button id="asignarLedBtn" class="mt-btn mt-success">Asignar LED</button>
ย ย ย ย </div>
ย ย ย ย <small>Nota: los LEDs solo podrรกn encenderse/apagarse si tienen tarima asignada.</small>
ย ย ย </div>
ย ย </div>
ย </div>
</div>
ยย
<script>
// ================= CONFIG Y ESTADO =================
const CONFIG = {
ย ย USUARIOS: ['MULTIPORT', 'BEDROCK', 'DROPS', 'LOGรSTICA', 'SUPERVISOR', 'CALIDAD'],
ย ย PRODUCCION_GRUPOS: ['MULTIPORT', 'BEDROCK', 'DROPS'],
ย ย PASSWORDS: {
ย ย ย ย 'LOGรSTICA': 'LOGRAM',
ย ย ย ย 'MULTIPORT': 'MP25',
ย ย ย ย 'BEDROCK': 'BR25',
ย ย ย ย 'DROPS': 'DROP25',
ย ย ย ย 'SUPERVISOR': 'SUP25',
ย ย ย ย 'CALIDAD_MULTIPORT': 'AQLMP',
ย ย ย ย 'CALIDAD_DROPS': 'AQLDP',
ย ย ย ย 'CALIDAD_BEDROCK': 'AQLBR',
ย ย ย ย 'REPORTES': 'REPO25',
ย ย ย ย 'DASHBOARD': 'DASH25'
ย ย },
ย ย LEDS_POR_GRUPO: {
ย ย ย ย 'MULTIPORT': 5,
ย ย ย ย 'BEDROCK': 5,
ย ย ย ย 'DROPS': 5,
ย ย ย ย 'CALIDAD_MULTIPORT': 5,
ย ย ย ย 'CALIDAD_BEDROCK': 5,
ย ย ย ย 'CALIDAD_DROPS': 5
ย ย }
};

let usuarioSeleccionado = null;
let ledActivoParaFormulario = { grupo: null, idx: null, linea: null };
let reporteActual = null;
let datosFiltradosReporte = null;
let miGrafico;
let graficosDashboard = {};
let dashboardUpdateInterval;


// -------------------------------------------------------
//ย โ Restauraciรณn/Compat: seleccionarUsuario()
//ย - Evita el error "seleccionarUsuario is not defined"
//ย - Si existรญa una versiรณn anterior, la detecta y delega.
//ย - AรADE: seteo de tema oscuro para Calidad/Producciรณn,
//ย ย ย ย ย ยy muestra el FAB de Tarimas.
// -------------------------------------------------------
// ================= FIREBASE =================
const firebaseConfig = {
ย ย apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
ย ย authDomain: "panel-logistica.firebaseapp.com",
ย ย databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
ย ย projectId: "panel-logistica",
ย ย storageBucket: "panel-logistica.appspot.com",
ย ย messagingSenderId: "38365879945",
ย ย appId: "1:38365879945:web:e2f3590fe77f013dba3058"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const db = database;ย
const ledRef = database.ref('estadoLEDs');
let historialRef;
let contadoresCalidadRef;
let rechazosDetalladosRef;
let dashboardListeners = [];

window.database = window.database || firebase.database();

// Guardaremos el usuario actual (texto del botรณn que usan)
window.__usuarioActual = null;

(function compatSeleccionarUsuario(){
ย const legacy = window.seleccionarUsuario; // por si ya existรญa
ย window._seleccionarUsuarioOriginal = (typeof legacy === 'function') ? legacy : null;

ย window.seleccionarUsuario = function(usuarioClave) {
ย ย try {
ย ย ย window.__usuarioActual = String(usuarioClave || '').toUpperCase();

ย ย ย // Tema oscuro solo para CALIDAD_* y PRODUCCION_*
ย ย ย const isDark = window.__usuarioActual.startsWith('CALIDAD') || window.__usuarioActual.startsWith('PRODUCCION');
ย ย ย document.body.classList.toggle('theme-dark', isDark);

ย ย ย // Mostrar FAB "TARIMAS" solo cuando ya hay usuario elegido
ย ย ย const fab = document.getElementById('mtOpenBtn');
ย ย ย if (fab) fab.style.display = 'block';

ย ย ย // Delegar a tu funciรณn original si existรญa:
ย ย ย if (window._seleccionarUsuarioOriginal) {
ย ย ย ย return window._seleccionarUsuarioOriginal(usuarioClave);
ย ย ย }

ย ย ย // Si no habรญa original, al menos no tronamos:
ย ย ย console.info('[Compat] seleccionarUsuario activo (sin versiรณn original). Usuario:', window.__usuarioActual);
ย ย } catch (e) {
ย ย ย console.error('Error en seleccionarUsuario compat:', e);
ย ย }
ย };
})();

// ==============ARRIBA ELIMINE ALGO=========================================
//ย ๐ฏ NUEVO: Identificaciรณn de Tarimas y Amarre con LEDs
//ย - Buscar tarima por BX
//ย - Mostrar detalle: empleado/turno/cajas/piezas/lista BX
//ย - En CALIDAD: asignar LED a tarima (ledsAsignados/{ledId})
//ย - En PRODUCCIรN/LOGรSTICA: no se puede accionar LED sin tarima
//ย - En LOGรSTICA: al apagar, se libera el LED (remove ledsAsignados)
// =======================================================

ย function contadoresVisiblesPara(usuario) {
ย if ((usuario || '').startsWith('CALIDAD_')) return ['liberadas', 'rechazadas'];
ย if (usuario === 'LOGรSTICA')ย ย ย ย ย ย ย ยreturn ['recolectadas'];
ย // Producciรณn (MULTIPORT/DROPS/BEDROCK):
ย return ['asignadas']; // o ['confirmadas'] si ya tienes esa acciรณn implementada
}
ย // Helpers UI panel
const MT = {
ย ui: {
ย ย panel:ย ยdocument.getElementById('mtPanel'),
ย ย openBtn: document.getElementById('mtOpenBtn'),
ย ย closeBtn:document.getElementById('mtCloseBtn'),
ย ย bxInput: document.getElementById('bxInput'),
ย ย buscarBtn: document.getElementById('buscarTarimaBtn'),
ย ย infoBox: document.getElementById('tarimaInfo'),
ย ย fields: {
ย ย ย id: document.getElementById('tarimaId'),
ย ย ย empleado: document.getElementById('empleado'),
ย ย ย turno: document.getElementById('turno'),
ย ย ย totalCajas: document.getElementById('totalCajas'),
ย ย ย totalPiezas: document.getElementById('totalPiezas'),
ย ย ย listaCajas: document.getElementById('listaCajas')
ย ย },
ย ย asignacion: {
ย ย ย wrap: document.getElementById('ledAssignment'),
ย ย ย select: document.getElementById('ledSelect'),
ย ย ย btn: document.getElementById('asignarLedBtn')
ย ย }
ย },
ย state: {
ย ย tarimaActual: null // { id, empleadoId, turno, cajas:{...}, totalPiezas }
ย }
};

// Abrir / cerrar panel
if (MT.ui.openBtn) MT.ui.openBtn.addEventListener('click', () => MT.ui.panel.classList.add('open'));
if (MT.ui.closeBtn) MT.ui.closeBtn.addEventListener('click', () => MT.ui.panel.classList.remove('open'));

// Buscar tarima por BX
if (MT.ui.buscarBtn) {
ย MT.ui.buscarBtn.addEventListener('click', () => {
ย ย const bx = (MT.ui.bxInput.value || '').trim();
ย ย if (!bx) { alert('Ingresa o escanea un cรณdigo BX'); return; }
ย ย buscarTarimaPorBX(bx);
ย });
}
// Tambiรฉn Enter en input
if (MT.ui.bxInput) {
ย MT.ui.bxInput.addEventListener('keypress', (e) => {
ย ย if (e.key === 'Enter') MT.ui.buscarBtn.click();
ย });
}


// === Helpers de grupo / rutas ===
function grupoProduccionDe(grupoCalidadOProd) {
ย // CALIDAD_MULTIPORT -> MULTIPORT, etc.
ย return (grupoCalidadOProd || '').replace(/^CALIDAD_/, '');
}

function nowISO() {
ย return new Date().toISOString();
}

// === Workflow por tarima ===
function pushWorkflow(tarimaId, evento, extra = {}) {
ย return db.ref(`tarimas/${tarimaId}/workflow`).push({
ย ย evento,
ย ย actor: usuarioSeleccionado || 'N/D',
ย ย timestamp: nowISO(),
ย ย ...extra
ย });
}ยย
/**
ย* Lee /tarimas en estructura:
ย* tarimas/{idTarima}/{
ย*ย ยempleadoId, turno, cajas:{ pushKey: {codigoCaja, cantidadPiezas, numeroOrden, ...} }
ย* }
ย*/
function buscarTarimaPorBX(bxCode) {
ย database.ref('tarimas').once('value').then(snapshot => {
ย ย let encontrada = null;
ย ย snapshot.forEach(tSnap => {
ย ย ย const t = tSnap.val() || {};
ย ย ย const cajas = t.cajas || {};
ย ย ย for (const k in cajas) {
ย ย ย ย if (cajas[k] && cajas[k].codigoCaja === bxCode) {
ย ย ย ย ย encontrada = { id: t.id || tSnap.key, ...t };
ย ย ย ย ย break;
ย ย ย ย }
ย ย ย }
ย ย ย if (encontrada) return true; // corta forEach
ย ย });

ย ย if (!encontrada) {
ย ย ย MT.ui.infoBox.style.display = 'none';
ย ย ย alert('No se encontrรณ tarima con ese BX.');
ย ย ย return;
ย ย }

ย ย // Guardamos y pintamos
ย ย MT.state.tarimaActual = normalizarTarima(encontrada);
ย ย renderTarimaEncontrada(MT.state.tarimaActual);
ย }).catch(err => {
ย ย console.error('Error buscando tarima:', err);
ย ย alert('Error al buscar la tarima. Reintenta.');
ย });
}

// Normaliza estructura a un objeto amigable p/ UI
function normalizarTarima(t) {
ย const out = {
ย ย id: t.id,
ย ย empleadoId: t.empleadoId || t.empleado || 'N/D',
ย ย turno: t.turno || 'N/D',
ย ย totalCajas: 0,
ย ย totalPiezas: 0,
ย ย cajas: [] // [{codigoCaja, cantidadPiezas}]
ย };
ย const cajas = t.cajas || {};
ย for (const cid in cajas) {
ย ย const c = cajas[cid] || {};
ย ย out.cajas.push({
ย ย ย id: cid,
ย ย ย codigoCaja: c.codigoCaja || 'โ',
ย ย ย cantidadPiezas: Number(c.cantidadPiezas || c.piezas || 0)
ย ย });
ย }
ย out.totalCajas = out.cajas.length;
ย out.totalPiezas = out.cajas.reduce((a,c)=>a + (Number.isFinite(c.cantidadPiezas)?c.cantidadPiezas:0), 0);
ย return out;
}

// Carga todos los LEDs disponibles directamente en el dropdown del panel.
// Carga todos los LEDs disponibles directamente en el dropdown del panel.
ยย
function cargarLedsDisponibles() {
ย ย const sel = MT.ui.asignacion.select;
ย ย sel.innerHTML = '';

ย ย // Escuchar en tiempo real los LEDs asignados
ย ย db.ref('estadoLEDs/CALIDAD_MULTIPORT/linea1').on('value', snap => {
ย ย ย ย sel.innerHTML = ''; // limpiar cada vez
ย ย ย ย const ledsEstado = snap.val() || {};
ย ย ย ย const totalLeds = 5; // ajusta segรบn corresponda

ย ย ย ย for (let i = 0; i < totalLeds; i++) {
ย ย ย ย ย ย const estado = ledsEstado[i] || {};
ย ย ย ย ย ย const ledId = `linea1-${i+1}`;

ย ย ย ย ย ย // Solo mostrar los disponibles (sin tarimaId asignada)
ย ย ย ย ย ย if (!estado.tarimaId) {
ย ย ย ย ย ย ย ย const opt = document.createElement('option');
ย ย ย ย ย ย ย ย opt.value = ledId;
ย ย ย ย ย ย ย ย opt.textContent = ledId;
ย ย ย ย ย ย ย ย sel.appendChild(opt);
ย ย ย ย ย ย }
ย ย ย ย }
ย ย });
}
ยย
function renderTarimasPendientes() {
ย ย const lista = document.getElementById('listaTarimasPendientes');
ย ย lista.innerHTML = '';

ย ย db.ref('tarimas').once('value').then(snap => {
ย ย ย ย const tarimas = snap.val() || {};

ย ย ย ย db.ref('tarimasAsignadas').once('value').then(snap2 => {
ย ย ย ย ย ย const asignadas = snap2.val() || {};
ย ย ย ย ย ย const usadas = Object.keys(asignadas);

ย ย ย ย ย ย Object.values(tarimas).forEach(t => {
ย ย ย ย ย ย ย ย if (!usadas.includes(t.id)) {
ย ย ย ย ย ย ย ย ย ย const li = document.createElement('li');
ย ย ย ย ย ย ย ย ย ย li.textContent = `#${t.id}`;
ย ย ย ย ย ย ย ย ย ย li.style.cursor = "pointer";
ย ย ย ย ย ย ย ย ย ย li.onclick = () => renderTarimaEncontrada(t);
ย ย ย ย ย ย ย ย ย ย lista.appendChild(li);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });
ย ย ย ย });
ย ย });
}

// ๐ฅ refrescar en tiempo real
db.ref('tarimas').on('value', renderTarimasPendientes);
db.ref('tarimasAsignadas').on('value', renderTarimasPendientes);


// Escribe el vรญnculo LED โ Tarima y actualiza el estado del LED
// Escribe el vรญnculo LED โ Tarima y actualiza el estado del LED
ยย
function asignarLedATarima(ledId, tarimaId) {
ย ย // ๐ก Paso 1: Verificar si la tarima ya estรก asignada en algรบn otro lugar
ย ย database.ref('tarimasAsignadas/' + tarimaId).once('value').then(snap => {
ย ย ย ย if (snap.exists()) {
ย ย ย ย ย ย return alert(`Error: La tarima ${tarimaId} ya ha sido asignada al LED ${snap.val().ledId}.`);
ย ย ย ย }

ย ย ย ย // Si no estรก asignada, continuar con el proceso
ย ย ย ย const payload = {
ย ย ย ย ย ย tarimaId,
ย ย ย ย ย ย asignadoPor: window.__usuarioActual || 'N/D',
ย ย ย ย ย ย timestamp: Date.now()
ย ย ย ย };

ย ย ย ย const grupo = 'CALIDAD_MULTIPORT';
ย ย ย ย const linea = 'linea1';
ย ย ย ย const ledIndex = parseInt(ledId.split('-')[1]) - 1;

ย ย ย ย const ledEstadoRef = db.ref(`estadoLEDs/${grupo}/${linea}/${ledIndex}`);
ย ย ย ย ledEstadoRef.set({
ย ย ย ย ย ย color: 'naranja',
ย ย ย ย ย ย tarimaId: tarimaId,
ย ย ย ย ย ย usuario: window.__usuarioActual || 'N/D',
ย ย ย ย ย ย timestamp: new Date().toISOString()
ย ย ย ย }).then(() => {
ย ย ย ย ย ย // ๐ก Paso 2: Registrar que la tarima ya fue asignada
ย ย ย ย ย ย database.ref('tarimasAsignadas/' + tarimaId).set({ ledId: ledId, timestamp: Date.now() });
ย ย ย ย ย ย alert(`โ Tarima ${tarimaId} asignada al LED ${ledId}`);
ย ย ย ย }).catch(err => {
ย ย ย ย ย ย console.error('Error asignando LED:', err);
ย ย ย ย ย ย alert('No se pudo asignar el LED. Intenta nuevamente.');
ย ย ย ย });
ย ย });
}

// ========================
// PRODUCCIรN: Asignar Tarima
// ========================
// ========================
// PRODUCCIรN: Asignar Tarima a LED
// ========================
function asignarTarimaProduccion(grupo, idx, linea) {
ย const select = document.getElementById('selectTarimaProduccion');
ย const key = select.value;
ย if (!key) {
ย ย alert("โ Debes seleccionar una tarima.");
ย ย return;
ย }

ย const recibidaRef = db.ref(`tarimasRecibidas/${grupo}/${key}`);
ย recibidaRef.once('value', snapshot => {
ย ย const tarima = snapshot.val();
ย ย if (!tarima) {
ย ย ย alert("โ Tarima no encontrada en recibidas.");
ย ย ย return;
ย ย }

ย ย const { fecha, turno } = obtenerTurnoActual();
ย ย const tarimaId = tarima.tarimaId || key;

ย ย // 1) Guardar en LED de Producciรณn
ย ย const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
ย ย ledRef.set({
ย ย ย encendido: true,
ย ย ย tarimaId: tarimaId,
ย ย ย usuario: usuarioSeleccionado,
ย ย ย timestamp: nowISO(),
ย ย ย horaEncendido: firebase.database.ServerValue.TIMESTAMP
ย ย });

ย ย // 2) Actualizar estado global de la tarima
ย ย db.ref(`tarimas/${tarimaId}`).update({
ย ย ย estado: 'asignada',
ย ย ย grupo: grupo,
ย ย ย linea: linea,
ย ย ย asignadaPor: usuarioSeleccionado,
ย ย ย timestampAsignada: nowISO()
ย ย });

ย ย // 3) Workflow + historial + contador
ย ย pushWorkflow(tarimaId, 'asignada_en_produccion', { grupo, linea, led: `${linea}-${idx+1}` });
ย ย db.ref(`historialLogs/${fecha}/${turno}`).push({
ย ย ย usuario: usuarioSeleccionado,
ย ย ย grupo,
ย ย ย accion: 'asignada_en_produccion',
ย ย ย tarimaId: tarimaId,
ย ย ย timestamp: nowISO()
ย ย });
ย ย db.ref(`contadoresTarimas/${fecha}/${turno}/${grupo}/asignadas`)
ย ย ย .transaction(v => (v || 0) + 1);

ย ย // 4) Eliminar de recibidas
ย ย recibidaRef.remove();

ย ย alert(`โ Tarima ${tarimaId} asignada a LED ${linea}-${idx+1}`);
ย ย cerrarModalProduccion && cerrarModalProduccion();
ย });
}
ย // ========================
// CALIDAD: Liberar Tarima
// ========================
// ========================
// CALIDAD: Liberar Tarima (CANรNICA)
// ========================
function liberarTarima(tarimaId) {
ย const { fecha, turno } = obtenerTurnoActual();
ย const grupoCalidad = usuarioSeleccionado;ย ย ย ย ย ย ย ย// ej: CALIDAD_MULTIPORT
ย const grupoProdย ย ย= grupoProduccionDe(grupoCalidad);ย // ej: MULTIPORT
ย const tarimaRefย ย ย= db.ref(`tarimas/${tarimaId}`);

ย tarimaRef.once('value').then(snap => {
ย ย if (!snap.exists()) {
ย ย ย alert(`โ Tarima ${tarimaId} no encontrada en TARIMAS.`);
ย ย ย return;
ย ย }

ย ย // 1) Estado global
ย ย tarimaRef.update({
ย ย ย estado: 'liberada',
ย ย ย liberadaPor: usuarioSeleccionado,
ย ย ย timestampLiberada: nowISO()
ย ย });

ย ย // 2) Hacerla visible a Producciรณn (clave = tarimaId)
ย ย db.ref(`tarimasRecibidas/${grupoProd}/${tarimaId}`).set({
ย ย ย tarimaId,
ย ย ย estado: 'recibida',
ย ย ย ledOrigen: (snap.val() && snap.val().led) || 'N/D',
ย ย ย recibidaDe: grupoCalidad,
ย ย ย timestampRecibida: nowISO()
ย ย });

ย ย // 3) Workflow + historial + contador (Calidad)
ย ย pushWorkflow(tarimaId, 'liberada', { grupoCalidad, grupoProd });
ย ย db.ref(`historialLogs/${fecha}/${turno}`).push({
ย ย ย usuario: usuarioSeleccionado,
ย ย ย grupo: grupoCalidad,
ย ย ย accion: 'liberada',
ย ย ย tarimaId,
ย ย ย timestamp: nowISO()
ย ย });
ย ย db.ref(`contadoresTarimas/${fecha}/${turno}/${grupoCalidad}/liberadas`)
ย ย ย .transaction(v => (v || 0) + 1);

ย ย alert(`โ Tarima ${tarimaId} liberada y enviada a ${grupoProd}.`);
ย ย cerrarModalCalidad && cerrarModalCalidad();
ย });
}
ย // --- !!DESPLIEQUE DE TARIMA EN PANEL, AGREGA DOWNDROP A CALIDAD O !! ---
ยย
ย function renderTarimaEncontrada(tarima) {
ย // Rellena campos
ย MT.ui.fields.id.textContent = tarima.id;
ย MT.ui.fields.empleado.textContent = tarima.empleadoId;
ย MT.ui.fields.turno.textContent = tarima.turno;
ย MT.ui.fields.totalCajas.textContent = tarima.totalCajas;
ย MT.ui.fields.totalPiezas.textContent = tarima.totalPiezas;

ย // Lista de cajas
ย MT.ui.fields.listaCajas.innerHTML = '';
ย tarima.cajas.forEach(c => {
ย ย const li = document.createElement('li');
ย ย li.textContent = `${c.codigoCaja}ย |ย ${c.cantidadPiezas} pz`;
ย ย MT.ui.fields.listaCajas.appendChild(li);
ย });

ย // Si el usuario es CALIDAD_* โ mostrar asignaciรณn de LED
ย const isCalidad = (window.__usuarioActual || '').startsWith('CALIDAD');
ย MT.ui.asignacion.wrap.style.display = isCalidad ? 'block' : 'none';

ย if (isCalidad) {
ย ย // ๐ก Llama a la funciรณn que ahora genera los LEDs en el panel.
ย ย cargarLedsDisponibles();
ย ย // ๐ก Asegura que el botรณn de asignar del panel tenga la lรณgica de asignaciรณn.
ย ย MT.ui.asignacion.btn.onclick = () => {
ย ย ย const ledId = MT.ui.asignacion.select.value;
ย ย ย if (!ledId) return;
ย ย ย asignarLedATarima(ledId, tarima.id);
ย ย };
ย }

ย MT.ui.infoBox.style.display = 'block';
}

ย // =======================================================
//ย โ VALIDACIรN DE ACCIONES SOBRE LEDs
//ย - Solo permite encender/apagar si hay tarima asignada.
//ย - En apagado (Logรญstica), libera el LED.
//ย - Se integra SIN romper tus funciones existentes.
//ย ย * Si tenรญas encenderLed/apagarLed โ las envolvemos.
//ย ย * Si no, exponemos estas funciones para tus botones.
// =======================================================

function validarLedAntesDeAccion(ledId) {
ย return database.ref('ledsAsignados/'+ledId).once('value').then(snap => snap.exists());
}

// Wrappers seguros (detectan y envuelven funciones existentes)
(function envolverAccionesLED(){
ย const _encender = window.encenderLed;
ย const _apagar = window.apagarLed;

ย // Encender: requiere tarima asignada
ย window.encenderLed = function(ledId) {
ย ย validarLedAntesDeAccion(ledId).then(ok => {
ย ย ย if (!ok) { alert('Este LED no tiene tarima asignada. Asigna una desde Calidad.'); return; }
ย ย ย if (typeof _encender === 'function') {
ย ย ย ย // Tu lรณgica original
ย ย ย ย _encender(ledId);
ย ย ย } else {
ย ย ย ย // Por si no existรญa: write directo (mantรฉn tu pintarLed/cargarEstado aparte)
ย ย ย ย database.ref('estadoLEDs/'+ledId).set(true);
ย ย ย }
ย ย }).catch(err => console.error('Validaciรณn LED fallรณ:', err));
ย };

ย // Apagar: requiere tarima asignada y luego libera
ย window.apagarLed = function(ledId) {
ย ย validarLedAntesDeAccion(ledId).then(ok => {
ย ย ย if (!ok) { alert('Este LED no tiene tarima asignada.'); return; }
ย ย ย const apagarAccion = () => {
ย ย ย ย if (typeof _apagar === 'function') {
ย ย ย ย ย _apagar(ledId);
ย ย ย ย } else {
ย ย ย ย ย database.ref('estadoLEDs/'+ledId).set(false);
ย ย ย ย }
ย ย ย ย // Liberaciรณn automรกtica
ย ย ย ย database.ref('ledsAsignados/'+ledId).remove()
ย ย ย ย ย .then(()=>console.info('LED liberado:', ledId))
ย ย ย ย ย .catch(err=>console.warn('No se pudo liberar LED:', err));
ย ย ย };
ย ย ย apagarAccion();
ย ย }).catch(err => console.error('Validaciรณn LED fallรณ:', err));
ย };
})();

// =======================================================
//ย ๐ NOTAS PARA FUTURAS EXTENSIONES
//ย - Reportes: puedes consumir /tarimas y /ledsAsignados para ver
//ย ย quรฉ LED tuvo quรฉ tarima y cuรกndo.
//ย - Permisos: si luego agregas auth/roles, aquรญ puedes condicionar
//ย ย la visibilidad del FAB y del panel por usuario.
//ย - Reglas de seguridad: idealmente, en Firebase Rules valida que
//ย ย solo se pueda escribir /estadoLEDs/{ledId} si existe
//ย ย /ledsAsignados/{ledId}. Asรญ la seguridad queda a prueba de balas.
// =======================================================

ยย
// ================= FUNCIONES DE RENDER ( REPARTE LA PANTALLA 2 ACORDE AL USUARIO SELECCIONADO =================
function inyectaLEDs(){
ย ย document.querySelectorAll('.grupo').forEach(grupoDiv => {
ย ย ย ย grupoDiv.classList.add('oculto');
ย ย });

ย ย if (usuarioSeleccionado === 'SUPERVISOR') {
ย ย ย ย document.querySelectorAll('.grupo').forEach(grupoDiv => {
ย ย ย ย ย ย grupoDiv.classList.remove('oculto');
ย ย ย ย });
ย ย } else if (usuarioSeleccionado === 'LOGรSTICA') {
ย ย ย ย document.querySelectorAll('.grupo:not([data-grupo*="CALIDAD_"])').forEach(grupoDiv => {
ย ย ย ย ย ย grupoDiv.classList.remove('oculto');
ย ย ย ย });
ย ย } else if (usuarioSeleccionado.startsWith('CALIDAD_')) {
ย ย ย ย document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`).classList.remove('oculto');
ย ย } else {
ย ย ย ย document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`).classList.remove('oculto');
ย ย ย ย document.querySelector(`.grupo[data-grupo="CALIDAD_${usuarioSeleccionado}"]`).classList.remove('oculto');
ย ย }

ย ย document.querySelectorAll('.grupo:not(.oculto) .leds').forEach(contenedor => {
ย ย ย ย const grupoLeds = contenedor.dataset.grupo;
ย ย ย ย const linea = contenedor.dataset.linea;
ย ย ย ยย
ย ย ย ย const ledsPorLinea = 5;
ย ย ย ย contenedor.innerHTML = '';
ย ย ย ยย
ย ย ย ย for(let i = 0; i < ledsPorLinea; i++){
ย ย ย ย ย ย const led = document.createElement('div');
ย ย ย ย ย ย led.className = 'led';
ย ย ย ย ย ย led.title = `${grupoLeds} โข ${linea} โข LED ${i+1}`;
ย ย ย ย ย ย led.addEventListener('click', () => togglearLED(grupoLeds, i, linea));
ย ย ย ย ย ย contenedor.appendChild(led);
ย ย ย ย }
ย ย });
}

// --- !!DETALLES CON LOS LEDS, ENCENDIDOS FX ETC!! ---
ยย
function pintarEstado() {
ย ย db.ref('estadoLEDs').on('value', snapshot => {
ย ย ย ย const estados = snapshot.val() || {};
ย ย ย ย document.querySelectorAll('.leds').forEach(contenedor => {
ย ย ย ย ย ย const grupoLeds = contenedor.dataset.grupo;
ย ย ย ย ย ย const linea = contenedor.dataset.linea;

ย ย ย ย ย ย if (estados[grupoLeds] && estados[grupoLeds][linea]) {
ย ย ย ย ย ย ย ย const ledsEstado = estados[grupoLeds][linea];
ย ย ย ย ย ย ย ย contenedor.querySelectorAll('.led').forEach((led, index) => {
ย ย ย ย ย ย ย ย ย ย led.classList.remove('on', 'naranja', 'rojo', 'verde', 'disabled');
ย ย ย ย ย ย ย ย ย ย led.innerHTML = '';

ย ย ย ย ย ย ย ย ย ย if (ledsEstado[index]) {
ย ย ย ย ย ย ย ย ย ย ย ย const estado = ledsEstado[index];
ย ย ย ย ย ย ย ย ย ย ย ย let tarimaId = estado.tarimaId || "";
ย ย ย ย ย ย ย ย ย ย ย ย if (tarimaId.length > 6) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย // mostramos รบltimos 4 caracteres si es largo
ย ย ย ย ย ย ย ย ย ย ย ย ย ย tarimaId = tarimaId.slice(-4);
ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย if (grupoLeds.startsWith('CALIDAD_') && estado.color) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย // LEDs de Calidad
ย ย ย ย ย ย ย ย ย ย ย ย ย ย led.classList.add(estado.color);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (tarimaId) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย led.innerHTML = `<span class="tarima-label">${tarimaId}</span>`;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย } else if (estado.encendido) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย // LEDs de Producciรณn
ย ย ย ย ย ย ย ย ย ย ย ย ย ย led.classList.add('on');
ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (tarimaId) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย led.innerHTML = `<span class="tarima-label">${tarimaId}</span>`;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย contenedor.querySelectorAll('.led').forEach(led => {
ย ย ย ย ย ย ย ย ย ย led.classList.remove('on', 'naranja', 'rojo', 'verde', 'disabled');
ย ย ย ย ย ย ย ย ย ย led.innerHTML = '';
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย }
ย ย ย ย });
ย ย });
}
ยย
function actualizarTiemposLEDs() {
ย ย document.querySelectorAll('.led-linea .led.on').forEach(led => {
ย ย ย ย const horaEncendido = led.dataset.horaEncendido;
ย ย ย ย if (horaEncendido) {
ย ย ย ย ย ย const tiempoTranscurrido = (new Date() - new Date(horaEncendido)) / 1000; // En segundos
ย ย ย ย ย ย const minutos = Math.floor(tiempoTranscurrido / 60);
ย ย ย ย ย ย const segundos = Math.floor(tiempoTranscurrido % 60);
ย ย ย ย ย ย led.querySelector('.tiempo-led').textContent = `${minutos}m ${segundos}s`;
ย ย ย ย }
ย ย });
}
ย // --- !!CONFIGURACION DE HORA Y TURNOS!! ---
ยย
ย function formatoHora(isoString) {
ย ย if (!isoString) return 'N/A';
ย ย const date = new Date(isoString);
ย ย const hours = String(date.getHours()).padStart(2, '0');
ย ย const minutes = String(date.getMinutes()).padStart(2, '0');
ย ย return `${hours}:${minutes}`;
}

function obtenerTurnoActual() {
ย ย const ahora = new Date();
ย ย const hora = ahora.getHours();
ย ย const minutos = ahora.getMinutes();

ย ย let fecha = new Date(ahora);
ย ย let turno;

ย ย // Turno 1: 06:30 a 18:29
ย ย if ((hora > 6 || (hora === 6 && minutos >= 30)) && (hora < 18 || (hora === 18 && minutos < 30))) {
ย ย ย ย turno = 'Turno 1';
ย ย }ย
ย ย // Turno 2: 18:30 a 06:29 del dรญa siguiente
ย ย else {
ย ย ย ย turno = 'Turno 2';
ย ย ย ย if (hora < 6 || (hora === 6 && minutos < 30)) {
ย ย ย ย ย ย fecha.setDate(ahora.getDate() - 1);
ย ย ย ย }
ย ย }
ย ยย
ย ย const year = fecha.getFullYear();
ย ย const month = String(fecha.getMonth() + 1).padStart(2, '0');
ย ย const day = String(fecha.getDate()).padStart(2, '0');
ย ย const fechaFormateada = `${year}-${month}-${day}`;
ย ยย
ย ย return { fecha: fechaFormateada, turno };
}

// --- !! SINCRONIZACION EN TIEMPO REALย !! ---
ยย
ย // --- !! SINCRONIZACION EN TIEMPO REAL CON TARIMAS !! ---
// --- !! SINCRONIZACION EN TIEMPO REAL CON TARIMAS !! ---
function iniciarListenersFirebase() {
ย ย const { fecha, turno } = obtenerTurnoActual();
ย ย document.getElementById('turnoActual').textContent = `Turno actual: ${turno}`;

ย ย // ๐ Referencias a la base de datos
ย ย const historialRef = db.ref(`historialLogs/${fecha}/${turno}`);
ย ย const contadoresTarimasRef = db.ref(`contadoresTarimas/${fecha}/${turno}`);
ย ยย
ย ย // ๐ Limpiar listeners anteriores (si estรกn definidos)
ย ย // Nota: Aunque ya tienes variables globales, declararlas aquรญ dentro asegura
ย ย // que siempre tengas la referencia correcta para este turno.
ย ย if (historialRef) historialRef.off();
ย ย if (contadoresTarimasRef) contadoresTarimasRef.off();

ย ย // --- Listener: historial en tiempo real ---
ย ย historialRef.on('value', (snapshot) => {
ย ย ย ย const logs = snapshot.val() || {};
ย ย ย ย let tarimasTotales = 0;
ย ย ย ย let tiempoTotalRecoleccion = 0;

ย ย ย ย // ๐ Contadores por grupo
ย ย ย ย const contadores = {
ย ย ย ย ย ย MULTIPORT: { asignadas: 0, recolectadas: 0, rechazadas: 0, liberadas: 0 },
ย ย ย ย ย ย BEDROCK:ย ย{ asignadas: 0, recolectadas: 0, rechazadas: 0, liberadas: 0 },
ย ย ย ย ย ย DROPS:ย ย ย{ asignadas: 0, recolectadas: 0, rechazadas: 0, liberadas: 0 },
ย ย ย ย ย ย CALIDAD_MULTIPORT: { rechazadas: 0, liberadas: 0 },
ย ย ย ย ย ย CALIDAD_BEDROCK:ย ย{ rechazadas: 0, liberadas: 0 },
ย ย ย ย ย ย CALIDAD_DROPS:ย ย ย{ rechazadas: 0, liberadas: 0 },
ย ย ย ย };

ย ย ย ย const tiempos = { MULTIPORT: [], BEDROCK: [], DROPS: [] };

ย ย ย ย // Procesar historial
ย ย ย ย Object.values(logs).forEach(log => {
ย ย ย ย ย ย switch (log.accion) {
ย ย ย ย ย ย ย ย case 'asignada_en_produccion':
ย ย ย ย ย ย ย ย ย ย if (contadores[log.grupo]) contadores[log.grupo].asignadas++;
ย ย ย ย ย ย ย ย ย ย break;
ย ย ย ย ย ย ย ย case 'recolectada':
ย ย ย ย ย ย ย ย ย ย if (contadores[log.grupo]) contadores[log.grupo].recolectadas++;
ย ย ย ย ย ย ย ย ย ย tarimasTotales++;
ย ย ย ย ย ย ย ย ย ย if (log.tiempoRecoleccion) {
ย ย ย ย ย ย ย ย ย ย ย ย tiempos[log.grupo]?.push(log);
ย ย ย ย ย ย ย ย ย ย ย ย tiempoTotalRecoleccion += log.tiempoRecoleccion;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย break;
ย ย ย ย ย ย ย ย case 'rechazada':
ย ย ย ย ย ย ย ย ย ย if (contadores[log.grupo]) contadores[log.grupo].rechazadas++;
ย ย ย ย ย ย ย ย ย ย break;
ย ย ย ย ย ย ย ย case 'liberada':
ย ย ย ย ย ย ย ย ย ย if (contadores[log.grupo]) contadores[log.grupo].liberadas++;
ย ย ย ย ย ย ย ย ย ย break;
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // ๐ Calcular tiempo promedio
ย ย ย ย const tiempoPromedio = tarimasTotales > 0
ย ย ย ย ย ย ? Math.round(tiempoTotalRecoleccion / tarimasTotales)
ย ย ย ย ย ย : 0;

ย ย ย ย // Actualizar UI principal
ย ย ย ย document.getElementById('tarimasTotales').textContent = tarimasTotales;
ย ย ย ย document.getElementById('tiempoPromedio').textContent = `${tiempoPromedio} min`;

ย ย ย ย const resumenTurnoDiv = document.getElementById('resumenTurno');
ย ย ย ย if (usuarioSeleccionado === 'LOGรSTICA' || usuarioSeleccionado === 'SUPERVISOR') {
ย ย ย ย ย ย resumenTurnoDiv.classList.remove('oculto');
ย ย ย ย } else {
ย ย ย ย ย ย resumenTurnoDiv.classList.add('oculto');
ย ย ย ย }

ย ย ย ย // Actualizar mรฉtricos en UI
ย ย ย ย Object.keys(contadores).forEach(grupo => {
ย ย ย ย ย ย const c = contadores[grupo];
ย ย ย ย ย ย const el = document.querySelector(`.grupo[data-grupo="${grupo}"] .tarimas`);
ย ย ย ย ย ย if (el) {
ย ย ย ย ย ย ย ย el.textContent =
ย ย ย ย ย ย ย ย ย ย `Asig: ${c.asignadas || 0} | Rec: ${c.recolectadas || 0} | Lib: ${c.liberadas || 0} | Rech: ${c.rechazadas || 0}`;
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // Mostrar tiempos por grupo
ย ย ย ย Object.keys(tiempos).forEach(grupo => {
ย ย ย ย ย ย const contenedorTiempos = document.querySelector(`.tiempos[data-grupo="${grupo}"]`);
ย ย ย ย ย ย if (!contenedorTiempos) return;

ย ย ย ย ย ย contenedorTiempos.innerHTML = '';
ย ย ย ย ย ย tiempos[grupo].forEach((logEntry, index) => {
ย ย ย ย ย ย ย ย const p = document.createElement('p');
ย ย ย ย ย ย ย ย const horaInicio = formatoHora(logEntry.horaEncendido);
ย ย ย ย ย ย ย ย const horaFin = formatoHora(logEntry.horaApagado);
ย ย ย ย ย ย ย ย p.textContent = `Tarima ${index + 1}: ${logEntry.tiempoRecoleccion} min (${horaInicio} - ${horaFin})`;
ย ย ย ย ย ย ย ย contenedorTiempos.appendChild(p);
ย ย ย ย ย ย });
ย ย ย ย ย ย contenedorTiempos.scrollTop = contenedorTiempos.scrollHeight;
ย ย ย ย });
ย ย });

ย ย // --- Listener: contadores globales en tiempo real ---
ย ย contadoresTarimasRef.on('value', (snapshot) => {
ย ย ย ย const contadores = snapshot.val() || {};
ย ย ย ย const grupos = ['MULTIPORT', 'BEDROCK', 'DROPS', 'CALIDAD_MULTIPORT', 'CALIDAD_BEDROCK', 'CALIDAD_DROPS'];

ย ย ย ย grupos.forEach(grupo => {
ย ย ย ย ย ย const g = contadores[grupo] || {};
ย ย ย ย ย ย const asig = g.asignadas || 0;
ย ย ย ย ย ย const rec = g.recolectadas || 0;
ย ย ย ย ย ย const lib = g.liberadas || 0;
ย ย ย ย ย ย const rech = g.rechazadas || 0;

ย ย ย ย ย ย const target = document.getElementById(`metricas_${grupo}`);
ย ย ย ย ย ย if (target) {
ย ย ย ย ย ย ย ย target.textContent = `Asig: ${asig} | Rec: ${rec} | Lib: ${lib} | Rech: ${rech}`;
ย ย ย ย ย ย }
ย ย ย ย });
ย ย });
}

// --- Actualizar contadores de tarimas ---
function actualizarContadoresTarimas(grupo, accion) {
ย ย const { fecha, turno } = obtenerTurnoActual();
ย ย const contadorRef = db.ref(`contadoresTarimas/${fecha}/${turno}/${grupo}`);

ย ย switch (accion) {
ย ย ย ย case 'asignada_en_produccion':
ย ย ย ย ย ย contadorRef.child('asignadas').transaction(val => (val || 0) + 1);
ย ย ย ย ย ย break;
ย ย ย ย case 'recolectada':
ย ย ย ย ย ย contadorRef.child('recolectadas').transaction(val => (val || 0) + 1);
ย ย ย ย ย ย break;
ย ย ย ย case 'rechazada':
ย ย ย ย ย ย contadorRef.child('rechazadas').transaction(val => (val || 0) + 1);
ย ย ย ย ย ย break;
ย ย ย ย case 'liberada':
ย ย ย ย ย ย contadorRef.child('liberadas').transaction(val => (val || 0) + 1);
ย ย ย ย ย ย break;
ย ย }
}


ยย
// ================= PERMISOS Y LรGICA =================
function esUsuarioProduccion() {
ย ย return CONFIG.PRODUCCION_GRUPOS.includes(usuarioSeleccionado);
}

function puedeControlar(grupo){
ย ย if(!usuarioSeleccionado) {
ย ย ย ย return false;
ย ย }
ยย
ย ย if (usuarioSeleccionado === 'SUPERVISOR') {
ย ย ย ย return false;
ย ย }
ยย
ย ย if (usuarioSeleccionado === 'LOGรSTICA') {
ย ย ย ย return true;
ย ย }
ยย
ย ย const grupoBaseUsuario = usuarioSeleccionado.startsWith('CALIDAD_') ? usuarioSeleccionado.replace('CALIDAD_', '') : usuarioSeleccionado;
ย ย const grupoBaseLed = grupo.startsWith('CALIDAD_') ? grupo.replace('CALIDAD_', '') : grupo;

ย ย return grupoBaseUsuario === grupoBaseLed;
}
ยย
// ===================== TOGGLE LED (CORREGIDO) =====================
// ===================== TOGGLE LED (CANรNICO) =====================
function togglearLED(grupo, idx, linea = 'linea1') {
ย const ledRefย ย= db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
ย const ledPathย = `${linea}-${idx + 1}`;
ย const usuarioActual = usuarioSeleccionado || '';

ย ledRef.once('value').then(snapshot => {
ย ย const estadoActual = snapshot.val() || {};

ย ย // ===== CALIDAD sobre LEDs de CALIDAD =====
ย ย if (usuarioActual.startsWith('CALIDAD_') && grupo.startsWith('CALIDAD_')) {
ย ย ย if (!estadoActual.tarimaId) {
ย ย ย ย alert('Este LED no tiene ninguna tarima asignada.');
ย ย ย ย return;
ย ย ย }
ย ย ย const color = estadoActual.color || 'naranja';
ย ย ย if (color === 'verde') {
ย ย ย ย alert('Este LED ya estรก liberado y no puede ser modificado por Calidad.');
ย ย ย ย return;
ย ย ย }
ย ย ย abrirModalCalidad(grupo, idx, linea, estadoActual.tarimaId);
ย ย ย return;
ย ย }

ย ย // ===== PRODUCCIรN recibiendo desde CALIDAD (clic en LED de CALIDAD) =====
if (
ย (usuarioActual === 'MULTIPORT' || usuarioActual === 'DROPS' || usuarioActual === 'BEDROCK') &&
ย grupo.startsWith('CALIDAD_')
) {
ย if (estadoActual.color === 'verde' && estadoActual.tarimaId) {
ย ย const ok = confirm(`ยฟRecibir tarima ${estadoActual.tarimaId} de Calidad?`);
ย ย if (!ok) return;

ย ย const tarimaId = estadoActual.tarimaId;

ย ย // Guardar en recibidas de Producciรณn
ย ย db.ref(`tarimasRecibidas/${usuarioActual}/${tarimaId}`).set({
ย ย ย tarimaId,
ย ย ย recibidoEn: nowISO(),
ย ย ย ledOrigen: `${linea}-${idx+1}`,
ย ย ย recibidaDe: grupo
ย ย });

ย ย // Limpiar el LED de Calidad para liberarlo
ย ย const ledRefCalidad = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
ย ย ledRefCalidad.set(null);

ย ย // Workflow + historial
ย ย pushWorkflow(tarimaId, 'recibida_por_produccion', { grupoOrigen: grupo, grupoDestino: usuarioActual });
ย ย alert(`โ Tarima ${tarimaId} recibida por ${usuarioActual}`);
ย } else {
ย ย alert('Solo puedes recibir tarimas liberadas (verdes).');
ย }
ย return;
}
ย ย // ===== PRODUCCIรN sobre sus propios LEDs (asignar) =====
ย ย if (
ย ย ย (usuarioActual === 'MULTIPORT' || usuarioActual === 'DROPS' || usuarioActual === 'BEDROCK') &&
ย ย ย grupo === usuarioActual
ย ย ) {
ย ย ย // Asegura que el LED estรฉ vacรญo
ย ย ย if (!estadoActual.encendido && !estadoActual.tarimaId) {
ย ย ย ย // ๐ง Seteamos el LED seleccionado ANTES de abrir el modal
ย ย ย ย ledSeleccionado = { grupo, idx, linea };
ย ย ย ย // Abre el modal de producciรณn
ย ย ย ย mostrarModalProduccion(grupo, linea);
ย ย ย } else {
ย ย ย ย alert('Este LED ya tiene una tarima asignada.');
ย ย ย }
ย ย ย return;
ย ย }

ย ย // ===== LOGรSTICA apaga LEDs con tarima asignada =====
ย ย if (usuarioActual === 'LOGรSTICA') {
ย ย ย if (estadoActual.encendido && estadoActual.tarimaId) {
ย ย ย ย const ok = confirm(`ยฟRecolectar tarima ${estadoActual.tarimaId}?`);
ย ย ย ย if (!ok) return;

ย ย ย ย // Limpiar LED
ย ย ย ย ledRef.set(null);

ย ย ย ย // Workflow + historial + contador logรญstica
ย ย ย ย const { fecha, turno } = obtenerTurnoActual();
ย ย ย ย const tarimaId = estadoActual.tarimaId;

ย ย ย ย pushWorkflow(tarimaId, 'recolectada', { grupo });
ย ย ย ย db.ref('historial').push({
ย ย ย ย ย usuario:ย ยusuarioActual,
ย ย ย ย ย grupo:ย ย ยgrupo,
ย ย ย ย ย led:ย ย ย ยledPath,
ย ย ย ย ย accion:ย ย 'recolectada',
ย ย ย ย ย tarimaId:ย tarimaId,
ย ย ย ย ย timestamp: nowISO()
ย ย ย ย });
ย ย ย ย db.ref(`contadoresTarimas/${fecha}/${turno}/LOGรSTICA/recolectadas`)
ย ย ย ย ย .transaction(v => (v || 0) + 1);
ย ย ย } else {
ย ย ย ย alert('LOGรSTICA solo puede apagar LEDs con tarima asignada.');
ย ย ย }
ย ย ย return;
ย ย }

ย ย // ===== Default =====
ย ย alert('No tienes permiso para controlar estos LEDs.');
ย });
}
// =================== FIN TOGGLE LED (CANรNICO) ===================
// =================== FIN TOGGLE LED (CORREGIDO) ===================
ยย
function actualizarEstadoLED(nuevoColor) {
ย if (!ledSeleccionado.grupo) return;

ย const { grupo, idx, linea } = ledSeleccionado;
ย const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);

ย ledRef.once('value').then(snap => {
ย ย const estado = snap.val() || {};
ย ย const tarimaId = estado.tarimaId || "N/D";

ย ย // Cambiar color en el LED (visual)
ย ย ledRef.update({
ย ย ย color: nuevoColor,
ย ย ย timestamp: nowISO()
ย ย });

ย ย // Historial simple (visual)
ย ย db.ref('historial').push({
ย ย ย usuario: usuarioSeleccionado,
ย ย ย grupo,
ย ย ย led: `${linea}-${idx+1}`,
ย ย ย accion: nuevoColor,
ย ย ย tarimaId,
ย ย ย timestamp: nowISO()
ย ย });

ย ย // โ๏ธNo movemos contadores de Producciรณn aquรญ.
ย ย cerrarModalCalidad && cerrarModalCalidad();
ย });
}

ย let ledSeleccionado = { grupo: null, idx: null, linea: null, tarimaId: null };

function abrirModalCalidad(grupo, idx, linea) {
ย ย ledSeleccionado = { grupo, idx, linea };

ย ย const modal = document.getElementById('modalCalidad');
ย ย modal.classList.add('visible');

ย ย modal.querySelectorAll('.opcion-btn').forEach(btn => {
ย ย ย ย btn.onclick = () => {
ย ย ย ย ย ย const color = btn.dataset.color;
ย ย ย ย ย ย if (color === 'rojo') {
ย ย ย ย ย ย ย ย modal.classList.remove('visible');
ย ย ย ย ย ย ย ย document.getElementById('modalRechazo').classList.add('visible');
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย actualizarEstadoLED(color);
ย ย ย ย ย ย ย ย modal.classList.remove('visible'); // ๐ฅ cerrar inmediatamente
ย ย ย ย ย ย }
ย ย ย ย };
ย ย });

ย ย modal.querySelector('.cerrar-btn').onclick = () => {
ย ย ย ย modal.classList.remove('visible');
ย ย };
}


function cerrarModalCalidad() {
ย ย document.getElementById('modalCalidad').classList.remove('visible');
ย ย document.getElementById('modalRechazo').classList.remove('visible');
}
ยย
// ================= LรGICA DE CALIDAD MODAL =================
function mostrarOpcionesCalidad(grupo, idx, linea = 'linea1') {
ย ย const modal = document.getElementById('modalOpcionesCalidad');
ย ย const select = modal.querySelector('#selectLedCalidad');
ย ย select.innerHTML = ''; // limpia opciones anteriores

ย ย // ==============================
ย ย // Generamos lista de LEDs (ej. linea1-1, linea1-2, etc.)
ย ย // ==============================
ย ย const totalLeds = CONFIG.LEDS_POR_GRUPO[grupo] || 5;
ย ย for (let i = 0; i < totalLeds; i++) {
ย ย ย ย const opt = document.createElement('option');
ย ย ย ย opt.value = i; // guardamos รญndice real
ย ย ย ย opt.textContent = `${linea}-${i+1}`; // nombre visible
ย ย ย ย if (i === idx) opt.selected = true;
ย ย ย ย select.appendChild(opt);
ย ย }

ย ย // Guardamos contexto en dataset
ย ย select.dataset.grupo = grupo;
ย ย select.dataset.linea = linea;

ย ย modal.style.display = 'block';
}
ย document.getElementById('btnAsignarTarimaCalidad').addEventListener('click', () => {
ย ย const select = document.getElementById('selectLedCalidad');
ย ย const grupo = select.dataset.grupo;
ย ย const linea = select.dataset.linea;
ย ย const idx = parseInt(select.value);

ย ย // Guardamos tarima en el LED correspondiente
ย ย const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
ย ย ledRef.set({
ย ย ย ย color: 'naranja', // inicia como en revisiรณn
ย ย ย ย tarimaId: tarimaEscaneadaActual || null,
ย ย ย ย usuario: usuarioSeleccionado,
ย ย ย ย timestamp: new Date().toISOString()
ย ย });

ย ย alert(`โ Tarima ${tarimaEscaneadaActual} asignada a ${linea}-${idx+1}`);
ย ย cerrarModalCalidad();
});

function cerrarModalCalidad() {
ย ย document.getElementById('modalOpcionesCalidad').style.display = 'none';
}
// ========================
// PRODUCCIรN: Modal de Asignaciรณn
// --- MODAL PRODUCCION: asignar tarima a LED tocado ---
function mostrarModalProduccion(grupo, linea = 'linea1') {
ย const modal = document.getElementById('modalAsignarTarimaProduccion');
ย const selectTarima = modal.querySelector('#selectTarimaProduccion');
ย const selectLed = modal.querySelector('#selectLedProduccion');

ย const recibidasRef = db.ref(`tarimasRecibidas/${grupo}`);
ย recibidasRef.once('value', snapshot => {
ย ย const recibidas = snapshot.val() || {};
ย ย selectTarima.innerHTML = '';

ย ย const keys = Object.keys(recibidas);
ย ย if (keys.length === 0) {
ย ย ย alert("โ๏ธ No hay tarimas recibidas de Calidad para asignar.");
ย ย ย return;
ย ย }

ย ย // Soporta tanto claves = tarimaId como claves aleatorias (por backward-compat)
ย ย keys.forEach(k => {
ย ย ย const t = recibidas[k];
ย ย ย const opt = document.createElement('option');
ย ย ย opt.value = k; // clave que usaremos para leer
ย ย ย opt.textContent = `${t.tarimaId || k} (de ${t.ledOrigen || 'N/D'})`;
ย ย ย selectTarima.appendChild(opt);
ย ย });

ย ย // Sรณlo el LED tocado
ย ย selectLed.innerHTML = '';
ย ย const opt = document.createElement('option');
ย ย opt.value = ledSeleccionado.idx;
ย ย opt.textContent = `${linea}-${ledSeleccionado.idx + 1}`;
ย ย selectLed.appendChild(opt);

ย ย modal.style.display = 'flex';
ย });
}

ยย
document.getElementById('btnAsignarProduccion').addEventListener('click', () => {
ย ย const { grupo, idx, linea } = ledSeleccionado;
ย ย asignarTarimaProduccion(grupo, idx, linea);
});

function cerrarModalProduccion() {
ย ย document.getElementById('modalAsignarTarimaProduccion').style.display = 'none';
}
ยย
function aplicarEstadoCalidad(nuevoColor) {
ย ย const { grupo, idx, linea } = ledActivoParaFormulario;
ย ย const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);

ย ย if (nuevoColor === 'verde') {
ย ย ย ย const contadorRef = contadoresCalidadRef.child(grupo);
ย ย ย ย contadorRef.child('liberadas').transaction(currentCount => (currentCount || 0) + 1);
ย ย ย ย ledRef.update({
ย ย ย ย ย ย color: nuevoColor,
ย ย ย ย ย ย timestamp: new Date().toISOString(),
ย ย ย ย ย ย usuario: usuarioSeleccionado,
ย ย ย ย ย ย disabled: true // Nuevo estado para deshabilitar
ย ย ย ย });
ย ย } else {
ย ย ย ย ledRef.update({
ย ย ย ย ย ย color: nuevoColor,
ย ย ย ย ย ย timestamp: new Date().toISOString(),
ย ย ย ย ย ย usuario: usuarioSeleccionado,
ย ย ย ย ย ย disabled: false // Asegurarse de que no estรฉ deshabilitado en otros estados
ย ย ย ย });
ย ย ย ย if (nuevoColor === 'rojo') {
ย ย ย ย ย ย const contadorRef = contadoresCalidadRef.child(grupo);
ย ย ย ย ย ย contadorRef.child('rechazadas').transaction(currentCount => (currentCount || 0) + 1);
ย ย ย ย }
ย ย }
}


function mostrarFormularioRechazo() {
ย ย document.getElementById('modalCalidad').classList.remove('visible');
ย ย document.getElementById('modalRechazo').classList.add('visible');
}

// ========================
// CALIDAD: Rechazar Tarima
// ========================
function guardarRechazo(tarimaId, grupoCalidad) {
ย const { fecha, turno } = obtenerTurnoActual();
ย const tarimaRef = db.ref(`tarimas/${tarimaId}`);

ย tarimaRef.once('value').then(snap => {
ย ย if (!snap.exists()) {
ย ย ย alert(`โ Tarima ${tarimaId} no encontrada.`);
ย ย ย return;
ย ย }

ย ย // 1) Estado global
ย ย tarimaRef.update({
ย ย ย estado: 'rechazada',
ย ย ย rechazadaPor: usuarioSeleccionado,
ย ย ย timestampRechazada: nowISO()
ย ย });

ย ย // 2) Workflow + historial + contador (Calidad)
ย ย pushWorkflow(tarimaId, 'rechazada', { grupoCalidad });
ย ย db.ref(`historialLogs/${fecha}/${turno}`).push({
ย ย ย usuario: usuarioSeleccionado,
ย ย ย grupo: grupoCalidad,
ย ย ย accion: 'rechazada',
ย ย ย tarimaId,
ย ย ย timestamp: nowISO()
ย ย });
ย ย db.ref(`contadoresTarimas/${fecha}/${turno}/${grupoCalidad}/rechazadas`)
ย ย ย .transaction(v => (v || 0) + 1);

ย ย // 3) Visual: LED en rojo
ย ย if (ledSeleccionado.grupo === grupoCalidad) {
ย ย ย const { idx, linea } = ledSeleccionado;
ย ย ย const ledRef = db.ref(`estadoLEDs/${grupoCalidad}/${linea}/${idx}`);
ย ย ย ledRef.update({
ย ย ย ย color: 'rojo',
ย ย ย ย tarimaId: tarimaId,
ย ย ย ย timestamp: nowISO()
ย ย ย });
ย ย }

ย ย alert(`โ Tarima ${tarimaId} rechazada.`);
ย ย cerrarModalCalidad && cerrarModalCalidad();
ย });
}

function cerrarModalRechazo() {
ย ย document.getElementById('modalRechazo').classList.remove('visible');
}

ยย
// ================= NAVEGACIรN Y ARRANQUE =================
function activarPantalla(id){
ย ย document.querySelectorAll('.pantalla').forEach(p => {
ย ย ย ย p.style.display = 'none';
ย ย ย ย p.classList.remove('activa');
ย ย });
ย ย const pantalla = document.getElementById(id);
ย ย pantalla.style.display = 'flex';
ย ย pantalla.classList.add('activa');
}

function volverAPantalla1(){
ย ย usuarioSeleccionado = null;
ย ย db.ref('estadoLEDs').off();ย
ย ย if (historialRef) historialRef.off();
ย ย if (contadoresCalidadRef) contadoresCalidadRef.off();
ย ย if (rechazosDetalladosRef) rechazosDetalladosRef.off();
ย ย clearInterval(dashboardUpdateInterval);
ย ย activarPantalla('pantalla1');
}

function seleccionarUsuario(usuario) {
ย ย if (!CONFIG.USUARIOS.includes(usuario)) {
ย ย ย ย return;
ย ย }

ย ย if (usuario === 'SUPERVISOR') {
ย ย ย ย const password = prompt('Introduce la contraseรฑa para SUPERVISOR:');
ย ย ย ย if (password === CONFIG.PASSWORDS['SUPERVISOR']) {
ย ย ย ย ย ย usuarioSeleccionado = usuario;
ย ย ย ย ย ย document.getElementById('tituloFijo').textContent = 'SUPERVISOR';
ย ย ย ย ย ย activarPantalla('pantalla2');
ย ย ย ย ย ย inyectaLEDs();
ย ย ย ย ย ย pintarEstado();
ย ย ย ย ย ย iniciarListenersFirebase();
ย ย ย ย ย ย alert(`ยกBienvenido, ${usuario}!`);
ย ย ย ย } else {
ย ย ย ย ย ย alert('Contraseรฑa incorrecta. Intรฉntalo de nuevo.');
ย ย ย ย }
ย ย } else if (usuario === 'CALIDAD') {
ย ย ย ย const password = prompt('Introduce la contraseรฑa para CALIDAD:');
ย ย ย ย let subusuario = null;

ย ย ย ย if (password === CONFIG.PASSWORDS['CALIDAD_MULTIPORT']) {
ย ย ย ย ย ย subusuario = 'CALIDAD_MULTIPORT';
ย ย ย ย } else if (password === CONFIG.PASSWORDS['CALIDAD_DROPS']) {
ย ย ย ย ย ย subusuario = 'CALIDAD_DROPS';
ย ย ย ย } else if (password === CONFIG.PASSWORDS['CALIDAD_BEDROCK']) {
ย ย ย ย ย ย subusuario = 'CALIDAD_BEDROCK';
ย ย ย ย }

ย ย ย ย if (subusuario) {
ย ย ย ย ย ย usuarioSeleccionado = subusuario;
ย ย ย ย ย ย document.getElementById('tituloFijo').textContent = `CALIDAD - ${subusuario.split('_')[1]}`;
ย ย ย ย ย ย activarPantalla('pantalla2');
ย ย ย ย ย ย inyectaLEDs();
ย ย ย ย ย ย pintarEstado();
ย ย ย ย ย ย iniciarListenersFirebase();
ย ย ย ย ย ย alert(`ยกBienvenido, ${subusuario.replace('_', ' ')}!`);
ย ย ย ย } else {
ย ย ย ย ย ย alert('Contraseรฑa incorrecta. Intรฉntalo de nuevo.');
ย ย ย ย }
ย ย } else {
ย ย ย ย const password = prompt(`Introduce la contraseรฑa para ${usuario}:`);
ย ย ย ย if (password === CONFIG.PASSWORDS[usuario]) {
ย ย ย ย ย ย usuarioSeleccionado = usuario;
ย ย ย ย ย ย if (usuario === 'LOGรSTICA') {
ย ย ย ย ย ย ย ย document.getElementById('tituloFijo').textContent = 'LOGรSTICA';
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย document.getElementById('tituloFijo').textContent = usuario;
ย ย ย ย ย ย }
ย ย ย ย ย ย activarPantalla('pantalla2');
ย ย ย ย ย ย inyectaLEDs();
ย ย ย ย ย ย pintarEstado();
ย ย ย ย ย ย iniciarListenersFirebase();

ย ย ย ย ย ย // โ Producciรณn carga tarimas recibidas
ย ย ย ย ย ย if (esUsuarioProduccion()) {
ย ย ย ย ย ย ย ย renderTarimasRecibidas(usuarioSeleccionado);
ย ย ย ย ย ย }

ย ย ย ย ย ย alert(`ยกBienvenido, ${usuario}!`);
ย ย ย ย } else {
ย ย ย ย ย ย alert('Contraseรฑa incorrecta. Intรฉntalo de nuevo.');
ย ย ย ย }
ย ย }
}
ยย
function seleccionarReporte() {
ย ย const password = prompt('Introduce la contraseรฑa para REPORTES:');
ย ย if (password === CONFIG.PASSWORDS['REPORTES']) {
ย ย ย ย activarPantalla('pantalla3');
ย ย ย ย document.getElementById('tituloReportes').textContent = 'REPORTES';
ย ย ย ย document.getElementById('selectoresReportes').style.display = 'flex';
ย ย ย ย document.getElementById('contenedorReporte').innerHTML = '<h2>Selecciona un reporte</h2>';
ย ย } else {
ย ย ย ย alert('Contraseรฑa incorrecta. Acceso denegado.');
ย ย }
}

// --- !!AQUI EMPIEZA BLOQUE DE DASHBOARD!! ---ย ยย
ย ยย
function seleccionarDashboard() {
ย ย const password = prompt('Introduce la contraseรฑa para DASHBOARD:');
ย ย if (password === CONFIG.PASSWORDS['DASHBOARD']) {
ย ย ย ย activarPantalla('pantalla4');
ย ย ย ย iniciarDashboard();
ย ย } else {
ย ย ย ย alert('Contraseรฑa incorrecta. Acceso denegado.');
ย ย }
}

function limpiarDashboardListeners() {
ย ย dashboardListeners.forEach(listener => listener.off());
ย ย dashboardListeners = [];
}

function iniciarDashboard() {
ย ย limpiarDashboardListeners();
ย ย const { fecha, turno } = obtenerTurnoActual();
ย ย document.getElementById('fechaDashboard').value = fecha;
ย ย document.getElementById('turnoDashboardSelect').value = 'todos';
ย ยย
ย ย setupDashboardListeners(fecha, turno);
ย ยย
ย ย // Listeners para los filtros de fecha y turno
ย ย document.getElementById('fechaDashboard').addEventListener('change', () => {
ย ย ย ย setupDashboardListeners(document.getElementById('fechaDashboard').value, document.getElementById('turnoDashboardSelect').value);
ย ย });

ย ย document.getElementById('turnoDashboardSelect').addEventListener('change', () => {
ย ย ย ย setupDashboardListeners(document.getElementById('fechaDashboard').value, document.getElementById('turnoDashboardSelect').value);
ย ย });
}

function setupDashboardListeners(fecha, turno) {
ย ย limpiarDashboardListeners();
ย ยย
ย ย const historialRefDash = db.ref(`historialLogs/${fecha}`);
ย ย const calidadRefDash = db.ref(`contadoresCalidad/${fecha}`);
ย ย const ledsRefDash = db.ref('estadoLEDs');

ย ย const historialListener = historialRefDash.on('value', snapshot => {
ย ย ย ย const logsPorTurno = snapshot.val() || {};
ย ย ย ย let logsFiltrados = {};
ย ย ย ย if (turno === 'todos') {
ย ย ย ย ย ย Object.values(logsPorTurno).forEach(logs => {
ย ย ย ย ย ย ย ย logsFiltrados = { ...logsFiltrados, ...logs };
ย ย ย ย ย ย });
ย ย ย ย } else {
ย ย ย ย ย ย logsFiltrados = logsPorTurno[turno] || {};
ย ย ย ย }
ย ย ย ย actualizarDashboard(logsFiltrados, 'historial', null, null);
ย ย });
ย ย dashboardListeners.push({ off: () => historialRefDash.off('value', historialListener) });

ย ย const calidadListener = calidadRefDash.on('value', snapshot => {
ย ย ย ย const contadoresPorTurno = snapshot.val() || {};
ย ย ย ย let contadoresFiltrados = {};
ย ย ย ย if (turno === 'todos') {
ย ย ย ย ย ย for (const t in contadoresPorTurno) {
ย ย ย ย ย ย ย ย for (const g in contadoresPorTurno[t]) {
ย ย ย ย ย ย ย ย ย ย contadoresFiltrados[g] = contadoresFiltrados[g] || { liberadas: 0, rechazadas: 0 };
ย ย ย ย ย ย ย ย ย ย contadoresFiltrados[g].liberadas += contadoresPorTurno[t][g].liberadas || 0;
ย ย ย ย ย ย ย ย ย ย contadoresFiltrados[g].rechazadas += contadoresPorTurno[t][g].rechazadas || 0;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย } else {
ย ย ย ย ย ย contadoresFiltrados = contadoresPorTurno[turno] || {};
ย ย ย ย }
ย ย ย ย actualizarDashboard(null, 'calidad', contadoresFiltrados, null);
ย ย });
ย ย dashboardListeners.push({ off: () => calidadRefDash.off('value', calidadListener) });
ย ยย
ย ย const ledsListener = ledsRefDash.on('value', snapshot => {
ย ย ย ย const leds = snapshot.val() || {};
ย ย ย ย actualizarDashboard(null, 'leds', null, leds);
ย ย });
ย ย dashboardListeners.push({ off: () => ledsRefDash.off('value', ledsListener) });
}


function actualizarDashboard(historialLogs, tipo, contadoresCalidad, estadoLEDs, filtroArea = 'TODAS') {
ย ย if (tipo === 'historial') {
ย ย ย ย const produccionPorArea = { MULTIPORT: 0, DROPS: 0, BEDROCK: 0 };
ย ย ย ย const tarimasPorHora = {};
ย ย ย ย let tarimasRecolectadas = 0;
ย ย ย ย let tiempoTotalRecoleccion = 0;
ย ย ย ยย
ย ย ย ย for (const logKey in historialLogs) {
ย ย ย ย ย ย const log = historialLogs[logKey];
ย ย ย ย ย ยย
ย ย ย ย ย ย // Nuevo filtro de รกrea
ย ย ย ย ย ย if (filtroArea === 'TODAS' || log.grupo === filtroArea) {
ย ย ย ย ย ย ย ย if (log.accion === 'encendido' && produccionPorArea.hasOwnProperty(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย produccionPorArea[log.grupo]++;
ย ย ย ย ย ย ย ย } else if (log.accion === 'apagado' && log.tiempoRecoleccion && ['MULTIPORT', 'BEDROCK', 'DROPS'].includes(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย tarimasRecolectadas++;
ย ย ย ย ย ย ย ย ย ย tiempoTotalRecoleccion += log.tiempoRecoleccion;
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย const horaApagado = new Date(log.horaApagado);
ย ย ย ย ย ย ย ย ย ย const horaRedondeada = horaApagado.getHours();
ย ย ย ย ย ย ย ย ย ย tarimasPorHora[horaRedondeada] = (tarimasPorHora[horaRedondeada] || 0) + 1;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ยย
ย ย ย ย const tiempoPromedio = tarimasRecolectadas > 0 ? (tiempoTotalRecoleccion / tarimasRecolectadas).toFixed(1) : 0;
ย ย ย ยย
ย ย ย ย document.getElementById('dashTarimasConfirmadas').textContent = Object.values(produccionPorArea).reduce((a, b) => a + b, 0);
ย ย ย ย document.getElementById('dashTarimasRecolectadas').textContent = tarimasRecolectadas;
ย ย ย ย document.getElementById('dashTiempoPromedio').textContent = `${tiempoPromedio} min`;
ย ย ย ยย
ย ย ย ย const kpiTiempoPromedio = document.getElementById('kpiTiempoPromedio');
ย ย ย ย if (tiempoPromedio > 10) {
ย ย ย ย ย ย kpiTiempoPromedio.classList.add('alerta');
ย ย ย ย } else {
ย ย ย ย ย ย kpiTiempoPromedio.classList.remove('alerta');
ย ย ย ย }
ย ย ย ยย
ย ย ย ย generarGraficoProduccionDash(produccionPorArea);
ย ย ย ย generarGraficoLogisticaDash(tarimasPorHora);
ย ย }
ย ยย
ย ย // El resto de la funciรณn para 'calidad' y 'leds' se mantiene igual y funciona de manera independiente
ย ย if (tipo === 'calidad') {
ย ย ย ย let liberadas = 0;
ย ย ย ย let rechazadas = 0;
ย ย ย ย for (const grupo in contadoresCalidad) {
ย ย ย ย ย ย liberadas += contadoresCalidad[grupo].liberadas || 0;
ย ย ย ย ย ย rechazadas += contadoresCalidad[grupo].rechazadas || 0;
ย ย ย ย }
ย ย ย ย const totalCalidad = liberadas + rechazadas;
ย ย ย ย const tasaRechazo = totalCalidad > 0 ? ((rechazadas / totalCalidad) * 100).toFixed(1) : 0;
ย ย ย ยย
ย ย ย ย document.getElementById('dashTasaRechazo').textContent = `${tasaRechazo}%`;

ย ย ย ย const kpiTasaRechazo = document.getElementById('kpiTasaRechazo');
ย ย ย ย if (tasaRechazo > 5) {
ย ย ย ย ย ย kpiTasaRechazo.classList.add('alerta');
ย ย ย ย } else {
ย ย ย ย ย ย kpiTasaRechazo.classList.remove('alerta');
ย ย ย ย }
ย ย ย ย generarGraficoCalidadDash({ liberadas, rechazadas });
ย ย }

ย ย if (tipo === 'leds') {
ย ย ย ย const pendientesPorArea = {};
ย ย ย ยย
ย ย ย ย CONFIG.PRODUCCION_GRUPOS.forEach(grupo => {
ย ย ย ย ย ย pendientesPorArea[grupo] = 0;
ย ย ย ย ย ย if (estadoLEDs.hasOwnProperty(grupo)) {
ย ย ย ย ย ย ย ย for (const linea in estadoLEDs[grupo]) {
ย ย ย ย ย ย ย ย ย ย for (const led in estadoLEDs[grupo][linea]) {
ย ย ย ย ย ย ย ย ย ย ย ย if (estadoLEDs[grupo][linea][led].encendido) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย pendientesPorArea[grupo]++;
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย });
ย ย ย ยย
ย ย ย ย const tablaPendientesBody = document.querySelector('#tablaPendientes tbody');
ย ย ย ย tablaPendientesBody.innerHTML = '';
ย ย ย ย for (const area in pendientesPorArea) {
ย ย ย ย ย ย const tr = document.createElement('tr');
ย ย ย ย ย ย tr.innerHTML = `<td>${area}</td><td>${pendientesPorArea[area]}</td>`;
ย ย ย ย ย ย tablaPendientesBody.appendChild(tr);
ย ย ย ย }
ย ย }
}
function generarGraficoProduccionDash(datos) {
ย ย if (graficosDashboard.produccion) {
ย ย ย ย graficosDashboard.produccion.destroy();
ย ย }
ย ย const ctx = document.getElementById('graficoProduccionDash').getContext('2d');
ย ย const labels = Object.keys(datos);
ย ย const data = Object.values(datos);
ย ย graficosDashboard.produccion = new Chart(ctx, {
ย ย ย ย type: 'bar',
ย ย ย ย data: {
ย ย ย ย ย ย labels: labels,
ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย label: 'Tarimas Confirmadas',
ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย backgroundColor: ['#4BC0C0', '#36A2EB', '#FFCE56'],
ย ย ย ย ย ย ย ย borderColor: ['#4BC0C0', '#36A2EB', '#FFCE56'],
ย ย ย ย ย ย ย ย borderWidth: 1
ย ย ย ย ย ย }]
ย ย ย ย },
ย ย ย ย options: {
ย ย ย ย ย ย responsive: true, maintainAspectRatio: false,
ย ย ย ย ย ย scales: {
ย ย ย ย ย ย ย ย y: { beginAtZero: true, title: { display: true, text: 'Tarimas' } }
ย ย ย ย ย ย },
ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย legend: { display: false },
ย ย ย ย ย ย ย ย title: { display: false }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย });
}

function generarGraficoCalidadDash(datos) {
ย ย if (graficosDashboard.calidad) {
ย ย ย ย graficosDashboard.calidad.destroy();
ย ย }
ย ย const ctx = document.getElementById('graficoCalidadDash').getContext('2d');
ย ย const labels = ['Liberadas', 'Rechazadas'];
ย ย const data = [datos.liberadas, datos.rechazadas];
ย ย graficosDashboard.calidad = new Chart(ctx, {
ย ย ย ย type: 'pie',
ย ย ย ย data: {
ย ย ย ย ย ย labels: labels,
ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย backgroundColor: ['#4caf50', '#f44336']
ย ย ย ย ย ย }]
ย ย ย ย },
ย ย ย ย options: {
ย ย ย ย ย ย responsive: true, maintainAspectRatio: false,
ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย legend: { position: 'top' },
ย ย ย ย ย ย ย ย title: { display: false }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย });
}

function generarGraficoLogisticaDash(tarimasPorHora) {
ย ย if (graficosDashboard.logistica) {
ย ย ย ย graficosDashboard.logistica.destroy();
ย ย }
ย ย const ctx = document.getElementById('graficoLogisticaDash').getContext('2d');
ย ยย
ย ย const horasOrdenadas = Object.keys(tarimasPorHora).sort((a, b) => a - b);
ย ย const labels = horasOrdenadas.map(hora => `${hora}:00 - ${parseInt(hora) + 1}:00`);
ย ย const data = horasOrdenadas.map(hora => tarimasPorHora[hora] || 0);

ย ย graficosDashboard.logistica = new Chart(ctx, {
ย ย ย ย type: 'bar', // Cambiado a grรกfico de barras para mejor visualizaciรณn de conteos
ย ย ย ย data: {
ย ย ย ย ย ย labels: labels,ย
ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย label: 'Tarimas Recolectadas por Hora',
ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย backgroundColor: '#36A2EB',
ย ย ย ย ย ย ย ย borderColor: '#36A2EB',
ย ย ย ย ย ย ย ย borderWidth: 1
ย ย ย ย ย ย }]
ย ย ย ย },
ย ย ย ย options: {
ย ย ย ย ย ย responsive: true,
ย ย ย ย ย ย maintainAspectRatio: false,
ย ย ย ย ย ย scales: {
ย ย ย ย ย ย ย ย y: {
ย ย ย ย ย ย ย ย ย ย beginAtZero: true,
ย ย ย ย ย ย ย ย ย ย title: {
ย ย ย ย ย ย ย ย ย ย ย ย display: true,
ย ย ย ย ย ย ย ย ย ย ย ย text: 'Tarimas Recolectadas' // Nueva etiqueta del eje Y
ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย ticks: {
ย ย ย ย ย ย ย ย ย ย ย ย stepSize: 1 // Asegura que las etiquetas sean nรบmeros enteros
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย x: {
ย ย ย ย ย ย ย ย ย ย title: {
ย ย ย ย ย ย ย ย ย ย ย ย display: true,
ย ย ย ย ย ย ย ย ย ย ย ย text: 'Hora del Dรญa'
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย },
ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย legend: { display: false }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย });
}

// --- !!AQUI EMPIEZAN FUNCIONES DE REPORTE!! ---
ย ยย
ย ยย
ย ย function mostrarReporte(tipo) {
ย ย reporteActual = tipo;
ย ย document.getElementById('selectoresReportes').style.display = 'none';
ย ย const contenedor = document.getElementById('contenedorReporte');
ย ย const { fecha: fechaActual, turno: turnoActual } = obtenerTurnoActual();

ย ย let areaFiltroHtml = '';
ย ย const areas = ['TODAS', 'MULTIPORT', 'DROPS', 'BEDROCK', 'CALIDAD_MULTIPORT', 'CALIDAD_DROPS', 'CALIDAD_BEDROCK'];
ย ย areaFiltroHtml = `
ย ย ย ย <label for="areaFiltro">รrea:</label>
ย ย ย ย <select id="areaFiltro">
ย ย ย ย ย ย ${areas.map(area => `<option value="${area}">${area.replace('CALIDAD_', 'Calidad ')}</option>`).join('')}
ย ย ย ย </select>
ย ย `;

ย ย let empleadoFiltroHtml = '';
ย ย if (tipo === 'calidad') {
ย ย ย ย empleadoFiltroHtml = `
ย ย ย ย ย ย <label for="empleadoFiltro">Empleado:</label>
ย ย ย ย ย ย <input type="text" id="empleadoFiltro" placeholder="Nombre de Empleado">
ย ย ย ย `;
ย ย }

ย ย let fechaFiltroHtml = '';
ย ย fechaFiltroHtml = `
ย ย ย ย <label for="fechaReporte">Fecha:</label>
ย ย ย ย <input type="date" id="fechaReporte" value="${fechaActual}">
ย ย `;

ย ย let turnoFiltroHtml = '';
ย ย turnoFiltroHtml = `
ย ย ย ย <label for="turnoFiltro">Turno:</label>
ย ย ย ย <select id="turnoFiltro">
ย ย ย ย ย ย <option value="todos">Todos</option>
ย ย ย ย ย ย <option value="Turno 1">Turno 1</option>
ย ย ย ย ย ย <option value="Turno 2">Turno 2</option>
ย ย ย ย </select>
ย ย `;

ย ย let exportButtons = `
ย ย ย ย <button class="usuario-btn" onclick="exportarReporte('excel')">Exportar a Excel</button>
ย ย ย ย <button class="usuario-btn" onclick="exportarReporte('pdf')">Exportar a PDF</button>
ย ย ย ย <button class="usuario-btn" onclick="exportarReporte('csv')">Exportar a CSV</button>
ย ย `;

ย ย let graficoSelector = '';
ย ย if (tipo !== 'resumen') {
ย ย ย ย graficoSelector = `
ย ย ย ย ย ย <div class="opciones-grafico">
ย ย ย ย ย ย ย ย <label>Tipo de Grรกfico:</label>
ย ย ย ย ย ย ย ย <select id="tipoGrafico">
ย ย ย ย ย ย ย ย ย ย <option value="bar">Barras</option>
ย ย ย ย ย ย ย ย ย ย <option value="pie">Pastel</option>
ย ย ย ย ย ย ย ย ย ย <option value="line">Lรญnea</option>
ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย </div>
ย ย ย ย `;
ย ย }


ย ย contenedor.innerHTML = `
ย ย ย ย <div class="header-reporte">
ย ย ย ย ย ย <button onclick="regresarASelectores()" class="usuario-btn">Regresar</button>
ย ย ย ย ย ย <div class="filtros">
ย ย ย ย ย ย ย ย ${fechaFiltroHtml}
ย ย ย ย ย ย ย ย ${turnoFiltroHtml}
ย ย ย ย ย ย ย ย ${tipo === 'resumen' ? '' : areaFiltroHtml}
ย ย ย ย ย ย ย ย ${empleadoFiltroHtml}
ย ย ย ย ย ย ย ย <button onclick="buscarReporte()" class="usuario-btn">Buscar</button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <h2 id="tituloReporteDinamico">Cargando...</h2>
ย ย ย ย ${graficoSelector}
ย ย ย ย <div id="contenidoReporte"></div>
ย ย ย ย <div class="botones-reporte">
ย ย ย ย ย ย ${exportButtons}
ย ย ย ย </div>
ย ย `;

ย ย if (document.getElementById('turnoFiltro')) {
ย ย ย ย document.getElementById('turnoFiltro').value = turnoActual;
ย ย }
ย ย if (document.getElementById('areaFiltro')) {
ย ย ย ย document.getElementById('areaFiltro').value = 'TODAS';
ย ย }
ย ยย
ย ย // Listener para el cambio de tipo de grรกfico
ย ย if (document.getElementById('tipoGrafico')) {
ย ย ย ย document.getElementById('tipoGrafico').addEventListener('change', actualizarGraficoReporte);
ย ย }

ย ย const fecha = document.getElementById('fechaReporte').value;
ย ย const turno = document.getElementById('turnoFiltro').value;
ย ย const area = document.getElementById('areaFiltro') ? document.getElementById('areaFiltro').value : null;
ย ย const empleado = document.getElementById('empleadoFiltro') ? document.getElementById('empleadoFiltro').value : null;

ย ย cargarDatosReporte(tipo, fecha, turno, area, empleado);
}

function actualizarGraficoReporte() {
ย ย const tipoGraficoSeleccionado = document.getElementById('tipoGrafico').value;
ย ย const contenedorGrafico = document.querySelector('#grafico-contenedor');
ย ยย
ย ย if (contenedorGrafico) {
ย ย ย ย contenedorGrafico.innerHTML = '<canvas id="graficoDinamico"></canvas>';
ย ย }

ย ย if (datosFiltradosReporte) {
ย ย ย ย let labels, data, chartTitle;
ย ย ย ย if (reporteActual === 'produccion') {
ย ย ย ย ย ย const conteo = {};
ย ย ย ย ย ย datosFiltradosReporte.forEach(log => {
ย ย ย ย ย ย ย ย const area = log.grupo;
ย ย ย ย ย ย ย ย conteo[area] = (conteo[area] || 0) + 1;
ย ย ย ย ย ย });
ย ย ย ย ย ย labels = Object.keys(conteo);
ย ย ย ย ย ย data = Object.values(conteo);
ย ย ย ย ย ย chartTitle = 'Tarimas Producidas por รrea';
ย ย ย ย } else if (reporteActual === 'logistica') {
ย ย ย ย ย ย const conteo = {};
ย ย ย ย ย ย datosFiltradosReporte.forEach(log => {
ย ย ย ย ย ย ย ย const area = log.grupo;
ย ย ย ย ย ย ย ย conteo[area] = (conteo[area] || 0) + 1;
ย ย ย ย ย ย });
ย ย ย ย ย ย labels = Object.keys(conteo);
ย ย ย ย ย ย data = Object.values(conteo);
ย ย ย ย ย ย chartTitle = 'Total de Tarimas Recolectadas por รrea';
ย ย ย ย } else if (reporteActual === 'calidad') {
ย ย ย ย ย ย const conteo = {};
ย ย ย ย ย ย datosFiltradosReporte.forEach(rechazo => {
ย ย ย ย ย ย ย ย const problema = rechazo.problema;
ย ย ย ย ย ย ย ย conteo[problema] = (conteo[problema] || 0) + 1;
ย ย ย ย ย ย });
ย ย ย ย ย ย labels = Object.keys(conteo);
ย ย ย ย ย ย data = Object.values(conteo);
ย ย ย ย ย ย chartTitle = 'Causas de Rechazo';
ย ย ย ย }

ย ย ย ย if (miGrafico) {
ย ย ย ย ย ย miGrafico.destroy();
ย ย ย ย }

ย ย ย ย const ctx = document.getElementById('graficoDinamico').getContext('2d');
ย ย ย ย const backgroundColors = [
ย ย ย ย ย ย '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED',
ย ย ย ย ย ย '#FF6361', '#5DADE2', '#F7DC6F', '#7DCEA0', '#AF7AC5', '#F5B041'
ย ย ย ย ];

ย ย ย ย miGrafico = new Chart(ctx, {
ย ย ย ย ย ย type: tipoGraficoSeleccionado,
ย ย ย ย ย ย data: {
ย ย ย ย ย ย ย ย labels: labels,
ย ย ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย ย ย label: chartTitle,
ย ย ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย ย ย backgroundColor: backgroundColors,
ย ย ย ย ย ย ย ย ย ย borderColor: backgroundColors,
ย ย ย ย ย ย ย ย ย ย borderWidth: 1,
ย ย ย ย ย ย ย ย ย ย fill: tipoGraficoSeleccionado === 'line',
ย ย ย ย ย ย ย ย ย ย tension: 0.4
ย ย ย ย ย ย ย ย }]
ย ย ย ย ย ย },
ย ย ย ย ย ย options: {
ย ย ย ย ย ย ย ย responsive: true,
ย ย ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย ย ย legend: {
ย ย ย ย ย ย ย ย ย ย ย ย position: 'top',
ย ย ย ย ย ย ย ย ย ย ย ย labels: { font: { size: 14 } }
ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย title: {
ย ย ย ย ย ย ย ย ย ย ย ย display: true,
ย ย ย ย ย ย ย ย ย ย ย ย text: chartTitle,
ย ย ย ย ย ย ย ย ย ย ย ย font: { size: 20 }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย scales: {
ย ย ย ย ย ย ย ย ย ย y: {
ย ย ย ย ย ย ย ย ย ย ย ย beginAtZero: true
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย });
ย ย }
}


function regresarASelectores() {
ย ย document.getElementById('tituloReportes').textContent = 'REPORTES';
ย ย document.getElementById('selectoresReportes').style.display = 'flex';
ย ย document.getElementById('contenedorReporte').innerHTML = '<h2>Selecciona un reporte</h2>';
ย ย if (miGrafico) {
ย ย ย ย miGrafico.destroy();
ย ย }
ย ย datosFiltradosReporte = null;
}

function buscarReporte() {
ย ย const tipo = reporteActual;
ย ย const fecha = document.getElementById('fechaReporte').value;
ย ย const turno = document.getElementById('turnoFiltro').value;
ย ย const area = document.getElementById('areaFiltro') ? document.getElementById('areaFiltro').value : null;
ย ย const empleado = document.getElementById('empleadoFiltro') ? document.getElementById('empleadoFiltro').value : null;

ย ย cargarDatosReporte(tipo, fecha, turno, area, empleado);
}


function cargarDatosReporte(tipo, fecha, turno, area, empleado) {
ย ย const contenedor = document.getElementById('contenidoReporte');
ย ย const tituloReporte = document.getElementById('tituloReporteDinamico');
ย ย contenedor.innerHTML = '<p>Cargando datos...</p>';
ย ยย
ย ย if (miGrafico) {
ย ย ย ย miGrafico.destroy();
ย ย }
ย ยย
ย ย const refHistorial = db.ref(`historialLogs`);
ย ย const refCalidad = db.ref(`contadoresCalidad`);
ย ย const refRechazos = db.ref(`rechazosDetallados`);

ย ย Promise.all([
ย ย ย ย refHistorial.once('value').then(s => s.val()),
ย ย ย ย refCalidad.once('value').then(s => s.val()),
ย ย ย ย refRechazos.once('value').then(s => s.val())
ย ย ]).then(([historial, calidad, rechazos]) => {
ย ย ย ย const datosCompletos = { historial, calidad, rechazos };
ย ย ย ยย
ย ย ย ย if (tipo === 'calidad') {
ย ย ย ย ย ย tituloReporte.textContent = `Reporte de Calidad - ${fecha}`;
ย ย ย ย ย ย procesarReporteCalidad(datosCompletos, contenedor, fecha, turno, area, empleado);
ย ย ย ย } else if (tipo === 'produccion') {
ย ย ย ย ย ย tituloReporte.textContent = `Reporte de Producciรณn - ${fecha}`;
ย ย ย ย ย ย procesarReporteProduccion(datosCompletos, contenedor, fecha, turno, area);
ย ย ย ย } else if (tipo === 'logistica') {
ย ย ย ย ย ย tituloReporte.textContent = `Reporte de Logรญstica - ${fecha}`;
ย ย ย ย ย ย procesarReporteLogistica(datosCompletos, contenedor, fecha, turno, area);
ย ย ย ย } else if (tipo === 'resumen') {
ย ย ย ย ย ย tituloReporte.textContent = `Resumen Ejecutivo`;
ย ย ย ย ย ย procesarReporteResumen(datosCompletos, contenedor, fecha, turno);
ย ย ย ย }
ย ย }).catch(error => {
ย ย ย ย console.error("Error al cargar los datos:", error);
ย ย ย ย contenedor.innerHTML = `<p>Error al cargar los datos. Intenta de nuevo.</p>`;
ย ย });
}


function procesarReporteCalidad(datos, contenedor, fecha, turno, area, empleado) {
ย ย let rechazosFiltrados = [];
ย ยย
ย ย for (const fechaKey in datos.rechazos) {
ย ย ย ย if (fecha !== fechaKey) continue;
ย ย ย ยย
ย ย ย ย for (const turnoKey in datos.rechazos[fechaKey]) {
ย ย ย ย ย ย if (turno !== 'todos' && turnoKey !== turno) continue;
ย ย ย ย ย ยย
ย ย ย ย ย ย for (const rechazoKey in datos.rechazos[fechaKey][turnoKey]) {
ย ย ย ย ย ย ย ย const rechazo = datos.rechazos[fechaKey][turnoKey][rechazoKey];
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (
ย ย ย ย ย ย ย ย ย ย (area === 'TODAS' || rechazo.areaRechazo === area) &&
ย ย ย ย ย ย ย ย ย ย (!empleado || (rechazo.empleado && rechazo.empleado.toLowerCase().includes(empleado.toLowerCase())))
ย ย ย ย ย ย ย ย ) {
ย ย ย ย ย ย ย ย ย ย rechazosFiltrados.push(rechazo);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }
ย ยย
ย ย datosFiltradosReporte = rechazosFiltrados;

ย ย const conteoProblemas = {};
ย ย rechazosFiltrados.forEach(rechazo => {
ย ย ย ย const problema = rechazo.problema || 'Desconocido';
ย ย ย ย conteoProblemas[problema] = (conteoProblemas[problema] || 0) + 1;
ย ย });

ย ย // KPIs
ย ย const kpisHtml = `
ย ย ย ย <div class="resumen-datos">
ย ย ย ย ย ย <div class="dato">
ย ย ย ย ย ย ย ย <div class="valor">${rechazosFiltrados.length}</div>
ย ย ย ย ย ย ย ย <div class="etiqueta">Tarimas Rechazadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="dato">
ย ย ย ย ย ย ย ย <div class="valor">${Object.keys(conteoProblemas).length}</div>
ย ย ย ย ย ย ย ย <div class="etiqueta">Problemas Identificados</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย `;
ย ยย
ย ย let tablaHtml = `<table><thead><tr><th>Fecha</th><th>Hora</th><th>รrea</th><th>Lรญnea</th><th>Empleado</th><th>No. de Parte</th><th>Descripciรณn de la Parte</th><th>Descripciรณn del Problema</th><th>Causa Raรญz</th><th>Acciรณn Correctiva</th></tr></thead><tbody>`;
ย ย rechazosFiltrados.forEach(r => {
ย ย ย ย const areaRechazoFormateada = r.areaRechazo ? r.areaRechazo.replace('CALIDAD_', '') : 'N/A';
ย ย ย ย tablaHtml += `
ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย <td>${r.fecha}</td>
ย ย ย ย ย ย ย ย <td>${r.hora}</td>
ย ย ย ย ย ย ย ย <td>${areaRechazoFormateada}</td>
ย ย ย ย ย ย ย ย <td>${r.linea || 'N/A'}</td>
ย ย ย ย ย ย ย ย <td>${r.empleado || 'N/A'}</td>
ย ย ย ย ย ย ย ย <td>${r.parte || 'N/A'}</td>
ย ย ย ย ย ย ย ย <td>${r.descripcionParte || 'N/A'}</td>
ย ย ย ย ย ย ย ย <td>${r.problema || 'N/A'}</td>
ย ย ย ย ย ย ย ย <td>${r.causa || 'N/A'}</td>
ย ย ย ย ย ย ย ย <td>${r.accion || 'N/A'}</td>
ย ย ย ย ย ย </tr>
ย ย ย ย `;
ย ย });
ย ย tablaHtml += `</tbody></table>`;

ย ย // Versiรณn para mรณvil
ย ย let tablaMovilHtml = `<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">`;
ย ย rechazosFiltrados.forEach(r => {
ย ย ย ย const areaRechazoFormateada = r.areaRechazo ? r.areaRechazo.replace('CALIDAD_', '') : 'N/A';
ย ย ย ย tablaMovilHtml += `
ย ย ย ย ย ย <div class="fila-dato">
ย ย ย ย ย ย ย ย <span class="etiqueta">Fecha:</span> <span class="valor">${r.fecha}</span><br>
ย ย ย ย ย ย ย ย <span class="etiqueta">Hora:</span> <span class="valor">${r.hora}</span><br>
ย ย ย ย ย ย ย ย <span class="etiqueta">รrea:</span> <span class="valor">${areaRechazoFormateada}</span><br>
ย ย ย ย ย ย ย ย <span class="etiqueta">Lรญnea:</span> <span class="valor">${r.linea || 'N/A'}</span><br>
ย ย ย ย ย ย ย ย <span class="etiqueta">Empleado:</span> <span class="valor">${r.empleado || 'N/A'}</span><br>
ย ย ย ย ย ย ย ย <span class="etiqueta">Problema:</span> <span class="valor">${r.problema || 'N/A'}</span>
ย ย ย ย ย ย </div>
ย ย ย ย `;
ย ย });
ย ย tablaMovilHtml += `</div></div>`;

ย ย let graficoHtml = '';
ย ย if (Object.keys(conteoProblemas).length > 0) {
ย ย ย ย graficoHtml = `<div id="grafico-contenedor" class="grafico-contenedor"><canvas id="graficoDinamico"></canvas></div>`;
ย ย }
ย ยย
ย ย contenedor.innerHTML = kpisHtml + graficoHtml + tablaHtml + tablaMovilHtml;

ย ย if (Object.keys(conteoProblemas).length > 0) {
ย ย ย ย actualizarGraficoReporte();
ย ย }
}


function procesarReporteProduccion(datos, contenedor, fecha, turno, area) {
ย ย let logsProduccion = [];
ย ย const conteo = { MULTIPORT: 0, DROPS: 0, BEDROCK: 0 };
ย ยย
ย ย for (const fechaKey in datos.historial) {
ย ย ย ย if (fecha !== fechaKey) continue;
ย ย ย ยย
ย ย ย ย for (const turnoKey in datos.historial[fechaKey]) {
ย ย ย ย ย ย if (turno !== 'todos' && turnoKey !== turno) continue;

ย ย ย ย ย ย for (const logKey in datos.historial[fechaKey][turnoKey]) {
ย ย ย ย ย ย ย ย const log = datos.historial[fechaKey][turnoKey][logKey];
ย ย ย ย ย ย ย ย if (log.accion === 'encendido' && ['MULTIPORT', 'DROPS', 'BEDROCK'].includes(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย if (area === 'TODAS' || log.grupo === area) {
ย ย ย ย ย ย ย ย ย ย ย ย logsProduccion.push(log);
ย ย ย ย ย ย ย ย ย ย ย ย conteo[log.grupo]++;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }
ย ยย
ย ย datosFiltradosReporte = logsProduccion;

ย ย const kpisHtml = `
ย ย ย ย <div class="resumen-datos">
ย ย ย ย ย ย <div class="dato">
ย ย ย ย ย ย ย ย <div class="valor">${logsProduccion.length}</div>
ย ย ย ย ย ย ย ย <div class="etiqueta">Tarimas Confirmadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย `;

ย ย const graficoHtml = `<div id="grafico-contenedor" class="grafico-contenedor"><canvas id="graficoDinamico"></canvas></div>`;

ย ย let tablaHtml = `
ย ย ย ย <table>
ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย <th>Lรญnea</th>
ย ย ย ย ย ย ย ย ย ย <th>Tarima</th>
ย ย ย ย ย ย ย ย ย ย <th>Hora de Confirmaciรณn</th>
ย ย ย ย ย ย ย ย ย ย <th>Usuario</th>
ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย </thead>
ย ย ย ย ย ย <tbody>
ย ย `;
ย ย logsProduccion.forEach(log => {
ย ย ย ย tablaHtml += `
ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย <td>${log.grupo}</td>
ย ย ย ย ย ย ย ย <td>${log.led}</td>
ย ย ย ย ย ย ย ย <td>${formatoHora(log.timestamp)}</td>
ย ย ย ย ย ย ย ย <td>${log.usuario}</td>
ย ย ย ย ย ย </tr>
ย ย ย ย `;
ย ย });
ย ย tablaHtml += `</tbody></table>`;
ย ยย
ย ย let tablaMovilHtml = `<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">`;
ย ย logsProduccion.forEach(log => {
ย ย ย ย tablaMovilHtml += `
ย ย ย ย ย ย <div class="fila-dato">
ย ย ย ย ย ย ย ย <span class="etiqueta">Lรญnea:</span> <span class="valor">${log.grupo}</span><br>
ย ย ย ย ย ย ย ย <span class="etiqueta">Tarima:</span> <span class="valor">${log.led}</span><br>
ย ย ย ย ย ย ย ย <span class="etiqueta">Hora:</span> <span class="valor">${formatoHora(log.timestamp)}</span><br>
ย ย ย ย ย ย ย ย <span class="etiqueta">Usuario:</span> <span class="valor">${log.usuario}</span>
ย ย ย ย ย ย </div>
ย ย ย ย `;
ย ย });
ย ย tablaMovilHtml += `</div></div>`;

ย ย contenedor.innerHTML = kpisHtml + graficoHtml + tablaHtml + tablaMovilHtml;
ย ย actualizarGraficoReporte();
}


function procesarReporteLogistica(datos, contenedor, fecha, turno, area) {
ย ย let logsRecoleccion = [];
ย ย let tiempoTotal = 0;
ย ยย
ย ย for (const fechaKey in datos.historial) {
ย ย ย ย if (fecha !== fechaKey) continue;
ย ย ย ยย
ย ย ย ย for (const turnoKey in datos.historial[fechaKey]) {
ย ย ย ย ย ย if (turno !== 'todos' && turnoKey !== turno) continue;
ย ย ย ย ย ยย
ย ย ย ย ย ย for (const logKey in datos.historial[fechaKey][turnoKey]) {
ย ย ย ย ย ย ย ย const log = datos.historial[fechaKey][turnoKey][logKey];
ย ย ย ย ย ย ย ย if (log.accion === 'apagado' && log.tiempoRecoleccion && ['MULTIPORT', 'DROPS', 'BEDROCK'].includes(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย if (area === 'TODAS' || log.grupo === area) {
ย ย ย ย ย ย ย ย ย ย ย ย logsRecoleccion.push(log);
ย ย ย ย ย ย ย ย ย ย ย ย tiempoTotal += log.tiempoRecoleccion;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }

ย ย datosFiltradosReporte = logsRecoleccion;
ย ยย
ย ย const tiempoPromedio = logsRecoleccion.length > 0 ? (tiempoTotal / logsRecoleccion.length).toFixed(1) : 0;
ย ยย
ย ย const conteoTarimasPorArea = {};
ย ย logsRecoleccion.forEach(log => {
ย ย ย ย const area = log.grupo;
ย ย ย ย conteoTarimasPorArea[area] = (conteoTarimasPorArea[area] || 0) + 1;
ย ย });

ย ย const kpisHtml = `
ย ย ย ย <div class="resumen-datos">
ย ย ย ย ย ย <div class="dato">
ย ย ย ย ย ย ย ย <div class="valor">${logsRecoleccion.length}</div>
ย ย ย ย ย ย ย ย <div class="etiqueta">Tarimas Recolectadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="dato">
ย ย ย ย ย ย ย ย <div class="valor">${tiempoPromedio} min</div>
ย ย ย ย ย ย ย ย <div class="etiqueta">Tiempo Promedio</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย `;

ย ย const graficoHtml = `<div id="grafico-contenedor" class="grafico-contenedor"><canvas id="graficoDinamico"></canvas></div>`;

ย ย let tablaHtml = `
ย ย ย ย <table>
ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย <th>Lรญnea</th>
ย ย ย ย ย ย ย ย ย ย <th>Tarima</th>
ย ย ย ย ย ย ย ย ย ย <th>Tiempo de Recolecciรณn (min)</th>
ย ย ย ย ย ย ย ย ย ย <th>Hora de Encendido</th>
ย ย ย ย ย ย ย ย ย ย <th>Hora de Apagado</th>
ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย </thead>
ย ย ย ย ย ย <tbody>
ย ย `;
ย ย logsRecoleccion.forEach(log => {
ย ย ย ย tablaHtml += `
ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย <td>${log.grupo}</td>
ย ย ย ย ย ย ย ย <td>${log.led}</td>
ย ย ย ย ย ย ย ย <td>${log.tiempoRecoleccion}</td>
ย ย ย ย ย ย ย ย <td>${formatoHora(log.horaEncendido)}</td>
ย ย ย ย ย ย ย ย <td>${formatoHora(log.horaApagado)}</td>
ย ย ย ย ย ย </tr>
ย ย ย ย `;
ย ย });
ย ย tablaHtml += `</tbody></table>`;
ย ยย
ย ย let tablaMovilHtml = `<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">`;
ย ย logsRecoleccion.forEach(log => {
ย ย ย ย tablaMovilHtml += `
ย ย ย ย ย ย <div class="fila-dato">
ย ย ย ย ย ย ย ย <span class="etiqueta">Lรญnea:</span> <span class="valor">${log.grupo}</span><br>
ย ย ย ย ย ย ย ย <span class="etiqueta">Tarima:</span> <span class="valor">${log.led}</span><br>
ย ย ย ย ย ย ย ย <span class="etiqueta">Tiempo:</span> <span class="valor">${log.tiempoRecoleccion} min</span><br>
ย ย ย ย ย ย ย ย <span class="etiqueta">Hora de Recolecciรณn:</span> <span class="valor">${formatoHora(log.horaApagado)}</span>
ย ย ย ย ย ย </div>
ย ย ย ย `;
ย ย });
ย ย tablaMovilHtml += `</div></div>`;

ย ย contenedor.innerHTML = kpisHtml + graficoHtml + tablaHtml + tablaMovilHtml;
ย ย document.getElementById('tipoGrafico').value = 'bar'; // Establecer por defecto a barras
ย ย actualizarGraficoReporte();
}

function procesarReporteResumen(datos, contenedor, fecha, turno) {
ย ย const areas = ['MULTIPORT', 'DROPS', 'BEDROCK'];
ย ย const resumen = {};
ย ยย
ย ย areas.forEach(area => {
ย ย ย ย resumen[area] = {
ย ย ย ย ย ย produccion: 0,
ย ย ย ย ย ย liberadas: 0,
ย ย ย ย ย ย rechazadas: 0,
ย ย ย ย ย ย tiempoLogistica: { total: 0, count: 0, promedio: 0 }
ย ย ย ย };
ย ย });

ย ย // Procesar historial (producciรณn y logรญstica)
ย ย for (const fechaKey in datos.historial) {
ย ย ย ย if (fechaKey !== fecha && fecha !== null) continue; // Si se elige una fecha, procesar solo esa
ย ย ย ย for (const turnoKey in datos.historial[fechaKey]) {
ย ย ย ย ย ย if (turnoKey !== turno && turno !== 'todos') continue; // Si se elige un turno, procesar solo ese
ย ย ย ย ย ย for (const logKey in datos.historial[fechaKey][turnoKey]) {
ย ย ย ย ย ย ย ย const log = datos.historial[fechaKey][turnoKey][logKey];
ย ย ย ย ย ย ย ย if (log.accion === 'encendido' && resumen.hasOwnProperty(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย resumen[log.grupo].produccion++;
ย ย ย ย ย ย ย ย } else if (log.accion === 'apagado' && log.tiempoRecoleccion && resumen.hasOwnProperty(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย resumen[log.grupo].tiempoLogistica.total += log.tiempoRecoleccion;
ย ย ย ย ย ย ย ย ย ย resumen[log.grupo].tiempoLogistica.count++;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }

ย ย // Procesar contadores de calidad
ย ย for (const fechaKey in datos.calidad) {
ย ย ย ย if (fechaKey !== fecha && fecha !== null) continue;
ย ย ย ย for (const turnoKey in datos.calidad[fechaKey]) {
ย ย ย ย ย ย if (turnoKey !== turno && turno !== 'todos') continue;
ย ย ย ย ย ย for (const grupoKey in datos.calidad[fechaKey][turnoKey]) {
ย ย ย ย ย ย ย ย const grupoBase = grupoKey.replace('CALIDAD_', '');
ย ย ย ย ย ย ย ย if (resumen.hasOwnProperty(grupoBase)) {
ย ย ย ย ย ย ย ย ย ย const contadores = datos.calidad[fechaKey][turnoKey][grupoKey];
ย ย ย ย ย ย ย ย ย ย resumen[grupoBase].liberadas += contadores.liberadas || 0;
ย ย ย ย ย ย ย ย ย ย resumen[grupoBase].rechazadas += contadores.rechazadas || 0;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }

ย ย let html = ``;
ย ย areas.forEach(area => {
ย ย ย ย const prod = resumen[area].produccion;
ย ย ย ย const liberadas = resumen[area].liberadas;
ย ย ย ย const rechazadas = resumen[area].rechazadas;
ย ย ย ย const totalCalidad = liberadas + rechazadas;
ย ย ย ย const tasaRechazo = totalCalidad > 0 ? ((rechazadas / totalCalidad) * 100).toFixed(1) : 0;
ย ย ย ย const tiempoPromedio = resumen[area].tiempoLogistica.count > 0 ? (resumen[area].tiempoLogistica.total / resumen[area].tiempoLogistica.count).toFixed(1) : 0;

ย ย ย ย html += `
ย ย ย ย ย ย <h3>${area}</h3>
ย ย ย ย ย ย <div class="resumen-datos">
ย ย ย ย ย ย ย ย <div class="dato">
ย ย ย ย ย ย ย ย ย ย <div class="valor">${prod}</div>
ย ย ย ย ย ย ย ย ย ย <div class="etiqueta">Tarimas Producidas</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="dato">
ย ย ย ย ย ย ย ย ย ย <div class="valor">${liberadas}</div>
ย ย ย ย ย ย ย ย ย ย <div class="etiqueta">Tarimas Liberadas</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="dato">
ย ย ย ย ย ย ย ย ย ย <div class="valor">${rechazadas}</div>
ย ย ย ย ย ย ย ย ย ย <div class="etiqueta">Tarimas Rechazadas</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="dato">
ย ย ย ย ย ย ย ย ย ย <div class="valor">${tasaRechazo}%</div>
ย ย ย ย ย ย ย ย ย ย <div class="etiqueta">Tasa de Rechazo</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="dato">
ย ย ย ย ย ย ย ย ย ย <div class="valor">${tiempoPromedio} min</div>
ย ย ย ย ย ย ย ย ย ย <div class="etiqueta">Tiempo Recolecciรณn</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย `;
ย ย });
ย ย contenedor.innerHTML = html;
}

function generarGraficoRechazos(datos) {
ย ย const ctx = document.getElementById('graficoRechazos').getContext('2d');
ย ย const labels = Object.keys(datos);
ย ย const data = Object.values(datos);
ย ยย
ย ย const backgroundColors = [
ย ย ย ย '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED',
ย ย ย ย '#FF6361', '#5DADE2', '#F7DC6F', '#7DCEA0', '#AF7AC5', '#F5B041'
ย ย ];
ย ยย
ย ย if (miGrafico) {
ย ย ย ย miGrafico.destroy();
ย ย }
ย ยย
ย ย miGrafico = new Chart(ctx, {
ย ย ย ย type: 'pie',
ย ย ย ย data: {
ย ย ย ย ย ย labels: labels,
ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย backgroundColor: backgroundColors,
ย ย ย ย ย ย ย ย hoverBackgroundColor: backgroundColors
ย ย ย ย ย ย }]
ย ย ย ย },
ย ย ย ย options: {
ย ย ย ย ย ย responsive: true,
ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย legend: {
ย ย ย ย ย ย ย ย ย ย position: 'top',
ย ย ย ย ย ย ย ย ย ย labels: {
ย ย ย ย ย ย ย ย ย ย ย ย font: { size: 14 }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย title: {
ย ย ย ย ย ย ย ย ย ย display: true,
ย ย ย ย ย ย ย ย ย ย text: 'Causas de Rechazo',
ย ย ย ย ย ย ย ย ย ย font: { size: 20 }
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย tooltip: {
ย ย ย ย ย ย ย ย ย ย callbacks: {
ย ย ย ย ย ย ย ย ย ย ย ย label: (context) => {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const label = context.label || '';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const value = context.raw;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const percentage = ((value / total) * 100).toFixed(1);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย return `${label}: ${value} (${percentage}%)`;
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย });
}

function generarGraficoProduccion(datos) {
ย ย const ctx = document.getElementById('graficoProduccion').getContext('2d');
ย ย const labels = Object.keys(datos);
ย ย const data = Object.values(datos);

ย ย if (miGrafico) {
ย ย ย ย miGrafico.destroy();
ย ย }

ย ย miGrafico = new Chart(ctx, {
ย ย ย ย type: 'bar',
ย ย ย ย data: {
ย ย ย ย ย ย labels: labels,
ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย label: 'Tarimas Confirmadas',
ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย backgroundColor: [
ย ย ย ย ย ย ย ย ย ย '#4BC0C0',
ย ย ย ย ย ย ย ย ย ย '#36A2EB',
ย ย ย ย ย ย ย ย ย ย '#FFCE56'
ย ย ย ย ย ย ย ย ],
ย ย ย ย ย ย ย ย borderColor: [
ย ย ย ย ย ย ย ย ย ย '#4BC0C0',
ย ย ย ย ย ย ย ย ย ย '#36A2EB',
ย ย ย ย ย ย ย ย ย ย '#FFCE56'
ย ย ย ย ย ย ย ย ],
ย ย ย ย ย ย ย ย borderWidth: 1
ย ย ย ย ย ย }]
ย ย ย ย },
ย ย ย ย options: {
ย ย ย ย ย ย responsive: true,
ย ย ย ย ย ย scales: {
ย ย ย ย ย ย ย ย y: {
ย ย ย ย ย ย ย ย ย ย beginAtZero: true,
ย ย ย ย ย ย ย ย ย ย title: {
ย ย ย ย ย ย ย ย ย ย ย ย display: true,
ย ย ย ย ย ย ย ย ย ย ย ย text: 'Cantidad de Tarimas'
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย },
ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย legend: {
ย ย ย ย ย ย ย ย ย ย display: false
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย title: {
ย ย ย ย ย ย ย ย ย ย display: true,
ย ย ย ย ย ย ย ย ย ย text: 'Producciรณn por รrea'
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย });
}


function exportarReporte(formato) {
ย ย const tabla = document.querySelector('#contenidoReporte table');
ย ย const chart = miGrafico;
ย ย const tipo = reporteActual;

ย ย if (!tabla) {
ย ย ย ย alert('No hay datos para exportar. Por favor, genera un reporte primero.');
ย ย ย ย return;
ย ย }

ย ย const nombreArchivo = `${tipo}_${document.getElementById('fechaReporte').value}`;

ย ย if (formato === 'excel') {
ย ย ย ย const data = XLSX.utils.table_to_sheet(tabla);
ย ย ย ย const wb = XLSX.utils.book_new();
ย ย ย ย XLSX.utils.book_append_sheet(wb, data, 'Reporte');
ย ย ย ย XLSX.writeFile(wb, `${nombreArchivo}.xlsx`);
ย ย } else if (formato === 'pdf') {
ย ย ย ย exportarAPdf(tabla, chart, nombreArchivo);
ย ย } else if (formato === 'csv') {
ย ย ย ย exportarACsv(tabla, nombreArchivo);
ย ย }
}

function exportarACsv(tabla, nombreReporte) {
ย ย let csv = [];
ย ย const filas = tabla.querySelectorAll('tr');

ย ย for (const fila of filas) {
ย ย ย ย let filaDatos = [];
ย ย ย ย const celdas = fila.querySelectorAll('th, td');
ย ย ย ย for (const celda of celdas) {
ย ย ย ย ย ย filaDatos.push(`"${celda.textContent.trim().replace(/"/g, '""')}"`); // Escapar comillas dobles
ย ย ย ย }
ย ย ย ย csv.push(filaDatos.join(','));
ย ย }

ย ย const csvFinal = csv.join('\n');
ย ย const blob = new Blob([csvFinal], { type: 'text/csv;charset=utf-8;' });
ย ย const url = URL.createObjectURL(blob);
ย ย const link = document.createElement('a');
ย ย link.setAttribute('href', url);
ย ย link.setAttribute('download', `${nombreReporte}.csv`);
ย ย link.style.visibility = 'hidden';
ย ย document.body.appendChild(link);
ย ย link.click();
ย ย document.body.removeChild(link);
}

function exportarAPdf(tabla, chart, nombreArchivo) {
ย ย const { jsPDF } = window.jspdf;
ย ย const doc = new jsPDF('p', 'pt', 'letter');
ย ย const margin = 20;
ย ย let y = margin;
ย ย let pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
ย ย let pageWidth = doc.internal.pageSize.width || doc.internal.pageSize.getWidth();

ย ย // Tรญtulo del reporte
ย ย doc.setFontSize(22);
ย ย doc.text(`Reporte de ${reporteActual.toUpperCase()}`, pageWidth / 2, y, { align: 'center' });
ย ย y += 30;

ย ย // Agregar la fecha
ย ย doc.setFontSize(12);
ย ย doc.text(`Fecha: ${document.getElementById('fechaReporte').value}`, margin, y);
ย ย y += 20;

ย ย // Agregar resumen si existe
ย ย const resumenDiv = document.querySelector('#contenidoReporte .resumen-datos');
ย ย if (resumenDiv) {
ย ย ย ย const resumenText = Array.from(resumenDiv.children).map(dato => {
ย ย ย ย ย ย const etiqueta = dato.querySelector('.etiqueta').textContent;
ย ย ย ย ย ย const valor = dato.querySelector('.valor').textContent;
ย ย ย ย ย ย return `${etiqueta}: ${valor}`;
ย ย ย ย }).join('ย |ย ');
ย ย ย ย doc.text(resumenText, margin, y);
ย ย ย ย y += 30;
ย ย }

ย ย // Agregar grรกfica como imagen
ย ย if (chart) {
ย ย ย ย const chartDataURL = chart.toBase64Image();
ย ย ย ย const imgWidth = 500;
ย ย ย ย const imgHeight = 250;
ย ย ย ย const imgX = (pageWidth - imgWidth) / 2;

ย ย ย ย if (y + imgHeight + 30 > pageHeight) {
ย ย ย ย ย ย doc.addPage();
ย ย ย ย ย ย y = margin;
ย ย ย ย }

ย ย ย ย doc.addImage(chartDataURL, 'PNG', imgX, y, imgWidth, imgHeight);
ย ย ย ย y += imgHeight + 30;
ย ย }

ย ย // Agregar tabla
ย ย const tableHeaders = Array.from(tabla.querySelectorAll('thead th')).map(th => th.textContent.trim());
ย ย const tableData = Array.from(tabla.querySelectorAll('tbody tr')).map(tr =>
ย ย ย ย Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim())
ย ย );

ย ย const startY = y;
ย ย doc.autoTable({
ย ย ย ย startY: startY,
ย ย ย ย head: [tableHeaders],
ย ย ย ย body: tableData,
ย ย ย ย theme: 'striped',
ย ย ย ย styles: { fontSize: 8, cellPadding: 5 },
ย ย ย ย columnStyles: {
ย ย ย ย ย ย 0: { cellWidth: 50 },
ย ย ย ย ย ย 1: { cellWidth: 50 },
ย ย ย ย ย ย 2: { cellWidth: 50 },
ย ย ย ย ย ย 3: { cellWidth: 60 },
ย ย ย ย ย ย 4: { cellWidth: 60 },
ย ย ย ย ย ย 5: { cellWidth: 70 },
ย ย ย ย ย ย 6: { cellWidth: 70 },
ย ย ย ย ย ย 7: { cellWidth: 70 },
ย ย ย ย ย ย 8: { cellWidth: 70 },
ย ย ย ย ย ย 9: { cellWidth: 70 },
ย ย ย ย },
ย ย ย ย margin: { top: y, left: margin, right: margin, bottom: margin }
ย ย });

ย ย doc.save(`${nombreArchivo}.pdf`);
}

// ================= ARRANQUE Y MANEJO DE MODALES =================
window.addEventListener('load', ()=>{
ย ย firebase.auth().signInAnonymously().catch(err => {
ย ย ย ย console.error('Auth error:', err);
ย ย });
ย ยย
ย ย firebase.auth().onAuthStateChanged(user => {
ย ย ย ย if (user) {
ย ย ย ย ย ย iniciarListenersFirebase();ย
ย ย ย ย ย ย activarPantalla('pantalla1');
ย ย ย ย } else {
ย ย ย ย ย ย // Manejar el caso de no autenticaciรณn si es necesario
ย ย ย ย }
ย ย });
ย ยย
ย ย const modalCalidad = document.getElementById('modalCalidad');
ย ย modalCalidad.querySelector('.cerrar-btn').addEventListener('click', () => {
ย ย ย ย modalCalidad.classList.remove('visible');
ย ย });

ย ย modalCalidad.querySelectorAll('.opcion-btn').forEach(btn => {
ย ย ย ย btn.addEventListener('click', () => {
ย ย ย ย ย ย const nuevoColor = btn.dataset.color;
ย ย ย ย ย ย if (nuevoColor === 'rojo') {
ย ย ย ย ย ย ย ย mostrarFormularioRechazo();
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย aplicarEstadoCalidad(nuevoColor);
ย ย ย ย ย ย ย ย modalCalidad.classList.remove('visible');
ย ย ย ย ย ย }
ย ย ย ย });
ย ย });

ย ย const modalRechazo = document.getElementById('modalRechazo');
ย ย modalRechazo.querySelector('#formularioRechazo').addEventListener('submit', (e) => {
ย ย ย ย e.preventDefault();
ย ย ย ยย
ย ย ย ย const formulario = e.target;
ย ย ย ย const datos = {
ย ย ย ย ย ย empleado: formulario.empleado.value,
ย ย ย ย ย ย linea: formulario.linea.value,
ย ย ย ย ย ย parte: formulario.parte.value,
ย ย ย ย ย ย descripcionParte: formulario.descripcionParte.value,
ย ย ย ย ย ย problema: formulario.problema.value,
ย ย ย ย ย ย causa: formulario.causa.value,
ย ย ย ย ย ย accion: formulario.accion.value,
ย ย ย ย };
ย ย ย ยย
ย ย ย ย guardarRechazo(datos);
ย ย ย ย formulario.reset();
ย ย });

ย ย const selectoresReportes = document.getElementById('selectoresReportes');
ย ย selectoresReportes.querySelectorAll('.usuario-btn').forEach(btn => {
ย ย ย ย btn.addEventListener('click', () => {
ย ย ย ย ย ย const tipoReporte = btn.dataset.reporte;
ย ย ย ย ย ย mostrarReporte(tipoReporte);
ย ย ย ย });
ย ย });

ย ย if ('serviceWorker' in navigator) {
ย ย ย ย navigator.serviceWorker.register('./sw.js')
ย ย ย ย ย ย .then(reg => {
ย ย ย ย ย ย ย ย console.log("โ Service Worker registrado:", reg);
ย ย ย ย ย ย })
ย ย ย ย ย ย .catch(err => {
ย ย ย ย ย ย ย ย console.error("โ Error al registrar Service Worker:", err);
ย ย ย ย ย ย });
ย ย }
});
</script>
</body>
</html>
