<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Log√≠stica</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --btn-bg: #0066cc;
  --btn-bg-hover: #004c99;
  --grid-size: 26px;
  --vignette: rgba(0,0,0,0.9);
  --titulo-size: clamp(42px,7vw,96px);
  --led-size: 50px;
  --led-gap: 16px;
  --led-off-core: #111;
  --led-off-edge: #000;
  --led-on-core: #0f0;
  --led-on-edge: #063;
  --glow: #00ff88;
  --blink-duration: 0.9s;
}

*{ box-sizing: border-box; }
html, body{ height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:#111; }
body{ overflow-y: auto; }

.pantalla{ display:none; width:100%; min-height:100vh; }
.pantalla.activa{ display:flex; flex-direction:column; }

#pantalla1{
    align-items:center;
    justify-content:center;
    flex-direction: column;
    background:linear-gradient(135deg,#222,#444);
    gap:18px;
}
.btn-contenedor{
    display:flex;
    flex-direction:column;
    align-items:center;
}

#pantalla1 h1{ margin:0 0 8px; }
.usuario-btn{
  background: var(--btn-bg);
  color:#fff;
  border:0;
  padding:14px 28px;
  margin:8px;
  border-radius:10px;
  font-size:18px;
  cursor:pointer;
  transition: background .25s ease;
  outline-color: #000;
}
.usuario-btn:hover{ background: var(--btn-bg-hover); }

#pantalla2{
  background-color:#000;
  background-image:
    radial-gradient(circle, rgba(60,60,60,.28) 20%, transparent 21%),
    radial-gradient(circle, #101010 20%, transparent 21%);
  background-size: var(--grid-size) var(--grid-size);
  box-shadow: inset 0 0 90px var(--vignette);
}
.header{ display:flex; align-items:center; justify-content:center; padding:16px 20px 6px; position: relative; }
#tituloFijo{
  font-weight:800;
  text-align:center;
  letter-spacing:.5px;
  text-shadow:0 2px 8px rgba(0,0,0,.65);
  font-size:var(--titulo-size);
}
#turnoActual {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 1.2rem;
    font-weight: bold;
    background-color: rgba(0,0,0,0.5);
    padding: 5px 10px;
    border-radius: 5px;
}
.zona-centro{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px 24px 28px;
  flex-direction: column;
}
.grupo-contenedor{
  display: flex;
  flex-wrap: wrap;
  gap: clamp(24px, 4vw, 64px);
  width: min(1200px, 96vw);
  justify-content: center;
}

.grupo.oculto {
  display: none;
}
.grupo{ display:flex; flex-direction:column; align-items:center; text-align:center; }
.grupo .nombre{ font-size: clamp(20px,2.2vw,28px); font-weight:800; margin-bottom:8px; letter-spacing:.5px; text-shadow:0 1px 6px rgba(0,0,0,.5); }
.grupo .tarimas{ font-size: clamp(16px,1.7vw,22px); opacity:.9; margin-bottom:14px; }
.leds{ display:flex; gap: var(--led-gap); justify-content:center; align-items:center; flex-wrap:nowrap; padding:4px; }
.led{
  width: var(--led-size);
  height: var(--led-size);
  border-radius:50%;
  cursor:pointer;
  background: radial-gradient(circle at 45% 40%, var(--led-off-core) 40%, var(--led-off-edge) 100%);
  box-shadow: inset -4px -5px 8px rgba(0,0,0,.8), inset 4px 5px 6px rgba(255,255,255,.06), 0 1px 0 rgba(255,255,255,.05);
  transition: transform .1s ease, filter .2s ease, box-shadow .2s ease;
}
.led:active{ transform: scale(.96); }
.led.on{
  background: radial-gradient(circle at 48% 45%, var(--led-on-core) 40%, var(--led-on-edge) 100%);
  box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  animation: blink var(--blink-duration) ease-in-out infinite;
}

.resumen-turno {
  display: flex;
  justify-content: center;
  gap: 40px;
  margin-bottom: 20px;
  background-color: #222;
  border-radius: 12px;
  padding: 15px 30px;
  box-shadow: 0 4px 10px rgba(0,0,0,.3);
  width: min(800px, 90vw);
}

.resumen-turno.oculto {
  display: none;
}

.dato-resumen {
  text-align: center;
}

.dato-resumen .etiqueta {
  font-size: 14px;
  opacity: 0.7;
  text-transform: uppercase;
  margin-bottom: 4px;
}

.dato-resumen .valor {
  font-size: 32px;
  font-weight: bold;
  letter-spacing: 1px;
}
.tiempos{
    margin-top: 10px;
    font-size: 14px;
    opacity: 0.8;
    text-align: left;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
}
.btn-rojo{
    background: #cc0000;
    outline-color: #000;
}
.btn-rojo:hover{
    background: #990000;
}
.footer{
    width: 100%;
    display: flex;
    justify-content: center;
    padding: 20px;
}
.footer .usuario-btn{
    padding: 10px 20px;
    font-size: 16px;
}
.contadores-calidad {
    display: flex;
    gap: 20px;
    justify-content: center;
    margin-top: 10px;
}
.contador-calidad {
    text-align: center;
    font-size: 14px;
    font-weight: bold;
}
.contador-calidad .valor {
    font-size: 20px;
    font-weight: bold;
}
.contador-calidad .etiqueta {
    font-size: 12px;
    opacity: 0.8;
}

@media(max-width:720px){ 
  .grupo-contenedor{ 
    display: flex;
    flex-direction: column;
    gap: 24px;
    width: 100%;
  }
}
@keyframes blink {
    0%, 100% {
        box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
    }
    50% {
        box-shadow: 0 0 40px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
    }
}
/* ================= CSS DEL MODAL DE CALIDAD ================= */
.modal-calidad {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    visibility: hidden; /* Oculto por defecto */
    opacity: 0; /* Oculto por defecto */
    transition: opacity 0.3s ease;
}
.modal-calidad.visible {
    visibility: visible;
    opacity: 1;
}
.modal-content {
    background-color: #222;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    max-width: 90%;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
}
.modal-content h3 {
    margin-top: 0;
    font-size: 24px;
    margin-bottom: 20px;
}
.opciones {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}
.opcion-btn {
    padding: 15px 25px;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
.opcion-btn[data-color="naranja"] { background-color: #ff9800; color: #fff; }
.opcion-btn[data-color="rojo"] { background-color: #f44336; color: #fff; }
.opcion-btn[data-color="verde"] { background-color: #4caf50; color: #fff; }
.opcion-btn:hover {
    filter: brightness(1.2);
}
.cerrar-btn {
    background-color: #555;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}
.cerrar-btn:hover {
    background-color: #777;
}
/* Nuevo CSS para el formulario de rechazo */
#modalRechazo .modal-content {
    text-align: left;
}
#modalRechazo .modal-content h3 {
    text-align: center;
    margin-bottom: 30px;
}
#modalRechazo form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
#modalRechazo label {
    font-size: 16px;
    margin-bottom: 5px;
    display: block;
}
#modalRechazo input, #modalRechazo textarea {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #555;
    background-color: #333;
    color: #fff;
    font-size: 16px;
}
#modalRechazo textarea {
    resize: vertical;
    min-height: 80px;
}
#modalRechazo button[type="submit"] {
    margin-top: 20px;
    background-color: var(--btn-bg);
    color: #fff;
    border: none;
    padding: 15px;
    border-radius: 8px;
    font-size: 18px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
#modalRechazo button[type="submit"]:hover {
    background-color: var(--btn-bg-hover);
}
.led.naranja {
    background: radial-gradient(circle at 48% 45%, #ff9800 40%, #c17500 100%);
    box-shadow: 0 0 22px #ff9800, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.rojo {
    background: radial-gradient(circle at 48% 45%, #f44336 40%, #d32f2f 100%);
    box-shadow: 0 0 22px #f44336, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.verde {
    background: radial-gradient(circle at 48% 45%, #4caf50 40%, #388e3c 100%);
    box-shadow: 0 0 22px #4caf50, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}

/* ================= CSS PARA PANTALLA 3 (REPORTES) ================= */
#pantalla3 {
    background-color: #f5f5f5;
    color: #333;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
#pantalla3 h1 {
    font-size: 2.5rem;
    color: #0066cc;
    margin-bottom: 20px;
}
#pantalla3 .btn-contenedor {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    width: 100%;
    max-width: 800px;
}
#pantalla3 .usuario-btn {
    background-color: #0066cc;
    color: #fff;
    font-size: 1.2rem;
    padding: 15px 30px;
    border-radius: 10px;
    cursor: pointer;
    border: none;
    transition: background-color 0.3s ease;
}
#pantalla3 .usuario-btn:hover {
    background-color: #004c99;
}
#pantalla3 .contenedor-reportes {
    background-color: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 1200px;
    margin-top: 20px;
}
#pantalla3 .header-reporte {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: space-between;
    margin-bottom: 20px;
}
#pantalla3 .header-reporte h2 {
    color: #0066cc;
    margin: 0;
}
#pantalla3 .header-reporte .filtros {
    display: flex;
    gap: 10px;
    align-items: center;
}
#pantalla3 .header-reporte .filtros label {
    font-size: 14px;
}
#pantalla3 .header-reporte .filtros input[type="date"],
#pantalla3 .header-reporte .filtros select {
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 14px;
}
#pantalla3 table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
#pantalla3 th, #pantalla3 td {
    border: 1px solid #ccc;
    padding: 12px;
    text-align: left;
    font-size: 14px;
}
#pantalla3 thead {
    background-color: #0066cc;
    color: #fff;
}
#pantalla3 tbody tr:nth-child(even) {
    background-color: #f2f2f2;
}
#pantalla3 tbody tr:hover {
    background-color: #ddd;
}
#pantalla3 .resumen-datos {
    display: flex;
    gap: 30px;
    flex-wrap: wrap;
    justify-content: space-around;
    margin-bottom: 20px;
}
#pantalla3 .dato {
    background-color: #f2f2f2;
    padding: 15px;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
}
#pantalla3 .dato .valor {
    font-size: 24px;
    color: #0066cc;
}
#pantalla3 .dato .etiqueta {
    font-size: 12px;
    text-transform: uppercase;
    color: #666;
}
.botones-reporte {
    margin-top: 20px;
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}
.grafico-contenedor {
    width: 100%;
    max-width: 600px;
    margin: 20px auto;
}
</style>
</head>

<body>

<section id="pantalla1" class="pantalla activa">
  <h1>Selecciona tu usuario</h1>
<div class="btn-contenedor">
    <button class="usuario-btn" onclick="seleccionarUsuario('LOG√çSTICA')">LOG√çSTICA</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('MULTIPORT')">MULTIPORT</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('DROPS')">DROPS</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('BEDROCK')">BEDROCK</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('SUPERVISOR')">SUPERVISOR</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('CALIDAD')">CALIDAD</button> 
    <button class="usuario-btn" onclick="seleccionarReporte()">REPORTES</button>
</div>
</section>

<section id="pantalla2" class="pantalla">
  <header class="header">
    <div id="tituloFijo">LOG√çSTICA</div>
    <div id="turnoActual"></div>
  </header>
  <div class="zona-centro">
      <div id="resumenTurno" class="resumen-turno oculto">
  <div class="dato-resumen">
    <div class="etiqueta">Tarimas Totales</div>
    <div id="tarimasTotales" class="valor">0</div>
  </div>
  <div class="dato-resumen">
    <div class="etiqueta">Tiempo Promedio</div>
    <div id="tiempoPromedio" class="valor">0 min</div>
  </div>
</div>
<div class="grupo-contenedor">
    <div class="grupo" data-grupo="MULTIPORT">
        <div class="nombre">MULTIPORT</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="MULTIPORT" data-linea="linea1"></div>
        <div class="leds" data-grupo="MULTIPORT" data-linea="linea2"></div>
        <div class="tiempos" data-grupo="MULTIPORT"></div>
    </div>

    <div class="grupo" data-grupo="DROPS">
        <div class="nombre">DROPS</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="DROPS" data-linea="linea1"></div>
        <div class="leds" data-grupo="DROPS" data-linea="linea2"></div>
        <div class="tiempos" data-grupo="DROPS"></div>
    </div>

    <div class="grupo" data-grupo="BEDROCK">
        <div class="nombre">BEDROCK</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="BEDROCK" data-linea="linea1"></div>
        <div class="leds" data-grupo="BEDROCK" data-linea="linea2"></div>
        <div class="tiempos" data-grupo="BEDROCK"></div>
    </div>

    <div class="grupo" data-grupo="CALIDAD_MULTIPORT">
        <div class="nombre">CALIDAD MULTIPORT</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="CALIDAD_MULTIPORT" data-linea="linea1"></div>
        <div class="contadores-calidad">
            <div class="contador-calidad">
                <span class="valor" id="liberadas_CALIDAD_MULTIPORT">0</span>
                <div class="etiqueta">Liberadas</div>
            </div>
            <div class="contador-calidad">
                <span class="valor" id="rechazadas_CALIDAD_MULTIPORT">0</span>
                <div class="etiqueta">Rechazadas</div>
            </div>
        </div>
        <div class="tiempos" data-grupo="CALIDAD_MULTIPORT"></div>
    </div>

    <div class="grupo" data-grupo="CALIDAD_DROPS">
        <div class="nombre">CALIDAD DROPS</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="CALIDAD_DROPS" data-linea="linea1"></div>
        <div class="contadores-calidad">
            <div class="contador-calidad">
                <span class="valor" id="liberadas_CALIDAD_DROPS">0</span>
                <div class="etiqueta">Liberadas</div>
            </div>
            <div class="contador-calidad">
                <span class="valor" id="rechazadas_CALIDAD_DROPS">0</span>
                <div class="etiqueta">Rechazadas</div>
            </div>
        </div>
        <div class="tiempos" data-grupo="CALIDAD_DROPS"></div>
    </div>

    <div class="grupo" data-grupo="CALIDAD_BEDROCK">
        <div class="nombre">CALIDAD BEDROCK</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="CALIDAD_BEDROCK" data-linea="linea1"></div>
        <div class="contadores-calidad">
            <div class="contador-calidad">
                <span class="valor" id="liberadas_CALIDAD_BEDROCK">0</span>
                <div class="etiqueta">Liberadas</div>
            </div>
            <div class="contador-calidad">
                <span class="valor" id="rechazadas_CALIDAD_BEDROCK">0</span>
                <div class="etiqueta">Rechazadas</div>
            </div>
        </div>
        <div class="tiempos" data-grupo="CALIDAD_BEDROCK"></div>
    </div>
</div>
  </div>
  <div class="footer">
    <button class="usuario-btn btn-rojo" onclick="volverAPantalla1()">Cerrar sesi√≥n</button>
  </div>
</section>

<section id="pantalla3" class="pantalla">
    <header class="header">
        <h1 id="tituloReportes">REPORTES</h1>
    </header>
    <div class="zona-centro">
        <div id="selectoresReportes" class="btn-contenedor">
            <button class="usuario-btn" data-reporte="produccion">PRODUCCI√ìN</button>
            <button class="usuario-btn" data-reporte="logistica">LOG√çSTICA</button>
            <button class="usuario-btn" data-reporte="calidad">CALIDAD</button>
            <button class="usuario-btn" data-reporte="resumen">RESUMEN EJECUTIVO</button>
        </div>
        <div id="contenedorReporte" class="contenedor-reportes">
            <h2>Selecciona un reporte</h2>
        </div>
    </div>
    <div class="footer">
        <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver</button>
    </div>
</section>

<div id="modalCalidad" class="modal-calidad">
    <div class="modal-content">
        <h3>Selecciona el estado de la tarima:</h3>
        <div class="opciones">
            <button class="opcion-btn" data-color="naranja">En proceso üü°</button>
            <button class="opcion-btn" data-color="rojo">Rechazada üî¥</button>
            <button class="opcion-btn" data-color="verde">Liberada üü¢</button>
        </div>
        <button class="cerrar-btn">Cerrar</button>
    </div>
</div>

<div id="modalRechazo" class="modal-calidad">
    <div class="modal-content">
        <h3>Detalles del Rechazo</h3>
        <form id="formularioRechazo">
            <label for="empleado">Empleado Originador:</label>
            <input type="text" id="empleado" name="empleado" required>
            
            <label for="linea">L√≠nea afectada:</label>
            <input type="text" id="linea" name="linea" required>

            <label for="parte">No. de parte:</label>
            <input type="text" id="parte" name="parte" required>

            <label for="descripcionParte">Descripci√≥n del No. de parte:</label>
            <input type="text" id="descripcionParte" name="descripcionParte" required>

            <label for="problema">Descripci√≥n del problema:</label>
            <textarea id="problema" name="problema" required></textarea>

            <label for="causa">Causa ra√≠z del problema:</label>
            <textarea id="causa" name="causa" required></textarea>

            <label for="accion">Acci√≥n correctiva:</label>
            <textarea id="accion" name="accion" required></textarea>

            <button type="submit">Guardar Rechazo</button>
        </form>
    </div>
</div>


<script>
// ================= CONFIG Y ESTADO =================
const CONFIG = {
    USUARIOS: ['MULTIPORT', 'BEDROCK', 'DROPS', 'LOG√çSTICA', 'SUPERVISOR', 'CALIDAD'],
    PASSWORDS: {
        'LOG√çSTICA': 'logistica123',
        'MULTIPORT': 'multiport123',
        'BEDROCK': 'bedrock123',
        'DROPS': 'drops123',
        'SUPERVISOR': 'supervisor123',
        'CALIDAD_MULTIPORT': 'calidadmp123',
        'CALIDAD_DROPS': 'calidaddp123',
        'CALIDAD_BEDROCK': 'calidadbr123',
        'REPORTES': 'reportes123'
    },
    LEDS_POR_GRUPO: {
        'MULTIPORT': 5,
        'BEDROCK': 5,
        'DROPS': 5,
        'CALIDAD_MULTIPORT': 5,
        'CALIDAD_BEDROCK': 5,
        'CALIDAD_DROPS': 5
    }
};

let usuarioSeleccionado = null;
let ledActivoParaFormulario = { grupo: null, idx: null, linea: null };
let reporteActual = null;
let miGrafico; // Variable global para el gr√°fico

// ================= FUNCION PARA OBTENER FECHA Y TURNO =================
function obtenerTurnoActual() {
    const ahora = new Date();
    const hora = ahora.getHours();
    const minutos = ahora.getMinutes();

    let fecha = new Date(ahora);
    let turno;

    // Turno 1: 06:30 a 18:29
    if ((hora > 6 || (hora === 6 && minutos >= 30)) && (hora < 18 || (hora === 18 && minutos < 30))) {
        turno = 'Turno 1';
    } 
    // Turno 2: 18:30 a 06:29 del d√≠a siguiente
    else {
        turno = 'Turno 2';
        if (hora < 6 || (hora === 6 && minutos < 30)) {
            // Si la hora es antes de las 6:30 AM, el turno pertenece al d√≠a anterior
            fecha.setDate(ahora.getDate() - 1);
        }
    }
    
    const year = fecha.getFullYear();
    const month = String(fecha.getMonth() + 1).padStart(2, '0');
    const day = String(fecha.getDate()).padStart(2, '0');
    const fechaFormateada = `${year}-${month}-${day}`;
    
    return { fecha: fechaFormateada, turno };
}

// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
  authDomain: "panel-logistica.firebaseapp.com",
  databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
  projectId: "panel-logistica",
  storageBucket: "panel-logistica.appspot.com",
  messagingSenderId: "38365879945",
  appId: "1:38365879945:web:e2f3590fe77f013dba3058"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const db = database; 
const ledRef = database.ref('estadoLEDs');
let historialRef;
let contadoresCalidadRef;
let rechazosDetalladosRef;

// ================= FUNCIONES DE RENDER =================
function inyectaLEDs(){
    document.querySelectorAll('.grupo').forEach(grupoDiv => {
        grupoDiv.classList.add('oculto');
    });

    if (usuarioSeleccionado === 'SUPERVISOR') {
        document.querySelectorAll('.grupo').forEach(grupoDiv => {
            grupoDiv.classList.remove('oculto');
        });
    } else if (usuarioSeleccionado === 'LOG√çSTICA') {
        document.querySelectorAll('.grupo:not([data-grupo*="CALIDAD_"])').forEach(grupoDiv => {
            grupoDiv.classList.remove('oculto');
        });
    } else if (usuarioSeleccionado.startsWith('CALIDAD_')) {
        document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`).classList.remove('oculto');
    } else {
        document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`).classList.remove('oculto');
        document.querySelector(`.grupo[data-grupo="CALIDAD_${usuarioSeleccionado}"]`).classList.remove('oculto');
    }

    document.querySelectorAll('.grupo:not(.oculto) .leds').forEach(contenedor => {
        const grupoLeds = contenedor.dataset.grupo;
        const linea = contenedor.dataset.linea;
        
        const ledsPorLinea = 5;
        contenedor.innerHTML = '';
        
        for(let i = 0; i < ledsPorLinea; i++){
            const led = document.createElement('div');
            led.className = 'led';
            led.title = `${grupoLeds} ‚Ä¢ ${linea} ‚Ä¢ LED ${i+1}`;
            led.addEventListener('click', () => togglearLED(grupoLeds, i, linea));
            contenedor.appendChild(led);
        }
    });
}

function pintarEstado() {
    db.ref('estadoLEDs').on('value', snapshot => {
        const estados = snapshot.val() || {};
        
        document.querySelectorAll('.leds').forEach(contenedor => {
            const grupoLeds = contenedor.dataset.grupo;
            const linea = contenedor.dataset.linea;
            
            if (estados[grupoLeds] && estados[grupoLeds][linea]) {
                const ledsEstado = estados[grupoLeds][linea];
                
                contenedor.querySelectorAll('.led').forEach((led, index) => {
                    // Limpiar clases de color y 'on' antes de aplicar el estado
                    led.classList.remove('on', 'naranja', 'rojo', 'verde');

                    if (ledsEstado[index]) {
                        if (grupoLeds.startsWith('CALIDAD_') && ledsEstado[index].color) {
                            led.classList.add(ledsEstado[index].color);
                        } else if (ledsEstado[index].encendido) {
                            led.classList.add('on');
                        }
                    } 
                });
            } else {
                contenedor.querySelectorAll('.led').forEach(led => {
                    led.classList.remove('on', 'naranja', 'rojo', 'verde');
                });
            }
        });
    });
}

function formatoHora(isoString) {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
}

function iniciarListenersFirebase() {
    const { fecha, turno } = obtenerTurnoActual();
    document.getElementById('turnoActual').textContent = `Turno actual: ${turno}`;

    // Desconectar listeners anteriores si existen
    if (historialRef) historialRef.off();
    if (contadoresCalidadRef) contadoresCalidadRef.off();
    if (rechazosDetalladosRef) rechazosDetalladosRef.off();

    historialRef = database.ref(`historialLogs/${fecha}/${turno}`);
    contadoresCalidadRef = database.ref(`contadoresCalidad/${fecha}/${turno}`);
    rechazosDetalladosRef = database.ref(`rechazosDetallados/${fecha}/${turno}`);

    historialRef.on('value', (snapshot) => {
        const logs = snapshot.val() || {};
        const contadores = { MULTIPORT: 0, BEDROCK: 0, DROPS: 0, CALIDAD_MULTIPORT: 0, CALIDAD_BEDROCK: 0, CALIDAD_DROPS: 0 };
        const tiempos = { MULTIPORT: [], BEDROCK: [], DROPS: [] };

        let tarimasTotales = 0;
        let tiempoTotalRecoleccion = 0;

        if (logs) {
            Object.values(logs).forEach(log => {
                if (log.accion === 'encendido' && contadores.hasOwnProperty(log.grupo)) {
                    contadores[log.grupo]++;
                } else if (log.accion === 'apagado' && log.tiempoRecoleccion) {
                    const grupoBase = log.grupo;
                    tiempos[grupoBase].push(log);
                    tarimasTotales++;
                    tiempoTotalRecoleccion += log.tiempoRecoleccion;
                }
            });
        }
        
        const tiempoPromedio = tarimasTotales > 0 ? Math.round(tiempoTotalRecoleccion / tarimasTotales) : 0;
        
        document.getElementById('tarimasTotales').textContent = tarimasTotales;
        document.getElementById('tiempoPromedio').textContent = `${tiempoPromedio} min`;

        const resumenTurnoDiv = document.getElementById('resumenTurno');
        if (usuarioSeleccionado === 'LOG√çSTICA' || usuarioSeleccionado === 'SUPERVISOR') {
            resumenTurnoDiv.classList.remove('oculto');
        } else {
            resumenTurnoDiv.classList.add('oculto');
        }
        
        document.querySelector('.grupo[data-grupo="MULTIPORT"] .tarimas').textContent = `Tarimas: ${contadores.MULTIPORT}`;
        document.querySelector('.grupo[data-grupo="BEDROCK"] .tarimas').textContent = `Tarimas: ${contadores.BEDROCK}`;
        document.querySelector('.grupo[data-grupo="DROPS"] .tarimas').textContent = `Tarimas: ${contadores.DROPS}`;
        document.querySelector('.grupo[data-grupo="CALIDAD_MULTIPORT"] .tarimas').textContent = `Tarimas: ${contadores.CALIDAD_MULTIPORT}`;
        document.querySelector('.grupo[data-grupo="CALIDAD_BEDROCK"] .tarimas').textContent = `Tarimas: ${contadores.CALIDAD_BEDROCK}`;
        document.querySelector('.grupo[data-grupo="CALIDAD_DROPS"] .tarimas').textContent = `Tarimas: ${contadores.CALIDAD_DROPS}`;


        Object.keys(tiempos).forEach(grupo => {
            const contenedorTiempos = document.querySelector(`.tiempos[data-grupo="${grupo}"]`);
            if (!contenedorTiempos) return;
            contenedorTiempos.innerHTML = '';
            tiempos[grupo].forEach((logEntry, index) => {
                const p = document.createElement('p');
                const horaInicio = formatoHora(logEntry.horaEncendido);
                const horaFin = formatoHora(logEntry.horaApagado);
                
                p.textContent = `Tarima ${index + 1}: ${logEntry.tiempoRecoleccion} minutos (${horaInicio} - ${horaFin})`;
                contenedorTiempos.appendChild(p);
            });
            contenedorTiempos.scrollTop = contenedorTiempos.scrollHeight;
        });
    });

    contadoresCalidadRef.on('value', (snapshot) => {
        const contadores = snapshot.val() || {};
        const gruposCalidad = ['CALIDAD_MULTIPORT', 'CALIDAD_DROPS', 'CALIDAD_BEDROCK'];
        
        gruposCalidad.forEach(grupo => {
            const liberadas = contadores[grupo] ? contadores[grupo].liberadas || 0 : 0;
            const rechazadas = contadores[grupo] ? contadores[grupo].rechazadas || 0 : 0;
            
            const liberadasSpan = document.getElementById(`liberadas_${grupo}`);
            const rechazadasSpan = document.getElementById(`rechazadas_${grupo}`);
            
            if (liberadasSpan) liberadasSpan.textContent = liberadas;
            if (rechazadasSpan) rechazadasSpan.textContent = rechazadas;
        });
    });
}


// ================= PERMISOS Y L√ìGICA =================
function puedeControlar(grupo){
    if(!usuarioSeleccionado) {
        return false;
    }
  
    if (usuarioSeleccionado === 'SUPERVISOR') {
        return false;
    }
  
    if (usuarioSeleccionado === 'LOG√çSTICA') {
        return true;
    }
  
    if (usuarioSeleccionado === grupo) {
        return true;
    }
    
    if (['MULTIPORT', 'DROPS', 'BEDROCK'].includes(usuarioSeleccionado) && grupo === `CALIDAD_${usuarioSeleccionado}`) {
        return true;
    }

    return false;
}
    
function togglearLED(grupo, idx, linea = 'linea1') {
    if (!puedeControlar(grupo)) {
        return alert('No tienes permiso para controlar estos LEDs');
    }

    const ledRef = db.ref('estadoLEDs/' + grupo + '/' + linea + '/' + idx);

    if (grupo.startsWith('CALIDAD_')) {
        if (['MULTIPORT', 'BEDROCK', 'DROPS'].includes(usuarioSeleccionado)) {
            ledRef.once('value', snapshot => {
                const estadoActual = snapshot.val() || {};
                if (estadoActual.color) {
                    if (!confirm('¬øEst√° realmente confirmada la tarima?')) {
                        return;
                    }
                    ledRef.set(null);
                    const log = {
                        usuario: usuarioSeleccionado,
                        grupo: grupo,
                        led: `${linea}-${idx+1}`,
                        accion: 'apagado_calidad',
                        timestamp: new Date().toISOString(),
                    };
                    historialRef.push(log);
                } else {
                    alert('Producci√≥n solo puede apagar LEDs de Calidad');
                }
            });
        } 
        else {
            mostrarOpcionesCalidad(grupo, idx, linea); 
        }
    }
    else {
        ledRef.once('value', snapshot => {
            const estadoActual = snapshot.val() || {};
            
            if (usuarioSeleccionado === 'LOG√çSTICA') {
                if (estadoActual.encendido) {
                    if (!confirm('¬øEst√° realmente recolectada la tarima?')) {
                        return;
                    }

                    ledRef.set({
                        encendido: false,
                        timestamp: new Date().toISOString()
                    });
                    
                    const tiempoRecoleccion = (new Date() - new Date(estadoActual.timestamp)) / 60000;
                    const log = {
                        usuario: usuarioSeleccionado,
                        grupo: grupo,
                        led: `${linea}-${idx+1}`,
                        accion: 'apagado',
                        timestamp: new Date().toISOString(),
                        tiempoRecoleccion: Math.round(tiempoRecoleccion),
                        horaEncendido: estadoActual.timestamp,
                        horaApagado: new Date().toISOString()
                    };
                    historialRef.push(log);
                } else {
                    alert('LOG√çSTICA solo puede apagar LEDs');
                }
            } else {
                if (!estadoActual.encendido) {
                    if (!confirm('¬øEst√° realmente confirmada la tarima?')) {
                        return;
                    }
                    ledRef.set({
                        encendido: true,
                        timestamp: new Date().toISOString(),
                        usuario: usuarioSeleccionado
                    });
                    
                    const log = {
                        usuario: usuarioSeleccionado,
                        grupo: grupo,
                        led: `${linea}-${idx+1}`,
                        accion: 'encendido',
                        timestamp: new Date().toISOString(),
                        tiempoRecoleccion: null,
                        horaEncendido: new Date().toISOString(),
                        horaApagado: null
                    };
                    historialRef.push(log);
                }
            }
        });
    }
}

// ================= L√ìGICA DE CALIDAD MODAL =================
function mostrarOpcionesCalidad(grupo, idx, linea) {
    ledActivoParaFormulario = { grupo, idx, linea };
    document.getElementById('modalCalidad').classList.add('visible');
}

function aplicarEstadoCalidad(nuevoColor) {
    const { grupo, idx, linea } = ledActivoParaFormulario;
    const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);

    ledRef.set({
        color: nuevoColor,
        timestamp: new Date().toISOString(),
        usuario: usuarioSeleccionado
    });

    if (nuevoColor === 'verde') {
        const contadorRef = contadoresCalidadRef.child(grupo);
        contadorRef.child('liberadas').transaction(currentCount => (currentCount || 0) + 1);
    } else if (nuevoColor === 'rojo') {
        const contadorRef = contadoresCalidadRef.child(grupo);
        contadorRef.child('rechazadas').transaction(currentCount => (currentCount || 0) + 1);
    }
}

function mostrarFormularioRechazo() {
    document.getElementById('modalCalidad').classList.remove('visible');
    document.getElementById('modalRechazo').classList.add('visible');
}

function guardarRechazo(datos) {
    const ahora = new Date();
    const fecha = ahora.toLocaleDateString('es-MX');
    const hora = ahora.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});

    const datosCompletos = {
        ...datos,
        fecha: fecha,
        hora: hora,
        timestamp: ahora.toISOString()
    };

    rechazosDetalladosRef.push(datosCompletos)
        .then(() => {
            console.log("Rechazo guardado exitosamente:", datosCompletos);
            aplicarEstadoCalidad('rojo');
        })
        .catch(error => {
            console.error("Error guardando rechazo:", error);
            alert("Hubo un error al guardar el rechazo.");
        })
        .finally(() => {
            document.getElementById('modalRechazo').classList.remove('visible');
        });
}

// ================= NAVEGACI√ìN Y ARRANQUE =================
function activarPantalla(id){
  document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa'));
  document.getElementById(id).classList.add('activa');
}

function volverAPantalla1(){
    usuarioSeleccionado = null;
    db.ref('estadoLEDs').off(); 
    if (historialRef) historialRef.off();
    if (contadoresCalidadRef) contadoresCalidadRef.off();
    if (rechazosDetalladosRef) rechazosDetalladosRef.off();
    activarPantalla('pantalla1');
}

function seleccionarUsuario(usuario) {
    if (!CONFIG.USUARIOS.includes(usuario)) {
        return;
    }

    if (usuario === 'SUPERVISOR') {
        usuarioSeleccionado = usuario;
        document.getElementById('tituloFijo').textContent = 'SUPERVISOR';
        activarPantalla('pantalla2');
        inyectaLEDs();
        pintarEstado();
        iniciarListenersFirebase(); // Inicia los listeners y muestra el turno
        alert(`¬°Bienvenido, ${usuario}!`);
    } else if (usuario === 'CALIDAD') {
        const password = prompt('Introduce la contrase√±a para CALIDAD:');
        let subusuario = null;
        
        if (password === CONFIG.PASSWORDS['CALIDAD_MULTIPORT']) {
            subusuario = 'CALIDAD_MULTIPORT';
        } else if (password === CONFIG.PASSWORDS['CALIDAD_DROPS']) {
            subusuario = 'CALIDAD_DROPS';
        } else if (password === CONFIG.PASSWORDS['CALIDAD_BEDROCK']) {
            subusuario = 'CALIDAD_BEDROCK';
        }

        if (subusuario) {
            usuarioSeleccionado = subusuario;
            document.getElementById('tituloFijo').textContent = `CALIDAD - ${subusuario.split('_')[1]}`;
            activarPantalla('pantalla2');
            inyectaLEDs();
            pintarEstado();
            iniciarListenersFirebase(); // Inicia los listeners y muestra el turno
            alert(`¬°Bienvenido, ${subusuario.replace('_', ' ')}!`);
        } else {
            alert('Contrase√±a incorrecta. Int√©ntalo de nuevo.');
        }
    } else {
        const password = prompt(`Introduce la contrase√±a para ${usuario}:`);
        if (password === CONFIG.PASSWORDS[usuario]) {
            usuarioSeleccionado = usuario;
            if (usuario === 'LOG√çSTICA') {
                document.getElementById('tituloFijo').textContent = 'LOG√çSTICA';
            } else {
                document.getElementById('tituloFijo').textContent = usuario;
            }
            activarPantalla('pantalla2');
            inyectaLEDs();
            pintarEstado();
            iniciarListenersFirebase(); // Inicia los listeners y muestra el turno
            alert(`¬°Bienvenido, ${usuario}!`);
        } else {
            alert('Contrase√±a incorrecta. Int√©ntalo de nuevo.');
        }
    }
}

function seleccionarReporte() {
    const password = prompt('Introduce la contrase√±a para REPORTES:');
    if (password === CONFIG.PASSWORDS['REPORTES']) {
        activarPantalla('pantalla3');
        document.getElementById('tituloReportes').textContent = 'REPORTES';
        document.getElementById('selectoresReportes').style.display = 'flex';
        document.getElementById('contenedorReporte').innerHTML = '<h2>Selecciona un reporte</h2>';
    } else {
        alert('Contrase√±a incorrecta. Acceso denegado.');
    }
}

function mostrarReporte(tipo) {
    reporteActual = tipo;
    document.getElementById('selectoresReportes').style.display = 'none';
    const contenedor = document.getElementById('contenedorReporte');
    const { fecha: fechaActual, turno: turnoActual } = obtenerTurnoActual();
    
    let areaFiltroHtml = '';
    const areas = ['TODAS', 'MULTIPORT', 'DROPS', 'BEDROCK'];
    areaFiltroHtml = `
        <select id="areaFiltro">
            ${areas.map(area => `<option value="${area}">${area}</option>`).join('')}
        </select>
    `;

    let fechaFiltroHtml = '';
    if (tipo === 'calidad' || tipo === 'produccion' || tipo === 'logistica') {
        fechaFiltroHtml = `
            <label for="fechaReporte">Fecha Inicio:</label>
            <input type="date" id="fechaInicioReporte" value="${fechaActual}">
            <label for="fechaReporte">Fecha Fin:</label>
            <input type="date" id="fechaFinReporte" value="${fechaActual}">
        `;
    } else {
        fechaFiltroHtml = `
            <label for="fechaReporte">Fecha:</label>
            <input type="date" id="fechaReporte" value="${fechaActual}">
        `;
    }

    let turnoFiltroHtml = '';
    if (tipo !== 'resumen') {
        turnoFiltroHtml = `
            <label for="turnoFiltro">Turno:</label>
            <select id="turnoFiltro">
                <option value="todos">Todos</option>
                <option value="Turno 1">Turno 1</option>
                <option value="Turno 2">Turno 2</option>
            </select>
        `;
    }

    contenedor.innerHTML = `
        <div class="header-reporte">
            <button onclick="regresarASelectores()" class="usuario-btn">Regresar</button>
            <div class="filtros">
                ${fechaFiltroHtml}
                ${turnoFiltroHtml}
                ${tipo !== 'resumen' ? areaFiltroHtml : ''}
                <button onclick="buscarReporte()" class="usuario-btn">Buscar</button>
            </div>
        </div>
        <h2 id="tituloReporteDinamico">Cargando...</h2>
        <div id="contenidoReporte"></div>
        <div class="botones-reporte">
            <button class="usuario-btn" onclick="exportarTablaACsv('${tipo}')">Exportar a CSV</button>
        </div>
    `;

    if (document.getElementById('turnoFiltro')) {
        document.getElementById('turnoFiltro').value = turnoActual;
    }
    if (document.getElementById('areaFiltro')) {
        document.getElementById('areaFiltro').value = 'TODAS';
    }
    
    const fechaInicio = document.getElementById('fechaInicioReporte') ? document.getElementById('fechaInicioReporte').value : fechaActual;
    const fechaFin = document.getElementById('fechaFinReporte') ? document.getElementById('fechaFinReporte').value : fechaActual;
    const area = document.getElementById('areaFiltro') ? document.getElementById('areaFiltro').value : null;
    const turno = document.getElementById('turnoFiltro') ? document.getElementById('turnoFiltro').value : null;
    
    cargarDatosReporte(tipo, fechaInicio, fechaFin, turno, area);
}


function regresarASelectores() {
    document.getElementById('tituloReportes').textContent = 'REPORTES';
    document.getElementById('selectoresReportes').style.display = 'flex';
    document.getElementById('contenedorReporte').innerHTML = '<h2>Selecciona un reporte</h2>';
    if (miGrafico) {
        miGrafico.destroy();
    }
}

function buscarReporte() {
    const tipo = reporteActual;
    const fechaInicio = document.getElementById('fechaInicioReporte') ? document.getElementById('fechaInicioReporte').value : document.getElementById('fechaReporte').value;
    const fechaFin = document.getElementById('fechaFinReporte') ? document.getElementById('fechaFinReporte').value : document.getElementById('fechaReporte').value;
    const turno = document.getElementById('turnoFiltro') ? document.getElementById('turnoFiltro').value : 'todos';
    const area = document.getElementById('areaFiltro') ? document.getElementById('areaFiltro').value : null;

    cargarDatosReporte(tipo, fechaInicio, fechaFin, turno, area);
}


function cargarDatosReporte(tipo, fechaInicio, fechaFin, turno, area = null) {
    const contenedor = document.getElementById('contenidoReporte');
    const tituloReporte = document.getElementById('tituloReporteDinamico');
    contenedor.innerHTML = '<p>Cargando datos...</p>';
    
    if (miGrafico) {
        miGrafico.destroy();
    }
    
    const fechas = obtenerRangoFechas(fechaInicio, fechaFin);
    const promesas = fechas.map(fecha => {
        const refHistorial = db.ref(`historialLogs/${fecha}`);
        const refCalidad = db.ref(`contadoresCalidad/${fecha}`);
        const refRechazos = db.ref(`rechazosDetallados/${fecha}`);
        return Promise.all([
            refHistorial.once('value').then(s => s.val()),
            refCalidad.once('value').then(s => s.val()),
            refRechazos.once('value').then(s => s.val())
        ]).then(([historial, calidad, rechazos]) => ({ fecha, historial, calidad, rechazos }));
    });
    
    Promise.all(promesas).then(resultados => {
        let datosCombinados = { historial: {}, calidad: {}, rechazos: {} };
        resultados.forEach(res => {
            Object.assign(datosCombinados.historial, res.historial);
            Object.assign(datosCombinados.calidad, res.calidad);
            Object.assign(datosCombinados.rechazos, res.rechazos);
        });

        if (tipo === 'calidad') {
            tituloReporte.textContent = `Reporte de Calidad (${fechaInicio} a ${fechaFin})`;
            procesarReporteCalidad(datosCombinados.rechazos, contenedor, area);
        } else if (tipo === 'produccion') {
            tituloReporte.textContent = `Reporte de Producci√≥n (${fechaInicio} a ${fechaFin})`;
            procesarReporteProduccion(datosCombinados.historial, contenedor, area);
        } else if (tipo === 'logistica') {
            tituloReporte.textContent = `Reporte de Log√≠stica (${fechaInicio} a ${fechaFin})`;
            procesarReporteLogistica(datosCombinados.historial, contenedor, area);
        } else if (tipo === 'resumen') {
            tituloReporte.textContent = `Resumen Ejecutivo (${fechaInicio} a ${fechaFin})`;
            procesarReporteResumen(datosCombinados, contenedor);
        }
    }).catch(error => {
        console.error("Error al cargar los datos:", error);
        contenedor.innerHTML = `<p>Error al cargar los datos. Intenta de nuevo.</p>`;
    });
}

function procesarReporteCalidad(datos, contenedor, area) {
    let rechazosFiltrados = [];
    for (const turnoKey in datos) {
        if (turno === 'todos' || turnoKey === turno) {
            for (const rechazoKey in datos[turnoKey]) {
                const rechazo = datos[turnoKey][rechazoKey];
                const areaDeRechazo = rechazo.linea.split(' ')[0].toUpperCase();
                if (area === 'TODAS' || areaDeRechazo === area) {
                    rechazosFiltrados.push(rechazo);
                }
            }
        }
    }
    
    const conteoCausas = {};
    rechazosFiltrados.forEach(rechazo => {
        const causa = rechazo.causa || 'Desconocida';
        conteoCausas[causa] = (conteoCausas[causa] || 0) + 1;
    });
    
    let html = `<table><thead><tr><th>Fecha</th><th>Hora</th><th>L√≠nea</th><th>Empleado</th><th>No. de Parte</th><th>Descripci√≥n del Problema</th><th>Causa Ra√≠z</th><th>Acci√≥n Correctiva</th></tr></thead><tbody>`;
    rechazosFiltrados.forEach(r => {
        html += `
            <tr>
                <td>${r.fecha}</td>
                <td>${r.hora}</td>
                <td>${r.linea || 'N/A'}</td>
                <td>${r.empleado || 'N/A'}</td>
                <td>${r.parte || 'N/A'}</td>
                <td>${r.problema || 'N/A'}</td>
                <td>${r.causa || 'N/A'}</td>
                <td>${r.accion || 'N/A'}</td>
            </tr>
        `;
    });
    html += `</tbody></table>`;
    contenedor.innerHTML = html;
    
    if (Object.keys(conteoCausas).length > 0) {
        const graficoDiv = document.createElement('div');
        graficoDiv.className = 'grafico-contenedor';
        graficoDiv.innerHTML = '<canvas id="graficoRechazos"></canvas>';
        contenedor.appendChild(graficoDiv);
        generarGraficoRechazos(conteoCausas);
    }
}


function procesarReporteProduccion(datos, contenedor, area) {
    let logsProduccion = [];
    const conteo = { MULTIPORT: 0, DROPS: 0, BEDROCK: 0 };
    
    for (const turnoKey in datos) {
        if (turno === 'todos' || turnoKey === turno) {
            for (const logKey in datos[turnoKey]) {
                const log = datos[turnoKey][logKey];
                if (log.accion === 'encendido' && ['MULTIPORT', 'DROPS', 'BEDROCK'].includes(log.grupo)) {
                    if (area === 'TODAS' || log.grupo === area) {
                        logsProduccion.push(log);
                        conteo[log.grupo]++;
                    }
                }
            }
        }
    }
    
    let html = `
        <div class="resumen-datos">
            <div class="dato">
                <div class="valor">${logsProduccion.length}</div>
                <div class="etiqueta">Tarimas Confirmadas</div>
            </div>
        </div>
    `;
    
    html += `
        <table>
            <thead>
                <tr>
                    <th>L√≠nea</th>
                    <th>Tarima</th>
                    <th>Hora de Confirmaci√≥n</th>
                    <th>Usuario</th>
                </tr>
            </thead>
            <tbody>
    `;
    logsProduccion.forEach(log => {
        html += `
            <tr>
                <td>${log.grupo}</td>
                <td>${log.led}</td>
                <td>${formatoHora(log.timestamp)}</td>
                <td>${log.usuario}</td>
            </tr>
        `;
    });
    html += `</tbody></table>`;
    contenedor.innerHTML = html;
    
    // Generar gr√°fico de barras de producci√≥n
    const graficoDiv = document.createElement('div');
    graficoDiv.className = 'grafico-contenedor';
    graficoDiv.innerHTML = '<canvas id="graficoProduccion"></canvas>';
    contenedor.appendChild(graficoDiv);
    generarGraficoProduccion(conteo);
}


function procesarReporteLogistica(datos, contenedor, area) {
    let logsRecoleccion = [];
    let tiempoTotal = 0;
    
    for (const turnoKey in datos) {
        if (turno === 'todos' || turnoKey === turno) {
            for (const logKey in datos[turnoKey]) {
                const log = datos[turnoKey][logKey];
                if (log.accion === 'apagado' && log.tiempoRecoleccion && ['MULTIPORT', 'DROPS', 'BEDROCK'].includes(log.grupo)) {
                     if (area === 'TODAS' || log.grupo === area) {
                        logsRecoleccion.push(log);
                        tiempoTotal += log.tiempoRecoleccion;
                    }
                }
            }
        }
    }
    
    const tiempoPromedio = logsRecoleccion.length > 0 ? (tiempoTotal / logsRecoleccion.length).toFixed(1) : 0;

    let html = `
        <div class="resumen-datos">
            <div class="dato">
                <div class="valor">${logsRecoleccion.length}</div>
                <div class="etiqueta">Tarimas Recolectadas</div>
            </div>
            <div class="dato">
                <div class="valor">${tiempoPromedio} min</div>
                <div class="etiqueta">Tiempo Promedio</div>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>L√≠nea</th>
                    <th>Tarima</th>
                    <th>Tiempo de Recolecci√≥n (min)</th>
                    <th>Hora de Encendido</th>
                    <th>Hora de Apagado</th>
                </tr>
            </thead>
            <tbody>
    `;
    logsRecoleccion.forEach(log => {
        html += `
            <tr>
                <td>${log.grupo}</td>
                <td>${log.led}</td>
                <td>${log.tiempoRecoleccion}</td>
                <td>${formatoHora(log.horaEncendido)}</td>
                <td>${formatoHora(log.horaApagado)}</td>
            </tr>
        `;
    });
    html += `</tbody></table>`;
    contenedor.innerHTML = html;
    
    const graficoDiv = document.createElement('div');
    graficoDiv.className = 'grafico-contenedor';
    graficoDiv.innerHTML = '<canvas id="graficoLogistica"></canvas>';
    contenedor.appendChild(graficoDiv);
    generarGraficoLogistica(logsRecoleccion);
}

function procesarReporteResumen(datos, contenedor) {
    const areas = ['MULTIPORT', 'DROPS', 'BEDROCK'];
    const resumen = {};
    
    areas.forEach(area => {
        resumen[area] = {
            produccion: 0,
            liberadas: 0,
            rechazadas: 0,
            tiempoLogistica: { total: 0, count: 0, promedio: 0 }
        };
    });

    // Procesar producci√≥n y log√≠stica
    for (const fechaKey in datos.historial) {
        for (const turnoKey in datos.historial[fechaKey]) {
            for (const logKey in datos.historial[fechaKey][turnoKey]) {
                const log = datos.historial[fechaKey][turnoKey][logKey];
                if (log.accion === 'encendido' && resumen.hasOwnProperty(log.grupo)) {
                    resumen[log.grupo].produccion++;
                } else if (log.accion === 'apagado' && log.tiempoRecoleccion && resumen.hasOwnProperty(log.grupo)) {
                    resumen[log.grupo].tiempoLogistica.total += log.tiempoRecoleccion;
                    resumen[log.grupo].tiempoLogistica.count++;
                }
            }
        }
    }

    // Procesar calidad
    for (const fechaKey in datos.calidad) {
        for (const turnoKey in datos.calidad[fechaKey]) {
            for (const grupoKey in datos.calidad[fechaKey][turnoKey]) {
                const grupoBase = grupoKey.replace('CALIDAD_', '');
                if (resumen.hasOwnProperty(grupoBase)) {
                    const contadores = datos.calidad[fechaKey][turnoKey][grupoKey];
                    resumen[grupoBase].liberadas += contadores.liberadas || 0;
                    resumen[grupoBase].rechazadas += contadores.rechazadas || 0;
                }
            }
        }
    }

    let html = ``;
    areas.forEach(area => {
        const prod = resumen[area].produccion;
        const liberadas = resumen[area].liberadas;
        const rechazadas = resumen[area].rechazadas;
        const totalCalidad = liberadas + rechazadas;
        const tasaRechazo = totalCalidad > 0 ? ((rechazadas / totalCalidad) * 100).toFixed(1) : 0;
        const tiempoPromedio = resumen[area].tiempoLogistica.count > 0 ? (resumen[area].tiempoLogistica.total / resumen[area].tiempoLogistica.count).toFixed(1) : 0;

        html += `
            <h3>${area}</h3>
            <div class="resumen-datos">
                <div class="dato">
                    <div class="valor">${prod}</div>
                    <div class="etiqueta">Tarimas Producidas</div>
                </div>
                <div class="dato">
                    <div class="valor">${liberadas}</div>
                    <div class="etiqueta">Tarimas Liberadas</div>
                </div>
                <div class="dato">
                    <div class="valor">${rechazadas}</div>
                    <div class="etiqueta">Tarimas Rechazadas</div>
                </div>
                <div class="dato">
                    <div class="valor">${tasaRechazo}%</div>
                    <div class="etiqueta">Tasa de Rechazo</div>
                </div>
                <div class="dato">
                    <div class="valor">${tiempoPromedio} min</div>
                    <div class="etiqueta">Tiempo Recolecci√≥n</div>
                </div>
            </div>
        `;
    });
    contenedor.innerHTML = html;
}

function generarGraficoRechazos(datos) {
    const ctx = document.getElementById('graficoRechazos').getContext('2d');
    const labels = Object.keys(datos);
    const data = Object.values(datos);
    
    const backgroundColors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED',
        '#FF6361', '#5DADE2', '#F7DC6F', '#7DCEA0', '#AF7AC5', '#F5B041'
    ];
    
    miGrafico = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                hoverBackgroundColor: backgroundColors
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: { size: 14 }
                    }
                },
                title: {
                    display: true,
                    text: 'Causas de Rechazo',
                    font: { size: 20 }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function generarGraficoProduccion(datos) {
    const ctx = document.getElementById('graficoProduccion').getContext('2d');
    const labels = Object.keys(datos);
    const data = Object.values(datos);

    miGrafico = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tarimas Confirmadas',
                data: data,
                backgroundColor: [
                    '#4BC0C0',
                    '#36A2EB',
                    '#FFCE56'
                ],
                borderColor: [
                    '#4BC0C0',
                    '#36A2EB',
                    '#FFCE56'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Cantidad de Tarimas'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Producci√≥n por √Årea'
                }
            }
        }
    });
}

function generarGraficoLogistica(datos) {
    const ctx = document.getElementById('graficoLogistica').getContext('2d');
    
    const logsOrdenados = datos.sort((a, b) => new Date(a.horaApagado) - new Date(b.horaApagado));
    const labels = logsOrdenados.map((log, index) => formatoHora(log.horaApagado));
    const data = logsOrdenados.map(log => log.tiempoRecoleccion);
    
    miGrafico = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tiempo de Recolecci√≥n (min)',
                data: data,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Hora de Recolecci√≥n'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Tiempo (min)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Evoluci√≥n del Tiempo de Recolecci√≥n'
                }
            }
        }
    });
}

function obtenerRangoFechas(fechaInicioStr, fechaFinStr) {
    const fechas = [];
    let fechaActual = new Date(fechaInicioStr + 'T00:00:00');
    const fechaFin = new Date(fechaFinStr + 'T00:00:00');

    while (fechaActual <= fechaFin) {
        const year = fechaActual.getFullYear();
        const month = String(fechaActual.getMonth() + 1).padStart(2, '0');
        const day = String(fechaActual.getDate()).padStart(2, '0');
        fechas.push(`${year}-${month}-${day}`);
        fechaActual.setDate(fechaActual.getDate() + 1);
    }
    return fechas;
}


function exportarTablaACsv(nombreReporte) {
    const tabla = document.querySelector('#contenidoReporte table');
    if (!tabla) {
        alert('No hay una tabla para exportar.');
        return;
    }

    let csv = [];
    const filas = tabla.querySelectorAll('tr');

    for (const fila of filas) {
        let filaDatos = [];
        const celdas = fila.querySelectorAll('th, td');
        for (const celda of celdas) {
            filaDatos.push(`"${celda.textContent.trim().replace(/"/g, '""')}"`); // Escapar comillas dobles
        }
        csv.push(filaDatos.join(','));
    }

    const csvFinal = csv.join('\n');
    const blob = new Blob([csvFinal], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `${nombreReporte}_${document.getElementById('fechaInicioReporte').value}_a_${document.getElementById('fechaFinReporte').value}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ================= ARRANQUE Y MANEJO DE MODALES =================
window.addEventListener('load', ()=>{
    firebase.auth().signInAnonymously().catch(err => {
        console.error('Auth error:', err);
    });
    
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            iniciarListenersFirebase(); 
            activarPantalla('pantalla1');
        } else {
            // Manejar el caso de no autenticaci√≥n si es necesario
        }
    });
    
    // Configurar listeners de los modales una sola vez
    const modalCalidad = document.getElementById('modalCalidad');
    modalCalidad.querySelector('.cerrar-btn').addEventListener('click', () => {
        modalCalidad.classList.remove('visible');
    });

    modalCalidad.querySelectorAll('.opcion-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const nuevoColor = btn.dataset.color;
            if (nuevoColor === 'rojo') {
                mostrarFormularioRechazo();
            } else {
                aplicarEstadoCalidad(nuevoColor);
                modalCalidad.classList.remove('visible');
            }
        });
    });

    const modalRechazo = document.getElementById('modalRechazo');
    modalRechazo.querySelector('#formularioRechazo').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formulario = e.target;
        const datos = {
            empleado: formulario.empleado.value,
            linea: formulario.linea.value,
            parte: formulario.parte.value,
            descripcionParte: formulario.descripcionParte.value,
            problema: formulario.problema.value,
            causa: formulario.causa.value,
            accion: formulario.accion.value,
        };
        
        guardarRechazo(datos);
        formulario.reset();
    });

    // Configurar listeners para la pantalla de reportes
    const selectoresReportes = document.getElementById('selectoresReportes');
    selectoresReportes.querySelectorAll('.usuario-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tipoReporte = btn.dataset.reporte;
            mostrarReporte(tipoReporte);
        });
    });

    // PWA: Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => {
                console.log("‚úÖ Service Worker registrado:", reg);
            })
            .catch(err => {
                console.error("‚ùå Error al registrar Service Worker:", err);
            });
    }
});
</script>
</body>
</html>
