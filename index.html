<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Logística</title>
    <meta name="theme-color" content="#0066cc">
    <link rel="manifest" href="manifest.json">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root{
  --btn-bg: #0066cc;
  --btn-bg-hover: #004c99;
  --grid-size: 26px;
  --vignette: rgba(0,0,0,0.9);
  --titulo-size: clamp(42px,7vw,96px);
  --led-size: 50px;
  --led-gap: 16px;
  --led-off-core: #111;
  --led-off-edge: #000;
  --led-on-core: #0f0;
  --led-on-edge: #063;
  --glow: #00ff88;
  --blink-duration: 0.9s;
}

*{ box-sizing: border-box; }
html, body{ height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:#111; }

.pantalla{ display:none; width:100%; height:100vh; }
.pantalla.activa{ display:flex; flex-direction:column; }

#pantalla1{
    align-items:center;
    justify-content:center;
    flex-direction: column;
    background:linear-gradient(135deg,#222,#444);
    gap:18px;
}
.btn-contenedor{
    display:flex;
    flex-direction:column;
    align-items:center;
}

#pantalla1 h1{ margin:0 0 8px; }
.usuario-btn{
  background: var(--btn-bg);
  color:#fff;
  border:0;
  padding:14px 28px;
  margin:8px;
  border-radius:10px;
  font-size:18px;
  cursor:pointer;
  transition: background .25s ease;
}
.usuario-btn:hover{ background: var(--btn-bg-hover); }

#pantalla2{
  background-color:#000;
  background-image:
    radial-gradient(circle, rgba(60,60,60,.28) 20%, transparent 21%),
    radial-gradient(circle, #101010 20%, transparent 21%);
  background-size: var(--grid-size) var(--grid-size);
  box-shadow: inset 0 0 90px var(--vignette);
}
.header{ display:flex; align-items:center; justify-content:center; padding:16px 20px 6px; }
#tituloFijo{
  font-weight:800;
  text-align:center;
  letter-spacing:.5px;
  text-shadow:0 2px 8px rgba(0,0,0,.65);
  font-size:var(--titulo-size);
}
.zona-centro{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px 24px 28px;
  flex-direction: column; /* <-- Agrega esta línea */
}
.grupo-contenedor{
  display:grid;
  grid-template-columns: repeat(3, minmax(200px, 1fr));
  gap: clamp(24px, 4vw, 64px);
  width: min(1200px, 96vw);
}
.grupo{ display:flex; flex-direction:column; align-items:center; text-align:center; }
.grupo .nombre{ font-size: clamp(20px,2.2vw,28px); font-weight:800; margin-bottom:8px; letter-spacing:.5px; text-shadow:0 1px 6px rgba(0,0,0,.5); }
.grupo .tarimas{ font-size: clamp(16px,1.7vw,22px); opacity:.9; margin-bottom:14px; }
.leds{ display:flex; gap: var(--led-gap); justify-content:center; align-items:center; flex-wrap:nowrap; padding:4px; }
.led{
  width: var(--led-size);
  height: var(--led-size);
  border-radius:50%;
  cursor:pointer;
  background: radial-gradient(circle at 45% 40%, var(--led-off-core) 40%, var(--led-off-edge) 100%);
  box-shadow: inset -4px -5px 8px rgba(0,0,0,.8), inset 4px 5px 6px rgba(255,255,255,.06), 0 1px 0 rgba(255,255,255,.05);
  transition: transform .1s ease, filter .2s ease, box-shadow .2s ease;
}
.led:active{ transform: scale(.96); }
.led.on{
  background: radial-gradient(circle at 48% 45%, var(--led-on-core) 40%, var(--led-on-edge) 100%);
  box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  animation: blink var(--blink-duration) ease-in-out infinite;
    
.tiempos{
    margin-top: 10px;
    font-size: 14px;
    opacity: 0.8;
    text-align: left;
    width: 100%;
    /* -- AGREGAR ESTAS DOS LÍNEAS -- */
    max-height: 200px; /* Puedes ajustar este valor si lo necesitas */
    overflow-y: auto;
}
@keyframes blink{ 0%,100%{ filter:brightness(1); } 50%{ filter:brightness(1.25); } }
@media(max-width:720px){
  .grupo-contenedor{
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
}
</style>
</head>

<body>

<section id="pantalla1" class="pantalla activa">
  <h1>Selecciona tu usuario</h1>
<div class="btn-contenedor">
    <button class="usuario-btn" onclick="seleccionarUsuario('LOGÍSTICA')">LOGÍSTICA</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('MULTIPORT')">MULTIPORT</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('BEDROCK')">BEDROCK</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('DROPS')">DROPS</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('SUPERVISOR')">SUPERVISOR</button>
</div>
</section>

<section id="pantalla2" class="pantalla">
  <header class="header">
    <div id="tituloFijo">LOGÍSTICA</div>
  </header>
  <div class="zona-centro">
    <div class="grupo-contenedor">

      <div class="grupo" data-grupo="MULTIPORT">
        <div class="nombre">MULTIPORT</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="MULTIPORT" data-linea="linea1"></div>
        <div class="leds" data-grupo="MULTIPORT" data-linea="linea2"></div>
        <div class="tiempos" data-grupo="MULTIPORT"></div>
      </div>

      <div class="grupo" data-grupo="DROPS">
        <div class="nombre">DROPS</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="DROPS" data-linea="linea1"></div>
        <div class="leds" data-grupo="DROPS" data-linea="linea2"></div>
        <div class="tiempos" data-grupo="DROPS"></div>
      </div>

      <div class="grupo" data-grupo="BEDROCK">
        <div class="nombre">BEDROCK</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="BEDROCK" data-linea="linea1"></div>
        <div class="leds" data-grupo="BEDROCK" data-linea="linea2"></div>
        <div class="tiempos" data-grupo="BEDROCK"></div>
      </div>
    </div>
  </div>
</section>

<script>
// ================= CONFIG Y ESTADO =================
const CONFIG = {
    LED_COUNT: 5,
    TITULO_FIJO: 'LOGÍSTICA',
    USUARIOS: ['LOGÍSTICA', 'MULTIPORT', 'BEDROCK', 'DROPS', 'SUPERVISOR'],
    PASSWORDS: {
        'LOGÍSTICA': 'logistica123',
        'MULTIPORT': 'multiport123',
        'BEDROCK': 'bedrock123',
        'DROPS': 'drops123',
        'SUPERVISOR': 'supervisor123'
    }
};
let usuarioSeleccionado = null;
let estadoLEDs = {
  MULTIPORT: { linea1:Array(CONFIG.LED_COUNT).fill(false), linea2:Array(CONFIG.LED_COUNT).fill(false) },
  BEDROCK:  { linea1:Array(CONFIG.LED_COUNT).fill(false), linea2:Array(CONFIG.LED_COUNT).fill(false) },
  DROPS:    { linea1:Array(CONFIG.LED_COUNT).fill(false), linea2:Array(CONFIG.LED_COUNT).fill(false) }
};

// ================= FUNCION PARA OBTENER FECHA Y TURNO =================
function obtenerTurnoActual() {
    const ahora = new Date();
    const hora = ahora.getHours() + (ahora.getMinutes() / 60);

    const year = ahora.getFullYear();
    const month = String(ahora.getMonth() + 1).padStart(2, '0');
    const day = String(ahora.getDate()).padStart(2, '0');
    let fecha = `${year}-${month}-${day}`;
    
    let turno;
    if (hora >= 6.5 && hora < 18.5) { // 06:30 a 18:30
        turno = 'Turno 1';
    } else { // 18:30 a 06:30
        turno = 'Turno 2';
    }
    
    return { fecha, turno };
}

// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
  authDomain: "panel-logistica.firebaseapp.com",
  databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
  projectId: "panel-logistica",
  storageBucket: "panel-logistica.appspot.com",
  messagingSenderId: "38365879945",
  appId: "1:38365879945:web:e2f3590fe77f013dba3058"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const ledRef = database.ref('estadoLEDs');
let historialRef;

// ================= AUTENTICACIÓN ANÓNIMA =================
firebase.auth().signInAnonymously().catch(err=>console.error('Auth error:', err));

// ================= FUNCIONES DE RENDER =================
function inyectaLEDs(){
  document.querySelectorAll('.leds').forEach(contenedor=>{
    const grupo = contenedor.dataset.grupo;
    const linea = contenedor.dataset.linea || 'linea1';
    contenedor.innerHTML = '';
    for(let i=0;i<CONFIG.LED_COUNT;i++){
      const led = document.createElement('div');
      led.className='led';
      led.title = `${grupo} • ${linea} • LED ${i+1}`;
      led.addEventListener('click', ()=> togglearLED(grupo, i, linea));
      contenedor.appendChild(led);
    }
  });
}

function pintarEstado(){
  Object.keys(estadoLEDs).forEach(grupo=>{
    document.querySelectorAll(`.leds[data-grupo="${grupo}"]`).forEach(contenedor=>{
      const linea = contenedor.dataset.linea || 'linea1';
      const leds = contenedor.querySelectorAll('.led');
      estadoLEDs[grupo][linea].forEach((estado, i)=>{
        if(leds[i]){
            leds[i].classList.toggle('on', !!estado.encendido);
        }
      });
    });
  });
}

// ================= FIREBASE: sincronización en tiempo real =================
function guardarEstado(){
    ledRef.set(estadoLEDs).catch(e=>console.warn('Error guardando en Firebase:',e));
}

function cargarEstado(){
  ledRef.on('value',(snapshot)=>{
    const data = snapshot.val();
    if(!data) return;
    ['MULTIPORT','BEDROCK','DROPS'].forEach(grupo=>{
      if(data[grupo]){
        ['linea1','linea2'].forEach(linea=>{
          if(data[grupo][linea] && typeof data[grupo][linea] === 'object'){
            // Asegurarse de que el formato sea un array para evitar errores
            const tempArray = Object.values(data[grupo][linea]);
            estadoLEDs[grupo][linea] = tempArray.slice(0, CONFIG.LED_COUNT);
            while(estadoLEDs[grupo][linea].length < CONFIG.LED_COUNT) estadoLEDs[grupo][linea].push({encendido: false, timestampEncendido: null});
          }
        });
      }
    });
    pintarEstado();
  });
  
  historialRef.on('value', (snapshot) => {
    const logs = snapshot.val();
    const contadores = { MULTIPORT: 0, BEDROCK: 0, DROPS: 0 };
    const tiempos = { MULTIPORT: [], BEDROCK: [], DROPS: [] };
    if (logs) {
      Object.values(logs).forEach(log => {
        if (log.accion === 'encendido' && contadores.hasOwnProperty(log.grupo)) {
          contadores[log.grupo]++;
        } else if (log.accion === 'apagado' && log.tiempoRecoleccion) {
          tiempos[log.grupo].push(log.tiempoRecoleccion);
        }
      });
    }
    
    document.querySelector('.grupo[data-grupo="MULTIPORT"] .tarimas').textContent = `Tarimas: ${contadores.MULTIPORT}`;
    document.querySelector('.grupo[data-grupo="BEDROCK"] .tarimas').textContent = `Tarimas: ${contadores.BEDROCK}`;
    document.querySelector('.grupo[data-grupo="DROPS"] .tarimas').textContent = `Tarimas: ${contadores.DROPS}`;

    // Actualiza los tiempos de recolección en la interfaz
    Object.keys(tiempos).forEach(grupo => {
        const contenedorTiempos = document.querySelector(`.tiempos[data-grupo="${grupo}"]`);
        contenedorTiempos.innerHTML = ''; // Limpiar el contenedor
        tiempos[grupo].forEach((tiempo, index) => {
            const p = document.createElement('p');
            p.textContent = `Tarima ${index + 1}: ${tiempo} minutos`;
            contenedorTiempos.appendChild(p);
        });
    });
  });
}

// ================= PERMISOS Y LÓGICA =================
function puedeControlar(grupo){
  if(!usuarioSeleccionado) {
    return false;
  }
  
  // Si el usuario es SUPERVISOR, no puede controlar nada
  if (usuarioSeleccionado === 'SUPERVISOR') {
    return false;
  }
  
  // LOGÍSTICA puede controlar todos los grupos
  if (usuarioSeleccionado === 'LOGÍSTICA') {
    return true;
  }
  
  // Los demás usuarios solo pueden controlar su propio grupo
  return usuarioSeleccionado === grupo;
}


function togglearLED(grupo, idx, linea='linea1'){
    if(!puedeControlar(grupo)) {
        return alert('No tienes permiso para controlar estos LEDs');
    }

    let accion = '';
    let tiempoRecoleccion = null;
    const estadoActual = estadoLEDs[grupo][linea][idx].encendido;

    // Lógica para LOGÍSTICA
    if (usuarioSeleccionado === 'LOGÍSTICA') {
        if (estadoActual) {
            // Si el LED está encendido, se apaga y se calcula el tiempo.
            const tiempoEncendido = new Date(estadoLEDs[grupo][linea][idx].timestampEncendido);
            const tiempoApagado = new Date();
            const diferencia = (tiempoApagado - tiempoEncendido) / 60000; // Diferencia en minutos
            tiempoRecoleccion = Math.round(diferencia);
            
            estadoLEDs[grupo][linea][idx].encendido = false;
            estadoLEDs[grupo][linea][idx].timestampEncendido = null;
            accion = 'apagado';
            
            guardarEstado();
            pintarEstado();
        } else {
            // Si el LED ya está apagado, se muestra una alerta.
            alert('LOGÍSTICA solo puede apagar LEDs');
            return;
        }
    } else { // Lógica para los demás usuarios
        if (!estadoActual) {
            // Si el LED está apagado, se enciende y se registra el timestamp
            estadoLEDs[grupo][linea][idx] = {
                encendido: true,
                timestampEncendido: new Date().toISOString()
            };
            accion = 'encendido';
        } else {
            // Si el LED está encendido, se apaga
            estadoLEDs[grupo][linea][idx] = {
                encendido: false,
                timestampEncendido: null
            };
            accion = 'apagado';
        }
        guardarEstado();
        pintarEstado();
    }

    // Crea un objeto de registro y lo guarda en Firebase.
    const log = {
        usuario: usuarioSeleccionado,
        grupo: grupo,
        led: `${linea}-${idx+1}`,
        accion: accion,
        timestamp: new Date().toISOString(),
        tiempoRecoleccion: tiempoRecoleccion
    };
    historialRef.push(log).catch(e => console.warn('Error guardando log en Firebase:', e));
}
// ================= NAVEGACIÓN =================
function activarPantalla(id){
  document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa'));
  document.getElementById(id).classList.add('activa');
}

function seleccionarUsuario(usuario) {
    if (!CONFIG.USUARIOS.includes(usuario)) {
        return;
    }

    // Si el usuario es SUPERVISOR, no se le pide contraseña y se avanza directamente
    if (usuario === 'SUPERVISOR') {
        usuarioSeleccionado = usuario;
        document.getElementById('tituloFijo').textContent = CONFIG.TITULO_FIJO;
        activarPantalla('pantalla2');
        inyectaLEDs();
        cargarEstado(); // Firebase sincroniza
        alert(`¡Bienvenido, ${usuario}!`);
    } else {
        // Para los demás usuarios, pedir la contraseña
        const password = prompt(`Introduce la contraseña para ${usuario}:`);
        if (password === CONFIG.PASSWORDS[usuario]) {
            usuarioSeleccionado = usuario;
            document.getElementById('tituloFijo').textContent = CONFIG.TITULO_FIJO;
            activarPantalla('pantalla2');
            inyectaLEDs();
            cargarEstado(); // Firebase sincroniza
            alert(`¡Bienvenido, ${usuario}!`);
        } else {
            alert('Contraseña incorrecta. Inténtalo de nuevo.');
        }
    }
}

// ================= ARRANQUE Y PWA: Service Worker =================
window.addEventListener('load', ()=>{
    const { fecha, turno } = obtenerTurnoActual();
    historialRef = database.ref(`historialLogs/${fecha}/${turno}`);

    usuarioSeleccionado = null;
    activarPantalla('pantalla1');
    inyectaLEDs();
    cargarEstado();

    // Registro del Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => {
                console.log("✅ Service Worker registrado:", reg);
            })
            .catch(err => {
                console.error("❌ Error al registrar Service Worker:", err);
            });
    }
});
</script>
</body>
</html>
