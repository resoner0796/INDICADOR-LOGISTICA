<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Log√≠stica</title>
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --btn-bg: #0066cc;
  --btn-bg-hover: #004c99;
  --grid-size: 26px;
  --vignette: rgba(0,0,0,0.9);
  --titulo-size: clamp(42px,7vw,96px);
  --led-size: 50px;
  --led-gap: 16px;
  --led-off-core: #111;
  --led-off-edge: #000;
  --led-on-core: #0f0;
  --led-on-edge: #063;
  --glow: #00ff88;
  --blink-duration: 0.9s;
}

*{ box-sizing: border-box; }
html, body{ height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:#111; }

.pantalla{ display:none; width:100%; min-height:100vh; }
.pantalla.activa{ display:flex;
flex-direction:column; }

#pantalla1{
  align-items:center;
  justify-content:center;
  flex-direction: column;
  background:linear-gradient(135deg,#222,#444);
  gap:18px;
}
.btn-contenedor{
  display:flex;
  flex-direction:column;
  align-items:center;
}

#pantalla1 h1{ margin:0 0 8px;
}
.usuario-btn{
  background: var(--btn-bg);
  color:#fff;
  border:0;
  padding:14px 28px;
  margin:8px;
  border-radius:10px;
  font-size:18px;
  cursor:pointer;
  transition: background .25s ease;
  outline-color: #000;
}
.usuario-btn:hover{ background: var(--btn-bg-hover); }

#pantalla2{
  background-color:#000;
  background-image:
    radial-gradient(circle, rgba(60,60,60,.28) 20%, transparent 21%),
    radial-gradient(circle, #101010 20%, transparent 21%);
  background-size: var(--grid-size) var(--grid-size);
  box-shadow: inset 0 0 90px var(--vignette);
  overflow-y: auto;
/* Permite el scroll solo en esta pantalla */
}
.header{ display:flex; align-items:center; justify-content:center; padding:16px 20px 6px; position: relative; }
#tituloFijo{
  font-weight:800;
  text-align:center;
  letter-spacing:.5px;
  text-shadow:0 2px 8px rgba(0,0,0,.65);
  font-size:var(--titulo-size);
}
#turnoActual {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 1.2rem;
  font-weight: bold;
  background-color: rgba(0,0,0,0.5);
  padding: 5px 10px;
  border-radius: 5px;
}
.zona-centro{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px 24px 28px;
  flex-direction: column;
}
.grupo-contenedor{
  display: flex;
  flex-wrap: wrap;
  gap: clamp(24px, 4vw, 64px);
  width: min(1200px, 96vw);
  justify-content: center;
}
.grupo.oculto {
  display: none;
}
.grupo{ display:flex; flex-direction:column; align-items:center; text-align:center; }
.grupo .nombre{ font-size: clamp(20px,2.2vw,28px); font-weight:800; margin-bottom:8px; letter-spacing:.5px; text-shadow:0 1px 6px rgba(0,0,0,.5); }
.grupo .tarimas{ font-size: clamp(16px,1.7vw,22px);
  opacity:.9; margin-bottom:14px; }
.leds{ display:flex; gap: var(--led-gap); justify-content:center; align-items:center; flex-wrap:nowrap; padding:4px; }
.led{
  width: var(--led-size);
  height: var(--led-size);
  border-radius:50%;
  cursor:pointer;
  background: radial-gradient(circle at 45% 40%, var(--led-off-core) 40%, var(--led-off-edge) 100%);
  box-shadow: inset -4px -5px 8px rgba(0,0,0,.8), inset 4px 5px 6px rgba(255,255,255,.06), 0 1px 0 rgba(255,255,255,.05);
  transition: transform .1s ease, filter .2s ease, box-shadow .2s ease;
}
.led:active{ transform: scale(.96);
}
.led.on{
  background: radial-gradient(circle at 48% 45%, var(--led-on-core) 40%, var(--led-on-edge) 100%);
  box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  animation: blink var(--blink-duration) ease-in-out infinite;
}
.led.disabled {
    cursor: not-allowed;
    pointer-events: none;
}

.resumen-turno {
  display: flex;
  justify-content: center;
  gap: 40px;
  margin-bottom: 20px;
  background-color: #222;
  border-radius: 12px;
  padding: 15px 30px;
  box-shadow: 0 4px 10px rgba(0,0,0,.3);
  width: min(800px, 90vw);
}
.resumen-turno.oculto {
  display: none;
}
.dato-resumen {
  text-align: center;
}
.dato-resumen .etiqueta {
  font-size: 14px;
  opacity: 0.7;
  text-transform: uppercase;
  margin-bottom: 4px;
}
.dato-resumen .valor {
  font-size: 32px;
  font-weight: bold;
  letter-spacing: 1px;
}
.tiempos{
  margin-top: 10px;
  font-size: 14px;
  opacity: 0.8;
  text-align: left;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
}
.btn-rojo{
  background: #cc0000;
  outline-color: #000;
}
.btn-rojo:hover{
  background: #990000;
}
.footer{
  width: 100%;
  display: flex;
  justify-content: center;
  padding: 20px;
}
.footer .usuario-btn{
  padding: 10px 20px;
  font-size: 16px;
}
.contadores-calidad {
  display: flex;
  gap: 20px;
  justify-content: center;
  margin-top: 10px;
}
.contador-calidad {
  text-align: center;
  font-size: 14px;
  font-weight: bold;
}
.contador-calidad .valor {
  font-size: 20px;
  font-weight: bold;
}
.contador-calidad .etiqueta {
  font-size: 12px;
  opacity: 0.8;
}

@media(max-width:720px){ 
  .grupo-contenedor{ 
    display: flex;
    flex-direction: column;
    gap: 24px;
    width: 100%;
  }
}
@keyframes blink {
  0%, 100% {
    box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  }
  50% {
    box-shadow: 0 0 40px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  }
}
/* ================= CSS DEL MODAL DE CALIDAD ================= */
.modal-calidad {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.modal-calidad.visible {
  visibility: visible;
  opacity: 1;
}
.modal-content {
  background-color: #222;
  padding: 30px;
  border-radius: 10px;
  text-align: center;
  max-width: 90%;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
}
.modal-content h3 {
  margin-top: 0;
  font-size: 24px;
  margin-bottom: 20px;
}
.opciones {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-bottom: 20px;
}
.opcion-btn {
  padding: 15px 25px;
  font-size: 18px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
.opcion-btn[data-color="naranja"] { background-color: #ff9800; color: #fff;
}
.opcion-btn[data-color="rojo"] { background-color: #f44336; color: #fff; }
.opcion-btn[data-color="verde"] { background-color: #4caf50; color: #fff; }
.opcion-btn:hover {
  filter: brightness(1.2);
}
.cerrar-btn {
  background-color: #555;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
}
.cerrar-btn:hover {
  background-color: #777;
}
/* Nuevo CSS para el formulario de rechazo */
#modalRechazo .modal-content {
  text-align: left;
}
#modalRechazo .modal-content h3 {
  text-align: center;
  margin-bottom: 30px;
}
#modalRechazo form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}
#modalRechazo label {
  font-size: 16px;
  margin-bottom: 5px;
  display: block;
}
#modalRechazo input, #modalRechazo textarea {
  width: 100%;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid #555;
  background-color: #333;
  color: #fff;
  font-size: 16px;
}
#modalRechazo textarea {
  resize: vertical;
  min-height: 80px;
}
#modalRechazo button[type="submit"] {
  margin-top: 20px;
  background-color: var(--btn-bg);
  color: #fff;
  border: none;
  padding: 15px;
  border-radius: 8px;
  font-size: 18px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
#modalRechazo button[type="submit"]:hover {
  background-color: var(--btn-bg-hover);
}
.led.naranja {
  background: radial-gradient(circle at 48% 45%, #ff9800 40%, #c17500 100%);
  box-shadow: 0 0 22px #ff9800, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.rojo {
  background: radial-gradient(circle at 48% 45%, #f44336 40%, #d32f2f 100%);
  box-shadow: 0 0 22px #f44336, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.verde {
  background: radial-gradient(circle at 48% 45%, #4caf50 40%, #388e3c 100%);
  box-shadow: 0 0 22px #4caf50, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}

/* ================= CSS PARA PANTALLA 3 (REPORTES) ================= */
#pantalla3 {
  background-color: #f5f5f5;
  color: #333;
  align-items: center;
  justify-content: flex-start;
  padding: 20px;
  overflow-y: auto;
}
#pantalla3 h1 {
  font-size: 2.5rem;
  color: #0066cc;
  margin-bottom: 20px;
}
#pantalla3 .btn-contenedor {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  width: 100%;
  max-width: 800px;
}
#pantalla3 .usuario-btn {
  background-color: #0066cc;
  color: #fff;
  font-size: 1.2rem;
  padding: 15px 30px;
  border-radius: 10px;
  cursor: pointer;
  border: none;
  transition: background-color 0.3s ease;
}
#pantalla3 .usuario-btn:hover {
  background-color: #004c99;
}
#pantalla3 .contenedor-reporte {
  background-color: #fff;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 1200px;
  margin-top: 20px;
}
#pantalla3 .header-reporte {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: space-between;
  margin-bottom: 20px;
}
#pantalla3 .header-reporte h2 {
  color: #0066cc;
  margin: 0;
}
#pantalla3 .header-reporte .filtros {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
}
#pantalla3 .header-reporte .filtros label {
  font-size: 14px;
}
#pantalla3 .header-reporte .filtros input[type="date"],
#pantalla3 .header-reporte .filtros select,
#pantalla3 .header-reporte .filtros input[type="text"] {
  padding: 8px;
  border-radius: 5px;
  border: 1px solid #ccc;
  font-size: 14px;
}
#pantalla3 table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  display: table;
}
#pantalla3 th, #pantalla3 td {
  border: 1px solid #ccc;
  padding: 12px;
  text-align: left;
  font-size: 14px;
}
#pantalla3 thead {
  background-color: #0066cc;
  color: #fff;
}
#pantalla3 tbody tr:nth-child(even) {
  background-color: #f2f2f2;
}
#pantalla3 tbody tr:hover {
  background-color: #ddd;
}
#pantalla3 .resumen-datos {
  display: flex;
  gap: 30px;
  flex-wrap: wrap;
  justify-content: space-around;
  margin-bottom: 20px;
}
#pantalla3 .dato {
  background-color: #f2f2f2;
  padding: 15px;
  border-radius: 8px;
  font-weight: bold;
  text-align: center;
}
#pantalla3 .dato .valor {
  font-size: 24px;
  color: #0066cc;
}
#pantalla3 .dato .etiqueta {
  font-size: 12px;
  text-transform: uppercase;
  color: #666;
}
.botones-reporte {
  margin-top: 20px;
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  flex-wrap: wrap;
}
.grafico-contenedor {
  width: 100%;
  max-width: 600px;
  margin: 20px auto;
}
.opciones-grafico {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
    justify-content: center;
}
.opciones-grafico .usuario-btn {
    padding: 8px 15px;
    font-size: 14px;
}
.reporte-calidad-mobile .tabla-calidad-movil .fila-dato {
    background-color: #f2f2f2;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
}
.reporte-calidad-mobile .tabla-calidad-movil .etiqueta {
    font-weight: bold;
    color: #666;
    display: block;
    font-size: 12px;
}
.reporte-calidad-mobile .tabla-calidad-movil .valor {
    color: #333;
    font-size: 16px;
}
@media (max-width: 768px) {
    #pantalla3 .header-reporte {
        flex-direction: column;
        align-items: flex-start;
    }
    #pantalla3 .header-reporte .filtros {
        width: 100%;
        flex-direction: column;
    }
    #pantalla3 .header-reporte .filtros input,
    #pantalla3 .header-reporte .filtros select {
        width: 100%;
    }
    #pantalla3 .resumen-datos {
        flex-direction: column;
        gap: 15px;
    }
    #pantalla3 .dato {
        width: 100%;
    }
    #pantalla3 table {
        display: none;
        /* Oculta la tabla normal en m√≥viles */
    }
    .reporte-calidad-mobile {
        display: block;
        /* Muestra la tabla m√≥vil */
    }
}
@media (min-width: 769px) {
    .reporte-calidad-mobile {
        display: none;
        /* Oculta la tabla m√≥vil en desktop */
    }
}

/* ================= CSS PARA PANTALLA 4 (DASHBOARD) ================= */
#pantalla4 {
  background-color: #000;
  color: #fff;
  padding: 20px;
  display: grid;
  grid-template-areas:
    "header"
    "filtros"
    "kpis"
    "graficos"
    "pendientes"
    "footer";
  gap: 20px;
  align-content: start;
  overflow-y: auto;
}
#pantalla4 .header {
  grid-area: header;
  text-align: center;
}
#pantalla4 .filtros-dashboard {
  grid-area: filtros;
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 20px;
  align-items: center;
}
#pantalla4 .filtros-dashboard label {
  font-size: 14px;
}
#pantalla4 .filtros-dashboard input[type="date"],
#pantalla4 .filtros-dashboard select {
  padding: 8px;
  border-radius: 5px;
  border: 1px solid #555;
  background-color: #222;
  color: #fff;
}
#pantalla4 .kpis-grid {
  grid-area: kpis;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}
#pantalla4 .kpi-card {
  background-color: #1a1a1a;
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  border: 1px solid #333;
}
#pantalla4 .kpi-card h3 {
  margin-top: 0;
  font-size: 1rem;
  color: #aaa;
  text-transform: uppercase;
}
#pantalla4 .kpi-card .valor {
  font-size: 3rem;
  font-weight: bold;
  color: #00ff88;
  transition: color 0.3s ease;
}
#pantalla4 .kpi-card.alerta .valor {
  color: #ff3333;
}
#pantalla4 .graficos-container {
  grid-area: graficos;
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}
#pantalla4 .graficos-container .panel {
  background-color: #1a1a1a;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  border: 1px solid #333;
}
#pantalla4 .graficos-container h3 {
  text-align: center;
  margin-top: 0;
  margin-bottom: 15px;
  color: #eee;
}
#pantalla4 #tablaPendientes {
  width: 100%;
  border-collapse: collapse;
  color: #fff;
}
#pantalla4 #tablaPendientes th, #pantalla4 #tablaPendientes td {
  padding: 12px;
  border-bottom: 1px solid #444;
  text-align: left;
}
#pantalla4 #tablaPendientes th {
  background-color: #222;
}
#pantalla4 #tablaPendientes tbody tr:hover {
  background-color: #333;
}
#pantalla4 .footer {
  grid-area: footer;
}
@media (min-width: 768px) {
  #pantalla4 {
    grid-template-columns: 1fr 1fr;
    grid-template-areas:
      "header header"
      "filtros filtros"
      "kpis kpis"
      "graficos graficos"
      "pendientes pendientes"
      "footer footer";
  }
  #pantalla4 .graficos-container {
      grid-template-columns: 1fr 1fr;
  }
  .graficos-container > *:nth-child(3) {
      grid-column: span 2;
  }
}
@media (min-width: 1200px) {
  #pantalla4 {
    grid-template-columns: repeat(3, 1fr);
    grid-template-areas:
      "header header header"
      "filtros filtros filtros"
      "kpis kpis kpis"
      "produccion calidad logistica"
      "pendientes pendientes pendientes"
      "footer footer footer";
  }
  #pantalla4 .graficos-container {
    grid-template-columns: 1fr 1fr 1fr;
  }
  .graficos-container > *:nth-child(3) {
      grid-column: span 1;
  }
}
</style>
</head>

<body>

<section id="pantalla1" class="pantalla activa">
<h1 id="mainTitle">Selecciona tu usuario</h1>
<div class="btn-contenedor">
    <button class="usuario-btn" onclick="seleccionarUsuario('LOG√çSTICA')">LOG√çSTICA</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('MULTIPORT')">MULTIPORT</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('DROPS')">DROPS</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('BEDROCK')">BEDROCK</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('SUPERVISOR')">SUPERVISOR</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('CALIDAD')">CALIDAD</button> 
    <button class="usuario-btn" onclick="seleccionarReporte()">REPORTES</button>
    <button class="usuario-btn" onclick="seleccionarDashboard()">DASHBOARD</button>
</div>
</section>

<section id="pantalla2" class="pantalla">
<header class="header">
    <div id="tituloFijo">LOG√çSTICA</div>
    <div id="turnoActual"></div>
</header>
<div class="zona-centro">
    <div id="seccionBusquedaBX" class="zona-centro oculto" style="display: none; align-items: stretch; margin-bottom: 20px;">
        <h2 id="tituloBusqueda">Identificar Tarima</h2>
        <p>Escanea un c√≥digo de caja (BX) para ver el resumen de la tarima.</p>
        <div class="tarima-search-container">
            <input type="text" id="bxInput" placeholder="Escanea o introduce el c√≥digo BX..." onkeypress="handleKey(event)">
            <button class="usuario-btn" id="buscarBtn" onclick="buscarTarimaPorBX()">Buscar</button>
        </div>
        <div id="tarimaInfo" class="resumen-turno oculto">
            <div class="dato-resumen">
                <div class="etiqueta">ID Tarima</div>
                <div id="tarimaId" class="valor"></div>
            </div>
            <div class="dato-resumen">
                <div class="etiqueta">Total Cajas</div>
                <div id="totalCajas" class="valor"></div>
            </div>
            <div class="dato-resumen">
                <div class="etiqueta">Total Piezas</div>
                <div id="totalPiezas" class="valor"></div>
            </div>
        </div>
    </div>
    
    <div id="ledsGeneralContainer" class="grupo-contenedor">
        <div class="grupo" data-grupo="MULTIPORT">
            <div class="nombre">MULTIPORT</div>
            <div class="tarimas">Tarimas: 0</div>
            <div class="leds" data-grupo="MULTIPORT" data-linea="linea1"></div>
            <div class="leds" data-grupo="MULTIPORT" data-linea="linea2"></div>
            <div class="tiempos" data-grupo="MULTIPORT"></div>
        </div>

        <div class="grupo" data-grupo="DROPS">
            <div class="nombre">DROPS</div>
            <div class="tarimas">Tarimas: 0</div>
            <div class="leds" data-grupo="DROPS" data-linea="linea1"></div>
            <div class="leds" data-grupo="DROPS" data-linea="linea2"></div>
            <div class="tiempos" data-grupo="DROPS"></div>
        </div>

        <div class="grupo" data-grupo="BEDROCK">
            <div class="nombre">BEDROCK</div>
            <div class="tarimas">Tarimas: 0</div>
            <div class="leds" data-grupo="BEDROCK" data-linea="linea1"></div>
            <div class="leds" data-grupo="BEDROCK" data-linea="linea2"></div>
            <div class="tiempos" data-grupo="BEDROCK"></div>
        </div>

        <div class="grupo" data-grupo="CALIDAD_MULTIPORT">
            <div class="nombre">CALIDAD MULTIPORT</div>
            <div class="tarimas">Tarimas: 0</div>
            <div class="leds" data-grupo="CALIDAD_MULTIPORT" data-linea="linea1"></div>
            <div class="contadores-calidad">
                <div class="contador-calidad">
                    <span class="valor" id="liberadas_CALIDAD_MULTIPORT">0</span>
                    <div class="etiqueta">Liberadas</div>
                </div>
                <div class="contador-calidad">
                    <span class="valor" id="rechazadas_CALIDAD_MULTIPORT">0</span>
                    <div class="etiqueta">Rechazadas</div>
                </div>
            </div>
            <div class="tiempos" data-grupo="CALIDAD_MULTIPORT"></div>
        </div>

        <div class="grupo" data-grupo="CALIDAD_DROPS">
            <div class="nombre">CALIDAD DROPS</div>
            <div class="tarimas">Tarimas: 0</div>
            <div class="leds" data-grupo="CALIDAD_DROPS" data-linea="linea1"></div>
            <div class="contadores-calidad">
                <div class="contador-calidad">
                    <span class="valor" id="liberadas_CALIDAD_DROPS">0</span>
                    <div class="etiqueta">Liberadas</div>
                </div>
                <div class="contador-calidad">
                    <span class="valor" id="rechazadas_CALIDAD_DROPS">0</span>
                    <div class="etiqueta">Rechazadas</div>
                </div>
            </div>
            <div class="tiempos" data-grupo="CALIDAD_DROPS"></div>
        </div>

        <div class="grupo" data-grupo="CALIDAD_BEDROCK">
            <div class="nombre">CALIDAD BEDROCK</div>
            <div class="tarimas">Tarimas: 0</div>
            <div class="leds" data-grupo="CALIDAD_BEDROCK" data-linea="linea1"></div>
            <div class="contadores-calidad">
                <div class="contador-calidad">
                    <span class="valor" id="liberadas_CALIDAD_BEDROCK">0</span>
                    <div class="etiqueta">Liberadas</div>
                </div>
                <div class="contador-calidad">
                    <span class="valor" id="rechazadas_CALIDAD_BEDROCK">0</span>
                    <div class="etiqueta">Rechazadas</div>
                </div>
            </div>
            <div class="tiempos" data-grupo="CALIDAD_BEDROCK"></div>
        </div>
    </div>
</div>
<div class="footer">
    <button class="usuario-btn btn-rojo" onclick="volverAPantalla1()">Cerrar sesi√≥n</button>
</div>
</section>

<section id="pantalla3" class="pantalla">
<header class="header">
    <h1 id="tituloReportes">REPORTES</h1>
</header>
<div class="zona-centro">
    <div id="selectoresReportes" class="btn-contenedor">
        <button class="usuario-btn" data-reporte="produccion">PRODUCCI√ìN</button>
        <button class="usuario-btn" data-reporte="logistica">LOG√çSTICA</button>
        <button class="usuario-btn" data-reporte="calidad">CALIDAD</button>
        <button class="usuario-btn" data-reporte="resumen">RESUMEN EJECUTIVO</button>
    </div>
    <div id="contenedorReporte" class="contenedor-reporte">
        <h2>Selecciona un reporte</h2>
    </div>
</div>
<div class="footer">
    <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver</button>
</div>
</section>

<section id="pantalla4" class="pantalla" style="display: none;">
<header class="header">
    <h1>DASHBOARD DE SUPERVISOR</h1>
</header>
<div class="filtros-dashboard">
    <label for="fechaDashboard">Fecha:</label>
    <input type="date" id="fechaDashboard">
    <label for="turnoDashboardSelect">Turno:</label>
    <select id="turnoDashboardSelect">
        <option value="todos">Todos</option>
        <option value="Turno 1">Turno 1</option>
        <option value="Turno 2">Turno 2</option>
    </select>
</div>
  <div class="kpis-grid">
    <div class="kpi-card">
        <h3>Tarimas Confirmadas</h3>
        <div class="valor" id="dashTarimasConfirmadas">0</div>
    </div>
    <div class="kpi-card">
        <h3>Tarimas Recolectadas</h3>
        <div class="valor" id="dashTarimasRecolectadas">0</div>
    </div>
    <div class="kpi-card" id="kpiTiempoPromedio">
        <h3>Tiempo Promedio</h3>
        <div class="valor" id="dashTiempoPromedio">0 min</div>
    </div>
    <div class="kpi-card" id="kpiTasaRechazo">
        <h3>Tasa de Rechazo</h3>
        <div class="valor" id="dashTasaRechazo">0%</div>
    </div>
</div>
<div class="graficos-container">
    <div class="panel">
        <h3>Producci√≥n por √Årea</h3>
        <div style="position: relative;
height: 300px;"><canvas id="graficoProduccionDash"></canvas></div>
    </div>
    <div class="panel">
        <h3>Estado de Calidad</h3>
        <div style="position: relative;
height: 300px;"><canvas id="graficoCalidadDash"></canvas></div>
    </div>
    <div class="panel">
        <h3>Evoluci√≥n Tiempos de Recolecci√≥n</h3>
        <div style="position: relative;
height: 300px;"><canvas id="graficoLogisticaDash"></canvas></div>
    </div>
</div>
<div class="panel" style="grid-area: pendientes;">
    <h3>Tarimas Pendientes por Recolectar</h3>
    <table id="tablaPendientes">
        <thead>
            <tr>
                <th>√Årea</th>
                <th>Tarimas Pendientes</th>
            </tr>
        </thead>
      <tbody></tbody>
    </table>
</div>
<div class="footer">
    <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver al inicio</button>
</div>
</section>

<div id="modalCalidad" class="modal-calidad">
<div class="modal-content">
    <h3>Selecciona el estado de la tarima:</h3>
    <div class="opciones">
        <button class="opcion-btn" data-color="naranja">En proceso üü°</button>
        <button class="opcion-btn" data-color="rojo">Rechazada üî¥</button>
        <button class="opcion-btn" data-color="verde">Liberada üü¢</button>
    </div>
    <button class="cerrar-btn" onclick="cerrarModalCalidad()">Cerrar</button>
</div>
</div>
<div id="modalRechazo" class="modal-calidad">
<div class="modal-content">
    <h3>Detalles del Rechazo</h3>
    <form id="formularioRechazo">
        <label for="empleado">Empleado Originador:</label>
        <input type="text" id="empleado" name="empleado" required>
        <label for="linea">L√≠nea afectada:</label>
        <input type="text" id="linea" name="linea" required>
        <label for="parte">No. de parte:</label>
        <input type="text" id="parte" name="parte" required>
        <label for="descripcionParte">Descripci√≥n del No. de parte:</label>
        <input type="text" id="descripcionParte" name="descripcionParte" required>
        <label for="problema">Descripci√≥n del problema:</label>
        <textarea id="problema" name="problema" required></textarea>
        <label for="causa">Causa ra√≠z del problema:</label>
        <textarea id="causa" name="causa" required></textarea>
        <label for="accion">Acci√≥n correctiva:</label>
        <textarea id="accion" name="accion" required></textarea>
        <button type="submit">Guardar Rechazo</button>
    </form>
</div>
</div>
<script>
// ================= CONFIG Y ESTADO =================
const CONFIG = {
  USUARIOS: ['MULTIPORT', 'BEDROCK', 'DROPS', 'LOG√çSTICA', 'SUPERVISOR', 'CALIDAD'],
  PRODUCCION_GRUPOS: ['MULTIPORT', 'BEDROCK', 'DROPS'],
  PASSWORDS: {
    'LOG√çSTICA': 'LOGRAM',
    'MULTIPORT': 'MP25',
    'BEDROCK': 'BR25',
    'DROPS': 'DROP25',
    'SUPERVISOR': 'SUP25',
    'CALIDAD_MULTIPORT': 'AQLMP',
    'CALIDAD_DROPS': 'AQLDP',
    'CALIDAD_BEDROCK': 'AQLBR',
    'REPORTES': 'REPO25',
    'DASHBOARD': 'DASH25'
  },
  LEDS_POR_GRUPO: {
    'MULTIPORT': 5,
    'BEDROCK': 5,
    'DROPS': 5,
    'CALIDAD_MULTIPORT': 5,
    'CALIDAD_BEDROCK': 5,
    'CALIDAD_DROPS': 5
  }
};
let usuarioSeleccionado = null;
let ledActivoParaFormulario = { grupo: null, idx: null, linea: null };
let reporteActual = null;
let datosFiltradosReporte = null;
let miGrafico;
let graficosDashboard = {};
let dashboardUpdateInterval;
const temporizadores = {};
let tarimaEnProceso = null;

// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
  authDomain: "panel-logistica.firebaseapp.com",
  databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
  projectId: "panel-logistica",
  storageBucket: "panel-logistica.appspot.com",
  messagingSenderId: "38365879945",
  appId: "1:38365879945:web:e2f3590fe77f013dba3058"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const db = database;
const ledRef = database.ref('estadoLEDs');
let historialRef;
let contadoresCalidadRef;
let rechazosDetalladosRef;
let dashboardListeners = [];

// ================= FUNCIONES DE CONTROL =================
function activarPantalla(id) {
    document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
    document.getElementById(id).classList.add('activa');
}

function volverAPantalla1() {
    usuarioSeleccionado = null;
    tarimaEnProceso = null;
    document.getElementById('seccionBusquedaBX').classList.add('oculto');
    limpiarInfoTarima();
    if (dashboardUpdateInterval) {
        clearInterval(dashboardUpdateInterval);
    }
    dashboardListeners.forEach(listener => database.ref().off('value', listener));
    dashboardListeners = [];
    activarPantalla('pantalla1');
}

function determinarTurno() {
  const now = new Date();
  const hours = now.getHours();
  const minutes = now.getMinutes();

  if ((hours > 6 || (hours === 6 && minutes >= 30)) && (hours < 18 || (hours === 18 && minutes < 30))) {
    return "Turno 1";
  } else {
    return "Turno 2";
  }
}

// ================= FUNCIONES DE RENDER =================
function inyectaLEDs(){
  document.querySelectorAll('.grupo').forEach(grupoDiv => {
    grupoDiv.classList.add('oculto');
  });

  const gruposVisibles = obtenerGruposVisibles(usuarioSeleccionado);
  gruposVisibles.forEach(grupoId => {
    const grupoDiv = document.querySelector(`.grupo[data-grupo="${grupoId}"]`);
    if (grupoDiv) {
      grupoDiv.classList.remove('oculto');
    }
  });

  document.querySelectorAll('.grupo-contenedor .leds').forEach(contenedor => {
    const grupoLeds = contenedor.dataset.grupo;
    const linea = contenedor.dataset.linea;
    const ledsPorLinea = CONFIG.LEDS_POR_GRUPO[grupoLeds];
    contenedor.innerHTML = '';
    if (ledsPorLinea) {
      for(let i = 0; i < ledsPorLinea; i++){
        const led = document.createElement('div');
        led.className = 'led';
        led.title = `${grupoLeds} ‚Ä¢ ${linea} ‚Ä¢ LED ${i+1}`;
        if (grupoLeds.startsWith('CALIDAD_')) {
            led.addEventListener('click', () => {
                if(tarimaEnProceso) {
                    abrirModalCalidad(grupoLeds, i, linea);
                } else {
                    alert('Por favor, primero busca una tarima.');
                }
            });
        } else {
            led.addEventListener('click', () => togglearLED(grupoLeds, i, linea));
        }
        contenedor.appendChild(led);
      }
    }
  });
}

function iniciarContadorTiempo(idLed, horaEncendido) {
  if (temporizadores[idLed]) {
    clearInterval(temporizadores[idLed]);
  }
  const ledBoton = document.getElementById(idLed);
  const spanTiempo = ledBoton ? ledBoton.querySelector('.tiempo-transcurrido') : null;
  if (!spanTiempo) return;

  const actualizarTiempo = () => {
    const ahora = Date.now();
    const diferencia = ahora - horaEncendido;
    const segundos = Math.floor(diferencia / 1000);
    const minutos = Math.floor(segundos / 60);
    const horas = Math.floor(minutos / 60);

    const texto = `${horas ? horas + 'h ' : ''}${minutos % 60}m ${segundos % 60}s`;
    spanTiempo.textContent = texto;
  };

  actualizarTiempo();
  temporizadores[idLed] = setInterval(actualizarTiempo, 1000);
}

// ================= FUNCIONES DE USUARIOS Y PANTALLAS =================
function seleccionarUsuario(usuario) {
  const password = prompt(`Introduce la contrase√±a para ${usuario}:`);
  const grupoCalidad = usuario.startsWith('CALIDAD_') ? usuario : 'CALIDAD_' + usuario;
  
  if (usuario === 'SUPERVISOR' && password === CONFIG.PASSWORDS[usuario]) {
    usuarioSeleccionado = usuario;
    mostrarPantallaUsuario(usuario);
  } else if (usuario === 'CALIDAD' && password === CONFIG.PASSWORDS['CALIDAD_MULTIPORT']) {
    usuarioSeleccionado = 'CALIDAD_MULTIPORT';
    mostrarPantallaUsuario(usuarioSeleccionado);
  } else if (usuario === 'CALIDAD' && password === CONFIG.PASSWORDS['CALIDAD_DROPS']) {
    usuarioSeleccionado = 'CALIDAD_DROPS';
    mostrarPantallaUsuario(usuarioSeleccionado);
  } else if (usuario === 'CALIDAD' && password === CONFIG.PASSWORDS['CALIDAD_BEDROCK']) {
    usuarioSeleccionado = 'CALIDAD_BEDROCK';
    mostrarPantallaUsuario(usuarioSeleccionado);
  } else if (CONFIG.PRODUCCION_GRUPOS.includes(usuario) && password === CONFIG.PASSWORDS[usuario]) {
    usuarioSeleccionado = usuario;
    mostrarPantallaUsuario(usuario);
  } else if (usuario === 'LOG√çSTICA' && password === CONFIG.PASSWORDS[usuario]) {
    usuarioSeleccionado = usuario;
    mostrarPantallaUsuario(usuario);
  } else {
    alert("Contrase√±a incorrecta.");
  }
}

function mostrarPantallaUsuario(usuario) {
    document.getElementById('tituloFijo').textContent = usuario.toUpperCase().replace('_', ' ');
    document.querySelector('.grupo-contenedor').classList.remove('oculto');
    document.getElementById('resumenTurno').classList.add('oculto');
    document.getElementById('seccionBusquedaBX').classList.add('oculto');

    if (usuario === 'SUPERVISOR') {
        document.getElementById('resumenTurno').classList.remove('oculto');
    }

    if (usuario !== 'SUPERVISOR') {
        document.getElementById('seccionBusquedaBX').classList.remove('oculto');
        document.getElementById('buscarBtn').textContent = 'Buscar';
    }

    if (usuario.startsWith('CALIDAD_')) {
        document.getElementById('tituloBusqueda').textContent = 'INSPECCI√ìN DE CALIDAD';
        document.getElementById('buscarBtn').textContent = 'Buscar Tarima';
    } else {
        document.getElementById('tituloBusqueda').textContent = 'Identificar Tarima';
    }
    
    inyectaLEDs();
    activarPantalla('pantalla2');
    setupFirebaseListeners();
}

function obtenerGruposVisibles(usuario) {
    switch(usuario) {
        case 'SUPERVISOR':
            return ['MULTIPORT', 'BEDROCK', 'DROPS', 'CALIDAD_MULTIPORT', 'CALIDAD_BEDROCK', 'CALIDAD_DROPS'];
        case 'LOG√çSTICA':
            return ['MULTIPORT', 'BEDROCK', 'DROPS'];
        case 'MULTIPORT':
        case 'BEDROCK':
        case 'DROPS':
            return [usuario, `CALIDAD_${usuario}`];
        case 'CALIDAD_MULTIPORT':
        case 'CALIDAD_DROPS':
        case 'CALIDAD_BEDROCK':
            return [usuario];
        default:
            return [];
    }
}

// ================= NUEVAS FUNCIONES DE B√öSQUEDA Y VALIDACI√ìN =================
async function buscarTarimaPorBX() {
    const bxCode = document.getElementById('bxInput').value.trim();
    if (bxCode === '') {
        alert("Por favor, introduce un c√≥digo de caja (BX) para buscar.");
        return;
    }

    limpiarInfoTarima();
    document.getElementById('tarimaInfo').style.display = 'none';
    tarimaEnProceso = null;

    const tarimasRef = database.ref('tarimas');
    let tarimaEncontrada = null;

    try {
        const snapshot = await tarimasRef.once('value');
        snapshot.forEach((tarimaSnapshot) => {
            const tarimaData = tarimaSnapshot.val();
            const cajas = tarimaData.cajas;
            if (cajas) {
                if (Object.values(cajas).some(caja => caja.codigoCaja === bxCode)) {
                    tarimaEncontrada = {
                        id: tarimaSnapshot.key,
                        totalCajas: Object.keys(cajas).length,
                        totalPiezas: Object.values(cajas).reduce((sum, caja) => sum + (caja.cantidadPiezas || 0), 0)
                    };
                    return true;
                }
            }
        });
    } catch (err) {
        console.error("Error al buscar tarima por BX:", err);
        alert("Hubo un error al buscar. Intenta de nuevo.");
        return;
    }

    if (tarimaEncontrada) {
        tarimaEnProceso = tarimaEncontrada;
        mostrarInfoTarima(tarimaEncontrada);
    } else {
        alert("No se encontr√≥ ninguna tarima con ese c√≥digo de caja (BX).");
        limpiarInfoTarima();
    }
}

function handleKey(event) {
  if (event.key === 'Enter') {
    buscarTarimaPorBX();
    event.preventDefault();
  }
}

function mostrarInfoTarima(data) {
    document.getElementById('tarimaId').textContent = data.id;
    document.getElementById('totalCajas').textContent = data.totalCajas;
    document.getElementById('totalPiezas').textContent = data.totalPiezas;
    document.getElementById('tarimaInfo').classList.remove('oculto');
    document.getElementById('tarimaInfo').style.display = 'flex';
}

function limpiarInfoTarima() {
    document.getElementById('tarimaId').textContent = '';
    document.getElementById('totalCajas').textContent = '';
    document.getElementById('totalPiezas').textContent = '';
    document.getElementById('tarimaInfo').classList.add('oculto');
    document.getElementById('tarimaInfo').style.display = 'none';
}

// ================= FUNCIONES DE LEDS Y MODALES =================
function abrirModalCalidad(grupo, ledIdx, linea) {
    if (!tarimaEnProceso) {
        alert("Por favor, busca y selecciona una tarima primero.");
        return;
    }
    ledActivoParaFormulario = { grupo: grupo, idx: ledIdx, linea: linea, tarimaId: tarimaEnProceso.id };
    const modal = document.getElementById('modalCalidad');
    modal.classList.add('visible');
    
    const opcionBtns = modal.querySelectorAll('.opcion-btn');
    opcionBtns.forEach(btn => {
        btn.onclick = () => manejarSeleccionCalidad(btn.dataset.color);
    });
}

function cerrarModalCalidad() {
    document.getElementById('modalCalidad').classList.remove('visible');
}

function manejarSeleccionCalidad(estadoColor) {
    if (!ledActivoParaFormulario.tarimaId) {
        alert("No hay una tarima en proceso.");
        cerrarModalCalidad();
        return;
    }

    const { tarimaId, grupo, idx, linea } = ledActivoParaFormulario;
    let nuevoEstado = '';
    let nuevoColor = '';

    switch (estadoColor) {
        case 'verde':
            nuevoEstado = 'Liberada';
            nuevoColor = 'verde';
            break;
        case 'naranja':
            nuevoEstado = 'En proceso';
            nuevoColor = 'naranja';
            break;
        case 'rojo':
            nuevoEstado = 'Rechazada';
            nuevoColor = 'rojo';
            break;
    }
    
    const ledPath = `estadoLEDs/${grupo}/${idx}`;
    const actualizaciones = {};
    actualizaciones[ledPath] = {
        tarima: tarimaId,
        encendido: true,
        horaEncendido: Date.now(),
        color: nuevoColor,
        estado: nuevoEstado,
        linea: linea
    };
    
    db.ref().update(actualizaciones)
    .then(() => {
        console.log("Estado de tarima actualizado en Firebase.");
        alert(`Tarima ${tarimaId} actualizada a estado: ${nuevoEstado}`);
        
        if (nuevoEstado === 'Rechazada') {
            document.getElementById('modalCalidad').classList.remove('visible');
            document.getElementById('modalRechazo').classList.add('visible');
        } else {
            cerrarModalCalidad();
            limpiarInfoTarima(); // Limpiamos la info despu√©s de liberar
        }
    })
    .catch(error => {
        console.error("Error al actualizar el estado de la tarima:", error);
        alert("Error al actualizar el estado. Int√©ntalo de nuevo.");
    });
}

document.getElementById('formularioRechazo').addEventListener('submit', (event) => {
    event.preventDefault();
    const form = event.target;
    const rechazoData = {
        empleado: form.empleado.value,
        linea: form.linea.value,
        parte: form.parte.value,
        descripcionParte: form.descripcionParte.value,
        problema: form.problema.value,
        causa: form.causa.value,
        accion: form.accion.value,
        tarimaId: ledActivoParaFormulario.tarimaId,
        timestamp: Date.now()
    };
    
    const rechazosRef = database.ref('rechazosDetallados').push();
    rechazosRef.set(rechazoData)
    .then(() => {
        alert("Rechazo guardado exitosamente.");
        document.getElementById('modalRechazo').classList.remove('visible');
        limpiarInfoTarima();
        form.reset();
    })
    .catch(error => {
        console.error("Error al guardar el rechazo:", error);
        alert("Error al guardar el rechazo. Int√©ntalo de nuevo.");
    });
});

// ================= FUNCIONES DE REPORTES =================
function seleccionarReporte() {
    const password = prompt('Introduce la contrase√±a para ver los reportes:');
    if (password === CONFIG.PASSWORDS['REPORTES']) {
        activarPantalla('pantalla3');
        document.getElementById('contenedorReporte').innerHTML = '<h2>Selecciona un reporte</h2>';
        const selectores = document.getElementById('selectoresReportes').querySelectorAll('.usuario-btn');
        selectores.forEach(btn => btn.addEventListener('click', () => {
            const tipoReporte = btn.dataset.reporte;
            mostrarReporte(tipoReporte);
        }));
    } else {
        alert('Contrase√±a incorrecta.');
    }
}
async function mostrarReporte(tipoReporte) {
  reporteActual = tipoReporte;
  const contenedor = document.getElementById('contenedorReporte');
  contenedor.innerHTML = '';
  document.getElementById('tituloReportes').textContent = 'Reporte de ' + tipoReporte.charAt(0).toUpperCase() + tipoReporte.slice(1);

  const loadingDiv = document.createElement('div');
  loadingDiv.textContent = 'Cargando datos...';
  contenedor.appendChild(loadingDiv);

  let datos = {};
  try {
    const snapshot = await db.ref('historial').once('value');
    datos = snapshot.val() || {};
  } catch (error) {
    console.error("Error al obtener datos del historial:", error);
    loadingDiv.textContent = 'Error al cargar los datos.';
    return;
  }
  
  datosFiltradosReporte = Object.values(datos).filter(d => {
    if (tipoReporte === 'calidad') {
        return d.tipo.startsWith('CALIDAD');
    }
    if (tipoReporte === 'logistica') {
        return d.tipo === 'RECOLECCI√ìN';
    }
    if (tipoReporte === 'produccion') {
        return ['MULTIPORT', 'DROPS', 'BEDROCK'].includes(d.tipo);
    }
    if (tipoReporte === 'resumen') {
        return true;
    }
    return false;
  });

  if (datosFiltradosReporte.length === 0) {
    loadingDiv.textContent = 'No hay datos para este reporte.';
    return;
  }
  
  loadingDiv.style.display = 'none';
  renderizarReporte(tipoReporte);
}
function renderizarReporte(tipoReporte) {
  const contenedor = document.getElementById('contenedorReporte');
  contenedor.innerHTML = '';
  
  const headerReporte = document.createElement('div');
  headerReporte.className = 'header-reporte';
  headerReporte.innerHTML = `<h2>${tipoReporte.toUpperCase()}</h2>`;

  const filtrosDiv = document.createElement('div');
  filtrosDiv.className = 'filtros';
  filtrosDiv.innerHTML = `
      <label>Fecha: <input type="date" id="filtroFecha"></label>
      <label>Turno: <select id="filtroTurno">
          <option value="todos">Todos</option>
          <option value="Turno 1">Turno 1</option>
          <option value="Turno 2">Turno 2</option>
      </select></label>
      ${tipoReporte !== 'resumen' ? `<label>√Årea: <select id="filtroArea"></select></label>` : ''}
  `;
  headerReporte.appendChild(filtrosDiv);
  contenedor.appendChild(headerReporte);
  
  const botoneraReporte = document.createElement('div');
  botoneraReporte.className = 'botones-reporte';
  botoneraReporte.innerHTML = `
      <button class="usuario-btn" onclick="exportarExcel('${tipoReporte}')">Exportar a Excel</button>
      <button class="usuario-btn" onclick="exportarPDF('${tipoReporte}')">Exportar a PDF</button>
  `;
  contenedor.appendChild(botoneraReporte);

  const tablaHtml = `
      <table>
          <thead>
              <tr>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th>ID Tarima</th>
                  <th>Usuario</th>
                  <th>Acci√≥n</th>
                  <th>Tiempo</th>
              </tr>
          </thead>
          <tbody></tbody>
      </table>
  `;
  contenedor.insertAdjacentHTML('beforeend', tablaHtml);

  // Inicializar select de √°rea
  const filtroArea = document.getElementById('filtroArea');
  if (filtroArea) {
    const areas = [...new Set(datosFiltradosReporte.map(d => d.area))];
    areas.forEach(area => {
      const option = document.createElement('option');
      option.value = area;
      option.textContent = area;
      filtroArea.appendChild(option);
    });
  }
  
  // Event listeners para los filtros
  document.getElementById('filtroFecha')?.addEventListener('change', () => aplicarFiltros(tipoReporte));
  document.getElementById('filtroTurno')?.addEventListener('change', () => aplicarFiltros(tipoReporte));
  document.getElementById('filtroArea')?.addEventListener('change', () => aplicarFiltros(tipoReporte));
  
  aplicarFiltros(tipoReporte);
}
function aplicarFiltros(tipoReporte) {
  const fecha = document.getElementById('filtroFecha')?.value;
  const turno = document.getElementById('filtroTurno')?.value;
  const area = document.getElementById('filtroArea')?.value;

  let datosFiltrados = datosFiltradosReporte.filter(d => {
      let cumpleFecha = true;
      if (fecha) {
          const fechaEvento = new Date(d.timestamp).toISOString().split('T')[0];
          cumpleFecha = fechaEvento === fecha;
      }
      let cumpleTurno = true;
      if (turno !== 'todos') {
          cumpleTurno = d.turno === turno;
      }
      let cumpleArea = true;
      if (area && area !== 'todos') {
          cumpleArea = d.area === area;
      }
      return cumpleFecha && cumpleTurno && cumpleArea;
  });

  const tbody = document.querySelector('#contenedorReporte tbody');
  tbody.innerHTML = '';
  datosFiltrados.forEach(dato => {
      const fechaHora = new Date(dato.timestamp);
      const fechaStr = fechaHora.toLocaleDateString();
      const horaStr = fechaHora.toLocaleTimeString();
      const fila = `
          <tr>
              <td>${fechaStr}</td>
              <td>${horaStr}</td>
              <td>${dato.tarima || 'N/A'}</td>
              <td>${dato.usuario}</td>
              <td>${dato.accion}</td>
              <td>${dato.tiempo ? `${(dato.tiempo / 1000).toFixed(2)}s` : 'N/A'}</td>
          </tr>
      `;
      tbody.insertAdjacentHTML('beforeend', fila);
  });
}

// ================= FUNCIONES DE DASHBOARD =================
function seleccionarDashboard() {
  const password = prompt('Introduce la contrase√±a para el Dashboard:');
  if (password === CONFIG.PASSWORDS['DASHBOARD']) {
    activarPantalla('pantalla4');
    setupDashboard();
  } else {
    alert('Contrase√±a incorrecta.');
  }
}
function setupDashboard() {
  const fechaInput = document.getElementById('fechaDashboard');
  const turnoSelect = document.getElementById('turnoDashboardSelect');
  fechaInput.value = new Date().toISOString().split('T')[0];
  fechaInput.addEventListener('change', updateDashboard);
  turnoSelect.addEventListener('change', updateDashboard);
  updateDashboard();
}

function updateDashboard() {
  const fechaSeleccionada = document.getElementById('fechaDashboard').value;
  const turnoSeleccionado = document.getElementById('turnoDashboardSelect').value;

  db.ref('historial').once('value', snapshot => {
    const historial = snapshot.val();
    let datosFiltrados = Object.values(historial).filter(item => {
      const fechaItem = new Date(item.timestamp).toISOString().split('T')[0];
      const turnoItem = item.turno;
      let cumpleFiltro = fechaItem === fechaSeleccionada;
      if (turnoSeleccionado !== 'todos') {
        cumpleFiltro = cumpleFiltro && (turnoItem === turnoSeleccionado);
      }
      return cumpleFiltro;
    });

    const datosProduccion = datosFiltrados.filter(d => ['MULTIPORT', 'BEDROCK', 'DROPS'].includes(d.area));
    const datosCalidad = datosFiltrados.filter(d => d.area && d.area.startsWith('CALIDAD_'));
    const datosLogistica = datosFiltrados.filter(d => d.area === 'LOG√çSTICA');

    // KPIs
    const tarimasConfirmadas = datosProduccion.length;
    const tarimasRecolectadas = datosLogistica.length;
    const tiemposRecoleccion = datosLogistica.map(d => d.tiempo).filter(t => t);
    const tiempoPromedio = tiemposRecoleccion.length > 0 ? (tiemposRecoleccion.reduce((a, b) => a + b) / tiemposRecoleccion.length / 1000).toFixed(2) : '0';
    
    const rechazos = datosCalidad.filter(d => d.accion === 'Rechazada');
    const liberadas = datosCalidad.filter(d => d.accion === 'Liberada');
    const tasaRechazo = liberadas.length + rechazos.length > 0 ? ((rechazos.length / (liberadas.length + rechazos.length)) * 100).toFixed(1) : '0';

    document.getElementById('dashTarimasConfirmadas').textContent = tarimasConfirmadas;
    document.getElementById('dashTarimasRecolectadas').textContent = tarimasRecolectadas;
    document.getElementById('dashTiempoPromedio').textContent = `${tiempoPromedio}s`;
    document.getElementById('dashTasaRechazo').textContent = `${tasaRechazo}%`;

    // Gr√°ficos
    const produccionPorArea = contarPorCampo(datosProduccion, 'area');
    const estadoCalidad = contarPorCampo(datosCalidad, 'accion');
    const evolucionLogistica = datosLogistica.map(d => ({
        hora: new Date(d.timestamp).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }),
        tiempo: (d.tiempo / 1000)
    }));

    renderizarGrafico('graficoProduccionDash', 'bar', Object.keys(produccionPorArea), Object.values(produccionPorArea), 'Tarimas');
    renderizarGrafico('graficoCalidadDash', 'doughnut', Object.keys(estadoCalidad), Object.values(estadoCalidad), 'Estado');
    renderizarGrafico('graficoLogisticaDash', 'line', evolucionLogistica.map(d => d.hora), evolucionLogistica.map(d => d.tiempo), 'Tiempo de recolecci√≥n (s)');
    
    // Tabla de pendientes
    const pendientesPorArea = {};
    Object.keys(CONFIG.LEDS_POR_GRUPO).forEach(grupo => {
        if (!grupo.startsWith('CALIDAD_')) {
            const ledsOcupados = Object.values(historial).filter(h => h.area === grupo && h.accion === 'LED encendido').length;
            pendientesPorArea[grupo] = ledsOcupados;
        }
    });
    renderizarTablaPendientes(pendientesPorArea);

  });
}
function contarPorCampo(datos, campo) {
    return datos.reduce((acc, item) => {
        if (item[campo]) {
            acc[item[campo]] = (acc[item[campo]] || 0) + 1;
        }
        return acc;
    }, {});
}
function renderizarGrafico(canvasId, tipo, labels, data, label) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (graficosDashboard[canvasId]) {
        graficosDashboard[canvasId].destroy();
    }
    graficosDashboard[canvasId] = new Chart(ctx, {
        type: tipo,
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                backgroundColor: tipo === 'doughnut' ? ['#4caf50', '#f44336', '#ff9800'] : '#0066cc',
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: tipo === 'doughnut' },
                title: { display: false }
            },
            scales: tipo !== 'doughnut' ? {
                y: { beginAtZero: true }
            } : {}
        }
    });
}
function renderizarTablaPendientes(datos) {
    const tbody = document.querySelector('#tablaPendientes tbody');
    tbody.innerHTML = '';
    for (const area in datos) {
        const fila = document.createElement('tr');
        fila.innerHTML = `<td>${area}</td><td>${datos[area]}</td>`;
        tbody.appendChild(fila);
    }
}
</script>
</body>
</html>
