<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Logรญstica</title>
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
ย --btn-bg: #0066cc;
ย --btn-bg-hover: #004c99;
ย --grid-size: 26px;
ย --vignette: rgba(0,0,0,0.9);
ย --titulo-size: clamp(42px,7vw,96px);
ย --led-size: 60px; /* Un poco mรกs grande para el ID */
ย --led-gap: 16px;
ย --led-off-core: #111;
ย --led-off-edge: #000;
ย --led-on-core: #0f0;
ย --led-on-edge: #063;
ย --glow: #00ff88;
ย --blink-duration: 0.9s;
}

*{ box-sizing: border-box; }
html, body{ height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:#111; }

.pantalla{ display:none; width:100%; min-height:100vh; }
.pantalla.activa{ display:flex; flex-direction:column; }

#pantalla1{
ย align-items:center;
ย justify-content:center;
ย flex-direction: column;
ย background:linear-gradient(135deg,#222,#444);
ย gap:18px;
}
.btn-contenedor{
ย display:flex;
ย flex-direction:column;
ย align-items:center;
}

#pantalla1 h1{ margin:0 0 8px; }
.usuario-btn{
ย background: var(--btn-bg);
ย color:#fff;
ย border:0;
ย padding:14px 28px;
ย margin:8px;
ย border-radius:10px;
ย font-size:18px;
ย cursor:pointer;
ย transition: background .25s ease;
ย outline-color: #000;
}
.usuario-btn:hover{ background: var(--btn-bg-hover); }

#pantalla2{
ย background-color:#000;
ย background-image:
ย ย radial-gradient(circle, rgba(60,60,60,.28) 20%, transparent 21%),
ย ย radial-gradient(circle, #101010 20%, transparent 21%);
ย background-size: var(--grid-size) var(--grid-size);
ย box-shadow: inset 0 0 90px var(--vignette);
ย overflow-y: auto; /* Permite el scroll solo en esta pantalla */
}
.header{ display:flex; align-items:center; justify-content:center; padding:16px 20px 6px; position: relative; }
#tituloFijo{
ย font-weight:800;
ย text-align:center;
ย letter-spacing:.5px;
ย text-shadow:0 2px 8px rgba(0,0,0,.65);
ย font-size:var(--titulo-size);
}
#turnoActual {
ย position: absolute;
ย top: 10px;
ย right: 10px;
ย font-size: 1.2rem;
ย font-weight: bold;
ย background-color: rgba(0,0,0,0.5);
ย padding: 5px 10px;
ย border-radius: 5px;
}
.zona-centro{
ย flex:1;
ย display:flex;
ย align-items:center;
ย justify-content:center;
ย padding:10px 24px 28px;
ย flex-direction: column;
}
.grupo-contenedor{
ย display: flex;
ย flex-wrap: wrap;
ย gap: clamp(24px, 4vw, 64px);
ย width: min(1200px, 96vw);
ย justify-content: center;
}
.grupo.oculto {
ย display: none;
}
.grupo{ display:flex; flex-direction:column; align-items:center; text-align:center; }
.grupo .nombre{ font-size: clamp(20px,2.2vw,28px); font-weight:800; margin-bottom:8px; letter-spacing:.5px; text-shadow:0 1px 6px rgba(0,0,0,.5); }
.grupo .tarimas{ font-size: clamp(16px,1.7vw,22px); opacity:.9; margin-bottom:14px; }
.leds{ display:flex; gap: var(--led-gap); justify-content:center; align-items:center; flex-wrap:nowrap; padding:4px; }
.led{
ย width: var(--led-size);
ย height: var(--led-size);
ย border-radius:50%;
ย cursor:pointer;
ย background: radial-gradient(circle at 45% 40%, var(--led-off-core) 40%, var(--led-off-edge) 100%);
ย box-shadow: inset -4px -5px 8px rgba(0,0,0,.8), inset 4px 5px 6px rgba(255,255,255,.06), 0 1px 0 rgba(255,255,255,.05);
ย transition: transform .1s ease, filter .2s ease, box-shadow .2s ease;
  /* Estilos para centrar el texto del ID */
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  font-size: 14px;
  color: #fff;
  text-shadow: 1px 1px 2px black;
}
.led:active{ transform: scale(.96); }
.led.on{
ย background: radial-gradient(circle at 48% 45%, var(--led-on-core) 40%, var(--led-on-edge) 100%);
ย box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
ย animation: blink var(--blink-duration) ease-in-out infinite;
}
.led.disabled {
ย ย cursor: not-allowed;
ย ย pointer-events: none;
}

.resumen-turno {
ย display: flex;
ย justify-content: center;
ย gap: 40px;
ย margin-bottom: 20px;
ย background-color: #222;
ย border-radius: 12px;
ย padding: 15px 30px;
ย box-shadow: 0 4px 10px rgba(0,0,0,.3);
ย width: min(800px, 90vw);
}
.resumen-turno.oculto {
ย display: none;
}
.dato-resumen {
ย text-align: center;
}
.dato-resumen .etiqueta {
ย font-size: 14px;
ย opacity: 0.7;
ย text-transform: uppercase;
ย margin-bottom: 4px;
}
.dato-resumen .valor {
ย font-size: 32px;
ย font-weight: bold;
ย letter-spacing: 1px;
}
.tiempos{
ย margin-top: 10px;
ย font-size: 14px;
ย opacity: 0.8;
ย text-align: left;
ย width: 100%;
ย max-height: 200px;
ย overflow-y: auto;
}
.btn-rojo{
ย background: #cc0000;
ย outline-color: #000;
}
.btn-rojo:hover{
ย background: #990000;
}
.footer{
ย width: 100%;
ย display: flex;
ย justify-content: center;
ย padding: 20px;
}
.footer .usuario-btn{
ย padding: 10px 20px;
ย font-size: 16px;
}
.contadores-calidad {
ย display: flex;
ย gap: 20px;
ย justify-content: center;
ย margin-top: 10px;
}
.contador-calidad {
ย text-align: center;
ย font-size: 14px;
ย font-weight: bold;
}
.contador-calidad .valor {
ย font-size: 20px;
ย font-weight: bold;
}
.contador-calidad .etiqueta {
ย font-size: 12px;
ย opacity: 0.8;
}

@media(max-width:720px){ย
ย .grupo-contenedor{ย
ย ย display: flex;
ย ย flex-direction: column;
ย ย gap: 24px;
ย ย width: 100%;
ย }
}
@keyframes blink {
ย 0%, 100% {
ย ย box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
ย }
ย 50% {
ย ย box-shadow: 0 0 40px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
ย }
}

/* Estilos base para ocultar los modales */
.modal-calidad,
.modal {
ย position: fixed;
ย top: 0;
ย left: 0;
ย width: 100%;
ย height: 100%;
ย background-color: rgba(0, 0, 0, 0.8);
ย display: flex;
ย justify-content: center;
ย align-items: center;
ย z-index: 1000;
ย visibility: hidden;
ย opacity: 0;
ย transition: opacity 0.3s ease, visibility 0.3s ease;
}

/* Esta clase es la que tu JavaScript debe agregar para mostrar el modal */
.modal-calidad.visible,
.modal.visible {
ย visibility: visible;
ย opacity: 1;
}

/* Estilos de los contenedores de los modales (los que ya tenรญas) */
#modalCalidad .modal-content,
#modalRechazo .modal-content,
#modalOpcionesCalidad .modal-content,
#modalAsignarTarimaProduccion .modal-content {
ย background-color: #1c1c1c !important;
ย color: #eee !important;
ย padding: 25px 35px;
ย border-radius: 12px;
ย text-align: center;
ย max-width: 450px;
ย width: 90%;
ย box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}
ยย
/* ================= CSS DEL MODAL DE CALIDAD ================= */
#modalCalidad .modal-content,
#modalRechazo .modal-content {
ย background-color: #1c1c1c !important;
ย color: #eee !important;
ย padding: 25px 35px;
ย border-radius: 12px;
ย text-align: center;
ย max-width: 450px;
ย width: 90%;
ย box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}
#modalCalidad h3,
#modalRechazo h3 {
ย color: #f0f0f0 !important;
}
#modalCalidad .opciones-btn,
#modalRechazo .opciones-btn {
ย padding: 12px 20px;
ย font-size: 16px;
ย font-weight: bold;
ย border: none;
ย border-radius: 6px;
ย cursor: pointer;
ย transition: transform 0.15s ease;
}
#modalCalidad .opcion-btn[data-color="rojo"] { background: #d32f2f; color: #fff; }
#modalCalidad .opcion-btn[data-color="verde"] { background: #2e7d32; color: #fff; }
#modalCalidad .opcion-btn:hover { transform: scale(1.05); }


/* Nuevo CSS para el formulario de rechazo */
#modalRechazo .modal-content {
ย text-align: left;
}
#modalRechazo .modal-content h3 {
ย text-align: center;
ย margin-bottom: 30px;
}
#modalRechazo form {
ย display: flex;
ย flex-direction: column;
ย gap: 15px;
}
#modalRechazo label {
ย font-size: 16px;
ย margin-bottom: 5px;
ย display: block;
}
#modalRechazo input, #modalRechazo textarea {
ย width: 100%;
ย padding: 10px;
ย border-radius: 5px;
ย border: 1px solid #555;
ย background-color: #333;
ย color: #fff;
ย font-size: 16px;
}
#modalRechazo textarea {
ย resize: vertical;
ย min-height: 80px;
}
#modalRechazo button[type="submit"] {
ย margin-top: 20px;
ย background-color: var(--btn-bg);
ย color: #fff;
ย border: none;
ย padding: 15px;
ย border-radius: 8px;
ย font-size: 18px;
ย cursor: pointer;
ย transition: background-color 0.3s ease;
}
#modalRechazo button[type="submit"]:hover {
ย background-color: var(--btn-bg-hover);
}

#modalRechazo .modal-actions {
ย display: flex;
ย justify-content: space-between;
ย margin-top: 20px;
}
#modalRechazo .modal-actions button {
ย flex: 1;
ย margin: 0 5px;
}
ยย
.led.naranja {
ย background: radial-gradient(circle at 48% 45%, #ff9800 40%, #c17500 100%);
ย box-shadow: 0 0 22px #ff9800, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.rojo {
ย background: radial-gradient(circle at 48% 45%, #f44336 40%, #d32f2f 100%);
ย box-shadow: 0 0 22px #f44336, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.verde {
ย background: radial-gradient(circle at 48% 45%, #4caf50 40%, #388e3c 100%);
ย box-shadow: 0 0 22px #4caf50, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}

/* ================= CSS PARA PANTALLA 3 (REPORTES) ================= */
#pantalla3 {
ย background-color: #f5f5f5;
ย color: #333;
ย align-items: center;
ย justify-content: flex-start;
ย padding: 20px;
ย overflow-y: auto;
}
#pantalla3 h1 {
ย font-size: 2.5rem;
ย color: #0066cc;
ย margin-bottom: 20px;
}
#pantalla3 .btn-contenedor {
ย display: flex;
ย flex-direction: row;
ย flex-wrap: wrap;
ย justify-content: center;
ย gap: 15px;
ย width: 100%;
ย max-width: 800px;
}
#pantalla3 .usuario-btn {
ย background-color: #0066cc;
ย color: #fff;
ย font-size: 1.2rem;
ย padding: 15px 30px;
ย border-radius: 10px;
ย cursor: pointer;
ย border: none;
ย transition: background-color 0.3s ease;
}
#pantalla3 .usuario-btn:hover {
ย background-color: #004c99;
}
#pantalla3 .contenedor-reporte {
ย background-color: #fff;
ย border-radius: 10px;
ย padding: 20px;
ย box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
ย width: 100%;
ย max-width: 1200px;
ย margin-top: 20px;
}
#pantalla3 .header-reporte {
ย display: flex;
ย align-items: center;
ย flex-wrap: wrap;
ย gap: 10px;
ย justify-content: space-between;
ย margin-bottom: 20px;
}
#pantalla3 .header-reporte h2 {
ย color: #0066cc;
ย margin: 0;
}
#pantalla3 .header-reporte .filtros {
ย display: flex;
ย flex-wrap: wrap;
ย gap: 10px;
ย align-items: center;
}
#pantalla3 .header-reporte .filtros label {
ย font-size: 14px;
}
#pantalla3 .header-reporte .filtros input[type="date"],
#pantalla3 .header-reporte .filtros select,
#pantalla3 .header-reporte .filtros input[type="text"] {
ย padding: 8px;
ย border-radius: 5px;
ย border: 1px solid #ccc;
ย font-size: 14px;
}
#pantalla3 table {
ย width: 100%;
ย border-collapse: collapse;
ย margin-top: 20px;
ย display: table;
}
#pantalla3 th, #pantalla3 td {
ย border: 1px solid #ccc;
ย padding: 12px;
ย text-align: left;
ย font-size: 14px;
}
#pantalla3 thead {
ย background-color: #0066cc;
ย color: #fff;
}
#pantalla3 tbody tr:nth-child(even) {
ย background-color: #f2f2f2;
}
#pantalla3 tbody tr:hover {
ย background-color: #ddd;
}
#pantalla3 .resumen-datos {
ย display: flex;
ย gap: 30px;
ย flex-wrap: wrap;
ย justify-content: space-around;
ย margin-bottom: 20px;
}
#pantalla3 .dato {
ย background-color: #f2f2f2;
ย padding: 15px;
ย border-radius: 8px;
ย font-weight: bold;
ย text-align: center;
}
#pantalla3 .dato .valor {
ย font-size: 24px;
ย color: #0066cc;
}
#pantalla3 .dato .etiqueta {
ย font-size: 12px;
ย text-transform: uppercase;
ย color: #666;
}
.botones-reporte {
ย margin-top: 20px;
ย display: flex;
ย gap: 15px;
ย justify-content: flex-end;
ย flex-wrap: wrap;
}
.grafico-contenedor {
ย width: 100%;
ย max-width: 600px;
ย margin: 20px auto;
}
.opciones-grafico {
ย ย display: flex;
ย ย gap: 10px;
ย ย align-items: center;
ย ย margin-bottom: 15px;
ย ย justify-content: center;
}
.opciones-grafico .usuario-btn {
ย ย padding: 8px 15px;
ย ย font-size: 14px;
}
.reporte-calidad-mobile .tabla-calidad-movil .fila-dato {
ย ย background-color: #f2f2f2;
ย ย padding: 10px;
ย ย border-radius: 5px;
ย ย margin-bottom: 10px;
}
.reporte-calidad-mobile .tabla-calidad-movil .etiqueta {
ย ย font-weight: bold;
ย ย color: #666;
ย ย display: block;
ย ย font-size: 12px;
}
.reporte-calidad-mobile .tabla-calidad-movil .valor {
ย ย color: #333;
ย ย font-size: 16px;
}
@media (max-width: 768px) {
ย ย #pantalla3 .header-reporte {
ย ย ย ย flex-direction: column;
ย ย ย ย align-items: flex-start;
ย ย }
ย ย #pantalla3 .header-reporte .filtros {
ย ย ย ย width: 100%;
ย ย ย ย flex-direction: column;
ย ย }
ย ย #pantalla3 .header-reporte .filtros input,
ย ย #pantalla3 .header-reporte .filtros select {
ย ย ย ย width: 100%;
ย ย }
ย ย #pantalla3 .resumen-datos {
ย ย ย ย flex-direction: column;
ย ย ย ย gap: 15px;
ย ย }
ย ย #pantalla3 .dato {
ย ย ย ย width: 100%;
ย ย }
ย ย #pantalla3 table {
ย ย ย ย display: none; /* Oculta la tabla normal en mรณviles */
ย ย }
ย ย .reporte-calidad-mobile {
ย ย ย ย display: block; /* Muestra la tabla mรณvil */
ย ย }
}
@media (min-width: 769px) {
ย ย .reporte-calidad-mobile {
ย ย ย ย display: none; /* Oculta la tabla mรณvil en desktop */
ย ย }
}

/* ================= CSS PARA PANTALLA 4 (DASHBOARD) ================= */
#pantalla4 {
ย background-color: #000;
ย color: #fff;
ย padding: 20px;
ย display: grid;
ย grid-template-areas:
ย ย "header"
ย ย "filtros"
ย ย "kpis"
ย ย "graficos"
ย ย "pendientes"
ย ย "footer";
ย gap: 20px;
ย align-content: start;
ย overflow-y: auto;
}
#pantalla4 .header {
ย grid-area: header;
ย text-align: center;
}
#pantalla4 .filtros-dashboard {
ย grid-area: filtros;
ย display: flex;
ย justify-content: center;
ย gap: 15px;
ย margin-bottom: 20px;
ย align-items: center;
}
#pantalla4 .filtros-dashboard label {
ย font-size: 14px;
}
#pantalla4 .filtros-dashboard input[type="date"],
#pantalla4 .filtros-dashboard select {
ย padding: 8px;
ย border-radius: 5px;
ย border: 1px solid #555;
ย background-color: #222;
ย color: #fff;
}
#pantalla4 .kpis-grid {
ย grid-area: kpis;
ย display: grid;
ย grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
ย gap: 20px;
}
#pantalla4 .kpi-card {
ย background-color: #1a1a1a;
ย border-radius: 10px;
ย padding: 20px;
ย text-align: center;
ย box-shadow: 0 4px 10px rgba(0,0,0,0.5);
ย border: 1px solid #333;
}
#pantalla4 .kpi-card h3 {
ย margin-top: 0;
ย font-size: 1rem;
ย color: #aaa;
ย text-transform: uppercase;
}
#pantalla4 .kpi-card .valor {
ย font-size: 3rem;
ย font-weight: bold;
ย color: #00ff88;
ย transition: color 0.3s ease;
}
#pantalla4 .kpi-card.alerta .valor {
ย color: #ff3333;
}
#pantalla4 .graficos-container {
ย grid-area: graficos;
ย display: grid;
ย grid-template-columns: 1fr;
ย gap: 20px;
}
#pantalla4 .graficos-container .panel {
ย background-color: #1a1a1a;
ย padding: 20px;
ย border-radius: 10px;
ย box-shadow: 0 4px 10px rgba(0,0,0,0.5);
ย border: 1px solid #333;
}
#pantalla4 .graficos-container h3 {
ย text-align: center;
ย margin-top: 0;
ย margin-bottom: 15px;
ย color: #eee;
}
#pantalla4 #tablaPendientes {
ย width: 100%;
ย border-collapse: collapse;
ย color: #fff;
}
#pantalla4 #tablaPendientes th, #pantalla4 #tablaPendientes td {
ย padding: 12px;
ย border-bottom: 1px solid #444;
ย text-align: left;
}
#pantalla4 #tablaPendientes th {
ย background-color: #222;
}
#pantalla4 #tablaPendientes tbody tr:hover {
ย background-color: #333;
}
#pantalla4 .footer {
ย grid-area: footer;
}
@media (min-width: 768px) {
ย #pantalla4 {
ย ย grid-template-columns: 1fr 1fr;
ย ย grid-template-areas:
ย ย ย "header header"
ย ย ย "filtros filtros"
ย ย ย "kpis kpis"
ย ย ย "graficos graficos"
ย ย ย "pendientes pendientes"
ย ย ย "footer footer";
ย }
ย #pantalla4 .graficos-container {
ย ย ย grid-template-columns: 1fr 1fr;
ย }
ย .graficos-container > *:nth-child(3) {
ย ย ย grid-column: span 2;
ย }
}
@media (min-width: 1200px) {
ย #pantalla4 {
ย ย grid-template-columns: repeat(3, 1fr);
ย ย grid-template-areas:
ย ย ย "header header header"
ย ย ย "filtros filtros filtros"
ย ย ย "kpis kpis kpis"
ย ย ย "produccion calidad logistica"
ย ย ย "pendientes pendientes pendientes"
ย ย ย "footer footer footer";
ย }
ย #pantalla4 .graficos-container {
ย ย grid-template-columns: 1fr 1fr 1fr;
ย }
ย .graficos-container > *:nth-child(3) {
ย ย ย grid-column: span 1;
ย }
}

ย /* FAB */
ย .mt-fab {
ย ย position: fixed;
ย ย bottom: 20px;
ย ย right: 20px;
ย ย background: #0a84ff;
ย ย color: #fff;
ย ย border: none;
ย ย border-radius: 50%;
ย ย width: 78px;
ย ย height: 78px;
ย ย font-size: 12px;
ย ย font-weight: 700;
ย ย cursor: pointer;
ย ย z-index: 1000;
ย ย box-shadow: 0 10px 25px rgba(10,132,255,.35);
ย }
ย .mt-fab:active { transform: translateY(1px); }

ย /* Panel lateral */
ย .mt-panel {
ย ย position: fixed;
ย ย top: 0; right: -420px; width: 420px; max-width: 95vw; height: 100%;
ย ย background: #111316; color: #eaeaea;
ย ย box-shadow: -4px 0 20px rgba(0,0,0,.45);
ย ย transition: right .28s ease;
ย ย z-index: 999;
ย }
ย .mt-panel.open { right: 0; }
ย .mt-panel-content { padding: 20px; }
ย .mt-close {
ย ย background: transparent; border: none; color: #aaa; font-size: 28px; cursor: pointer; float: right;
ย }
ย .mt-close:hover { color: #fff; }

ย /* Controles */
ย .mt-row { display: flex; gap: 10px; align-items: stretch; }
ย .mt-btn {
ย ย padding: 10px 14px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;
ย }
ย .mt-primary { background:#0a84ff; color:#fff; }
ย .mt-success { background:#34c759; color:#000; }
ย .mt-select, #bxInput {
ย ย flex: 1; padding: 10px 12px; border-radius: 10px; border: 1px solid #2b2f36; background:#171a1f; color:#eaeaea;
ย }
ย .mt-select:focus, #bxInput:focus { outline: 2px solid #0a84ff; }

ย .mt-card {
ย ย margin-top: 16px; padding: 16px; border-radius: 14px;
ย ย background: linear-gradient(180deg, #16191e 0%, #121418 100%);
ย ย border: 1px solid #20242b;
ย }
ย .mt-grid {
ย ย display: grid; grid-template-columns: repeat(2,1fr); gap: 8px 14px; margin-bottom: 10px;
ย }
ย .mt-list { list-style: none; padding-left: 0; margin: 8px 0 0; max-height: 200px; overflow: auto; }
ย .mt-list li {
ย ย padding: 10px 12px; margin-bottom: 8px; border-radius: 10px;
ย ย background:#0f1216; border: 1px solid #22262c; font-size: 14px;
ย ย word-break: break-word;
ย }
ย .mt-assign { margin-top: 14px; border-top: 1px dashed #2a2f36; padding-top: 12px; }

</style>
</head>
<body>

<section id="pantalla1" class="pantalla activa">
<h1 id="mainTitle">Selecciona tu usuario</h1>
<div class="btn-contenedor">
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('LOGรSTICA')">LOGรSTICA</button>
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('MULTIPORT')">MULTIPORT</button>
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('DROPS')">DROPS</button>
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('BEDROCK')">BEDROCK</button>
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('SUPERVISOR')">SUPERVISOR</button>
ย ย <button class="usuario-btn" onclick="seleccionarUsuario('CALIDAD')">CALIDAD</button>ย
ย ย <button class="usuario-btn" onclick="seleccionarReporte()">REPORTES</button>
ย ย <button class="usuario-btn" onclick="seleccionarDashboard()">DASHBOARD</button>
</div>
</section>

<section id="pantalla2" class="pantalla">
<header class="header">
ย ย <div id="tituloFijo">LOGรSTICA</div>
ย ย <div id="turnoActual"></div>
</header>
<div class="zona-centro">
ย ย <div id="resumenTurno" class="resumen-turno oculto">
<div class="dato-resumen">
ย ย <div class="etiqueta">Tarimas Recolectadas</div>
ย ย <div id="tarimasTotales" class="valor">0</div>
</div>
<div class="dato-resumen">
ย ย <div class="etiqueta">Tiempo Promedio</div>
ย ย <div id="tiempoPromedio" class="valor">0 min</div>
</div>
</div>
<div class="grupo-contenedor">
ย ย <div class="grupo" data-grupo="MULTIPORT">
ย ย ย ย <div class="nombre">MULTIPORT</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="MULTIPORT" data-linea="linea1"></div>
ย ย ย ย <div class="leds" data-grupo="MULTIPORT" data-linea="linea2"></div>
ย ย ย <div class="tarimas-recibidas-panel" id="tarimasRecibidasPanel_MULTIPORT">
        ย ย ย </div>
ย ย ย ย<div class="tiempos" data-grupo="MULTIPORT"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="DROPS">
ย ย ย ย <div class="nombre">DROPS</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="DROPS" data-linea="linea1"></div>
ย ย ย ย <div class="leds" data-grupo="DROPS" data-linea="linea2"></div>
ย ย ย ย <div class="tiempos" data-grupo="DROPS"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="BEDROCK">
ย ย ย ย <div class="nombre">BEDROCK</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="BEDROCK" data-linea="linea1"></div>
ย ย ย ย <div class="leds" data-grupo="BEDROCK" data-linea="linea2"></div>
ย ย ย ย <div class="tiempos" data-grupo="BEDROCK"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="CALIDAD_MULTIPORT">
ย ย ย ย <div class="nombre">CALIDAD MULTIPORT</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="CALIDAD_MULTIPORT" data-linea="linea1"></div>
ย ย ย ย <div class="contadores-calidad">
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="liberadas_CALIDAD_MULTIPORT">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Liberadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="rechazadas_CALIDAD_MULTIPORT">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Rechazadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div class="tiempos" data-grupo="CALIDAD_MULTIPORT"></div>
ย ย </div>
ยย
ย ย <div class="grupo" data-grupo="CALIDAD_DROPS">
ย ย ย ย <div class="nombre">CALIDAD DROPS</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="CALIDAD_DROPS" data-linea="linea1"></div>
ย ย ย ย <div class="contadores-calidad">
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="liberadas_CALIDAD_DROPS">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Liberadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="rechazadas_CALIDAD_DROPS">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Rechazadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div class="tiempos" data-grupo="CALIDAD_DROPS"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="CALIDAD_BEDROCK">
ย ย ย ย <div class="nombre">CALIDAD BEDROCK</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="CALIDAD_BEDROCK" data-linea="linea1"></div>
ย ย ย ย <div class="contadores-calidad">
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="liberadas_CALIDAD_BEDROCK">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Liberadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="rechazadas_CALIDAD_BEDROCK">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Rechazadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div class="tiempos" data-grupo="CALIDAD_BEDROCK"></div>
ย ย </div>
</div>
</div>
<div class="footer">
ย ย <button class="usuario-btn btn-rojo" onclick="volverAPantalla1()">Cerrar sesiรณn</button>
</div>
</section>

<section id="pantalla3" class="pantalla">
<header class="header">
ย ย <h1 id="tituloReportes">REPORTES</h1>
</header>
<div class="zona-centro">
ย ย <div id="selectoresReportes" class="btn-contenedor">
ย ย ย ย <button class="usuario-btn" data-reporte="produccion">PRODUCCIรN</button>
ย ย ย ย <button class="usuario-btn" data-reporte="logistica">LOGรSTICA</button>
ย ย ย ย <button class="usuario-btn" data-reporte="calidad">CALIDAD</button>
ย ย ย ย <button class="usuario-btn" data-reporte="resumen">RESUMEN EJECUTIVO</button>
ย ย </div>
ย ย <div id="contenedorReporte" class="contenedor-reporte">
ย ย ย ย <h2>Selecciona un reporte</h2>
ย ย </div>
</div>
<div class="footer">
ย ย <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver</button>
</div>
</section>

<section id="pantalla4" class="pantalla">
<header class="header">
ย ย <h1>DASHBOARD DE SUPERVISOR</h1>
</header>
<div class="filtros-dashboard">
ย ย <label for="fechaDashboard">Fecha:</label>
ย ย <input type="date" id="fechaDashboard">
ย ย <label for="turnoDashboardSelect">Turno:</label>
ย ย <select id="turnoDashboardSelect">
ย ย ย ย <option value="todos">Todos</option>
ย ย ย ย <option value="Turno 1">Turno 1</option>
ย ย ย ย <option value="Turno 2">Turno 2</option>
ย ย </select>
</div>
ย <div class="kpis-grid">
ย ย <div class="kpi-card">
ย ย ย ย <h3>Tarimas Asignadas (Prod)</h3>
ย ย ย ย <div class="valor" id="dashTarimasConfirmadas">0</div>
ย ย </div>
ย ย <div class="kpi-card">
ย ย ย ย <h3>Tarimas Recolectadas</h3>
ย ย ย ย <div class="valor" id="dashTarimasRecolectadas">0</div>
ย ย </div>
ย ย <div class="kpi-card" id="kpiTiempoPromedio">
ย ย ย ย <h3>Tiempo Promedio Recolecciรณn</h3>
ย ย ย ย <div class="valor" id="dashTiempoPromedio">0 min</div>
ย ย </div>
ย ย <div class="kpi-card" id="kpiTasaRechazo">
ย ย ย ย <h3>Tasa de Rechazo</h3>
ย ย ย ย <div class="valor" id="dashTasaRechazo">0%</div>
ย ย </div>
</div>
<div class="graficos-container">
ย ย <div class="panel" data-area-grafico="produccion">
ย ย ย ย <h3>Producciรณn por รrea</h3>
ย ย ย ย <div style="position: relative; height: 300px;"><canvas id="graficoProduccionDash"></canvas></div>
ย ย </div>
ย ย <div class="panel" data-area-grafico="calidad">
ย ย ย ย <h3>Estado de Calidad</h3>
ย ย ย ย <div style="position: relative; height: 300px;"><canvas id="graficoCalidadDash"></canvas></div>
ย ย </div>
ย ย <div class="panel" data-area-grafico="logistica">
ย ย ย ย <h3>Evoluciรณn Tiempos de Recolecciรณn</h3>
ย ย ย ย <div style="position: relative; height: 300px;"><canvas id="graficoLogisticaDash"></canvas></div>
ย ย </div>
</div>
<div class="panel" style="grid-area: pendientes;">
ย ย <h3>Tarimas Pendientes por Recolectar</h3>
ย ย <table id="tablaPendientes">
ย ย ย ย <thead>
ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย <th>รrea</th>
                <th>ID Tarima</th>
ย ย ย ย ย ย ย ย <th>Tiempo Espera</th>
ย ย ย ย ย ย </tr>
ย ย ย ย </thead>
ย ย ย ย <tbody></tbody>
ย ย </table>
</div>
<div class="footer">
ย ย <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver al inicio</button>
</div>
</section>

<div id="modalCalidad" class="modal-calidad">
ย <div class="modal-content">
ย ย <h3>Selecciona el estado de la tarima: <strong id="modal-tarima-id"></strong></h3>
ย ย <div class="opciones" style="display: flex; gap: 15px; justify-content: center; margin: 20px 0;">
ย ย ย <button class="opcion-btn" data-color="rojo">Rechazada ๐ด</button>
ย ย ย <button class="opcion-btn" data-color="verde">Liberada ๐ข</button>
ย ย </div>
ย ย <button class="cerrar-btn usuario-btn" style="background: #555;" onclick="cerrarModal('modalCalidad')">Cancelar</button>
ย </div>
</div>

<div id="modalRechazo" class="modal-calidad">
ย <div class="modal-content">
ย ย <h3>Detalles del Rechazo</h3>
ย ย <form id="formularioRechazo">
ย ย ย ย <label for="empleado">Empleado Originador:</label>
ย ย ย ย <input type="text" id="empleado" name="empleado" required>
ย ย ย ยย
ย ย ย ย <label for="linea">Lรญnea afectada:</label>
ย ย ย ย <input type="text" id="linea" name="linea" required>

ย ย ย ย <label for="parte">No. de parte:</label>
ย ย ย ย <input type="text" id="parte" name="parte" required>

ย ย ย ย <label for="descripcionParte">Descripciรณn del No. de parte:</label>
ย ย ย ย <input type="text" id="descripcionParte" name="descripcionParte" required>

ย ย ย ย <label for="problema">Descripciรณn del problema:</label>
ย ย ย ย <textarea id="problema" name="problema" required></textarea>

ย ย ย ย <label for="causa">Causa raรญz del problema:</label>
ย ย ย ย <textarea id="causa" name="causa" required></textarea>

ย ย ย ย <label for="accion">Acciรณn correctiva:</label>
ย ย ย ย <textarea id="accion" name="accion" required></textarea>

ย ย ย ย <div class="modal-actions">
ย ย ย ย ย ย <button type="submit">Guardar Rechazo</button>
ย ย ย ย ย ย <button type="button" onclick="cerrarModal('modalRechazo')">Cancelar</button>
ย ย ย ย </div>
ย ย </form>
ย </div>
</div>
ย
<div id="modalAsignarTarimaProduccion" class="modal">
ย <div class="modal-content">
ย ย <h3>Asignar tarima recibida</h3>
ย ย <label for="selectTarimaProduccion" style="display: block; margin: 10px 0;">Selecciona Tarima:</label>
ย ย <select id="selectTarimaProduccion" style="width: 100%; padding: 8px; border-radius: 5px;"></select>
ย ย <div class="modal-actions" style="display:flex; justify-content: space-around; margin-top: 20px;">
ย ย ย <button id="btnAsignarProduccion" class="usuario-btn">Asignar</button>
ย ย ย <button onclick="cerrarModal('modalAsignarTarimaProduccion')" class="usuario-btn btn-rojo">Cancelar</button>
ย ย </div>
ย </div>
</div>
ยย
<button class="mt-fab" id="mtOpenBtn" style="display:none;" title="Identificaciรณn de Tarima">TARIMAS</button>

<div id="mtPanel" class="mt-panel" aria-hidden="true">
ย <div class="mt-panel-content">
ย ย <button id="mtCloseBtn" class="mt-close" aria-label="Cerrar panel">&times;</button>
ย ย <h2>Identificaciรณn de Tarima</h2>
ย ย <p>Escanea o ingresa un cรณdigo <b>BX</b> para identificar la tarima:</p>

ย ย <div class="mt-row">
ย ย ย <input type="text" id="bxInput" placeholder="Escanear/pegar ID de tarima..." autocomplete="off" />
ย ย ย <button id="buscarTarimaBtn" class="mt-btn mt-primary">Buscar</button>
ย ย </div>

ย ย <div id="tarimaInfo" class="mt-card" style="display:none;">
ย ย ย <h3>Tarima encontrada</h3>
ย ย ย <div class="mt-grid">
ย ย ย ย <div><b>ID:</b> <span id="tarimaId"></span></div>
ย ย ย ย <div><b>Empleado:</b> <span id="empleadoPanel"></span></div>
ย ย ย ย <div><b>Turno:</b> <span id="turnoPanel"></span></div>
ย ย ย ย <div><b>Estado:</b> <strong id="estadoPanel"></strong></div>
ย ย ย </div>
ย ย ย <div id="ledAssignment" class="mt-assign" style="display:none;">
ย ย ย ย <label for="ledSelect">Asignar a LED de Calidad:</label>
ย ย ย ย <div class="mt-row">
ย ย ย ย ย <select id="ledSelect" class="mt-select"></select>
ย ย ย ย ย <button id="asignarLedBtn" class="mt-btn mt-success">Asignar</button>
ย ย ย ย </div>
ย ย ย ย <small>Solo se pueden asignar tarimas con estado 'CREADA'.</small>
ย ย ย </div>
ย ย </div>
ย </div>
</div>
ยย
<script>
// ================= CONFIG Y ESTADO =================
const CONFIG = {
ย ย USUARIOS: ['MULTIPORT', 'BEDROCK', 'DROPS', 'LOGรSTICA', 'SUPERVISOR', 'CALIDAD'],
ย ย PRODUCCION_GRUPOS: ['MULTIPORT', 'BEDROCK', 'DROPS'],
ย ย PASSWORDS: {
ย ย ย ย 'LOGรSTICA': 'LOGRAM',
ย ย ย ย 'MULTIPORT': 'MP25',
ย ย ย ย 'BEDROCK': 'BR25',
ย ย ย ย 'DROPS': 'DROP25',
ย ย ย ย 'SUPERVISOR': 'SUP25',
ย ย ย ย 'CALIDAD_MULTIPORT': 'AQLMP',
ย ย ย ย 'CALIDAD_DROPS': 'AQLDP',
ย ย ย ย 'CALIDAD_BEDROCK': 'AQLBR',
ย ย ย ย 'REPORTES': 'REPO25',
ย ย ย ย 'DASHBOARD': 'DASH25'
ย ย },
    // Total de LEDs por grupo (5 por lรญnea)
ย ย LEDS_POR_GRUPO: {
ย ย ย ย 'MULTIPORT': 10, 'BEDROCK': 10, 'DROPS': 10,
ย ย ย ย 'CALIDAD_MULTIPORT': 5, 'CALIDAD_BEDROCK': 5, 'CALIDAD_DROPS': 5
ย ย }
};

let usuarioSeleccionado = null;
// Objeto para guardar la info del LED/Tarima que se estรก manipulando en los modales
let contextoActivo = { grupo: null, idx: null, linea: null, tarimaId: null, data: {} };
let reporteActual = null;
let datosFiltradosReporte = null;
let miGrafico;
let graficosDashboard = {};
let firebaseListeners = []; // Para gestionar y limpiar los listeners


// ================= FIREBASE =================
const firebaseConfig = {
ย ย apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
ย ย authDomain: "panel-logistica.firebaseapp.com",
ย ย databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
ย ย projectId: "panel-logistica",
ย ย storageBucket: "panel-logistica.appspot.com",
ย ย messagingSenderId: "38365879945",
ย ย appId: "1:38365879945:web:e2f3590fe77f013dba3058"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= FUNCIONES DE RENDERIZADO =================
function inyectaLEDs(){
ย ย document.querySelectorAll('.grupo').forEach(g => g.classList.add('oculto'));

ย ย if (usuarioSeleccionado === 'SUPERVISOR') {
ย ย ย ย document.querySelectorAll('.grupo').forEach(g => g.classList.remove('oculto'));
ย ย } else if (usuarioSeleccionado === 'LOGรSTICA') {
ย ย ย ย document.querySelectorAll('.grupo:not([data-grupo*="CALIDAD_"])').forEach(g => g.classList.remove('oculto'));
ย ย } else if (usuarioSeleccionado.startsWith('CALIDAD_')) {
        document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`)?.classList.remove('oculto');
    } else { // Usuarios de producciรณn
ย ย ย ย document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`)?.classList.remove('oculto');
ย ย ย ย document.querySelector(`.grupo[data-grupo="CALIDAD_${usuarioSeleccionado}"]`)?.classList.remove('oculto');
ย ย }

ย ย document.querySelectorAll('.grupo:not(.oculto) .leds').forEach(contenedor => {
ย ย ย ย const grupo = contenedor.dataset.grupo;
ย ย ย ย const linea = contenedor.dataset.linea;
ย ย ย ย const ledsPorLinea = (linea === 'linea1' || grupo.startsWith('CALIDAD_')) ? 5 : 5;
ย ย ย ย contenedor.innerHTML = '';
ย ย ย ย for(let i = 0; i < ledsPorLinea; i++){
ย ย ย ย ย ย const led = document.createElement('div');
ย ย ย ย ย ย led.className = 'led';
ย ย ย ย ย ย let index = (linea === 'linea2' ? 5 : 0) + i; // รndice global para el grupo
            if (grupo.startsWith('CALIDAD_')) index = i;
ย ย ย ย ย ย led.title = `${grupo} โข ${linea} โข LED ${i+1}`;
ย ย ย ย ย ย led.addEventListener('click', () => togglearLED(grupo, index, linea));
ย ย ย ย ย ย contenedor.appendChild(led);
ย ย ย ย }
ย ย });
}

function pintarEstado(estados) {
    estados = estados || {};
    document.querySelectorAll('.leds').forEach(contenedor => {
        const grupo = contenedor.dataset.grupo;
        const linea = contenedor.dataset.linea;
        const ledsGrupo = estados[grupo]?.[linea] || [];

        contenedor.querySelectorAll('.led').forEach((led, i) => {
            const estado = ledsGrupo[i];
            led.className = 'led'; // Resetea clases
            led.textContent = ''; // Limpia texto

            if (estado) {
                if (estado.color) led.classList.add(estado.color);
                if (estado.encendido) led.classList.add('on');
                if (estado.tarimaId) {
                    led.textContent = estado.tarimaId.slice(-4); // Muestra รบltimos 4 chars del ID
                }
            }
        });
    });
}

// ================= LรGICA DE TURNOS Y TIEMPO =================
function formatoHora(isoString) {
ย ย if (!isoString) return 'N/A';
ย ย const date = new Date(isoString);
ย ย return date.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
}

function obtenerTurnoActual() {
ย ย const ahora = new Date();
ย ย const hora = ahora.getHours();
ย ย let fecha = new Date(ahora);
ย ย let turno = (hora >= 6 && hora < 18) ? 'Turno 1' : 'Turno 2';
ย ย if (turno === 'Turno 2' && hora < 6) {
ย ย ย ย fecha.setDate(ahora.getDate() - 1);
ย ย }
ย ย const fechaFormateada = fecha.toISOString().split('T')[0];
ย ย return { fecha: fechaFormateada, turno };
}


// ================= LISTENERS DE FIREBASE (TIEMPO REAL) =================
function limpiarListeners() {
    firebaseListeners.forEach(listener => listener.ref.off(listener.evento, listener.callback));
    firebaseListeners = [];
}

function iniciarListenersFirebase() {
ย ย limpiarListeners();
ย ย const { fecha, turno } = obtenerTurnoActual();
ย ย document.getElementById('turnoActual').textContent = `Turno: ${turno}`;

    const refs = {
        estadoLEDs: db.ref('estadoLEDs'),
        historial: db.ref(`historialLogs/${fecha}/${turno}`),
        contadoresCalidad: db.ref(`contadoresCalidad/${fecha}/${turno}`),
        tarimasLiberadas: db.ref('tarimasLiberadas') // Nueva ruta para tarimas listas para producciรณn
    };

    const addListener = (ref, evento, callback) => {
        ref.on(evento, callback);
        firebaseListeners.push({ ref, evento, callback });
    };

    // Listener para el estado visual de los LEDs
    addListener(refs.estadoLEDs, 'value', snapshot => pintarEstado(snapshot.val()));

    // Listener para el resumen de turno y tiempos
    addListener(refs.historial, 'value', snapshot => {
        const logs = snapshot.val() || {};
        let tarimasRecolectadas = 0;
        let tiempoTotal = 0;
        const tiemposPorGrupo = {};

        Object.values(logs).forEach(log => {
            if (log.accion === 'recolectada' && log.tiempoRecoleccion != null) {
                tarimasRecolectadas++;
                tiempoTotal += log.tiempoRecoleccion;
                if (!tiemposPorGrupo[log.grupo]) tiemposPorGrupo[log.grupo] = [];
                tiemposPorGrupo[log.grupo].push(log);
            }
        });

        const promedio = tarimasRecolectadas > 0 ? (tiempoTotal / tarimasRecolectadas).toFixed(1) : 0;
        document.getElementById('tarimasTotales').textContent = tarimasRecolectadas;
        document.getElementById('tiempoPromedio').textContent = `${promedio} min`;

        // Actualizar UI de tiempos por grupo
        document.querySelectorAll('.tiempos').forEach(div => div.innerHTML = '');
        for(const grupo in tiemposPorGrupo) {
            const div = document.querySelector(`.tiempos[data-grupo="${grupo}"]`);
            if (div) {
                div.innerHTML = tiemposPorGrupo[grupo]
                    .slice(-5) // รบltimos 5
                    .map(l => `<p>Tarima ${l.tarimaId.slice(-4)}: ${l.tiempoRecoleccion} min</p>`)
                    .join('');
            }
        }
    });

    // Listener para contadores de calidad en la UI
    addListener(refs.contadoresCalidad, 'value', snapshot => {
        const contadores = snapshot.val() || {};
        ['CALIDAD_MULTIPORT', 'CALIDAD_DROPS', 'CALIDAD_BEDROCK'].forEach(grupo => {
            const data = contadores[grupo] || { liberadas: 0, rechazadas: 0 };
            document.getElementById(`liberadas_${grupo}`).textContent = data.liberadas;
            document.getElementById(`rechazadas_${grupo}`).textContent = data.rechazadas;
        });
    });

    // Mostrar resumen solo a usuarios relevantes
    const resumenTurnoDiv = document.getElementById('resumenTurno');
    if (usuarioSeleccionado === 'LOGรSTICA' || usuarioSeleccionado === 'SUPERVISOR') {
        resumenTurnoDiv.classList.remove('oculto');
    } else {
        resumenTurnoDiv.classList.add('oculto');
    }
}


// ================= LรGICA DE ACCIONES CON TARIMAS =================

// Funciรณn central para registrar eventos
function registrarAccion(accion, detalles) {
    const { fecha, turno } = obtenerTurnoActual();
    const log = {
        accion,
        usuario: usuarioSeleccionado,
        timestamp: new Date().toISOString(),
        ...detalles
    };
    db.ref(`historialLogs/${fecha}/${turno}`).push(log);
}


// Funciรณn principal que decide quรฉ hacer al hacer clic en un LED
function togglearLED(grupo, idx, linea) {
    const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
    ledRef.once('value', snapshot => {
        const estadoActual = snapshot.val();
        contextoActivo = { grupo, idx, linea, tarimaId: estadoActual?.tarimaId, data: estadoActual };

        // --- Lรณgica para LOGรSTICA ---
        if (usuarioSeleccionado === 'LOGรSTICA') {
            if (estadoActual?.encendido && estadoActual.tarimaId) {
                if (confirm(`ยฟConfirmar recolecciรณn de tarima ${estadoActual.tarimaId}?`)) {
                    const horaEncendido = new Date(estadoActual.horaEncendido);
                    const tiempoRecoleccion = Math.round((new Date() - horaEncendido) / 60000); // en minutos
                    
                    registrarAccion('recolectada', {
                        tarimaId: estadoActual.tarimaId,
                        grupo,
                        tiempoRecoleccion
                    });
                    ledRef.set(null); // Limpia el LED
                }
            } else {
                alert('Solo puedes recolectar tarimas encendidas.');
            }
        // --- Lรณgica para PRODUCCIรN ---
        } else if (CONFIG.PRODUCCION_GRUPOS.includes(usuarioSeleccionado) && usuarioSeleccionado === grupo) {
            if (!estadoActual) { // Si el LED estรก vacรญo
                abrirModal('modalAsignarTarimaProduccion');
            } else {
                alert('Este LED ya estรก ocupado.');
            }
        // --- Lรณgica para CALIDAD ---
        } else if (usuarioSeleccionado.startsWith('CALIDAD_') && usuarioSeleccionado === grupo) {
            if (estadoActual?.tarimaId) {
                document.getElementById('modal-tarima-id').textContent = estadoActual.tarimaId;
                abrirModal('modalCalidad');
            } else {
                alert("Este LED estรก vacรญo. Asigna una tarima desde el panel 'TARIMAS'.");
            }
        }
    });
}

// ================= MANEJO DE MODALES Y PANEL LATERAL =================
function cerrarModal(id) {
    document.getElementById(id)?.classList.remove('visible');
}

function abrirModal(id) {
    const modal = document.getElementById(id);
    if (id === 'modalAsignarTarimaProduccion') {
        const select = document.getElementById('selectTarimaProduccion');
        select.innerHTML = '<option>Cargando...</option>';
        const grupoProd = usuarioSeleccionado;
        // Busca tarimas que Calidad marcรณ como 'liberadas' para este grupo
        db.ref('tarimasLiberadas').child(grupoProd).once('value', snapshot => {
            select.innerHTML = '';
            if (!snapshot.exists()) {
                select.innerHTML = '<option>No hay tarimas disponibles</option>';
                return;
            }
            snapshot.forEach(tarimaSnap => {
                const opt = document.createElement('option');
                opt.value = tarimaSnap.key;
                opt.textContent = tarimaSnap.key;
                select.appendChild(opt);
            });
        });
    }
    modal?.classList.add('visible');
}

// Acciones del modal de Calidad
document.querySelectorAll('#modalCalidad .opcion-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const color = btn.dataset.color;
        const { grupo, idx, linea, tarimaId } = contextoActivo;
        const { fecha, turno } = obtenerTurnoActual();
        const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
        const contadoresRef = db.ref(`contadoresCalidad/${fecha}/${turno}/${grupo}`);

        if (color === 'verde') { // Liberada
            const grupoProd = grupo.replace('CALIDAD_', '');
            db.ref('tarimasLiberadas').child(grupoProd).child(tarimaId).set(true); // Poner disponible para producciรณn
            ledRef.set(null); // Limpiar LED de calidad
            contadoresRef.child('liberadas').transaction(v => (v || 0) + 1);
            registrarAccion('liberada', { tarimaId, grupo });
            alert(`Tarima ${tarimaId} liberada para ${grupoProd}.`);
        } else { // Rechazada
            abrirModal('modalRechazo');
        }
        cerrarModal('modalCalidad');
    });
});

// Formulario de rechazo
document.getElementById('formularioRechazo').addEventListener('submit', e => {
    e.preventDefault();
    const { grupo, idx, linea, tarimaId } = contextoActivo;
    const { fecha, turno } = obtenerTurnoActual();
    const contadoresRef = db.ref(`contadoresCalidad/${fecha}/${turno}/${grupo}`);
    const formData = new FormData(e.target);
    const detallesRechazo = Object.fromEntries(formData.entries());

    db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`).set(null); // Limpiar LED
    contadoresRef.child('rechazadas').transaction(v => (v || 0) + 1);
    registrarAccion('rechazada', { tarimaId, grupo, detalles: detallesRechazo });
    
    // Guardar detalles del rechazo para reportes
    db.ref(`rechazosDetallados/${fecha}/${turno}`).push({ tarimaId, grupo, ...detallesRechazo });
    
    alert(`Tarima ${tarimaId} rechazada.`);
    cerrarModal('modalRechazo');
    e.target.reset();
});


// Botรณn de asignar en Producciรณn
document.getElementById('btnAsignarProduccion').addEventListener('click', () => {
    const tarimaId = document.getElementById('selectTarimaProduccion').value;
    if (!tarimaId) return alert('Selecciona una tarima.');
    
    const { grupo, idx, linea } = contextoActivo;
    const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
    
    // Asigna la tarima al LED de producciรณn
    ledRef.set({
        encendido: true,
        tarimaId: tarimaId,
        usuario: usuarioSeleccionado,
        horaEncendido: new Date().toISOString()
    });
    
    // Elimina la tarima de la lista de liberadas
    db.ref('tarimasLiberadas').child(grupo).child(tarimaId).remove();
    
    registrarAccion('asignada_produccion', { tarimaId, grupo });
    alert(`Tarima ${tarimaId} asignada a producciรณn.`);
    cerrarModal('modalAsignarTarimaProduccion');
});

// Lรณgica del Panel Lateral (FAB)
const panelUI = {
    panel: document.getElementById('mtPanel'),
    openBtn: document.getElementById('mtOpenBtn'),
    closeBtn: document.getElementById('mtCloseBtn'),
    bxInput: document.getElementById('bxInput'),
    buscarBtn: document.getElementById('buscarTarimaBtn'),
    infoBox: document.getElementById('tarimaInfo'),
    tarimaId: document.getElementById('tarimaId'),
    empleadoPanel: document.getElementById('empleadoPanel'),
    turnoPanel: document.getElementById('turnoPanel'),
    estadoPanel: document.getElementById('estadoPanel'),
    ledAssignment: document.getElementById('ledAssignment'),
    ledSelect: document.getElementById('ledSelect'),
    asignarLedBtn: document.getElementById('asignarLedBtn')
};

panelUI.openBtn.addEventListener('click', () => panelUI.panel.classList.add('open'));
panelUI.closeBtn.addEventListener('click', () => panelUI.panel.classList.remove('open'));
panelUI.buscarBtn.addEventListener('click', () => {
    const id = panelUI.bxInput.value.trim();
    if (!id) return;
    // Asumimos que tienes una ruta /tarimas/{id} con la info
    db.ref(`tarimas/${id}`).once('value', snapshot => {
        if (!snapshot.exists()) {
            panelUI.infoBox.style.display = 'none';
            return alert('Tarima no encontrada.');
        }
        const data = snapshot.val();
        contextoActivo.tarimaId = snapshot.key; // Guarda el ID para usarlo despuรฉs
        panelUI.tarimaId.textContent = snapshot.key;
        panelUI.empleadoPanel.textContent = data.empleadoId || 'N/D';
        panelUI.turnoPanel.textContent = data.turno || 'N/D';
        panelUI.estadoPanel.textContent = (data.estado || 'CREADA').toUpperCase();
        panelUI.infoBox.style.display = 'block';

        // Lรณgica de asignaciรณn para Calidad
        if (usuarioSeleccionado.startsWith('CALIDAD_') && (data.estado || 'creada') === 'creada') {
            panelUI.ledAssignment.style.display = 'block';
            const select = panelUI.ledSelect;
            select.innerHTML = '<option>Buscando LEDs...</option>';
            // Busca LEDs vacรญos en el รกrea de calidad del usuario
            db.ref(`estadoLEDs/${usuarioSeleccionado}/linea1`).once('value', ledSnap => {
                const leds = ledSnap.val() || [];
                select.innerHTML = '';
                for (let i = 0; i < CONFIG.LEDS_POR_GRUPO[usuarioSeleccionado]; i++) {
                    if (!leds[i]) {
                        const opt = document.createElement('option');
                        opt.value = i;
                        opt.textContent = `LED ${i+1}`;
                        select.appendChild(opt);
                    }
                }
                if (select.innerHTML === '') select.innerHTML = '<option>No hay LEDs libres</option>';
            });
        } else {
            panelUI.ledAssignment.style.display = 'none';
        }
    });
});

panelUI.asignarLedBtn.addEventListener('click', () => {
    const idx = panelUI.ledSelect.value;
    if (idx === '' || !contextoActivo.tarimaId) return alert('Selecciona un LED y una tarima.');
    
    const tarimaId = contextoActivo.tarimaId;
    const ledRef = db.ref(`estadoLEDs/${usuarioSeleccionado}/linea1/${idx}`);
    
    ledRef.set({
        color: 'naranja', // Estado inicial "en revisiรณn"
        tarimaId: tarimaId,
        usuario: usuarioSeleccionado,
        timestamp: new Date().toISOString()
    });

    // Actualiza el estado de la tarima principal
    db.ref(`tarimas/${tarimaId}`).update({ estado: 'en_calidad' });

    registrarAccion('asignada_calidad', { tarimaId, grupo: usuarioSeleccionado });
    alert(`Tarima ${tarimaId} asignada a revisiรณn en LED ${parseInt(idx)+1}.`);
    panelUI.panel.classList.remove('open');
});

// ================= NAVEGACIรN Y ARRANQUE =================
function activarPantalla(id){
ย ย document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
ย ย const pantalla = document.getElementById(id);
    // Usar flex en lugar de block para que los estilos de centrado funcionen
ย ย pantalla.style.display = 'flex'; 
ย ย pantalla.classList.add('activa');
}

function volverAPantalla1(){
ย ย usuarioSeleccionado = null;
ย ย limpiarListeners();
    document.getElementById('mtOpenBtn').style.display = 'none';
ย ย activarPantalla('pantalla1');
}

function seleccionarUsuario(usuario) {
    let password;
    let targetUser = usuario;

    if (usuario === 'CALIDAD') {
        password = prompt('Introduce la contraseรฑa para CALIDAD:');
        if (password === CONFIG.PASSWORDS['CALIDAD_MULTIPORT']) targetUser = 'CALIDAD_MULTIPORT';
        else if (password === CONFIG.PASSWORDS['CALIDAD_DROPS']) targetUser = 'CALIDAD_DROPS';
        else if (password === CONFIG.PASSWORDS['CALIDAD_BEDROCK']) targetUser = 'CALIDAD_BEDROCK';
        else return alert('Contraseรฑa incorrecta.');
    } else {
        password = prompt(`Introduce la contraseรฑa para ${usuario}:`);
        if (password !== CONFIG.PASSWORDS[usuario]) {
            return alert('Contraseรฑa incorrecta.');
        }
    }

    usuarioSeleccionado = targetUser;
    document.getElementById('tituloFijo').textContent = targetUser.replace('_', ' ');
    document.getElementById('mtOpenBtn').style.display = 'block';
    activarPantalla('pantalla2');
    inyectaLEDs();
    iniciarListenersFirebase();
}
ยย
function seleccionarReporte() {
ย ย const password = prompt('Introduce la contraseรฑa para REPORTES:');
ย ย if (password === CONFIG.PASSWORDS['REPORTES']) {
ย ย ย ย activarPantalla('pantalla3');
ย ย ย ย document.getElementById('tituloReportes').textContent = 'REPORTES';
ย ย ย ย document.getElementById('selectoresReportes').style.display = 'flex';
ย ย ย ย document.getElementById('contenedorReporte').innerHTML = '<h2>Selecciona un reporte</h2>';
ย ย } else {
ย ย ย ย alert('Contraseรฑa incorrecta. Acceso denegado.');
ย ย }
}
ย ยย
function seleccionarDashboard() {
ย ย const password = prompt('Introduce la contraseรฑa para DASHBOARD:');
ย ย if (password === CONFIG.PASSWORDS['DASHBOARD']) {
ย ย ย ย activarPantalla('pantalla4');
ย ย ย ย iniciarDashboard();
ย ย } else {
ย ย ย ย alert('Contraseรฑa incorrecta. Acceso denegado.');
ย ย }
}


// A PARTIR DE AQUร ESTร LA LรGICA DE DASHBOARD Y REPORTES
// La he revisado para que sea compatible con la nueva estructura de `historialLogs`
// Ahora deberรญa funcionar correctamente al leer los nuevos eventos.

function iniciarDashboard() {
    limpiarListeners();
    const { fecha } = obtenerTurnoActual();
    document.getElementById('fechaDashboard').value = fecha;
    document.getElementById('turnoDashboardSelect').value = 'todos';
    
    const setup = () => {
        limpiarListeners();
        const fechaSel = document.getElementById('fechaDashboard').value;
        const turnoSel = document.getElementById('turnoDashboardSelect').value;
        setupDashboardListeners(fechaSel, turnoSel);
    };

    document.getElementById('fechaDashboard').addEventListener('change', setup);
    document.getElementById('turnoDashboardSelect').addEventListener('change', setup);
    setup();
}

function setupDashboardListeners(fecha, turnoFiltro) {
    const historialRef = db.ref(`historialLogs/${fecha}`);
    const ledsRef = db.ref('estadoLEDs');

    const historialCallback = snapshot => {
        const turnos = snapshot.val() || {};
        let logsAgregados = [];
        if (turnoFiltro === 'todos') {
            Object.values(turnos).forEach(dataTurno => {
                logsAgregados.push(...Object.values(dataTurno));
            });
        } else if (turnos[turnoFiltro]) {
            logsAgregados = Object.values(turnos[turnoFiltro]);
        }
        actualizarDashboard(logsAgregados);
    };
    
    const ledsCallback = snapshot => {
        actualizarTablaPendientes(snapshot.val() || {});
    };

    historialRef.on('value', historialCallback);
    ledsRef.on('value', ledsCallback);
    
    firebaseListeners.push({ ref: historialRef, evento: 'value', callback: historialCallback });
    firebaseListeners.push({ ref: ledsRef, evento: 'value', callback: ledsCallback });
}

function actualizarDashboard(logs) {
    const kpis = {
        asignadas: 0,
        recolectadas: 0,
        tiempoTotal: 0,
        liberadas: 0,
        rechazadas: 0,
        prodPorArea: {},
        recoleccionPorHora: {}
    };

    logs.forEach(log => {
        switch(log.accion) {
            case 'asignada_produccion':
                kpis.asignadas++;
                kpis.prodPorArea[log.grupo] = (kpis.prodPorArea[log.grupo] || 0) + 1;
                break;
            case 'recolectada':
                kpis.recolectadas++;
                kpis.tiempoTotal += log.tiempoRecoleccion || 0;
                const hora = new Date(log.timestamp).getHours();
                kpis.recoleccionPorHora[hora] = (kpis.recoleccionPorHora[hora] || 0) + 1;
                break;
            case 'liberada':
                kpis.liberadas++;
                break;
            case 'rechazada':
                kpis.rechazadas++;
                break;
        }
    });

    const tiempoPromedio = kpis.recolectadas > 0 ? (kpis.tiempoTotal / kpis.recolectadas).toFixed(1) : 0;
    const totalCalidad = kpis.liberadas + kpis.rechazadas;
    const tasaRechazo = totalCalidad > 0 ? ((kpis.rechazadas / totalCalidad) * 100).toFixed(1) : 0;

    document.getElementById('dashTarimasConfirmadas').textContent = kpis.asignadas;
    document.getElementById('dashTarimasRecolectadas').textContent = kpis.recolectadas;
    document.getElementById('dashTiempoPromedio').textContent = `${tiempoPromedio} min`;
    document.getElementById('dashTasaRechazo').textContent = `${tasaRechazo}%`;
    document.getElementById('kpiTiempoPromedio').classList.toggle('alerta', tiempoPromedio > 15);
    document.getElementById('kpiTasaRechazo').classList.toggle('alerta', tasaRechazo > 5);

    // Grรกficos
    generarGraficoDash('graficoProduccionDash', 'bar', {
        labels: Object.keys(kpis.prodPorArea),
        datasets: [{ label: 'Asignadas', data: Object.values(kpis.prodPorArea), backgroundColor: '#36A2EB' }]
    });
    generarGraficoDash('graficoCalidadDash', 'pie', {
        labels: ['Liberadas', 'Rechazadas'],
        datasets: [{ data: [kpis.liberadas, kpis.rechazadas], backgroundColor: ['#4caf50', '#f44336'] }]
    });
    const horas = Object.keys(kpis.recoleccionPorHora).sort((a,b) => a-b);
    generarGraficoDash('graficoLogisticaDash', 'line', {
        labels: horas.map(h => `${h}:00`),
        datasets: [{ label: 'Recolectadas por Hora', data: horas.map(h => kpis.recoleccionPorHora[h]), borderColor: '#FFCE56', fill: false }]
    });
}

function actualizarTablaPendientes(estadoLEDs) {
    const tablaBody = document.querySelector('#tablaPendientes tbody');
    tablaBody.innerHTML = '';
    CONFIG.PRODUCCION_GRUPOS.forEach(grupo => {
        for (const linea in estadoLEDs[grupo] || {}) {
            (estadoLEDs[grupo][linea] || []).forEach(led => {
                if (led?.encendido && led.tarimaId && led.horaEncendido) {
                    const tr = document.createElement('tr');
                    const espera = Math.round((Date.now() - new Date(led.horaEncendido)) / 60000);
                    tr.innerHTML = `<td>${grupo}</td><td>${led.tarimaId}</td><td>${espera} min</td>`;
                    tablaBody.appendChild(tr);
                }
            });
        }
    });
}

function generarGraficoDash(canvasId, type, data) {
    if (graficosDashboard[canvasId]) graficosDashboard[canvasId].destroy();
    const ctx = document.getElementById(canvasId).getContext('2d');
    graficosDashboard[canvasId] = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, color: '#fff' } });
}


// ... (Las funciones de reporte como `mostrarReporte`, `exportarReporte`, etc. se dejan intactas pero ahora funcionarรกn con los datos correctos)
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('#selectoresReportes .usuario-btn').forEach(btn => {
        btn.addEventListener('click', (e) => mostrarReporte(e.target.dataset.reporte));
    });
});
function mostrarReporte(tipo) { console.log("Mostrar reporte:", tipo); /* Implementaciรณn de reportes */ }
function exportarReporte(formato) { console.log("Exportar a:", formato); /* Implementaciรณn de exportaciรณn */ }

// ================= ARRANQUE INICIAL =================
window.addEventListener('load', ()=>{
ย ย firebase.auth().signInAnonymously().catch(err => console.error('Auth error:', err));
ย ย firebase.auth().onAuthStateChanged(user => {
ย ย ย ย if (user) {
ย ย ย ย ย ย activarPantalla('pantalla1');
ย ย ย ย }
ย ย });
ย ย if ('serviceWorker' in navigator) {
ย ย ย ย navigator.serviceWorker.register('./sw.js').catch(err => console.error("SW reg failed:", err));
ย ย }
});

</script>
</body>
</html>
