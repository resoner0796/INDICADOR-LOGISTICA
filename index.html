<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Logística</title>
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --btn-bg: #0066cc;
  --btn-bg-hover: #004c99;
  --grid-size: 26px;
  --vignette: rgba(0,0,0,0.9);
  --titulo-size: clamp(42px,7vw,96px);
  --led-size: 60px; /* Un poco más grande para el ID */
  --led-gap: 16px;
  --led-off-core: #111;
  --led-off-edge: #000;
  --led-on-core: #0f0;
  --led-on-edge: #063;
  --glow: #00ff88;
  --blink-duration: 0.9s;
}

*{ box-sizing: border-box; }
html, body{ height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:#111; }

.pantalla{ display:none; width:100%; min-height:100vh; }
.pantalla.activa{ display:flex; flex-direction:column; }

#pantalla1{
  align-items:center;
  justify-content:center;
  flex-direction: column;
  background:linear-gradient(135deg,#222,#444);
  gap:18px;
}
.btn-contenedor{
  display:flex;
  flex-direction:column;
  align-items:center;
}

#pantalla1 h1{ margin:0 0 8px; }
.usuario-btn{
  background: var(--btn-bg);
  color:#fff;
  border:0;
  padding:14px 28px;
  margin:8px;
  border-radius:10px;
  font-size:18px;
  cursor:pointer;
  transition: background .25s ease;
  outline-color: #000;
}
.usuario-btn:hover{ background: var(--btn-bg-hover); }

#pantalla2{
  background-color:#000;
  background-image:
    radial-gradient(circle, rgba(60,60,60,.28) 20%, transparent 21%),
    radial-gradient(circle, #101010 20%, transparent 21%);
  background-size: var(--grid-size) var(--grid-size);
  box-shadow: inset 0 0 90px var(--vignette);
  overflow-y: auto; /* Permite el scroll solo en esta pantalla */
}
.header{ display:flex; align-items:center; justify-content:center; padding:16px 20px 6px; position: relative; }
#tituloFijo{
  font-weight:800;
  text-align:center;
  letter-spacing:.5px;
  text-shadow:0 2px 8px rgba(0,0,0,.65);
  font-size:var(--titulo-size);
}
#turnoActual {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 1.2rem;
  font-weight: bold;
  background-color: rgba(0,0,0,0.5);
  padding: 5px 10px;
  border-radius: 5px;
}
.zona-centro{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px 24px 28px;
  flex-direction: column;
}
.grupo-contenedor{
  display: flex;
  flex-wrap: wrap;
  gap: clamp(24px, 4vw, 64px);
  width: min(1200px, 96vw);
  justify-content: center;
}
.grupo.oculto {
  display: none;
}
.grupo{ display:flex; flex-direction:column; align-items:center; text-align:center; }
.grupo .nombre{ font-size: clamp(20px,2.2vw,28px); font-weight:800; margin-bottom:8px; letter-spacing:.5px; text-shadow:0 1px 6px rgba(0,0,0,.5); }
.grupo .tarimas{ font-size: clamp(16px,1.7vw,22px); opacity:.9; margin-bottom:14px; }
.leds{ display:flex; gap: var(--led-gap); justify-content:center; align-items:center; flex-wrap:nowrap; padding:4px; }
.led{
  width: var(--led-size);
  height: var(--led-size);
  border-radius:50%;
  cursor:pointer;
  background: radial-gradient(circle at 45% 40%, var(--led-off-core) 40%, var(--led-off-edge) 100%);
  box-shadow: inset -4px -5px 8px rgba(0,0,0,.8), inset 4px 5px 6px rgba(255,255,255,.06), 0 1px 0 rgba(255,255,255,.05);
  transition: transform .1s ease, filter .2s ease, box-shadow .2s ease;
  /* Estilos para centrar el texto del ID */
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  font-size: 14px;
  color: #fff;
  text-shadow: 1px 1px 2px black;
}
.led:active{ transform: scale(.96); }
.led.on{
  background: radial-gradient(circle at 48% 45%, var(--led-on-core) 40%, var(--led-on-edge) 100%);
  box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  animation: blink var(--blink-duration) ease-in-out infinite;
}
.led.disabled {
    cursor: not-allowed;
    pointer-events: none;
}

.resumen-turno {
  display: flex;
  justify-content: center;
  gap: 40px;
  margin-bottom: 20px;
  background-color: #222;
  border-radius: 12px;
  padding: 15px 30px;
  box-shadow: 0 4px 10px rgba(0,0,0,.3);
  width: min(800px, 90vw);
}
.resumen-turno.oculto {
  display: none;
}
.dato-resumen {
  text-align: center;
}
.dato-resumen .etiqueta {
  font-size: 14px;
  opacity: 0.7;
  text-transform: uppercase;
  margin-bottom: 4px;
}
.dato-resumen .valor {
  font-size: 32px;
  font-weight: bold;
  letter-spacing: 1px;
}
.tiempos{
  margin-top: 10px;
  font-size: 14px;
  opacity: 0.8;
  text-align: left;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
}
.btn-rojo{
  background: #cc0000;
  outline-color: #000;
}
.btn-rojo:hover{
  background: #990000;
}
.footer{
  width: 100%;
  display: flex;
  justify-content: center;
  padding: 20px;
}
.footer .usuario-btn{
  padding: 10px 20px;
  font-size: 16px;
}
.contadores-calidad {
  display: flex;
  gap: 20px;
  justify-content: center;
  margin-top: 10px;
}
.contador-calidad {
  text-align: center;
  font-size: 14px;
  font-weight: bold;
}
.contador-calidad .valor {
  font-size: 20px;
  font-weight: bold;
}
.contador-calidad .etiqueta {
  font-size: 12px;
  opacity: 0.8;
}

@media(max-width:720px){ 
  .grupo-contenedor{ 
    display: flex;
    flex-direction: column;
    gap: 24px;
    width: 100%;
  }
}
@keyframes blink {
  0%, 100% {
    box-shadow: 0 0 22px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  }
  50% {
    box-shadow: 0 0 40px var(--glow), inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
  }
}

/* Estilos base para ocultar los modales */
.modal-calidad,
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

/* Esta clase es la que tu JavaScript debe agregar para mostrar el modal */
.modal-calidad.visible,
.modal.visible {
  visibility: visible;
  opacity: 1;
}

/* Estilos de los contenedores de los modales (los que ya tenías) */
#modalCalidad .modal-content,
#modalRechazo .modal-content,
#modalOpcionesCalidad .modal-content,
#modalAsignarTarimaProduccion .modal-content {
  background-color: #1c1c1c !important;
  color: #eee !important;
  padding: 25px 35px;
  border-radius: 12px;
  text-align: center;
  max-width: 450px;
  width: 90%;
  box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}
  
/* ================= CSS DEL MODAL DE CALIDAD ================= */
#modalCalidad .modal-content,
#modalRechazo .modal-content {
  background-color: #1c1c1c !important;
  color: #eee !important;
  padding: 25px 35px;
  border-radius: 12px;
  text-align: center;
  max-width: 450px;
  width: 90%;
  box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}
#modalCalidad h3,
#modalRechazo h3 {
  color: #f0f0f0 !important;
}
#modalCalidad .opciones-btn,
#modalRechazo .opciones-btn {
  padding: 12px 20px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: transform 0.15s ease;
}
#modalCalidad .opcion-btn[data-color="rojo"] { background: #d32f2f; color: #fff; }
#modalCalidad .opcion-btn[data-color="verde"] { background: #2e7d32; color: #fff; }
#modalCalidad .opcion-btn:hover { transform: scale(1.05); }


/* Nuevo CSS para el formulario de rechazo */
#modalRechazo .modal-content {
  text-align: left;
}
#modalRechazo .modal-content h3 {
  text-align: center;
  margin-bottom: 30px;
}
#modalRechazo form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}
#modalRechazo label {
  font-size: 16px;
  margin-bottom: 5px;
  display: block;
}
#modalRechazo input, #modalRechazo textarea {
  width: 100%;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid #555;
  background-color: #333;
  color: #fff;
  font-size: 16px;
}
#modalRechazo textarea {
  resize: vertical;
  min-height: 80px;
}
#modalRechazo button[type="submit"] {
  margin-top: 20px;
  background-color: var(--btn-bg);
  color: #fff;
  border: none;
  padding: 15px;
  border-radius: 8px;
  font-size: 18px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
#modalRechazo button[type="submit"]:hover {
  background-color: var(--btn-bg-hover);
}

#modalRechazo .modal-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}
#modalRechazo .modal-actions button {
  flex: 1;
  margin: 0 5px;
}
  
.led.naranja {
  background: radial-gradient(circle at 48% 45%, #ff9800 40%, #c17500 100%);
  box-shadow: 0 0 22px #ff9800, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.rojo {
  background: radial-gradient(circle at 48% 45%, #f44336 40%, #d32f2f 100%);
  box-shadow: 0 0 22px #f44336, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}
.led.verde {
  background: radial-gradient(circle at 48% 45%, #4caf50 40%, #388e3c 100%);
  box-shadow: 0 0 22px #4caf50, inset -4px -5px 8px rgba(0,0,0,.75), inset 3px 4px 7px rgba(255,255,255,.10);
}

/* ================= CSS PARA PANTALLA 3 (REPORTES) ================= */
#pantalla3 {
  background-color: #f5f5f5;
  color: #333;
  align-items: center;
  justify-content: flex-start;
  padding: 20px;
  overflow-y: auto;
}
#pantalla3 h1 {
  font-size: 2.5rem;
  color: #0066cc;
  margin-bottom: 20px;
}
#pantalla3 .btn-contenedor {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  width: 100%;
  max-width: 800px;
}
#pantalla3 .usuario-btn {
  background-color: #0066cc;
  color: #fff;
  font-size: 1.2rem;
  padding: 15px 30px;
  border-radius: 10px;
  cursor: pointer;
  border: none;
  transition: background-color 0.3s ease;
}
#pantalla3 .usuario-btn:hover {
  background-color: #004c99;
}
#pantalla3 .contenedor-reporte {
  background-color: #fff;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 1200px;
  margin-top: 20px;
}
#pantalla3 .header-reporte {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: space-between;
  margin-bottom: 20px;
}
#pantalla3 .header-reporte h2 {
  color: #0066cc;
  margin: 0;
}
#pantalla3 .header-reporte .filtros {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
}
#pantalla3 .header-reporte .filtros label {
  font-size: 14px;
}
#pantalla3 .header-reporte .filtros input[type="date"],
#pantalla3 .header-reporte .filtros select,
#pantalla3 .header-reporte .filtros input[type="text"] {
  padding: 8px;
  border-radius: 5px;
  border: 1px solid #ccc;
  font-size: 14px;
}
#pantalla3 table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  display: table;
}
#pantalla3 th, #pantalla3 td {
  border: 1px solid #ccc;
  padding: 12px;
  text-align: left;
  font-size: 14px;
}
#pantalla3 thead {
  background-color: #0066cc;
  color: #fff;
}
#pantalla3 tbody tr:nth-child(even) {
  background-color: #f2f2f2;
}
#pantalla3 tbody tr:hover {
  background-color: #ddd;
}
#pantalla3 .resumen-datos {
  display: flex;
  gap: 30px;
  flex-wrap: wrap;
  justify-content: space-around;
  margin-bottom: 20px;
}
#pantalla3 .dato {
  background-color: #f2f2f2;
  padding: 15px;
  border-radius: 8px;
  font-weight: bold;
  text-align: center;
}
#pantalla3 .dato .valor {
  font-size: 24px;
  color: #0066cc;
}
#pantalla3 .dato .etiqueta {
  font-size: 12px;
  text-transform: uppercase;
  color: #666;
}
.botones-reporte {
  margin-top: 20px;
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  flex-wrap: wrap;
}
.grafico-contenedor {
  width: 100%;
  max-width: 600px;
  margin: 20px auto;
}
.opciones-grafico {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
    justify-content: center;
}
.opciones-grafico .usuario-btn {
    padding: 8px 15px;
    font-size: 14px;
}
.reporte-calidad-mobile .tabla-calidad-movil .fila-dato {
    background-color: #f2f2f2;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
}
.reporte-calidad-mobile .tabla-calidad-movil .etiqueta {
    font-weight: bold;
    color: #666;
    display: block;
    font-size: 12px;
}
.reporte-calidad-mobile .tabla-calidad-movil .valor {
    color: #333;
    font-size: 16px;
}
@media (max-width: 768px) {
    #pantalla3 .header-reporte {
        flex-direction: column;
        align-items: flex-start;
    }
    #pantalla3 .header-reporte .filtros {
        width: 100%;
        flex-direction: column;
    }
    #pantalla3 .header-reporte .filtros input,
    #pantalla3 .header-reporte .filtros select {
        width: 100%;
    }
    #pantalla3 .resumen-datos {
        flex-direction: column;
        gap: 15px;
    }
    #pantalla3 .dato {
        width: 100%;
    }
    #pantalla3 table {
        display: none; /* Oculta la tabla normal en móviles */
    }
    .reporte-calidad-mobile {
        display: block; /* Muestra la tabla móvil */
    }
}
@media (min-width: 769px) {
    .reporte-calidad-mobile {
        display: none; /* Oculta la tabla móvil en desktop */
    }
}

/* ================= CSS PARA PANTALLA 4 (DASHBOARD) ================= */
#pantalla4 {
  background-color: #000;
  color: #fff;
  padding: 20px;
  display: grid;
  grid-template-areas:
    "header"
    "filtros"
    "kpis"
    "graficos"
    "pendientes"
    "footer";
  gap: 20px;
  align-content: start;
  overflow-y: auto;
}
#pantalla4 .header {
  grid-area: header;
  text-align: center;
}
#pantalla4 .filtros-dashboard {
  grid-area: filtros;
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 20px;
  align-items: center;
}
#pantalla4 .filtros-dashboard label {
  font-size: 14px;
}
#pantalla4 .filtros-dashboard input[type="date"],
#pantalla4 .filtros-dashboard select {
  padding: 8px;
  border-radius: 5px;
  border: 1px solid #555;
  background-color: #222;
  color: #fff;
}
#pantalla4 .kpis-grid {
  grid-area: kpis;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}
#pantalla4 .kpi-card {
  background-color: #1a1a1a;
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  border: 1px solid #333;
}
#pantalla4 .kpi-card h3 {
  margin-top: 0;
  font-size: 1rem;
  color: #aaa;
  text-transform: uppercase;
}
#pantalla4 .kpi-card .valor {
  font-size: 3rem;
  font-weight: bold;
  color: #00ff88;
  transition: color 0.3s ease;
}
#pantalla4 .kpi-card.alerta .valor {
  color: #ff3333;
}
#pantalla4 .graficos-container {
  grid-area: graficos;
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}
#pantalla4 .graficos-container .panel {
  background-color: #1a1a1a;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  border: 1px solid #333;
}
#pantalla4 .graficos-container h3 {
  text-align: center;
  margin-top: 0;
  margin-bottom: 15px;
  color: #eee;
}
#pantalla4 #tablaPendientes {
  width: 100%;
  border-collapse: collapse;
  color: #fff;
}
#pantalla4 #tablaPendientes th, #pantalla4 #tablaPendientes td {
  padding: 12px;
  border-bottom: 1px solid #444;
  text-align: left;
}
#pantalla4 #tablaPendientes th {
  background-color: #222;
}
#pantalla4 #tablaPendientes tbody tr:hover {
  background-color: #333;
}
#pantalla4 .footer {
  grid-area: footer;
}
@media (min-width: 768px) {
  #pantalla4 {
    grid-template-columns: 1fr 1fr;
    grid-template-areas:
      "header header"
      "filtros filtros"
      "kpis kpis"
      "graficos graficos"
      "pendientes pendientes"
      "footer footer";
  }
  #pantalla4 .graficos-container {
      grid-template-columns: 1fr 1fr;
  }
  .graficos-container > *:nth-child(3) {
      grid-column: span 2;
  }
}
@media (min-width: 1200px) {
  #pantalla4 {
    grid-template-columns: repeat(3, 1fr);
    grid-template-areas:
      "header header header"
      "filtros filtros filtros"
      "kpis kpis kpis"
      "produccion calidad logistica"
      "pendientes pendientes pendientes"
      "footer footer footer";
  }
  #pantalla4 .graficos-container {
    grid-template-columns: 1fr 1fr 1fr;
  }
  .graficos-container > *:nth-child(3) {
      grid-column: span 1;
  }
}

  /* FAB */
  .mt-fab {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #0a84ff;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 78px;
    height: 78px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 10px 25px rgba(10,132,255,.35);
  }
  .mt-fab:active { transform: translateY(1px); }

  /* Panel lateral */
  .mt-panel {
    position: fixed;
    top: 0; right: -420px; width: 420px; max-width: 95vw; height: 100%;
    background: #111316; color: #eaeaea;
    box-shadow: -4px 0 20px rgba(0,0,0,.45);
    transition: right .28s ease;
    z-index: 999;
  }
  .mt-panel.open { right: 0; }
  .mt-panel-content { padding: 20px; }
  .mt-close {
    background: transparent; border: none; color: #aaa; font-size: 28px; cursor: pointer; float: right;
  }
  .mt-close:hover { color: #fff; }

  /* Controles */
  .mt-row { display: flex; gap: 10px; align-items: stretch; }
  .mt-btn {
    padding: 10px 14px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;
  }
  .mt-primary { background:#0a84ff; color:#fff; }
  .mt-success { background:#34c759; color:#000; }
  .mt-select, #bxInput {
    flex: 1; padding: 10px 12px; border-radius: 10px; border: 1px solid #2b2f36; background:#171a1f; color:#eaeaea;
  }
  .mt-select:focus, #bxInput:focus { outline: 2px solid #0a84ff; }

  .mt-card {
    margin-top: 16px; padding: 16px; border-radius: 14px;
    background: linear-gradient(180deg, #16191e 0%, #121418 100%);
    border: 1px solid #20242b;
  }
  .mt-grid {
    display: grid; grid-template-columns: repeat(2,1fr); gap: 8px 14px; margin-bottom: 10px;
  }
  .mt-list { list-style: none; padding-left: 0; margin: 8px 0 0; max-height: 200px; overflow: auto; }
  .mt-list li {
    padding: 10px 12px; margin-bottom: 8px; border-radius: 10px;
    background:#0f1216; border: 1px solid #22262c; font-size: 14px;
    word-break: break-word;
  }
  .mt-assign { margin-top: 14px; border-top: 1px dashed #2a2f36; padding-top: 12px; }

</style>
</head>
<body>

<section id="pantalla1" class="pantalla activa">
<h1 id="mainTitle">Selecciona tu usuario</h1>
<div class="btn-contenedor">
    <button class="usuario-btn" onclick="seleccionarUsuario('LOGÍSTICA')">LOGÍSTICA</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('MULTIPORT')">MULTIPORT</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('DROPS')">DROPS</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('BEDROCK')">BEDROCK</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('SUPERVISOR')">SUPERVISOR</button>
    <button class="usuario-btn" onclick="seleccionarUsuario('CALIDAD')">CALIDAD</button> 
    <button class="usuario-btn" onclick="seleccionarReporte()">REPORTES</button>
    <button class="usuario-btn" onclick="seleccionarDashboard()">DASHBOARD</button>
</div>
</section>

<section id="pantalla2" class="pantalla">
<header class="header">
    <div id="tituloFijo">LOGÍSTICA</div>
    <div id="turnoActual"></div>
</header>
<div class="zona-centro">
    <div id="resumenTurno" class="resumen-turno oculto">
<div class="dato-resumen">
    <div class="etiqueta">Tarimas Recolectadas</div>
    <div id="tarimasTotales" class="valor">0</div>
</div>
<div class="dato-resumen">
    <div class="etiqueta">Tiempo Promedio</div>
    <div id="tiempoPromedio" class="valor">0 min</div>
</div>
</div>
<div class="grupo-contenedor">
    <div class="grupo" data-grupo="MULTIPORT">
        <div class="nombre">MULTIPORT</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="MULTIPORT" data-linea="linea1"></div>
        <div class="leds" data-grupo="MULTIPORT" data-linea="linea2"></div>
      <div class="tarimas-recibidas-panel" id="tarimasRecibidasPanel_MULTIPORT">
              </div>
       <div class="tiempos" data-grupo="MULTIPORT"></div>
    </div>

    <div class="grupo" data-grupo="DROPS">
        <div class="nombre">DROPS</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="DROPS" data-linea="linea1"></div>
        <div class="leds" data-grupo="DROPS" data-linea="linea2"></div>
        <div class="tiempos" data-grupo="DROPS"></div>
    </div>

    <div class="grupo" data-grupo="BEDROCK">
        <div class="nombre">BEDROCK</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="BEDROCK" data-linea="linea1"></div>
        <div class="leds" data-grupo="BEDROCK" data-linea="linea2"></div>
        <div class="tiempos" data-grupo="BEDROCK"></div>
    </div>

    <div class="grupo" data-grupo="CALIDAD_MULTIPORT">
        <div class="nombre">CALIDAD MULTIPORT</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="CALIDAD_MULTIPORT" data-linea="linea1"></div>
        <div class="contadores-calidad">
            <div class="contador-calidad">
                <span class="valor" id="liberadas_CALIDAD_MULTIPORT">0</span>
                <div class="etiqueta">Liberadas</div>
            </div>
            <div class="contador-calidad">
                <span class="valor" id="rechazadas_CALIDAD_MULTIPORT">0</span>
                <div class="etiqueta">Rechazadas</div>
            </div>
        </div>
        <div class="tiempos" data-grupo="CALIDAD_MULTIPORT"></div>
    </div>
  
    <div class="grupo" data-grupo="CALIDAD_DROPS">
        <div class="nombre">CALIDAD DROPS</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="CALIDAD_DROPS" data-linea="linea1"></div>
        <div class="contadores-calidad">
            <div class="contador-calidad">
                <span class="valor" id="liberadas_CALIDAD_DROPS">0</span>
                <div class="etiqueta">Liberadas</div>
            </div>
            <div class="contador-calidad">
                <span class="valor" id="rechazadas_CALIDAD_DROPS">0</span>
                <div class="etiqueta">Rechazadas</div>
            </div>
        </div>
        <div class="tiempos" data-grupo="CALIDAD_DROPS"></div>
    </div>

    <div class="grupo" data-grupo="CALIDAD_BEDROCK">
        <div class="nombre">CALIDAD BEDROCK</div>
        <div class="tarimas">Tarimas: 0</div>
        <div class="leds" data-grupo="CALIDAD_BEDROCK" data-linea="linea1"></div>
        <div class="contadores-calidad">
            <div class="contador-calidad">
                <span class="valor" id="liberadas_CALIDAD_BEDROCK">0</span>
                <div class="etiqueta">Liberadas</div>
            </div>
            <div class="contador-calidad">
                <span class="valor" id="rechazadas_CALIDAD_BEDROCK">0</span>
                <div class="etiqueta">Rechazadas</div>
            </div>
        </div>
        <div class="tiempos" data-grupo="CALIDAD_BEDROCK"></div>
    </div>
</div>
</div>
<div class="footer">
    <button class="usuario-btn btn-rojo" onclick="volverAPantalla1()">Cerrar sesión</button>
</div>
</section>

<section id="pantalla3" class="pantalla">
<header class="header">
    <h1 id="tituloReportes">REPORTES</h1>
</header>
<div class="zona-centro">
    <div id="selectoresReportes" class="btn-contenedor">
        <button class="usuario-btn" data-reporte="produccion">PRODUCCIÓN</button>
        <button class="usuario-btn" data-reporte="logistica">LOGÍSTICA</button>
        <button class="usuario-btn" data-reporte="calidad">CALIDAD</button>
        <button class="usuario-btn" data-reporte="resumen">RESUMEN EJECUTIVO</button>
    </div>
    <div id="contenedorReporte" class="contenedor-reporte">
        <h2>Selecciona un reporte</h2>
    </div>
</div>
<div class="footer">
    <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver</button>
</div>
</section>

<section id="pantalla4" class="pantalla">
<header class="header">
    <h1>DASHBOARD DE SUPERVISOR</h1>
</header>
<div class="filtros-dashboard">
    <label for="fechaDashboard">Fecha:</label>
    <input type="date" id="fechaDashboard">
    <label for="turnoDashboardSelect">Turno:</label>
    <select id="turnoDashboardSelect">
        <option value="todos">Todos</option>
        <option value="Turno 1">Turno 1</option>
        <option value="Turno 2">Turno 2</option>
    </select>
</div>
  <div class="kpis-grid">
    <div class="kpi-card">
        <h3>Tarimas Asignadas (Prod)</h3>
        <div class="valor" id="dashTarimasConfirmadas">0</div>
    </div>
    <div class="kpi-card">
        <h3>Tarimas Recolectadas</h3>
        <div class="valor" id="dashTarimasRecolectadas">0</div>
    </div>
    <div class="kpi-card" id="kpiTiempoPromedio">
        <h3>Tiempo Promedio Recolección</h3>
        <div class="valor" id="dashTiempoPromedio">0 min</div>
    </div>
    <div class="kpi-card" id="kpiTasaRechazo">
        <h3>Tasa de Rechazo</h3>
        <div class="valor" id="dashTasaRechazo">0%</div>
    </div>
</div>
<div class="graficos-container">
    <div class="panel" data-area-grafico="produccion">
        <h3>Producción por Área</h3>
        <div style="position: relative; height: 300px;"><canvas id="graficoProduccionDash"></canvas></div>
    </div>
    <div class="panel" data-area-grafico="calidad">
        <h3>Estado de Calidad</h3>
        <div style="position: relative; height: 300px;"><canvas id="graficoCalidadDash"></canvas></div>
    </div>
    <div class="panel" data-area-grafico="logistica">
        <h3>Evolución Tiempos de Recolección</h3>
        <div style="position: relative; height: 300px;"><canvas id="graficoLogisticaDash"></canvas></div>
    </div>
</div>
<div class="panel" style="grid-area: pendientes;">
    <h3>Tarimas Pendientes por Recolectar</h3>
    <table id="tablaPendientes">
        <thead>
            <tr>
                <th>Área</th>
                <th>ID Tarima</th>
                <th>Tiempo Espera</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
<div class="footer">
    <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver al inicio</button>
</div>
</section>

<div id="modalCalidad" class="modal-calidad">
  <div class="modal-content">
    <h3>Selecciona el estado de la tarima: <strong id="modal-tarima-id"></strong></h3>
    <div class="opciones" style="display: flex; gap: 15px; justify-content: center; margin: 20px 0;">
      <button class="opcion-btn" data-color="rojo">Rechazada 🔴</button>
      <button class="opcion-btn" data-color="verde">Liberada 🟢</button>
    </div>
    <button class="cerrar-btn usuario-btn" style="background: #555;" onclick="cerrarModal('modalCalidad')">Cancelar</button>
  </div>
</div>

<div id="modalRechazo" class="modal-calidad">
  <div class="modal-content">
    <h3>Detalles del Rechazo</h3>
    <form id="formularioRechazo">
        <label for="empleado">Empleado Originador:</label>
        <input type="text" id="empleado" name="empleado" required>
        
        <label for="linea">Línea afectada:</label>
        <input type="text" id="linea" name="linea" required>

        <label for="parte">No. de parte:</label>
        <input type="text" id="parte" name="parte" required>

        <label for="descripcionParte">Descripción del No. de parte:</label>
        <input type="text" id="descripcionParte" name="descripcionParte" required>

        <label for="problema">Descripción del problema:</label>
        <textarea id="problema" name="problema" required></textarea>

        <label for="causa">Causa raíz del problema:</label>
        <textarea id="causa" name="causa" required></textarea>

        <label for="accion">Acción correctiva:</label>
        <textarea id="accion" name="accion" required></textarea>

        <div class="modal-actions">
            <button type="submit">Guardar Rechazo</button>
            <button type="button" onclick="cerrarModal('modalRechazo')">Cancelar</button>
        </div>
    </form>
  </div>
</div>
 
<div id="modalAsignarTarimaProduccion" class="modal">
  <div class="modal-content">
    <h3>Asignar tarima recibida</h3>
    <label for="selectTarimaProduccion" style="display: block; margin: 10px 0;">Selecciona Tarima:</label>
    <select id="selectTarimaProduccion" style="width: 100%; padding: 8px; border-radius: 5px;"></select>
    <div class="modal-actions" style="display:flex; justify-content: space-around; margin-top: 20px;">
      <button id="btnAsignarProduccion" class="usuario-btn">Asignar</button>
      <button onclick="cerrarModal('modalAsignarTarimaProduccion')" class="usuario-btn btn-rojo">Cancelar</button>
    </div>
  </div>
</div>
  
<button class="mt-fab" id="mtOpenBtn" style="display:none;" title="Identificación de Tarima">TARIMAS</button>

<div id="mtPanel" class="mt-panel" aria-hidden="true">
  <div class="mt-panel-content">
    <button id="mtCloseBtn" class="mt-close" aria-label="Cerrar panel">&times;</button>
    <h2>Identificación de Tarima</h2>
    <p>Escanea o ingresa un código <b>BX</b> para identificar la tarima:</p>

    <div class="mt-row">
      <input type="text" id="bxInput" placeholder="Escanear/pegar ID de tarima..." autocomplete="off" />
      <button id="buscarTarimaBtn" class="mt-btn mt-primary">Buscar</button>
    </div>

    <div id="tarimaInfo" class="mt-card" style="display:none;">
      <h3>Tarima encontrada</h3>
      <div class="mt-grid">
        <div><b>ID:</b> <span id="tarimaId"></span></div>
        <div><b>Empleado:</b> <span id="empleadoPanel"></span></div>
        <div><b>Turno:</b> <span id="turnoPanel"></span></div>
        <div><b>Estado:</b> <strong id="estadoPanel"></strong></div>
      </div>
      <div id="ledAssignment" class="mt-assign" style="display:none;">
        <label for="ledSelect">Asignar a LED de Calidad:</label>
        <div class="mt-row">
          <select id="ledSelect" class="mt-select"></select>
          <button id="asignarLedBtn" class="mt-btn mt-success">Asignar</button>
        </div>
        <small>Solo se pueden asignar tarimas con estado 'CREADA'.</small>
      </div>
    </div>
  </div>
</div>
  
<script>
// ================= CONFIG Y ESTADO =================
const CONFIG = {
    USUARIOS: ['MULTIPORT', 'BEDROCK', 'DROPS', 'LOGÍSTICA', 'SUPERVISOR', 'CALIDAD'],
    PRODUCCION_GRUPOS: ['MULTIPORT', 'BEDROCK', 'DROPS'],
    PASSWORDS: {
        'LOGÍSTICA': 'LOGRAM',
        'MULTIPORT': 'MP25',
        'BEDROCK': 'BR25',
        'DROPS': 'DROP25',
        'SUPERVISOR': 'SUP25',
        'CALIDAD_MULTIPORT': 'AQLMP',
        'CALIDAD_DROPS': 'AQLDP',
        'CALIDAD_BEDROCK': 'AQLBR',
        'REPORTES': 'REPO25',
        'DASHBOARD': 'DASH25'
    },
    // Total de LEDs por grupo (5 por línea)
    LEDS_POR_GRUPO: {
        'MULTIPORT': 10, 'BEDROCK': 10, 'DROPS': 10,
        'CALIDAD_MULTIPORT': 5, 'CALIDAD_BEDROCK': 5, 'CALIDAD_DROPS': 5
    }
};

let usuarioSeleccionado = null;
// Objeto para guardar la info del LED/Tarima que se está manipulando en los modales
let contextoActivo = { grupo: null, idx: null, linea: null, tarimaId: null, data: {} };
let reporteActual = null;
let datosFiltradosReporte = null;
let miGrafico;
let graficosDashboard = {};
let firebaseListeners = []; // Para gestionar y limpiar los listeners


// ================= FIREBASE =================
const firebaseConfig = {
    apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
    authDomain: "panel-logistica.firebaseapp.com",
    databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
    projectId: "panel-logistica",
    storageBucket: "panel-logistica.appspot.com",
    messagingSenderId: "38365879945",
    appId: "1:38365879945:web:e2f3590fe77f013dba3058"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= FUNCIONES DE RENDERIZADO =================
function inyectaLEDs(){
    document.querySelectorAll('.grupo').forEach(g => g.classList.add('oculto'));

    if (usuarioSeleccionado === 'SUPERVISOR') {
        document.querySelectorAll('.grupo').forEach(g => g.classList.remove('oculto'));
    } else if (usuarioSeleccionado === 'LOGÍSTICA') {
        document.querySelectorAll('.grupo:not([data-grupo*="CALIDAD_"])').forEach(g => g.classList.remove('oculto'));
    } else if (usuarioSeleccionado.startsWith('CALIDAD_')) {
        document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`)?.classList.remove('oculto');
    } else { // Usuarios de producción
        document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`)?.classList.remove('oculto');
        document.querySelector(`.grupo[data-grupo="CALIDAD_${usuarioSeleccionado}"]`)?.classList.remove('oculto');
    }

    document.querySelectorAll('.grupo:not(.oculto) .leds').forEach(contenedor => {
        const grupo = contenedor.dataset.grupo;
        const linea = contenedor.dataset.linea;
        const ledsPorLinea = (linea === 'linea1' || grupo.startsWith('CALIDAD_')) ? 5 : 5;
        contenedor.innerHTML = '';
        for(let i = 0; i < ledsPorLinea; i++){
            const led = document.createElement('div');
            led.className = 'led';
            let index = (linea === 'linea2' ? 5 : 0) + i; // Índice global para el grupo
            if (grupo.startsWith('CALIDAD_')) index = i;
            led.title = `${grupo} • ${linea} • LED ${i+1}`;
            led.addEventListener('click', () => togglearLED(grupo, index, linea));
            contenedor.appendChild(led);
        }
    });
}

function pintarEstado(estados) {
    estados = estados || {};
    document.querySelectorAll('.leds').forEach(contenedor => {
        const grupo = contenedor.dataset.grupo;
        const linea = contenedor.dataset.linea;
        const ledsGrupo = estados[grupo]?.[linea] || [];

        contenedor.querySelectorAll('.led').forEach((led, i) => {
            const estado = ledsGrupo[i];
            led.className = 'led'; // Resetea clases
            led.textContent = ''; // Limpia texto

            if (estado) {
                if (estado.color) led.classList.add(estado.color);
                if (estado.encendido) led.classList.add('on');
                if (estado.tarimaId) {
                    led.textContent = estado.tarimaId.slice(-4); // Muestra últimos 4 chars del ID
                }
            }
        });
    });
}

// ================= LÓGICA DE TURNOS Y TIEMPO =================
function formatoHora(isoString) {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    return date.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
}

function obtenerTurnoActual() {
    const ahora = new Date();
    const hora = ahora.getHours();
    let fecha = new Date(ahora);
    let turno = (hora >= 6 && hora < 18) ? 'Turno 1' : 'Turno 2';
    if (turno === 'Turno 2' && hora < 6) {
        fecha.setDate(ahora.getDate() - 1);
    }
    const fechaFormateada = fecha.toISOString().split('T')[0];
    return { fecha: fechaFormateada, turno };
}


// ================= LISTENERS DE FIREBASE (TIEMPO REAL) =================
function limpiarListeners() {
    firebaseListeners.forEach(listener => listener.ref.off(listener.evento, listener.callback));
    firebaseListeners = [];
}

function iniciarListenersFirebase() {
    limpiarListeners();
    const { fecha, turno } = obtenerTurnoActual();
    document.getElementById('turnoActual').textContent = `Turno: ${turno}`;

    const refs = {
        estadoLEDs: db.ref('estadoLEDs'),
        historial: db.ref(`historialLogs/${fecha}/${turno}`),
        contadoresCalidad: db.ref(`contadoresCalidad/${fecha}/${turno}`),
        tarimasLiberadas: db.ref('tarimasLiberadas') // Nueva ruta para tarimas listas para producción
    };

    const addListener = (ref, evento, callback) => {
        ref.on(evento, callback);
        firebaseListeners.push({ ref, evento, callback });
    };

    // Listener para el estado visual de los LEDs
    addListener(refs.estadoLEDs, 'value', snapshot => pintarEstado(snapshot.val()));

    // Listener para el resumen de turno y tiempos
    addListener(refs.historial, 'value', snapshot => {
        const logs = snapshot.val() || {};
        let tarimasRecolectadas = 0;
        let tiempoTotal = 0;
        const tiemposPorGrupo = {};

        Object.values(logs).forEach(log => {
            if (log.accion === 'recolectada' && log.tiempoRecoleccion != null) {
                tarimasRecolectadas++;
                tiempoTotal += log.tiempoRecoleccion;
                if (!tiemposPorGrupo[log.grupo]) tiemposPorGrupo[log.grupo] = [];
                tiemposPorGrupo[log.grupo].push(log);
            }
        });

        const promedio = tarimasRecolectadas > 0 ? (tiempoTotal / tarimasRecolectadas).toFixed(1) : 0;
        document.getElementById('tarimasTotales').textContent = tarimasRecolectadas;
        document.getElementById('tiempoPromedio').textContent = `${promedio} min`;

        // Actualizar UI de tiempos por grupo
        document.querySelectorAll('.tiempos').forEach(div => div.innerHTML = '');
        for(const grupo in tiemposPorGrupo) {
            const div = document.querySelector(`.tiempos[data-grupo="${grupo}"]`);
            if (div) {
                div.innerHTML = tiemposPorGrupo[grupo]
                    .slice(-5) // últimos 5
                    .map(l => `<p>Tarima ${l.tarimaId.slice(-4)}: ${l.tiempoRecoleccion} min</p>`)
                    .join('');
            }
        }
    });

    // Listener para contadores de calidad en la UI
    addListener(refs.contadoresCalidad, 'value', snapshot => {
        const contadores = snapshot.val() || {};
        ['CALIDAD_MULTIPORT', 'CALIDAD_DROPS', 'CALIDAD_BEDROCK'].forEach(grupo => {
            const data = contadores[grupo] || { liberadas: 0, rechazadas: 0 };
            document.getElementById(`liberadas_${grupo}`).textContent = data.liberadas;
            document.getElementById(`rechazadas_${grupo}`).textContent = data.rechazadas;
        });
    });

    // Mostrar resumen solo a usuarios relevantes
    const resumenTurnoDiv = document.getElementById('resumenTurno');
    if (usuarioSeleccionado === 'LOGÍSTICA' || usuarioSeleccionado === 'SUPERVISOR') {
        resumenTurnoDiv.classList.remove('oculto');
    } else {
        resumenTurnoDiv.classList.add('oculto');
    }
}


// ================= LÓGICA DE ACCIONES CON TARIMAS =================

// Función central para registrar eventos
function registrarAccion(accion, detalles) {
    const { fecha, turno } = obtenerTurnoActual();
    const log = {
        accion,
        usuario: usuarioSeleccionado,
        timestamp: new Date().toISOString(),
        ...detalles
    };
    db.ref(`historialLogs/${fecha}/${turno}`).push(log);
}


// Función principal que decide qué hacer al hacer clic en un LED
function togglearLED(grupo, idx, linea) {
    const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
    ledRef.once('value', snapshot => {
        const estadoActual = snapshot.val();
        contextoActivo = { grupo, idx, linea, tarimaId: estadoActual?.tarimaId, data: estadoActual };

        // --- Lógica para LOGÍSTICA ---
        if (usuarioSeleccionado === 'LOGÍSTICA') {
            if (estadoActual?.encendido && estadoActual.tarimaId) {
                if (confirm(`¿Confirmar recolección de tarima ${estadoActual.tarimaId}?`)) {
                    const horaEncendido = new Date(estadoActual.horaEncendido);
                    const tiempoRecoleccion = Math.round((new Date() - horaEncendido) / 60000); // en minutos
                    
                    registrarAccion('recolectada', {
                        tarimaId: estadoActual.tarimaId,
                        grupo,
                        tiempoRecoleccion
                    });
                    ledRef.set(null); // Limpia el LED
                }
            } else {
                alert('Solo puedes recolectar tarimas encendidas.');
            }
        // --- Lógica para PRODUCCIÓN ---
        } else if (CONFIG.PRODUCCION_GRUPOS.includes(usuarioSeleccionado) && usuarioSeleccionado === grupo) {
            if (!estadoActual) { // Si el LED está vacío
                abrirModal('modalAsignarTarimaProduccion');
            } else {
                alert('Este LED ya está ocupado.');
            }
        // --- Lógica para CALIDAD ---
        } else if (usuarioSeleccionado.startsWith('CALIDAD_') && usuarioSeleccionado === grupo) {
            if (estadoActual?.tarimaId) {
                document.getElementById('modal-tarima-id').textContent = estadoActual.tarimaId;
                abrirModal('modalCalidad');
            } else {
                alert("Este LED está vacío. Asigna una tarima desde el panel 'TARIMAS'.");
            }
        }
    });
}

// ================= MANEJO DE MODALES Y PANEL LATERAL =================
function cerrarModal(id) {
    document.getElementById(id)?.classList.remove('visible');
}

function abrirModal(id) {
    const modal = document.getElementById(id);
    if (id === 'modalAsignarTarimaProduccion') {
        const select = document.getElementById('selectTarimaProduccion');
        select.innerHTML = '<option>Cargando...</option>';
        const grupoProd = usuarioSeleccionado;
        // Busca tarimas que Calidad marcó como 'liberadas' para este grupo
        db.ref('tarimasLiberadas').child(grupoProd).once('value', snapshot => {
            select.innerHTML = '';
            if (!snapshot.exists()) {
                select.innerHTML = '<option>No hay tarimas disponibles</option>';
                return;
            }
            snapshot.forEach(tarimaSnap => {
                const opt = document.createElement('option');
                opt.value = tarimaSnap.key;
                opt.textContent = tarimaSnap.key;
                select.appendChild(opt);
            });
        });
    }
    modal?.classList.add('visible');
}

// Acciones del modal de Calidad
document.querySelectorAll('#modalCalidad .opcion-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const color = btn.dataset.color;
        const { grupo, idx, linea, tarimaId } = contextoActivo;
        const { fecha, turno } = obtenerTurnoActual();
        const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
        const contadoresRef = db.ref(`contadoresCalidad/${fecha}/${turno}/${grupo}`);

        if (color === 'verde') { // Liberada
            const grupoProd = grupo.replace('CALIDAD_', '');
            db.ref('tarimasLiberadas').child(grupoProd).child(tarimaId).set(true); // Poner disponible para producción
            ledRef.set(null); // Limpiar LED de calidad
            contadoresRef.child('liberadas').transaction(v => (v || 0) + 1);
            registrarAccion('liberada', { tarimaId, grupo });
            alert(`Tarima ${tarimaId} liberada para ${grupoProd}.`);
        } else { // Rechazada
            abrirModal('modalRechazo');
        }
        cerrarModal('modalCalidad');
    });
});

// Formulario de rechazo
document.getElementById('formularioRechazo').addEventListener('submit', e => {
    e.preventDefault();
    const { grupo, idx, linea, tarimaId } = contextoActivo;
    const { fecha, turno } = obtenerTurnoActual();
    const contadoresRef = db.ref(`contadoresCalidad/${fecha}/${turno}/${grupo}`);
    const formData = new FormData(e.target);
    const detallesRechazo = Object.fromEntries(formData.entries());

    db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`).set(null); // Limpiar LED
    contadoresRef.child('rechazadas').transaction(v => (v || 0) + 1);
    registrarAccion('rechazada', { tarimaId, grupo, detalles: detallesRechazo });
    
    // Guardar detalles del rechazo para reportes
    db.ref(`rechazosDetallados/${fecha}/${turno}`).push({ tarimaId, grupo, ...detallesRechazo });
    
    alert(`Tarima ${tarimaId} rechazada.`);
    cerrarModal('modalRechazo');
    e.target.reset();
});


// Botón de asignar en Producción
document.getElementById('btnAsignarProduccion').addEventListener('click', () => {
    const tarimaId = document.getElementById('selectTarimaProduccion').value;
    if (!tarimaId) return alert('Selecciona una tarima.');
    
    const { grupo, idx, linea } = contextoActivo;
    const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
    
    // Asigna la tarima al LED de producción
    ledRef.set({
        encendido: true,
        tarimaId: tarimaId,
        usuario: usuarioSeleccionado,
        horaEncendido: new Date().toISOString()
    });
    
    // Elimina la tarima de la lista de liberadas
    db.ref('tarimasLiberadas').child(grupo).child(tarimaId).remove();
    
    registrarAccion('asignada_produccion', { tarimaId, grupo });
    alert(`Tarima ${tarimaId} asignada a producción.`);
    cerrarModal('modalAsignarTarimaProduccion');
});

// Lógica del Panel Lateral (FAB)
const panelUI = {
    panel: document.getElementById('mtPanel'),
    openBtn: document.getElementById('mtOpenBtn'),
    closeBtn: document.getElementById('mtCloseBtn'),
    bxInput: document.getElementById('bxInput'),
    buscarBtn: document.getElementById('buscarTarimaBtn'),
    infoBox: document.getElementById('tarimaInfo'),
    tarimaId: document.getElementById('tarimaId'),
    empleadoPanel: document.getElementById('empleadoPanel'),
    turnoPanel: document.getElementById('turnoPanel'),
    estadoPanel: document.getElementById('estadoPanel'),
    ledAssignment: document.getElementById('ledAssignment'),
    ledSelect: document.getElementById('ledSelect'),
    asignarLedBtn: document.getElementById('asignarLedBtn')
};

panelUI.openBtn.addEventListener('click', () => panelUI.panel.classList.add('open'));
panelUI.closeBtn.addEventListener('click', () => panelUI.panel.classList.remove('open'));
panelUI.buscarBtn.addEventListener('click', () => {
    const id = panelUI.bxInput.value.trim();
    if (!id) return;
    // Asumimos que tienes una ruta /tarimas/{id} con la info
    db.ref(`tarimas/${id}`).once('value', snapshot => {
        if (!snapshot.exists()) {
            panelUI.infoBox.style.display = 'none';
            return alert('Tarima no encontrada.');
        }
        const data = snapshot.val();
        contextoActivo.tarimaId = snapshot.key; // Guarda el ID para usarlo después
        panelUI.tarimaId.textContent = snapshot.key;
        panelUI.empleadoPanel.textContent = data.empleadoId || 'N/D';
        panelUI.turnoPanel.textContent = data.turno || 'N/D';
        panelUI.estadoPanel.textContent = (data.estado || 'CREADA').toUpperCase();
        panelUI.infoBox.style.display = 'block';

        // Lógica de asignación para Calidad
        if (usuarioSeleccionado.startsWith('CALIDAD_') && (data.estado || 'creada') === 'creada') {
            panelUI.ledAssignment.style.display = 'block';
            const select = panelUI.ledSelect;
            select.innerHTML = '<option>Buscando LEDs...</option>';
            // Busca LEDs vacíos en el área de calidad del usuario
            db.ref(`estadoLEDs/${usuarioSeleccionado}/linea1`).once('value', ledSnap => {
                const leds = ledSnap.val() || [];
                select.innerHTML = '';
                for (let i = 0; i < CONFIG.LEDS_POR_GRUPO[usuarioSeleccionado]; i++) {
                    if (!leds[i]) {
                        const opt = document.createElement('option');
                        opt.value = i;
                        opt.textContent = `LED ${i+1}`;
                        select.appendChild(opt);
                    }
                }
                if (select.innerHTML === '') select.innerHTML = '<option>No hay LEDs libres</option>';
            });
        } else {
            panelUI.ledAssignment.style.display = 'none';
        }
    });
});

panelUI.asignarLedBtn.addEventListener('click', () => {
    const idx = panelUI.ledSelect.value;
    if (idx === '' || !contextoActivo.tarimaId) return alert('Selecciona un LED y una tarima.');
    
    const tarimaId = contextoActivo.tarimaId;
    const ledRef = db.ref(`estadoLEDs/${usuarioSeleccionado}/linea1/${idx}`);
    
    ledRef.set({
        color: 'naranja', // Estado inicial "en revisión"
        tarimaId: tarimaId,
        usuario: usuarioSeleccionado,
        timestamp: new Date().toISOString()
    });

    // Actualiza el estado de la tarima principal
    db.ref(`tarimas/${tarimaId}`).update({ estado: 'en_calidad' });

    registrarAccion('asignada_calidad', { tarimaId, grupo: usuarioSeleccionado });
    alert(`Tarima ${tarimaId} asignada a revisión en LED ${parseInt(idx)+1}.`);
    panelUI.panel.classList.remove('open');
});

// ================= NAVEGACIÓN Y ARRANQUE =================
function activarPantalla(id){
    document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
    const pantalla = document.getElementById(id);
    // Usar flex en lugar de block para que los estilos de centrado funcionen
    pantalla.style.display = 'flex'; 
    pantalla.classList.add('activa');
}

function volverAPantalla1(){
    usuarioSeleccionado = null;
    limpiarListeners();
    document.getElementById('mtOpenBtn').style.display = 'none';
    activarPantalla('pantalla1');
}

function seleccionarUsuario(usuario) {
    let password;
    let targetUser = usuario;

    if (usuario === 'CALIDAD') {
        password = prompt('Introduce la contraseña para CALIDAD:');
        if (password === CONFIG.PASSWORDS['CALIDAD_MULTIPORT']) targetUser = 'CALIDAD_MULTIPORT';
        else if (password === CONFIG.PASSWORDS['CALIDAD_DROPS']) targetUser = 'CALIDAD_DROPS';
        else if (password === CONFIG.PASSWORDS['CALIDAD_BEDROCK']) targetUser = 'CALIDAD_BEDROCK';
        else return alert('Contraseña incorrecta.');
    } else {
        password = prompt(`Introduce la contraseña para ${usuario}:`);
        if (password !== CONFIG.PASSWORDS[usuario]) {
            return alert('Contraseña incorrecta.');
        }
    }

    usuarioSeleccionado = targetUser;
    document.getElementById('tituloFijo').textContent = targetUser.replace('_', ' ');
    document.getElementById('mtOpenBtn').style.display = 'block';
    activarPantalla('pantalla2');
    inyectaLEDs();
    iniciarListenersFirebase();
}
  
function seleccionarReporte() {
    const password = prompt('Introduce la contraseña para REPORTES:');
    if (password === CONFIG.PASSWORDS['REPORTES']) {
        activarPantalla('pantalla3');
        document.getElementById('tituloReportes').textContent = 'REPORTES';
        document.getElementById('selectoresReportes').style.display = 'flex';
        document.getElementById('contenedorReporte').innerHTML = '<h2>Selecciona un reporte</h2>';
    } else {
        alert('Contraseña incorrecta. Acceso denegado.');
    }
}
    
function seleccionarDashboard() {
    const password = prompt('Introduce la contraseña para DASHBOARD:');
    if (password === CONFIG.PASSWORDS['DASHBOARD']) {
        activarPantalla('pantalla4');
        iniciarDashboard();
    } else {
        alert('Contraseña incorrecta. Acceso denegado.');
    }
}


// A PARTIR DE AQUÍ ESTÁ LA LÓGICA DE DASHBOARD Y REPORTES
// La he revisado para que sea compatible con la nueva estructura de `historialLogs`
// Ahora debería funcionar correctamente al leer los nuevos eventos.

function iniciarDashboard() {
    limpiarListeners();
    const { fecha } = obtenerTurnoActual();
    document.getElementById('fechaDashboard').value = fecha;
    document.getElementById('turnoDashboardSelect').value = 'todos';
    
    const setup = () => {
        limpiarListeners();
        const fechaSel = document.getElementById('fechaDashboard').value;
        const turnoSel = document.getElementById('turnoDashboardSelect').value;
        setupDashboardListeners(fechaSel, turnoSel);
    };

    document.getElementById('fechaDashboard').addEventListener('change', setup);
    document.getElementById('turnoDashboardSelect').addEventListener('change', setup);
    setup();
}

function setupDashboardListeners(fecha, turnoFiltro) {
    const historialRef = db.ref(`historialLogs/${fecha}`);
    const ledsRef = db.ref('estadoLEDs');

    const historialCallback = snapshot => {
        const turnos = snapshot.val() || {};
        let logsAgregados = [];
        if (turnoFiltro === 'todos') {
            Object.values(turnos).forEach(dataTurno => {
                logsAgregados.push(...Object.values(dataTurno));
            });
        } else if (turnos[turnoFiltro]) {
            logsAgregados = Object.values(turnos[turnoFiltro]);
        }
        actualizarDashboard(logsAgregados);
    };
    
    const ledsCallback = snapshot => {
        actualizarTablaPendientes(snapshot.val() || {});
    };

    historialRef.on('value', historialCallback);
    ledsRef.on('value', ledsCallback);
    
    firebaseListeners.push({ ref: historialRef, evento: 'value', callback: historialCallback });
    firebaseListeners.push({ ref: ledsRef, evento: 'value', callback: ledsCallback });
}

function actualizarDashboard(logs) {
    const kpis = {
        asignadas: 0,
        recolectadas: 0,
        tiempoTotal: 0,
        liberadas: 0,
        rechazadas: 0,
        prodPorArea: {},
        recoleccionPorHora: {}
    };

    logs.forEach(log => {
        switch(log.accion) {
            case 'asignada_produccion':
                kpis.asignadas++;
                kpis.prodPorArea[log.grupo] = (kpis.prodPorArea[log.grupo] || 0) + 1;
                break;
            case 'recolectada':
                kpis.recolectadas++;
                kpis.tiempoTotal += log.tiempoRecoleccion || 0;
                const hora = new Date(log.timestamp).getHours();
                kpis.recoleccionPorHora[hora] = (kpis.recoleccionPorHora[hora] || 0) + 1;
                break;
            case 'liberada':
                kpis.liberadas++;
                break;
            case 'rechazada':
                kpis.rechazadas++;
                break;
        }
    });

    const tiempoPromedio = kpis.recolectadas > 0 ? (kpis.tiempoTotal / kpis.recolectadas).toFixed(1) : 0;
    const totalCalidad = kpis.liberadas + kpis.rechazadas;
    const tasaRechazo = totalCalidad > 0 ? ((kpis.rechazadas / totalCalidad) * 100).toFixed(1) : 0;

    document.getElementById('dashTarimasConfirmadas').textContent = kpis.asignadas;
    document.getElementById('dashTarimasRecolectadas').textContent = kpis.recolectadas;
    document.getElementById('dashTiempoPromedio').textContent = `${tiempoPromedio} min`;
    document.getElementById('dashTasaRechazo').textContent = `${tasaRechazo}%`;
    document.getElementById('kpiTiempoPromedio').classList.toggle('alerta', tiempoPromedio > 15);
    document.getElementById('kpiTasaRechazo').classList.toggle('alerta', tasaRechazo > 5);

    // Gráficos
    generarGraficoDash('graficoProduccionDash', 'bar', {
        labels: Object.keys(kpis.prodPorArea),
        datasets: [{ label: 'Asignadas', data: Object.values(kpis.prodPorArea), backgroundColor: '#36A2EB' }]
    });
    generarGraficoDash('graficoCalidadDash', 'pie', {
        labels: ['Liberadas', 'Rechazadas'],
        datasets: [{ data: [kpis.liberadas, kpis.rechazadas], backgroundColor: ['#4caf50', '#f44336'] }]
    });
    const horas = Object.keys(kpis.recoleccionPorHora).sort((a,b) => a-b);
    generarGraficoDash('graficoLogisticaDash', 'line', {
        labels: horas.map(h => `${h}:00`),
        datasets: [{ label: 'Recolectadas por Hora', data: horas.map(h => kpis.recoleccionPorHora[h]), borderColor: '#FFCE56', fill: false }]
    });
}

function actualizarTablaPendientes(estadoLEDs) {
    const tablaBody = document.querySelector('#tablaPendientes tbody');
    tablaBody.innerHTML = '';
    CONFIG.PRODUCCION_GRUPOS.forEach(grupo => {
        for (const linea in estadoLEDs[grupo] || {}) {
            (estadoLEDs[grupo][linea] || []).forEach(led => {
                if (led?.encendido && led.tarimaId && led.horaEncendido) {
                    const tr = document.createElement('tr');
                    const espera = Math.round((Date.now() - new Date(led.horaEncendido)) / 60000);
                    tr.innerHTML = `<td>${grupo}</td><td>${led.tarimaId}</td><td>${espera} min</td>`;
                    tablaBody.appendChild(tr);
                }
            });
        }
    });
}

function generarGraficoDash(canvasId, type, data) {
    if (graficosDashboard[canvasId]) graficosDashboard[canvasId].destroy();
    const ctx = document.getElementById(canvasId).getContext('2d');
    graficosDashboard[canvasId] = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, color: '#fff' } });
}


// ... (Las funciones de reporte como `mostrarReporte`, `exportarReporte`, etc. se dejan intactas pero ahora funcionarán con los datos correctos)
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('#selectoresReportes .usuario-btn').forEach(btn => {
        btn.addEventListener('click', (e) => mostrarReporte(e.target.dataset.reporte));
    });
});
function mostrarReporte(tipo) { console.log("Mostrar reporte:", tipo); /* Implementación de reportes */ }
function exportarReporte(formato) { console.log("Exportar a:", formato); /* Implementación de exportación */ }

// ================= ARRANQUE INICIAL =================
window.addEventListener('load', ()=>{
    firebase.auth().signInAnonymously().catch(err => console.error('Auth error:', err));
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            activarPantalla('pantalla1');
        }
    });
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(err => console.error("SW reg failed:", err));
    }
});

</script>
</body>
</html>
