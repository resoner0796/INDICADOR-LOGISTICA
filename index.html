<!DOCTYPE html>
<html lang="es">
<head>
  <!-- =======================================================
       PANEL LOG√çSTICA ‚Äî INDEX √öNICO (Dark + console.log)
       ======================================================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel Log√≠stica</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#121212" />
  <link rel="icon" href="icon-192.png" type="image/png" />

  <style>
    /* =======================================================
       === ESTILOS GLOBALES DARK ===
       ======================================================= */
    :root {
      --bg: #121212;
      --bg-2: #1b1f24;
      --panel: #1e1e1e;
      --text: #e8e8e8;
      --muted: #b8b8b8;
      --accent: #4caf50;
      --warn: #ff9800;
      --danger: #f44336;
      --info: #2196f3;
      --border: #2a2f36;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    h1,h2,h3,h4 { margin: 0 0 10px; }
    a,button { cursor: pointer; }
    .oculto { display: none !important; }

    /* =======================================================
       === LAYOUT PANTALLAS ===
       ======================================================= */
    .pantalla { display: none; padding: 20px; }
    .pantalla.activa { display: block; }
    #tituloFijo { font-size: 22px; font-weight: 700; margin: 8px 0 16px; }

    .btn {
      background: #2a2f36;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      transition: .2s;
    }
    .btn:hover { background: #343a43; }
    .btn.primary { background: var(--info); border-color: var(--info); }
    .btn.success { background: var(--accent); border-color: var(--accent); }
    .btn.warn { background: var(--warn); border-color: var(--warn); }
    .btn.danger { background: var(--danger); border-color: var(--danger); }

    .row { display: flex; flex-wrap: wrap; gap: 16px; align-items: center; }
    .col { flex: 1 1 260px; min-width: 260px; }

    /* =======================================================
       === TARJETAS / PANEL ===
       ======================================================= */
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }

    /* =======================================================
       === LEDS ===
       ======================================================= */
    .leds { display: grid; grid-template-columns: repeat(auto-fit, minmax(46px,1fr)); gap: 10px; }
    .led {
      height: 46px; border-radius: 12px;
      background: #3d4450; color: #fff;
      display: grid; place-items: center; font-weight: 700;
      border: 1px solid var(--border);
      transition: transform .06s ease;
      user-select: none;
    }
    .led:active { transform: scale(.96); }
    .led.on { background: var(--info); }
    .led.verde { background: var(--accent); }
    .led.rojo { background: var(--danger); }
    .led.naranja { background: var(--warn); color: #20262d; }
    .led.disabled { background: #2e3440; color: #667; }

    .grupo-title { font-size: 16px; font-weight: 700; margin: 6px 0 10px; opacity:.9 }
    .grupo-wrap { margin-bottom: 18px; }

    /* =======================================================
       === MODALES DARK (Calidad / Rechazo / Producci√≥n) ===
       ======================================================= */
    .modal {
      position: fixed; inset: 0; display: grid; place-items: center;
      background: rgba(0,0,0,.8); z-index: 1000;
      visibility: hidden; opacity: 0; transition: opacity .25s ease;
    }
    .modal.visible { visibility: visible; opacity: 1; }
    .modal-content {
      width: min(92vw, 560px);
      background: #171a1f;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 22px;
      box-shadow: 0 10px 40px rgba(0,0,0,.45);
    }
    .modal h3 { font-size: 20px; margin-bottom: 14px; }
    .modal .grid { display: grid; gap: 12px; }
    .modal .row { gap: 10px; }
    .modal .btn { width: 100%; }

    .opciones { display: grid; gap: 10px; margin: 12px 0 18px; }
    .opcion-btn { padding: 12px 14px; border-radius: 10px; border: 0; font-weight: 700; }
    .opcion-btn[data-color="naranja"] { background: var(--warn); color: #111; }
    .opcion-btn[data-color="rojo"]    { background: var(--danger); }
    .opcion-btn[data-color="verde"]   { background: var(--accent); }

    .input, select, textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      background: #0f1216; color: var(--text);
      border: 1px solid var(--border); outline: none;
    }
    label { font-size: 13px; color: var(--muted); }

    /* =======================================================
       === LISTAS TARIMAS (pendientes / recibidas) ===
       ======================================================= */
    .list { display: grid; gap: 8px; }
    .tarima-item {
      background: #111419; border: 1px solid var(--border);
      border-radius: 10px; padding: 12px;
      display: grid; gap: 4px;
    }
    .tarima-head { display:flex; justify-content:space-between; align-items:center; }
    .badge { padding: 3px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); opacity:.85 }
    .badge.info { background: #0d2740; color: #9cd1ff; border-color: #1a3c5f; }
    .badge.warn { background: #3c2a00; color: #ffd699; border-color: #5f430a; }
    .badge.ok   { background: #07330d; color: #b9ffbf; border-color: #0b5a15; }

    /* =======================================================
       === STATS DASHBOARD ===
       ======================================================= */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; }
    .stat-card { text-align: center; padding: 16px; border-radius: 12px; background: var(--panel); border:1px solid var(--border); }
    .stat-card h3 { font-size: 30px; margin: 4px 0; }

    /* mini helper */
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt20{margin-top:20px}
    .mb8{margin-bottom:8px}.mb12{margin-bottom:12px}.mb16{margin-bottom:16px}.mb20{margin-bottom:20px}
  </style>
</head>
<body>
  <!-- =======================================================
       LOGIN / SELECCI√ìN DE USUARIO
       ======================================================= -->
  <div id="pantalla1" class="pantalla activa">
    <h1>Selecciona Usuario</h1>
    <div class="row mt16">
      <button class="btn" onclick="seleccionarUsuario('SUPERVISOR')">Supervisor</button>
      <button class="btn" onclick="seleccionarUsuario('CALIDAD')">Calidad</button>
      <button class="btn" onclick="seleccionarUsuario('MULTIPORT')">Multiport</button>
      <button class="btn" onclick="seleccionarUsuario('DROPS')">Drops</button>
      <button class="btn" onclick="seleccionarUsuario('BEDROCK')">Bedrock</button>
      <button class="btn" onclick="seleccionarUsuario('LOG√çSTICA')">Log√≠stica</button>
    </div>
  </div>

  <!-- =======================================================
       PANTALLA PRINCIPAL
       ======================================================= -->
  <div id="pantalla2" class="pantalla">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h2 id="tituloFijo">Panel</h2>
      <div>
        <button class="btn" onclick="activarPantalla('pantallaReportes')">Reportes</button>
        <button class="btn" onclick="activarPantalla('pantallaDashboard')">Dashboard</button>
        <button class="btn" onclick="volverLogin()">Salir</button>
      </div>
    </div>

    <!-- === Panel Buscar BX / Asignaci√≥n (solo CALIDAD_*) === -->
    <div id="panelBusquedaCalidad" class="card mt12 oculto">
      <h3>Identificar Tarima por BX</h3>
      <div class="row mt8">
        <input id="bxBuscar" class="input col" placeholder="Escanea o escribe BX..."/>
        <button class="btn primary" onclick="buscarTarimaPorBX()">Buscar</button>
      </div>
      <div id="resultadoBX" class="mt12 oculto">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <div><b>ID:</b> <span id="bxTarimaId">‚Äî</span></div>
              <div><b>Empleado:</b> <span id="bxTarimaEmpleado">‚Äî</span></div>
              <div><b>Turno:</b> <span id="bxTarimaTurno">‚Äî</span></div>
              <div><b>Cajas:</b> <span id="bxTarimaCajas">‚Äî</span> | <b>Piezas:</b> <span id="bxTarimaPiezas">‚Äî</span></div>
            </div>
            <div>
              <label class="mb8">Asignar a LED (l√≠nea1-X):</label>
              <div class="row">
                <select id="selectLedCalidad" class="input" style="max-width:180px"></select>
                <button class="btn success" onclick="asignarLedATarimaDesdePanel()">Asignar</button>
              </div>
              <small class="mt8" style="display:block;opacity:.7">Solo aparecen LEDs libres.</small>
            </div>
          </div>
          <div class="mt12"><b>Cajas:</b><ul id="bxTarimaCajasLista" style="margin:6px 0 0 18px"></ul></div>
        </div>
      </div>
    </div>

    <!-- === LEDs (Calidad + Producci√≥n + Log√≠stica) === -->
    <div id="panelLEDs" class="mt16"></div>

    <!-- === Tarimas Pendientes ‚Üí Calidad === -->
    <div class="card mt20">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h3>Tarimas Pendientes por Calidad</h3>
        <span class="badge warn">Pendientes</span>
      </div>
      <div id="tarimasPendientes" class="list mt12"></div>
    </div>

    <!-- === Tarimas Recibidas ‚Üí Producci√≥n === -->
    <div class="card mt20">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h3>Tarimas Recibidas (Producci√≥n)</h3>
        <span class="badge info">En Producci√≥n</span>
      </div>
      <div id="tarimasRecibidas" class="list mt12"></div>
    </div>
  </div>

  <!-- =======================================================
       REPORTES
       ======================================================= -->
  <div id="pantallaReportes" class="pantalla">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h2>Reportes</h2>
      <button class="btn" onclick="activarPantalla('pantalla2')">Volver</button>
    </div>
    <div class="card mt12">
      <div class="row">
        <div class="col">
          <label>Fecha inicio</label>
          <input type="date" id="repInicio" class="input"/>
        </div>
        <div class="col">
          <label>Fecha fin</label>
          <input type="date" id="repFin" class="input"/>
        </div>
        <div class="col">
          <label>√Årea</label>
          <select id="repArea" class="input">
            <option value="">Todas</option>
            <option value="MULTIPORT">Multiport</option>
            <option value="DROPS">Drops</option>
            <option value="BEDROCK">Bedrock</option>
            <option value="CALIDAD">Calidad</option>
            <option value="LOG√çSTICA">Log√≠stica</option>
          </select>
        </div>
        <div class="col">
          <label>Turno</label>
          <select id="repTurno" class="input">
            <option value="">Todos</option>
            <option value="1">Turno 1</option>
            <option value="2">Turno 2</option>
            <option value="3">Turno 3</option>
          </select>
        </div>
      </div>
      <div class="row mt12">
        <button class="btn primary" onclick="generarReporte()">Generar</button>
        <button class="btn" onclick="exportarCSV()">Exportar CSV</button>
      </div>
    </div>
    <div id="reporteResultado" class="mt16"></div>
  </div>

  <!-- =======================================================
       DASHBOARD
       ======================================================= -->
  <div id="pantallaDashboard" class="pantalla">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h2>Dashboard</h2>
      <button class="btn" onclick="activarPantalla('pantalla2')">Volver</button>
    </div>
    <div class="stats mt12">
      <div class="stat-card">
        <h4>Liberadas (Hoy)</h4>
        <h3 id="contadorLiberadas">0</h3>
      </div>
      <div class="stat-card">
        <h4>Rechazadas (Hoy)</h4>
        <h3 id="contadorRechazadas">0</h3>
      </div>
      <div class="stat-card">
        <h4>Recolectadas (Hoy)</h4>
        <h3 id="contadorRecolectadas">0</h3>
      </div>
    </div>
  </div>

  <!-- =======================================================
       MODAL CALIDAD (cambio de estado)
       ======================================================= -->
  <div id="modalCalidad" class="modal">
    <div class="modal-content">
      <h3>Selecciona el estado de la tarima</h3>
      <div class="opciones">
        <button class="opcion-btn" data-color="naranja">En proceso üü°</button>
        <button class="opcion-btn" data-color="rojo">Rechazada üî¥</button>
        <button class="opcion-btn" data-color="verde">Liberada üü¢</button>
      </div>
      <div class="row">
        <button class="btn" onclick="cerrarModal('modalCalidad')">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- =======================================================
       MODAL RECHAZO (formulario)
       ======================================================= -->
  <div id="modalRechazo" class="modal">
    <div class="modal-content">
      <h3>Detalles del Rechazo</h3>
      <form id="formularioRechazo" class="grid">
        <div>
          <label>Empleado Originador</label>
          <input class="input" id="r_empleado" required />
        </div>
        <div>
          <label>L√≠nea afectada</label>
          <input class="input" id="r_linea" required />
        </div>
        <div>
          <label>No. de parte</label>
          <input class="input" id="r_parte" required />
        </div>
        <div>
          <label>Descripci√≥n del No. de parte</label>
          <input class="input" id="r_descparte" required />
        </div>
        <div>
          <label>Descripci√≥n del problema</label>
          <textarea class="input" id="r_problema" required></textarea>
        </div>
        <div>
          <label>Causa ra√≠z</label>
          <textarea class="input" id="r_causa" required></textarea>
        </div>
        <div>
          <label>Acci√≥n correctiva</label>
          <textarea class="input" id="r_accion" required></textarea>
        </div>
        <div class="row">
          <button type="submit" class="btn danger">Guardar Rechazo</button>
          <button type="button" class="btn" onclick="cerrarModal('modalRechazo')">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- =======================================================
       MODAL PRODUCCI√ìN (asignar tarima a LED)
       ======================================================= -->
  <div id="modalProduccion" class="modal">
    <div class="modal-content">
      <h3>Asignar Tarima a LED (Producci√≥n)</h3>
      <div class="grid">
        <div>
          <label>Tarima recibida</label>
          <select id="selectTarimaProduccion" class="input"></select>
        </div>
        <div>
          <label>LED (l√≠nea1-X)</label>
          <select id="selectLedProduccion" class="input"></select>
        </div>
        <div class="row">
          <button class="btn success" onclick="asignarTarimaProduccion()">Asignar</button>
          <button class="btn" onclick="cerrarModal('modalProduccion')">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- =======================================================
       LIBS FIREBASE
       ======================================================= -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- =======================================================
       SCRIPT PRINCIPAL (Firebase + L√≥gica)
       ======================================================= -->
  <script>
    console.log('[INIT] Cargando Panel Log√≠stica');

    // ================= CONFIG =================
    const CONFIG = {
      USUARIOS: ['MULTIPORT','DROPS','BEDROCK','LOG√çSTICA','SUPERVISOR','CALIDAD'],
      PRODUCCION_GRUPOS: ['MULTIPORT','DROPS','BEDROCK'],
      PASSWORDS: {
        'LOG√çSTICA': 'LOGRAM',
        'MULTIPORT': 'MP25',
        'BEDROCK': 'BR25',
        'DROPS': 'DROP25',
        'SUPERVISOR': 'SUP25',
        'CALIDAD_MULTIPORT': 'AQLMP',
        'CALIDAD_DROPS': 'AQLDP',
        'CALIDAD_BEDROCK': 'AQLBR',
        'REPORTES': 'REPO25',
        'DASHBOARD': 'DASH25'
      },
      LEDS_POR_GRUPO: {
        'MULTIPORT': 10,
        'BEDROCK': 10,
        'DROPS': 10,
        'CALIDAD_MULTIPORT': 5,
        'CALIDAD_BEDROCK': 5,
        'CALIDAD_DROPS': 5
      }
    };

    // ============== FIREBASE CONFIG (TU CONFIG) ==============
    const firebaseConfig = {
      apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
      authDomain: "panel-logistica.firebaseapp.com",
      databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
      projectId: "panel-logistica",
      storageBucket: "panel-logistica.appspot.com",
      messagingSenderId: "38365879945",
      appId: "1:38365879945:web:e2f3590fe77f013dba3058"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ledRef = db.ref('estadoLEDs');
    const historialRef = db.ref('historial');
    const tarimasRef = db.ref('tarimas'); // ‚Üê coleccion de tarimas generales (recolecci√≥n)
    const tarimasAsignadasRef = db.ref('tarimasAsignadas'); // tarimaId ‚Üí { ledId, grupo, linea, idx }
    const tarimasRecibidasRef = db.ref('tarimasRecibidas'); // por grupo de producci√≥n
    const contadoresRef = db.ref('contadores'); // { liberadasHoy, rechazadasHoy, recolectadasHoy }
    // Si manejas por √°rea: contadores/areas/{MULTIPORT|...}/{liberadas, rechazadas, recolectadas}

    // ============== ESTADO UI ==============
    let usuarioSeleccionado = null;       // 'MULTIPORT' | 'CALIDAD_MULTIPORT' | 'LOG√çSTICA'...
    let __grupoCalidad = null;            // 'CALIDAD_MULTIPORT' / etc
    let __grupoProduccion = null;         // 'MULTIPORT' / etc
    let ledSeleccionado = { grupo:null, linea:null, idx:null }; // para modal calidad
    let tarimaBXActual = null;            // tarima encontrada por BX
    let listeners = [];

    // ============== HELPERS ==============
    const qs  = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    function activarPantalla(id) {
      qsa('.pantalla').forEach(p=>p.classList.remove('activa'));
      qs('#'+id).classList.add('activa');
    }
    function volverLogin(){
      limpiarListeners();
      usuarioSeleccionado = null;
      __grupoCalidad = null;
      __grupoProduccion = null;
      document.getElementById('tituloFijo').textContent = 'Panel';
      activarPantalla('pantalla1');
    }
    function limpiarListeners(){
      console.log('[Listeners] Limpiando');
      listeners.forEach(unsub => unsub && unsub.off && unsub.off());
      listeners = [];
    }
    function esCalidad(){ return usuarioSeleccionado && usuarioSeleccionado.startsWith('CALIDAD_'); }
    function esProduccion(){ return CONFIG.PRODUCCION_GRUPOS.includes(usuarioSeleccionado); }
    function esLogistica(){ return usuarioSeleccionado === 'LOG√çSTICA'; }
    function getAreaDeCalidad(c){ return (c||'').replace('CALIDAD_',''); }

    // ============== LOGIN / SELECCI√ìN USUARIO ==============
    function seleccionarUsuario(usuario) {
      console.log('[Login] seleccionarUsuario:', usuario);
      if (!CONFIG.USUARIOS.includes(usuario)) return;

      if (usuario === 'SUPERVISOR') {
        const p = prompt('Introduce la contrase√±a para SUPERVISOR:');
        if (p !== CONFIG.PASSWORDS['SUPERVISOR']) return alert('Contrase√±a incorrecta');
        usuarioSeleccionado = 'SUPERVISOR';
      } else if (usuario === 'CALIDAD') {
        const p = prompt('Contrase√±a para CALIDAD (AQLMP/AQLDP/AQLBR):');
        if (p === CONFIG.PASSWORDS['CALIDAD_MULTIPORT']) usuarioSeleccionado = 'CALIDAD_MULTIPORT';
        else if (p === CONFIG.PASSWORDS['CALIDAD_DROPS']) usuarioSeleccionado = 'CALIDAD_DROPS';
        else if (p === CONFIG.PASSWORDS['CALIDAD_BEDROCK']) usuarioSeleccionado = 'CALIDAD_BEDROCK';
        else return alert('Contrase√±a incorrecta');
      } else {
        const p = prompt(`Introduce la contrase√±a para ${usuario}:`);
        if (p !== CONFIG.PASSWORDS[usuario]) return alert('Contrase√±a incorrecta');
        usuarioSeleccionado = usuario;
      }

      // Config contexto
      __grupoCalidad = esCalidad() ? usuarioSeleccionado : null;
      __grupoProduccion = esProduccion() ? usuarioSeleccionado : null;
      document.getElementById('tituloFijo').textContent = usuarioSeleccionado;

      activarPantalla('pantalla2');
      inicializarPantalla2();
      alert(`¬°Bienvenido, ${usuarioSeleccionado}!`);
    }

    // ============== INICIALIZACI√ìN PANTALLA 2 ==============
    function inicializarPantalla2() {
      limpiarListeners();
      inyectaLEDs();
      pintarEstado();
      escucharDashboard();
      renderTarimasPendientes();
      if (esProduccion()) renderTarimasRecibidas(usuarioSeleccionado);
      // Panel BX visible s√≥lo en CALIDAD
      qs('#panelBusquedaCalidad').classList.toggle('oculto', !esCalidad());
      if (esCalidad()) cargarDropdownLedsCalidad(); // precargar disponibles
    }

    // ============== INYECTAR LEDS (HTML) ==============
    function inyectaLEDs(){
      const panel = qs('#panelLEDs');
      panel.innerHTML = '';

      // Grupo CALIDAD del usuario actual (si aplica)
      if (esCalidad()) {
        const g = usuarioSeleccionado; // p.ej. CALIDAD_MULTIPORT
        const wrap = document.createElement('div');
        wrap.className = 'grupo-wrap card';
        wrap.innerHTML = `<div class="grupo-title">${g} ‚Äî L√≠nea 1</div>
          <div class="leds" data-grupo="${g}" data-linea="linea1">
            ${Array.from({length: CONFIG.LEDS_POR_GRUPO[g]||5}).map((_,i)=>`
              <div class="led" id="LED-${g}-linea1-${i}" onclick="togglearLED('${g}', ${i}, 'linea1')">${i+1}</div>
            `).join('')}
          </div>`;
        panel.appendChild(wrap);
      }

      // Grupos PRODUCCI√ìN visibles si el usuario es producci√≥n
      if (esProduccion()) {
        const g = usuarioSeleccionado; // MULTIPORT | DROPS | BEDROCK
        // LEDs de CALIDAD (para recibir) ‚Äî se muestran arriba
        const gCalidad = 'CALIDAD_'+g;
        const wrapC = document.createElement('div');
        wrapC.className = 'grupo-wrap card';
        wrapC.innerHTML = `<div class="grupo-title">${gCalidad} ‚Äî L√≠nea 1 (para RECIBIR)</div>
          <div class="leds" data-grupo="${gCalidad}" data-linea="linea1">
            ${Array.from({length: CONFIG.LEDS_POR_GRUPO[gCalidad]||5}).map((_,i)=>`
              <div class="led" id="LED-${gCalidad}-linea1-${i}" onclick="togglearLED('${gCalidad}', ${i}, 'linea1')">${i+1}</div>
            `).join('')}
          </div>`;
        panel.appendChild(wrapC);

        // LEDs de PRODUCCI√ìN (para asignar tarimas recibidas)
        const wrapP = document.createElement('div');
        wrapP.className = 'grupo-wrap card';
        wrapP.innerHTML = `<div class="grupo-title">${g} ‚Äî L√≠nea 1 (asignar/confirmar)</div>
          <div class="leds" data-grupo="${g}" data-linea="linea1">
            ${Array.from({length: CONFIG.LEDS_POR_GRUPO[g]||10}).map((_,i)=>`
              <div class="led" id="LED-${g}-linea1-${i}" onclick="togglearLED('${g}', ${i}, 'linea1')">${i+1}</div>
            `).join('')}
          </div>`;
        panel.appendChild(wrapP);
      }

      // LOG√çSTICA ve los 3 grupos de producci√≥n
      if (esLogistica() || usuarioSeleccionado==='SUPERVISOR') {
        CONFIG.PRODUCCION_GRUPOS.forEach(g=>{
          const wrap = document.createElement('div');
          wrap.className = 'grupo-wrap card';
          wrap.innerHTML = `<div class="grupo-title">${g} ‚Äî L√≠nea 1</div>
            <div class="leds" data-grupo="${g}" data-linea="linea1">
              ${Array.from({length: CONFIG.LEDS_POR_GRUPO[g]||10}).map((_,i)=>`
                <div class="led" id="LED-${g}-linea1-${i}" onclick="togglearLED('${g}', ${i}, 'linea1')">${i+1}</div>
              `).join('')}
            </div>`;
          panel.appendChild(wrap);
        });
      }
    }

    // ============== PINTAR ESTADO (escucha tiempo real) ==============
    function pintarEstado(){
      console.log('[LEDs] Activando listener estadoLEDs');
      const unsub = ledRef.on('value', snap=>{
        const estados = snap.val() || {};
        qsa('.leds').forEach(contenedor=>{
          const grupo = contenedor.dataset.grupo;
          const linea = contenedor.dataset.linea;
          const ledsArr = (estados[grupo] && estados[grupo][linea]) ? estados[grupo][linea] : [];
          contenedor.querySelectorAll('.led').forEach((ledEl, idx)=>{
            ledEl.classList.remove('on','naranja','rojo','verde','disabled');
            ledEl.innerHTML = (idx+1);

            const st = ledsArr[idx];
            if (!st) return;
            let tarimaId = st.tarimaId || '';
            if (tarimaId) {
              const mini = (tarimaId.length > 6) ? tarimaId.slice(-4) : tarimaId;
              ledEl.innerHTML = mini;
            }
            if (grupo.startsWith('CALIDAD_') && st.color) {
              ledEl.classList.add(st.color);
            } else if (st.encendido) {
              ledEl.classList.add('on');
            }
          });
        });
        // refrescar leds libres en panel calidad (dropdown)
        if (esCalidad()) cargarDropdownLedsCalidad();
      });
      listeners.push({ off: ()=> ledRef.off('value', unsub) });
    }

    // ============== TOGGLE / ACCIONES LEDS ==============
    function togglearLED(grupo, idx, linea='linea1') {
      console.log('[LED] toggle', { grupo, idx, linea, usuarioSeleccionado });
      const ref = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
      const ledPath = `${linea}-${idx+1}`;
      ref.once('value').then(snap=>{
        const st = snap.val() || {};

        // ---- CALIDAD controla solo sus LEDs (color) ----
        if (esCalidad() && grupo === usuarioSeleccionado) {
          if (st.color === 'verde') return alert('Este LED ya est√° liberado.');
          if (!st.tarimaId) return alert('Asigna una tarima a este LED desde el panel por BX.');

          // abrir modal para cambiar estado (naranja/rojo/verde)
          ledSeleccionado = { grupo, idx, linea, tarimaId: st.tarimaId };
          abrirModal('modalCalidad');
          return;
        }

        // ---- PRODUCCI√ìN: recibe de CALIDAD_x y asigna a sus propios LEDs ----
        const miArea = usuarioSeleccionado;
        if (esProduccion() && grupo.startsWith('CALIDAD_')) {
          // recibir tarima liberada
          if (st.color === 'verde' && st.tarimaId) {
            if (!confirm(`¬øRecibir tarima ${st.tarimaId} de ${grupo}?`)) return;
            // push a tarimasRecibidas/{miArea}
            tarimasRecibidasRef.child(miArea).push({
              id: st.tarimaId,
              recibidoEn: Date.now(),
              ledOrigen: ledPath
            });
            // apagar LED de calidad
            ref.set(null);
            historialRef.push({
              usuario: miArea, grupo, led: ledPath,
              accion: 'recibida_de_calidad', tarimaId: st.tarimaId,
              timestamp: new Date().toISOString()
            });
            return;
          }
          return alert('Solo puedes recibir tarimas liberadas (verdes).');
        }

        // PRODUCCI√ìN: clic en su propio LED ‚Üí asignar tarima recibida a LED libre
        if (esProduccion() && grupo === miArea) {
          // LED libre ‚Üí abrir modal asignaci√≥n
          if (!st.encendido && !st.tarimaId) {
            abrirModalProduccionAsignacion(grupo, linea, idx);
            return;
          }
          return alert('Este LED ya tiene tarima asignada.');
        }

        // ---- LOG√çSTICA: solo apaga LEDs con tarima (recolecci√≥n) ----
        if (esLogistica() && CONFIG.PRODUCCION_GRUPOS.includes(grupo)) {
          if (st.encendido && st.tarimaId) {
            if (!confirm(`¬øRecolectar tarima ${st.tarimaId}?`)) return;
            ref.set(null);
            incrementarContador('recolectadasHoy', +1);
            historialRef.push({
              usuario: 'LOG√çSTICA', grupo, led: ledPath,
              accion: 'recolectada', tarimaId: st.tarimaId,
              timestamp: new Date().toISOString()
            });
            return;
          }
          return alert('Solo puedes apagar LEDs con tarima asignada.');
        }

        alert('No tienes permiso para controlar estos LEDs.');
      });
    }

    // ============== MODAL CALIDAD (cambiar estado) ==============
    // Cerrar al elegir opci√≥n + actualizar contadores y DB
    qsa('#modalCalidad .opcion-btn').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const color = e.currentTarget.dataset.color; // naranja / rojo / verde
        console.log('[ModalCalidad] Opci√≥n:', color, ledSeleccionado);
        if (!ledSeleccionado.grupo) return;
        const { grupo, idx, linea, tarimaId } = ledSeleccionado;
        const ref = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
        if (color === 'rojo') {
          // abrir modal de rechazo
          cerrarModal('modalCalidad');
          abrirModal('modalRechazo');
          // guardar tarimaId activo para rechazo
          qs('#formularioRechazo').dataset.tarimaId = tarimaId;
          qs('#formularioRechazo').dataset.ledRef = `estadoLEDs/${grupo}/${linea}/${idx}`;
          return;
        }
        if (color === 'naranja') {
          // vuelve a "en proceso"
          ref.update({ color: 'naranja', timestamp: new Date().toISOString() });
          cerrarModal('modalCalidad');
          return;
        }
        if (color === 'verde') {
          // LIBERADA
          ref.update({ color: 'verde', timestamp: new Date().toISOString() });
          // contador
          const area = getAreaDeCalidad(grupo);
          incrementarContador('liberadasHoy', +1, area);
          // historial
          historialRef.push({
            usuario: grupo, grupo, led: `${linea}-${idx+1}`,
            accion: 'liberada_calidad', tarimaId,
            timestamp: new Date().toISOString()
          });
          cerrarModal('modalCalidad');
          return;
        }
      });
    });

    // ============== MODAL RECHAZO (guardar) ==============
    qs('#formularioRechazo').addEventListener('submit', (e)=>{
      e.preventDefault();
      const f = e.currentTarget;
      const tarimaId = f.dataset.tarimaId;
      const ledPath = f.dataset.ledRef; // 'estadoLEDs/..'
      const payload = {
        tarimaId,
        empleado: qs('#r_empleado').value.trim(),
        linea: qs('#r_linea').value.trim(),
        parte: qs('#r_parte').value.trim(),
        descParte: qs('#r_descparte').value.trim(),
        problema: qs('#r_problema').value.trim(),
        causa: qs('#r_causa').value.trim(),
        accion: qs('#r_accion').value.trim(),
        timestamp: Date.now(),
        usuario: usuarioSeleccionado
      };
      // Guardar rechazo
      db.ref('rechazos').push(payload);
      // pintar LED rojo
      db.ref(ledPath).update({ color:'rojo', timestamp: new Date().toISOString() });
      // contadores
      const grupo = ledPath.split('/')[1]; // CALIDAD_X
      const area = getAreaDeCalidad(grupo);
      incrementarContador('rechazadasHoy', +1, area);
      historialRef.push({
        usuario: usuarioSeleccionado, grupo, led: ledPath.split('/').slice(-2).join('-'),
        accion: 'rechazada_calidad', tarimaId,
        timestamp: new Date().toISOString()
      });
      cerrarModal('modalRechazo');
      f.reset();
    });

    function abrirModal(id){ qs('#'+id).classList.add('visible'); }
    function cerrarModal(id){ qs('#'+id).classList.remove('visible'); }

    // ============== PANEL CALIDAD: Buscar BX + Asignar LED ==============
    async function buscarTarimaPorBX(){
      const bx = qs('#bxBuscar').value.trim();
      if (!bx) return alert('Escanea o escribe un BX.');
      console.log('[BX] Buscar:', bx);

      // Buscar en /tarimas por campo BX (asumimos modelo tarimas/{id:{bx,empleado,turno,totalCajas,totalPiezas,cajas[]}})
      const snap = await tarimasRef.orderByChild('BX').equalTo(bx).once('value');
      const data = snap.val();
      if (!data) {
        qs('#resultadoBX').classList.add('oculto');
        return alert('No se encontr√≥ tarima para ese BX.');
      }
      const [tarimaId, tarima] = Object.entries(data)[0];
      tarimaBXActual = { id: tarimaId, ...tarima };

      // Rellenar UI
      qs('#bxTarimaId').textContent = tarimaId;
      qs('#bxTarimaEmpleado').textContent = tarima.empleadoId || '‚Äî';
      qs('#bxTarimaTurno').textContent = tarima.turno || '‚Äî';
      qs('#bxTarimaCajas').textContent = tarima.totalCajas || 0;
      qs('#bxTarimaPiezas').textContent = tarima.totalPiezas || 0;
      const ul = qs('#bxTarimaCajasLista'); ul.innerHTML = '';
      (tarima.cajas||[]).forEach(c=>{
        const li = document.createElement('li');
        li.textContent = `${c.codigoCaja} | ${c.cantidadPiezas} pz`;
        ul.appendChild(li);
      });

      // Cargar LEDs disponibles
      await cargarDropdownLedsCalidad();

      qs('#resultadoBX').classList.remove('oculto');
    }

    async function cargarDropdownLedsCalidad(){
      if (!esCalidad()) return;
      const grupo = usuarioSeleccionado; // CALIDAD_X
      const linea = 'linea1';
      const total = CONFIG.LEDS_POR_GRUPO[grupo] || 5;
      const sel = qs('#selectLedCalidad');
      if (!sel) return;

      // Obtener LEDs ocupados:
      const ledsSnap = await db.ref(`estadoLEDs/${grupo}/${linea}`).once('value');
      const leds = ledsSnap.val()||[];

      // Generar opciones de libres:
      sel.innerHTML = '';
      for (let i=0; i<total; i++){
        const st = leds[i];
        const ocupado = !!(st && (st.color || st.tarimaId));
        if (!ocupado) {
          const opt = document.createElement('option');
          opt.value = `${i}`;
          opt.textContent = `linea1-${i+1}`;
          sel.appendChild(opt);
        }
      }
      if (!sel.children.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Sin LEDs libres';
        sel.appendChild(opt);
      }
    }

    async function asignarLedATarimaDesdePanel(){
      if (!tarimaBXActual) return alert('Primero identifica una tarima por BX.');
      const sel = qs('#selectLedCalidad');
      const idx = parseInt(sel.value);
      if (isNaN(idx)) return alert('No hay LED disponible seleccionado.');
      const grupo = usuarioSeleccionado; // CALIDAD_X
      const linea = 'linea1';
      const ledRefPath = `estadoLEDs/${grupo}/${linea}/${idx}`;
      const ref = db.ref(ledRefPath);

      // Evitar duplicidad: la tarima ya asignada?
      const ya = (await tarimasAsignadasRef.child(tarimaBXActual.id).once('value')).val();
      if (ya) return alert(`Tarima ${tarimaBXActual.id} ya est√° asignada al LED ${ya.ledId}`);

      await ref.set({
        color: 'naranja',
        tarimaId: tarimaBXActual.id,
        usuario: usuarioSeleccionado,
        timestamp: new Date().toISOString()
      });
      await tarimasAsignadasRef.child(tarimaBXActual.id).set({
        ledId: `${linea}-${idx+1}`,
        grupo, linea, idx,
        timestamp: Date.now()
      });

      historialRef.push({
        usuario: usuarioSeleccionado, grupo, led: `${linea}-${idx+1}`,
        accion: 'asignada_calidad', tarimaId: tarimaBXActual.id,
        timestamp: new Date().toISOString()
      });

      alert(`‚úÖ Tarima ${tarimaBXActual.id} asignada al LED ${linea}-${idx+1}`);
      // refrescar dropdown
      cargarDropdownLedsCalidad();
    }

    // ============== PRODUCCI√ìN: modal asignar tarima a LED ==============
    async function abrirModalProduccionAsignacion(grupo, linea, idx){
      console.log('[Producci√≥n] Abrir modal asignaci√≥n', {grupo,linea,idx});
      // tarimas recibidas
      const list = await tarimasRecibidasRef.child(grupo).once('value');
      const rec = list.val() || {};
      const selTarima = qs('#selectTarimaProduccion');
      selTarima.innerHTML = '';
      Object.values(rec).forEach(t=>{
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = `Tarima ${t.id}`;
        selTarima.appendChild(opt);
      });
      if (!selTarima.children.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No hay tarimas recibidas';
        selTarima.appendChild(opt);
      }

      // leds disponibles en producci√≥n
      const total = CONFIG.LEDS_POR_GRUPO[grupo] || 10;
      const selLed = qs('#selectLedProduccion'); selLed.innerHTML = '';
      const ledsSnap = await db.ref(`estadoLEDs/${grupo}/${linea}`).once('value');
      const leds = ledsSnap.val()||[];
      for (let i=0;i<total;i++){
        const st = leds[i];
        const libre = !(st && (st.encendido || st.tarimaId));
        if (libre) {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = `${linea}-${i+1}`;
          selLed.appendChild(opt);
        }
      }
      // Preseleccionar donde clicke√≥
      if ([...selLed.options].some(o=>+o.value===idx)) selLed.value = String(idx);

      abrirModal('modalProduccion');
      // guardar contexto en dataset
      selLed.dataset.grupo = grupo;
      selLed.dataset.linea = linea;
    }

    async function asignarTarimaProduccion(){
      const selTarima = qs('#selectTarimaProduccion');
      const selLed = qs('#selectLedProduccion');
      const tarimaId = selTarima.value;
      const grupo = selLed.dataset.grupo;
      const linea = selLed.dataset.linea;
      const idx = parseInt(selLed.value);
      if (!tarimaId) return alert('Selecciona una tarima recibida.');

      const ref = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);
      await ref.set({
        encendido: true,
        tarimaId,
        usuario: usuarioSeleccionado,
        timestamp: new Date().toISOString(),
        horaEncendido: firebase.database.ServerValue.TIMESTAMP
      });

      // eliminar de recibidas (solo 1 ejemplar)
      const recSnap = await tarimasRecibidasRef.child(grupo).once('value');
      const rec = recSnap.val()||{};
      const key = Object.keys(rec).find(k=>rec[k].id===tarimaId);
      if (key) await tarimasRecibidasRef.child(`${grupo}/${key}`).remove();

      historialRef.push({
        usuario: usuarioSeleccionado, grupo, led: `${linea}-${idx+1}`,
        accion: 'asignada_produccion', tarimaId,
        timestamp: new Date().toISOString()
      });

      alert(`‚úÖ Tarima ${tarimaId} asignada al LED ${linea}-${idx+1}`);
      cerrarModal('modalProduccion');
      // refrescar listas
      renderTarimasRecibidas(grupo);
    }

    // ============== TARIMAS PENDIENTES (para Calidad) ==============
    function renderTarimasPendientes(){
      console.log('[Tarimas] Listener pendientes');
      // Criterio: tarimas que NO est√°n en tarimasAsignadas
      const container = qs('#tarimasPendientes');
      const unsub1 = tarimasRef.on('value', async (snap)=>{
        const todas = snap.val()||{};
        // leer asignadas
        const asignadas = (await tarimasAsignadasRef.once('value')).val()||{};
        const asignadasSet = new Set(Object.keys(asignadas));
        container.innerHTML = '';
        Object.entries(todas).forEach(([id, t])=>{
          if (!asignadasSet.has(id)) {
            const el = document.createElement('div');
            el.className = 'tarima-item';
            el.innerHTML = `
              <div class="tarima-head">
                <b>#${id}</b>
                <span class="badge warn">Pendiente</span>
              </div>
              <div class="mt8" style="opacity:.85">Cajas: ${t.totalCajas || 0} ‚Äî Piezas: ${t.totalPiezas || 0}</div>
            `;
            container.appendChild(el);
          }
        });
      });
      listeners.push({ off: ()=> tarimasRef.off('value', unsub1) });
    }

    // ============== TARIMAS RECIBIDAS (por Producci√≥n) ==============
    function renderTarimasRecibidas(area){
      console.log('[Producci√≥n] Listener recibidas:', area);
      const cont = qs('#tarimasRecibidas');
      const ref = tarimasRecibidasRef.child(area);
      const unsub = ref.on('value', (snap)=>{
        const data = snap.val()||{};
        cont.innerHTML = '';
        Object.values(data).forEach(t=>{
          const el = document.createElement('div');
          el.className = 'tarima-item';
          el.innerHTML = `
            <div class="tarima-head">
              <b>#${t.id}</b>
              <span class="badge info">Recibida</span>
            </div>
            <div class="mt8" style="opacity:.85">LED origen: ${t.ledOrigen || '‚Äî'} ¬∑ ${new Date(t.recibidoEn).toLocaleString()}</div>
          `;
          cont.appendChild(el);
        });
      });
      listeners.push({ off: ()=> ref.off('value', unsub) });
    }

    // ============== CONTADORES / DASHBOARD ==============
    function escucharDashboard(){
      console.log('[Dashboard] Listener contadores');
      const unsub = contadoresRef.on('value', (snap)=>{
        const c = snap.val()||{};
        qs('#contadorLiberadas').textContent = c.liberadasHoy || 0;
        qs('#contadorRechazadas').textContent = c.rechazadasHoy || 0;
        qs('#contadorRecolectadas').textContent = c.recolectadasHoy || 0;
      });
      listeners.push({ off: ()=> contadoresRef.off('value', unsub) });
    }
    async function incrementarContador(campo, delta, area=null){
      const ref = contadoresRef.child(campo);
      await ref.transaction(v=>(v||0)+delta);
      // Si quieres por √°rea:
      if (area) {
        await contadoresRef.child('areas').child(area).child(campo).transaction(v=>(v||0)+delta);
      }
    }

    // ============== REPORTES ==============
    async function generarReporte(){
      console.log('[Reportes] Generar');
      const inicio = qs('#repInicio').value ? new Date(qs('#repInicio').value).getTime() : null;
      const fin    = qs('#repFin').value   ? (new Date(qs('#repFin').value).getTime() + 86400000 - 1) : null;
      const area   = qs('#repArea').value;
      const turno  = qs('#repTurno').value;

      const snap = await historialRef.once('value');
      const data = snap.val()||{};
      // filtrado b√°sico
      const rows = Object.values(data).filter(r=>{
        const t = new Date(r.timestamp).getTime();
        if (inicio && t<inicio) return false;
        if (fin && t>fin) return false;
        if (area) {
          // match si la acci√≥n/usuario/grupo contiene el √°rea
          const matchArea = (r.usuario||'').includes(area) || (r.grupo||'').includes(area);
          if (!matchArea) return false;
        }
        if (turno) {
          // si guardas turno en historial, filtra aqu√≠ (ejemplo omitido)
        }
        return true;
      });

      const out = document.createElement('div');
      out.className = 'card';
      out.innerHTML = `<h3>Resultados: ${rows.length}</h3>` +
        rows.map(r=>`
          <div style="border-top:1px solid var(--border); padding:8px 0">
            <div><b>${r.accion}</b> ‚Äî ${r.tarimaId || '‚Äî'}</div>
            <div style="opacity:.85">${r.usuario} | ${r.grupo} | LED: ${r.led || '‚Äî'} | ${new Date(r.timestamp).toLocaleString()}</div>
          </div>
        `).join('');
      const cont = qs('#reporteResultado');
      cont.innerHTML = '';
      cont.appendChild(out);
      window.__reporteCache = rows; // para exportar
    }

    function exportarCSV(){
      console.log('[Reportes] Exportar CSV');
      const rows = window.__reporteCache || [];
      const cols = ['timestamp','usuario','grupo','accion','tarimaId','led'];
      const csv = [
        cols.join(','),
        ...rows.map(r=>cols.map(k=>JSON.stringify(r[k]||'')).join(','))
      ].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `reporte_${Date.now()}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // ============== UTILS MODALES PRODUCCI√ìN ==============
    function abrirModal(id){ qs('#'+id).classList.add('visible'); }
    function cerrarModal(id){ qs('#'+id).classList.remove('visible'); }

    // ============== NOTA: PWA SW OPCIONAL ==============
       if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => {
                console.log("‚úÖ Service Worker registrado:", reg);
            })
            .catch(err => {
                console.error("‚ùå Error al registrar Service Worker:", err);
            });
    }
});
  </script>
</body>
</html>
